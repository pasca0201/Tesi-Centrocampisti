<html>
<head>
<title>test_frame_apply.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #7a7e85;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_frame_apply.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">dtypes </span><span class="s0">import </span><span class="s1">CategoricalDtype</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">MultiIndex</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">Timestamp</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">tests</span><span class="s2">.</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">common </span><span class="s0">import </span><span class="s1">zip_frames</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">int_frame_const_col</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot; 
    Fixture for DataFrame of ints which are constant per column 
 
    Columns are ['A', 'B', 'C'], with values (per column): [1, 2, 3] 
    &quot;&quot;&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">), </span><span class="s4">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">6</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">) + </span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">df</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s5">&quot;python&quot;</span><span class="s2">, </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s5">&quot;numba&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">single_cpu</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;numba&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s0">def </span><span class="s1">test_apply</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine not supporting numpy ufunc yet&quot;</span><span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">):</span>
        <span class="s6"># ufunc</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)[</span><span class="s5">&quot;A&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s6"># aggregator</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)[</span><span class="s5">&quot;A&quot;</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>

        <span class="s1">d </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">xs</span><span class="s2">(</span><span class="s1">d</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] == </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index </span><span class="s0">is </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;raw&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_args</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine doesn't support args&quot;</span><span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">y</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">,), </span><span class="s1">raw</span><span class="s2">=</span><span class="s1">raw</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame </span><span class="s2">+ </span><span class="s4">1</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_categorical_func</span><span class="s2">():</span>
    <span class="s6"># GH 9573</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;c0&quot;</span><span class="s2">: [</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">], </span><span class="s5">&quot;c1&quot;</span><span class="s2">: [</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;D&quot;</span><span class="s2">, </span><span class="s5">&quot;D&quot;</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">ts</span><span class="s2">: </span><span class="s1">ts</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;category&quot;</span><span class="s2">))</span>

    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s5">&quot;c0&quot;</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">CategoricalDtype</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s5">&quot;c1&quot;</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">CategoricalDtype</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_axis1_with_ea</span><span class="s2">():</span>
    <span class="s6"># GH#36785</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2013-01-01&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;UTC&quot;</span><span class="s2">)]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;data, dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s1">CategoricalDtype</span><span class="s2">([</span><span class="s4">1</span><span class="s2">])), (</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2013-01-01&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;UTC&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">)],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_agg_axis1_duplicate_index</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s6"># GH 42380</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s1">data</span><span class="s2">], [</span><span class="s1">data</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_mixed_datetimelike</span><span class="s2">():</span>
    <span class="s6"># mixed datetimelike</span>
    <span class="s6"># GH 7778</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">),</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">unit</span><span class="s2">=</span><span class="s5">&quot;s&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;func&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_empty</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># empty</span>
    <span class="s1">empty_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">empty_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">empty</span>


<span class="s0">def </span><span class="s1">test_apply_float_frame</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s1">no_rows </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">[:</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">no_rows</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">no_cols </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[:, []]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">no_cols</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_empty_except_index</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># GH 2476</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_with_reduce_empty</span><span class="s2">():</span>
    <span class="s6"># reduce with an empty DataFrame</span>
    <span class="s1">empty_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">()</span>

    <span class="s1">x </span><span class="s2">= []</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">empty_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">append</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">empty_frame</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">empty_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">append</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;reduce&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">empty_with_cols </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">empty_with_cols</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">append</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">empty_with_cols</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">empty_with_cols</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">append</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;reduce&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># Ensure that x.append hasn't been called</span>
    <span class="s0">assert </span><span class="s1">x </span><span class="s2">== []</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;func&quot;</span><span class="s2">, [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;prod&quot;</span><span class="s2">, </span><span class="s5">&quot;any&quot;</span><span class="s2">, </span><span class="s5">&quot;all&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_funcs_over_empty</span><span class="s2">(</span><span class="s1">func</span><span class="s2">):</span>
    <span class="s6"># GH 28213</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">np</span><span class="s2">, </span><span class="s1">func</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)()</span>
    <span class="s0">if </span><span class="s1">func </span><span class="s0">in </span><span class="s2">(</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;prod&quot;</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nunique_empty</span><span class="s2">():</span>
    <span class="s6"># GH 28213</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">nunique</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">nunique</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_standard_nonunique</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">s</span><span class="s2">: </span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">s</span><span class="s2">: </span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_scalars</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s6"># scalars</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_scalars_axis1</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">)</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s1">c</span><span class="s2">: </span><span class="s1">m </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_lists_columns</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s6"># lists</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">))),</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">m</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">),</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;float64&quot;</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_lists_index</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">))), </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span>
    <span class="s2">)</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s1">c</span><span class="s2">: </span><span class="s1">m </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">},</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;float64&quot;</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_list_lambda_func</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">):</span>
    <span class="s6"># preserve columns</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_broadcast_series_lambda_func</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s5">&quot;abc&quot;</span><span class="s2">)),</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_raw_float_frame</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;numba can't handle when UDF returns None.&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_assert_raw</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>

    <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">_assert_raw</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_raw_float_frame_lambda</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">values</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_raw_float_frame_no_reduction</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># no reduction</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">* </span><span class="s4">2</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame </span><span class="s2">* </span><span class="s4">2</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_raw_mixed_type_frame</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;isinstance check doesn't work with numba&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_assert_raw</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>

    <span class="s6"># Mixed dtype (GH-32423)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">1.0</span><span class="s2">,</span>
            <span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">,</span>
            <span class="s5">&quot;c&quot;</span><span class="s2">: </span><span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;float32&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">] * </span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;float32&quot;</span><span class="s2">),</span>
            <span class="s5">&quot;int32&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">] * </span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int32&quot;</span><span class="s2">),</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">_assert_raw</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_axis1</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)[</span><span class="s1">d</span><span class="s2">]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">xs</span><span class="s2">(</span><span class="s1">d</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_apply_mixed_dtype_corner</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[:</span><span class="s4">0</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s6"># the result here is actually kind of ambiguous, should it be a Series</span>
    <span class="s6"># or a DataFrame?</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_mixed_dtype_corner_indexing</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s5">&quot;foo&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;B&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s5">&quot;ignore::RuntimeWarning&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;ax&quot;</span><span class="s2">, [</span><span class="s5">&quot;index&quot;</span><span class="s2">, </span><span class="s5">&quot;columns&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;func&quot;</span><span class="s2">, [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()], </span><span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;identity&quot;</span><span class="s2">, </span><span class="s5">&quot;mean&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;raw&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_empty_infer_type</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(**{</span><span class="s1">ax</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">]})</span>

    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">):</span>
        <span class="s1">test_res </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;f8&quot;</span><span class="s2">))</span>
        <span class="s1">is_reduction </span><span class="s2">= </span><span class="s0">not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">test_res</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s1">raw</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_reduction</span><span class="s2">:</span>
            <span class="s1">agg_axis </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_get_agg_axis</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index </span><span class="s0">is </span><span class="s1">agg_axis</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_empty_infer_type_broadcast</span><span class="s2">():</span>
    <span class="s1">no_cols </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">no_cols</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_with_args_kwds_add_some</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">add_some</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">howmuch</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">howmuch</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">add_some</span><span class="s2">, </span><span class="s1">howmuch</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_with_args_kwds_agg_and_add</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">agg_and_add</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">howmuch</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() + </span><span class="s1">howmuch</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">agg_and_add</span><span class="s2">, </span><span class="s1">howmuch</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">() + </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_with_args_kwds_subtract_and_divide</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">subtract_and_divide</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">sub</span><span class="s2">, </span><span class="s1">divide</span><span class="s2">=</span><span class="s4">1</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s1">sub</span><span class="s2">) / </span><span class="s1">divide</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">subtract_and_divide</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">,), </span><span class="s1">divide</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: (</span><span class="s1">x </span><span class="s2">- </span><span class="s4">2.0</span><span class="s2">) / </span><span class="s4">2.0</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_yield_list</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">list</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">float_frame</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_reduce_Series</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">, </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">get_loc</span><span class="s2">(</span><span class="s5">&quot;A&quot;</span><span class="s2">)] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_reduce_to_dict</span><span class="s2">():</span>
    <span class="s6"># GH 25196 37544</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;c0&quot;</span><span class="s2">, </span><span class="s5">&quot;c1&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;i0&quot;</span><span class="s2">, </span><span class="s5">&quot;i1&quot;</span><span class="s2">])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([{</span><span class="s5">&quot;i0&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;i1&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}, {</span><span class="s5">&quot;i0&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;i1&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">}], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([{</span><span class="s5">&quot;c0&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;c1&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s5">&quot;c0&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;c1&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">}], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_differently_indexed</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">20</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)))</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">Series</span><span class="s2">.</span><span class="s1">describe</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s1">i</span><span class="s2">: </span><span class="s1">v</span><span class="s2">.</span><span class="s1">describe</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">Series</span><span class="s2">.</span><span class="s1">describe</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s1">i</span><span class="s2">: </span><span class="s1">v</span><span class="s2">.</span><span class="s1">describe</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_bug</span><span class="s2">():</span>
    <span class="s6"># GH 6125</span>
    <span class="s1">positions </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;ABC0&quot;</span><span class="s2">, </span><span class="s4">50</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;YUM0&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;DEF0&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;ABC1&quot;</span><span class="s2">, </span><span class="s4">50</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;YUM1&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;DEF1&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
        <span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;market&quot;</span><span class="s2">, </span><span class="s5">&quot;position&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">r</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">r</span><span class="s2">[</span><span class="s5">&quot;market&quot;</span><span class="s2">]</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">positions</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">positions </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s5">&quot;ABC0&quot;</span><span class="s2">, </span><span class="s4">50</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s5">&quot;YUM0&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), </span><span class="s5">&quot;DEF0&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">), </span><span class="s5">&quot;ABC1&quot;</span><span class="s2">, </span><span class="s4">50</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), </span><span class="s5">&quot;YUM1&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">), </span><span class="s5">&quot;DEF1&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">],</span>
        <span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;market&quot;</span><span class="s2">, </span><span class="s5">&quot;position&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">positions</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_convert_objects</span><span class="s2">():</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: [</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;bar&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;foo&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: [</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;two&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;one&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s5">&quot;C&quot;</span><span class="s2">: [</span>
                <span class="s5">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;dull&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;shiny&quot;</span><span class="s2">,</span>
                <span class="s5">&quot;shiny&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s5">&quot;D&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">11</span><span class="s2">),</span>
            <span class="s5">&quot;E&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">11</span><span class="s2">),</span>
            <span class="s5">&quot;F&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">11</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name_axis1</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name_non_reduction</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s6"># non-reductions</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_attach_name_non_reduction_axis1</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">len</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()</span>
    <span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_multi_index</span><span class="s2">():</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;col1&quot;</span><span class="s2">, </span><span class="s5">&quot;col2&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;min&quot;</span><span class="s2">: </span><span class="s1">min</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s5">&quot;max&quot;</span><span class="s2">: </span><span class="s1">max</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)}), </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_like</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;df, dicts&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span>
            <span class="s1">DataFrame</span><span class="s2">([[</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">], [</span><span class="s5">&quot;spam&quot;</span><span class="s2">, </span><span class="s5">&quot;eggs&quot;</span><span class="s2">]]),</span>
            <span class="s1">Series</span><span class="s2">([{</span><span class="s4">0</span><span class="s2">: </span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s5">&quot;spam&quot;</span><span class="s2">}, {</span><span class="s4">0</span><span class="s2">: </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s5">&quot;eggs&quot;</span><span class="s2">}]),</span>
        <span class="s2">],</span>
        <span class="s2">[</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]), </span><span class="s1">Series</span><span class="s2">([{</span><span class="s4">0</span><span class="s2">: </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s4">0</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}])],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_apply_dict</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">dicts</span><span class="s2">):</span>
    <span class="s6"># GH 8735</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">to_dict</span><span class="s2">()</span>
    <span class="s1">reduce_true </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;reduce&quot;</span><span class="s2">)</span>
    <span class="s1">reduce_false </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">reduce_none </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">reduce_true</span><span class="s2">, </span><span class="s1">dicts</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reduce_false</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">reduce_none</span><span class="s2">, </span><span class="s1">dicts</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_non_numpy_dtype</span><span class="s2">():</span>
    <span class="s6"># GH 12244</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;dt&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s5">&quot;2015-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;Europe/Brussels&quot;</span><span class="s2">)})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timedelta</span><span class="s2">(</span><span class="s5">&quot;1day&quot;</span><span class="s2">))</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;dt&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s5">&quot;2015-01-02&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;Europe/Brussels&quot;</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_non_numpy_dtype_category</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;dt&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;category&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_dup_names_multi_agg</span><span class="s2">():</span>
    <span class="s6"># GH 21063</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;min&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;min&quot;</span><span class="s2">])</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;op&quot;</span><span class="s2">, [</span><span class="s5">&quot;apply&quot;</span><span class="s2">, </span><span class="s5">&quot;agg&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_nested_result_axis_1</span><span class="s2">(</span><span class="s1">op</span><span class="s2">):</span>
    <span class="s6"># GH 13820</span>
    <span class="s0">def </span><span class="s1">apply_list</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">row</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">], </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">row</span><span class="s2">[</span><span class="s5">&quot;C&quot;</span><span class="s2">], </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">row</span><span class="s2">[</span><span class="s5">&quot;B&quot;</span><span class="s2">]]</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s5">&quot;ABCD&quot;</span><span class="s2">))</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">op</span><span class="s2">)(</span><span class="s1">apply_list</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_noreduction_tzaware_object</span><span class="s2">():</span>
    <span class="s6"># https://github.com/pandas-dev/pandas/issues/31505</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;foo&quot;</span><span class="s2">: [</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2020&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;UTC&quot;</span><span class="s2">)]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;datetime64[ns, UTC]&quot;</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">())</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_function_runs_once</span><span class="s2">():</span>
    <span class="s6"># https://github.com/pandas-dev/pandas/issues/30815</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">names </span><span class="s2">= []  </span><span class="s6"># Save row names function is applied to</span>

    <span class="s0">def </span><span class="s1">reducing_function</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">names</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">row</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">non_reducing_function</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">names</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">row</span><span class="s2">.</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s2">[</span><span class="s1">reducing_function</span><span class="s2">, </span><span class="s1">non_reducing_function</span><span class="s2">]:</span>
        <span class="s0">del </span><span class="s1">names</span><span class="s2">[:]</span>

        <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">names </span><span class="s2">== </span><span class="s1">list</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_raw_function_runs_once</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># https://github.com/pandas-dev/pandas/issues/34506</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;appending to list outside of numba func is not supported&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">values </span><span class="s2">= []  </span><span class="s6"># Save row values function is applied to</span>

    <span class="s0">def </span><span class="s1">reducing_function</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">values</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">non_reducing_function</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">values</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s2">[</span><span class="s1">reducing_function</span><span class="s2">, </span><span class="s1">non_reducing_function</span><span class="s2">]:</span>
        <span class="s0">del </span><span class="s1">values</span><span class="s2">[:]</span>

        <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">values </span><span class="s2">== </span><span class="s1">list</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">to_list</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_apply_with_byte_string</span><span class="s2">():</span>
    <span class="s6"># GH 34529</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s7">b&quot;abcd&quot;</span><span class="s2">, </span><span class="s7">b&quot;efgh&quot;</span><span class="s2">]), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;col&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s7">b&quot;abcd&quot;</span><span class="s2">, </span><span class="s7">b&quot;efgh&quot;</span><span class="s2">]), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;col&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s6"># After we make the apply we expect a dataframe just</span>
    <span class="s6"># like the original but with the object datatype</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;object&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;val&quot;</span><span class="s2">, [</span><span class="s5">&quot;asd&quot;</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_category_equalness</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
    <span class="s6"># Check if categorical comparisons on apply, GH 21239</span>
    <span class="s1">df_values </span><span class="s2">= [</span><span class="s5">&quot;asd&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s5">&quot;asd&quot;</span><span class="s2">, </span><span class="s5">&quot;cde&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s1">df_values</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;category&quot;</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">== </span><span class="s1">val</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan </span><span class="s0">if </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">isnull</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) </span><span class="s0">else </span><span class="s1">x </span><span class="s2">== </span><span class="s1">val </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">df_values</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;a&quot;</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s6"># the user has supplied an opaque UDF where</span>
<span class="s6"># they are transforming the input that requires</span>
<span class="s6"># us to infer the output</span>


<span class="s0">def </span><span class="s1">test_infer_row_shape</span><span class="s2">():</span>
    <span class="s6"># GH 17437</span>
    <span class="s6"># if row shape is changing, infer it</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)))</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fft</span><span class="s2">.</span><span class="s1">fft</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">).</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">fft</span><span class="s2">.</span><span class="s1">rfft</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">).</span><span class="s1">shape</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== (</span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;ops, by_row, expected&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">}, </span><span class="s5">&quot;compat&quot;</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})),</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">}, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})),</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()}, </span><span class="s5">&quot;compat&quot;</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">})),</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()}, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">})),</span>
        <span class="s2">(</span>
            <span class="s2">{</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()]},</span>
            <span class="s5">&quot;compat&quot;</span><span class="s2">,</span>
            <span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">{</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()]},</span>
            <span class="s0">False</span><span class="s2">,</span>
            <span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]),</span>
        <span class="s2">),</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}, </span><span class="s5">&quot;compat&quot;</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]})),</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dictlike_lambda</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">, </span><span class="s1">by_row</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s6"># GH53601</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">, </span><span class="s1">by_row</span><span class="s2">=</span><span class="s1">by_row</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;ops&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()},</span>
        <span class="s2">{</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()]},</span>
        <span class="s2">{</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">1</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dictlike_lambda_raises</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">):</span>
    <span class="s6"># GH53601</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;by_row=True not allowed&quot;</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">, </span><span class="s1">by_row</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_with_dictlike_columns</span><span class="s2">():</span>
    <span class="s6"># GH 17602</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: {</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">]}, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([{</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">} </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;tm&quot;</span><span class="s2">] = [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2017-05-01 00:00:00&quot;</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2017-05-02 00:00:00&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: {</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">]}, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># compose a series</span>
    <span class="s1">result </span><span class="s2">= (</span><span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">]).</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: {</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([{</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}, {</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_with_dictlike_columns_with_datetime</span><span class="s2">():</span>
    <span class="s6"># GH 18775</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">()</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;author&quot;</span><span class="s2">] = [</span><span class="s5">&quot;X&quot;</span><span class="s2">, </span><span class="s5">&quot;Y&quot;</span><span class="s2">, </span><span class="s5">&quot;Z&quot;</span><span class="s2">]</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;publisher&quot;</span><span class="s2">] = [</span><span class="s5">&quot;BBC&quot;</span><span class="s2">, </span><span class="s5">&quot;NBC&quot;</span><span class="s2">, </span><span class="s5">&quot;N24&quot;</span><span class="s2">]</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;date&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">(</span>
        <span class="s2">[</span><span class="s5">&quot;17-10-2010 07:15:30&quot;</span><span class="s2">, </span><span class="s5">&quot;13-05-2011 08:20:35&quot;</span><span class="s2">, </span><span class="s5">&quot;15-01-2013 09:09:09&quot;</span><span class="s2">],</span>
        <span class="s1">dayfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: {}, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([{}, {}, {}])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_with_dictlike_columns_with_infer</span><span class="s2">():</span>
    <span class="s6"># GH 17602</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: {</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">]}, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;s&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;tm&quot;</span><span class="s2">] = [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2017-05-01 00:00:00&quot;</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2017-05-02 00:00:00&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: {</span><span class="s5">&quot;s&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">]}, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;ops, by_row, expected&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">], </span><span class="s5">&quot;compat&quot;</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">): [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})),</span>
        <span class="s2">([</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">], </span><span class="s0">False</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({(</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">): [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})),</span>
        <span class="s2">([</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()], </span><span class="s5">&quot;compat&quot;</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">])),</span>
        <span class="s2">([</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()], </span><span class="s0">False</span><span class="s2">, </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">])),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()],</span>
            <span class="s5">&quot;compat&quot;</span><span class="s2">,</span>
            <span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()],</span>
            <span class="s0">False</span><span class="s2">,</span>
            <span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s5">&quot;compat&quot;</span><span class="s2">,</span>
            <span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s0">False</span><span class="s2">,</span>
            <span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, [</span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_listlike_lambda</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">, </span><span class="s1">by_row</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s6"># GH53601</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">, </span><span class="s1">by_row</span><span class="s2">=</span><span class="s1">by_row</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;ops&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()],</span>
        <span class="s2">[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()],</span>
        <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">3</span><span class="s2">],</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_listlike_lambda_raises</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">):</span>
    <span class="s6"># GH53601</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;by_row=True not allowed&quot;</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">ops</span><span class="s2">, </span><span class="s1">by_row</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_with_listlike_columns</span><span class="s2">():</span>
    <span class="s6"># GH 17348</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)),</span>
            <span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;list&quot;</span><span class="s2">, </span><span class="s5">&quot;of&quot;</span><span class="s2">, </span><span class="s5">&quot;words&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;ts&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s5">&quot;2016-10-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s5">&quot;h&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]].</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">t</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]].</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;ts&quot;</span><span class="s2">]].</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">t</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;ts&quot;</span><span class="s2">]].</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_with_listlike_columns_returning_list</span><span class="s2">():</span>
    <span class="s6"># GH 18919</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;x&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;q&quot;</span><span class="s2">]]), </span><span class="s5">&quot;y&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([[</span><span class="s5">&quot;z&quot;</span><span class="s2">], [</span><span class="s5">&quot;q&quot;</span><span class="s2">, </span><span class="s5">&quot;t&quot;</span><span class="s2">]])})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">([(</span><span class="s5">&quot;i0&quot;</span><span class="s2">, </span><span class="s5">&quot;j0&quot;</span><span class="s2">), (</span><span class="s5">&quot;i1&quot;</span><span class="s2">, </span><span class="s5">&quot;j1&quot;</span><span class="s2">)])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">row</span><span class="s2">: [</span><span class="s1">el </span><span class="s0">for </span><span class="s1">el </span><span class="s0">in </span><span class="s1">row</span><span class="s2">[</span><span class="s5">&quot;x&quot;</span><span class="s2">] </span><span class="s0">if </span><span class="s1">el </span><span class="s0">in </span><span class="s1">row</span><span class="s2">[</span><span class="s5">&quot;y&quot;</span><span class="s2">]], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([[], [</span><span class="s5">&quot;q&quot;</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_infer_output_shape_columns</span><span class="s2">():</span>
    <span class="s6"># GH 18573</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;number&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">],</span>
            <span class="s5">&quot;string&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;datetime&quot;</span><span class="s2">: [</span>
                <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2017-11-29 03:30:00&quot;</span><span class="s2">),</span>
                <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2017-11-29 03:45:00&quot;</span><span class="s2">),</span>
            <span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">row</span><span class="s2">: (</span><span class="s1">row</span><span class="s2">.</span><span class="s1">number</span><span class="s2">, </span><span class="s1">row</span><span class="s2">.</span><span class="s1">string</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([(</span><span class="s1">t</span><span class="s2">.</span><span class="s1">number</span><span class="s2">, </span><span class="s1">t</span><span class="s2">.</span><span class="s1">string</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_infer_output_shape_listlike_columns</span><span class="s2">():</span>
    <span class="s6"># GH 16353</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">] </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;val&quot;</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_infer_output_shape_listlike_columns_np_func</span><span class="s2">(</span><span class="s1">val</span><span class="s2">):</span>
    <span class="s6"># GH 17970</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s5">&quot;abc&quot;</span><span class="s2">))</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">row</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">val</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">val</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_infer_output_shape_listlike_columns_with_timestamp</span><span class="s2">():</span>
    <span class="s6"># GH 17892</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;a&quot;</span><span class="s2">: [</span>
                <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2010-02-01&quot;</span><span class="s2">),</span>
                <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2010-02-04&quot;</span><span class="s2">),</span>
                <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2010-02-05&quot;</span><span class="s2">),</span>
                <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2010-02-06&quot;</span><span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s5">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
            <span class="s5">&quot;d&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">fun</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;lst&quot;</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_consistent_coerce_for_shapes</span><span class="s2">(</span><span class="s1">lst</span><span class="s2">):</span>
    <span class="s6"># we want column names to NOT be propagated</span>
    <span class="s6"># just because the shape matches the input shape</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">lst</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">lst </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_consistent_names</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">):</span>
    <span class="s6"># if a Series is returned, we should use the resulting index names</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;test&quot;</span><span class="s2">, </span><span class="s5">&quot;other&quot;</span><span class="s2">, </span><span class="s5">&quot;cols&quot;</span><span class="s2">]), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">int_frame_const_col</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span>
        <span class="s1">columns</span><span class="s2">={</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s5">&quot;test&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s5">&quot;other&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">: </span><span class="s5">&quot;cols&quot;</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;test&quot;</span><span class="s2">, </span><span class="s5">&quot;other&quot;</span><span class="s2">]), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[[</span><span class="s5">&quot;test&quot;</span><span class="s2">, </span><span class="s5">&quot;other&quot;</span><span class="s2">]]</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_result_type</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">):</span>
    <span class="s6"># result_type should be consistent no matter which</span>
    <span class="s6"># path we take in the code</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_result_type_shorter_list</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">):</span>
    <span class="s6"># result_type should be consistent no matter which</span>
    <span class="s6"># path we take in the code</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]].</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_result_type_broadcast</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># result_type should be consistent no matter which</span>
    <span class="s6"># path we take in the code</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine doesn't support list return&quot;</span><span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s6"># broadcast result</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_result_type_broadcast_series_func</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># result_type should be consistent no matter which</span>
    <span class="s6"># path we take in the code</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba Series constructor only support ndarrays not list data&quot;</span>
        <span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s1">columns </span><span class="s2">= [</span><span class="s5">&quot;other&quot;</span><span class="s2">, </span><span class="s5">&quot;col&quot;</span><span class="s2">, </span><span class="s5">&quot;names&quot;</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">),</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;broadcast&quot;</span><span class="s2">,</span>
        <span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_result_type_series_result</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># result_type should be consistent no matter which</span>
    <span class="s6"># path we take in the code</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba Series constructor only support ndarrays not list data&quot;</span>
        <span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s6"># series result</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">x</span><span class="s2">.</span><span class="s1">index</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_result_type_series_result_other_index</span><span class="s2">(</span><span class="s1">int_frame_const_col</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># result_type should be consistent no matter which</span>
    <span class="s6"># path we take in the code</span>

    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;no support in numba Series constructor for list of columns&quot;</span>
        <span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>
    <span class="s6"># series result with other index</span>
    <span class="s1">columns </span><span class="s2">= [</span><span class="s5">&quot;other&quot;</span><span class="s2">, </span><span class="s5">&quot;col&quot;</span><span class="s2">, </span><span class="s5">&quot;names&quot;</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">columns</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;box&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">)],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;list&quot;</span><span class="s2">, </span><span class="s5">&quot;tuple&quot;</span><span class="s2">, </span><span class="s5">&quot;array&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_consistency_for_boxed</span><span class="s2">(</span><span class="s1">box</span><span class="s2">, </span><span class="s1">int_frame_const_col</span><span class="s2">):</span>
    <span class="s6"># passing an array or list should not affect the output shape</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">int_frame_const_col</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">box</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">box</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">itertuples</span><span class="s2">()])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">box</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;expand&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">int_frame_const_col</span><span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]].</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">={</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_transform</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">other_axis </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">} </span><span class="s0">else </span><span class="s4">0</span>

    <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">):</span>
        <span class="s1">f_abs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">)</span>
        <span class="s1">f_sqrt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">)</span>

        <span class="s6"># ufunc</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">f_sqrt</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s6"># list-like</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">f_sqrt</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">}:</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">([</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, [</span><span class="s5">&quot;sqrt&quot;</span><span class="s2">]])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">([</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, [</span><span class="s5">&quot;sqrt&quot;</span><span class="s2">]])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s6"># multiple items in list</span>
        <span class="s6"># these are in the order as if we are applying both</span>
        <span class="s6"># functions per series and then concatting</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">zip_frames</span><span class="s2">([</span><span class="s1">f_abs</span><span class="s2">, </span><span class="s1">f_sqrt</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">other_axis</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">}:</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, [</span><span class="s5">&quot;absolute&quot;</span><span class="s2">, </span><span class="s5">&quot;sqrt&quot;</span><span class="s2">]]</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, [</span><span class="s5">&quot;absolute&quot;</span><span class="s2">, </span><span class="s5">&quot;sqrt&quot;</span><span class="s2">]]</span>
            <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_demo</span><span class="s2">():</span>
    <span class="s6"># demonstration tests</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s4">5</span><span class="s2">})</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]}, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_demo_dict_agg</span><span class="s2">():</span>
    <span class="s6"># demonstration tests</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s4">5</span><span class="s2">})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">]})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">5.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">25.0</span><span class="s2">]},</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;max&quot;</span><span class="s2">, </span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">reindex_like</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_with_name_as_column_name</span><span class="s2">():</span>
    <span class="s6"># GH 36212 - Column name is &quot;name&quot;</span>
    <span class="s1">data </span><span class="s2">= {</span><span class="s5">&quot;name&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]}</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s6"># result's name should be None</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">({</span><span class="s5">&quot;name&quot;</span><span class="s2">: </span><span class="s5">&quot;count&quot;</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;name&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># Check if name is still preserved when aggregating series instead</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;name&quot;</span><span class="s2">].</span><span class="s1">agg</span><span class="s2">({</span><span class="s5">&quot;name&quot;</span><span class="s2">: </span><span class="s5">&quot;count&quot;</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;name&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;name&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_multiple_mixed</span><span class="s2">():</span>
    <span class="s6"># GH 20909</span>
    <span class="s1">mdf </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
            <span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">],</span>
            <span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;foobarbaz&quot;</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s6"># sorted index</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">mdf</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">mdf</span><span class="s2">[[</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">]].</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;min&quot;</span><span class="s2">])</span>
    <span class="s6"># GH40420: the result of .agg should have an index that is sorted</span>
    <span class="s6"># according to the arguments provided to agg.</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[[</span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">]].</span><span class="s1">reindex</span><span class="s2">([</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;min&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_multiple_mixed_raises</span><span class="s2">():</span>
    <span class="s6"># GH 20909</span>
    <span class="s1">mdf </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
            <span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;D&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s6"># sorted index</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;does not support reduction&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mdf</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">mdf</span><span class="s2">[[</span><span class="s5">&quot;D&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">]].</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;min&quot;</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_agg_reduce</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">float_frame</span><span class="s2">):</span>
    <span class="s1">other_axis </span><span class="s2">= </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">} </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">name1</span><span class="s2">, </span><span class="s1">name2 </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">[</span><span class="s1">other_axis</span><span class="s2">].</span><span class="s1">unique</span><span class="s2">()[:</span><span class="s4">2</span><span class="s2">].</span><span class="s1">sort_values</span><span class="s2">()</span>

    <span class="s6"># all reducers</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">),</span>
            <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">),</span>
            <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s5">&quot;mean&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">T </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">} </span><span class="s0">else </span><span class="s1">expected</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;mean&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># dict input with scalars</span>
    <span class="s1">func </span><span class="s2">= {</span><span class="s1">name1</span><span class="s2">: </span><span class="s5">&quot;mean&quot;</span><span class="s2">, </span><span class="s1">name2</span><span class="s2">: </span><span class="s5">&quot;sum&quot;</span><span class="s2">}</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name1</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
            <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name2</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">(),</span>
        <span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s1">name1</span><span class="s2">, </span><span class="s1">name2</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># dict input with lists</span>
    <span class="s1">func </span><span class="s2">= {</span><span class="s1">name1</span><span class="s2">: [</span><span class="s5">&quot;mean&quot;</span><span class="s2">], </span><span class="s1">name2</span><span class="s2">: [</span><span class="s5">&quot;sum&quot;</span><span class="s2">]}</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s1">name1</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name1</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">()], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;mean&quot;</span><span class="s2">]),</span>
            <span class="s1">name2</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name2</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">()], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">]),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">T </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;columns&quot;</span><span class="s2">} </span><span class="s0">else </span><span class="s1">expected</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># dict input with lists with multiple</span>
    <span class="s1">func </span><span class="s2">= {</span><span class="s1">name1</span><span class="s2">: [</span><span class="s5">&quot;mean&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">], </span><span class="s1">name2</span><span class="s2">: [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">]}</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">float_frame</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s1">name1</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span>
                    <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name1</span><span class="s2">].</span><span class="s1">mean</span><span class="s2">(),</span>
                    <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name1</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">(),</span>
                <span class="s2">],</span>
                <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;mean&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">],</span>
            <span class="s2">),</span>
            <span class="s1">name2</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span>
                    <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name2</span><span class="s2">].</span><span class="s1">sum</span><span class="s2">(),</span>
                    <span class="s1">float_frame</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">(</span><span class="s1">other_axis</span><span class="s2">)[</span><span class="s1">name2</span><span class="s2">].</span><span class="s1">max</span><span class="s2">(),</span>
                <span class="s2">],</span>
                <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">],</span>
            <span class="s2">),</span>
        <span class="s2">},</span>
        <span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">T </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">{</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;columns&quot;</span><span class="s2">} </span><span class="s0">else </span><span class="s1">expected</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nuiscance_columns</span><span class="s2">():</span>
    <span class="s6"># GH 15015</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
            <span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s5">&quot;baz&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;D&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s5">&quot;min&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">)], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;min&quot;</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">, </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;20130101&quot;</span><span class="s2">).</span><span class="s1">as_unit</span><span class="s2">(</span><span class="s5">&quot;ns&quot;</span><span class="s2">)]],</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;min&quot;</span><span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;does not support reduction&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s5">&quot;sum&quot;</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">]].</span><span class="s1">agg</span><span class="s2">(</span><span class="s5">&quot;sum&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s5">&quot;foobarbaz&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;does not support reduction&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s5">&quot;sum&quot;</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;how&quot;</span><span class="s2">, [</span><span class="s5">&quot;agg&quot;</span><span class="s2">, </span><span class="s5">&quot;apply&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_non_callable_aggregates</span><span class="s2">(</span><span class="s1">how</span><span class="s2">):</span>
    <span class="s6"># GH 16405</span>
    <span class="s6"># 'size' is a property of frame/series</span>
    <span class="s6"># validate that this is working</span>
    <span class="s6"># GH 39116 - expand to apply</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>

    <span class="s6"># Function aggregate</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">how</span><span class="s2">)({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s5">&quot;count&quot;</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">})</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># Non-function aggregate</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">how</span><span class="s2">)({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s5">&quot;size&quot;</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">})</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># Mix function and non-function aggs</span>
    <span class="s1">result1 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">how</span><span class="s2">)([</span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">])</span>
    <span class="s1">result2 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">how</span><span class="s2">)(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;A&quot;</span><span class="s2">: {</span><span class="s5">&quot;count&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
            <span class="s5">&quot;B&quot;</span><span class="s2">: {</span><span class="s5">&quot;count&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
            <span class="s5">&quot;C&quot;</span><span class="s2">: {</span><span class="s5">&quot;count&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;size&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result1</span><span class="s2">, </span><span class="s1">result2</span><span class="s2">, </span><span class="s1">check_like</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result2</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_like</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s6"># Just functional string arg is same as calling df.arg()</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">how</span><span class="s2">)(</span><span class="s5">&quot;count&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">count</span><span class="s2">()</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;how&quot;</span><span class="s2">, [</span><span class="s5">&quot;agg&quot;</span><span class="s2">, </span><span class="s5">&quot;apply&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_size_as_str</span><span class="s2">(</span><span class="s1">how</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s6"># GH 39934</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>
    <span class="s6"># Just a string attribute arg same as calling df.arg</span>
    <span class="s6"># on the columns</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">how</span><span class="s2">)(</span><span class="s5">&quot;size&quot;</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">axis </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s5">&quot;index&quot;</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_listlike_result</span><span class="s2">():</span>
    <span class="s6"># GH-29587 user defined function returning list-likes</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]})</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">group_col</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">group_col</span><span class="s2">.</span><span class="s1">dropna</span><span class="s2">().</span><span class="s1">unique</span><span class="s2">())</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1.5</span><span class="s2">], [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]], </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s1">func</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(</span><span class="s5">&quot;func&quot;</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;axis&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;args, kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), {}),</span>
        <span class="s2">((</span><span class="s4">8</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">15</span><span class="s2">), {}),</span>
        <span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), {}),</span>
        <span class="s2">((</span><span class="s4">1</span><span class="s2">,), {</span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}),</span>
        <span class="s2">((), {</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}),</span>
        <span class="s2">((), {</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}),</span>
        <span class="s2">((), {</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_agg_args_kwargs</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">3</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() + (</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b</span><span class="s2">) / </span><span class="s1">c</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

    <span class="s0">if </span><span class="s1">axis </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">8.0</span><span class="s2">])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;num_cols&quot;</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_frequency_is_original</span><span class="s2">(</span><span class="s1">num_cols</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># GH 22150</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine only supports numeric indices&quot;</span><span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DatetimeIndex</span><span class="s2">([</span><span class="s5">&quot;1950-06-30&quot;</span><span class="s2">, </span><span class="s5">&quot;1952-10-24&quot;</span><span class="s2">, </span><span class="s5">&quot;1953-05-29&quot;</span><span class="s2">])</span>
    <span class="s1">original </span><span class="s2">= </span><span class="s1">index</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_cols</span><span class="s2">))</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">index</span><span class="s2">.</span><span class="s1">freq </span><span class="s2">== </span><span class="s1">original</span><span class="s2">.</span><span class="s1">freq</span>


<span class="s0">def </span><span class="s1">test_apply_datetime_tz_issue</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># GH 29052</span>

    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine doesn't support non-numeric indexes&quot;</span>
        <span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>

    <span class="s1">timestamps </span><span class="s2">= [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2019-03-15 12:34:31.909000+0000&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;UTC&quot;</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2019-03-15 12:34:34.359000+0000&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;UTC&quot;</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s5">&quot;2019-03-15 12:34:34.660000+0000&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s5">&quot;UTC&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">timestamps</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">timestamps</span><span class="s2">, </span><span class="s1">data</span><span class="s2">=</span><span class="s1">timestamps</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;df&quot;</span><span class="s2">, [</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]})])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;method&quot;</span><span class="s2">, [</span><span class="s5">&quot;min&quot;</span><span class="s2">, </span><span class="s5">&quot;max&quot;</span><span class="s2">, </span><span class="s5">&quot;sum&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_mixed_column_raises</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">using_infer_string</span><span class="s2">):</span>
    <span class="s6"># GH 16832</span>
    <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s5">&quot;sum&quot;</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">r'can only concatenate str \(not &quot;int&quot;\) to str|does not support'</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;not supported between instances of 'str' and 'float'&quot;</span>
    <span class="s0">if not </span><span class="s1">using_infer_string</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)()</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;col&quot;</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_apply_dtype</span><span class="s2">(</span><span class="s1">col</span><span class="s2">):</span>
    <span class="s6"># GH 31466</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">col</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dtypes</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_mutating</span><span class="s2">(</span><span class="s1">using_array_manager</span><span class="s2">, </span><span class="s1">using_copy_on_write</span><span class="s2">, </span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
    <span class="s6"># GH#35462 case where applied func pins a new BlockManager to a row</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">), </span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s4">200</span><span class="s2">)})</span>
    <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">row</span><span class="s2">):</span>
        <span class="s1">mgr </span><span class="s2">= </span><span class="s1">row</span><span class="s2">.</span><span class="s1">_mgr</span>
        <span class="s1">row</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] += </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">row</span><span class="s2">.</span><span class="s1">_mgr </span><span class="s0">is not </span><span class="s1">mgr</span>
        <span class="s0">return </span><span class="s1">row</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">] += </span><span class="s4">1</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_cow_warning</span><span class="s2">(</span><span class="s1">warn_copy_on_write</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s1">using_array_manager</span><span class="s2">:</span>
        <span class="s6"># INFO(CoW) With copy on write, mutating a viewing row doesn't mutate the parent</span>
        <span class="s6"># INFO(ArrayManager) With BlockManager, the row is a view and mutated in place,</span>
        <span class="s6"># with ArrayManager the row is not a view, and thus not mutated in place</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_empty_list_reduce</span><span class="s2">():</span>
    <span class="s6"># GH#35683 get columns correct</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [], </span><span class="s1">result_type</span><span class="s2">=</span><span class="s5">&quot;reduce&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [], </span><span class="s5">&quot;b&quot;</span><span class="s2">: []}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_no_suffix_index</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># GH36189</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine doesn't support list-likes/dict-like callables&quot;</span>
        <span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">pdf </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]] * </span><span class="s4">3</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">])</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">pdf</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">([</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(), </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()], </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">27</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">27</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">, </span><span class="s5">&quot;&lt;lambda&gt;&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_raw_returns_string</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># https://github.com/pandas-dev/pandas/issues/35940</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">&quot;No object dtype support in numba&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;aa&quot;</span><span class="s2">, </span><span class="s5">&quot;bbb&quot;</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">raw</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s5">&quot;aa&quot;</span><span class="s2">, </span><span class="s5">&quot;bbb&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_aggregation_func_column_order</span><span class="s2">():</span>
    <span class="s6"># GH40420: the result of .agg should have an index that is sorted</span>
    <span class="s6"># according to the arguments provided to agg.</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=(</span><span class="s5">&quot;att1&quot;</span><span class="s2">, </span><span class="s5">&quot;att2&quot;</span><span class="s2">, </span><span class="s5">&quot;att3&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">sum_div2</span><span class="s2">(</span><span class="s1">s</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">s</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() / </span><span class="s4">2</span>

    <span class="s1">aggs </span><span class="s2">= [</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s1">sum_div2</span><span class="s2">, </span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;min&quot;</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">aggs</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;att1&quot;</span><span class="s2">: [</span><span class="s4">21.0</span><span class="s2">, </span><span class="s4">10.5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
            <span class="s5">&quot;att2&quot;</span><span class="s2">: [</span><span class="s4">18.0</span><span class="s2">, </span><span class="s4">9.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">],</span>
            <span class="s5">&quot;att3&quot;</span><span class="s2">: [</span><span class="s4">17.0</span><span class="s2">, </span><span class="s4">8.5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;sum&quot;</span><span class="s2">, </span><span class="s5">&quot;sum_div2&quot;</span><span class="s2">, </span><span class="s5">&quot;count&quot;</span><span class="s2">, </span><span class="s5">&quot;min&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_getitem_axis_1</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s6"># GH 13427</span>
    <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s5">&quot;numba&quot;</span><span class="s2">:</span>
        <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
            <span class="s1">reason</span><span class="s2">=</span><span class="s5">&quot;numba engine not supporting duplicate index values&quot;</span>
        <span class="s2">)</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]].</span><span class="s1">apply</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] + </span><span class="s1">x</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_nuisance_depr_passes_through_warnings</span><span class="s2">():</span>
    <span class="s6"># GH 43740</span>
    <span class="s6"># DataFrame.agg with list-likes may emit warnings for both individual</span>
    <span class="s6"># args and for entire columns, but we only want to emit once. We</span>
    <span class="s6"># catch and suppress the warnings for individual args, but need to make</span>
    <span class="s6"># sure if some other warnings were raised, they get passed through to</span>
    <span class="s6"># the user.</span>

    <span class="s0">def </span><span class="s1">expected_warning</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span><span class="s5">&quot;Hello, World!&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">()</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Hello, World!&quot;</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s1">expected_warning</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_apply_type</span><span class="s2">():</span>
    <span class="s6"># GH 46719</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;string&quot;</span><span class="s2">, </span><span class="s1">float</span><span class="s2">], </span><span class="s5">&quot;col2&quot;</span><span class="s2">: [</span><span class="s4">0.25</span><span class="s2">, </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2020</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]},</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s6"># axis=0</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">, </span><span class="s5">&quot;col2&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># axis=1</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">type</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_on_empty_dataframe</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
    <span class="s6"># GH 39111</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">head</span><span class="s2">(</span><span class="s4">0</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">max</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">]), </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_apply_return_list</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s1">x</span><span class="s2">.</span><span class="s1">values</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;test, constant&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]}, {</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">]}),</span>
        <span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]}, {</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">]}),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_unique_agg_type_is_series</span><span class="s2">(</span><span class="s1">test</span><span class="s2">, </span><span class="s1">constant</span><span class="s2">):</span>
    <span class="s6"># GH#22558</span>
    <span class="s1">df1 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">test</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s1">constant</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;object&quot;</span><span class="s2">)</span>
    <span class="s1">aggregation </span><span class="s2">= {</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s5">&quot;unique&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">: </span><span class="s5">&quot;unique&quot;</span><span class="s2">}</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">aggregation</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_any_apply_keyword_non_zero_axis_regression</span><span class="s2">():</span>
    <span class="s6"># https://github.com/pandas-dev/pandas/issues/48656</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s5">&quot;any&quot;</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span><span class="s5">&quot;any&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_mapping_func_deprecated</span><span class="s2">():</span>
    <span class="s6"># GH 53325</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;x&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>

    <span class="s0">def </span><span class="s1">foo1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">c</span>

    <span class="s0">def </span><span class="s1">foo2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">b </span><span class="s2">+ </span><span class="s1">c</span>

    <span class="s6"># single func already takes the vectorized path</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">foo1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df </span><span class="s2">+ </span><span class="s4">7</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;using .+ in Series.agg cannot aggregate and&quot;</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s1">foo1</span><span class="s2">, </span><span class="s1">foo2</span><span class="s2">], </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[[</span><span class="s5">&quot;x&quot;</span><span class="s2">, </span><span class="s5">&quot;x&quot;</span><span class="s2">], [</span><span class="s5">&quot;foo1&quot;</span><span class="s2">, </span><span class="s5">&quot;foo2&quot;</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s6"># TODO: the result below is wrong, should be fixed (GH53325)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">({</span><span class="s5">&quot;x&quot;</span><span class="s2">: </span><span class="s1">foo1</span><span class="s2">}, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;x&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_std</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">])</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;using DataFrame.std&quot;</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s4">2.0</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s4">2.0</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;using Series.std&quot;</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">std</span><span class="s2">])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s4">2.0</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s4">2.0</span><span class="s2">}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s5">&quot;std&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_agg_dist_like_and_nonunique_columns</span><span class="s2">():</span>
    <span class="s6"># GH#51099</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s5">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;bar&quot;</span><span class="s2">]}</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">]</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">agg</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s5">&quot;count&quot;</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">].</span><span class="s1">count</span><span class="s2">()</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>