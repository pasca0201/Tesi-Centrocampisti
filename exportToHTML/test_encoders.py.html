<html>
<head>
<title>test_encoders.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_encoders.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>

<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">NotFittedError</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">preprocessing </span><span class="s0">import </span><span class="s1">OneHotEncoder</span><span class="s2">, </span><span class="s1">OrdinalEncoder</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_missing </span><span class="s0">import </span><span class="s1">is_scalar_nan</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_convert_container</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSR_CONTAINERS</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_sparse_dense</span><span class="s2">():</span>
    <span class="s3"># check that sparse and dense will give the same results</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">enc_sparse </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>
    <span class="s1">enc_dense </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">X_trans_sparse </span><span class="s2">= </span><span class="s1">enc_sparse</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_trans_dense </span><span class="s2">= </span><span class="s1">enc_dense</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">X_trans_sparse</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans_dense</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">X_trans_sparse</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">X_trans_dense</span><span class="s2">)</span>

    <span class="s3"># check outcome</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">X_trans_sparse</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans_sparse</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">X_trans_dense</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_handle_unknown</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s3"># Test that one hot encoder raises error for unknown features</span>
    <span class="s3"># present during transform.</span>
    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;error&quot;</span><span class="s2">)</span>
    <span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Found unknown categories&quot;</span><span class="s2">):</span>
        <span class="s1">oh</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>

    <span class="s3"># Test the ignore option, ignores unknown features (giving all 0's)</span>
    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">)</span>
    <span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X2_passed </span><span class="s2">= </span><span class="s1">X2</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">oh</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2_passed</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]]),</span>
    <span class="s2">)</span>
    <span class="s3"># ensure transformed data was not modified in place</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">X2_passed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_handle_unknown_strings</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;11111111&quot;</span><span class="s2">, </span><span class="s5">&quot;22&quot;</span><span class="s2">, </span><span class="s5">&quot;333&quot;</span><span class="s2">, </span><span class="s5">&quot;4444&quot;</span><span class="s2">]).</span><span class="s1">reshape</span><span class="s2">((-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;55555&quot;</span><span class="s2">, </span><span class="s5">&quot;22&quot;</span><span class="s2">]).</span><span class="s1">reshape</span><span class="s2">((-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s3"># Non Regression test for the issue #12470</span>
    <span class="s3"># Test the ignore option, when categories are numpy string dtype</span>
    <span class="s3"># particularly when the known category strings are larger</span>
    <span class="s3"># than the unknown category strings</span>
    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">)</span>
    <span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X2_passed </span><span class="s2">= </span><span class="s1">X2</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">oh</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2_passed</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]]),</span>
    <span class="s2">)</span>
    <span class="s3"># ensure transformed data was not modified in place</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">, </span><span class="s1">X2_passed</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;output_dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;input_dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_dtype</span><span class="s2">(</span><span class="s1">input_dtype</span><span class="s2">, </span><span class="s1">output_dtype</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_dtype</span><span class="s2">)</span>

    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_dtype</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">X_expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">X_expected</span><span class="s2">)</span>

    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_dtype</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;output_dtype&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_dtype_pandas</span><span class="s2">(</span><span class="s1">output_dtype</span><span class="s2">):</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>
    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_dtype</span><span class="s2">)</span>

    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_dtype</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">X_expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">X_expected</span><span class="s2">)</span>

    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">output_dtype</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">), </span><span class="s1">X_expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">), </span><span class="s1">X_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_feature_names</span><span class="s2">():</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;girl&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">41</span><span class="s2">, </span><span class="s5">&quot;girl&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">51</span><span class="s2">, </span><span class="s5">&quot;boy&quot;</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">91</span><span class="s2">, </span><span class="s5">&quot;girl&quot;</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">30</span><span class="s2">],</span>
    <span class="s2">]</span>

    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s5">&quot;x0_Female&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x0_Male&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_1&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_41&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_51&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_91&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x2_boy&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x2_girl&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x3_1&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x3_2&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x3_12&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x3_21&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x4_3&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x4_10&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x4_30&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">feature_names2 </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;three&quot;</span><span class="s2">, </span><span class="s5">&quot;four&quot;</span><span class="s2">, </span><span class="s5">&quot;five&quot;</span><span class="s2">])</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s5">&quot;one_Female&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;one_Male&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;two_1&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;two_41&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;two_51&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;two_91&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;three_boy&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;three_girl&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;four_1&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;four_2&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;four_12&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;four_21&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;five_3&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;five_10&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;five_30&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">feature_names2</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;input_features should have length&quot;</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">([</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_feature_names_unicode</span><span class="s2">():</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;c❤t1&quot;</span><span class="s2">, </span><span class="s5">&quot;dat2&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;x0_c❤t1&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_dat2&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">input_features</span><span class="s2">=[</span><span class="s5">&quot;n👍me&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;n👍me_c❤t1&quot;</span><span class="s2">, </span><span class="s5">&quot;n👍me_dat2&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_custom_feature_name_combiner</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of `feature_name_combiner` as a callable.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">name_combiner</span><span class="s2">(</span><span class="s1">feature</span><span class="s2">, </span><span class="s1">category</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">feature </span><span class="s2">+ </span><span class="s5">&quot;_&quot; </span><span class="s2">+ </span><span class="s1">repr</span><span class="s2">(</span><span class="s1">category</span><span class="s2">)</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">feature_name_combiner</span><span class="s2">=</span><span class="s1">name_combiner</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;None&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;x0_'None'&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_None&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(</span><span class="s1">input_features</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;a_'None'&quot;</span><span class="s2">, </span><span class="s5">&quot;a_None&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">wrong_combiner</span><span class="s2">(</span><span class="s1">feature</span><span class="s2">, </span><span class="s1">category</span><span class="s2">):</span>
        <span class="s3"># we should be returning a Python string</span>
        <span class="s0">return </span><span class="s4">0</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">feature_name_combiner</span><span class="s2">=</span><span class="s1">wrong_combiner</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= (</span>
        <span class="s5">&quot;When `feature_name_combiner` is a callable, it should return a Python string.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_set_params</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]).</span><span class="s1">T</span>
    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>
    <span class="s3"># set params on not yet fitted object</span>
    <span class="s1">oh</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
    <span class="s0">assert </span><span class="s1">oh</span><span class="s2">.</span><span class="s1">get_params</span><span class="s2">()[</span><span class="s5">&quot;categories&quot;</span><span class="s2">] == [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
    <span class="s0">assert </span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">().</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
    <span class="s3"># set params on already fitted object</span>
    <span class="s1">oh</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
    <span class="s0">assert </span><span class="s1">oh</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">().</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_categorical_onehot</span><span class="s2">(</span><span class="s1">X</span><span class="s2">):</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
    <span class="s1">Xtr1 </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">Xtr2 </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xtr1</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">Xtr2</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">Xtr1</span><span class="s2">) </span><span class="s0">and </span><span class="s1">Xtr1</span><span class="s2">.</span><span class="s1">format </span><span class="s2">== </span><span class="s5">&quot;csr&quot;</span>
    <span class="s0">return </span><span class="s1">Xtr1</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[[</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s5">&quot;nan&quot;</span><span class="s2">), </span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">None</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">None</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">None</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s5">&quot;nan&quot;</span><span class="s2">), </span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s5">&quot;mixed&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;numeric&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;mixed-nan&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;mixed-float-nan&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;mixed-None&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;mixed-None-nan&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;mixed-None-float-nan&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder</span><span class="s2">(</span><span class="s1">X</span><span class="s2">):</span>
    <span class="s1">Xtr </span><span class="s2">= </span><span class="s1">check_categorical_onehot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[:, [</span><span class="s4">0</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xtr</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>

    <span class="s1">Xtr </span><span class="s2">= </span><span class="s1">check_categorical_onehot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[:, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xtr</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">Xtr </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xtr</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">(), [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;sparse_&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;first&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_inverse</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">, </span><span class="s1">sparse_</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">sparse_</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">sparse_</span><span class="s2">, </span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">drop </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s3"># with unknown categories</span>
        <span class="s3"># drop is incompatible with handle_unknown=ignore</span>
        <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]</span>
        <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
            <span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">sparse_</span><span class="s2">,</span>
            <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">,</span>
            <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s5">&quot;def&quot;</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">54</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s4">56</span><span class="s2">]],</span>
        <span class="s2">)</span>
        <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">exp</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s3"># with an otherwise numerical output, still object if unknown</span>
        <span class="s1">X </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]</span>
        <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
            <span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">sparse_</span><span class="s2">,</span>
            <span class="s1">categories</span><span class="s2">=[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">54</span><span class="s2">, </span><span class="s4">56</span><span class="s2">]],</span>
            <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">exp</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">exp</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s3"># incorrect shape raises</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s5">&quot;Shape of the passed X data is not correct&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;sparse_&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, X_trans&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]], [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]),</span>
        <span class="s2">(</span>
            <span class="s2">[[</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;three&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;two&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]],</span>
            <span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]],</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_inverse_transform_raise_error_with_unknown</span><span class="s2">(</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">sparse_</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that `inverse_transform` raise an error with unknown samples, no 
    dropped feature, and `handle_unknow=&quot;error`. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/14934 
    &quot;&quot;&quot;</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">sparse_</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">r&quot;Samples \[(\d )*\d\] can not be inverted when drop=None and &quot;</span>
        <span class="s5">r&quot;handle_unknown='error' because they contain all zeros&quot;</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">sparse_</span><span class="s2">:</span>
        <span class="s3"># emulate sparse data transform by a one-hot encoder sparse.</span>
        <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s5">&quot;sparse&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_inverse_if_binary</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s5">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s5">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;reset_drop&quot;</span><span class="s2">, [</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_drop_reset</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">, </span><span class="s1">reset_drop</span><span class="s2">):</span>
    <span class="s3"># check that resetting drop option without refitting does not throw an error</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s5">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s5">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s1">reset_drop</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">X_tr</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(), </span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;method&quot;</span><span class="s2">, [</span><span class="s5">&quot;fit&quot;</span><span class="s2">, </span><span class="s5">&quot;fit_transform&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;X&quot;</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">])])</span>
<span class="s0">def </span><span class="s1">test_X_is_not_1D</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">method</span><span class="s2">):</span>
    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Expected 2D array, got 1D array instead&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;method&quot;</span><span class="s2">, [</span><span class="s5">&quot;fit&quot;</span><span class="s2">, </span><span class="s5">&quot;fit_transform&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_X_is_not_1D_pandas</span><span class="s2">(</span><span class="s1">method</span><span class="s2">):</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">])</span>
    <span class="s1">oh </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">f&quot;Expected a 2-dimensional container but got </span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span><span class="s0">} </span><span class="s5">instead.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">oh</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, cat_exp, cat_dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">([[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]], [[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s5">&quot;def&quot;</span><span class="s2">], [</span><span class="s4">55</span><span class="s2">]], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]), [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">]], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">], [</span><span class="s5">&quot;cat&quot;</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">]]), [[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">], [</span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]), [[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">]], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s5">&quot;nan&quot;</span><span class="s2">)], [</span><span class="s0">None</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s5">&quot;nan&quot;</span><span class="s2">)]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s1">float</span><span class="s2">(</span><span class="s5">&quot;nan&quot;</span><span class="s2">)]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s5">&quot;mixed&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;numeric&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;string&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;missing-float&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;missing-np.nan-object&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;missing-float-nan-object&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_categories</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">cat_exp</span><span class="s2">, </span><span class="s1">cat_dtype</span><span class="s2">):</span>
    <span class="s3"># order of categories should not depend on order of samples</span>
    <span class="s0">for </span><span class="s1">Xi </span><span class="s0">in </span><span class="s2">[</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]]:</span>
        <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xi</span><span class="s2">)</span>
        <span class="s3"># assert enc.categories == 'auto'</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, </span><span class="s1">cat_exp</span><span class="s2">):</span>
            <span class="s1">res_list </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">exp</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]):</span>
                <span class="s0">assert </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">res_list</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">])</span>
                <span class="s0">assert </span><span class="s1">res_list</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">exp</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">exp</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">cat_dtype</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, X2, cats, cat_dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;z&quot;</span><span class="s2">]],</span>
            <span class="s1">object</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;z&quot;</span><span class="s2">]],</span>
            <span class="s1">object</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;z&quot;</span><span class="s2">]],</span>
            <span class="s1">object</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s5">&quot;object&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;numeric&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object-string&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object-string-none&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object-string-nan&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object-None-and-nan&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_specified_categories</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X2</span><span class="s2">, </span><span class="s1">cats</span><span class="s2">, </span><span class="s1">cat_dtype</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">cats</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">cats</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s3"># manually specified categories should have same dtype as</span>
    <span class="s3"># the data when coerced from lists</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">cat_dtype</span>

    <span class="s3"># when specifying categories manually, unknown categories should already</span>
    <span class="s3"># raise when fitting</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Found unknown categories&quot;</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_unsorted_categories</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">]])</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>

    <span class="s3"># unsorted passed categories still raise for numerical values</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]).</span><span class="s1">T</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Unsorted categories are not supported&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Encoder&quot;</span><span class="s2">, [</span><span class="s1">OneHotEncoder</span><span class="s2">, </span><span class="s1">OrdinalEncoder</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_encoder_nan_ending_specified_categories</span><span class="s2">(</span><span class="s1">Encoder</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test encoder for specified categories that nan is at the end. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/27088 
    &quot;&quot;&quot;</span>
    <span class="s1">cats </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">Encoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Nan should be the last element&quot;</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_specified_categories_mixed_columns</span><span class="s2">():</span>
    <span class="s3"># multiple columns</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]])</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s3"># integer categories but from object dtype data</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_pandas</span><span class="s2">():</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>

    <span class="s1">Xtr </span><span class="s2">= </span><span class="s1">check_categorical_onehot</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xtr</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;drop, expected_names&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s5">&quot;first&quot;</span><span class="s2">, [</span><span class="s5">&quot;x0_c&quot;</span><span class="s2">, </span><span class="s5">&quot;x2_b&quot;</span><span class="s2">]),</span>
        <span class="s2">(</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, [</span><span class="s5">&quot;x0_c&quot;</span><span class="s2">, </span><span class="s5">&quot;x1_2&quot;</span><span class="s2">, </span><span class="s5">&quot;x2_b&quot;</span><span class="s2">]),</span>
        <span class="s2">([</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;x0_b&quot;</span><span class="s2">, </span><span class="s5">&quot;x2_a&quot;</span><span class="s2">]),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;binary&quot;</span><span class="s2">, </span><span class="s5">&quot;manual&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_feature_names_drop</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">, </span><span class="s1">expected_names</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]]</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_names</span><span class="s2">, </span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_drop_equals_if_binary</span><span class="s2">():</span>
    <span class="s3"># Canonical case</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s4">10</span><span class="s2">, </span><span class="s5">&quot;yes&quot;</span><span class="s2">], [</span><span class="s4">20</span><span class="s2">, </span><span class="s5">&quot;no&quot;</span><span class="s2">], [</span><span class="s4">30</span><span class="s2">, </span><span class="s5">&quot;yes&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]]</span>
    <span class="s2">)</span>
    <span class="s1">expected_drop_idx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">None</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">, </span><span class="s1">expected_drop_idx</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s3"># with only one cat, the behaviour is equivalent to drop=None</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;true&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;false&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;false&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]])</span>
    <span class="s1">expected_drop_idx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">, </span><span class="s1">expected_drop_idx</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s4">20</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;mixed&quot;</span><span class="s2">, </span><span class="s5">&quot;numeric&quot;</span><span class="s2">, </span><span class="s5">&quot;object&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder</span><span class="s2">(</span><span class="s1">X</span><span class="s2">):</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">()</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;float64&quot;</span><span class="s2">))</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, X2, cats, cat_dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;object&quot;</span><span class="s2">, </span><span class="s5">&quot;numeric&quot;</span><span class="s2">, </span><span class="s5">&quot;object-string-cat&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_specified_categories</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">X2</span><span class="s2">, </span><span class="s1">cats</span><span class="s2">, </span><span class="s1">cat_dtype</span><span class="s2">):</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">cats</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">list</span><span class="s2">(</span><span class="s1">cats</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s3"># manually specified categories should have same dtype as</span>
    <span class="s3"># the data when coerced from lists</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">cat_dtype</span>

    <span class="s3"># when specifying categories manually, unknown categories should already</span>
    <span class="s3"># raise when fitting</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Found unknown categories&quot;</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_inverse</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">]]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">()</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s3"># incorrect shape raises</span>
    <span class="s1">X_tr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s5">&quot;Shape of the passed X data is not correct&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_tr</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_handle_unknowns_string</span><span class="s2">():</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">X_fit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;x&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;z&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;xy&quot;</span><span class="s2">], [</span><span class="s5">&quot;bla&quot;</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;x&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_fit</span><span class="s2">)</span>

    <span class="s1">X_trans_enc </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans_enc</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s1">X_trans_inv </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans_enc</span><span class="s2">)</span>
    <span class="s1">inv_exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;y&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;x&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans_inv</span><span class="s2">, </span><span class="s1">inv_exp</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s1">float</span><span class="s2">, </span><span class="s1">int</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_handle_unknowns_numeric</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">999</span><span class="s2">)</span>
    <span class="s1">X_fit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">12</span><span class="s2">], [</span><span class="s4">23</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_fit</span><span class="s2">)</span>

    <span class="s1">X_trans_enc </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">999</span><span class="s2">], [-</span><span class="s4">999</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans_enc</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s1">X_trans_inv </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans_enc</span><span class="s2">)</span>
    <span class="s1">inv_exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s4">8</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans_inv</span><span class="s2">, </span><span class="s1">inv_exp</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_handle_unknowns_nan</span><span class="s2">():</span>
    <span class="s3"># Make sure unknown_value=np.nan properly works</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

    <span class="s1">X_fit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">]])</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_fit</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_handle_unknowns_nan_non_float_dtype</span><span class="s2">():</span>
    <span class="s3"># Make sure an error is raised when unknown_value=np.nan and the dtype</span>
    <span class="s3"># isn't a float dtype</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span>
    <span class="s2">)</span>

    <span class="s1">X_fit </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;dtype parameter should be a float dtype&quot;</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_fit</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_raise_categories_shape</span><span class="s2">():</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;Low&quot;</span><span class="s2">, </span><span class="s5">&quot;Medium&quot;</span><span class="s2">, </span><span class="s5">&quot;High&quot;</span><span class="s2">, </span><span class="s5">&quot;Medium&quot;</span><span class="s2">, </span><span class="s5">&quot;Low&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">cats </span><span class="s2">= [</span><span class="s5">&quot;Low&quot;</span><span class="s2">, </span><span class="s5">&quot;Medium&quot;</span><span class="s2">, </span><span class="s5">&quot;High&quot;</span><span class="s2">]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Shape mismatch: if categories is an array,&quot;</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_encoder_dtypes</span><span class="s2">():</span>
    <span class="s3"># check that dtypes are preserved when determining categories</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;float64&quot;</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">X </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;float64&quot;</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]]),  </span><span class="s3"># str dtype</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s7">b&quot;a&quot;</span><span class="s2">, </span><span class="s7">b&quot;b&quot;</span><span class="s2">], [</span><span class="s7">b&quot;c&quot;</span><span class="s2">, </span><span class="s7">b&quot;d&quot;</span><span class="s2">]]),  </span><span class="s3"># bytes dtype</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;object&quot;</span><span class="s2">),</span>
    <span class="s2">]:</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]]</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]]</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">&quot;object&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_encoder_dtypes_pandas</span><span class="s2">():</span>
    <span class="s3"># check dtype (similar to test_categorical_encoder_dtypes for dataframes)</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;float64&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s5">&quot;int64&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s5">&quot;C&quot;</span><span class="s2">: [</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">]})</span>
    <span class="s1">X_type </span><span class="s2">= [</span><span class="s1">X</span><span class="s2">[</span><span class="s5">&quot;A&quot;</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[</span><span class="s5">&quot;B&quot;</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">X</span><span class="s2">[</span><span class="s5">&quot;C&quot;</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">]</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">([</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">X_type</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">(), </span><span class="s1">exp</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_warning</span><span class="s2">():</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s5">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_no_warnings</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;missing_value&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">float</span><span class="s2">(</span><span class="s5">&quot;nan&quot;</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_one_hot_encoder_drop_manual</span><span class="s2">(</span><span class="s1">missing_value</span><span class="s2">):</span>
    <span class="s1">cats_to_drop </span><span class="s2">= [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s1">missing_value</span><span class="s2">]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s1">cats_to_drop</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">56</span><span class="s2">, </span><span class="s1">missing_value</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">exp </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">drop </span><span class="s0">is </span><span class="s1">cats_to_drop</span>

    <span class="s1">dropped_cats </span><span class="s2">= [</span>
        <span class="s1">cat</span><span class="s2">[</span><span class="s1">feature</span><span class="s2">] </span><span class="s0">for </span><span class="s1">cat</span><span class="s2">, </span><span class="s1">feature </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">)</span>
    <span class="s2">]</span>
    <span class="s1">X_inv_trans </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">trans</span><span class="s2">)</span>
    <span class="s1">X_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>

    <span class="s3"># last value is np.nan</span>
    <span class="s0">if </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">cats_to_drop</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]):</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dropped_cats</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">cats_to_drop</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">dropped_cats</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">cats_to_drop</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s3"># do not include the last column which includes missing values</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">[:, :-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">X_inv_trans</span><span class="s2">[:, :-</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s3"># check last column is the missing value</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, :-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">X_inv_trans</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, :-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">X_inv_trans</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">dropped_cats</span><span class="s2">, </span><span class="s1">cats_to_drop</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_array</span><span class="s2">, </span><span class="s1">X_inv_trans</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">41</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_invalid_drop_length</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s5">&quot;`drop` should have length equal to the number&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">([[</span><span class="s5">&quot;abc&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">55</span><span class="s2">], [</span><span class="s5">&quot;def&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">59</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;density&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;sparse&quot;</span><span class="s2">, </span><span class="s5">&quot;dense&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [</span><span class="s5">&quot;first&quot;</span><span class="s2">, [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">ids</span><span class="s2">=[</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;manual&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_categories</span><span class="s2">(</span><span class="s1">density</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s1">ohe_base </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">density</span><span class="s2">)</span>
    <span class="s1">ohe_test </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s1">density</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]]</span>
    <span class="s1">ohe_base</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe_base</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, </span><span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">drop </span><span class="s2">== </span><span class="s5">&quot;first&quot;</span><span class="s2">:</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">drop_cat</span><span class="s2">, </span><span class="s1">drop_idx</span><span class="s2">, </span><span class="s1">cat_list </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span>
            <span class="s1">drop</span><span class="s2">, </span><span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">, </span><span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">categories_</span>
        <span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">cat_list</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">drop_idx</span><span class="s2">)] == </span><span class="s1">drop_cat</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ohe_test</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Encoder&quot;</span><span class="s2">, [</span><span class="s1">OneHotEncoder</span><span class="s2">, </span><span class="s1">OrdinalEncoder</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_encoders_has_categorical_tags</span><span class="s2">(</span><span class="s1">Encoder</span><span class="s2">):</span>
    <span class="s0">assert </span><span class="s5">&quot;categorical&quot; </span><span class="s0">in </span><span class="s1">Encoder</span><span class="s2">().</span><span class="s1">_get_tags</span><span class="s2">()[</span><span class="s5">&quot;X_types&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">11</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">0.29</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">12</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;categories&quot;</span><span class="s2">, [</span><span class="s5">&quot;auto&quot;</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]]])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_two_levels</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">categories</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that different parameters for combine 'a', 'c', and 'd' into 
    the infrequent category works as expected.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s1">expected_inv </span><span class="s2">= [[</span><span class="s1">col</span><span class="s2">] </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">] + [</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">] * </span><span class="s4">4</span><span class="s2">]</span>
    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>

    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;x0_b&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s5">&quot;first&quot;</span><span class="s2">, [</span><span class="s5">&quot;b&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_two_levels_drop_frequent</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test two levels and dropping the frequent category.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]] == </span><span class="s5">&quot;b&quot;</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">]])</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>

    <span class="s1">X_inverse </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">]], </span><span class="s1">X_inverse</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_two_levels_drop_infrequent_errors</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test two levels and dropping any infrequent category removes the 
    whole infrequent category.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">f&quot;Unable to drop category </span><span class="s0">{</span><span class="s1">drop</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span><span class="s0">!r} </span><span class="s5">from feature 0 because it is infrequent&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">9</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">0.24</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">0.16</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_three_levels</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test that different parameters for combing 'a', and 'd' into 
    the infrequent category works as expected.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s1">expected_inv </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>

    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s5">&quot;x0_b&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_c&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">], </span><span class="s1">feature_names</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [</span><span class="s5">&quot;first&quot;</span><span class="s2">, [</span><span class="s5">&quot;b&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_three_levels_drop_frequent</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test three levels and dropping the frequent category.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>

    <span class="s3"># Check handle_unknown=&quot;ignore&quot;</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Found unknown categories&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]])</span>

    <span class="s1">assert_allclose</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]], </span><span class="s1">X_trans</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;drop&quot;</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_three_levels_drop_infrequent_errors</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test three levels and dropping the infrequent category.&quot;&quot;&quot;</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s5">f&quot;Unable to drop category </span><span class="s0">{</span><span class="s1">drop</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span><span class="s0">!r} </span><span class="s5">from feature 0 because it is infrequent&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ohe_infrequent_handle_unknown_error</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that different parameters for combining 'a', and 'd' into 
    the infrequent category works as expected.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;error&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>

    <span class="s3"># all categories are known</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s3"># 'bad' is not known and will error</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;bad&quot;</span><span class="s2">]]</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s5">r&quot;Found unknown categories \['bad'\] in column 0&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;kwargs&quot;</span><span class="s2">, [{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}, {</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">}]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_two_levels_user_cats_one_frequent</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;'a' is the only frequent category, all other categories are infrequent.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;e&quot;</span><span class="s2">] * </span><span class="s4">30</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]],</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s3"># 'a' is dropped</span>
    <span class="s1">drops </span><span class="s2">= [</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, [</span><span class="s5">&quot;a&quot;</span><span class="s2">]]</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">]]</span>
    <span class="s0">for </span><span class="s1">drop </span><span class="s0">in </span><span class="s1">drops</span><span class="s2">:</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s1">drop</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_ohe_infrequent_two_levels_user_cats</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that the order of the categories provided by a user is respected.&quot;&quot;&quot;</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]],</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s3"># 'infrequent' is used to denote the infrequent categories for</span>
    <span class="s3"># `inverse_transform`</span>
    <span class="s1">expected_inv </span><span class="s2">= [[</span><span class="s1">col</span><span class="s2">] </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">] + [</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">] * </span><span class="s4">4</span><span class="s2">]</span>
    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ohe_infrequent_three_levels_user_cats</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that the order of the categories provided by a user is respected. 
    In this case 'c' is encoded as the first category and 'b' is encoded 
    as the second one.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]],</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s3"># 'infrequent' is used to denote the infrequent categories for</span>
    <span class="s3"># `inverse_transform`</span>
    <span class="s1">expected_inv </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ohe_infrequent_mixed</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test infrequent categories where feature 0 has infrequent categories, 
    and feature 1 does not.&quot;&quot;&quot;</span>

    <span class="s3"># X[:, 0] 1 and 2 are infrequent</span>
    <span class="s3"># X[:, 1] nothing is infrequent</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s3"># feature 1 is binary so it drops a category 0</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ohe_infrequent_multiple_categories</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test infrequent categories with feature matrix with 3 features.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
    <span class="s2">]</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span>
    <span class="s2">)</span>
    <span class="s3"># X[:, 0] 1 and 2 are infrequent</span>
    <span class="s3"># X[:, 1] 1 and 10 are infrequent</span>
    <span class="s3"># X[:, 2] nothing is infrequent</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s3"># 'infrequent' is used to denote the infrequent categories</span>
    <span class="s3"># For the first column, 1 and 2 have the same frequency. In this case,</span>
    <span class="s3"># 1 will be chosen to be the feature name because is smaller lexiconically</span>
    <span class="s1">feature_names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s5">&quot;x0_0&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x0_3&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_0&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_5&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x1_infrequent_sklearn&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x2_0&quot;</span><span class="s2">,</span>
            <span class="s5">&quot;x2_1&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">feature_names</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
    <span class="s2">]</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>

    <span class="s1">X_test_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s3"># X[:, 2] does not have an infrequent category, thus it is encoded as all</span>
    <span class="s3"># zeros</span>
    <span class="s1">expected </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_test_trans</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">())</span>

    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">)</span>
    <span class="s1">expected_inv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], [</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>

    <span class="s3"># error for unknown categories</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;error&quot;</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Found unknown categories&quot;</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s3"># only infrequent or known categories</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">X_test_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_test_trans</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">())</span>

    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">)</span>

    <span class="s1">expected_inv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ohe_infrequent_multiple_categories_dtypes</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test infrequent categories with a pandas dataframe with multiple dtypes.&quot;&quot;&quot;</span>

    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;str&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;int&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
        <span class="s2">},</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;str&quot;</span><span class="s2">, </span><span class="s5">&quot;int&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=</span><span class="s5">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span>
    <span class="s2">)</span>
    <span class="s3"># X[:, 0] 'a', 'b', 'c' have the same frequency. 'a' and 'b' will be</span>
    <span class="s3"># considered infrequent because they are greater</span>

    <span class="s3"># X[:, 1] 0, 3, 5, 10 has frequency 2 and 12 has frequency 1.</span>
    <span class="s3"># 0, 3, 12 will be considered infrequent</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">12</span><span class="s2">])</span>

    <span class="s1">expected </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
    <span class="s2">]</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_trans</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;str&quot;</span><span class="s2">: [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">], </span><span class="s5">&quot;int&quot;</span><span class="s2">: [</span><span class="s4">14</span><span class="s2">, </span><span class="s4">12</span><span class="s2">]}, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;str&quot;</span><span class="s2">, </span><span class="s5">&quot;int&quot;</span><span class="s2">])</span>

    <span class="s1">expected </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">X_test_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_test_trans</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">())</span>

    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">)</span>
    <span class="s1">expected_inv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">], [</span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">]],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>

    <span class="s3"># only infrequent or known categories</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;str&quot;</span><span class="s2">: [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s5">&quot;int&quot;</span><span class="s2">: [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]}, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;str&quot;</span><span class="s2">, </span><span class="s5">&quot;int&quot;</span><span class="s2">])</span>
    <span class="s1">X_test_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">expected </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">X_test_trans</span><span class="s2">)</span>

    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">)</span>
    <span class="s1">expected_inv </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">], [</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">expected_inv</span><span class="s2">, </span><span class="s1">X_inv</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;kwargs&quot;</span><span class="s2">, [{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">21</span><span class="s2">, </span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_one_level_errors</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;All user provided categories are infrequent.&quot;&quot;&quot;</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">2</span><span class="s2">]).</span><span class="s1">T</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, **</span><span class="s1">kwargs</span>
    <span class="s2">)</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;kwargs&quot;</span><span class="s2">, [{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}])</span>
<span class="s0">def </span><span class="s1">test_ohe_infrequent_user_cats_unknown_training_errors</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;All user provided categories are infrequent.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;e&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]],</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]])</span>


<span class="s3"># deliberately omit 'OS' as an invalid combo</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;input_dtype, category_dtype&quot;</span><span class="s2">, [</span><span class="s5">&quot;OO&quot;</span><span class="s2">, </span><span class="s5">&quot;OU&quot;</span><span class="s2">, </span><span class="s5">&quot;UO&quot;</span><span class="s2">, </span><span class="s5">&quot;UU&quot;</span><span class="s2">, </span><span class="s5">&quot;SO&quot;</span><span class="s2">, </span><span class="s5">&quot;SU&quot;</span><span class="s2">, </span><span class="s5">&quot;SS&quot;</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;array_type&quot;</span><span class="s2">, [</span><span class="s5">&quot;list&quot;</span><span class="s2">, </span><span class="s5">&quot;array&quot;</span><span class="s2">, </span><span class="s5">&quot;dataframe&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_encoders_string_categories</span><span class="s2">(</span><span class="s1">input_dtype</span><span class="s2">, </span><span class="s1">category_dtype</span><span class="s2">, </span><span class="s1">array_type</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that encoding work with object, unicode, and byte string dtypes. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/15616 
    https://github.com/scikit-learn/scikit-learn/issues/15726 
    https://github.com/scikit-learn/scikit-learn/issues/19677 
    &quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span><span class="s2">)</span>
    <span class="s1">categories </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">category_dtype</span><span class="s2">)]</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">_convert_container</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">array_type</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">input_dtype</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_mixed_string_bytes_categoricals</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that this mixture of predefined categories and X raises an error. 
 
    Categories defined as bytes can not easily be compared to data that is 
    a string. 
    &quot;&quot;&quot;</span>
    <span class="s3"># data as unicode</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;U&quot;</span><span class="s2">)</span>
    <span class="s3"># predefined categories as bytes</span>
    <span class="s1">categories </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;S&quot;</span><span class="s2">)]</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s5">&quot;In column 0, the predefined categories have type 'bytes' which is incompatible&quot;</span>
        <span class="s5">&quot; with values of type 'str_'.&quot;</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;missing_value&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ohe_missing_values_get_feature_names</span><span class="s2">(</span><span class="s1">missing_value</span><span class="s2">):</span>
    <span class="s3"># encoder with missing values with object dtypes</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s1">missing_value</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">missing_value</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">names </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">names</span><span class="s2">, [</span><span class="s5">&quot;x0_a&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_b&quot;</span><span class="s2">, </span><span class="s5">f&quot;x0_</span><span class="s0">{</span><span class="s1">missing_value</span><span class="s0">}</span><span class="s5">&quot;</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_ohe_missing_value_support_pandas</span><span class="s2">():</span>
    <span class="s3"># check support for pandas with mixed dtypes and missing values</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;col1&quot;</span><span class="s2">: [</span><span class="s5">&quot;dog&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;col2&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">),</span>
        <span class="s2">},</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;col1&quot;</span><span class="s2">, </span><span class="s5">&quot;col2&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">expected_df_trans </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">Xtr </span><span class="s2">= </span><span class="s1">check_categorical_onehot</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Xtr</span><span class="s2">, </span><span class="s1">expected_df_trans</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">, </span><span class="s5">&quot;ignore&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;pd_nan_type&quot;</span><span class="s2">, [</span><span class="s5">&quot;pd.NA&quot;</span><span class="s2">, </span><span class="s5">&quot;np.nan&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ohe_missing_value_support_pandas_categorical</span><span class="s2">(</span><span class="s1">pd_nan_type</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s3"># checks pandas dataframe with categorical features</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">pd_missing_value </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA </span><span class="s0">if </span><span class="s1">pd_nan_type </span><span class="s2">== </span><span class="s5">&quot;pd.NA&quot; </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">pd_missing_value</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;category&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">expected_df_trans </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">)</span>
    <span class="s1">df_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected_df_trans</span><span class="s2">, </span><span class="s1">df_trans</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][:-</span><span class="s4">1</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][-</span><span class="s4">1</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ohe_drop_first_handle_unknown_ignore_warns</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check drop='first' and handle_unknown='ignore'/'infrequent_if_exist' 
    during transform.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">X_expected</span><span class="s2">)</span>

    <span class="s3"># Both categories are unknown</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>

    <span class="s1">warn_msg </span><span class="s2">= (</span>
        <span class="s5">r&quot;Found unknown categories in columns \[0, 1\] during &quot;</span>
        <span class="s5">&quot;transform. These unknown categories will be encoded as all &quot;</span>
        <span class="s5">&quot;zeros&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warn_msg</span><span class="s2">):</span>
        <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">X_expected</span><span class="s2">)</span>

    <span class="s3"># inverse_transform maps to None</span>
    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inv</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ohe_drop_if_binary_handle_unknown_ignore_warns</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check drop='if_binary' and handle_unknown='ignore' during transform.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">X_expected</span><span class="s2">)</span>

    <span class="s3"># Both categories are unknown</span>
    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>

    <span class="s1">warn_msg </span><span class="s2">= (</span>
        <span class="s5">r&quot;Found unknown categories in columns \[0, 1\] during &quot;</span>
        <span class="s5">&quot;transform. These unknown categories will be encoded as all &quot;</span>
        <span class="s5">&quot;zeros&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warn_msg</span><span class="s2">):</span>
        <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">X_expected</span><span class="s2">)</span>

    <span class="s3"># inverse_transform maps to None</span>
    <span class="s1">X_inv </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_expected</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inv</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;handle_unknown&quot;</span><span class="s2">, [</span><span class="s5">&quot;ignore&quot;</span><span class="s2">, </span><span class="s5">&quot;infrequent_if_exist&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ohe_drop_first_explicit_categories</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check drop='first' and handle_unknown='ignore'/'infrequent_if_exist' 
    during fit with categories passed in.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span>
        <span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;first&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s1">handle_unknown</span><span class="s2">,</span>
        <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]],</span>
    <span class="s2">)</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">X_expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>

    <span class="s1">warn_msg </span><span class="s2">= (</span>
        <span class="s5">r&quot;Found unknown categories in columns \[0\] during transform. &quot;</span>
        <span class="s5">r&quot;These unknown categories will be encoded as all zeros&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">warn_msg</span><span class="s2">):</span>
        <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">X_expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ohe_more_informative_error_message</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Raise informative error message when pandas output and sparse_output=True.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s5">&quot;b&quot;</span><span class="s2">: [</span><span class="s5">&quot;z&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]}, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">&quot;Pandas output does not support sparse data. Set &quot;</span>
        <span class="s5">&quot;sparse_output=False to output pandas dataframes or disable Pandas output&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_passthrough_missing_values_float_errors_dtype</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test ordinal encoder with nan passthrough fails when dtype=np.int32.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]]).</span><span class="s1">T</span>
    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s5">r&quot;There are missing values in features \[0\]. For OrdinalEncoder &quot;</span>
        <span class="s5">f&quot;to encode missing values with dtype: </span><span class="s0">{</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s0">}</span><span class="s5">&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">oe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;encoded_missing_value&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_passthrough_missing_values_float</span><span class="s2">(</span><span class="s1">encoded_missing_value</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test ordinal encoder with nan on float dtypes.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">encoded_missing_value</span><span class="s2">=</span><span class="s1">encoded_missing_value</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">) == </span><span class="s4">1</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s1">encoded_missing_value</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">]])</span>

    <span class="s1">X_inverse </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;pd_nan_type&quot;</span><span class="s2">, [</span><span class="s5">&quot;pd.NA&quot;</span><span class="s2">, </span><span class="s5">&quot;np.nan&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;encoded_missing_value&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_missing_value_support_pandas_categorical</span><span class="s2">(</span>
    <span class="s1">pd_nan_type</span><span class="s2">, </span><span class="s1">encoded_missing_value</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check ordinal encoder is compatible with pandas.&quot;&quot;&quot;</span>
    <span class="s3"># checks pandas dataframe with categorical features</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">pd_missing_value </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA </span><span class="s0">if </span><span class="s1">pd_nan_type </span><span class="s2">== </span><span class="s5">&quot;pd.NA&quot; </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">pd_missing_value</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;category&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">encoded_missing_value</span><span class="s2">=</span><span class="s1">encoded_missing_value</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][:</span><span class="s4">3</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][-</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s1">df_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">df_trans</span><span class="s2">, [[</span><span class="s4">2.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">], [</span><span class="s1">encoded_missing_value</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">]])</span>

    <span class="s1">X_inverse </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">df_trans</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_inverse</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">[</span><span class="s4">3</span><span class="s2">:, </span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, X2, cats, cat_dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)],</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)],</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3.0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])],</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s5">&quot;object-None-missing-value&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;object-nan-missing_value&quot;</span><span class="s2">,</span>
        <span class="s5">&quot;numeric-missing-value&quot;</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_specified_categories_missing_passthrough</span><span class="s2">(</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">X2</span><span class="s2">, </span><span class="s1">cats</span><span class="s2">, </span><span class="s1">cat_dtype</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test ordinal encoder for specified categories.&quot;&quot;&quot;</span>
    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s1">exp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">exp</span><span class="s2">)</span>
    <span class="s3"># manually specified categories should have same dtype as</span>
    <span class="s3"># the data when coerced from lists</span>
    <span class="s0">assert </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">cat_dtype</span>

    <span class="s3"># when specifying categories manually, unknown categories should already</span>
    <span class="s3"># raise when fitting</span>
    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Found unknown categories&quot;</span><span class="s2">):</span>
        <span class="s1">oe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Encoder&quot;</span><span class="s2">, [</span><span class="s1">OneHotEncoder</span><span class="s2">, </span><span class="s1">OrdinalEncoder</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_encoder_duplicate_specified_categories</span><span class="s2">(</span><span class="s1">Encoder</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test encoder for specified categories have duplicate values. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/27088 
    &quot;&quot;&quot;</span>
    <span class="s1">cats </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)]</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">Encoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">cats</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;the predefined categories contain duplicate elements.&quot;</span>
    <span class="s2">):</span>
        <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X, expected_X_trans, X_test&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">4.0</span><span class="s2">]]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]]),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;d&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_handle_missing_and_unknown</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">expected_X_trans</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test the interaction between missing values and handle_unknown&quot;&quot;&quot;</span>

    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected_X_trans</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), [[-</span><span class="s4">1.0</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_sparse</span><span class="s2">(</span><span class="s1">csr_container</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise proper error with sparse input in OrdinalEncoder. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/19878 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">X_sparse </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">encoder </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">()</span>

    <span class="s1">err_msg </span><span class="s2">= </span><span class="s5">&quot;Sparse data was passed, but dense data is required&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">encoder</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">encoder</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_sparse</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_trans_sparse </span><span class="s2">= </span><span class="s1">csr_container</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">encoder</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans_sparse</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_fit_with_unseen_category</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check OrdinalEncoder.fit works with unseen category when 
    `handle_unknown=&quot;use_encoded_value&quot;`. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/19872 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">])[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=[[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">999</span>
    <span class="s2">)</span>
    <span class="s1">oe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;error&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Found unknown categories&quot;</span><span class="s2">):</span>
        <span class="s1">oe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X_train&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[[</span><span class="s5">&quot;AA&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;AA&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;O&quot;</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;AA&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;U&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X_test&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;O&quot;</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s5">&quot;U&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_handle_unknown_string_dtypes</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Checks that `OrdinalEncoder` transforms string dtypes. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/19872 
    &quot;&quot;&quot;</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">9</span><span class="s2">)</span>
    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[-</span><span class="s4">9</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_python_integer</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that `OrdinalEncoder` accepts Python integers that are potentially 
    larger than 64 bits. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/20721 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s4">44253463435747313673</span><span class="s2">,</span>
            <span class="s4">9867966753463435747313673</span><span class="s2">,</span>
            <span class="s4">44253462342215747313673</span><span class="s2">,</span>
            <span class="s4">442534634357764313673</span><span class="s2">,</span>
        <span class="s2">]</span>
    <span class="s2">).</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">encoder </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">).</span><span class="s1">T</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_features_names_out_pandas</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check feature names out is same as the input.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">names </span><span class="s2">= [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">names</span><span class="s2">)</span>
    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">feature_names_out </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">names</span><span class="s2">, </span><span class="s1">feature_names_out</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_unknown_missing_interaction</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check interactions between encode_unknown and missing value encoding.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>

    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">,</span>
        <span class="s1">unknown_value</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
        <span class="s1">encoded_missing_value</span><span class="s2">=-</span><span class="s4">3</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">]])</span>

    <span class="s3"># &quot;c&quot; is unknown and is mapped to np.nan</span>
    <span class="s3"># &quot;None&quot; is a missing value and is set to -3</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">X_test_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">, [[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">]])</span>

    <span class="s3"># Non-regression test for #24082</span>
    <span class="s1">X_roundtrip </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">)</span>

    <span class="s3"># np.nan is unknown so it maps to None</span>
    <span class="s0">assert </span><span class="s1">X_roundtrip</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">0</span><span class="s2">] </span><span class="s0">is None</span>

    <span class="s3"># -3 is the encoded missing value so it maps back to nan</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">X_roundtrip</span><span class="s2">[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;with_pandas&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_encoded_missing_value_error</span><span class="s2">(</span><span class="s1">with_pandas</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check OrdinalEncoder errors when encoded_missing_value is used by 
    an known category.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;dog&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>

    <span class="s3"># The 0-th feature has no missing values so it is not included in the list of</span>
    <span class="s3"># features</span>
    <span class="s1">error_msg </span><span class="s2">= (</span>
        <span class="s5">r&quot;encoded_missing_value \(1\) is already used to encode a known category &quot;</span>
        <span class="s5">r&quot;in features: &quot;</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">with_pandas</span><span class="s2">:</span>
        <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;letter&quot;</span><span class="s2">, </span><span class="s5">&quot;pet&quot;</span><span class="s2">])</span>
        <span class="s1">error_msg </span><span class="s2">= </span><span class="s1">error_msg </span><span class="s2">+ </span><span class="s5">r&quot;\['pet'\]&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">error_msg </span><span class="s2">= </span><span class="s1">error_msg </span><span class="s2">+ </span><span class="s5">r&quot;\[1\]&quot;</span>

    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">encoded_missing_value</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_msg</span><span class="s2">):</span>
        <span class="s1">oe</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;X_train, X_test_trans_expected, X_roundtrip_expected&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span>
            <span class="s3"># missing value is not in training set</span>
            <span class="s3"># inverse transform will considering encoded nan as unknown</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;1&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s2">[[</span><span class="s4">0</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">&quot;1&quot;</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s3"># missing value in training set,</span>
            <span class="s3"># inverse transform will considering encoded nan as missing</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">&quot;1&quot;</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s2">[[</span><span class="s4">0</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]],</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s5">&quot;1&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_unknown_missing_interaction_both_nan</span><span class="s2">(</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test_trans_expected</span><span class="s2">, </span><span class="s1">X_roundtrip_expected</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check transform when unknown_value and encoded_missing_value is nan. 
 
    Non-regression test for #24082. 
    &quot;&quot;&quot;</span>
    <span class="s1">oe </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">,</span>
        <span class="s1">unknown_value</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
        <span class="s1">encoded_missing_value</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;1&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">]])</span>
    <span class="s1">X_test_trans </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>

    <span class="s3"># both nan and unknown are encoded as nan</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">, </span><span class="s1">X_test_trans_expected</span><span class="s2">)</span>
    <span class="s1">X_roundtrip </span><span class="s2">= </span><span class="s1">oe</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_test_trans</span><span class="s2">)</span>

    <span class="s1">n_samples </span><span class="s2">= </span><span class="s1">X_roundtrip_expected</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">):</span>
        <span class="s1">expected_val </span><span class="s2">= </span><span class="s1">X_roundtrip_expected</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">X_roundtrip</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">expected_val </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">val </span><span class="s0">is None</span>
        <span class="s0">elif </span><span class="s1">is_scalar_nan</span><span class="s2">(</span><span class="s1">expected_val</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">val </span><span class="s2">== </span><span class="s1">expected_val</span>


<span class="s0">def </span><span class="s1">test_one_hot_encoder_set_output</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check OneHotEncoder works with set_output.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">()</span>

    <span class="s1">ohe</span><span class="s2">.</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">match </span><span class="s2">= </span><span class="s5">&quot;Pandas output does not support sparse data. Set sparse_output=False&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>

    <span class="s1">ohe_default </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;default&quot;</span><span class="s2">)</span>
    <span class="s1">ohe_pandas </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">).</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X_default </span><span class="s2">= </span><span class="s1">ohe_default</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>
    <span class="s1">X_pandas </span><span class="s2">= </span><span class="s1">ohe_pandas</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_pandas</span><span class="s2">.</span><span class="s1">to_numpy</span><span class="s2">(), </span><span class="s1">X_default</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe_pandas</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(), </span><span class="s1">X_pandas</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_set_output</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check OrdinalEncoder works with set_output.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X_df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]})</span>

    <span class="s1">ord_default </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">().</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;default&quot;</span><span class="s2">)</span>
    <span class="s1">ord_pandas </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">().</span><span class="s1">set_output</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">=</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>

    <span class="s1">X_default </span><span class="s2">= </span><span class="s1">ord_default</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>
    <span class="s1">X_pandas </span><span class="s2">= </span><span class="s1">ord_pandas</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_df</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_pandas</span><span class="s2">.</span><span class="s1">to_numpy</span><span class="s2">(), </span><span class="s1">X_default</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ord_pandas</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(), </span><span class="s1">X_pandas</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_predefined_categories_dtype</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that the categories_ dtype is `object` for string categories 
 
    Regression test for gh-25171. 
    &quot;&quot;&quot;</span>
    <span class="s1">categories </span><span class="s2">= [[</span><span class="s5">&quot;as&quot;</span><span class="s2">, </span><span class="s5">&quot;mmas&quot;</span><span class="s2">, </span><span class="s5">&quot;eas&quot;</span><span class="s2">, </span><span class="s5">&quot;ras&quot;</span><span class="s2">, </span><span class="s5">&quot;acs&quot;</span><span class="s2">], [</span><span class="s5">&quot;1&quot;</span><span class="s2">, </span><span class="s5">&quot;2&quot;</span><span class="s2">]]</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">)</span>

    <span class="s1">enc</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">([[</span><span class="s5">&quot;as&quot;</span><span class="s2">, </span><span class="s5">&quot;1&quot;</span><span class="s2">]])</span>

    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">n</span><span class="s2">, </span><span class="s1">cat </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">enc</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">[</span><span class="s1">n</span><span class="s2">], </span><span class="s1">cat</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_missing_unknown_encoding_max</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check missing value or unknown encoding can equal the cardinality.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;dog&quot;</span><span class="s2">], [</span><span class="s5">&quot;cat&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">encoded_missing_value</span><span class="s2">=</span><span class="s4">2</span><span class="s2">).</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">]])</span>

    <span class="s1">enc </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=</span><span class="s4">2</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;snake&quot;</span><span class="s2">]])</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">enc</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">2</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_drop_idx_infrequent_categories</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check drop_idx is defined correctly with infrequent categories. 
 
    Non-regression test for gh-25550. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;e&quot;</span><span class="s2">] * </span><span class="s4">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">min_frequency</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;first&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(), [</span><span class="s5">&quot;x0_c&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_d&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_e&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]] == </span><span class="s5">&quot;b&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">min_frequency</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s5">&quot;if_binary&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(), [</span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]] == </span><span class="s5">&quot;c&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;e&quot;</span><span class="s2">] * </span><span class="s4">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">min_frequency</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=[</span><span class="s5">&quot;d&quot;</span><span class="s2">]).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(), [</span><span class="s5">&quot;x0_b&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_c&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_e&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]] == </span><span class="s5">&quot;d&quot;</span>

    <span class="s1">ohe </span><span class="s2">= </span><span class="s1">OneHotEncoder</span><span class="s2">(</span><span class="s1">min_frequency</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">sparse_output</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">None</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span>
        <span class="s1">ohe</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">(),</span>
        <span class="s2">[</span><span class="s5">&quot;x0_b&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_c&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_d&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_e&quot;</span><span class="s2">, </span><span class="s5">&quot;x0_infrequent_sklearn&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ohe</span><span class="s2">.</span><span class="s1">drop_idx_ </span><span class="s0">is None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">9</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">0.24</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">0.16</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">, </span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_infrequent_three_levels</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Test parameters for grouping 'a', and 'd' into the infrequent category.&quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">, **</span><span class="s1">kwargs</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;z&quot;</span><span class="s2">]]</span>
    <span class="s1">expected_trans </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected_trans</span><span class="s2">)</span>

    <span class="s1">X_inverse </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">expected_inverse </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s0">None</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">, </span><span class="s1">expected_inverse</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_infrequent_three_levels_user_cats</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that the order of the categories provided by a user is respected. 
 
    In this case 'c' is encoded as the first category and 'b' is encoded 
    as the second one. 
    &quot;&quot;&quot;</span>

    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]],</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">,</span>
        <span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">categories_</span><span class="s2">, [[</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;d&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;z&quot;</span><span class="s2">]]</span>
    <span class="s1">expected_trans </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected_trans</span><span class="s2">)</span>

    <span class="s1">X_inverse </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">expected_inverse </span><span class="s2">= [</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;b&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s0">None</span><span class="s2">],</span>
    <span class="s2">]</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">, </span><span class="s1">expected_inverse</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_infrequent_mixed</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test when feature 0 has infrequent categories and feature 1 does not.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">(([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]))</span>

    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] </span><span class="s0">is None</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">expected_trans </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected_trans</span><span class="s2">)</span>

    <span class="s1">X_inverse </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">)</span>
    <span class="s1">expected_inverse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;infrequent_sklearn&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X_inverse</span><span class="s2">, </span><span class="s1">expected_inverse</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_infrequent_multiple_categories_dtypes</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test infrequent categories with a pandas DataFrame with multiple dtypes.&quot;&quot;&quot;</span>

    <span class="s1">pd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s5">&quot;pandas&quot;</span><span class="s2">)</span>
    <span class="s1">categorical_dtype </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">CategoricalDtype</span><span class="s2">([</span><span class="s5">&quot;bird&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">, </span><span class="s5">&quot;dog&quot;</span><span class="s2">, </span><span class="s5">&quot;snake&quot;</span><span class="s2">])</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;str&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;int&quot;</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s5">&quot;categorical&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s5">&quot;dog&quot;</span><span class="s2">] * </span><span class="s4">4 </span><span class="s2">+ [</span><span class="s5">&quot;cat&quot;</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s5">&quot;snake&quot;</span><span class="s2">] + [</span><span class="s5">&quot;bird&quot;</span><span class="s2">],</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">categorical_dtype</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">},</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;str&quot;</span><span class="s2">, </span><span class="s5">&quot;int&quot;</span><span class="s2">, </span><span class="s5">&quot;categorical&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s3"># X[:, 0] 'a', 'b', 'c' have the same frequency. 'a' and 'b' will be</span>
    <span class="s3"># considered infrequent because they appear first when sorted</span>

    <span class="s3"># X[:, 1] 0, 3, 5, 10 has frequency 2 and 12 has frequency 1.</span>
    <span class="s3"># 0, 3, 12 will be considered infrequent because they appear first when</span>
    <span class="s3"># sorted.</span>

    <span class="s3"># X[:, 2] &quot;snake&quot; and &quot;bird&quot; or infrequent</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">12</span><span class="s2">])</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], [</span><span class="s5">&quot;bird&quot;</span><span class="s2">, </span><span class="s5">&quot;snake&quot;</span><span class="s2">])</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s5">&quot;str&quot;</span><span class="s2">: [</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;b&quot;</span><span class="s2">, </span><span class="s5">&quot;f&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">],</span>
            <span class="s5">&quot;int&quot;</span><span class="s2">: [</span><span class="s4">12</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
            <span class="s5">&quot;categorical&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s5">&quot;cat&quot;</span><span class="s2">] + [</span><span class="s5">&quot;snake&quot;</span><span class="s2">] + [</span><span class="s5">&quot;bird&quot;</span><span class="s2">] + [</span><span class="s5">&quot;dog&quot;</span><span class="s2">],</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">categorical_dtype</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">},</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s5">&quot;str&quot;</span><span class="s2">, </span><span class="s5">&quot;int&quot;</span><span class="s2">, </span><span class="s5">&quot;categorical&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">expected_trans </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected_trans</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_infrequent_custom_mapping</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check behavior of unknown_value and encoded_missing_value with infrequent.&quot;&quot;&quot;</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3 </span><span class="s2">+ [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>

    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">,</span>
        <span class="s1">unknown_value</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
        <span class="s1">max_categories</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
        <span class="s1">encoded_missing_value</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">infrequent_categories_</span><span class="s2">, [[</span><span class="s5">&quot;a&quot;</span><span class="s2">, </span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s5">&quot;d&quot;</span><span class="s2">]])</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">expected_trans </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">]]</span>

    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">expected_trans</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_all_frequent</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;All categories are considered frequent have same encoding as default encoder.&quot;&quot;&quot;</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>

    <span class="s1">adjusted_encoder </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">1</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s1">default_encoder </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">1</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">adjusted_encoder</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), </span><span class="s1">default_encoder</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s5">&quot;kwargs&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">{</span><span class="s5">&quot;max_categories&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">},</span>
        <span class="s2">{</span><span class="s5">&quot;min_frequency&quot;</span><span class="s2">: </span><span class="s4">100</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_ordinal_encoder_all_infrequent</span><span class="s2">(</span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;When all categories are infrequent, they are all encoded as zero.&quot;&quot;&quot;</span>
    <span class="s1">X_train </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s5">&quot;a&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;b&quot;</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;c&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;d&quot;</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">encoder </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span>
        <span class="s2">**</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">handle_unknown</span><span class="s2">=</span><span class="s5">&quot;use_encoded_value&quot;</span><span class="s2">, </span><span class="s1">unknown_value</span><span class="s2">=-</span><span class="s4">1</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= [[</span><span class="s5">&quot;a&quot;</span><span class="s2">], [</span><span class="s5">&quot;b&quot;</span><span class="s2">], [</span><span class="s5">&quot;c&quot;</span><span class="s2">], [</span><span class="s5">&quot;d&quot;</span><span class="s2">], [</span><span class="s5">&quot;e&quot;</span><span class="s2">]]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">encoder</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">), [[</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_missing_appears_frequent</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check behavior when missing value appears frequently.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">] * </span><span class="s4">20 </span><span class="s2">+ [</span><span class="s5">&quot;dog&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;cat&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;snake&quot;</span><span class="s2">] + [</span><span class="s5">&quot;deer&quot;</span><span class="s2">]],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">max_categories</span><span class="s2">=</span><span class="s4">3</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;snake&quot;</span><span class="s2">, </span><span class="s5">&quot;cat&quot;</span><span class="s2">, </span><span class="s5">&quot;dog&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">).</span><span class="s1">T</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_ordinal_encoder_missing_appears_infrequent</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check behavior when missing value appears infrequently.&quot;&quot;&quot;</span>

    <span class="s3"># feature 0 has infrequent categories</span>
    <span class="s3"># feature 1 has no infrequent categories</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">] + [</span><span class="s5">&quot;dog&quot;</span><span class="s2">] * </span><span class="s4">10 </span><span class="s2">+ [</span><span class="s5">&quot;cat&quot;</span><span class="s2">] * </span><span class="s4">5 </span><span class="s2">+ [</span><span class="s5">&quot;snake&quot;</span><span class="s2">] + [</span><span class="s5">&quot;deer&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">&quot;red&quot;</span><span class="s2">] * </span><span class="s4">9 </span><span class="s2">+ [</span><span class="s5">&quot;green&quot;</span><span class="s2">] * </span><span class="s4">9</span><span class="s2">,</span>
        <span class="s2">],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">T</span>
    <span class="s1">ordinal </span><span class="s2">= </span><span class="s1">OrdinalEncoder</span><span class="s2">(</span><span class="s1">min_frequency</span><span class="s2">=</span><span class="s4">4</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">X_test </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s5">&quot;snake&quot;</span><span class="s2">, </span><span class="s5">&quot;red&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">&quot;deer&quot;</span><span class="s2">, </span><span class="s5">&quot;green&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s5">&quot;green&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">&quot;dog&quot;</span><span class="s2">, </span><span class="s5">&quot;green&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s5">&quot;cat&quot;</span><span class="s2">, </span><span class="s5">&quot;red&quot;</span><span class="s2">],</span>
        <span class="s2">],</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">ordinal</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;Encoder&quot;</span><span class="s2">, [</span><span class="s1">OneHotEncoder</span><span class="s2">, </span><span class="s1">OrdinalEncoder</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_encoder_not_fitted</span><span class="s2">(</span><span class="s1">Encoder</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we raise a `NotFittedError` by calling transform before fit with 
    the encoders. 
 
    One could expect that the passing the `categories` argument to the encoder 
    would make it stateless. However, `fit` is making a couple of check, such as the 
    position of `np.nan`. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">&quot;A&quot;</span><span class="s2">], [</span><span class="s5">&quot;B&quot;</span><span class="s2">], [</span><span class="s5">&quot;C&quot;</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">encoder </span><span class="s2">= </span><span class="s1">Encoder</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">=[[</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;C&quot;</span><span class="s2">]])</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotFittedError</span><span class="s2">):</span>
        <span class="s1">encoder</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
</pre>
</body>
</html>