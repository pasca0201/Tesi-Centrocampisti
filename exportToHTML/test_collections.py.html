<html>
<head>
<title>test_collections.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_collections.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">SimpleNamespace</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_array_almost_equal</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">collections </span><span class="s0">as </span><span class="s1">mcollections</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">colors </span><span class="s0">as </span><span class="s1">mcolors</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">path </span><span class="s0">as </span><span class="s1">mpath</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">transforms </span><span class="s0">as </span><span class="s1">mtransforms</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">collections </span><span class="s0">import </span><span class="s2">(</span><span class="s1">Collection</span><span class="s2">, </span><span class="s1">LineCollection</span><span class="s2">,</span>
                                    <span class="s1">EventCollection</span><span class="s2">, </span><span class="s1">PolyCollection</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s2">, </span><span class="s1">image_comparison</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;pcolormesh&quot;</span><span class="s2">, </span><span class="s3">&quot;pcolor&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">pcfunc</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s0">def </span><span class="s1">generate_EventCollection_plot</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot;Generate the initial collection and plot it.&quot;&quot;&quot;</span>
    <span class="s1">positions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">5.</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">13.</span><span class="s2">, </span><span class="s5">21.</span><span class="s2">])</span>
    <span class="s1">extra_positions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">34.</span><span class="s2">, </span><span class="s5">55.</span><span class="s2">, </span><span class="s5">89.</span><span class="s2">])</span>
    <span class="s1">orientation </span><span class="s2">= </span><span class="s3">'horizontal'</span>
    <span class="s1">lineoffset </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">linelength </span><span class="s2">= </span><span class="s5">.5</span>
    <span class="s1">linewidth </span><span class="s2">= </span><span class="s5">2</span>
    <span class="s1">color </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">linestyle </span><span class="s2">= </span><span class="s3">'solid'</span>
    <span class="s1">antialiased </span><span class="s2">= </span><span class="s0">True</span>

    <span class="s1">coll </span><span class="s2">= </span><span class="s1">EventCollection</span><span class="s2">(</span><span class="s1">positions</span><span class="s2">,</span>
                           <span class="s1">orientation</span><span class="s2">=</span><span class="s1">orientation</span><span class="s2">,</span>
                           <span class="s1">lineoffset</span><span class="s2">=</span><span class="s1">lineoffset</span><span class="s2">,</span>
                           <span class="s1">linelength</span><span class="s2">=</span><span class="s1">linelength</span><span class="s2">,</span>
                           <span class="s1">linewidth</span><span class="s2">=</span><span class="s1">linewidth</span><span class="s2">,</span>
                           <span class="s1">color</span><span class="s2">=</span><span class="s1">color</span><span class="s2">,</span>
                           <span class="s1">linestyle</span><span class="s2">=</span><span class="s1">linestyle</span><span class="s2">,</span>
                           <span class="s1">antialiased</span><span class="s2">=</span><span class="s1">antialiased</span>
                           <span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: default'</span><span class="s2">)</span>
    <span class="s1">props </span><span class="s2">= {</span><span class="s3">'positions'</span><span class="s2">: </span><span class="s1">positions</span><span class="s2">,</span>
             <span class="s3">'extra_positions'</span><span class="s2">: </span><span class="s1">extra_positions</span><span class="s2">,</span>
             <span class="s3">'orientation'</span><span class="s2">: </span><span class="s1">orientation</span><span class="s2">,</span>
             <span class="s3">'lineoffset'</span><span class="s2">: </span><span class="s1">lineoffset</span><span class="s2">,</span>
             <span class="s3">'linelength'</span><span class="s2">: </span><span class="s1">linelength</span><span class="s2">,</span>
             <span class="s3">'linewidth'</span><span class="s2">: </span><span class="s1">linewidth</span><span class="s2">,</span>
             <span class="s3">'color'</span><span class="s2">: </span><span class="s1">color</span><span class="s2">,</span>
             <span class="s3">'linestyle'</span><span class="s2">: </span><span class="s1">linestyle</span><span class="s2">,</span>
             <span class="s3">'antialiased'</span><span class="s2">: </span><span class="s1">antialiased</span>
             <span class="s2">}</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">22</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">ax</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__default'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__get_props</span><span class="s2">():</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s6"># check that the default segments have the correct coordinates</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s6"># check that the default positions match the input positions</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">], </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">())</span>
    <span class="s6"># check that the default orientation matches the input orientation</span>
    <span class="s0">assert </span><span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">] == </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_orientation</span><span class="s2">()</span>
    <span class="s6"># check that the default orientation matches the input orientation</span>
    <span class="s0">assert </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">is_horizontal</span><span class="s2">()</span>
    <span class="s6"># check that the default linelength matches the input linelength</span>
    <span class="s0">assert </span><span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">] == </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_linelength</span><span class="s2">()</span>
    <span class="s6"># check that the default lineoffset matches the input lineoffset</span>
    <span class="s0">assert </span><span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">] == </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_lineoffset</span><span class="s2">()</span>
    <span class="s6"># check that the default linestyle matches the input linestyle</span>
    <span class="s0">assert </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_linestyle</span><span class="s2">() == [(</span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
    <span class="s6"># check that the default color matches the input color</span>
    <span class="s0">for </span><span class="s1">color </span><span class="s0">in </span><span class="s2">[</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_color</span><span class="s2">(), *</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_colors</span><span class="s2">()]:</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">color</span><span class="s2">, </span><span class="s1">props</span><span class="s2">[</span><span class="s3">'color'</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__set_positions'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__set_positions</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_positions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">], </span><span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">]])</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_positions</span><span class="s2">(</span><span class="s1">new_positions</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_positions</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">())</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">, </span><span class="s1">new_positions</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: set_positions'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">90</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__add_positions'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__add_positions</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_positions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                               <span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">switch_orientation</span><span class="s2">()  </span><span class="s6"># Test adding in the vertical orientation, too.</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">add_positions</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">][</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">switch_orientation</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_positions</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">())</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">new_positions</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: add_positions'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">35</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__append_positions'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__append_positions</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_positions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                               <span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">][</span><span class="s5">2</span><span class="s2">]])</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">append_positions</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">][</span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_positions</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">())</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">new_positions</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: append_positions'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">90</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__extend_positions'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__extend_positions</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_positions </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                               <span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">][</span><span class="s5">1</span><span class="s2">:]])</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">extend_positions</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'extra_positions'</span><span class="s2">][</span><span class="s5">1</span><span class="s2">:])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">new_positions</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">())</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">new_positions</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: extend_positions'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">90</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__switch_orientation'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__switch_orientation</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_orientation </span><span class="s2">= </span><span class="s3">'vertical'</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">switch_orientation</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">new_orientation </span><span class="s2">== </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_orientation</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">is_horizontal</span><span class="s2">()</span>
    <span class="s1">new_positions </span><span class="s2">= </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">()</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">new_positions</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">], </span><span class="s1">new_orientation</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: switch_orientation'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">22</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__switch_orientation__2x'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__switch_orientation_2x</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot; 
    Check that calling switch_orientation twice sets the orientation back to 
    the default. 
    &quot;&quot;&quot;</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">switch_orientation</span><span class="s2">()</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">switch_orientation</span><span class="s2">()</span>
    <span class="s1">new_positions </span><span class="s2">= </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_positions</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">] == </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_orientation</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">is_horizontal</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">], </span><span class="s1">new_positions</span><span class="s2">)</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">new_positions</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: switch_orientation 2x'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__set_orientation'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__set_orientation</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_orientation </span><span class="s2">= </span><span class="s3">'vertical'</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_orientation</span><span class="s2">(</span><span class="s1">new_orientation</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">new_orientation </span><span class="s2">== </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_orientation</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">is_horizontal</span><span class="s2">()</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">new_orientation</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: set_orientation'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">22</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__set_linelength'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__set_linelength</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_linelength </span><span class="s2">= </span><span class="s5">15</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_linelength</span><span class="s2">(</span><span class="s1">new_linelength</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">new_linelength </span><span class="s2">== </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_linelength</span><span class="s2">()</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                   <span class="s1">new_linelength</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'lineoffset'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: set_linelength'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">20</span><span class="s2">, </span><span class="s5">20</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__set_lineoffset'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__set_lineoffset</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">props </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_lineoffset </span><span class="s2">= -</span><span class="s5">5.</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_lineoffset</span><span class="s2">(</span><span class="s1">new_lineoffset</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">new_lineoffset </span><span class="s2">== </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_lineoffset</span><span class="s2">()</span>
    <span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'positions'</span><span class="s2">],</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'linelength'</span><span class="s2">],</span>
                   <span class="s1">new_lineoffset</span><span class="s2">,</span>
                   <span class="s1">props</span><span class="s2">[</span><span class="s3">'orientation'</span><span class="s2">])</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: set_lineoffset'</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">6</span><span class="s2">, -</span><span class="s5">4</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span>
    <span class="s3">'EventCollection_plot__set_linestyle'</span><span class="s2">,</span>
    <span class="s3">'EventCollection_plot__set_linestyle'</span><span class="s2">,</span>
    <span class="s3">'EventCollection_plot__set_linewidth'</span><span class="s2">,</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__set_prop</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">prop</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">expected </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s3">'linestyle'</span><span class="s2">, </span><span class="s3">'dashed'</span><span class="s2">, [(</span><span class="s5">0</span><span class="s2">, (</span><span class="s5">6.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s2">))]),</span>
            <span class="s2">(</span><span class="s3">'linestyle'</span><span class="s2">, (</span><span class="s5">0</span><span class="s2">, (</span><span class="s5">6.</span><span class="s2">, </span><span class="s5">6.</span><span class="s2">)), [(</span><span class="s5">0</span><span class="s2">, (</span><span class="s5">6.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s2">))]),</span>
            <span class="s2">(</span><span class="s3">'linewidth'</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">5</span><span class="s2">),</span>
    <span class="s2">]:</span>
        <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(**{</span><span class="s1">prop</span><span class="s2">: </span><span class="s1">value</span><span class="s2">})</span>
        <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">getp</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">) == </span><span class="s1">expected</span>
        <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">f'EventCollection: set_</span><span class="s0">{</span><span class="s1">prop</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EventCollection_plot__set_color'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test__EventCollection__set_color</span><span class="s2">():</span>
    <span class="s1">splt</span><span class="s2">, </span><span class="s1">coll</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">generate_EventCollection_plot</span><span class="s2">()</span>
    <span class="s1">new_color </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_color</span><span class="s2">(</span><span class="s1">new_color</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">color </span><span class="s0">in </span><span class="s2">[</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_color</span><span class="s2">(), *</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_colors</span><span class="s2">()]:</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">color</span><span class="s2">, </span><span class="s1">new_color</span><span class="s2">)</span>
    <span class="s1">splt</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'EventCollection: set_color'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_segments</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">, </span><span class="s1">positions</span><span class="s2">, </span><span class="s1">linelength</span><span class="s2">, </span><span class="s1">lineoffset</span><span class="s2">, </span><span class="s1">orientation</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    Test helper checking that all values in the segment are correct, given a 
    particular set of inputs. 
    &quot;&quot;&quot;</span>
    <span class="s1">segments </span><span class="s2">= </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_segments</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">orientation</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">'horizontal'</span>
            <span class="s0">or </span><span class="s1">orientation</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">'none' </span><span class="s0">or </span><span class="s1">orientation </span><span class="s0">is None</span><span class="s2">):</span>
        <span class="s6"># if horizontal, the position in is in the y-axis</span>
        <span class="s1">pos1 </span><span class="s2">= </span><span class="s5">1</span>
        <span class="s1">pos2 </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">elif </span><span class="s1">orientation</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() == </span><span class="s3">'vertical'</span><span class="s2">:</span>
        <span class="s6"># if vertical, the position in is in the x-axis</span>
        <span class="s1">pos1 </span><span class="s2">= </span><span class="s5">0</span>
        <span class="s1">pos2 </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;orientation must be 'horizontal' or 'vertical'&quot;</span><span class="s2">)</span>

    <span class="s6"># test to make sure each segment is correct</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">segment </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">segments</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">segment</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">pos1</span><span class="s2">] == </span><span class="s1">lineoffset </span><span class="s2">+ </span><span class="s1">linelength </span><span class="s2">/ </span><span class="s5">2</span>
        <span class="s0">assert </span><span class="s1">segment</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">pos1</span><span class="s2">] == </span><span class="s1">lineoffset </span><span class="s2">- </span><span class="s1">linelength </span><span class="s2">/ </span><span class="s5">2</span>
        <span class="s0">assert </span><span class="s1">segment</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">pos2</span><span class="s2">] == </span><span class="s1">positions</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">segment</span><span class="s2">[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">pos2</span><span class="s2">] == </span><span class="s1">positions</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_collection_norm_autoscale</span><span class="s2">():</span>
    <span class="s6"># norm should be autoscaled when array is set, not deferred to draw time</span>
    <span class="s1">lines </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">24</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">LineCollection</span><span class="s2">(</span><span class="s1">lines</span><span class="s2">, </span><span class="s1">array</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s5">2</span><span class="s2">) == </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span>
    <span class="s6"># setting a new array shouldn't update the already scaled limits</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">) + </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s5">2</span><span class="s2">) == </span><span class="s5">2 </span><span class="s2">/ </span><span class="s5">3</span>


<span class="s0">def </span><span class="s1">test_null_collection_datalim</span><span class="s2">():</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([])</span>
    <span class="s1">col_data_lim </span><span class="s2">= </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_datalim</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">IdentityTransform</span><span class="s2">())</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">col_data_lim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                       <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">null</span><span class="s2">().</span><span class="s1">get_points</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_no_offsets_datalim</span><span class="s2">():</span>
    <span class="s6"># A collection with no offsets and a non transData</span>
    <span class="s6"># transform should return a null bbox</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([</span><span class="s1">mpath</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">([(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)])])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">)</span>
    <span class="s1">coll_data_lim </span><span class="s2">= </span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_datalim</span><span class="s2">(</span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">IdentityTransform</span><span class="s2">())</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">coll_data_lim</span><span class="s2">.</span><span class="s1">get_points</span><span class="s2">(),</span>
                       <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">.</span><span class="s1">null</span><span class="s2">().</span><span class="s1">get_points</span><span class="s2">())</span>


<span class="s0">def </span><span class="s1">test_add_collection</span><span class="s2">():</span>
    <span class="s6"># Test if data limits are unchanged by adding an empty collection.</span>
    <span class="s6"># GitHub issue #1490, pull #1497.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">bounds </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">bounds</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([], [])</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">bounds </span><span class="s2">== </span><span class="s1">bounds</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_collection_log_datalim</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s6"># Data limits should respect the minimum x/y when using log scale.</span>
    <span class="s1">x_vals </span><span class="s2">= [</span><span class="s5">4.38462e-6</span><span class="s2">, </span><span class="s5">5.54929e-6</span><span class="s2">, </span><span class="s5">7.02332e-6</span><span class="s2">, </span><span class="s5">8.88889e-6</span><span class="s2">, </span><span class="s5">1.12500e-5</span><span class="s2">,</span>
              <span class="s5">1.42383e-5</span><span class="s2">, </span><span class="s5">1.80203e-5</span><span class="s2">, </span><span class="s5">2.28070e-5</span><span class="s2">, </span><span class="s5">2.88651e-5</span><span class="s2">, </span><span class="s5">3.65324e-5</span><span class="s2">,</span>
              <span class="s5">4.62363e-5</span><span class="s2">, </span><span class="s5">5.85178e-5</span><span class="s2">, </span><span class="s5">7.40616e-5</span><span class="s2">, </span><span class="s5">9.37342e-5</span><span class="s2">, </span><span class="s5">1.18632e-4</span><span class="s2">]</span>
    <span class="s1">y_vals </span><span class="s2">= [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.182</span><span class="s2">, </span><span class="s5">0.332</span><span class="s2">, </span><span class="s5">0.604</span><span class="s2">, </span><span class="s5">1.1</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.64</span><span class="s2">, </span><span class="s5">6.64</span><span class="s2">, </span><span class="s5">12.1</span><span class="s2">, </span><span class="s5">22.0</span><span class="s2">,</span>
              <span class="s5">39.6</span><span class="s2">, </span><span class="s5">71.3</span><span class="s2">]</span>

    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x_vals</span><span class="s2">, </span><span class="s1">y_vals</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">()</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">y</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">()</span>

    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">set_xscale</span><span class="s2">(</span><span class="s3">'log'</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s3">'log'</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">margins </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">set_xscale</span><span class="s2">(</span><span class="s3">'log'</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">set_yscale</span><span class="s2">(</span><span class="s3">'log'</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">marker</span><span class="s2">=</span><span class="s3">&quot;o&quot;</span><span class="s2">, </span><span class="s1">ls</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_quiver_limits</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">8</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">u </span><span class="s2">= </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">80</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">q </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">quiver</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">q</span><span class="s2">.</span><span class="s1">get_datalim</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">).</span><span class="s1">bounds </span><span class="s2">== (</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s5">25</span><span class="s2">, </span><span class="s5">32</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">quiver</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">y</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">bounds </span><span class="s2">== (</span><span class="s5">20.0</span><span class="s2">, </span><span class="s5">30.0</span><span class="s2">, </span><span class="s5">15.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_barb_limits</span><span class="s2">():</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">()</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">5</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">20</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">translate</span><span class="s2">(</span><span class="s5">25</span><span class="s2">, </span><span class="s5">32</span><span class="s2">) + </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">barbs</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">y</span><span class="s2">), </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">)</span>
    <span class="s6"># The calculated bounds are approximately the bounds of the original data,</span>
    <span class="s6"># this is because the entire path is taken into account when updating the</span>
    <span class="s6"># datalim.</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">dataLim</span><span class="s2">.</span><span class="s1">bounds</span><span class="s2">, (</span><span class="s5">20</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">6</span><span class="s2">),</span>
                              <span class="s1">decimal</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'EllipseCollection_test_image.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s5">0.021 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s3">'arm64' </span><span class="s0">else </span><span class="s5">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_EllipseCollection</span><span class="s2">():</span>
    <span class="s6"># Test basic functionality</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">XY </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">((</span><span class="s1">X</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())).</span><span class="s1">T</span>

    <span class="s1">ww </span><span class="s2">= </span><span class="s1">X </span><span class="s2">/ </span><span class="s1">x</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">hh </span><span class="s2">= </span><span class="s1">Y </span><span class="s2">/ </span><span class="s1">y</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">aa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">ww</span><span class="s2">) * </span><span class="s5">20  </span><span class="s6"># first axis is 20 degrees CCW from x axis</span>

    <span class="s1">ec </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">EllipseCollection</span><span class="s2">(</span>
        <span class="s1">ww</span><span class="s2">, </span><span class="s1">hh</span><span class="s2">, </span><span class="s1">aa</span><span class="s2">, </span><span class="s1">units</span><span class="s2">=</span><span class="s3">'x'</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">=</span><span class="s1">XY</span><span class="s2">, </span><span class="s1">offset_transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">,</span>
        <span class="s1">facecolors</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">autoscale_view</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_EllipseCollection_setter_getter</span><span class="s2">():</span>
    <span class="s6"># Test widths, heights and angle setter</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">widths </span><span class="s2">= (</span><span class="s5">2</span><span class="s2">, )</span>
    <span class="s1">heights </span><span class="s2">= (</span><span class="s5">3</span><span class="s2">, )</span>
    <span class="s1">angles </span><span class="s2">= (</span><span class="s5">45</span><span class="s2">, )</span>
    <span class="s1">offsets </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)) * </span><span class="s5">10</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">ec </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">EllipseCollection</span><span class="s2">(</span>
        <span class="s1">widths</span><span class="s2">=</span><span class="s1">widths</span><span class="s2">,</span>
        <span class="s1">heights</span><span class="s2">=</span><span class="s1">heights</span><span class="s2">,</span>
        <span class="s1">angles</span><span class="s2">=</span><span class="s1">angles</span><span class="s2">,</span>
        <span class="s1">offsets</span><span class="s2">=</span><span class="s1">offsets</span><span class="s2">,</span>
        <span class="s1">units</span><span class="s2">=</span><span class="s3">'x'</span><span class="s2">,</span>
        <span class="s1">offset_transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">_widths</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">widths</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">() * </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">_heights</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">heights</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">() * </span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">_angles</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">deg2rad</span><span class="s2">(</span><span class="s1">angles</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">get_widths</span><span class="s2">(), </span><span class="s1">widths</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">get_heights</span><span class="s2">(), </span><span class="s1">heights</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">get_angles</span><span class="s2">(), </span><span class="s1">angles</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">12</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s5">2</span><span class="s2">, </span><span class="s5">12</span><span class="s2">)</span>

    <span class="s1">new_widths </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)) * </span><span class="s5">2</span>
    <span class="s1">new_heights </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)) * </span><span class="s5">3</span>
    <span class="s1">new_angles </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)) * </span><span class="s5">180</span>

    <span class="s1">ec</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">widths</span><span class="s2">=</span><span class="s1">new_widths</span><span class="s2">, </span><span class="s1">heights</span><span class="s2">=</span><span class="s1">new_heights</span><span class="s2">, </span><span class="s1">angles</span><span class="s2">=</span><span class="s1">new_angles</span><span class="s2">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">get_widths</span><span class="s2">(), </span><span class="s1">new_widths</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">get_heights</span><span class="s2">(), </span><span class="s1">new_heights</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">ec</span><span class="s2">.</span><span class="s1">get_angles</span><span class="s2">(), </span><span class="s1">new_angles</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'polycollection_close.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_polycollection_close</span><span class="s2">():</span>
    <span class="s0">from </span><span class="s1">mpl_toolkits</span><span class="s2">.</span><span class="s1">mplot3d </span><span class="s0">import </span><span class="s1">Axes3D  </span><span class="s6"># type: ignore</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'axes3d.automargin'</span><span class="s2">] = </span><span class="s0">True</span>

    <span class="s1">vertsQuad </span><span class="s2">= [</span>
        <span class="s2">[[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">], [</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">], [</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">], [</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">], [</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">], [</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">], [</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">], [</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">], [</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">], [</span><span class="s5">3.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">]],</span>
        <span class="s2">[[</span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">], [</span><span class="s5">3.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">], [</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">], [</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">]]]</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">(</span><span class="s1">Axes3D</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">))</span>

    <span class="s1">colors </span><span class="s2">= [</span><span class="s3">'r'</span><span class="s2">, </span><span class="s3">'g'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">, </span><span class="s3">'k'</span><span class="s2">]</span>
    <span class="s1">zpos </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>

    <span class="s1">poly </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PolyCollection</span><span class="s2">(</span>
        <span class="s1">vertsQuad </span><span class="s2">* </span><span class="s1">len</span><span class="s2">(</span><span class="s1">zpos</span><span class="s2">), </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">0.25</span><span class="s2">)</span>
    <span class="s1">poly</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s5">0.7</span><span class="s2">)</span>

    <span class="s6"># need to have a z-value for *each* polygon = element!</span>
    <span class="s1">zs </span><span class="s2">= []</span>
    <span class="s1">cs </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">z</span><span class="s2">, </span><span class="s1">c </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">zpos</span><span class="s2">, </span><span class="s1">colors</span><span class="s2">):</span>
        <span class="s1">zs</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">z</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">vertsQuad</span><span class="s2">))</span>
        <span class="s1">cs</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">c</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">vertsQuad</span><span class="s2">))</span>

    <span class="s1">poly</span><span class="s2">.</span><span class="s1">set_color</span><span class="s2">(</span><span class="s1">cs</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection3d</span><span class="s2">(</span><span class="s1">poly</span><span class="s2">, </span><span class="s1">zs</span><span class="s2">=</span><span class="s1">zs</span><span class="s2">, </span><span class="s1">zdir</span><span class="s2">=</span><span class="s3">'y'</span><span class="s2">)</span>

    <span class="s6"># axis limit settings:</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim3d</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_zlim3d</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim3d</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'regularpolycollection_rotate.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_regularpolycollection_rotate</span><span class="s2">():</span>
    <span class="s1">xx</span><span class="s2">, </span><span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mgrid</span><span class="s2">[:</span><span class="s5">10</span><span class="s2">, :</span><span class="s5">10</span><span class="s2">]</span>
    <span class="s1">xy_points </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">([</span><span class="s1">xx</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">(), </span><span class="s1">yy</span><span class="s2">.</span><span class="s1">flatten</span><span class="s2">()])</span>
    <span class="s1">rotations </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xy_points</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">xy</span><span class="s2">, </span><span class="s1">alpha </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">xy_points</span><span class="s2">, </span><span class="s1">rotations</span><span class="s2">):</span>
        <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">RegularPolyCollection</span><span class="s2">(</span>
            <span class="s5">4</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">=(</span><span class="s5">100</span><span class="s2">,), </span><span class="s1">rotation</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">,</span>
            <span class="s1">offsets</span><span class="s2">=[</span><span class="s1">xy</span><span class="s2">], </span><span class="s1">offset_transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">autolim</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">autoscale_view</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'regularpolycollection_scale.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_regularpolycollection_scale</span><span class="s2">():</span>
    <span class="s6"># See issue #3860</span>

    <span class="s0">class </span><span class="s1">SquareCollection</span><span class="s2">(</span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">RegularPolyCollection</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s1">rotation</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s5">4.</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">get_transform</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s4">&quot;&quot;&quot;Return transform scaling circle areas to data space.&quot;&quot;&quot;</span>
            <span class="s1">ax </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">axes</span>

            <span class="s1">pts2pixels </span><span class="s2">= </span><span class="s5">72.0 </span><span class="s2">/ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">dpi</span>

            <span class="s1">scale_x </span><span class="s2">= </span><span class="s1">pts2pixels </span><span class="s2">* </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">width </span><span class="s2">/ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">viewLim</span><span class="s2">.</span><span class="s1">width</span>
            <span class="s1">scale_y </span><span class="s2">= </span><span class="s1">pts2pixels </span><span class="s2">* </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">height </span><span class="s2">/ </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">viewLim</span><span class="s2">.</span><span class="s1">height</span>
            <span class="s0">return </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">scale</span><span class="s2">(</span><span class="s1">scale_x</span><span class="s2">, </span><span class="s1">scale_y</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">xy </span><span class="s2">= [(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)]</span>
    <span class="s6"># Unit square has a half-diagonal of `1/sqrt(2)`, so `pi * r**2` equals...</span>
    <span class="s1">circle_areas </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">squares </span><span class="s2">= </span><span class="s1">SquareCollection</span><span class="s2">(</span>
        <span class="s1">sizes</span><span class="s2">=</span><span class="s1">circle_areas</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">=</span><span class="s1">xy</span><span class="s2">, </span><span class="s1">offset_transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">squares</span><span class="s2">, </span><span class="s1">autolim</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">axis</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_picking</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1000</span><span class="s2">], </span><span class="s1">picker</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">dpi</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi</span><span class="s2">)</span>
    <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s5">325</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s5">240</span><span class="s2">)</span>
    <span class="s1">found</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">col</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">found</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s3">'ind'</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_quadmesh_contains</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] * </span><span class="s1">x</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :]</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">mesh </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata </span><span class="s2">= </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_transform</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">))</span>
    <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">xdata</span><span class="s2">=</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">=</span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">found</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">found</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s3">'ind'</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">])</span>

    <span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata </span><span class="s2">= </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_transform</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">))</span>
    <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">xdata</span><span class="s2">=</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">=</span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">found</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">found</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">[</span><span class="s3">'ind'</span><span class="s2">], [</span><span class="s5">5</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_quadmesh_contains_concave</span><span class="s2">():</span>
    <span class="s6"># Test a concave polygon, V-like shape</span>
    <span class="s1">x </span><span class="s2">= [[</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]</span>
    <span class="s1">y </span><span class="s2">= [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">]]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">mesh </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, [[</span><span class="s5">0</span><span class="s2">]])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s6"># xdata, ydata, expected</span>
    <span class="s1">points </span><span class="s2">= [(-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),  </span><span class="s6"># left wing</span>
              <span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),  </span><span class="s6"># between the two wings</span>
              <span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.25</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),  </span><span class="s6"># right wing</span>
              <span class="s2">(</span><span class="s5">0</span><span class="s2">, -</span><span class="s5">0.25</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),  </span><span class="s6"># main body</span>
              <span class="s2">]</span>
    <span class="s0">for </span><span class="s1">point </span><span class="s0">in </span><span class="s1">points</span><span class="s2">:</span>
        <span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">expected </span><span class="s2">= </span><span class="s1">point</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_transform</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">))</span>
        <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">xdata</span><span class="s2">=</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">=</span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">found</span><span class="s2">, </span><span class="s1">indices </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">found </span><span class="s0">is </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_quadmesh_cursor_data</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] * </span><span class="s1">x</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :]</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">mesh </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s6"># Empty array data</span>
    <span class="s1">mesh</span><span class="s2">.</span><span class="s1">_A </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata </span><span class="s2">= </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_transform</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">))</span>
    <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">xdata</span><span class="s2">=</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">=</span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s6"># Empty collection should return None</span>
    <span class="s0">assert </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s6"># Now test adding the array data, to make sure we do get a value</span>
    <span class="s1">mesh</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">), [</span><span class="s5">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_quadmesh_cursor_data_multiple_points</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">mesh </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata </span><span class="s2">= </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">1.5</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_transform</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">))</span>
    <span class="s1">mouse_event </span><span class="s2">= </span><span class="s1">SimpleNamespace</span><span class="s2">(</span><span class="s1">xdata</span><span class="s2">=</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">=</span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">)</span>
    <span class="s6"># All quads are covering the same square</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">mesh</span><span class="s2">.</span><span class="s1">get_cursor_data</span><span class="s2">(</span><span class="s1">mouse_event</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">9</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_linestyle_single_dashes</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], </span><span class="s1">linestyle</span><span class="s2">=(</span><span class="s5">0.</span><span class="s2">, [</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">]))</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'size_in_xy.png'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_size_in_xy</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">widths</span><span class="s2">, </span><span class="s1">heights</span><span class="s2">, </span><span class="s1">angles </span><span class="s2">= (</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">), </span><span class="s5">10</span><span class="s2">, </span><span class="s5">0</span>
    <span class="s1">widths </span><span class="s2">= </span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span>
    <span class="s1">coords </span><span class="s2">= [(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">), (</span><span class="s5">15</span><span class="s2">, </span><span class="s5">15</span><span class="s2">)]</span>
    <span class="s1">e </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">EllipseCollection</span><span class="s2">(</span>
        <span class="s1">widths</span><span class="s2">, </span><span class="s1">heights</span><span class="s2">, </span><span class="s1">angles</span><span class="s2">, </span><span class="s1">units</span><span class="s2">=</span><span class="s3">'xy'</span><span class="s2">,</span>
        <span class="s1">offsets</span><span class="s2">=</span><span class="s1">coords</span><span class="s2">, </span><span class="s1">offset_transform</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">e</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">30</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">30</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pandas_indexing</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">):</span>

    <span class="s6"># Should not fail break when faced with a</span>
    <span class="s6"># non-zero indexed series</span>
    <span class="s1">index </span><span class="s2">= [</span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">13</span><span class="s2">]</span>
    <span class="s1">ec </span><span class="s2">= </span><span class="s1">fc </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">'red'</span><span class="s2">, </span><span class="s3">'blue'</span><span class="s2">, </span><span class="s3">'green'</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">lw </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">ls </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">'solid'</span><span class="s2">, </span><span class="s3">'dashed'</span><span class="s2">, </span><span class="s3">'dashdot'</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
    <span class="s1">aa </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

    <span class="s1">Collection</span><span class="s2">(</span><span class="s1">edgecolors</span><span class="s2">=</span><span class="s1">ec</span><span class="s2">)</span>
    <span class="s1">Collection</span><span class="s2">(</span><span class="s1">facecolors</span><span class="s2">=</span><span class="s1">fc</span><span class="s2">)</span>
    <span class="s1">Collection</span><span class="s2">(</span><span class="s1">linewidths</span><span class="s2">=</span><span class="s1">lw</span><span class="s2">)</span>
    <span class="s1">Collection</span><span class="s2">(</span><span class="s1">linestyles</span><span class="s2">=</span><span class="s1">ls</span><span class="s2">)</span>
    <span class="s1">Collection</span><span class="s2">(</span><span class="s1">antialiaseds</span><span class="s2">=</span><span class="s1">aa</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_lslw_bcast</span><span class="s2">():</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([])</span>
    <span class="s1">col</span><span class="s2">.</span><span class="s1">set_linestyles</span><span class="s2">([</span><span class="s3">'-'</span><span class="s2">, </span><span class="s3">'-'</span><span class="s2">])</span>
    <span class="s1">col</span><span class="s2">.</span><span class="s1">set_linewidths</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_linestyles</span><span class="s2">() == [(</span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)] * </span><span class="s5">6</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_linewidths</span><span class="s2">() == [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">] * </span><span class="s5">2</span>

    <span class="s1">col</span><span class="s2">.</span><span class="s1">set_linestyles</span><span class="s2">([</span><span class="s3">'-'</span><span class="s2">, </span><span class="s3">'-'</span><span class="s2">, </span><span class="s3">'-'</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_linestyles</span><span class="s2">() == [(</span><span class="s5">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)] * </span><span class="s5">3</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_linewidths</span><span class="s2">() == [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]).</span><span class="s1">all</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_set_wrong_linestyle</span><span class="s2">():</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">Collection</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Do not know how to convert 'fuzzy'&quot;</span><span class="s2">):</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">set_linestyle</span><span class="s2">(</span><span class="s3">'fuzzy'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_capstyle</span><span class="s2">():</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([])</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_capstyle</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([], </span><span class="s1">capstyle</span><span class="s2">=</span><span class="s3">'round'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_capstyle</span><span class="s2">() == </span><span class="s3">'round'</span>
    <span class="s1">col</span><span class="s2">.</span><span class="s1">set_capstyle</span><span class="s2">(</span><span class="s3">'butt'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_capstyle</span><span class="s2">() == </span><span class="s3">'butt'</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_joinstyle</span><span class="s2">():</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([])</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_joinstyle</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">PathCollection</span><span class="s2">([], </span><span class="s1">joinstyle</span><span class="s2">=</span><span class="s3">'round'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_joinstyle</span><span class="s2">() == </span><span class="s3">'round'</span>
    <span class="s1">col</span><span class="s2">.</span><span class="s1">set_joinstyle</span><span class="s2">(</span><span class="s3">'miter'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">get_joinstyle</span><span class="s2">() == </span><span class="s3">'miter'</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'cap_and_joinstyle.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_cap_and_joinstyle_image</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">([-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">([-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">])</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">])</span>
    <span class="s1">ys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.5</span><span class="s2">], [</span><span class="s5">1.0</span><span class="s2">]]) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]])</span>

    <span class="s1">segs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">segs</span><span class="s2">[:, :, </span><span class="s5">0</span><span class="s2">] = </span><span class="s1">x</span>
    <span class="s1">segs</span><span class="s2">[:, :, </span><span class="s5">1</span><span class="s2">] = </span><span class="s1">ys</span>
    <span class="s1">line_segments </span><span class="s2">= </span><span class="s1">LineCollection</span><span class="s2">(</span><span class="s1">segs</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">20</span><span class="s2">])</span>
    <span class="s1">line_segments</span><span class="s2">.</span><span class="s1">set_capstyle</span><span class="s2">(</span><span class="s3">&quot;round&quot;</span><span class="s2">)</span>
    <span class="s1">line_segments</span><span class="s2">.</span><span class="s1">set_joinstyle</span><span class="s2">(</span><span class="s3">&quot;miter&quot;</span><span class="s2">)</span>

    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">line_segments</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s3">'Line collection with customized caps and joinstyle'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'scatter_post_alpha.png'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_scatter_post_alpha</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">sc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), </span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">), </span><span class="s1">c</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>
    <span class="s1">sc</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s5">.1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_scatter_alpha_array</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">x </span><span class="s2">/ </span><span class="s5">5</span>
    <span class="s6"># With colormapping.</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">sc0 </span><span class="s2">= </span><span class="s1">ax0</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">sc1 </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">sc1</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sc0</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sc1</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s6"># Without colormapping.</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">sc0 </span><span class="s2">= </span><span class="s1">ax0</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=[</span><span class="s3">'r'</span><span class="s2">, </span><span class="s3">'g'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'m'</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">sc1 </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sc0</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sc1</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s6"># Without colormapping, and set alpha afterward.</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">sc0 </span><span class="s2">= </span><span class="s1">ax0</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=[</span><span class="s3">'r'</span><span class="s2">, </span><span class="s3">'g'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'m'</span><span class="s2">])</span>
    <span class="s1">sc0</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">sc1 </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s1">sc1</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sc0</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">sc1</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pathcollection_legend_elements</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">19680801</span><span class="s2">)</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">300</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s5">10</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">sc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s1">c</span><span class="s2">, </span><span class="s1">s</span><span class="s2">=</span><span class="s1">s</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s3">&quot;jet&quot;</span><span class="s2">, </span><span class="s1">marker</span><span class="s2">=</span><span class="s3">&quot;o&quot;</span><span class="s2">, </span><span class="s1">linewidths</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>

    <span class="s1">h</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">=</span><span class="s3">&quot;{x:g}&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">h</span><span class="s2">) == </span><span class="s5">5</span>
    <span class="s0">assert </span><span class="s1">l </span><span class="s2">== [</span><span class="s3">&quot;0&quot;</span><span class="s2">, </span><span class="s3">&quot;1&quot;</span><span class="s2">, </span><span class="s3">&quot;2&quot;</span><span class="s2">, </span><span class="s3">&quot;3&quot;</span><span class="s2">, </span><span class="s3">&quot;4&quot;</span><span class="s2">]</span>
    <span class="s1">colors </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_color</span><span class="s2">() </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">h</span><span class="s2">])</span>
    <span class="s1">colors2 </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">cmap</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">5</span><span class="s2">)/</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">colors</span><span class="s2">, </span><span class="s1">colors2</span><span class="s2">)</span>
    <span class="s1">l1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">h2</span><span class="s2">, </span><span class="s1">lab2 </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s5">9</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">) == </span><span class="s5">9</span>
    <span class="s1">l2 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">, </span><span class="s1">lab2</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s5">2</span><span class="s2">)</span>

    <span class="s1">h</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">=</span><span class="s3">&quot;sizes&quot;</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">&quot;red&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_alpha</span><span class="s2">() == </span><span class="s5">0.5 </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">h</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_markerfacecolor</span><span class="s2">() == </span><span class="s3">&quot;red&quot; </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">h</span><span class="s2">)</span>
    <span class="s1">l3 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s5">4</span><span class="s2">)</span>

    <span class="s1">h</span><span class="s2">, </span><span class="s1">l </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span><span class="s1">prop</span><span class="s2">=</span><span class="s3">&quot;sizes&quot;</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">=</span><span class="s3">&quot;{x:.2f}&quot;</span><span class="s2">,</span>
                              <span class="s1">func</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s5">2</span><span class="s2">*</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">actsizes </span><span class="s2">= [</span><span class="s1">line</span><span class="s2">.</span><span class="s1">get_markersize</span><span class="s2">() </span><span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">h</span><span class="s2">]</span>
    <span class="s1">labeledsizes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">float</span><span class="s2">) / </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">actsizes</span><span class="s2">, </span><span class="s1">labeledsizes</span><span class="s2">)</span>
    <span class="s1">l4 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">l</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">=</span><span class="s5">3</span><span class="s2">)</span>

    <span class="s1">loc </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">MaxNLocator</span><span class="s2">(</span><span class="s1">nbins</span><span class="s2">=</span><span class="s5">9</span><span class="s2">, </span><span class="s1">min_n_ticks</span><span class="s2">=</span><span class="s5">9</span><span class="s2">-</span><span class="s5">1</span><span class="s2">,</span>
                                 <span class="s1">steps</span><span class="s2">=[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2.5</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">8</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">h5</span><span class="s2">, </span><span class="s1">lab5 </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s1">loc</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">h5</span><span class="s2">)</span>

    <span class="s1">levels </span><span class="s2">= [-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">55.4</span><span class="s2">, </span><span class="s5">260</span><span class="s2">]</span>
    <span class="s1">h6</span><span class="s2">, </span><span class="s1">lab6 </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span><span class="s1">num</span><span class="s2">=</span><span class="s1">levels</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">=</span><span class="s3">&quot;sizes&quot;</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">=</span><span class="s3">&quot;{x:g}&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">[</span><span class="s1">float</span><span class="s2">(</span><span class="s1">l</span><span class="s2">) </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">lab6</span><span class="s2">] == </span><span class="s1">levels</span><span class="s2">[</span><span class="s5">2</span><span class="s2">:]</span>

    <span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s2">[</span><span class="s1">l1</span><span class="s2">, </span><span class="s1">l2</span><span class="s2">, </span><span class="s1">l3</span><span class="s2">, </span><span class="s1">l4</span><span class="s2">]:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_EventCollection_nosort</span><span class="s2">():</span>
    <span class="s6"># Check that EventCollection doesn't modify input in place</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">EventCollection</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">]))</span>


<span class="s0">def </span><span class="s1">test_collection_set_verts_array</span><span class="s2">():</span>
    <span class="s1">verts </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">80</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">col_arr </span><span class="s2">= </span><span class="s1">PolyCollection</span><span class="s2">(</span><span class="s1">verts</span><span class="s2">)</span>
    <span class="s1">col_list </span><span class="s2">= </span><span class="s1">PolyCollection</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">verts</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">col_arr</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">col_list</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ap</span><span class="s2">, </span><span class="s1">lp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">col_arr</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">, </span><span class="s1">col_list</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">ap</span><span class="s2">.</span><span class="s1">_vertices</span><span class="s2">, </span><span class="s1">lp</span><span class="s2">.</span><span class="s1">_vertices</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">ap</span><span class="s2">.</span><span class="s1">_codes</span><span class="s2">, </span><span class="s1">lp</span><span class="s2">.</span><span class="s1">_codes</span><span class="s2">)</span>

    <span class="s1">verts_tuple </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
    <span class="s1">verts_tuple</span><span class="s2">[:] = [</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">verts</span><span class="s2">]</span>
    <span class="s1">col_arr_tuple </span><span class="s2">= </span><span class="s1">PolyCollection</span><span class="s2">(</span><span class="s1">verts_tuple</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">col_arr</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">col_arr_tuple</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ap</span><span class="s2">, </span><span class="s1">atp </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">col_arr</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">, </span><span class="s1">col_arr_tuple</span><span class="s2">.</span><span class="s1">_paths</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">ap</span><span class="s2">.</span><span class="s1">_vertices</span><span class="s2">, </span><span class="s1">atp</span><span class="s2">.</span><span class="s1">_vertices</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">ap</span><span class="s2">.</span><span class="s1">_codes</span><span class="s2">, </span><span class="s1">atp</span><span class="s2">.</span><span class="s1">_codes</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_collection_set_array</span><span class="s2">():</span>
    <span class="s1">vals </span><span class="s2">= [*</span><span class="s1">range</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)]</span>

    <span class="s6"># Test set_array with list</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">Collection</span><span class="s2">()</span>
    <span class="s1">c</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">)</span>

    <span class="s6"># Test set_array with wrong dtype</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;^Image data of dtype&quot;</span><span class="s2">):</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s3">&quot;wrong_input&quot;</span><span class="s2">)</span>

    <span class="s6"># Test if array kwarg is copied</span>
    <span class="s1">vals</span><span class="s2">[</span><span class="s5">5</span><span class="s2">] = </span><span class="s5">45</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">not_equal</span><span class="s2">(</span><span class="s1">vals</span><span class="s2">, </span><span class="s1">c</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">()).</span><span class="s1">any</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_blended_collection_autolim</span><span class="s2">():</span>
    <span class="s1">a </span><span class="s2">= [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">]</span>
    <span class="s1">height </span><span class="s2">= </span><span class="s5">.2</span>

    <span class="s1">xy_pairs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s5">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s1">height</span><span class="s2">], </span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">))])</span>
    <span class="s1">line_segs </span><span class="s2">= </span><span class="s1">xy_pairs</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">([</span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">), </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>

    <span class="s1">f</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">trans </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">blended_transform_factory</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transAxes</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_collection</span><span class="s2">(</span><span class="s1">LineCollection</span><span class="s2">(</span><span class="s1">line_segs</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">trans</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">autoscale_view</span><span class="s2">(</span><span class="s1">scalex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">scaley</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), [</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">4.</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_singleton_autolim</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">(), [-</span><span class="s5">0.06</span><span class="s2">, </span><span class="s5">0.06</span><span class="s2">])</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), [-</span><span class="s5">0.06</span><span class="s2">, </span><span class="s5">0.06</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;transform, expected&quot;</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s3">&quot;transData&quot;</span><span class="s2">, (-</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">3.5</span><span class="s2">)),</span>
    <span class="s2">(</span><span class="s3">&quot;transAxes&quot;</span><span class="s2">, (</span><span class="s5">2.8</span><span class="s2">, </span><span class="s5">3.2</span><span class="s2">)),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_autolim_with_zeros</span><span class="s2">(</span><span class="s1">transform</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s6"># 1) Test that a scatter at (0, 0) data coordinates contributes to</span>
    <span class="s6"># autoscaling even though any(offsets) would be False in that situation.</span>
    <span class="s6"># 2) Test that specifying transAxes for the transform does not contribute</span>
    <span class="s6"># to the autoscaling.</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">=</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">transform</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">(), </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_quadmesh_set_array_validation</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">11</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">8</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">7</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s3">&quot;For X (11) and Y (8) with flat shading, A should have shape &quot;</span>
            <span class="s3">&quot;(7, 10, 3) or (7, 10, 4) or (7, 10) or (70,), not (10, 7)&quot;</span><span class="s2">)):</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">7</span><span class="s2">))</span>

    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">54</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s2">))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s3">&quot;For X (11) and Y (8) with flat shading, A should have shape &quot;</span>
            <span class="s3">&quot;(7, 10, 3) or (7, 10, 4) or (7, 10) or (70,), not (6, 9)&quot;</span><span class="s2">)):</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s3">&quot;For X (11) and Y (8) with flat shading, A should have shape &quot;</span>
            <span class="s3">&quot;(7, 10, 3) or (7, 10, 4) or (7, 10) or (70,), not (54,)&quot;</span><span class="s2">)):</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>

    <span class="s6"># RGB(A) tests</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">9</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))  </span><span class="s6"># RGB with wrong X/Y dims</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s3">&quot;For X (11) and Y (8) with flat shading, A should have shape &quot;</span>
            <span class="s3">&quot;(7, 10, 3) or (7, 10, 4) or (7, 10) or (70,), not (9, 6, 3)&quot;</span><span class="s2">)):</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>

    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">9</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))  </span><span class="s6"># RGBA with wrong X/Y dims</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s3">&quot;For X (11) and Y (8) with flat shading, A should have shape &quot;</span>
            <span class="s3">&quot;(7, 10, 3) or (7, 10, 4) or (7, 10) or (70,), not (9, 6, 4)&quot;</span><span class="s2">)):</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>

    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">7</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))  </span><span class="s6"># Right X/Y dims, bad 3rd dim</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
            <span class="s3">&quot;For X (11) and Y (8) with flat shading, A should have shape &quot;</span>
            <span class="s3">&quot;(7, 10, 3) or (7, 10, 4) or (7, 10) or (70,), not (7, 10, 2)&quot;</span><span class="s2">)):</span>
        <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">10</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">7</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s5">7</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">shading</span><span class="s2">=</span><span class="s3">'gouraud'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_polyquadmesh_masked_vertices_array</span><span class="s2">():</span>
    <span class="s1">xx</span><span class="s2">, </span><span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">], [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
    <span class="s6"># 2 x 3 mesh data</span>
    <span class="s1">zz </span><span class="s2">= (</span><span class="s1">xx</span><span class="s2">*</span><span class="s1">yy</span><span class="s2">)[:-</span><span class="s5">1</span><span class="s2">, :-</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">quadmesh </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">quadmesh</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s1">quadmesh_fc </span><span class="s2">= </span><span class="s1">quadmesh</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">()[</span><span class="s5">1</span><span class="s2">:, :]</span>
    <span class="s6"># Mask the origin vertex in x</span>
    <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_where</span><span class="s2">((</span><span class="s1">xx </span><span class="s2">== </span><span class="s5">0</span><span class="s2">) &amp; (</span><span class="s1">yy </span><span class="s2">== </span><span class="s5">0</span><span class="s2">), </span><span class="s1">xx</span><span class="s2">)</span>
    <span class="s1">polymesh </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">pcolor</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s6"># One cell should be left out</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()) == </span><span class="s5">5</span>
    <span class="s6"># Poly version should have the same facecolors as the end of the quadmesh</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">quadmesh_fc</span><span class="s2">, </span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">())</span>

    <span class="s6"># Mask the origin vertex in y</span>
    <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_where</span><span class="s2">((</span><span class="s1">xx </span><span class="s2">== </span><span class="s5">0</span><span class="s2">) &amp; (</span><span class="s1">yy </span><span class="s2">== </span><span class="s5">0</span><span class="s2">), </span><span class="s1">yy</span><span class="s2">)</span>
    <span class="s1">polymesh </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">pcolor</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s6"># One cell should be left out</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()) == </span><span class="s5">5</span>
    <span class="s6"># Poly version should have the same facecolors as the end of the quadmesh</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">quadmesh_fc</span><span class="s2">, </span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">())</span>

    <span class="s6"># Mask the origin cell data</span>
    <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_where</span><span class="s2">((</span><span class="s1">xx</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">, :-</span><span class="s5">1</span><span class="s2">] == </span><span class="s5">0</span><span class="s2">) &amp; (</span><span class="s1">yy</span><span class="s2">[:-</span><span class="s5">1</span><span class="s2">, :-</span><span class="s5">1</span><span class="s2">] == </span><span class="s5">0</span><span class="s2">), </span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">polymesh </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">pcolor</span><span class="s2">(</span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s6"># One cell should be left out</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()) == </span><span class="s5">5</span>
    <span class="s6"># Poly version should have the same facecolors as the end of the quadmesh</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">quadmesh_fc</span><span class="s2">, </span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">())</span>

    <span class="s6"># Setting array with 1D compressed values is deprecated</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">MatplotlibDeprecationWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Setting a PolyQuadMesh&quot;</span><span class="s2">):</span>
        <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">5</span><span class="s2">))</span>

    <span class="s6"># We should also be able to call set_array with a new mask and get</span>
    <span class="s6"># updated polys</span>
    <span class="s6"># Remove mask, should add all polys back</span>
    <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()) == </span><span class="s5">6</span>
    <span class="s6"># Add mask should remove polys</span>
    <span class="s1">zz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">masked_less</span><span class="s2">(</span><span class="s1">zz</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">zz</span><span class="s2">)</span>
    <span class="s1">polymesh</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">polymesh</span><span class="s2">.</span><span class="s1">get_paths</span><span class="s2">()) == </span><span class="s5">4</span>


<span class="s0">def </span><span class="s1">test_quadmesh_get_coordinates</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= [</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">]</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s1">xx</span><span class="s2">, </span><span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s6"># shape (3, 3, 2)</span>
    <span class="s1">coords </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">stack</span><span class="s2">([</span><span class="s1">xx</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">.</span><span class="s1">T</span><span class="s2">]).</span><span class="s1">T</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_coordinates</span><span class="s2">(), </span><span class="s1">coords</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_quadmesh_set_array</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
    <span class="s6"># Test that the collection is able to update with a 2d array</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">(), </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s6"># Check that pre-flattened arrays work too</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">9</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">9</span><span class="s2">))</span>

    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">16</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">), </span><span class="s1">shading</span><span class="s2">=</span><span class="s3">'gouraud'</span><span class="s2">)</span>
    <span class="s6"># Test that the collection is able to update with a 2d array</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">(), </span><span class="s1">z</span><span class="s2">)</span>

    <span class="s6"># Check that pre-flattened arrays work too</span>
    <span class="s1">coll</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">16</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_array</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s5">16</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_quadmesh_vmin_vmax</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s6"># test when vmin/vmax on the norm changes, the quadmesh gets updated</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">cmap </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colormaps</span><span class="s2">[</span><span class="s3">'plasma'</span><span class="s2">]</span>
    <span class="s1">norm </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">colors</span><span class="s2">.</span><span class="s1">Normalize</span><span class="s2">(</span><span class="s1">vmin</span><span class="s2">=</span><span class="s5">0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)([[</span><span class="s5">1</span><span class="s2">]], </span><span class="s1">cmap</span><span class="s2">=</span><span class="s1">cmap</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">=</span><span class="s1">norm</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">, :], </span><span class="s1">cmap</span><span class="s2">(</span><span class="s1">norm</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)))</span>

    <span class="s6"># Change the vmin/vmax of the norm so that the color is from</span>
    <span class="s6"># the bottom of the colormap now</span>
    <span class="s1">norm</span><span class="s2">.</span><span class="s1">vmin</span><span class="s2">, </span><span class="s1">norm</span><span class="s2">.</span><span class="s1">vmax </span><span class="s2">= </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">, :], </span><span class="s1">cmap</span><span class="s2">(</span><span class="s1">norm</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)))</span>


<span class="s0">def </span><span class="s1">test_quadmesh_alpha_array</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">9</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">alpha </span><span class="s2">= </span><span class="s1">z </span><span class="s2">/ </span><span class="s1">z</span><span class="s2">.</span><span class="s1">max</span><span class="s2">()</span>
    <span class="s1">alpha_flat </span><span class="s2">= </span><span class="s1">alpha</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>
    <span class="s6"># Provide 2-D alpha:</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">coll1 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">coll2 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">coll2</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">coll1</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha_flat</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">coll2</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha_flat</span><span class="s2">)</span>
    <span class="s6"># Or provide 1-D alpha:</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">coll1 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax0</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">coll2 </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">coll2</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">coll1</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha_flat</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">coll2</span><span class="s2">.</span><span class="s1">get_facecolors</span><span class="s2">()[:, -</span><span class="s5">1</span><span class="s2">], </span><span class="s1">alpha_flat</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_alpha_validation</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s6"># Most of the relevant testing is in test_artist and test_colors.</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)))</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;^Data array shape&quot;</span><span class="s2">):</span>
        <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">([</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">])</span>
        <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_legend_inverse_size_label_relationship</span><span class="s2">():</span>
    <span class="s4">&quot;&quot;&quot; 
    Ensure legend markers scale appropriately when label and size are 
    inversely related. 
    Here label = 5 / size 
    &quot;&quot;&quot;</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s5">19680801</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s5">50</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s5">50</span><span class="s2">)</span>
    <span class="s1">C </span><span class="s2">= </span><span class="s5">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s5">50</span><span class="s2">)</span>
    <span class="s1">S </span><span class="s2">= </span><span class="s5">5 </span><span class="s2">/ </span><span class="s1">C</span>

    <span class="s1">legend_sizes </span><span class="s2">= [</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">]</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">sc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">, </span><span class="s1">s</span><span class="s2">=</span><span class="s1">S</span><span class="s2">)</span>
    <span class="s1">handles</span><span class="s2">, </span><span class="s1">labels </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">legend_elements</span><span class="s2">(</span>
      <span class="s1">prop</span><span class="s2">=</span><span class="s3">'sizes'</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s1">legend_sizes</span><span class="s2">, </span><span class="s1">func</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">s</span><span class="s2">: </span><span class="s5">5 </span><span class="s2">/ </span><span class="s1">s</span>
    <span class="s2">)</span>

    <span class="s6"># Convert markersize scale to 's' scale</span>
    <span class="s1">handle_sizes </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">.</span><span class="s1">get_markersize</span><span class="s2">() </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">handles</span><span class="s2">]</span>
    <span class="s1">handle_sizes </span><span class="s2">= [</span><span class="s5">5 </span><span class="s2">/ </span><span class="s1">x</span><span class="s2">**</span><span class="s5">2 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">handle_sizes</span><span class="s2">]</span>

    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">handle_sizes</span><span class="s2">, </span><span class="s1">legend_sizes</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_color_logic</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s1">pcfunc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s6"># Explicitly set an edgecolor.</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">pcfunc</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">=</span><span class="s3">'red'</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()  </span><span class="s6"># This is called in draw().</span>
    <span class="s6"># Define 2 reference &quot;colors&quot; here for multiple use.</span>
    <span class="s1">face_default </span><span class="s2">= </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">to_rgba_array</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">_get_default_facecolor</span><span class="s2">())</span>
    <span class="s1">mapped </span><span class="s2">= </span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_cmap</span><span class="s2">()(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()))</span>
    <span class="s6"># GitHub issue #1302:</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), </span><span class="s3">'red'</span><span class="s2">)</span>
    <span class="s6"># Check setting attributes after initialization:</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">pcfunc</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_edgecolor</span><span class="s2">(</span><span class="s3">'red'</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">]])</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_alpha</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)  </span><span class="s6"># restore default alpha</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s6"># Reset edgecolor to default.</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_edgecolor</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), </span><span class="s1">mapped</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)  </span><span class="s6"># restore default for facecolor</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">mapped</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), </span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s6"># Turn off colormapping entirely:</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), </span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">face_default</span><span class="s2">)  </span><span class="s6"># not mapped</span>
    <span class="s6"># Turn it back on by restoring the array (must be 1D!):</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">mapped</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), </span><span class="s3">'none'</span><span class="s2">)</span>
    <span class="s6"># Give color via tuple rather than string.</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">pcfunc</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">=(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), </span><span class="s1">facecolors</span><span class="s2">=(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">mapped</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s6"># Provide an RGB array; mapping overrides it.</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">pcfunc</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">=(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), </span><span class="s1">facecolors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)))</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">mapped</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s6"># Turn off the mapping.</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s6"># And an RGBA array.</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">pcfunc</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">=(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">), </span><span class="s1">facecolors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)))</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">mapped</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s6"># Turn off the mapping.</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)))</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">test_LineCollection_args</span><span class="s2">():</span>
    <span class="s1">lc </span><span class="s2">= </span><span class="s1">LineCollection</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">linewidth</span><span class="s2">=</span><span class="s5">2.2</span><span class="s2">, </span><span class="s1">edgecolor</span><span class="s2">=</span><span class="s3">'r'</span><span class="s2">,</span>
                        <span class="s1">zorder</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">lc</span><span class="s2">.</span><span class="s1">get_linewidth</span><span class="s2">()[</span><span class="s5">0</span><span class="s2">] == </span><span class="s5">2.2</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">lc</span><span class="s2">.</span><span class="s1">get_edgecolor</span><span class="s2">(), </span><span class="s3">'r'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">lc</span><span class="s2">.</span><span class="s1">get_zorder</span><span class="s2">() == </span><span class="s5">3</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">lc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), [[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">]])</span>
    <span class="s6"># To avoid breaking mplot3d, LineCollection internally sets the facecolor</span>
    <span class="s6"># kwarg if it has not been specified.  Hence we need the following test</span>
    <span class="s6"># for LineCollection._set_default().</span>
    <span class="s1">lc </span><span class="s2">= </span><span class="s1">LineCollection</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">same_color</span><span class="s2">(</span><span class="s1">lc</span><span class="s2">.</span><span class="s1">get_facecolor</span><span class="s2">(), </span><span class="s3">'none'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_array_dimensions</span><span class="s2">(</span><span class="s1">pcfunc</span><span class="s2">):</span>
    <span class="s6"># Make sure we can set the 1D, 2D, and 3D array shapes</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">, </span><span class="s1">pcfunc</span><span class="s2">)(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s6"># 1D</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">())</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s6"># 2D</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>
    <span class="s6"># 3D RGB is OK as well</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">36</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">set_array</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
    <span class="s1">pc</span><span class="s2">.</span><span class="s1">update_scalarmappable</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_get_segments</span><span class="s2">():</span>
    <span class="s1">segments </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">256</span><span class="s2">), (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)).</span><span class="s1">T</span>
    <span class="s1">lc </span><span class="s2">= </span><span class="s1">LineCollection</span><span class="s2">([</span><span class="s1">segments</span><span class="s2">])</span>

    <span class="s1">readback</span><span class="s2">, = </span><span class="s1">lc</span><span class="s2">.</span><span class="s1">get_segments</span><span class="s2">()</span>
    <span class="s6"># these should comeback un-changed!</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">segments </span><span class="s2">== </span><span class="s1">readback</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_set_offsets_late</span><span class="s2">():</span>
    <span class="s1">identity </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">IdentityTransform</span><span class="s2">()</span>
    <span class="s1">sizes </span><span class="s2">= [</span><span class="s5">2</span><span class="s2">]</span>

    <span class="s1">null </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">CircleCollection</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">=</span><span class="s1">sizes</span><span class="s2">)</span>

    <span class="s1">init </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">CircleCollection</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">=</span><span class="s1">sizes</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">=(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>

    <span class="s1">late </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">CircleCollection</span><span class="s2">(</span><span class="s1">sizes</span><span class="s2">=</span><span class="s1">sizes</span><span class="s2">)</span>
    <span class="s1">late</span><span class="s2">.</span><span class="s1">set_offsets</span><span class="s2">((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">))</span>

    <span class="s6"># Bbox.__eq__ doesn't compare bounds</span>
    <span class="s1">null_bounds </span><span class="s2">= </span><span class="s1">null</span><span class="s2">.</span><span class="s1">get_datalim</span><span class="s2">(</span><span class="s1">identity</span><span class="s2">).</span><span class="s1">bounds</span>
    <span class="s1">init_bounds </span><span class="s2">= </span><span class="s1">init</span><span class="s2">.</span><span class="s1">get_datalim</span><span class="s2">(</span><span class="s1">identity</span><span class="s2">).</span><span class="s1">bounds</span>
    <span class="s1">late_bounds </span><span class="s2">= </span><span class="s1">late</span><span class="s2">.</span><span class="s1">get_datalim</span><span class="s2">(</span><span class="s1">identity</span><span class="s2">).</span><span class="s1">bounds</span>

    <span class="s6"># offsets and transform are applied when set after initialization</span>
    <span class="s0">assert </span><span class="s1">null_bounds </span><span class="s2">!= </span><span class="s1">init_bounds</span>
    <span class="s0">assert </span><span class="s1">init_bounds </span><span class="s2">== </span><span class="s1">late_bounds</span>


<span class="s0">def </span><span class="s1">test_set_offset_transform</span><span class="s2">():</span>
    <span class="s1">skew </span><span class="s2">= </span><span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">().</span><span class="s1">skew</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s1">init </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">Collection</span><span class="s2">(</span><span class="s1">offset_transform</span><span class="s2">=</span><span class="s1">skew</span><span class="s2">)</span>

    <span class="s1">late </span><span class="s2">= </span><span class="s1">mcollections</span><span class="s2">.</span><span class="s1">Collection</span><span class="s2">()</span>
    <span class="s1">late</span><span class="s2">.</span><span class="s1">set_offset_transform</span><span class="s2">(</span><span class="s1">skew</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">skew </span><span class="s2">== </span><span class="s1">init</span><span class="s2">.</span><span class="s1">get_offset_transform</span><span class="s2">() == </span><span class="s1">late</span><span class="s2">.</span><span class="s1">get_offset_transform</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_set_offset_units</span><span class="s2">():</span>
    <span class="s6"># passing the offsets in initially (i.e. via scatter)</span>
    <span class="s6"># should yield the same results as `set_offsets`</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">5</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">d </span><span class="s2">= </span><span class="s1">x </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">timedelta64</span><span class="s2">(</span><span class="s5">24</span><span class="s2">, </span><span class="s3">'h'</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">'2021-11-29'</span><span class="s2">)</span>

    <span class="s1">sc </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">off0 </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">get_offsets</span><span class="s2">()</span>
    <span class="s1">sc</span><span class="s2">.</span><span class="s1">set_offsets</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)))</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">off0</span><span class="s2">, </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">get_offsets</span><span class="s2">())</span>

    <span class="s6"># try the other way around</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">sc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>
    <span class="s1">off0 </span><span class="s2">= </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">get_offsets</span><span class="s2">()</span>
    <span class="s1">sc</span><span class="s2">.</span><span class="s1">set_offsets</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)))</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">off0</span><span class="s2">, </span><span class="s1">sc</span><span class="s2">.</span><span class="s1">get_offsets</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">=[</span><span class="s3">&quot;test_check_masked_offsets&quot;</span><span class="s2">],</span>
                  <span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s3">&quot;mpl20&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_check_masked_offsets</span><span class="s2">():</span>
    <span class="s6"># Check if masked data is respected by scatter</span>
    <span class="s6"># Ref: Issue #24545</span>
    <span class="s1">unmasked_x </span><span class="s2">= [</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s5">2022</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">49</span><span class="s2">, </span><span class="s5">52</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s5">2022</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">49</span><span class="s2">, </span><span class="s5">53</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s5">2022</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">49</span><span class="s2">, </span><span class="s5">54</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s5">2022</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">49</span><span class="s2">, </span><span class="s5">55</span><span class="s2">),</span>
        <span class="s1">datetime</span><span class="s2">(</span><span class="s5">2022</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">49</span><span class="s2">, </span><span class="s5">56</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s1">masked_y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">unmasked_x</span><span class="s2">, </span><span class="s1">masked_y</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_masked_set_offsets</span><span class="s2">(</span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">fig_test</span><span class="s2">):</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>

    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">scat </span><span class="s2">= </span><span class="s1">ax_test</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">scat</span><span class="s2">.</span><span class="s1">set_offsets</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]))</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">set_xticks</span><span class="s2">([])</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">set_yticks</span><span class="s2">([])</span>

    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">set_xticks</span><span class="s2">([])</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">set_yticks</span><span class="s2">([])</span>


<span class="s0">def </span><span class="s1">test_check_offsets_dtype</span><span class="s2">():</span>
    <span class="s6"># Check that setting offsets doesn't change dtype</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">], </span><span class="s1">mask</span><span class="s2">=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">scat </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">masked_offsets </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>
    <span class="s1">scat</span><span class="s2">.</span><span class="s1">set_offsets</span><span class="s2">(</span><span class="s1">masked_offsets</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">scat</span><span class="s2">.</span><span class="s1">get_offsets</span><span class="s2">(), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">masked_offsets</span><span class="s2">))</span>

    <span class="s1">unmasked_offsets </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">column_stack</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">])</span>
    <span class="s1">scat</span><span class="s2">.</span><span class="s1">set_offsets</span><span class="s2">(</span><span class="s1">unmasked_offsets</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">scat</span><span class="s2">.</span><span class="s1">get_offsets</span><span class="s2">(), </span><span class="s1">type</span><span class="s2">(</span><span class="s1">unmasked_offsets</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'gapcolor'</span><span class="s2">, [</span><span class="s3">'orange'</span><span class="s2">, [</span><span class="s3">'r'</span><span class="s2">, </span><span class="s3">'k'</span><span class="s2">]])</span>
<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">'png'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">({</span><span class="s3">'lines.linewidth'</span><span class="s2">: </span><span class="s5">20</span><span class="s2">})</span>
<span class="s0">def </span><span class="s1">test_striped_lines</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">gapcolor</span><span class="s2">):</span>
    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s5">111</span><span class="s2">)</span>
    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s5">111</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s2">[</span><span class="s1">ax_test</span><span class="s2">, </span><span class="s1">ax_ref</span><span class="s2">]:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">6</span><span class="s2">)</span>
    <span class="s1">linestyles </span><span class="s2">= [</span><span class="s3">':'</span><span class="s2">, </span><span class="s3">'-'</span><span class="s2">, </span><span class="s3">'--'</span><span class="s2">]</span>

    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">vlines</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s1">linestyles</span><span class="s2">, </span><span class="s1">gapcolor</span><span class="s2">=</span><span class="s1">gapcolor</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">gapcolor</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s1">gapcolor </span><span class="s2">= [</span><span class="s1">gapcolor</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">gcol</span><span class="s2">, </span><span class="s1">ls </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">cycle</span><span class="s2">(</span><span class="s1">gapcolor</span><span class="s2">),</span>
                           <span class="s1">itertools</span><span class="s2">.</span><span class="s1">cycle</span><span class="s2">(</span><span class="s1">linestyles</span><span class="s2">)):</span>
        <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">axvline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">linestyle</span><span class="s2">=</span><span class="s1">ls</span><span class="s2">, </span><span class="s1">gapcolor</span><span class="s2">=</span><span class="s1">gcol</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">)</span>
</pre>
</body>
</html>