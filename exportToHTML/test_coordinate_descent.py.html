<html>
<head>
<title>test_coordinate_descent.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_coordinate_descent.py</font>
</center></td></tr></table>
<pre><span class="s0"># Authors: Olivier Grisel &lt;olivier.grisel@ensta.org&gt;</span>
<span class="s0">#          Alexandre Gramfort &lt;alexandre.gramfort@inria.fr&gt;</span>
<span class="s0"># License: BSD 3 clause</span>

<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">copy </span><span class="s2">import </span><span class="s1">deepcopy</span>

<span class="s2">import </span><span class="s1">joblib</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">interpolate</span><span class="s3">, </span><span class="s1">sparse</span>

<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">clone</span><span class="s3">, </span><span class="s1">is_classifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s1">load_diabetes</span><span class="s3">, </span><span class="s1">make_regression</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">ConvergenceWarning</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ElasticNet</span><span class="s3">,</span>
    <span class="s1">ElasticNetCV</span><span class="s3">,</span>
    <span class="s1">Lasso</span><span class="s3">,</span>
    <span class="s1">LassoCV</span><span class="s3">,</span>
    <span class="s1">LassoLars</span><span class="s3">,</span>
    <span class="s1">LassoLarsCV</span><span class="s3">,</span>
    <span class="s1">LinearRegression</span><span class="s3">,</span>
    <span class="s1">MultiTaskElasticNet</span><span class="s3">,</span>
    <span class="s1">MultiTaskElasticNetCV</span><span class="s3">,</span>
    <span class="s1">MultiTaskLasso</span><span class="s3">,</span>
    <span class="s1">MultiTaskLassoCV</span><span class="s3">,</span>
    <span class="s1">Ridge</span><span class="s3">,</span>
    <span class="s1">RidgeClassifier</span><span class="s3">,</span>
    <span class="s1">RidgeClassifierCV</span><span class="s3">,</span>
    <span class="s1">RidgeCV</span><span class="s3">,</span>
    <span class="s1">enet_path</span><span class="s3">,</span>
    <span class="s1">lars_path</span><span class="s3">,</span>
    <span class="s1">lasso_path</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model</span><span class="s3">.</span><span class="s1">_coordinate_descent </span><span class="s2">import </span><span class="s1">_set_order</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">BaseCrossValidator</span><span class="s3">,</span>
    <span class="s1">GridSearchCV</span><span class="s3">,</span>
    <span class="s1">LeaveOneGroupOut</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection</span><span class="s3">.</span><span class="s1">_split </span><span class="s2">import </span><span class="s1">GroupsConsumerMixin</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">pipeline </span><span class="s2">import </span><span class="s1">make_pipeline</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">preprocessing </span><span class="s2">import </span><span class="s1">StandardScaler</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">check_array</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">TempMemmap</span><span class="s3">,</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
    <span class="s1">ignore_warnings</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s1">COO_CONTAINERS</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;order&quot;</span><span class="s3">, [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;F&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;input_order&quot;</span><span class="s3">, [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;F&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_set_order_dense</span><span class="s3">(</span><span class="s1">order</span><span class="s3">, </span><span class="s1">input_order</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check that _set_order returns arrays with promised order.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">]], </span><span class="s1">order</span><span class="s3">=</span><span class="s1">input_order</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">order</span><span class="s3">=</span><span class="s1">input_order</span><span class="s3">)</span>
    <span class="s1">X2</span><span class="s3">, </span><span class="s1">y2 </span><span class="s3">= </span><span class="s1">_set_order</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s1">order</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">order </span><span class="s3">== </span><span class="s4">&quot;C&quot;</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s4">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">y2</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s4">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
    <span class="s2">elif </span><span class="s1">order </span><span class="s3">== </span><span class="s4">&quot;F&quot;</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s4">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">y2</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s4">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>

    <span class="s2">if </span><span class="s1">order </span><span class="s3">== </span><span class="s1">input_order</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">X </span><span class="s2">is </span><span class="s1">X2</span>
        <span class="s2">assert </span><span class="s1">y </span><span class="s2">is </span><span class="s1">y2</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;order&quot;</span><span class="s3">, [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;F&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;input_order&quot;</span><span class="s3">, [</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s4">&quot;F&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;coo_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_set_order_sparse</span><span class="s3">(</span><span class="s1">order</span><span class="s3">, </span><span class="s1">input_order</span><span class="s3">, </span><span class="s1">coo_container</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check that _set_order returns sparse matrices in promised format.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">]]))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">coo_container</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
    <span class="s1">sparse_format </span><span class="s3">= </span><span class="s4">&quot;csc&quot; </span><span class="s2">if </span><span class="s1">input_order </span><span class="s3">== </span><span class="s4">&quot;F&quot; </span><span class="s2">else </span><span class="s4">&quot;csr&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">asformat</span><span class="s3">(</span><span class="s1">sparse_format</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">asformat</span><span class="s3">(</span><span class="s1">sparse_format</span><span class="s3">)</span>
    <span class="s1">X2</span><span class="s3">, </span><span class="s1">y2 </span><span class="s3">= </span><span class="s1">_set_order</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s1">order</span><span class="s3">)</span>

    <span class="s1">format </span><span class="s3">= </span><span class="s4">&quot;csc&quot; </span><span class="s2">if </span><span class="s1">order </span><span class="s3">== </span><span class="s4">&quot;F&quot; </span><span class="s2">else </span><span class="s4">&quot;csr&quot;</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">) </span><span class="s2">and </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">format</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">y2</span><span class="s3">) </span><span class="s2">and </span><span class="s1">y2</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">format</span>


<span class="s2">def </span><span class="s1">test_lasso_zero</span><span class="s3">():</span>
    <span class="s0"># Check that the lasso can handle zero data without crashing</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_nonfinite_params</span><span class="s3">():</span>
    <span class="s0"># Check ElasticNet throws ValueError when dealing with non-finite parameter</span>
    <span class="s0"># values</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s6">10</span>
    <span class="s1">fmax </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">max</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">fmax </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">2</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Coordinate descent iterations resulted in non-finite parameter values&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_toy</span><span class="s3">():</span>
    <span class="s0"># Test Lasso on a toy example for various values of alpha.</span>
    <span class="s0"># When validating this against glmnet notice that glmnet divides it</span>
    <span class="s0"># against nobs.</span>

    <span class="s1">X </span><span class="s3">= [[-</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]]</span>
    <span class="s1">Y </span><span class="s3">= [-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]  </span><span class="s0"># just a straight line</span>
    <span class="s1">T </span><span class="s3">= [[</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">]]  </span><span class="s0"># test sample</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.85</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">1.7</span><span class="s3">, </span><span class="s6">2.55</span><span class="s3">, </span><span class="s6">3.4</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.25</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.75</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_toy</span><span class="s3">():</span>
    <span class="s0"># Test ElasticNet for various parameters of alpha and l1_ratio.</span>
    <span class="s0"># Actually, the parameters alpha = 0 should not be allowed. However,</span>
    <span class="s0"># we test it as a border case.</span>
    <span class="s0"># ElasticNet is tested with and without precomputed Gram matrix</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[-</span><span class="s6">1.0</span><span class="s3">], [</span><span class="s6">0.0</span><span class="s3">], [</span><span class="s6">1.0</span><span class="s3">]])</span>
    <span class="s1">Y </span><span class="s3">= [-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]  </span><span class="s0"># just a straight line</span>
    <span class="s1">T </span><span class="s3">= [[</span><span class="s6">2.0</span><span class="s3">], [</span><span class="s6">3.0</span><span class="s3">], [</span><span class="s6">4.0</span><span class="s3">]]  </span><span class="s0"># test sample</span>

    <span class="s0"># this should be the same as lasso</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.50819</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">1.0163</span><span class="s3">, </span><span class="s6">1.5245</span><span class="s3">, </span><span class="s6">2.0327</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)  </span><span class="s0"># with Gram</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.50819</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">1.0163</span><span class="s3">, </span><span class="s6">1.5245</span><span class="s3">, </span><span class="s6">2.0327</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)  </span><span class="s0"># with Gram</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.50819</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">1.0163</span><span class="s3">, </span><span class="s6">1.5245</span><span class="s3">, </span><span class="s6">2.0327</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.45454</span><span class="s3">], </span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">0.9090</span><span class="s3">, </span><span class="s6">1.3636</span><span class="s3">, </span><span class="s6">1.8181</span><span class="s3">], </span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_dual_gap</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Check that Lasso.dual_gap_ matches its objective formulation, with the 
    datafit normalized by n_samples 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">30</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">alpha </span><span class="s3">= </span><span class="s6">0.01 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T </span><span class="s3">@ </span><span class="s1">y</span><span class="s3">)) / </span><span class="s1">n_samples</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">w </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span>
    <span class="s1">R </span><span class="s3">= </span><span class="s1">y </span><span class="s3">- </span><span class="s1">X </span><span class="s3">@ </span><span class="s1">w</span>
    <span class="s1">primal </span><span class="s3">= </span><span class="s6">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">R</span><span class="s3">**</span><span class="s6">2</span><span class="s3">) + </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">w</span><span class="s3">))</span>
    <span class="s0"># dual pt: R / n_samples, dual constraint: norm(X.T @ theta, inf) &lt;= alpha</span>
    <span class="s1">R </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T </span><span class="s3">@ </span><span class="s1">R</span><span class="s3">) / (</span><span class="s1">n_samples </span><span class="s3">* </span><span class="s1">alpha</span><span class="s3">))</span>
    <span class="s1">dual </span><span class="s3">= </span><span class="s6">0.5 </span><span class="s3">* (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">y</span><span class="s3">**</span><span class="s6">2</span><span class="s3">) - </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">((</span><span class="s1">y </span><span class="s3">- </span><span class="s1">R</span><span class="s3">) ** </span><span class="s6">2</span><span class="s3">))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s1">primal </span><span class="s3">- </span><span class="s1">dual</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">200</span><span class="s3">, </span><span class="s1">n_informative_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">1</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot; 
    build an ill-posed linear regression problem with many noisy features and 
    comparatively few samples 
    &quot;&quot;&quot;</span>
    <span class="s1">random_state </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">n_targets </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">:</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">w</span><span class="s3">[</span><span class="s1">n_informative_features</span><span class="s3">:] = </span><span class="s6">0.0</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">w</span><span class="s3">)</span>
    <span class="s1">X_test </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">y_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">w</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test</span>


<span class="s2">def </span><span class="s1">test_lasso_cv</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">max_iter </span><span class="s3">= </span><span class="s6">150</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s6">0.056</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s6">0.056</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s0"># Check that the lars and the coordinate descent implementation</span>
    <span class="s0"># select a similar alpha</span>
    <span class="s1">lars </span><span class="s3">= </span><span class="s1">LassoLarsCV</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">30</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s0"># for this we check that they don't fall in the grid of</span>
    <span class="s0"># clf.alphas further than 1</span>
    <span class="s2">assert </span><span class="s3">(</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">searchsorted</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">[::-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">lars</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">)</span>
            <span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">searchsorted</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">[::-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s3">&lt;= </span><span class="s6">1</span>
    <span class="s3">)</span>
    <span class="s0"># check that they also give a similar MSE</span>
    <span class="s1">mse_lars </span><span class="s3">= </span><span class="s1">interpolate</span><span class="s3">.</span><span class="s1">interp1d</span><span class="s3">(</span><span class="s1">lars</span><span class="s3">.</span><span class="s1">cv_alphas_</span><span class="s3">, </span><span class="s1">lars</span><span class="s3">.</span><span class="s1">mse_path_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">testing</span><span class="s3">.</span><span class="s1">assert_approx_equal</span><span class="s3">(</span>
        <span class="s1">mse_lars</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">[</span><span class="s6">5</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">mse_path_</span><span class="s3">[</span><span class="s6">5</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">significant</span><span class="s3">=</span><span class="s6">2</span>
    <span class="s3">)</span>

    <span class="s0"># test set</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test</span><span class="s3">) &gt; </span><span class="s6">0.99</span>


<span class="s2">def </span><span class="s1">test_lasso_cv_with_some_model_selection</span><span class="s3">():</span>
    <span class="s2">from </span><span class="s1">sklearn </span><span class="s2">import </span><span class="s1">datasets</span>
    <span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection </span><span class="s2">import </span><span class="s1">ShuffleSplit</span>

    <span class="s1">diabetes </span><span class="s3">= </span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">load_diabetes</span><span class="s3">()</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span>

    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">StandardScaler</span><span class="s3">(), </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">=</span><span class="s1">ShuffleSplit</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)))</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_cv_positive_constraint</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">max_iter </span><span class="s3">= </span><span class="s6">500</span>

    <span class="s0"># Ensure the unconstrained fit has a negative coefficient</span>
    <span class="s1">clf_unconstrained </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">clf_unconstrained</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">clf_unconstrained</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &lt; </span><span class="s6">0</span>

    <span class="s0"># On same data, constrained fit has non-negative coefficients</span>
    <span class="s1">clf_constrained </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span>
        <span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">1</span>
    <span class="s3">)</span>
    <span class="s1">clf_constrained</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">clf_constrained</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &gt;= </span><span class="s6">0</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;alphas, err_type, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">((</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">100</span><span class="s3">), </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s4">r&quot;alphas\[1\] == -1, must be &gt;= 0.0.&quot;</span><span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">(-</span><span class="s6">0.1</span><span class="s3">, -</span><span class="s6">1.0</span><span class="s3">, -</span><span class="s6">10.0</span><span class="s3">),</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s4">r&quot;alphas\[0\] == -0.1, must be &gt;= 0.0.&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s4">&quot;1&quot;</span><span class="s3">),</span>
            <span class="s1">TypeError</span><span class="s3">,</span>
            <span class="s4">r&quot;alphas\[2\] must be an instance of float, not str&quot;</span><span class="s3">,</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_lassocv_alphas_validation</span><span class="s3">(</span><span class="s1">alphas</span><span class="s3">, </span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check the `alphas` validation in LassoCV.&quot;&quot;&quot;</span>

    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">5</span><span class="s3">, </span><span class="s6">5</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">lassocv </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">alphas</span><span class="s3">=</span><span class="s1">alphas</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">err_type</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">lassocv</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_scale_alpha_inplace</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Rescale the parameter alpha from when the estimator is evoked with 
    normalize set to True as if it were evoked in a Pipeline with normalize set 
    to False and with a StandardScaler. 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s4">&quot;alpha&quot; </span><span class="s2">not in </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">()) </span><span class="s2">and </span><span class="s3">(</span>
        <span class="s4">&quot;alphas&quot; </span><span class="s2">not in </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">()</span>
    <span class="s3">):</span>
        <span class="s2">return</span>

    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, (</span><span class="s1">RidgeCV</span><span class="s3">, </span><span class="s1">RidgeClassifierCV</span><span class="s3">)):</span>
        <span class="s0"># alphas is not validated at this point and can be a list.</span>
        <span class="s0"># We convert it to a np.ndarray to make sure broadcasting</span>
        <span class="s0"># is used.</span>
        <span class="s1">alphas </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">alphas</span><span class="s3">) * </span><span class="s1">n_samples</span>
        <span class="s2">return </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">alphas</span><span class="s3">=</span><span class="s1">alphas</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, (</span><span class="s1">Lasso</span><span class="s3">, </span><span class="s1">LassoLars</span><span class="s3">, </span><span class="s1">MultiTaskLasso</span><span class="s3">)):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">alpha </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, (</span><span class="s1">Ridge</span><span class="s3">, </span><span class="s1">RidgeClassifier</span><span class="s3">)):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">alpha </span><span class="s3">* </span><span class="s1">n_samples</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, (</span><span class="s1">ElasticNet</span><span class="s3">, </span><span class="s1">MultiTaskElasticNet</span><span class="s3">)):</span>
        <span class="s2">if </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">l1_ratio </span><span class="s3">== </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">alpha </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">alpha </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">l1_ratio </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">alpha </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">alpha </span><span class="s3">* </span><span class="s1">n_samples</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s0"># To avoid silent errors in case of refactoring</span>
            <span class="s2">raise </span><span class="s1">NotImplementedError</span>

    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">alpha</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;LinearModel, params&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">Lasso</span><span class="s3">, {</span><span class="s4">&quot;tol&quot;</span><span class="s3">: </span><span class="s6">1e-16</span><span class="s3">, </span><span class="s4">&quot;alpha&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LassoCV</span><span class="s3">, {</span><span class="s4">&quot;tol&quot;</span><span class="s3">: </span><span class="s6">1e-16</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">ElasticNetCV</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s1">RidgeClassifier</span><span class="s3">, {</span><span class="s4">&quot;solver&quot;</span><span class="s3">: </span><span class="s4">&quot;sparse_cg&quot;</span><span class="s3">, </span><span class="s4">&quot;alpha&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">ElasticNet</span><span class="s3">, {</span><span class="s4">&quot;tol&quot;</span><span class="s3">: </span><span class="s6">1e-16</span><span class="s3">, </span><span class="s4">&quot;l1_ratio&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">, </span><span class="s4">&quot;alpha&quot;</span><span class="s3">: </span><span class="s6">0.01</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">ElasticNet</span><span class="s3">, {</span><span class="s4">&quot;tol&quot;</span><span class="s3">: </span><span class="s6">1e-16</span><span class="s3">, </span><span class="s4">&quot;l1_ratio&quot;</span><span class="s3">: </span><span class="s6">0</span><span class="s3">, </span><span class="s4">&quot;alpha&quot;</span><span class="s3">: </span><span class="s6">0.01</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">Ridge</span><span class="s3">, {</span><span class="s4">&quot;solver&quot;</span><span class="s3">: </span><span class="s4">&quot;sparse_cg&quot;</span><span class="s3">, </span><span class="s4">&quot;tol&quot;</span><span class="s3">: </span><span class="s6">1e-12</span><span class="s3">, </span><span class="s4">&quot;alpha&quot;</span><span class="s3">: </span><span class="s6">0.1</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearRegression</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s1">RidgeCV</span><span class="s3">, {}),</span>
        <span class="s3">(</span><span class="s1">RidgeClassifierCV</span><span class="s3">, {}),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_model_pipeline_same_dense_and_sparse</span><span class="s3">(</span><span class="s1">LinearModel</span><span class="s3">, </span><span class="s1">params</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Test that linear model preceded by StandardScaler in the pipeline and</span>
    <span class="s0"># with normalize set to False gives the same y_pred and the same .coef_</span>
    <span class="s0"># given X sparse or dense</span>

    <span class="s1">model_dense </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">LinearModel</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">))</span>

    <span class="s1">model_sparse </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">LinearModel</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">))</span>

    <span class="s0"># prepare the data</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s6">200</span>
    <span class="s1">n_features </span><span class="s3">= </span><span class="s6">2</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s1">X </span><span class="s3">&lt; </span><span class="s6">0.1</span><span class="s3">] = </span><span class="s6">0.0</span>

    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">is_classifier</span><span class="s3">(</span><span class="s1">model_dense</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">model_dense</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">model_sparse</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">model_sparse</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">model_dense</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">y_pred_dense </span><span class="s3">= </span><span class="s1">model_dense</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">y_pred_sparse </span><span class="s3">= </span><span class="s1">model_sparse</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_pred_dense</span><span class="s3">, </span><span class="s1">y_pred_sparse</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">model_dense</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">model_sparse</span><span class="s3">[</span><span class="s6">1</span><span class="s3">].</span><span class="s1">intercept_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_path_return_models_vs_new_return_gives_same_coefficients</span><span class="s3">():</span>
    <span class="s0"># Test that lasso_path with lars_path style output gives the</span>
    <span class="s0"># same result</span>

    <span class="s0"># Some toy data</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3.1</span><span class="s3">], [</span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">5.4</span><span class="s3">, </span><span class="s6">4.3</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3.1</span><span class="s3">])</span>
    <span class="s1">alphas </span><span class="s3">= [</span><span class="s6">5.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">]</span>

    <span class="s0"># Use lars_path and lasso_path(new output) with 1D linear interpolation</span>
    <span class="s0"># to compute the same path</span>
    <span class="s1">alphas_lars</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">coef_path_lars </span><span class="s3">= </span><span class="s1">lars_path</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;lasso&quot;</span><span class="s3">)</span>
    <span class="s1">coef_path_cont_lars </span><span class="s3">= </span><span class="s1">interpolate</span><span class="s3">.</span><span class="s1">interp1d</span><span class="s3">(</span>
        <span class="s1">alphas_lars</span><span class="s3">[::-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">coef_path_lars</span><span class="s3">[:, ::-</span><span class="s6">1</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">alphas_lasso2</span><span class="s3">, </span><span class="s1">coef_path_lasso2</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lasso_path</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">alphas</span><span class="s3">=</span><span class="s1">alphas</span><span class="s3">)</span>
    <span class="s1">coef_path_cont_lasso </span><span class="s3">= </span><span class="s1">interpolate</span><span class="s3">.</span><span class="s1">interp1d</span><span class="s3">(</span>
        <span class="s1">alphas_lasso2</span><span class="s3">[::-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">coef_path_lasso2</span><span class="s3">[:, ::-</span><span class="s6">1</span><span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">coef_path_cont_lasso</span><span class="s3">(</span><span class="s1">alphas</span><span class="s3">), </span><span class="s1">coef_path_cont_lars</span><span class="s3">(</span><span class="s1">alphas</span><span class="s3">), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">1</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_path</span><span class="s3">():</span>
    <span class="s0"># We use a large number of samples and of informative features so that</span>
    <span class="s0"># the l1_ratio selected is more toward ridge than lasso</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s6">200</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">n_informative_features</span><span class="s3">=</span><span class="s6">100</span>
    <span class="s3">)</span>
    <span class="s1">max_iter </span><span class="s3">= </span><span class="s6">150</span>

    <span class="s0"># Here we have a small number of iterations, and thus the</span>
    <span class="s0"># ElasticNet might not converge. This is to speed up tests</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span>
        <span class="s1">alphas</span><span class="s3">=[</span><span class="s6">0.01</span><span class="s3">, </span><span class="s6">0.05</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">], </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">], </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span>
    <span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s0"># Well-conditioned settings, we should have selected our</span>
    <span class="s0"># smallest penalty</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">min</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">))</span>
    <span class="s0"># Non-sparse ground truth: we should have selected an elastic-net</span>
    <span class="s0"># that is closer to ridge than to lasso</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio_ </span><span class="s3">== </span><span class="s1">min</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span>
        <span class="s1">alphas</span><span class="s3">=[</span><span class="s6">0.01</span><span class="s3">, </span><span class="s6">0.05</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">],</span>
        <span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">,</span>
        <span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">],</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">,</span>
        <span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">,</span>
        <span class="s1">precompute</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s0"># Well-conditioned settings, we should have selected our</span>
    <span class="s0"># smallest penalty</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">min</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">))</span>
    <span class="s0"># Non-sparse ground truth: we should have selected an elastic-net</span>
    <span class="s0"># that is closer to ridge than to lasso</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio_ </span><span class="s3">== </span><span class="s1">min</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio</span><span class="s3">)</span>

    <span class="s0"># We are in well-conditioned settings with low noise: we should</span>
    <span class="s0"># have a good test-set performance</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test</span><span class="s3">) &gt; </span><span class="s6">0.99</span>

    <span class="s0"># Multi-output/target case</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span>
        <span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">], </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span>
    <span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s0"># We are in well-conditioned settings with low noise: we should</span>
    <span class="s0"># have a good test-set performance</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test</span><span class="s3">) &gt; </span><span class="s6">0.99</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)</span>

    <span class="s0"># Mono-output should have same cross-validated alpha_ and l1_ratio_</span>
    <span class="s0"># in both cases.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">])</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">clf2 </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">])</span>
    <span class="s1">clf2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">l1_ratio_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">l1_ratio_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_path_parameters</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">max_iter </span><span class="s3">= </span><span class="s6">100</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)  </span><span class="s0"># new params</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s6">50 </span><span class="s3">== </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">n_alphas</span>
    <span class="s2">assert </span><span class="s6">50 </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_warm_start</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">warm_start</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)  </span><span class="s0"># do a second round with 5 iterations</span>

    <span class="s1">clf2 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_alpha_warning</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[-</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]]</span>
    <span class="s1">Y </span><span class="s3">= [-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]  </span><span class="s0"># just a straight line</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s4">&quot;With alpha=0, this algorithm does not &quot;</span>
        <span class="s4">&quot;converge well. You are advised to use the &quot;</span>
        <span class="s4">&quot;LinearRegression estimator&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_positive_constraint</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[-</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">]  </span><span class="s0"># just a straight line with negative slope</span>

    <span class="s1">lasso </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">lasso</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">lasso</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &gt;= </span><span class="s6">0</span>

    <span class="s1">lasso </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">lasso</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">lasso</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &gt;= </span><span class="s6">0</span>


<span class="s2">def </span><span class="s1">test_enet_positive_constraint</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[-</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">]  </span><span class="s0"># just a straight line with negative slope</span>

    <span class="s1">enet </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">enet</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">enet</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &gt;= </span><span class="s6">0</span>


<span class="s2">def </span><span class="s1">test_enet_cv_positive_constraint</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">max_iter </span><span class="s3">= </span><span class="s6">500</span>

    <span class="s0"># Ensure the unconstrained fit has a negative coefficient</span>
    <span class="s1">enetcv_unconstrained </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span>
        <span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">1</span>
    <span class="s3">)</span>
    <span class="s1">enetcv_unconstrained</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">enetcv_unconstrained</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &lt; </span><span class="s6">0</span>

    <span class="s0"># On same data, constrained fit has non-negative coefficients</span>
    <span class="s1">enetcv_constrained </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span>
        <span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s1">max_iter</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">1</span>
    <span class="s3">)</span>
    <span class="s1">enetcv_constrained</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">enetcv_constrained</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">) &gt;= </span><span class="s6">0</span>


<span class="s2">def </span><span class="s1">test_uniform_targets</span><span class="s3">():</span>
    <span class="s1">enet </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">m_enet </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">lasso </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">m_lasso </span><span class="s3">= </span><span class="s1">MultiTaskLassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>

    <span class="s1">models_single_task </span><span class="s3">= (</span><span class="s1">enet</span><span class="s3">, </span><span class="s1">lasso</span><span class="s3">)</span>
    <span class="s1">models_multi_task </span><span class="s3">= (</span><span class="s1">m_enet</span><span class="s3">, </span><span class="s1">m_lasso</span><span class="s3">)</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">X_train </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">3</span><span class="s3">))</span>
    <span class="s1">X_test </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">3</span><span class="s3">))</span>

    <span class="s1">y1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s6">10</span><span class="s3">, </span><span class="s6">2</span><span class="s3">))</span>

    <span class="s2">for </span><span class="s1">model </span><span class="s2">in </span><span class="s1">models_single_task</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">y_values </span><span class="s2">in </span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">):</span>
            <span class="s1">y1</span><span class="s3">.</span><span class="s1">fill</span><span class="s3">(</span><span class="s1">y_values</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">), </span><span class="s1">y1</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">resolution</span><span class="s3">] * </span><span class="s6">3</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">model </span><span class="s2">in </span><span class="s1">models_multi_task</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">y_values </span><span class="s2">in </span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">):</span>
            <span class="s1">y2</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">].</span><span class="s1">fill</span><span class="s3">(</span><span class="s1">y_values</span><span class="s3">)</span>
            <span class="s1">y2</span><span class="s3">[:, </span><span class="s6">1</span><span class="s3">].</span><span class="s1">fill</span><span class="s3">(</span><span class="s6">2 </span><span class="s3">* </span><span class="s1">y_values</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">), </span><span class="s1">y2</span><span class="s3">)</span>
            <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">model</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">resolution</span><span class="s3">] * </span><span class="s6">3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_multi_task_lasso_and_enet</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
    <span class="s0"># Y_test = np.c_[y_test, y_test]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskLasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s6">0 </span><span class="s3">&lt; </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_ </span><span class="s3">&lt; </span><span class="s6">1e-5</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s6">0 </span><span class="s3">&lt; </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_ </span><span class="s3">&lt; </span><span class="s6">1e-5</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s4">&quot;Objective did not converge. You might want to &quot;</span>
        <span class="s4">&quot;increase the number of iterations.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">ConvergenceWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lasso_readonly_data</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[-</span><span class="s6">1</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">]])</span>
    <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])  </span><span class="s0"># just a straight line</span>
    <span class="s1">T </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">], [</span><span class="s6">4</span><span class="s3">]])  </span><span class="s0"># test sample</span>
    <span class="s2">with </span><span class="s1">TempMemmap</span><span class="s3">((</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">):</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">)</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
        <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s6">0.25</span><span class="s3">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.75</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_multi_task_lasso_readonly_data</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
    <span class="s2">with </span><span class="s1">TempMemmap</span><span class="s3">((</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)) </span><span class="s2">as </span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">):</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskLasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s6">0 </span><span class="s3">&lt; </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_gap_ </span><span class="s3">&lt; </span><span class="s6">1e-5</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_enet_multitarget</span><span class="s3">():</span>
    <span class="s1">n_targets </span><span class="s3">= </span><span class="s6">3</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">8</span><span class="s3">, </span><span class="s1">n_informative_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">=</span><span class="s1">n_targets</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">)</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">coef</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">, </span><span class="s1">dual_gap </span><span class="s3">= (</span>
        <span class="s1">estimator</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">,</span>
        <span class="s1">estimator</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">,</span>
        <span class="s1">estimator</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_targets</span><span class="s3">):</span>
        <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">k</span><span class="s3">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">coef</span><span class="s3">[</span><span class="s1">k</span><span class="s3">, :], </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">intercept</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dual_gap</span><span class="s3">[</span><span class="s1">k</span><span class="s3">], </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">dual_gap_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_multioutput_enetcv_error</span><span class="s3">():</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_multitask_enet_and_lasso_cv</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s6">0.00556</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskLassoCV</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s6">0.00278</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span>
        <span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.3</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">], </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span>
    <span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s6">0.5 </span><span class="s3">== </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio_</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">3</span><span class="s3">,) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">3</span><span class="s3">) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">mse_path_</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">.</span><span class="s1">shape</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskLassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">3</span><span class="s3">,) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">3</span><span class="s3">) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">mse_path_</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s2">assert </span><span class="s6">10 </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alphas_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_1d_multioutput_enet_and_multitask_enet_cv</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">])</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">])</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">l1_ratio_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">l1_ratio_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_1d_multioutput_lasso_and_multitask_lasso_cv</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">MultiTaskLassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">2e-3</span><span class="s3">)</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sparse_input_dtype_enet_and_lassocv</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">)</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">6</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">6</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">)</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">alpha_</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">6</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">6</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_elasticnet_precompute_incorrect_gram</span><span class="s3">():</span>
    <span class="s0"># check that passing an invalid precomputed Gram matrix will raise an</span>
    <span class="s0"># error.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">X_centered </span><span class="s3">= </span><span class="s1">X </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">average</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">garbage </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
    <span class="s1">precompute </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">garbage</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">garbage</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s1">precompute</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Gram matrix.*did not pass validation.*&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_centered</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_elasticnet_precompute_gram_weighted_samples</span><span class="s3">():</span>
    <span class="s0"># check the equivalence between passing a precomputed Gram matrix and</span>
    <span class="s0"># internal computation using sample weights.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">lognormal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>

    <span class="s1">w_norm </span><span class="s3">= </span><span class="s1">sample_weight </span><span class="s3">* (</span><span class="s1">y</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">/ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">))</span>
    <span class="s1">X_c </span><span class="s3">= </span><span class="s1">X </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">average</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">=</span><span class="s1">w_norm</span><span class="s3">)</span>
    <span class="s1">X_r </span><span class="s3">= </span><span class="s1">X_c </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">w_norm</span><span class="s3">)[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
    <span class="s1">gram </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_r</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">X_r</span><span class="s3">)</span>

    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s1">gram</span><span class="s3">)</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_c</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>

    <span class="s1">clf2 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">clf2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_elasticnet_precompute_gram</span><span class="s3">():</span>
    <span class="s0"># Check the dtype-aware check for a precomputed Gram matrix</span>
    <span class="s0"># (see https://github.com/scikit-learn/scikit-learn/pull/22059</span>
    <span class="s0"># and https://github.com/scikit-learn/scikit-learn/issues/21997).</span>
    <span class="s0"># Here: (X_c.T, X_c)[2, 3] is not equal to np.dot(X_c[:, 2], X_c[:, 3])</span>
    <span class="s0"># but within tolerance for np.float32</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">58</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">binomial</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0.25</span><span class="s3">, (</span><span class="s6">1000</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">1000</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

    <span class="s1">X_c </span><span class="s3">= </span><span class="s1">X </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">average</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">gram </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_c</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">X_c</span><span class="s3">)</span>

    <span class="s1">clf1 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s1">gram</span><span class="s3">)</span>
    <span class="s1">clf1</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_c</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">clf2 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">clf2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clf1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_warm_start_convergence</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">model </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">n_iter_reference </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">n_iter_</span>

    <span class="s0"># This dataset is not trivial enough for the model to converge in one pass.</span>
    <span class="s2">assert </span><span class="s1">n_iter_reference </span><span class="s3">&gt; </span><span class="s6">2</span>

    <span class="s0"># Check that n_iter_ is invariant to multiple calls to fit</span>
    <span class="s0"># when warm_start=False, all else being equal.</span>
    <span class="s1">model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">n_iter_cold_start </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">n_iter_</span>
    <span class="s2">assert </span><span class="s1">n_iter_cold_start </span><span class="s3">== </span><span class="s1">n_iter_reference</span>

    <span class="s0"># Fit the same model again, using a warm start: the optimizer just performs</span>
    <span class="s0"># a single pass before checking that it has already converged</span>
    <span class="s1">model</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">warm_start</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">n_iter_warm_start </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">n_iter_</span>
    <span class="s2">assert </span><span class="s1">n_iter_warm_start </span><span class="s3">== </span><span class="s6">1</span>


<span class="s2">def </span><span class="s1">test_warm_start_convergence_with_regularizer_decrement</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_diabetes</span><span class="s3">(</span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s0"># Train a model to converge on a lightly regularized problem</span>
    <span class="s1">final_alpha </span><span class="s3">= </span><span class="s6">1e-5</span>
    <span class="s1">low_reg_model </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">final_alpha</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s0"># Fitting a new model on a more regularized version of the same problem.</span>
    <span class="s0"># Fitting with high regularization is easier it should converge faster</span>
    <span class="s0"># in general.</span>
    <span class="s1">high_reg_model </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">final_alpha </span><span class="s3">* </span><span class="s6">10</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">low_reg_model</span><span class="s3">.</span><span class="s1">n_iter_ </span><span class="s3">&gt; </span><span class="s1">high_reg_model</span><span class="s3">.</span><span class="s1">n_iter_</span>

    <span class="s0"># Fit the solution to the original, less regularized version of the</span>
    <span class="s0"># problem but from the solution of the highly regularized variant of</span>
    <span class="s0"># the problem as a better starting point. This should also converge</span>
    <span class="s0"># faster than the original model that starts from zero.</span>
    <span class="s1">warm_low_reg_model </span><span class="s3">= </span><span class="s1">deepcopy</span><span class="s3">(</span><span class="s1">high_reg_model</span><span class="s3">)</span>
    <span class="s1">warm_low_reg_model</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">warm_start</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">final_alpha</span><span class="s3">)</span>
    <span class="s1">warm_low_reg_model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">low_reg_model</span><span class="s3">.</span><span class="s1">n_iter_ </span><span class="s3">&gt; </span><span class="s1">warm_low_reg_model</span><span class="s3">.</span><span class="s1">n_iter_</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_random_descent</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Test that both random and cyclic selection give the same results.</span>
    <span class="s0"># Ensure that the test models fully converge and check a wide</span>
    <span class="s0"># range of conditions.</span>

    <span class="s0"># This uses the coordinate descent algo using the gram trick.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">20</span><span class="s3">)</span>
    <span class="s1">clf_cyclic </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;cyclic&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">)</span>
    <span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">clf_random </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;random&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">clf_random</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>

    <span class="s0"># This uses the descent algo without the gram trick</span>
    <span class="s1">clf_cyclic </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;cyclic&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">)</span>
    <span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:</span><span class="s6">20</span><span class="s3">])</span>
    <span class="s1">clf_random </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;random&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">clf_random</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:</span><span class="s6">20</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>

    <span class="s0"># Sparse Case</span>
    <span class="s1">clf_cyclic </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;cyclic&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">)</span>
    <span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">clf_random </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;random&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">clf_random</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>

    <span class="s0"># Multioutput case.</span>
    <span class="s1">new_y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]))</span>
    <span class="s1">clf_cyclic </span><span class="s3">= </span><span class="s1">MultiTaskElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;cyclic&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">)</span>
    <span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">new_y</span><span class="s3">)</span>
    <span class="s1">clf_random </span><span class="s3">= </span><span class="s1">MultiTaskElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;random&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">clf_random</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">new_y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf_cyclic</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf_random</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_path_positive</span><span class="s3">():</span>
    <span class="s0"># Test positive parameter</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>

    <span class="s0"># For mono output</span>
    <span class="s0"># Test that the coefs returned by positive=True in enet_path are positive</span>
    <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s3">[</span><span class="s1">enet_path</span><span class="s3">, </span><span class="s1">lasso_path</span><span class="s3">]:</span>
        <span class="s1">pos_path_coef </span><span class="s3">= </span><span class="s1">path</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">[:, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">pos_path_coef </span><span class="s3">&gt;= </span><span class="s6">0</span><span class="s3">)</span>

    <span class="s0"># For multi output, positive parameter is not allowed</span>
    <span class="s0"># Test that an error is raised</span>
    <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s3">[</span><span class="s1">enet_path</span><span class="s3">, </span><span class="s1">lasso_path</span><span class="s3">]:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">path</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">positive</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sparse_dense_descent_paths</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Test that dense and sparse input give the same input for descent paths.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">20</span><span class="s3">)</span>
    <span class="s1">csr </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">path </span><span class="s2">in </span><span class="s3">[</span><span class="s1">enet_path</span><span class="s3">, </span><span class="s1">lasso_path</span><span class="s3">]:</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">coefs</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">path</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">sparse_coefs</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">path</span><span class="s3">(</span><span class="s1">csr</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">coefs</span><span class="s3">, </span><span class="s1">sparse_coefs</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;path_func&quot;</span><span class="s3">, [</span><span class="s1">enet_path</span><span class="s3">, </span><span class="s1">lasso_path</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_path_unknown_parameter</span><span class="s3">(</span><span class="s1">path_func</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check that passing parameter not used by the coordinate descent solver 
    will raise an error.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">50</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">20</span><span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s4">&quot;Unexpected parameters in params&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">path_func</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">normalize</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_check_input_false</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">20</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s4">&quot;F&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float64&quot;</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s4">&quot;F&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float64&quot;</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;cyclic&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">)</span>
    <span class="s0"># Check that no error is raised if data is provided in the right format</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">check_input</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s0"># With check_input=False, an exhaustive check is not made on y but its</span>
    <span class="s0"># dtype is still cast in _preprocess_data to X's dtype. So the test should</span>
    <span class="s0"># pass anyway</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s4">&quot;F&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float32&quot;</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">check_input</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s0"># With no input checking, providing X in C order should result in false</span>
    <span class="s0"># computation</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">check_array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s4">&quot;C&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">&quot;float64&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">check_input</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;check_input&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_enet_copy_X_True</span><span class="s3">(</span><span class="s1">check_input</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">order</span><span class="s3">=</span><span class="s4">&quot;F&quot;</span><span class="s3">)</span>

    <span class="s1">original_X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">enet </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">copy_X</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">enet</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">check_input</span><span class="s3">=</span><span class="s1">check_input</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">original_X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_copy_X_False_check_input_False</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">order</span><span class="s3">=</span><span class="s4">&quot;F&quot;</span><span class="s3">)</span>

    <span class="s1">original_X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">enet </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">copy_X</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">enet</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">check_input</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s0"># No copying, X is overwritten</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">not_equal</span><span class="s3">(</span><span class="s1">original_X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_overrided_gram_matrix</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">20</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">Gram </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">selection</span><span class="s3">=</span><span class="s4">&quot;cyclic&quot;</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-8</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">=</span><span class="s1">Gram</span><span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s4">&quot;Gram matrix was provided but X was centered&quot;</span>
        <span class="s4">&quot; to fit intercept: recomputing Gram matrix.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;model&quot;</span><span class="s3">, [</span><span class="s1">ElasticNet</span><span class="s3">, </span><span class="s1">Lasso</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_lasso_non_float_y</span><span class="s3">(</span><span class="s1">model</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [-</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]</span>
    <span class="s1">y_float </span><span class="s3">= [</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">model</span><span class="s3">(</span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">clf_float </span><span class="s3">= </span><span class="s1">model</span><span class="s3">(</span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">clf_float</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y_float</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_float</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_float_precision</span><span class="s3">():</span>
    <span class="s0"># Generate dataset</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">20</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s0"># Here we have a small number of iterations, and thus the</span>
    <span class="s0"># ElasticNet might not converge. This is to speed up tests</span>

    <span class="s2">for </span><span class="s1">fit_intercept </span><span class="s2">in </span><span class="s3">[</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]:</span>
        <span class="s1">coef </span><span class="s3">= {}</span>
        <span class="s1">intercept </span><span class="s3">= {}</span>
        <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">]:</span>
            <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span>
                <span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">,</span>
                <span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
                <span class="s1">precompute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">,</span>
            <span class="s3">)</span>

            <span class="s1">X </span><span class="s3">= </span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">y </span><span class="s3">= </span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

            <span class="s1">coef</span><span class="s3">[(</span><span class="s4">&quot;simple&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)] = </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span>
            <span class="s1">intercept</span><span class="s3">[(</span><span class="s4">&quot;simple&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)] = </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span>

            <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>

            <span class="s0"># test precompute Gram array</span>
            <span class="s1">Gram </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">clf_precompute </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span>
                <span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">,</span>
                <span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
                <span class="s1">precompute</span><span class="s3">=</span><span class="s1">Gram</span><span class="s3">,</span>
                <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf_precompute</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_precompute</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf_precompute</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>

            <span class="s0"># test multi task enet</span>
            <span class="s1">multi_y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]))</span>
            <span class="s1">clf_multioutput </span><span class="s3">= </span><span class="s1">MultiTaskElasticNet</span><span class="s3">(</span>
                <span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">,</span>
                <span class="s1">max_iter</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
                <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">clf_multioutput</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">multi_y</span><span class="s3">)</span>
            <span class="s1">coef</span><span class="s3">[(</span><span class="s4">&quot;multi&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)] = </span><span class="s1">clf_multioutput</span><span class="s3">.</span><span class="s1">coef_</span>
            <span class="s1">intercept</span><span class="s3">[(</span><span class="s4">&quot;multi&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)] = </span><span class="s1">clf_multioutput</span><span class="s3">.</span><span class="s1">intercept_</span>
            <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>

        <span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s3">[</span><span class="s4">&quot;simple&quot;</span><span class="s3">, </span><span class="s4">&quot;multi&quot;</span><span class="s3">]:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                <span class="s1">coef</span><span class="s3">[(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)], </span><span class="s1">coef</span><span class="s3">[(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">4</span>
            <span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                <span class="s1">intercept</span><span class="s3">[(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)], </span><span class="s1">intercept</span><span class="s3">[(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">4</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_enet_l1_ratio</span><span class="s3">():</span>
    <span class="s0"># Test that an error message is raised if an estimator that</span>
    <span class="s0"># uses _alpha_grid is called with l1_ratio=0</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s4">&quot;Automatic alpha grid generation is not supported for l1_ratio=0. &quot;</span>
        <span class="s4">&quot;Please supply a grid by providing your estimator with the &quot;</span>
        <span class="s4">&quot;appropriate `alphas=` argument.&quot;</span>
    <span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">8</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">]]).</span><span class="s1">T</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">12</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">21</span><span class="s3">, </span><span class="s6">5</span><span class="s3">])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">])</span>

    <span class="s0"># Test that l1_ratio=0 with alpha&gt;0 produces user warning</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s4">&quot;Coordinate descent without L1 regularization may &quot;</span>
        <span class="s4">&quot;lead to unexpected results and is discouraged. &quot;</span>
        <span class="s4">&quot;Set l1_ratio &gt; 0 to add L1 regularization.&quot;</span>
    <span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">alphas</span><span class="s3">=[</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s0"># Test that l1_ratio=0 is allowed if we supply a grid manually</span>
    <span class="s1">alphas </span><span class="s3">= [</span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">]</span>
    <span class="s1">estkwds </span><span class="s3">= {</span><span class="s4">&quot;alphas&quot;</span><span class="s3">: </span><span class="s1">alphas</span><span class="s3">, </span><span class="s4">&quot;random_state&quot;</span><span class="s3">: </span><span class="s6">42</span><span class="s3">}</span>
    <span class="s1">est_desired </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.00001</span><span class="s3">, **</span><span class="s1">estkwds</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, **</span><span class="s1">estkwds</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">ignore_warnings</span><span class="s3">():</span>
        <span class="s1">est_desired</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">est</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">est_desired</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">5</span><span class="s3">)</span>

    <span class="s1">est_desired </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.00001</span><span class="s3">, **</span><span class="s1">estkwds</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">(</span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, **</span><span class="s1">estkwds</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">ignore_warnings</span><span class="s3">():</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">])</span>
        <span class="s1">est_desired</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[:, </span><span class="s2">None</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">est</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">est_desired</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">5</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_coef_shape_not_zero</span><span class="s3">():</span>
    <span class="s1">est_no_intercept </span><span class="s3">= </span><span class="s1">Lasso</span><span class="s3">(</span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">est_no_intercept</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s6">3</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">est_no_intercept</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s6">1</span><span class="s3">,)</span>


<span class="s2">def </span><span class="s1">test_warm_start_multitask_lasso</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">MultiTaskLasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">warm_start</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)  </span><span class="s0"># do a second round with 5 iterations</span>

    <span class="s1">clf2 </span><span class="s3">= </span><span class="s1">MultiTaskLasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;klass, n_classes, kwargs&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">Lasso</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)),</span>
        <span class="s3">(</span><span class="s1">Lasso</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">precompute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)),</span>
        <span class="s3">(</span><span class="s1">MultiTaskLasso</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">()),</span>
        <span class="s3">(</span><span class="s1">MultiTaskLasso</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">dict</span><span class="s3">()),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_enet_coordinate_descent</span><span class="s3">(</span><span class="s1">klass</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">, </span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Test that a warning is issued if model does not converge&quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">klass</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s6">5</span>
    <span class="s1">n_features </span><span class="s3">= </span><span class="s6">2</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)) * </span><span class="s6">1e50</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">))</span>
    <span class="s2">if </span><span class="s1">klass </span><span class="s3">== </span><span class="s1">Lasso</span><span class="s3">:</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s4">&quot;Objective did not converge. You might want to&quot;</span>
        <span class="s4">&quot; increase the number of iterations.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">ConvergenceWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_convergence_warnings</span><span class="s3">():</span>
    <span class="s1">random_state </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">1000</span><span class="s3">, </span><span class="s6">500</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">1000</span><span class="s3">, </span><span class="s6">3</span><span class="s3">))</span>

    <span class="s0"># check that the model converges w/o convergence warnings</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s4">&quot;error&quot;</span><span class="s3">, </span><span class="s1">ConvergenceWarning</span><span class="s3">)</span>
        <span class="s1">MultiTaskElasticNet</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sparse_input_convergence_warning</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s6">500</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">ConvergenceWarning</span><span class="s3">):</span>
        <span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">max_iter</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s0"># check that the model converges w/o convergence warnings</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s4">&quot;error&quot;</span><span class="s3">, </span><span class="s1">ConvergenceWarning</span><span class="s3">)</span>
        <span class="s1">Lasso</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">), </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;precompute, inner_precompute&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">&quot;auto&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_lassoCV_does_not_set_precompute</span><span class="s3">(</span><span class="s1">monkeypatch</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">, </span><span class="s1">inner_precompute</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">build_dataset</span><span class="s3">()</span>
    <span class="s1">calls </span><span class="s3">= </span><span class="s6">0</span>

    <span class="s2">class </span><span class="s1">LassoMock</span><span class="s3">(</span><span class="s1">Lasso</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
            <span class="s1">super</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s2">nonlocal </span><span class="s1">calls</span>
            <span class="s1">calls </span><span class="s3">+= </span><span class="s6">1</span>
            <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">precompute </span><span class="s3">== </span><span class="s1">inner_precompute</span>

    <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setattr</span><span class="s3">(</span><span class="s4">&quot;sklearn.linear_model._coordinate_descent.Lasso&quot;</span><span class="s3">, </span><span class="s1">LassoMock</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(</span><span class="s1">precompute</span><span class="s3">=</span><span class="s1">precompute</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">calls </span><span class="s3">&gt; </span><span class="s6">0</span>


<span class="s2">def </span><span class="s1">test_multi_task_lasso_cv_dtype</span><span class="s3">():</span>
    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">10</span><span class="s3">, </span><span class="s6">3</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">binomial</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)  </span><span class="s0"># make it explicit that X is int</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[:, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]].</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">MultiTaskLassoCV</span><span class="s3">(</span><span class="s1">n_alphas</span><span class="s3">=</span><span class="s6">5</span><span class="s3">, </span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">est</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]] * </span><span class="s6">2</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;fit_intercept&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;alpha&quot;</span><span class="s3">, [</span><span class="s6">0.01</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;precompute&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_enet_sample_weight_consistency</span><span class="s3">(</span>
    <span class="s1">fit_intercept</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">, </span><span class="s1">global_random_seed</span>
<span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Test that the impact of sample_weight is consistent. 
 
    Note that this test is stricter than the common test 
    check_sample_weights_invariance alone and also tests sparse X. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s1">global_random_seed</span><span class="s3">)</span>
    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">10</span><span class="s3">, </span><span class="s6">5</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">alpha</span><span class="s3">=</span><span class="s1">alpha</span><span class="s3">,</span>
        <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">,</span>
        <span class="s1">precompute</span><span class="s3">=</span><span class="s1">precompute</span><span class="s3">,</span>
        <span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">,</span>
        <span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.5</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">reg </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">coef </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">intercept </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span>

    <span class="s0"># 1) sample_weight=np.ones(..) should be equivalent to sample_weight=None</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">)</span>

    <span class="s0"># 2) sample_weight=None should be equivalent to sample_weight = number</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s6">123.0</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">)</span>

    <span class="s0"># 3) scaling of sample_weight should have no effect, cf. np.average()</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">low</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">coef </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">intercept </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span>

    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">* </span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">)</span>

    <span class="s0"># 4) setting elements of sample_weight to 0 is equivalent to removing these samples</span>
    <span class="s1">sample_weight_0 </span><span class="s3">= </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">sample_weight_0</span><span class="s3">[-</span><span class="s6">5</span><span class="s3">:] = </span><span class="s6">0</span>
    <span class="s1">y</span><span class="s3">[-</span><span class="s6">5</span><span class="s3">:] *= </span><span class="s6">1000  </span><span class="s0"># to make excluding those samples important</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight_0</span><span class="s3">)</span>
    <span class="s1">coef_0 </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">intercept_0 </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:-</span><span class="s6">5</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[:-</span><span class="s6">5</span><span class="s3">], </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">[:-</span><span class="s6">5</span><span class="s3">])</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef_0</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept_0</span><span class="s3">)</span>

    <span class="s0"># 5) check that multiplying sample_weight by 2 is equivalent to repeating</span>
    <span class="s0"># corresponding samples twice</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">[: </span><span class="s1">n_samples </span><span class="s3">// </span><span class="s6">2</span><span class="s3">]], </span><span class="s1">format</span><span class="s3">=</span><span class="s4">&quot;csc&quot;</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">[: </span><span class="s1">n_samples </span><span class="s3">// </span><span class="s6">2</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">[: </span><span class="s1">n_samples </span><span class="s3">// </span><span class="s6">2</span><span class="s3">]])</span>
    <span class="s1">sample_weight_1 </span><span class="s3">= </span><span class="s1">sample_weight</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">sample_weight_1</span><span class="s3">[: </span><span class="s1">n_samples </span><span class="s3">// </span><span class="s6">2</span><span class="s3">] *= </span><span class="s6">2</span>
    <span class="s1">sample_weight_2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">[: </span><span class="s1">n_samples </span><span class="s3">// </span><span class="s6">2</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span>
    <span class="s3">)</span>

    <span class="s1">reg1 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight_1</span><span class="s3">)</span>
    <span class="s1">reg2 </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight_2</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg1</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">reg2</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;fit_intercept&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_enet_cv_sample_weight_correctness</span><span class="s3">(</span><span class="s1">fit_intercept</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Test that ElasticNetCV with sample weights gives correct results.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">n_splits</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">3</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">5</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_splits </span><span class="s3">* </span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">beta </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">beta</span><span class="s3">[</span><span class="s6">0</span><span class="s3">:</span><span class="s6">2</span><span class="s3">] = </span><span class="s6">0</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">X </span><span class="s3">@ </span><span class="s1">beta </span><span class="s3">+ </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_splits </span><span class="s3">* </span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">sw </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>

    <span class="s0"># Set alphas, otherwise the two cv models might use different ones.</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">alphas </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0.001</span><span class="s3">, </span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s6">91</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">alphas </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0.01</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s6">91</span><span class="s3">)</span>

    <span class="s0"># We weight the first fold 2 times more.</span>
    <span class="s1">sw</span><span class="s3">[:</span><span class="s1">n_samples</span><span class="s3">] = </span><span class="s6">2</span>
    <span class="s1">groups_sw </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
    <span class="s3">]</span>
    <span class="s1">splits_sw </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">LeaveOneGroupOut</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">=</span><span class="s1">groups_sw</span><span class="s3">))</span>
    <span class="s1">reg_sw </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span>
        <span class="s1">alphas</span><span class="s3">=</span><span class="s1">alphas</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">splits_sw</span><span class="s3">, </span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">, **</span><span class="s1">params</span>
    <span class="s3">)</span>
    <span class="s1">reg_sw</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sw</span><span class="s3">)</span>

    <span class="s0"># We repeat the first fold 2 times and provide splits ourselves</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">X</span><span class="s3">[:</span><span class="s1">n_samples</span><span class="s3">], </span><span class="s1">X</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">y</span><span class="s3">[:</span><span class="s1">n_samples</span><span class="s3">], </span><span class="s1">y</span><span class="s3">]</span>
    <span class="s1">groups </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s6">2 </span><span class="s3">* </span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
    <span class="s3">]</span>
    <span class="s1">splits </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">LeaveOneGroupOut</span><span class="s3">().</span><span class="s1">split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">=</span><span class="s1">groups</span><span class="s3">))</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">alphas</span><span class="s3">=</span><span class="s1">alphas</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s1">splits</span><span class="s3">, </span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">)</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s0"># ensure that we chose meaningful alphas, i.e. not boundaries</span>
    <span class="s2">assert </span><span class="s1">alphas</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] &lt; </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">alpha_ </span><span class="s3">&lt; </span><span class="s1">alphas</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">reg_sw</span><span class="s3">.</span><span class="s1">alpha_ </span><span class="s3">== </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">alpha_</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg_sw</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">reg_sw</span><span class="s3">.</span><span class="s1">intercept_ </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;sample_weight&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_enet_cv_grid_search</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Test that ElasticNetCV gives same result as GridSearchCV.&quot;&quot;&quot;</span>
    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">200</span><span class="s3">, </span><span class="s6">10</span>
    <span class="s1">cv </span><span class="s3">= </span><span class="s6">5</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s1">n_features</span><span class="s3">,</span>
        <span class="s1">effective_rank</span><span class="s3">=</span><span class="s6">10</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s1">n_features </span><span class="s3">- </span><span class="s6">4</span><span class="s3">,</span>
        <span class="s1">noise</span><span class="s3">=</span><span class="s6">10</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">sample_weight</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s1">alphas </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s6">1e-5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s6">1</span><span class="s3">), </span><span class="s1">num</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">l1_ratios </span><span class="s3">= [</span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.9</span><span class="s3">]</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">, </span><span class="s1">alphas</span><span class="s3">=</span><span class="s1">alphas</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s1">l1_ratios</span><span class="s3">)</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>

    <span class="s1">param </span><span class="s3">= {</span><span class="s4">&quot;alpha&quot;</span><span class="s3">: </span><span class="s1">alphas</span><span class="s3">, </span><span class="s4">&quot;l1_ratio&quot;</span><span class="s3">: </span><span class="s1">l1_ratios</span><span class="s3">}</span>
    <span class="s1">gs </span><span class="s3">= </span><span class="s1">GridSearchCV</span><span class="s3">(</span>
        <span class="s1">estimator</span><span class="s3">=</span><span class="s1">ElasticNet</span><span class="s3">(),</span>
        <span class="s1">param_grid</span><span class="s3">=</span><span class="s1">param</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s1">cv</span><span class="s3">,</span>
        <span class="s1">scoring</span><span class="s3">=</span><span class="s4">&quot;neg_mean_squared_error&quot;</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">l1_ratio_ </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s1">gs</span><span class="s3">.</span><span class="s1">best_params_</span><span class="s3">[</span><span class="s4">&quot;l1_ratio&quot;</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">alpha_ </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s1">gs</span><span class="s3">.</span><span class="s1">best_params_</span><span class="s3">[</span><span class="s4">&quot;alpha&quot;</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;fit_intercept&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;l1_ratio&quot;</span><span class="s3">, [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;precompute&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_enet_cv_sample_weight_consistency</span><span class="s3">(</span>
    <span class="s1">fit_intercept</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">, </span><span class="s1">precompute</span><span class="s3">, </span><span class="s1">sparse_container</span>
<span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Test that the impact of sample_weight is consistent.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">10</span><span class="s3">, </span><span class="s6">5</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">) + </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">l1_ratio</span><span class="s3">=</span><span class="s1">l1_ratio</span><span class="s3">,</span>
        <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">,</span>
        <span class="s1">precompute</span><span class="s3">=</span><span class="s1">precompute</span><span class="s3">,</span>
        <span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">,</span>
        <span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">l1_ratio </span><span class="s3">== </span><span class="s6">0</span><span class="s3">:</span>
        <span class="s1">params</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;l1_ratio&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">reg </span><span class="s3">= </span><span class="s1">LassoCV</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">reg </span><span class="s3">= </span><span class="s1">ElasticNetCV</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">coef </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">intercept </span><span class="s3">= </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span>

    <span class="s0"># sample_weight=np.ones(..) should be equivalent to sample_weight=None</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">)</span>

    <span class="s0"># sample_weight=None should be equivalent to sample_weight = number</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s6">123.0</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">)</span>

    <span class="s0"># scaling of sample_weight should have no effect, cf. np.average()</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">coef</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">fit_intercept</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">intercept</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;estimator&quot;</span><span class="s3">, [</span><span class="s1">ElasticNetCV</span><span class="s3">, </span><span class="s1">LassoCV</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_linear_models_cv_fit_with_loky</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">):</span>
    <span class="s0"># LinearModelsCV.fit performs inplace operations on fancy-indexed memmapped</span>
    <span class="s0"># data when using the loky backend, causing an error due to unexpected</span>
    <span class="s0"># behavior of fancy indexing of read-only memmaps (cf. numpy#14132).</span>

    <span class="s0"># Create a problem sufficiently large to cause memmapping (1MB).</span>
    <span class="s0"># Unfortunately the scikit-learn and joblib APIs do not make it possible to</span>
    <span class="s0"># change the max_nbyte of the inner Parallel call.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s6">1e6</span><span class="s3">) // </span><span class="s6">8 </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X</span><span class="s3">.</span><span class="s1">nbytes </span><span class="s3">&gt; </span><span class="s6">1e6  </span><span class="s0"># 1 MB</span>
    <span class="s2">with </span><span class="s1">joblib</span><span class="s3">.</span><span class="s1">parallel_backend</span><span class="s3">(</span><span class="s4">&quot;loky&quot;</span><span class="s3">):</span>
        <span class="s1">estimator</span><span class="s3">(</span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s6">3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;check_input&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_enet_sample_weight_does_not_overwrite_sample_weight</span><span class="s3">(</span><span class="s1">check_input</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check that ElasticNet does not overwrite sample_weights.&quot;&quot;&quot;</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s3">= </span><span class="s6">10</span><span class="s3">, </span><span class="s6">5</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>

    <span class="s1">sample_weight_1_25 </span><span class="s3">= </span><span class="s6">1.25 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">sample_weight_1_25</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

    <span class="s1">reg </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">()</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">check_input</span><span class="s3">=</span><span class="s1">check_input</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">sample_weight_1_25</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;ridge_alpha&quot;</span><span class="s3">, [</span><span class="s6">1e-1</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">1e6</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_enet_ridge_consistency</span><span class="s3">(</span><span class="s1">ridge_alpha</span><span class="s3">):</span>
    <span class="s0"># Check that ElasticNet(l1_ratio=0) converges to the same solution as Ridge</span>
    <span class="s0"># provided that the value of alpha is adapted.</span>
    <span class="s0">#</span>
    <span class="s0"># XXX: this test does not pass for weaker regularization (lower values of</span>
    <span class="s0"># ridge_alpha): it could be either a problem of ElasticNet or Ridge (less</span>
    <span class="s0"># likely) and depends on the dataset statistics: lower values for</span>
    <span class="s0"># effective_rank are more problematic in particular.</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s6">300</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s1">effective_rank</span><span class="s3">=</span><span class="s6">10</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s6">50</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">sw </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">low</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s6">10</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">alpha </span><span class="s3">= </span><span class="s6">1.0</span>
    <span class="s1">common_params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">ridge </span><span class="s3">= </span><span class="s1">Ridge</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">alpha</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sw</span><span class="s3">)</span>

    <span class="s1">alpha_enet </span><span class="s3">= </span><span class="s1">alpha </span><span class="s3">/ </span><span class="s1">sw</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
    <span class="s1">enet </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s1">alpha_enet</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, **</span><span class="s1">common_params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sw</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ridge</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">enet</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ridge</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">enet</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;estimator&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">Lasso</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">),</span>
        <span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">, </span><span class="s1">l1_ratio</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sample_weight_invariance</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s6">100</span><span class="s3">,</span>
        <span class="s1">n_features</span><span class="s3">=</span><span class="s6">300</span><span class="s3">,</span>
        <span class="s1">effective_rank</span><span class="s3">=</span><span class="s6">10</span><span class="s3">,</span>
        <span class="s1">n_informative</span><span class="s3">=</span><span class="s6">50</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">sw </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">low</span><span class="s3">=</span><span class="s6">0.01</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">tol</span><span class="s3">=</span><span class="s6">1e-12</span><span class="s3">)</span>

    <span class="s0"># Check that setting some weights to 0 is equivalent to trimming the</span>
    <span class="s0"># samples:</span>
    <span class="s1">cutoff </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] // </span><span class="s6">3</span>
    <span class="s1">sw_with_null </span><span class="s3">= </span><span class="s1">sw</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">sw_with_null</span><span class="s3">[:</span><span class="s1">cutoff</span><span class="s3">] = </span><span class="s6">0.0</span>
    <span class="s1">X_trimmed</span><span class="s3">, </span><span class="s1">y_trimmed </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[</span><span class="s1">cutoff</span><span class="s3">:, :], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">cutoff</span><span class="s3">:]</span>
    <span class="s1">sw_trimmed </span><span class="s3">= </span><span class="s1">sw</span><span class="s3">[</span><span class="s1">cutoff</span><span class="s3">:]</span>

    <span class="s1">reg_trimmed </span><span class="s3">= (</span>
        <span class="s1">clone</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">)</span>
        <span class="s3">.</span><span class="s1">set_params</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">)</span>
        <span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_trimmed</span><span class="s3">, </span><span class="s1">y_trimmed</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sw_trimmed</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">reg_null_weighted </span><span class="s3">= (</span>
        <span class="s1">clone</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">).</span><span class="s1">set_params</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sw_with_null</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg_null_weighted</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">reg_trimmed</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg_null_weighted</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">reg_trimmed</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>

    <span class="s0"># Check that duplicating the training dataset is equivalent to multiplying</span>
    <span class="s0"># the weights by 2:</span>
    <span class="s1">X_dup </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">y_dup </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">sw_dup </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">sw</span><span class="s3">, </span><span class="s1">sw</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">)</span>

    <span class="s1">reg_2sw </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">).</span><span class="s1">set_params</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s6">2 </span><span class="s3">* </span><span class="s1">sw</span><span class="s3">)</span>
    <span class="s1">reg_dup </span><span class="s3">= (</span>
        <span class="s1">clone</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">).</span><span class="s1">set_params</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_dup</span><span class="s3">, </span><span class="s1">y_dup</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sw_dup</span><span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg_2sw</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">reg_dup</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">reg_2sw</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">reg_dup</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_read_only_buffer</span><span class="s3">():</span>
    <span class="s5">&quot;&quot;&quot;Test that sparse coordinate descent works for read-only buffers&quot;&quot;&quot;</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">ElasticNet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">=</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">copy_X</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asfortranarray</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s6">100</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)))</span>
    <span class="s1">X</span><span class="s3">.</span><span class="s1">setflags</span><span class="s3">(</span><span class="s1">write</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">100</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;EstimatorCV&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s1">ElasticNetCV</span><span class="s3">, </span><span class="s1">LassoCV</span><span class="s3">, </span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">, </span><span class="s1">MultiTaskLassoCV</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_cv_estimators_reject_params_with_no_routing_enabled</span><span class="s3">(</span><span class="s1">EstimatorCV</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check that the models inheriting from class:`LinearModelCV` raise an 
    error when any `params` are passed when routing is not enabled. 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">)</span>
    <span class="s1">groups </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">] * (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">) // </span><span class="s6">2</span><span class="s3">))</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">EstimatorCV</span><span class="s3">()</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;is only supported if enable_metadata_routing=True&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">=</span><span class="s1">groups</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;MultiTaskEstimatorCV&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s1">MultiTaskElasticNetCV</span><span class="s3">, </span><span class="s1">MultiTaskLassoCV</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_multitask_cv_estimators_with_sample_weight</span><span class="s3">(</span><span class="s1">MultiTaskEstimatorCV</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot;Check that for :class:`MultiTaskElasticNetCV` and 
    class:`MultiTaskLassoCV` if `sample_weight` is passed and the 
    CV splitter does not support `sample_weight` an error is raised. 
    On the other hand if the splitter does support `sample_weight` 
    while `sample_weight` is passed there is no error and process 
    completes smoothly as before. 
    &quot;&quot;&quot;</span>

    <span class="s2">class </span><span class="s1">CVSplitter</span><span class="s3">(</span><span class="s1">GroupsConsumerMixin</span><span class="s3">, </span><span class="s1">BaseCrossValidator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">get_n_splits</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">pass  </span><span class="s0"># pragma: nocover</span>

    <span class="s2">class </span><span class="s1">CVSplitterSampleWeight</span><span class="s3">(</span><span class="s1">CVSplitter</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">split</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">groups</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">split_index </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) // </span><span class="s6">2</span>
            <span class="s1">train_indices </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">split_index</span><span class="s3">))</span>
            <span class="s1">test_indices </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">split_index</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)))</span>
            <span class="s2">yield </span><span class="s1">test_indices</span><span class="s3">, </span><span class="s1">train_indices</span>
            <span class="s2">yield </span><span class="s1">train_indices</span><span class="s3">, </span><span class="s1">test_indices</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_regression</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s6">42</span><span class="s3">, </span><span class="s1">n_targets</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>

    <span class="s0"># If CV splitter does not support sample_weight an error is raised</span>
    <span class="s1">splitter </span><span class="s3">= </span><span class="s1">CVSplitter</span><span class="s3">().</span><span class="s1">set_split_request</span><span class="s3">(</span><span class="s1">groups</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MultiTaskEstimatorCV</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">=</span><span class="s1">splitter</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;do not support sample weights&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>

    <span class="s0"># If CV splitter does support sample_weight no error is raised</span>
    <span class="s1">splitter </span><span class="s3">= </span><span class="s1">CVSplitterSampleWeight</span><span class="s3">().</span><span class="s1">set_split_request</span><span class="s3">(</span>
        <span class="s1">groups</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span>
    <span class="s3">)</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">MultiTaskEstimatorCV</span><span class="s3">(</span><span class="s1">cv</span><span class="s3">=</span><span class="s1">splitter</span><span class="s3">)</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
</pre>
</body>
</html>