<html>
<head>
<title>test_cdflib.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_cdflib.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Test cdflib functions versus mpmath, if available. 
 
The following functions still need tests: 
 
- ncfdtr 
- ncfdtri 
- ncfdtridfn 
- ncfdtridfd 
- ncfdtrinc 
- nbdtrik 
- nbdtrin 
- pdtrik 
- nctdtr 
- nctdtrit 
- nctdtridf 
- nctdtrinc 
 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">itertools</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special </span><span class="s2">as </span><span class="s1">sp</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special</span><span class="s3">.</span><span class="s1">_testutils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">MissingModule</span><span class="s3">, </span><span class="s1">check_version</span><span class="s3">, </span><span class="s1">FuncData</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special</span><span class="s3">.</span><span class="s1">_mptestutils </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">Arg</span><span class="s3">, </span><span class="s1">IntArg</span><span class="s3">, </span><span class="s1">get_args</span><span class="s3">, </span><span class="s1">mpf2float</span><span class="s3">, </span><span class="s1">assert_mpmath_equal</span><span class="s3">)</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">mpmath</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">mpmath </span><span class="s3">= </span><span class="s1">MissingModule</span><span class="s3">(</span><span class="s4">'mpmath'</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">ProbArg</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Generate a set of probabilities on [0, 1].&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Include the endpoints for compatibility with Arg et. al.</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s6">1</span>

    <span class="s2">def </span><span class="s1">values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Return an array containing approximately n numbers.&quot;&quot;&quot;</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">//</span><span class="s6">3</span><span class="s3">)</span>
        <span class="s1">v1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(-</span><span class="s6">30</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s6">0.3</span><span class="s3">), </span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">v2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s6">0.3</span><span class="s3">, </span><span class="s6">0.7</span><span class="s3">, </span><span class="s1">m </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">endpoint</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)[</span><span class="s6">1</span><span class="s3">:]</span>
        <span class="s1">v3 </span><span class="s3">= </span><span class="s6">1 </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logspace</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s6">0.3</span><span class="s3">), -</span><span class="s6">15</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">v1</span><span class="s3">, </span><span class="s1">v2</span><span class="s3">, </span><span class="s1">v3</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">EndpointFilter</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s1">a</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">b</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rtol </span><span class="s3">= </span><span class="s1">rtol</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">atol </span><span class="s3">= </span><span class="s1">atol</span>

    <span class="s2">def </span><span class="s1">__call__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
        <span class="s1">mask1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">x </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">a</span><span class="s3">) &lt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rtol</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">a</span><span class="s3">) + </span><span class="s1">self</span><span class="s3">.</span><span class="s1">atol</span>
        <span class="s1">mask2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">x </span><span class="s3">- </span><span class="s1">self</span><span class="s3">.</span><span class="s1">b</span><span class="s3">) &lt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rtol</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">b</span><span class="s3">) + </span><span class="s1">self</span><span class="s3">.</span><span class="s1">atol</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">where</span><span class="s3">(</span><span class="s1">mask1 </span><span class="s3">| </span><span class="s1">mask2</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">_CDFData</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">spfunc</span><span class="s3">, </span><span class="s1">mpfunc</span><span class="s3">, </span><span class="s1">index</span><span class="s3">, </span><span class="s1">argspec</span><span class="s3">, </span><span class="s1">spfunc_first</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                 <span class="s1">dps</span><span class="s3">=</span><span class="s6">20</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s6">5000</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                 <span class="s1">endpt_rtol</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">endpt_atol</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">spfunc </span><span class="s3">= </span><span class="s1">spfunc</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mpfunc </span><span class="s3">= </span><span class="s1">mpfunc</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">index</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">argspec </span><span class="s3">= </span><span class="s1">argspec</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">spfunc_first </span><span class="s3">= </span><span class="s1">spfunc_first</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dps </span><span class="s3">= </span><span class="s1">dps</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">n </span><span class="s3">= </span><span class="s1">n</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rtol </span><span class="s3">= </span><span class="s1">rtol</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">atol </span><span class="s3">= </span><span class="s1">atol</span>

        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">argspec</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_rtol </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_atol </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">elif </span><span class="s1">endpt_rtol </span><span class="s2">is not None or </span><span class="s1">endpt_atol </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">endpt_rtol</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_rtol </span><span class="s3">= </span><span class="s1">endpt_rtol</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_rtol </span><span class="s3">= [</span><span class="s1">endpt_rtol</span><span class="s3">]*</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">argspec</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">endpt_atol</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_atol </span><span class="s3">= </span><span class="s1">endpt_atol</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_atol </span><span class="s3">= [</span><span class="s1">endpt_atol</span><span class="s3">]*</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">argspec</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_rtol </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_atol </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">idmap</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">spfunc_first</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">spfunc</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s1">args</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">] = </span><span class="s1">res</span>
            <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dps</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mpfunc</span><span class="s3">(*</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">args</span><span class="s3">))</span>
                <span class="s5"># Imaginary parts are spurious</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">mpf2float</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dps</span><span class="s3">):</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mpfunc</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>
                <span class="s1">res </span><span class="s3">= </span><span class="s1">mpf2float</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">args</span><span class="s3">)</span>
            <span class="s1">args</span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">] = </span><span class="s1">res</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">spfunc</span><span class="s3">(*</span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">args</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">res</span>

    <span class="s2">def </span><span class="s1">get_param_filter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_rtol </span><span class="s2">is None and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_atol </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">return None</span>

        <span class="s1">filters </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">rtol</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">, </span><span class="s1">spec </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_rtol</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">endpt_atol</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">argspec</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">rtol </span><span class="s2">is None and </span><span class="s1">atol </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">filters</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
                <span class="s2">continue</span>
            <span class="s2">elif </span><span class="s1">rtol </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">rtol </span><span class="s3">= </span><span class="s6">0.0</span>
            <span class="s2">elif </span><span class="s1">atol </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">atol </span><span class="s3">= </span><span class="s6">0.0</span>

            <span class="s1">filters</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">EndpointFilter</span><span class="s3">(</span><span class="s1">spec</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">spec</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">filters</span>

    <span class="s2">def </span><span class="s1">check</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Generate values for the arguments</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">get_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">argspec</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">param_filter </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_param_filter</span><span class="s3">()</span>
        <span class="s1">param_columns </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">args</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">result_columns </span><span class="s3">= </span><span class="s1">args</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">((</span><span class="s1">args</span><span class="s3">, </span><span class="s1">args</span><span class="s3">[:, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">index</span><span class="s3">].</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">args</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s6">1</span><span class="s3">)))</span>
        <span class="s1">FuncData</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">idmap</span><span class="s3">, </span><span class="s1">args</span><span class="s3">,</span>
                 <span class="s1">param_columns</span><span class="s3">=</span><span class="s1">param_columns</span><span class="s3">, </span><span class="s1">result_columns</span><span class="s3">=</span><span class="s1">result_columns</span><span class="s3">,</span>
                 <span class="s1">rtol</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">rtol</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">vectorized</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                 <span class="s1">param_filter</span><span class="s3">=</span><span class="s1">param_filter</span><span class="s3">).</span><span class="s1">check</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_assert_inverts</span><span class="s3">(*</span><span class="s1">a</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">):</span>
    <span class="s1">d </span><span class="s3">= </span><span class="s1">_CDFData</span><span class="s3">(*</span><span class="s1">a</span><span class="s3">, **</span><span class="s1">kw</span><span class="s3">)</span>
    <span class="s1">d</span><span class="s3">.</span><span class="s1">check</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_binomial_cdf</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
    <span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">k</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">k </span><span class="s3">&lt;= </span><span class="s6">0</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">k </span><span class="s3">&gt;= </span><span class="s1">n</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s1">onemp </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">fsub</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">exact</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">(</span><span class="s1">n </span><span class="s3">- </span><span class="s1">k</span><span class="s3">, </span><span class="s1">k </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">=</span><span class="s1">onemp</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_f_cdf</span><span class="s3">(</span><span class="s1">dfn</span><span class="s3">, </span><span class="s1">dfd</span><span class="s3">, </span><span class="s1">x</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">x </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">0</span><span class="s3">)</span>
    <span class="s1">dfn</span><span class="s3">, </span><span class="s1">dfd</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">dfn</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">dfd</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">ub </span><span class="s3">= </span><span class="s1">dfn</span><span class="s3">*</span><span class="s1">x</span><span class="s3">/(</span><span class="s1">dfn</span><span class="s3">*</span><span class="s1">x </span><span class="s3">+ </span><span class="s1">dfd</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">(</span><span class="s1">dfn</span><span class="s3">/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">dfd</span><span class="s3">/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">=</span><span class="s1">ub</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">res</span>


<span class="s2">def </span><span class="s1">_student_t_cdf</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">t</span><span class="s3">, </span><span class="s1">dps</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">dps </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">dps </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span>
    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s1">dps</span><span class="s3">):</span>
        <span class="s1">df</span><span class="s3">, </span><span class="s1">t </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">df</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>
        <span class="s1">fac </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">hyp2f1</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">*(</span><span class="s1">df </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">), </span><span class="s6">1.5</span><span class="s3">, -</span><span class="s1">t</span><span class="s3">**</span><span class="s6">2</span><span class="s3">/</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">fac </span><span class="s3">*= </span><span class="s1">t</span><span class="s3">*</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">*(</span><span class="s1">df </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">))</span>
        <span class="s1">fac </span><span class="s3">/= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">*</span><span class="s1">df</span><span class="s3">)*</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">*</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s6">0.5 </span><span class="s3">+ </span><span class="s1">fac</span>


<span class="s2">def </span><span class="s1">_noncentral_chi_pdf</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">nc</span><span class="s3">):</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">besseli</span><span class="s3">(</span><span class="s1">df</span><span class="s3">/</span><span class="s6">2 </span><span class="s3">- </span><span class="s6">1</span><span class="s3">, </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">nc</span><span class="s3">*</span><span class="s1">t</span><span class="s3">))</span>
    <span class="s1">res </span><span class="s3">*= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-(</span><span class="s1">t </span><span class="s3">+ </span><span class="s1">nc</span><span class="s3">)/</span><span class="s6">2</span><span class="s3">)*(</span><span class="s1">t</span><span class="s3">/</span><span class="s1">nc</span><span class="s3">)**(</span><span class="s1">df</span><span class="s3">/</span><span class="s6">4 </span><span class="s3">- </span><span class="s6">1</span><span class="s3">/</span><span class="s6">2</span><span class="s3">)/</span><span class="s6">2</span>
    <span class="s2">return </span><span class="s1">res</span>


<span class="s2">def </span><span class="s1">_noncentral_chi_cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">nc</span><span class="s3">, </span><span class="s1">dps</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">dps </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">dps </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mp</span><span class="s3">.</span><span class="s1">dps</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">nc </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">df</span><span class="s3">), </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s1">nc</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">workdps</span><span class="s3">(</span><span class="s1">dps</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">quad</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">t</span><span class="s3">: </span><span class="s1">_noncentral_chi_pdf</span><span class="s3">(</span><span class="s1">t</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">nc</span><span class="s3">), [</span><span class="s6">0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">])</span>
        <span class="s2">return </span><span class="s1">res</span>


<span class="s2">def </span><span class="s1">_tukey_lmbda_quantile</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
    <span class="s5"># For lmbda != 0</span>
    <span class="s2">return </span><span class="s3">(</span><span class="s1">p</span><span class="s3">**</span><span class="s1">lmbda </span><span class="s3">- (</span><span class="s6">1 </span><span class="s3">- </span><span class="s1">p</span><span class="s3">)**</span><span class="s1">lmbda</span><span class="s3">)/</span><span class="s1">lmbda</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">check_version</span><span class="s3">(</span><span class="s1">mpmath</span><span class="s3">, </span><span class="s4">'0.19'</span><span class="s3">)</span>
<span class="s2">class </span><span class="s1">TestCDFlib</span><span class="s3">:</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_bdtrik</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">bdtrik</span><span class="s3">,</span>
            <span class="s1">_binomial_cdf</span><span class="s3">,</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1000</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bdtrin</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">bdtrin</span><span class="s3">,</span>
            <span class="s1">_binomial_cdf</span><span class="s3">,</span>
            <span class="s6">1</span><span class="s3">, [</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1000</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">ProbArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-4</span><span class="s3">, </span><span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s6">1e-6</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_btdtria</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">btdtria</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e2</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
                <span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">inclusive_b</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_btdtrib</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Use small values of a or mpmath doesn't converge</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">btdtrib</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">betainc</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">=</span><span class="s1">x</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s6">1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e2</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">(),</span>
             <span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">inclusive_b</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">,</span>
            <span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s2">None</span><span class="s3">, </span><span class="s6">1e-18</span><span class="s3">, </span><span class="s6">1e-15</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_fdtridfd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">fdtridfd</span><span class="s3">,</span>
            <span class="s1">_f_cdf</span><span class="s3">,</span>
            <span class="s6">1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gdtria</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">gdtria</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s6">0</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
             <span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e4</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">,</span>
            <span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s2">None</span><span class="s3">, </span><span class="s6">1e-7</span><span class="s3">, </span><span class="s6">1e-10</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_gdtrib</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Use small values of a and x or mpmath doesn't converge</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">gdtrib</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s6">1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e2</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">(),</span>
             <span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gdtrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">gdtrix</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">a</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s6">2</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1e3</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
             <span class="s1">ProbArg</span><span class="s3">()],</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">,</span>
            <span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s2">None</span><span class="s3">, </span><span class="s6">1e-7</span><span class="s3">, </span><span class="s6">1e-10</span><span class="s3">])</span>

    <span class="s5"># Overall nrdtrimn and nrdtrisd are not performing well with infeasible/edge</span>
    <span class="s5"># combinations of sigma and x, hence restricted the domains to still use the</span>
    <span class="s5"># testing machinery, also see gh-20069</span>

    <span class="s5"># nrdtrimn signature: p, sd, x</span>
    <span class="s5"># nrdtrisd signature: mn, p, x</span>
    <span class="s2">def </span><span class="s1">test_nrdtrimn</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">nrdtrimn</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ncdf</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">),</span>
            <span class="s6">0</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">ProbArg</span><span class="s3">(),  </span><span class="s5"># CDF value p</span>
             <span class="s1">Arg</span><span class="s3">(</span><span class="s6">0.1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">inclusive_b</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),  </span><span class="s5"># sigma</span>
             <span class="s1">Arg</span><span class="s3">(-</span><span class="s6">1e10</span><span class="s3">, </span><span class="s6">1e10</span><span class="s3">)],  </span><span class="s5"># x</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_nrdtrisd</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">nrdtrisd</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">ncdf</span><span class="s3">(</span><span class="s1">z</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">),</span>
            <span class="s6">1</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">inclusive_b</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),  </span><span class="s5"># mn</span>
             <span class="s1">ProbArg</span><span class="s3">(),  </span><span class="s5"># CDF value p</span>
             <span class="s1">Arg</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">1e100</span><span class="s3">)],  </span><span class="s5"># x</span>
            <span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_stdtr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Ideally the left endpoint for Arg() should be 0.</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">stdtr</span><span class="s3">,</span>
            <span class="s1">_student_t_cdf</span><span class="s3">,</span>
            <span class="s3">[</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">1e-10</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_stdtridf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">stdtridf</span><span class="s3">,</span>
            <span class="s1">_student_t_cdf</span><span class="s3">,</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_stdtrit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">stdtrit</span><span class="s3">,</span>
            <span class="s1">_student_t_cdf</span><span class="s3">,</span>
            <span class="s6">1</span><span class="s3">, [</span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">()], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">,</span>
            <span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s2">None</span><span class="s3">, </span><span class="s6">1e-10</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_chdtriv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">chdtriv</span><span class="s3">,</span>
            <span class="s2">lambda </span><span class="s1">v</span><span class="s3">, </span><span class="s1">x</span><span class="s3">: </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">gammainc</span><span class="s3">(</span><span class="s1">v</span><span class="s3">/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">x</span><span class="s3">/</span><span class="s6">2</span><span class="s3">, </span><span class="s1">regularized</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">100</span><span class="s3">)], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-4</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_chndtridf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Use a larger atol since mpmath is doing numerical integration</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">chndtridf</span><span class="s3">,</span>
            <span class="s1">_noncentral_chi_cdf</span><span class="s3">,</span>
            <span class="s6">1</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">(),</span>
                <span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-4</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_chndtrinc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Use a larger atol since mpmath is doing numerical integration</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">chndtrinc</span><span class="s3">,</span>
            <span class="s1">_noncentral_chi_cdf</span><span class="s3">,</span>
            <span class="s6">2</span><span class="s3">, [</span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">ProbArg</span><span class="s3">()],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-4</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_chndtrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># Use a larger atol since mpmath is doing numerical integration</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">chndtrix</span><span class="s3">,</span>
            <span class="s1">_noncentral_chi_cdf</span><span class="s3">,</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">IntArg</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">100</span><span class="s3">), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">n</span><span class="s3">=</span><span class="s6">1000</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-4</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">,</span>
            <span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s6">1e-6</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_tklmbda_zero_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s5"># When lmbda = 0 the CDF has a simple closed form</span>
        <span class="s1">one </span><span class="s3">= </span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">mpf</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">assert_mpmath_equal</span><span class="s3">(</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">tklmbda</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
            <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">one</span><span class="s3">/(</span><span class="s1">mpmath</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">) + </span><span class="s1">one</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s1">Arg</span><span class="s3">()], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_tklmbda_neg_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">tklmbda</span><span class="s3">,</span>
            <span class="s1">_tukey_lmbda_quantile</span><span class="s3">,</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(-</span><span class="s6">25</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s1">inclusive_b</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">spfunc_first</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">,</span>
            <span class="s1">endpt_atol</span><span class="s3">=[</span><span class="s6">1e-9</span><span class="s3">, </span><span class="s6">1e-5</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">run</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_tklmbda_pos_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">_assert_inverts</span><span class="s3">(</span>
            <span class="s1">sp</span><span class="s3">.</span><span class="s1">tklmbda</span><span class="s3">,</span>
            <span class="s1">_tukey_lmbda_quantile</span><span class="s3">,</span>
            <span class="s6">0</span><span class="s3">, [</span><span class="s1">ProbArg</span><span class="s3">(), </span><span class="s1">Arg</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">100</span><span class="s3">, </span><span class="s1">inclusive_a</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)],</span>
            <span class="s1">spfunc_first</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)</span>

    <span class="s5"># The values of lmdba are chosen so that 1/lmbda is exact.</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'lmbda'</span><span class="s3">, [</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">8.0</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_tklmbda_lmbda1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
        <span class="s1">bound </span><span class="s3">= </span><span class="s6">1</span><span class="s3">/</span><span class="s1">lmbda</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">tklmbda</span><span class="s3">([-</span><span class="s1">bound</span><span class="s3">, </span><span class="s1">bound</span><span class="s3">], </span><span class="s1">lmbda</span><span class="s3">), [</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">])</span>


<span class="s1">funcs </span><span class="s3">= [</span>
    <span class="s3">(</span><span class="s4">&quot;btdtria&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;btdtrib&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;bdtrik&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;bdtrin&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;chdtriv&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;chndtr&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;chndtrix&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;chndtridf&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;chndtrinc&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;fdtridfd&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;ncfdtr&quot;</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;ncfdtri&quot;</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;ncfdtridfn&quot;</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;ncfdtridfd&quot;</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;ncfdtrinc&quot;</span><span class="s3">, </span><span class="s6">4</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;gdtrix&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;gdtrib&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;gdtria&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nbdtrik&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nbdtrin&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nrdtrimn&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nrdtrisd&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;pdtrik&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;stdtr&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;stdtrit&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;stdtridf&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nctdtr&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nctdtrit&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nctdtridf&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;nctdtrinc&quot;</span><span class="s3">, </span><span class="s6">3</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s4">&quot;tklmbda&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">),</span>
<span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'func,numargs'</span><span class="s3">, </span><span class="s1">funcs</span><span class="s3">, </span><span class="s1">ids</span><span class="s3">=[</span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">funcs</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_nonfinite</span><span class="s3">(</span><span class="s1">func</span><span class="s3">, </span><span class="s1">numargs</span><span class="s3">):</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">1701299355559735</span><span class="s3">)</span>
    <span class="s1">func </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">, </span><span class="s1">func</span><span class="s3">)</span>
    <span class="s1">args_choices </span><span class="s3">= [(</span><span class="s1">float</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">numargs</span><span class="s3">)]</span>

    <span class="s2">for </span><span class="s1">args </span><span class="s2">in </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">(*</span><span class="s1">args_choices</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">args</span><span class="s3">):</span>
            <span class="s5"># Nan inputs should result to nan output</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s5"># All other inputs should return something (but not</span>
            <span class="s5"># raise exceptions or cause hangs)</span>
            <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">test_chndtrix_gh2158</span><span class="s3">():</span>
    <span class="s5"># test that gh-2158 is resolved; previously this blew up</span>
    <span class="s1">res </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">chndtrix</span><span class="s3">(</span><span class="s6">0.999999</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">20.</span><span class="s3">)+</span><span class="s6">1e-6</span><span class="s3">)</span>

    <span class="s5"># Generated in R</span>
    <span class="s5"># options(digits=16)</span>
    <span class="s5"># ncp &lt;- seq(0, 19) + 1e-6</span>
    <span class="s5"># print(qchisq(0.999999, df = 2, ncp = ncp))</span>
    <span class="s1">res_exp </span><span class="s3">= [</span><span class="s6">27.63103493142305</span><span class="s3">, </span><span class="s6">35.25728589950540</span><span class="s3">, </span><span class="s6">39.97396073236288</span><span class="s3">,</span>
               <span class="s6">43.88033702110538</span><span class="s3">, </span><span class="s6">47.35206403482798</span><span class="s3">, </span><span class="s6">50.54112500166103</span><span class="s3">,</span>
               <span class="s6">53.52720257322766</span><span class="s3">, </span><span class="s6">56.35830042867810</span><span class="s3">, </span><span class="s6">59.06600769498512</span><span class="s3">,</span>
               <span class="s6">61.67243118946381</span><span class="s3">, </span><span class="s6">64.19376191277179</span><span class="s3">, </span><span class="s6">66.64228141346548</span><span class="s3">,</span>
               <span class="s6">69.02756927200180</span><span class="s3">, </span><span class="s6">71.35726934749408</span><span class="s3">, </span><span class="s6">73.63759723904816</span><span class="s3">,</span>
               <span class="s6">75.87368842650227</span><span class="s3">, </span><span class="s6">78.06984431185720</span><span class="s3">, </span><span class="s6">80.22971052389806</span><span class="s3">,</span>
               <span class="s6">82.35640899964173</span><span class="s3">, </span><span class="s6">84.45263768373256</span><span class="s3">]</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">res_exp</span><span class="s3">)</span>

<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail_on_32bit</span><span class="s3">(</span><span class="s4">&quot;32bit fails due to algorithm threshold&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_nctdtr_gh19896</span><span class="s3">():</span>
    <span class="s5"># test that gh-19896 is resolved.</span>
    <span class="s5"># Compared to SciPy 1.11 results from Fortran code.</span>
    <span class="s1">dfarr </span><span class="s3">= [</span><span class="s6">0.98</span><span class="s3">, </span><span class="s6">9.8</span><span class="s3">, </span><span class="s6">98</span><span class="s3">, </span><span class="s6">980</span><span class="s3">]</span>
    <span class="s1">pnoncarr </span><span class="s3">= [-</span><span class="s6">3.8</span><span class="s3">, </span><span class="s6">0.38</span><span class="s3">, </span><span class="s6">3.8</span><span class="s3">, </span><span class="s6">38</span><span class="s3">]</span>
    <span class="s1">tarr </span><span class="s3">= [</span><span class="s6">0.0015</span><span class="s3">, </span><span class="s6">0.15</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">15</span><span class="s3">]</span>
    <span class="s1">resarr </span><span class="s3">= [</span><span class="s6">0.9999276519560749</span><span class="s3">, </span><span class="s6">0.9999276519560749</span><span class="s3">, </span><span class="s6">0.9999908831755221</span><span class="s3">,</span>
              <span class="s6">0.9999990265452424</span><span class="s3">, </span><span class="s6">0.3524153312279712</span><span class="s3">, </span><span class="s6">0.39749697267251416</span><span class="s3">,</span>
              <span class="s6">0.7168629634895805</span><span class="s3">, </span><span class="s6">0.9656246449259646</span><span class="s3">, </span><span class="s6">7.234804392512006e-05</span><span class="s3">,</span>
              <span class="s6">7.234804392512006e-05</span><span class="s3">, </span><span class="s6">0.03538804607509127</span><span class="s3">, </span><span class="s6">0.795482701508521</span><span class="s3">,</span>
              <span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">,</span>
              <span class="s6">0.011927908523093889</span><span class="s3">, </span><span class="s6">0.9999276519560749</span><span class="s3">, </span><span class="s6">0.9999276519560749</span><span class="s3">,</span>
              <span class="s6">0.9999997441133123</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.3525155979118013</span><span class="s3">,</span>
              <span class="s6">0.4076312014048369</span><span class="s3">, </span><span class="s6">0.8476794017035086</span><span class="s3">, </span><span class="s6">0.9999999297116268</span><span class="s3">,</span>
              <span class="s6">7.234804392512006e-05</span><span class="s3">, </span><span class="s6">7.234804392512006e-05</span><span class="s3">, </span><span class="s6">0.013477443099785824</span><span class="s3">,</span>
              <span class="s6">0.9998501512331494</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">,</span>
              <span class="s6">0.0</span><span class="s3">, </span><span class="s6">6.561112613212572e-07</span><span class="s3">, </span><span class="s6">0.9999276519560749</span><span class="s3">,</span>
              <span class="s6">0.9999276519560749</span><span class="s3">, </span><span class="s6">0.9999999313496014</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">,</span>
              <span class="s6">0.3525281784865706</span><span class="s3">, </span><span class="s6">0.40890253001898014</span><span class="s3">, </span><span class="s6">0.8664672830017024</span><span class="s3">,</span>
              <span class="s6">1.0</span><span class="s3">, </span><span class="s6">7.234804392512006e-05</span><span class="s3">, </span><span class="s6">7.234804392512006e-05</span><span class="s3">,</span>
              <span class="s6">0.010990889489704836</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">,</span>
              <span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">,</span>
              <span class="s6">0.9999276519560749</span><span class="s3">, </span><span class="s6">0.9999276519560749</span><span class="s3">, </span><span class="s6">0.9999999418789304</span><span class="s3">,</span>
              <span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.35252945487817355</span><span class="s3">, </span><span class="s6">0.40903153246690993</span><span class="s3">,</span>
              <span class="s6">0.8684247068528264</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">7.234804392512006e-05</span><span class="s3">,</span>
              <span class="s6">7.234804392512006e-05</span><span class="s3">, </span><span class="s6">0.01075068918582911</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">,</span>
              <span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">]</span>
    <span class="s1">actarr </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">df</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">t </span><span class="s2">in </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">(</span><span class="s1">dfarr</span><span class="s3">, </span><span class="s1">pnoncarr</span><span class="s3">, </span><span class="s1">tarr</span><span class="s3">):</span>
        <span class="s1">actarr </span><span class="s3">+= [</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">nctdtr</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">t</span><span class="s3">)]</span>
    <span class="s5"># The rtol is kept high on purpose to make it pass on 32bit systems</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actarr</span><span class="s3">, </span><span class="s1">resarr</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-6</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">0.0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_nctdtrinc_gh19896</span><span class="s3">():</span>
    <span class="s5"># test that gh-19896 is resolved.</span>
    <span class="s5"># Compared to SciPy 1.11 results from Fortran code.</span>
    <span class="s1">dfarr </span><span class="s3">= [</span><span class="s6">0.001</span><span class="s3">, </span><span class="s6">0.98</span><span class="s3">, </span><span class="s6">9.8</span><span class="s3">, </span><span class="s6">98</span><span class="s3">, </span><span class="s6">980</span><span class="s3">, </span><span class="s6">10000</span><span class="s3">, </span><span class="s6">98</span><span class="s3">, </span><span class="s6">9.8</span><span class="s3">, </span><span class="s6">0.98</span><span class="s3">, </span><span class="s6">0.001</span><span class="s3">]</span>
    <span class="s1">parr </span><span class="s3">= [</span><span class="s6">0.001</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.3</span><span class="s3">, </span><span class="s6">0.8</span><span class="s3">, </span><span class="s6">0.999</span><span class="s3">, </span><span class="s6">0.001</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.3</span><span class="s3">, </span><span class="s6">0.8</span><span class="s3">, </span><span class="s6">0.999</span><span class="s3">]</span>
    <span class="s1">tarr </span><span class="s3">= [</span><span class="s6">0.0015</span><span class="s3">, </span><span class="s6">0.15</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">15</span><span class="s3">, </span><span class="s6">300</span><span class="s3">, </span><span class="s6">0.0015</span><span class="s3">, </span><span class="s6">0.15</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">, </span><span class="s6">15</span><span class="s3">, </span><span class="s6">300</span><span class="s3">]</span>
    <span class="s1">desired </span><span class="s3">= [</span><span class="s6">3.090232306168629</span><span class="s3">, </span><span class="s6">1.406141304556198</span><span class="s3">, </span><span class="s6">2.014225177124157</span><span class="s3">,</span>
               <span class="s6">13.727067118283456</span><span class="s3">, </span><span class="s6">278.9765683871208</span><span class="s3">, </span><span class="s6">3.090232306168629</span><span class="s3">,</span>
               <span class="s6">1.4312427877936222</span><span class="s3">, </span><span class="s6">2.014225177124157</span><span class="s3">, </span><span class="s6">3.712743137978295</span><span class="s3">,</span>
               <span class="s3">-</span><span class="s6">3.086951096691082</span><span class="s3">]</span>
    <span class="s1">actual </span><span class="s3">= </span><span class="s1">sp</span><span class="s3">.</span><span class="s1">nctdtrinc</span><span class="s3">(</span><span class="s1">dfarr</span><span class="s3">, </span><span class="s1">parr</span><span class="s3">, </span><span class="s1">tarr</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">desired</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">5e-12</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">0.0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_stdtr_stdtrit_neg_inf</span><span class="s3">():</span>
    <span class="s5"># -inf was treated as +inf and values from the normal were returned</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">stdtr</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, [-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])))</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">stdtrit</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, [</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.25</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.75</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">])))</span>


<span class="s2">def </span><span class="s1">test_bdtrik_nbdtrik_inf</span><span class="s3">():</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">,-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,-</span><span class="s6">10.0</span><span class="s3">, -</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">.00001</span><span class="s3">, </span><span class="s6">.5</span><span class="s3">, </span><span class="s6">0.9999</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">10.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">y</span><span class="s3">[:,</span><span class="s2">None</span><span class="s3">]</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s6">10.0</span><span class="s3">, -</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">.00001</span><span class="s3">, </span><span class="s6">.5</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">bdtrik</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)))</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">sp</span><span class="s3">.</span><span class="s1">nbdtrik</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)))</span>
</pre>
</body>
</html>