<html>
<head>
<title>test_pipeline.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pipeline.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Test the pipeline module. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">tempfile </span><span class="s2">import </span><span class="s1">mkdtemp</span>

<span class="s2">import </span><span class="s1">joblib</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">BaseEstimator</span><span class="s3">, </span><span class="s1">TransformerMixin</span><span class="s3">, </span><span class="s1">clone</span><span class="s3">, </span><span class="s1">is_classifier</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">cluster </span><span class="s2">import </span><span class="s1">KMeans</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s1">load_iris</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">decomposition </span><span class="s2">import </span><span class="s1">PCA</span><span class="s3">, </span><span class="s1">TruncatedSVD</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">dummy </span><span class="s2">import </span><span class="s1">DummyRegressor</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">ensemble </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">HistGradientBoostingClassifier</span><span class="s3">,</span>
    <span class="s1">RandomForestClassifier</span><span class="s3">,</span>
    <span class="s1">RandomTreesEmbedding</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">UnsetMetadataPassedError</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">feature_extraction</span><span class="s3">.</span><span class="s1">text </span><span class="s2">import </span><span class="s1">CountVectorizer</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">feature_selection </span><span class="s2">import </span><span class="s1">SelectKBest</span><span class="s3">, </span><span class="s1">f_classif</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">impute </span><span class="s2">import </span><span class="s1">SimpleImputer</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model </span><span class="s2">import </span><span class="s1">Lasso</span><span class="s3">, </span><span class="s1">LinearRegression</span><span class="s3">, </span><span class="s1">LogisticRegression</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics </span><span class="s2">import </span><span class="s1">accuracy_score</span><span class="s3">, </span><span class="s1">r2_score</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection </span><span class="s2">import </span><span class="s1">train_test_split</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">neighbors </span><span class="s2">import </span><span class="s1">LocalOutlierFactor</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">pipeline </span><span class="s2">import </span><span class="s1">FeatureUnion</span><span class="s3">, </span><span class="s1">Pipeline</span><span class="s3">, </span><span class="s1">make_pipeline</span><span class="s3">, </span><span class="s1">make_union</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">preprocessing </span><span class="s2">import </span><span class="s1">FunctionTransformer</span><span class="s3">, </span><span class="s1">StandardScaler</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">svm </span><span class="s2">import </span><span class="s1">SVC</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">metadata_routing_common </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ConsumingNoFitTransformTransformer</span><span class="s3">,</span>
    <span class="s1">ConsumingTransformer</span><span class="s3">,</span>
    <span class="s1">_Registry</span><span class="s3">,</span>
    <span class="s1">check_recorded_metadata</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_metadata_requests </span><span class="s2">import </span><span class="s1">COMPOSITE_METHODS</span><span class="s3">, </span><span class="s1">METHODS</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">MinimalClassifier</span><span class="s3">,</span>
    <span class="s1">MinimalRegressor</span><span class="s3">,</span>
    <span class="s1">MinimalTransformer</span><span class="s3">,</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s1">CSR_CONTAINERS</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">validation </span><span class="s2">import </span><span class="s1">check_is_fitted</span>

<span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>

<span class="s1">JUNK_FOOD_DOCS </span><span class="s3">= (</span>
    <span class="s4">&quot;the pizza pizza beer copyright&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;the pizza burger beer copyright&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;the the pizza beer beer copyright&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;the burger beer beer copyright&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;the coke burger coke copyright&quot;</span><span class="s3">,</span>
    <span class="s4">&quot;the coke burger burger&quot;</span><span class="s3">,</span>
<span class="s3">)</span>


<span class="s2">class </span><span class="s1">NoFit</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot;Small class to test parameter dispatching.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">a</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s1">a</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">b</span>


<span class="s2">class </span><span class="s1">NoTrans</span><span class="s3">(</span><span class="s1">NoFit</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">{</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">b</span><span class="s3">}</span>

    <span class="s2">def </span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s1">params</span><span class="s3">[</span><span class="s4">&quot;a&quot;</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s2">class </span><span class="s1">NoInvTransf</span><span class="s3">(</span><span class="s1">NoTrans</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">Transf</span><span class="s3">(</span><span class="s1">NoInvTransf</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X</span>

    <span class="s2">def </span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">TransfFitParams</span><span class="s3">(</span><span class="s1">Transf</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, **</span><span class="s1">fit_params</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fit_params </span><span class="s3">= </span><span class="s1">fit_params</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s2">class </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mult</span><span class="s3">=</span><span class="s5">1</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">mult </span><span class="s3">= </span><span class="s1">mult</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) * </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mult</span>

    <span class="s2">def </span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) / </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mult</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) * </span><span class="s1">self</span><span class="s3">.</span><span class="s1">mult</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">predict_proba </span><span class="s3">= </span><span class="s1">predict_log_proba </span><span class="s3">= </span><span class="s1">decision_function </span><span class="s3">= </span><span class="s1">predict</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">FitParamT</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Mock classifier&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">successful </span><span class="s3">= </span><span class="s2">False</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">should_succeed</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">successful </span><span class="s3">= </span><span class="s1">should_succeed</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">successful</span>

    <span class="s2">def </span><span class="s1">fit_predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">should_succeed</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">should_succeed</span><span class="s3">=</span><span class="s1">should_succeed</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">sample_weight </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">X </span><span class="s3">* </span><span class="s1">sample_weight</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">DummyTransf</span><span class="s3">(</span><span class="s1">Transf</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Transformer which store the column means&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">means_ </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s6"># store timestamp to figure out whether the result of 'fit' has been</span>
        <span class="s6"># cached or not</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">timestamp_ </span><span class="s3">= </span><span class="s1">time</span><span class="s3">.</span><span class="s1">time</span><span class="s3">()</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s2">class </span><span class="s1">DummyEstimatorParams</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Mock classifier that takes params on predict&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">got_attribute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">got_attribute </span><span class="s3">= </span><span class="s1">got_attribute</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">got_attribute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">got_attribute </span><span class="s3">= </span><span class="s1">got_attribute</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">got_attribute</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">got_attribute </span><span class="s3">= </span><span class="s1">got_attribute</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s2">def </span><span class="s1">test_pipeline_invalid_parameters</span><span class="s3">():</span>
    <span class="s6"># Test the various init parameters of the pipeline in fit</span>
    <span class="s6"># method</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s6"># Check that we can't fit pipelines with objects without fit</span>
    <span class="s6"># method</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s4">&quot;Last step of Pipeline should implement fit &quot;</span>
        <span class="s4">&quot;or be the string 'passthrough'&quot;</span>
        <span class="s4">&quot;.*NoFit.*&quot;</span>
    <span class="s3">)</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">NoFit</span><span class="s3">())])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s6"># Smoke test with only an estimator</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">NoTrans</span><span class="s3">()</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) == </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">svc__a</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">svc__b</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">svc</span><span class="s3">=</span><span class="s1">clf</span><span class="s3">, **</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s6"># Check that params are set</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">svc__a</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">a </span><span class="s3">== </span><span class="s5">0.1</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">b </span><span class="s2">is None</span>
    <span class="s6"># Smoke test the repr:</span>
    <span class="s1">repr</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">)</span>

    <span class="s6"># Test with two objects</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s1">filter1 </span><span class="s3">= </span><span class="s1">SelectKBest</span><span class="s3">(</span><span class="s1">f_classif</span><span class="s3">)</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;anova&quot;</span><span class="s3">, </span><span class="s1">filter1</span><span class="s3">), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>

    <span class="s6"># Check that estimators are not cloned on pipeline construction</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;anova&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">filter1</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;svc&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">clf</span>

    <span class="s6"># Check that we can't fit with non-transformers on the way</span>
    <span class="s6"># Note that NoTrans implements fit, but not transform</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;All intermediate steps should be transformers.*</span><span class="s2">\\</span><span class="s4">bNoTrans</span><span class="s2">\\</span><span class="s4">b.*&quot;</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;t&quot;</span><span class="s3">, </span><span class="s1">NoTrans</span><span class="s3">()), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s6"># Check that params are set</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">svc__C</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">C </span><span class="s3">== </span><span class="s5">0.1</span>
    <span class="s6"># Smoke test the repr:</span>
    <span class="s1">repr</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">)</span>

    <span class="s6"># Check that params are not set when naming them wrong</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Invalid parameter 'C' for estimator SelectKBest(). Valid parameters are: ['k',&quot;</span>
        <span class="s4">&quot; 'score_func'].&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">anova__C</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

    <span class="s6"># Test clone</span>
    <span class="s1">pipe2 </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;svc&quot;</span><span class="s3">] </span><span class="s2">is not </span><span class="s1">pipe2</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;svc&quot;</span><span class="s3">]</span>

    <span class="s6"># Check that apart from estimators, the parameters are the same</span>
    <span class="s1">params </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">params2 </span><span class="s3">= </span><span class="s1">pipe2</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">params</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">pipe2</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">params2</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s6"># Remove estimators that where copied</span>
    <span class="s1">params</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;svc&quot;</span><span class="s3">)</span>
    <span class="s1">params</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;anova&quot;</span><span class="s3">)</span>
    <span class="s1">params2</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;svc&quot;</span><span class="s3">)</span>
    <span class="s1">params2</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">(</span><span class="s4">&quot;anova&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">params </span><span class="s3">== </span><span class="s1">params2</span>


<span class="s2">def </span><span class="s1">test_pipeline_init_tuple</span><span class="s3">():</span>
    <span class="s6"># Pipeline accepts steps as tuple</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(((</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())))</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">transf</span><span class="s3">=</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_methods_anova</span><span class="s3">():</span>
    <span class="s6"># Test the various methods of the pipeline (anova).</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s6"># Test with Anova + LogisticRegression</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">LogisticRegression</span><span class="s3">()</span>
    <span class="s1">filter1 </span><span class="s3">= </span><span class="s1">SelectKBest</span><span class="s3">(</span><span class="s1">f_classif</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;anova&quot;</span><span class="s3">, </span><span class="s1">filter1</span><span class="s3">), (</span><span class="s4">&quot;logistic&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_fit_params</span><span class="s3">():</span>
    <span class="s6"># Test that the pipeline can take fit parameters</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">clf__should_succeed</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s6"># classifier should return True</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s6"># and transformer params should not be changed</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">a </span><span class="s2">is None</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">b </span><span class="s2">is None</span>
    <span class="s6"># invalid parameters should raise an error message</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s4">&quot;fit() got an unexpected keyword argument 'bad'&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">clf__bad</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_sample_weight_supported</span><span class="s3">():</span>
    <span class="s6"># Pipeline should pass sample_weight</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s5">3</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">) == </span><span class="s5">3</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">) == </span><span class="s5">3</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])) == </span><span class="s5">8</span>


<span class="s2">def </span><span class="s1">test_pipeline_sample_weight_unsupported</span><span class="s3">():</span>
    <span class="s6"># When sample_weight is None it shouldn't be passed</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">())])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s5">3</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">) == </span><span class="s5">3</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s4">&quot;score() got an unexpected keyword argument 'sample_weight'&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]))</span>


<span class="s2">def </span><span class="s1">test_pipeline_raise_set_params_error</span><span class="s3">():</span>
    <span class="s6"># Test pipeline raises set params error message for nested models.</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;cls&quot;</span><span class="s3">, </span><span class="s1">LinearRegression</span><span class="s3">())])</span>

    <span class="s6"># expected error message</span>
    <span class="s1">error_msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Invalid parameter 'fake' for estimator Pipeline(steps=[('cls',&quot;</span>
        <span class="s4">&quot; LinearRegression())]). Valid parameters are: ['memory', 'steps', 'verbose'].&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">fake</span><span class="s3">=</span><span class="s4">&quot;nope&quot;</span><span class="s3">)</span>

    <span class="s6"># invalid outer parameter name for compound parameter: the expected error message</span>
    <span class="s6"># is the same as above.</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">fake__estimator</span><span class="s3">=</span><span class="s4">&quot;nope&quot;</span><span class="s3">)</span>

    <span class="s6"># expected error message for invalid inner parameter</span>
    <span class="s1">error_msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Invalid parameter 'invalid_param' for estimator LinearRegression(). Valid&quot;</span>
        <span class="s4">&quot; parameters are: ['copy_X', 'fit_intercept', 'n_jobs', 'positive'].&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">cls__invalid_param</span><span class="s3">=</span><span class="s4">&quot;nope&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_methods_pca_svm</span><span class="s3">():</span>
    <span class="s6"># Test the various methods of the pipeline (pca + svm).</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s6"># Test with PCA + SVC</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;full&quot;</span><span class="s3">, </span><span class="s1">n_components</span><span class="s3">=</span><span class="s4">&quot;mle&quot;</span><span class="s3">, </span><span class="s1">whiten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_score_samples_pca_lof</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s6"># Test that the score_samples method is implemented on a pipeline.</span>
    <span class="s6"># Test that the score_samples method on pipeline yields same results as</span>
    <span class="s6"># applying transform and score_samples steps separately.</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;full&quot;</span><span class="s3">, </span><span class="s1">n_components</span><span class="s3">=</span><span class="s4">&quot;mle&quot;</span><span class="s3">, </span><span class="s1">whiten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">lof </span><span class="s3">= </span><span class="s1">LocalOutlierFactor</span><span class="s3">(</span><span class="s1">novelty</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;lof&quot;</span><span class="s3">, </span><span class="s1">lof</span><span class="s3">)])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s6"># Check the shapes</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],)</span>
    <span class="s6"># Check the values</span>
    <span class="s1">lof</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">lof</span><span class="s3">.</span><span class="s1">score_samples</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)))</span>


<span class="s2">def </span><span class="s1">test_score_samples_on_pipeline_without_score_samples</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">]])</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
    <span class="s6"># Test that a pipeline does not have score_samples method when the final</span>
    <span class="s6"># step of the pipeline does not have score_samples defined.</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">LogisticRegression</span><span class="s3">())</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">inner_msg </span><span class="s3">= </span><span class="s4">&quot;'LogisticRegression' object has no attribute 'score_samples'&quot;</span>
    <span class="s1">outer_msg </span><span class="s3">= </span><span class="s4">&quot;'Pipeline' has no attribute 'score_samples'&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">outer_msg</span><span class="s3">) </span><span class="s2">as </span><span class="s1">exec_info</span><span class="s3">:</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score_samples</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exec_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">, </span><span class="s1">AttributeError</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">inner_msg </span><span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">exec_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_methods_preprocessing_svm</span><span class="s3">():</span>
    <span class="s6"># Test the various methods of the pipeline (preprocessing + svm).</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">n_classes </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;randomized&quot;</span><span class="s3">, </span><span class="s1">whiten</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s4">&quot;ovr&quot;</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">preprocessing </span><span class="s2">in </span><span class="s3">[</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">]:</span>
        <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;preprocess&quot;</span><span class="s3">, </span><span class="s1">preprocessing</span><span class="s3">), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s6"># check shapes of various prediction functions</span>
        <span class="s1">predict </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">predict</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">,)</span>

        <span class="s1">proba </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">proba</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">)</span>

        <span class="s1">log_proba </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">log_proba</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">)</span>

        <span class="s1">decision_function </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">decision_function</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_classes</span><span class="s3">)</span>

        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fit_predict_on_pipeline</span><span class="s3">():</span>
    <span class="s6"># test that the fit_predict method is implemented on a pipeline</span>
    <span class="s6"># test that the fit_predict on pipeline yields same results as applying</span>
    <span class="s6"># transform and clustering steps separately</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">km </span><span class="s3">= </span><span class="s1">KMeans</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">n_init</span><span class="s3">=</span><span class="s4">&quot;auto&quot;</span><span class="s3">)</span>
    <span class="s6"># As pipeline doesn't clone estimators on construction,</span>
    <span class="s6"># it must have its own estimators</span>
    <span class="s1">scaler_for_pipeline </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">km_for_pipeline </span><span class="s3">= </span><span class="s1">KMeans</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">n_init</span><span class="s3">=</span><span class="s4">&quot;auto&quot;</span><span class="s3">)</span>

    <span class="s6"># first compute the transform and clustering step separately</span>
    <span class="s1">scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">separate_pred </span><span class="s3">= </span><span class="s1">km</span><span class="s3">.</span><span class="s1">fit_predict</span><span class="s3">(</span><span class="s1">scaled</span><span class="s3">)</span>

    <span class="s6"># use a pipeline to do the transform and clustering in one step</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;scaler&quot;</span><span class="s3">, </span><span class="s1">scaler_for_pipeline</span><span class="s3">), (</span><span class="s4">&quot;Kmeans&quot;</span><span class="s3">, </span><span class="s1">km_for_pipeline</span><span class="s3">)])</span>
    <span class="s1">pipeline_pred </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit_predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pipeline_pred</span><span class="s3">, </span><span class="s1">separate_pred</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fit_predict_on_pipeline_without_fit_predict</span><span class="s3">():</span>
    <span class="s6"># tests that a pipeline does not have fit_predict method when final</span>
    <span class="s6"># step of pipeline does not have fit_predict defined</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;full&quot;</span><span class="s3">)</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;scaler&quot;</span><span class="s3">, </span><span class="s1">scaler</span><span class="s3">), (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">)])</span>

    <span class="s1">outer_msg </span><span class="s3">= </span><span class="s4">&quot;'Pipeline' has no attribute 'fit_predict'&quot;</span>
    <span class="s1">inner_msg </span><span class="s3">= </span><span class="s4">&quot;'PCA' object has no attribute 'fit_predict'&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">outer_msg</span><span class="s3">) </span><span class="s2">as </span><span class="s1">exec_info</span><span class="s3">:</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">, </span><span class="s4">&quot;fit_predict&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exec_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">, </span><span class="s1">AttributeError</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">inner_msg </span><span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">exec_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fit_predict_with_intermediate_fit_params</span><span class="s3">():</span>
    <span class="s6"># tests that Pipeline passes fit_params to intermediate steps</span>
    <span class="s6"># when fit_predict is invoked</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">TransfFitParams</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit_predict</span><span class="s3">(</span>
        <span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">transf__should_get_this</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">clf__should_succeed</span><span class="s3">=</span><span class="s2">True</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">fit_params</span><span class="s3">[</span><span class="s4">&quot;should_get_this&quot;</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;clf&quot;</span><span class="s3">].</span><span class="s1">successful</span>
    <span class="s2">assert </span><span class="s4">&quot;should_succeed&quot; </span><span class="s2">not in </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">fit_params</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;method_name&quot;</span><span class="s3">, [</span><span class="s4">&quot;predict&quot;</span><span class="s3">, </span><span class="s4">&quot;predict_proba&quot;</span><span class="s3">, </span><span class="s4">&quot;predict_log_proba&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_predict_methods_with_predict_params</span><span class="s3">(</span><span class="s1">method_name</span><span class="s3">):</span>
    <span class="s6"># tests that Pipeline passes predict_* to the final estimator</span>
    <span class="s6"># when predict_* is invoked</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">DummyEstimatorParams</span><span class="s3">())])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">, </span><span class="s1">method_name</span><span class="s3">)</span>
    <span class="s1">method</span><span class="s3">(</span><span class="s1">X</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">got_attribute</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;clf&quot;</span><span class="s3">].</span><span class="s1">got_attribute</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_union</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s6"># basic sanity check for feature union</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">X </span><span class="s3">-= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">svd </span><span class="s3">= </span><span class="s1">TruncatedSVD</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">select </span><span class="s3">= </span><span class="s1">SelectKBest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;svd&quot;</span><span class="s3">, </span><span class="s1">svd</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)])</span>
    <span class="s1">fs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">X_transformed </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">3</span><span class="s3">)</span>

    <span class="s6"># check if it does the expected thing</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">[:, :-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">svd</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">[:, -</span><span class="s5">1</span><span class="s3">], </span><span class="s1">select</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">())</span>

    <span class="s6"># test if it also works for sparse input</span>
    <span class="s6"># We use a different svd object to control the random_state stream</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;svd&quot;</span><span class="s3">, </span><span class="s1">svd</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)])</span>
    <span class="s1">X_sp </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_sp_transformed </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sp</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">, </span><span class="s1">X_sp_transformed</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s6"># Test clone</span>
    <span class="s1">fs2 </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">fs</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">transformer_list</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">1</span><span class="s3">] </span><span class="s2">is not </span><span class="s1">fs2</span><span class="s3">.</span><span class="s1">transformer_list</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">1</span><span class="s3">]</span>

    <span class="s6"># test setting parameters</span>
    <span class="s1">fs</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">select__k</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">4</span><span class="s3">)</span>

    <span class="s6"># test it works with transformers missing fit_transform</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;svd&quot;</span><span class="s3">, </span><span class="s1">svd</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)])</span>
    <span class="s1">X_transformed </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">8</span><span class="s3">)</span>

    <span class="s6"># test error if some elements do not support transform</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;All estimators should implement fit and transform.*</span><span class="s2">\\</span><span class="s4">bNoTrans</span><span class="s2">\\</span><span class="s4">b&quot;</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;transform&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;no_transform&quot;</span><span class="s3">, </span><span class="s1">NoTrans</span><span class="s3">())])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">fs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s6"># test that init accepts tuples</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(((</span><span class="s4">&quot;svd&quot;</span><span class="s3">, </span><span class="s1">svd</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)))</span>
    <span class="s1">fs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_named_transformers</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `named_transformers` attribute.&quot;&quot;&quot;</span>
    <span class="s1">transf </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">noinvtransf </span><span class="s3">= </span><span class="s1">NoInvTransf</span><span class="s3">()</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">transf</span><span class="s3">), (</span><span class="s4">&quot;noinvtransf&quot;</span><span class="s3">, </span><span class="s1">noinvtransf</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">named_transformers</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">] == </span><span class="s1">transf</span>
    <span class="s2">assert </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">named_transformers</span><span class="s3">[</span><span class="s4">&quot;noinvtransf&quot;</span><span class="s3">] == </span><span class="s1">noinvtransf</span>

    <span class="s6"># test named attribute</span>
    <span class="s2">assert </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">named_transformers</span><span class="s3">.</span><span class="s1">transf </span><span class="s3">== </span><span class="s1">transf</span>
    <span class="s2">assert </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">named_transformers</span><span class="s3">.</span><span class="s1">noinvtransf </span><span class="s3">== </span><span class="s1">noinvtransf</span>


<span class="s2">def </span><span class="s1">test_make_union</span><span class="s3">():</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;full&quot;</span><span class="s3">)</span>
    <span class="s1">mock </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">fu </span><span class="s3">= </span><span class="s1">make_union</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">)</span>
    <span class="s1">names</span><span class="s3">, </span><span class="s1">transformers </span><span class="s3">= </span><span class="s1">zip</span><span class="s3">(*</span><span class="s1">fu</span><span class="s3">.</span><span class="s1">transformer_list</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">names </span><span class="s3">== (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s4">&quot;transf&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">transformers </span><span class="s3">== (</span><span class="s1">pca</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_union_kwargs</span><span class="s3">():</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;full&quot;</span><span class="s3">)</span>
    <span class="s1">mock </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">fu </span><span class="s3">= </span><span class="s1">make_union</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">, </span><span class="s1">n_jobs</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">fu</span><span class="s3">.</span><span class="s1">transformer_list </span><span class="s3">== </span><span class="s1">make_union</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">).</span><span class="s1">transformer_list</span>
    <span class="s2">assert </span><span class="s5">3 </span><span class="s3">== </span><span class="s1">fu</span><span class="s3">.</span><span class="s1">n_jobs</span>

    <span class="s6"># invalid keyword parameters should raise an error message</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;make_union() got an unexpected keyword argument 'transformer_weights'&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">make_union</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">, </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s4">&quot;pca&quot;</span><span class="s3">: </span><span class="s5">10</span><span class="s3">, </span><span class="s4">&quot;Transf&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">})</span>


<span class="s2">def </span><span class="s1">test_pipeline_transform</span><span class="s3">():</span>
    <span class="s6"># Test whether pipeline works with a transformer at the end.</span>
    <span class="s6"># Also test pipeline.transform and pipeline.inverse_transform</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;full&quot;</span><span class="s3">)</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">)])</span>

    <span class="s6"># test transform and fit_transform:</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans2 </span><span class="s3">= </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans3 </span><span class="s3">= </span><span class="s1">pca</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_trans2</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_trans3</span><span class="s3">)</span>

    <span class="s1">X_back </span><span class="s3">= </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">X_back2 </span><span class="s3">= </span><span class="s1">pca</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_back</span><span class="s3">, </span><span class="s1">X_back2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_fit_transform</span><span class="s3">():</span>
    <span class="s6"># Test whether pipeline works with a transformer missing fit_transform</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">transf </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">transf</span><span class="s3">)])</span>

    <span class="s6"># test fit_transform:</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">X_trans2 </span><span class="s3">= </span><span class="s1">transf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_trans2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;start, end&quot;</span><span class="s3">, [(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), (</span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_pipeline_slice</span><span class="s3">(</span><span class="s1">start</span><span class="s3">, </span><span class="s1">end</span><span class="s3">):</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;transf1&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;transf2&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())],</span>
        <span class="s1">memory</span><span class="s3">=</span><span class="s4">&quot;123&quot;</span><span class="s3">,</span>
        <span class="s1">verbose</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">pipe_slice </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">[</span><span class="s1">start</span><span class="s3">:</span><span class="s1">end</span><span class="s3">]</span>
    <span class="s6"># Test class</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">pipe_slice</span><span class="s3">, </span><span class="s1">Pipeline</span><span class="s3">)</span>
    <span class="s6"># Test steps</span>
    <span class="s2">assert </span><span class="s1">pipe_slice</span><span class="s3">.</span><span class="s1">steps </span><span class="s3">== </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s1">start</span><span class="s3">:</span><span class="s1">end</span><span class="s3">]</span>
    <span class="s6"># Test named_steps attribute</span>
    <span class="s2">assert </span><span class="s3">(</span>
        <span class="s1">list</span><span class="s3">(</span><span class="s1">pipe_slice</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">.</span><span class="s1">items</span><span class="s3">())</span>
        <span class="s3">== </span><span class="s1">list</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">.</span><span class="s1">items</span><span class="s3">())[</span><span class="s1">start</span><span class="s3">:</span><span class="s1">end</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s6"># Test the rest of the parameters</span>
    <span class="s1">pipe_params </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">pipe_slice_params </span><span class="s3">= </span><span class="s1">pipe_slice</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">del </span><span class="s1">pipe_params</span><span class="s3">[</span><span class="s4">&quot;steps&quot;</span><span class="s3">]</span>
    <span class="s2">del </span><span class="s1">pipe_slice_params</span><span class="s3">[</span><span class="s4">&quot;steps&quot;</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">pipe_params </span><span class="s3">== </span><span class="s1">pipe_slice_params</span>
    <span class="s6"># Test exception</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Pipeline slicing only supports a step of 1&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">[</span><span class="s1">start</span><span class="s3">:</span><span class="s1">end</span><span class="s3">:-</span><span class="s5">1</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_pipeline_index</span><span class="s3">():</span>
    <span class="s1">transf </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">FitParamT</span><span class="s3">()</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">transf</span><span class="s3">), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">transf</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">] == </span><span class="s1">transf</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] == </span><span class="s1">clf</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">[</span><span class="s4">&quot;clf&quot;</span><span class="s3">] == </span><span class="s1">clf</span>

    <span class="s6"># should raise an error if slicing out of range</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">IndexError</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]</span>

    <span class="s6"># should raise an error if indexing with wrong element name</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">[</span><span class="s4">&quot;foobar&quot;</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_set_pipeline_steps</span><span class="s3">():</span>
    <span class="s1">transf1 </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">transf2 </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">transf1</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;mock&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">transf1</span>

    <span class="s6"># Directly setting attr</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps </span><span class="s3">= [(</span><span class="s4">&quot;mock2&quot;</span><span class="s3">, </span><span class="s1">transf2</span><span class="s3">)]</span>
    <span class="s2">assert </span><span class="s4">&quot;mock&quot; </span><span class="s2">not in </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;mock2&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">transf2</span>
    <span class="s2">assert </span><span class="s3">[(</span><span class="s4">&quot;mock2&quot;</span><span class="s3">, </span><span class="s1">transf2</span><span class="s3">)] == </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps</span>

    <span class="s6"># Using set_params</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">steps</span><span class="s3">=[(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">transf1</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s3">[(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">transf1</span><span class="s3">)] == </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps</span>

    <span class="s6"># Using set_params to replace single step</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">mock</span><span class="s3">=</span><span class="s1">transf2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s3">[(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">transf2</span><span class="s3">)] == </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps</span>

    <span class="s6"># With invalid data</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">steps</span><span class="s3">=[(</span><span class="s4">&quot;junk&quot;</span><span class="s3">, ())])</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Last step of Pipeline should implement fit or be the string 'passthrough'.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;This 'Pipeline' has no attribute 'fit_transform'&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_pipeline_named_steps</span><span class="s3">():</span>
    <span class="s1">transf </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">mult2 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">transf</span><span class="s3">), (</span><span class="s4">&quot;mult&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">)])</span>

    <span class="s6"># Test access via named_steps bunch object</span>
    <span class="s2">assert </span><span class="s4">&quot;mock&quot; </span><span class="s2">in </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span>
    <span class="s2">assert </span><span class="s4">&quot;mock2&quot; </span><span class="s2">not in </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">.</span><span class="s1">mock </span><span class="s2">is </span><span class="s1">transf</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">.</span><span class="s1">mult </span><span class="s2">is </span><span class="s1">mult2</span>

    <span class="s6"># Test bunch with conflict attribute of dict</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;values&quot;</span><span class="s3">, </span><span class="s1">transf</span><span class="s3">), (</span><span class="s4">&quot;mult&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">.</span><span class="s1">values </span><span class="s2">is not </span><span class="s1">transf</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">.</span><span class="s1">mult </span><span class="s2">is </span><span class="s1">mult2</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_pipeline_correctly_adjusts_steps</span><span class="s3">(</span><span class="s1">passthrough</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">mult2 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">mult3 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">mult5 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">), (</span><span class="s4">&quot;bad&quot;</span><span class="s3">, </span><span class="s1">passthrough</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">), (</span><span class="s4">&quot;m5&quot;</span><span class="s3">, </span><span class="s1">mult5</span><span class="s3">)]</span>
    <span class="s3">)</span>

    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">expected_names </span><span class="s3">= [</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s4">&quot;bad&quot;</span><span class="s3">, </span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s4">&quot;m5&quot;</span><span class="s3">]</span>
    <span class="s1">actual_names </span><span class="s3">= [</span><span class="s1">name </span><span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">expected_names </span><span class="s3">== </span><span class="s1">actual_names</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_set_pipeline_step_passthrough</span><span class="s3">(</span><span class="s1">passthrough</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">mult2 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">mult3 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">mult5 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">make</span><span class="s3">():</span>
        <span class="s2">return </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">), (</span><span class="s4">&quot;last&quot;</span><span class="s3">, </span><span class="s1">mult5</span><span class="s3">)])</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make</span><span class="s3">()</span>

    <span class="s1">exp </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s5">3 </span><span class="s3">* </span><span class="s5">5</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">exp</span><span class="s3">], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]]))</span>

    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m3</span><span class="s3">=</span><span class="s1">passthrough</span><span class="s3">)</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s5">5</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">exp</span><span class="s3">], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]]))</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">deep</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) == {</span>
        <span class="s4">&quot;steps&quot;</span><span class="s3">: </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">,</span>
        <span class="s4">&quot;m2&quot;</span><span class="s3">: </span><span class="s1">mult2</span><span class="s3">,</span>
        <span class="s4">&quot;m3&quot;</span><span class="s3">: </span><span class="s1">passthrough</span><span class="s3">,</span>
        <span class="s4">&quot;last&quot;</span><span class="s3">: </span><span class="s1">mult5</span><span class="s3">,</span>
        <span class="s4">&quot;memory&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
        <span class="s4">&quot;m2__mult&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">,</span>
        <span class="s4">&quot;last__mult&quot;</span><span class="s3">: </span><span class="s5">5</span><span class="s3">,</span>
        <span class="s4">&quot;verbose&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">}</span>

    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">=</span><span class="s1">passthrough</span><span class="s3">)</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s5">5</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">exp</span><span class="s3">], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]]))</span>

    <span class="s6"># for other methods, ensure no AttributeErrors on None:</span>
    <span class="s1">other_methods </span><span class="s3">= [</span>
        <span class="s4">&quot;predict_proba&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;predict_log_proba&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;decision_function&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;transform&quot;</span><span class="s3">,</span>
        <span class="s4">&quot;score&quot;</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s1">other_methods</span><span class="s3">:</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">=</span><span class="s1">mult2</span><span class="s3">)</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s5">5</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">exp</span><span class="s3">], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]]))</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make</span><span class="s3">()</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">last</span><span class="s3">=</span><span class="s1">passthrough</span><span class="s3">)</span>
    <span class="s6"># mult2 and mult3 are active</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s5">6</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]]))</span>

    <span class="s1">inner_msg </span><span class="s3">= </span><span class="s4">&quot;'str' object has no attribute 'predict'&quot;</span>
    <span class="s1">outer_msg </span><span class="s3">= </span><span class="s4">&quot;This 'Pipeline' has no attribute 'predict'&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">outer_msg</span><span class="s3">) </span><span class="s2">as </span><span class="s1">exec_info</span><span class="s3">:</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;predict&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exec_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">, </span><span class="s1">AttributeError</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">inner_msg </span><span class="s2">in </span><span class="s1">str</span><span class="s3">(</span><span class="s1">exec_info</span><span class="s3">.</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__cause__</span><span class="s3">)</span>

    <span class="s6"># Check 'passthrough' step at construction time</span>
    <span class="s1">exp </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">* </span><span class="s5">5</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">passthrough</span><span class="s3">), (</span><span class="s4">&quot;last&quot;</span><span class="s3">, </span><span class="s1">mult5</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s1">exp</span><span class="s3">], </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s1">exp</span><span class="s3">]]))</span>


<span class="s2">def </span><span class="s1">test_pipeline_ducktyping</span><span class="s3">():</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">predict</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">transform</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">Transf</span><span class="s3">())</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;predict&quot;</span><span class="s3">)</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">transform</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == (</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;predict&quot;</span><span class="s3">)</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">transform</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">inverse_transform</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">Transf</span><span class="s3">(), </span><span class="s1">NoInvTransf</span><span class="s3">())</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;predict&quot;</span><span class="s3">)</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">transform</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;inverse_transform&quot;</span><span class="s3">)</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">NoInvTransf</span><span class="s3">(), </span><span class="s1">Transf</span><span class="s3">())</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;predict&quot;</span><span class="s3">)</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">transform</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s4">&quot;inverse_transform&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_pipeline</span><span class="s3">():</span>
    <span class="s1">t1 </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">t2 </span><span class="s3">= </span><span class="s1">Transf</span><span class="s3">()</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">, </span><span class="s1">Pipeline</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;transf-1&quot;</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;transf-2&quot;</span>

    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">t1</span><span class="s3">, </span><span class="s1">t2</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">, </span><span class="s1">Pipeline</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;transf-1&quot;</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s5">1</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;transf-2&quot;</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[</span><span class="s5">2</span><span class="s3">][</span><span class="s5">0</span><span class="s3">] == </span><span class="s4">&quot;fitparamt&quot;</span>


<span class="s2">def </span><span class="s1">test_feature_union_weights</span><span class="s3">():</span>
    <span class="s6"># test feature union with transformer weights</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;randomized&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">select </span><span class="s3">= </span><span class="s1">SelectKBest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s6"># test using fit followed by transform</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)], </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s4">&quot;pca&quot;</span><span class="s3">: </span><span class="s5">10</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">fs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">X_transformed </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s6"># test using fit_transform</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)], </span><span class="s1">transformer_weights</span><span class="s3">={</span><span class="s4">&quot;pca&quot;</span><span class="s3">: </span><span class="s5">10</span><span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s1">X_fit_transformed </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s6"># test it works with transformers missing fit_transform</span>
    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;select&quot;</span><span class="s3">, </span><span class="s1">select</span><span class="s3">)],</span>
        <span class="s1">transformer_weights</span><span class="s3">={</span><span class="s4">&quot;mock&quot;</span><span class="s3">: </span><span class="s5">10</span><span class="s3">},</span>
    <span class="s3">)</span>
    <span class="s1">X_fit_transformed_wo_method </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s6"># check against expected result</span>

    <span class="s6"># We use a different pca object to control the random_state stream</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">[:, :-</span><span class="s5">1</span><span class="s3">], </span><span class="s5">10 </span><span class="s3">* </span><span class="s1">pca</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">[:, -</span><span class="s5">1</span><span class="s3">], </span><span class="s1">select</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">())</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_fit_transformed</span><span class="s3">[:, :-</span><span class="s5">1</span><span class="s3">], </span><span class="s5">10 </span><span class="s3">* </span><span class="s1">pca</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_fit_transformed</span><span class="s3">[:, -</span><span class="s5">1</span><span class="s3">], </span><span class="s1">select</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">())</span>
    <span class="s2">assert </span><span class="s1">X_fit_transformed_wo_method</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s5">7</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_parallel</span><span class="s3">():</span>
    <span class="s6"># test that n_jobs work for FeatureUnion</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">JUNK_FOOD_DOCS</span>

    <span class="s1">fs </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;words&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;word&quot;</span><span class="s3">)),</span>
            <span class="s3">(</span><span class="s4">&quot;chars&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;char&quot;</span><span class="s3">)),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">fs_parallel </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;words&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;word&quot;</span><span class="s3">)),</span>
            <span class="s3">(</span><span class="s4">&quot;chars&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;char&quot;</span><span class="s3">)),</span>
        <span class="s3">],</span>
        <span class="s1">n_jobs</span><span class="s3">=</span><span class="s5">2</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">fs_parallel2 </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;words&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;word&quot;</span><span class="s3">)),</span>
            <span class="s3">(</span><span class="s4">&quot;chars&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;char&quot;</span><span class="s3">)),</span>
        <span class="s3">],</span>
        <span class="s1">n_jobs</span><span class="s3">=</span><span class="s5">2</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">fs</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_transformed </span><span class="s3">= </span><span class="s1">fs</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">fs_parallel</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_transformed_parallel </span><span class="s3">= </span><span class="s1">fs_parallel</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">X_transformed_parallel</span><span class="s3">.</span><span class="s1">shape</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_transformed_parallel</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s6"># fit_transform should behave the same</span>
    <span class="s1">X_transformed_parallel2 </span><span class="s3">= </span><span class="s1">fs_parallel2</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_transformed_parallel2</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s6"># transformers should stay fit after fit_transform</span>
    <span class="s1">X_transformed_parallel2 </span><span class="s3">= </span><span class="s1">fs_parallel2</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_transformed_parallel2</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_feature_union_feature_names</span><span class="s3">():</span>
    <span class="s1">word_vect </span><span class="s3">= </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;word&quot;</span><span class="s3">)</span>
    <span class="s1">char_vect </span><span class="s3">= </span><span class="s1">CountVectorizer</span><span class="s3">(</span><span class="s1">analyzer</span><span class="s3">=</span><span class="s4">&quot;char_wb&quot;</span><span class="s3">, </span><span class="s1">ngram_range</span><span class="s3">=(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;chars&quot;</span><span class="s3">, </span><span class="s1">char_vect</span><span class="s3">), (</span><span class="s4">&quot;words&quot;</span><span class="s3">, </span><span class="s1">word_vect</span><span class="s3">)])</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">JUNK_FOOD_DOCS</span><span class="s3">)</span>
    <span class="s1">feature_names </span><span class="s3">= </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">feat </span><span class="s2">in </span><span class="s1">feature_names</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s4">&quot;chars__&quot; </span><span class="s2">in </span><span class="s1">feat </span><span class="s2">or </span><span class="s4">&quot;words__&quot; </span><span class="s2">in </span><span class="s1">feat</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">feature_names</span><span class="s3">) == </span><span class="s5">35</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;tr1&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">())]).</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Transformer tr1 (type Transf) does not provide get_feature_names_out&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_classes_property</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>

    <span class="s1">reg </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">SelectKBest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">=</span><span class="s5">1</span><span class="s3">), </span><span class="s1">LinearRegression</span><span class="s3">())</span>
    <span class="s1">reg</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">):</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">reg</span><span class="s3">, </span><span class="s4">&quot;classes_&quot;</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">SelectKBest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">=</span><span class="s5">1</span><span class="s3">), </span><span class="s1">LogisticRegression</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">):</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s4">&quot;classes_&quot;</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">classes_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_set_feature_union_steps</span><span class="s3">():</span>
    <span class="s1">mult2 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">mult3 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">mult5 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>

    <span class="s1">mult3</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x3&quot;</span><span class="s3">]</span>
    <span class="s1">mult2</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x2&quot;</span><span class="s3">]</span>
    <span class="s1">mult5</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x5&quot;</span><span class="s3">]</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m2__x2&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s6"># Directly setting attr</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">transformer_list </span><span class="s3">= [(</span><span class="s4">&quot;m5&quot;</span><span class="s3">, </span><span class="s1">mult5</span><span class="s3">)]</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">5</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m5__x5&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s6"># Using set_params</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">transformer_list</span><span class="s3">=[(</span><span class="s4">&quot;mock&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;mock__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s6"># Using set_params to replace single step</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">mock</span><span class="s3">=</span><span class="s1">mult5</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">5</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;mock__x5&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_set_feature_union_step_drop</span><span class="s3">():</span>
    <span class="s1">mult2 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">mult3 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s1">mult2</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x2&quot;</span><span class="s3">]</span>
    <span class="s1">mult3</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x3&quot;</span><span class="s3">]</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m2__x2&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">=</span><span class="s4">&quot;drop&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m3</span><span class="s3">=</span><span class="s4">&quot;drop&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s6"># check we can change back</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m3</span><span class="s3">=</span><span class="s1">mult3</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

    <span class="s6"># Check 'drop' step at construction time</span>
    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s4">&quot;drop&quot;</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_set_feature_union_passthrough</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of setting a transformer to `&quot;passthrough&quot;`.&quot;&quot;&quot;</span>
    <span class="s1">mult2 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">mult3 </span><span class="s3">= </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s6"># We only test get_features_names_out, as get_feature_names is unsupported by</span>
    <span class="s6"># FunctionTransformer, and hence unsupported by FeatureUnion passthrough.</span>
    <span class="s1">mult2</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x2&quot;</span><span class="s3">]</span>
    <span class="s1">mult3</span><span class="s3">.</span><span class="s1">get_feature_names_out </span><span class="s3">= </span><span class="s2">lambda </span><span class="s1">input_features</span><span class="s3">: [</span><span class="s4">&quot;x3&quot;</span><span class="s3">]</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s1">mult2</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m2__x2&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>

    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">=</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m2__myfeat&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;myfeat&quot;</span><span class="s3">]))</span>

    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m3</span><span class="s3">=</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s4">&quot;m2__myfeat&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__myfeat&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;myfeat&quot;</span><span class="s3">])</span>
    <span class="s3">)</span>

    <span class="s6"># check we can change back</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">m3</span><span class="s3">=</span><span class="s1">mult3</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m2__myfeat&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;myfeat&quot;</span><span class="s3">]))</span>

    <span class="s6"># Check 'passthrough' step at construction time</span>
    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;m2&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">), (</span><span class="s4">&quot;m3&quot;</span><span class="s3">, </span><span class="s1">mult3</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">([</span><span class="s4">&quot;m2__myfeat&quot;</span><span class="s3">, </span><span class="s4">&quot;m3__x3&quot;</span><span class="s3">], </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;myfeat&quot;</span><span class="s3">]))</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">columns </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;randomized&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">), (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">)])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)[:, :</span><span class="s1">columns</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)[:, :</span><span class="s1">columns</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s4">&quot;passthrough__f0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__pca0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__pca1&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;f0&quot;</span><span class="s3">, </span><span class="s4">&quot;f1&quot;</span><span class="s3">, </span><span class="s4">&quot;f2&quot;</span><span class="s3">, </span><span class="s4">&quot;f3&quot;</span><span class="s3">]),</span>
    <span class="s3">)</span>

    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">pca</span><span class="s3">=</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)</span>
    <span class="s1">X_ft </span><span class="s3">= </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_ft</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">]))</span>
    <span class="s1">X_ft </span><span class="s3">= </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_ft</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">]))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s4">&quot;passthrough__f0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f3&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;f0&quot;</span><span class="s3">, </span><span class="s4">&quot;f1&quot;</span><span class="s3">, </span><span class="s4">&quot;f2&quot;</span><span class="s3">, </span><span class="s4">&quot;f3&quot;</span><span class="s3">]),</span>
    <span class="s3">)</span>

    <span class="s1">ft</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">passthrough</span><span class="s3">=</span><span class="s1">pca</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)[:, -</span><span class="s1">columns</span><span class="s3">:])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)[:, -</span><span class="s1">columns</span><span class="s3">:])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s4">&quot;passthrough__pca0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__pca1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__f3&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;f0&quot;</span><span class="s3">, </span><span class="s4">&quot;f1&quot;</span><span class="s3">, </span><span class="s4">&quot;f2&quot;</span><span class="s3">, </span><span class="s4">&quot;f3&quot;</span><span class="s3">]),</span>
    <span class="s3">)</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">), (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">)],</span>
        <span class="s1">transformer_weights</span><span class="s3">={</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">: </span><span class="s5">2</span><span class="s3">},</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X </span><span class="s3">* </span><span class="s5">2</span><span class="s3">, </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)[:, :</span><span class="s1">columns</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X </span><span class="s3">* </span><span class="s5">2</span><span class="s3">, </span><span class="s1">ft</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)[:, :</span><span class="s1">columns</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s4">&quot;passthrough__f0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__f3&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__pca0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__pca1&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">([</span><span class="s4">&quot;f0&quot;</span><span class="s3">, </span><span class="s4">&quot;f1&quot;</span><span class="s3">, </span><span class="s4">&quot;f2&quot;</span><span class="s3">, </span><span class="s4">&quot;f3&quot;</span><span class="s3">]),</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_passthrough_get_feature_names_out_true</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=True (default)&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;randomized&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)])</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s4">&quot;pca__pca0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca__pca1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__x0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__x1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__x2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;passthrough__x3&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(),</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_passthrough_get_feature_names_out_false</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=False&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">svd_solver</span><span class="s3">=</span><span class="s4">&quot;randomized&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">ft </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">), (</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)], </span><span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">)</span>
    <span class="s1">ft</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s4">&quot;pca0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;pca1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;x0&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;x1&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;x2&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;x3&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
        <span class="s1">ft</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(),</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_passthrough_get_feature_names_out_false_errors</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check get_feature_names_out and non-verbose names and colliding names.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span><span class="s3">])</span>

    <span class="s1">select_a </span><span class="s3">= </span><span class="s1">FunctionTransformer</span><span class="s3">(</span>
        <span class="s2">lambda </span><span class="s1">X</span><span class="s3">: </span><span class="s1">X</span><span class="s3">[[</span><span class="s4">&quot;a&quot;</span><span class="s3">]], </span><span class="s1">feature_names_out</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">self</span><span class="s3">, </span><span class="s1">_</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s4">&quot;a&quot;</span><span class="s3">])</span>
    <span class="s3">)</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;t1&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">()), (</span><span class="s4">&quot;t2&quot;</span><span class="s3">, </span><span class="s1">select_a</span><span class="s3">)],</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Output feature names: ['a'] are not unique. &quot;</span>
        <span class="s4">&quot;Please set verbose_feature_names_out=True to add prefixes to feature names&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">union</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_feature_union_passthrough_get_feature_names_out_false_errors_overlap_over_5</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check get_feature_names_out with non-verbose names and &gt;= 5 colliding names.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">10</span><span class="s3">))], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s4">f&quot;f</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)])</span>

    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;t1&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">), (</span><span class="s4">&quot;t2&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)],</span>
        <span class="s1">verbose_feature_names_out</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span>
        <span class="s4">&quot;Output feature names: ['f0', 'f1', 'f2', 'f3', 'f4', ...] &quot;</span>
        <span class="s4">&quot;are not unique. Please set verbose_feature_names_out=True to add prefixes to&quot;</span>
        <span class="s4">&quot; feature names&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">union</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_step_name_validation</span><span class="s3">():</span>
    <span class="s1">error_message_1 </span><span class="s3">= </span><span class="s4">r&quot;Estimator names must not contain __: got \['a__q'\]&quot;</span>
    <span class="s1">error_message_2 </span><span class="s3">= </span><span class="s4">r&quot;Names provided are not unique: \['a', 'a'\]&quot;</span>
    <span class="s1">error_message_3 </span><span class="s3">= </span><span class="s4">r&quot;Estimator names conflict with constructor arguments: \['%s'\]&quot;</span>
    <span class="s1">bad_steps1 </span><span class="s3">= [(</span><span class="s4">&quot;a__q&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)), (</span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">3</span><span class="s3">))]</span>
    <span class="s1">bad_steps2 </span><span class="s3">= [(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)), (</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">3</span><span class="s3">))]</span>
    <span class="s2">for </span><span class="s1">cls</span><span class="s3">, </span><span class="s1">param </span><span class="s2">in </span><span class="s3">[(</span><span class="s1">Pipeline</span><span class="s3">, </span><span class="s4">&quot;steps&quot;</span><span class="s3">), (</span><span class="s1">FeatureUnion</span><span class="s3">, </span><span class="s4">&quot;transformer_list&quot;</span><span class="s3">)]:</span>
        <span class="s6"># we validate in construction (despite scikit-learn convention)</span>
        <span class="s1">bad_steps3 </span><span class="s3">= [(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)), (</span><span class="s1">param</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">3</span><span class="s3">))]</span>
        <span class="s2">for </span><span class="s1">bad_steps</span><span class="s3">, </span><span class="s1">message </span><span class="s2">in </span><span class="s3">[</span>
            <span class="s3">(</span><span class="s1">bad_steps1</span><span class="s3">, </span><span class="s1">error_message_1</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">bad_steps2</span><span class="s3">, </span><span class="s1">error_message_2</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s1">bad_steps3</span><span class="s3">, </span><span class="s1">error_message_3 </span><span class="s3">% </span><span class="s1">param</span><span class="s3">),</span>
        <span class="s3">]:</span>
            <span class="s6"># three ways to make invalid:</span>
            <span class="s6"># - construction</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
                <span class="s1">cls</span><span class="s3">(**{</span><span class="s1">param</span><span class="s3">: </span><span class="s1">bad_steps</span><span class="s3">}).</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

            <span class="s6"># - setattr</span>
            <span class="s1">est </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">(**{</span><span class="s1">param</span><span class="s3">: [(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">1</span><span class="s3">))]})</span>
            <span class="s1">setattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">param</span><span class="s3">, </span><span class="s1">bad_steps</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
                <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
                <span class="s1">est</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

            <span class="s6"># - set_params</span>
            <span class="s1">est </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">(**{</span><span class="s1">param</span><span class="s3">: [(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">(</span><span class="s5">1</span><span class="s3">))]})</span>
            <span class="s1">est</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(**{</span><span class="s1">param</span><span class="s3">: </span><span class="s1">bad_steps</span><span class="s3">})</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
                <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>

            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
                <span class="s1">est</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_set_params_nested_pipeline</span><span class="s3">():</span>
    <span class="s1">estimator </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">DummyRegressor</span><span class="s3">())]))])</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">a__b__alpha</span><span class="s3">=</span><span class="s5">0.001</span><span class="s3">, </span><span class="s1">a__b</span><span class="s3">=</span><span class="s1">Lasso</span><span class="s3">())</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">a__steps</span><span class="s3">=[(</span><span class="s4">&quot;b&quot;</span><span class="s3">, </span><span class="s1">LogisticRegression</span><span class="s3">())], </span><span class="s1">a__b__C</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_memory</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">cachedir </span><span class="s3">= </span><span class="s1">mkdtemp</span><span class="s3">()</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">memory </span><span class="s3">= </span><span class="s1">joblib</span><span class="s3">.</span><span class="s1">Memory</span><span class="s3">(</span><span class="s1">location</span><span class="s3">=</span><span class="s1">cachedir</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s6"># Test with Transformer + SVC</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">transf </span><span class="s3">= </span><span class="s1">DummyTransf</span><span class="s3">()</span>
        <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">transf</span><span class="s3">)), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)])</span>
        <span class="s1">cached_pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">transf</span><span class="s3">), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">)], </span><span class="s1">memory</span><span class="s3">=</span><span class="s1">memory</span><span class="s3">)</span>

        <span class="s6"># Memoize the transformer at the first fit</span>
        <span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s6"># Get the time stamp of the transformer in the cached pipeline</span>
        <span class="s1">ts </span><span class="s3">= </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">timestamp_</span>
        <span class="s6"># Check that cached_pipe and pipe yield identical results</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span>
            <span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">means_</span><span class="s3">, </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">means_</span>
        <span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">transf</span><span class="s3">, </span><span class="s4">&quot;means_&quot;</span><span class="s3">)</span>
        <span class="s6"># Check that we are reading the cache while fitting</span>
        <span class="s6"># a second time</span>
        <span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s6"># Check that cached_pipe and pipe yield identical results</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">), </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span>
            <span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">means_</span><span class="s3">, </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">means_</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">ts </span><span class="s3">== </span><span class="s1">cached_pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">timestamp_</span>
        <span class="s6"># Create a new pipeline with cloned estimators</span>
        <span class="s6"># Check that even changing the name step does not affect the cache hit</span>
        <span class="s1">clf_2 </span><span class="s3">= </span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">transf_2 </span><span class="s3">= </span><span class="s1">DummyTransf</span><span class="s3">()</span>
        <span class="s1">cached_pipe_2 </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
            <span class="s3">[(</span><span class="s4">&quot;transf_2&quot;</span><span class="s3">, </span><span class="s1">transf_2</span><span class="s3">), (</span><span class="s4">&quot;svc&quot;</span><span class="s3">, </span><span class="s1">clf_2</span><span class="s3">)], </span><span class="s1">memory</span><span class="s3">=</span><span class="s1">memory</span>
        <span class="s3">)</span>
        <span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

        <span class="s6"># Check that cached_pipe and pipe yield identical results</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span>
            <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">), </span><span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span>
            <span class="s1">pipe</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf&quot;</span><span class="s3">].</span><span class="s1">means_</span><span class="s3">,</span>
            <span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf_2&quot;</span><span class="s3">].</span><span class="s1">means_</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">ts </span><span class="s3">== </span><span class="s1">cached_pipe_2</span><span class="s3">.</span><span class="s1">named_steps</span><span class="s3">[</span><span class="s4">&quot;transf_2&quot;</span><span class="s3">].</span><span class="s1">timestamp_</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">cachedir</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_make_pipeline_memory</span><span class="s3">():</span>
    <span class="s1">cachedir </span><span class="s3">= </span><span class="s1">mkdtemp</span><span class="s3">()</span>
    <span class="s1">memory </span><span class="s3">= </span><span class="s1">joblib</span><span class="s3">.</span><span class="s1">Memory</span><span class="s3">(</span><span class="s1">location</span><span class="s3">=</span><span class="s1">cachedir</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">DummyTransf</span><span class="s3">(), </span><span class="s1">SVC</span><span class="s3">(), </span><span class="s1">memory</span><span class="s3">=</span><span class="s1">memory</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">memory </span><span class="s2">is </span><span class="s1">memory</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">DummyTransf</span><span class="s3">(), </span><span class="s1">SVC</span><span class="s3">())</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">memory </span><span class="s2">is None</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">) == </span><span class="s5">2</span>

    <span class="s1">shutil</span><span class="s3">.</span><span class="s1">rmtree</span><span class="s3">(</span><span class="s1">cachedir</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">FeatureNameSaver</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_feature_names</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">reset</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">X</span>

    <span class="s2">def </span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">input_features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">input_features</span>


<span class="s2">def </span><span class="s1">test_features_names_passthrough</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check pipeline.get_feature_names_out with passthrough&quot;&quot;&quot;</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s1">steps</span><span class="s3">=[</span>
            <span class="s3">(</span><span class="s4">&quot;names&quot;</span><span class="s3">, </span><span class="s1">FeatureNameSaver</span><span class="s3">()),</span>
            <span class="s3">(</span><span class="s4">&quot;pass&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">LogisticRegression</span><span class="s3">()),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">pipe</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">].</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">), </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_names_count_vectorizer</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check pipeline.get_feature_names_out with vectorizers&quot;&quot;&quot;</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span><span class="s1">steps</span><span class="s3">=[(</span><span class="s4">&quot;vect&quot;</span><span class="s3">, </span><span class="s1">CountVectorizer</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">LogisticRegression</span><span class="s3">())])</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s4">&quot;pizza&quot; </span><span class="s2">in </span><span class="s1">x </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">JUNK_FOOD_DOCS</span><span class="s3">]</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">JUNK_FOOD_DOCS</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">pipe</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">].</span><span class="s1">get_feature_names_out</span><span class="s3">(),</span>
        <span class="s3">[</span><span class="s4">&quot;beer&quot;</span><span class="s3">, </span><span class="s4">&quot;burger&quot;</span><span class="s3">, </span><span class="s4">&quot;coke&quot;</span><span class="s3">, </span><span class="s4">&quot;copyright&quot;</span><span class="s3">, </span><span class="s4">&quot;pizza&quot;</span><span class="s3">, </span><span class="s4">&quot;the&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">pipe</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">].</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s4">&quot;nonsense_is_ignored&quot;</span><span class="s3">),</span>
        <span class="s3">[</span><span class="s4">&quot;beer&quot;</span><span class="s3">, </span><span class="s4">&quot;burger&quot;</span><span class="s3">, </span><span class="s4">&quot;coke&quot;</span><span class="s3">, </span><span class="s4">&quot;copyright&quot;</span><span class="s3">, </span><span class="s4">&quot;pizza&quot;</span><span class="s3">, </span><span class="s4">&quot;the&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_feature_names_out_error_without_definition</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that error is raised when a transformer does not define 
    `get_feature_names_out`.&quot;&quot;&quot;</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span><span class="s1">steps</span><span class="s3">=[(</span><span class="s4">&quot;notrans&quot;</span><span class="s3">, </span><span class="s1">NoTrans</span><span class="s3">())])</span>
    <span class="s1">iris </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">()</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;does not provide get_feature_names_out&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">test_pipeline_param_error</span><span class="s3">():</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">LogisticRegression</span><span class="s3">())</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
        <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Pipeline.fit does not accept the sample_weight parameter&quot;</span>
    <span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">]], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">sample_weight</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>


<span class="s1">parameter_grid_test_verbose </span><span class="s3">= (</span>
    <span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">), </span><span class="s1">method </span><span class="s2">in </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())]),</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 2 of 2\) Processing clf.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;noop&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">())]),</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 1 of 3\) Processing transf.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 2 of 3\) Processing noop.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 3 of 3\) Processing clf.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">Pipeline</span><span class="s3">(</span>
                    <span class="s3">[</span>
                        <span class="s3">(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()),</span>
                        <span class="s3">(</span><span class="s4">&quot;noop&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">),</span>
                        <span class="s3">(</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">FitParamT</span><span class="s3">()),</span>
                    <span class="s3">]</span>
                <span class="s3">),</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 1 of 3\) Processing transf.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 2 of 3\) Processing noop.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 3 of 3\) Processing clf.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">()), (</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)]),</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 2 of 2\) Processing clf.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">), (</span><span class="s4">&quot;mult&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">())]),</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 2 of 2\) Processing mult.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">), (</span><span class="s4">&quot;mult&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">())]),</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 1 of 2\) Processing transf.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[Pipeline\].*\(step 2 of 2\) Processing mult.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;mult1&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">()), (</span><span class="s4">&quot;mult2&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">())]),</span>
                <span class="s4">r&quot;\[FeatureUnion\].*\(step 1 of 2\) Processing mult1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[FeatureUnion\].*\(step 2 of 2\) Processing mult2.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;mult1&quot;</span><span class="s3">, </span><span class="s4">&quot;drop&quot;</span><span class="s3">), (</span><span class="s4">&quot;mult2&quot;</span><span class="s3">, </span><span class="s1">Mult</span><span class="s3">()), (</span><span class="s4">&quot;mult3&quot;</span><span class="s3">, </span><span class="s4">&quot;drop&quot;</span><span class="s3">)]),</span>
                <span class="s4">r&quot;\[FeatureUnion\].*\(step 1 of 1\) Processing mult2.* total=.*\n$&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">],</span>
        <span class="s3">[</span><span class="s4">&quot;fit&quot;</span><span class="s3">, </span><span class="s4">&quot;fit_transform&quot;</span><span class="s3">, </span><span class="s4">&quot;fit_predict&quot;</span><span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
    <span class="s2">and not </span><span class="s3">(</span>
        <span class="s1">method </span><span class="s3">== </span><span class="s4">&quot;fit_transform&quot;</span>
        <span class="s2">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s4">&quot;steps&quot;</span><span class="s3">)</span>
        <span class="s2">and </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">est</span><span class="s3">.</span><span class="s1">steps</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">][</span><span class="s5">1</span><span class="s3">], </span><span class="s1">FitParamT</span><span class="s3">)</span>
    <span class="s3">)</span>
<span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;est, pattern, method&quot;</span><span class="s3">, </span><span class="s1">parameter_grid_test_verbose</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_verbose</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">capsys</span><span class="s3">):</span>
    <span class="s1">func </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [[</span><span class="s5">7</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">]]</span>

    <span class="s1">est</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">verbose</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">func</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">().</span><span class="s1">out</span><span class="s3">, </span><span class="s4">&quot;Got output for verbose=False&quot;</span>

    <span class="s1">est</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">verbose</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">func</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">re</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">pattern</span><span class="s3">, </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">().</span><span class="s1">out</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_n_features_in_pipeline</span><span class="s3">():</span>
    <span class="s6"># make sure pipelines delegate n_features_in to the first step</span>

    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

    <span class="s1">ss </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">gbdt </span><span class="s3">= </span><span class="s1">HistGradientBoostingClassifier</span><span class="s3">()</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">, </span><span class="s1">gbdt</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">, </span><span class="s4">&quot;n_features_in_&quot;</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s5">2</span>

    <span class="s6"># if the first step has the n_features_in attribute then the pipeline also</span>
    <span class="s6"># has it, even though it isn't fitted.</span>
    <span class="s1">ss </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">gbdt </span><span class="s3">= </span><span class="s1">HistGradientBoostingClassifier</span><span class="s3">()</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">, </span><span class="s1">gbdt</span><span class="s3">)</span>
    <span class="s1">ss</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s5">2</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">gbdt</span><span class="s3">, </span><span class="s4">&quot;n_features_in_&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_n_features_in_feature_union</span><span class="s3">():</span>
    <span class="s6"># make sure FeatureUnion delegates n_features_in to the first transformer</span>

    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

    <span class="s1">ss </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">fu </span><span class="s3">= </span><span class="s1">make_union</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">fu</span><span class="s3">, </span><span class="s4">&quot;n_features_in_&quot;</span><span class="s3">)</span>
    <span class="s1">fu</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">fu</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s5">2</span>

    <span class="s6"># if the first step has the n_features_in attribute then the feature_union</span>
    <span class="s6"># also has it, even though it isn't fitted.</span>
    <span class="s1">ss </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">fu </span><span class="s3">= </span><span class="s1">make_union</span><span class="s3">(</span><span class="s1">ss</span><span class="s3">)</span>
    <span class="s1">ss</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">fu</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s1">ss</span><span class="s3">.</span><span class="s1">n_features_in_ </span><span class="s3">== </span><span class="s5">2</span>


<span class="s2">def </span><span class="s1">test_feature_union_fit_params</span><span class="s3">():</span>
    <span class="s6"># Regression test for issue: #15117</span>
    <span class="s2">class </span><span class="s1">DummyTransformer</span><span class="s3">(</span><span class="s1">TransformerMixin</span><span class="s3">, </span><span class="s1">BaseEstimator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, **</span><span class="s1">fit_params</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">fit_params </span><span class="s3">!= {</span><span class="s4">&quot;a&quot;</span><span class="s3">: </span><span class="s5">0</span><span class="s3">}:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">X</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">t </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;dummy0&quot;</span><span class="s3">, </span><span class="s1">DummyTransformer</span><span class="s3">()), (</span><span class="s4">&quot;dummy1&quot;</span><span class="s3">, </span><span class="s1">DummyTransformer</span><span class="s3">())])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">t</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">t</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">t</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">a</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">t</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">a</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_fit_params_without_fit_transform</span><span class="s3">():</span>
    <span class="s6"># Test that metadata is passed correctly to underlying transformers that don't</span>
    <span class="s6"># implement a `fit_transform` method when SLEP6 is not enabled.</span>

    <span class="s2">class </span><span class="s1">DummyTransformer</span><span class="s3">(</span><span class="s1">ConsumingNoFitTransformTransformer</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, **</span><span class="s1">fit_params</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">fit_params </span><span class="s3">!= {</span><span class="s4">&quot;metadata&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">}:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span>
            <span class="s2">return </span><span class="s1">self</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">t </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;nofittransform0&quot;</span><span class="s3">, </span><span class="s1">DummyTransformer</span><span class="s3">()),</span>
            <span class="s3">(</span><span class="s4">&quot;nofittransform1&quot;</span><span class="s3">, </span><span class="s1">DummyTransformer</span><span class="s3">()),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">t</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">t</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_missing_values_leniency</span><span class="s3">():</span>
    <span class="s6"># check that pipeline let the missing values validation to</span>
    <span class="s6"># the underlying transformers and predictors.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s1">mask </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">choice</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=[</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">bool</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s1">mask</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">SimpleImputer</span><span class="s3">(), </span><span class="s1">LogisticRegression</span><span class="s3">())</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) &gt; </span><span class="s5">0.4</span>


<span class="s2">def </span><span class="s1">test_feature_union_warns_unknown_transformer_weight</span><span class="s3">():</span>
    <span class="s6"># Warn user when transformer_weights containers a key not present in</span>
    <span class="s6"># transformer_list</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

    <span class="s1">transformer_list </span><span class="s3">= [(</span><span class="s4">&quot;transf&quot;</span><span class="s3">, </span><span class="s1">Transf</span><span class="s3">())]</span>
    <span class="s6"># Transformer weights dictionary with incorrect name</span>
    <span class="s1">weights </span><span class="s3">= {</span><span class="s4">&quot;transformer&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">}</span>
    <span class="s1">expected_msg </span><span class="s3">= (</span>
        <span class="s4">'Attempting to weight transformer &quot;transformer&quot;, '</span>
        <span class="s4">&quot;but it is not present in transformer_list.&quot;</span>
    <span class="s3">)</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span><span class="s1">transformer_list</span><span class="s3">, </span><span class="s1">transformer_weights</span><span class="s3">=</span><span class="s1">weights</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">expected_msg</span><span class="s3">):</span>
        <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_pipeline_get_tags_none</span><span class="s3">(</span><span class="s1">passthrough</span><span class="s3">):</span>
    <span class="s6"># Checks that tags are set correctly when the first transformer is None or</span>
    <span class="s6"># 'passthrough'</span>
    <span class="s6"># Non-regression test for:</span>
    <span class="s6"># https://github.com/scikit-learn/scikit-learn/issues/18815</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">passthrough</span><span class="s3">, </span><span class="s1">SVC</span><span class="s3">())</span>
    <span class="s2">assert not </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">_get_tags</span><span class="s3">()[</span><span class="s4">&quot;pairwise&quot;</span><span class="s3">]</span>


<span class="s6"># FIXME: Replace this test with a full `check_estimator` once we have API only</span>
<span class="s6"># checks.</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;Predictor&quot;</span><span class="s3">, [</span><span class="s1">MinimalRegressor</span><span class="s3">, </span><span class="s1">MinimalClassifier</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_search_cv_using_minimal_compatible_estimator</span><span class="s3">(</span><span class="s1">Predictor</span><span class="s3">):</span>
    <span class="s6"># Check that third-party library estimators can be part of a pipeline</span>
    <span class="s6"># and tuned by grid-search without inheriting from BaseEstimator.</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">25</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">] * </span><span class="s5">5 </span><span class="s3">+ [</span><span class="s5">1</span><span class="s3">] * </span><span class="s5">20</span><span class="s3">)</span>

    <span class="s1">model </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;transformer&quot;</span><span class="s3">, </span><span class="s1">MinimalTransformer</span><span class="s3">()), (</span><span class="s4">&quot;predictor&quot;</span><span class="s3">, </span><span class="s1">Predictor</span><span class="s3">())]</span>
    <span class="s3">)</span>
    <span class="s1">model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">is_classifier</span><span class="s3">(</span><span class="s1">model</span><span class="s3">):</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">y_pred</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">model</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s1">accuracy_score</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y_pred</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">model</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s1">r2_score</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_pipeline_check_if_fitted</span><span class="s3">():</span>
    <span class="s2">class </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fitted_ </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s2">return </span><span class="s1">self</span>

    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">Estimator</span><span class="s3">())])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">)</span>
    <span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_check_if_fitted</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check __sklearn_is_fitted__ is defined correctly.&quot;&quot;&quot;</span>

    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">MinimalTransformer</span><span class="s3">())])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">union</span><span class="s3">)</span>

    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">union</span><span class="s3">)</span>

    <span class="s6"># passthrough is stateless</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;pass&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)])</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">union</span><span class="s3">)</span>

    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;clf&quot;</span><span class="s3">, </span><span class="s1">MinimalTransformer</span><span class="s3">()), (</span><span class="s4">&quot;pass&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">union</span><span class="s3">)</span>

    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">check_is_fitted</span><span class="s3">(</span><span class="s1">union</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_pipeline_get_feature_names_out_passes_names_through</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that pipeline passes names through. 
 
    Non-regresion test for #21349. 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>

    <span class="s2">class </span><span class="s1">AddPrefixStandardScalar</span><span class="s3">(</span><span class="s1">StandardScaler</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">input_features</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
            <span class="s1">names </span><span class="s3">= </span><span class="s1">super</span><span class="s3">().</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">input_features</span><span class="s3">=</span><span class="s1">input_features</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s4">f&quot;my_prefix_</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">names</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">)</span>

    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">AddPrefixStandardScalar</span><span class="s3">(), </span><span class="s1">StandardScaler</span><span class="s3">())</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">input_names </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span>
    <span class="s1">feature_names_out </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">input_names</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">feature_names_out</span><span class="s3">, [</span><span class="s4">f&quot;my_prefix_</span><span class="s2">{</span><span class="s1">name</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">input_names</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_pipeline_set_output_integration</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test pipeline's set_output with feature names.&quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">make_pipeline</span><span class="s3">(</span><span class="s1">StandardScaler</span><span class="s3">(), </span><span class="s1">LogisticRegression</span><span class="s3">())</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">feature_names_in_ </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">].</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s1">log_reg_feature_names </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">].</span><span class="s1">feature_names_in_</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">feature_names_in_</span><span class="s3">, </span><span class="s1">log_reg_feature_names</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_set_output</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test feature union with set_output API.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">X_train</span><span class="s3">, </span><span class="s1">X_test </span><span class="s3">= </span><span class="s1">train_test_split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;scalar&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">()), (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">PCA</span><span class="s3">())])</span>
    <span class="s1">union</span><span class="s3">.</span><span class="s1">set_output</span><span class="s3">(</span><span class="s1">transform</span><span class="s3">=</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>
    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">)</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">union</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">union</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">())</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">.</span><span class="s1">index</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_feature_union_getitem</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check FeatureUnion.__getitem__ returns expected results.&quot;&quot;&quot;</span>
    <span class="s1">scalar </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">pca </span><span class="s3">= </span><span class="s1">PCA</span><span class="s3">()</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s4">&quot;scalar&quot;</span><span class="s3">, </span><span class="s1">scalar</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">pca</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;pass&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s4">&quot;drop_me&quot;</span><span class="s3">, </span><span class="s4">&quot;drop&quot;</span><span class="s3">),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">union</span><span class="s3">[</span><span class="s4">&quot;scalar&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">scalar</span>
    <span class="s2">assert </span><span class="s1">union</span><span class="s3">[</span><span class="s4">&quot;pca&quot;</span><span class="s3">] </span><span class="s2">is </span><span class="s1">pca</span>
    <span class="s2">assert </span><span class="s1">union</span><span class="s3">[</span><span class="s4">&quot;pass&quot;</span><span class="s3">] == </span><span class="s4">&quot;passthrough&quot;</span>
    <span class="s2">assert </span><span class="s1">union</span><span class="s3">[</span><span class="s4">&quot;drop_me&quot;</span><span class="s3">] == </span><span class="s4">&quot;drop&quot;</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;key&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">slice</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_feature_union_getitem_error</span><span class="s3">(</span><span class="s1">key</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Raise error when __getitem__ gets a non-string input.&quot;&quot;&quot;</span>

    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;scalar&quot;</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">()), (</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">PCA</span><span class="s3">())])</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Only string keys are supported&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">union</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_feature_union_feature_names_in_</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Ensure feature union has `.feature_names_in_` attribute if `X` has a 
    `columns` attribute. 
 
    Test for #24754. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s4">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">load_iris</span><span class="s3">(</span><span class="s1">as_frame</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">return_X_y</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s6"># FeatureUnion should have the feature_names_in_ attribute if the</span>
    <span class="s6"># first transformer also has it</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;scale&quot;</span><span class="s3">, </span><span class="s1">scaler</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">union</span><span class="s3">, </span><span class="s4">&quot;feature_names_in_&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">union</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">, </span><span class="s1">union</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">)</span>

    <span class="s6"># fit with pandas.DataFrame</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;pass&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)])</span>
    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">union</span><span class="s3">, </span><span class="s4">&quot;feature_names_in_&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">union</span><span class="s3">.</span><span class="s1">feature_names_in_</span><span class="s3">)</span>

    <span class="s6"># fit with numpy array</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">to_numpy</span><span class="s3">()</span>
    <span class="s1">union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;pass&quot;</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">)])</span>
    <span class="s1">union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">union</span><span class="s3">, </span><span class="s4">&quot;feature_names_in_&quot;</span><span class="s3">)</span>


<span class="s6"># TODO(1.7): remove this test</span>
<span class="s2">def </span><span class="s1">test_pipeline_inverse_transform_Xt_deprecation</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">0</span><span class="s3">).</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">))</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;pca&quot;</span><span class="s3">, </span><span class="s1">PCA</span><span class="s3">(</span><span class="s1">n_components</span><span class="s3">=</span><span class="s5">2</span><span class="s3">))])</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Missing required positional argument&quot;</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Cannot use both X and Xt. Use X only&quot;</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">=</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Xt</span><span class="s3">=</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s4">&quot;error&quot;</span><span class="s3">)</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Xt was renamed X in version 1.5&quot;</span><span class="s3">):</span>
        <span class="s1">pipe</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">Xt</span><span class="s3">=</span><span class="s1">X</span><span class="s3">)</span>


<span class="s6"># Test that metadata is routed correctly for pipelines and FeatureUnion</span>
<span class="s6"># =====================================================================</span>


<span class="s2">class </span><span class="s1">SimpleEstimator</span><span class="s3">(</span><span class="s1">BaseEstimator</span><span class="s3">):</span>
    <span class="s6"># This class is used in this section for testing routing in the pipeline.</span>
    <span class="s6"># This class should have every set_{method}_request</span>
    <span class="s2">def </span><span class="s1">fit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">fit_predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">predict</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">score</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>

    <span class="s2">def </span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">sample_weight </span><span class="s2">is not None</span>
        <span class="s2">assert </span><span class="s1">prop </span><span class="s2">is not None</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s6"># split and partial_fit not relevant for pipelines</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">METHODS</span><span class="s3">) - {</span><span class="s4">&quot;split&quot;</span><span class="s3">, </span><span class="s4">&quot;partial_fit&quot;</span><span class="s3">}))</span>
<span class="s2">def </span><span class="s1">test_metadata_routing_for_pipeline</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that metadata is routed correctly for pipelines.&quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">set_request</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, **</span><span class="s1">kwarg</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Set requests for a given method. 
 
        If the given method is a composite method, set the same requests for 
        all the methods that compose it. 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">method </span><span class="s2">in </span><span class="s1">COMPOSITE_METHODS</span><span class="s3">:</span>
            <span class="s1">methods </span><span class="s3">= </span><span class="s1">COMPOSITE_METHODS</span><span class="s3">[</span><span class="s1">method</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">methods </span><span class="s3">= [</span><span class="s1">method</span><span class="s3">]</span>

        <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s1">methods</span><span class="s3">:</span>
            <span class="s1">getattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s4">f&quot;set_</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">_request&quot;</span><span class="s3">)(**</span><span class="s1">kwarg</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">est</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">, </span><span class="s1">metadata </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;a&quot;</span><span class="s3">, </span><span class="s4">&quot;b&quot;</span>

    <span class="s6"># test that metadata is routed correctly for pipelines when requested</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">SimpleEstimator</span><span class="s3">()</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">set_request</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">set_request</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s4">&quot;fit&quot;</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">trs </span><span class="s3">= (</span>
        <span class="s1">ConsumingTransformer</span><span class="s3">()</span>
        <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">.</span><span class="s1">set_inverse_transform_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;trs&quot;</span><span class="s3">, </span><span class="s1">trs</span><span class="s3">), (</span><span class="s4">&quot;estimator&quot;</span><span class="s3">, </span><span class="s1">est</span><span class="s3">)])</span>

    <span class="s2">if </span><span class="s4">&quot;fit&quot; </span><span class="s2">not in </span><span class="s1">method</span><span class="s3">:</span>
        <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">], </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s1">prop</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
        <span class="s3">)</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span>
            <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s1">prop</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
        <span class="s3">)</span>
    <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
        <span class="s6"># Some methods don't accept y</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span>
            <span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s1">prop</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
        <span class="s3">)</span>

    <span class="s6"># Make sure the transformer has received the metadata</span>
    <span class="s6"># For the transformer, always only `fit` and `transform` are called.</span>
    <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
        <span class="s1">obj</span><span class="s3">=</span><span class="s1">trs</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;fit&quot;</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
    <span class="s3">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
        <span class="s1">obj</span><span class="s3">=</span><span class="s1">trs</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;transform&quot;</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s6"># split and partial_fit not relevant for pipelines</span>
<span class="s6"># sorted is here needed to make `pytest -nX` work. W/o it, tests are collected</span>
<span class="s6"># in different orders between workers and that makes it fail.</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">METHODS</span><span class="s3">) - {</span><span class="s4">&quot;split&quot;</span><span class="s3">, </span><span class="s4">&quot;partial_fit&quot;</span><span class="s3">}))</span>
<span class="s2">def </span><span class="s1">test_metadata_routing_error_for_pipeline</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that metadata is not routed for pipelines when not requested.&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">]</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;a&quot;</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">SimpleEstimator</span><span class="s3">()</span>
    <span class="s6"># here not setting sample_weight request and leaving it as None</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;estimator&quot;</span><span class="s3">, </span><span class="s1">est</span><span class="s3">)])</span>
    <span class="s1">error_message </span><span class="s3">= (</span>
        <span class="s4">&quot;[sample_weight, prop] are passed but are not explicitly set as requested&quot;</span>
        <span class="s4">f&quot; or not requested for SimpleEstimator.</span><span class="s2">{</span><span class="s1">method</span><span class="s2">}</span><span class="s4">&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">error_message</span><span class="s3">)):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s6"># passing X, y positional as the first two arguments</span>
            <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s1">prop</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">TypeError</span><span class="s3">:</span>
            <span class="s6"># not all methods accept y (like `predict`), so here we only</span>
            <span class="s6"># pass X as a positional arg.</span>
            <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">prop</span><span class="s3">=</span><span class="s1">prop</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s4">&quot;decision_function&quot;</span><span class="s3">, </span><span class="s4">&quot;transform&quot;</span><span class="s3">, </span><span class="s4">&quot;inverse_transform&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_routing_passed_metadata_not_supported</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that the right error message is raised when metadata is passed while 
    not supported when `enable_metadata_routing=False`.&quot;&quot;&quot;</span>

    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;estimator&quot;</span><span class="s3">, </span><span class="s1">SimpleEstimator</span><span class="s3">())])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
        <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;is only supported if enable_metadata_routing=True&quot;</span>
    <span class="s3">):</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">pipe</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)([[</span><span class="s5">1</span><span class="s3">]], </span><span class="s1">sample_weight</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">prop</span><span class="s3">=</span><span class="s4">&quot;a&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_pipeline_with_estimator_with_len</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test that pipeline works with estimators that have a `__len__` method.&quot;&quot;&quot;</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">(</span>
        <span class="s3">[(</span><span class="s4">&quot;trs&quot;</span><span class="s3">, </span><span class="s1">RandomTreesEmbedding</span><span class="s3">()), (</span><span class="s4">&quot;estimator&quot;</span><span class="s3">, </span><span class="s1">RandomForestClassifier</span><span class="s3">())]</span>
    <span class="s3">)</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">pipe</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;last_step&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_pipeline_with_no_last_step</span><span class="s3">(</span><span class="s1">last_step</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that the pipeline works when there is not last step. 
 
    It should just ignore and pass through the data on transform. 
    &quot;&quot;&quot;</span>
    <span class="s1">pipe </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s4">&quot;trs&quot;</span><span class="s3">, </span><span class="s1">FunctionTransformer</span><span class="s3">()), (</span><span class="s4">&quot;estimator&quot;</span><span class="s3">, </span><span class="s1">last_step</span><span class="s3">)])</span>
    <span class="s2">assert </span><span class="s1">pipe</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">]).</span><span class="s1">transform</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">]]) == [[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">]]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_union_metadata_routing_error</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test that the right error is raised when metadata is not requested.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]])</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;a&quot;</span>

    <span class="s6"># test lacking set_fit_request</span>
    <span class="s1">feature_union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;sub_transformer&quot;</span><span class="s3">, </span><span class="s1">ConsumingTransformer</span><span class="s3">())])</span>

    <span class="s1">error_message </span><span class="s3">= (</span>
        <span class="s4">&quot;[sample_weight, metadata] are passed but are not explicitly set as requested&quot;</span>
        <span class="s4">f&quot; or not requested for </span><span class="s2">{</span><span class="s1">ConsumingTransformer</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s4">.fit&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">UnsetMetadataPassedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">error_message</span><span class="s3">)):</span>
        <span class="s1">feature_union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>

    <span class="s6"># test lacking set_transform_request</span>
    <span class="s1">feature_union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s4">&quot;sub_transformer&quot;</span><span class="s3">,</span>
                <span class="s1">ConsumingTransformer</span><span class="s3">().</span><span class="s1">set_fit_request</span><span class="s3">(</span>
                    <span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span>
                <span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">error_message </span><span class="s3">= (</span>
        <span class="s4">&quot;[sample_weight, metadata] are passed but are not explicitly set as requested &quot;</span>
        <span class="s4">f&quot;or not requested for </span><span class="s2">{</span><span class="s1">ConsumingTransformer</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">}</span><span class="s4">.transform&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">UnsetMetadataPassedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s1">error_message</span><span class="s3">)):</span>
        <span class="s1">feature_union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span>
            <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span>
        <span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s1">metadata</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_union_get_metadata_routing_without_fit</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Test that get_metadata_routing() works regardless of the Child's 
    consumption of any metadata.&quot;&quot;&quot;</span>
    <span class="s1">feature_union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">([(</span><span class="s4">&quot;sub_transformer&quot;</span><span class="s3">, </span><span class="s1">ConsumingTransformer</span><span class="s3">())])</span>
    <span class="s1">feature_union</span><span class="s3">.</span><span class="s1">get_metadata_routing</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">usefixtures</span><span class="s3">(</span><span class="s4">&quot;enable_slep006&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s4">&quot;transformer&quot;</span><span class="s3">, [</span><span class="s1">ConsumingTransformer</span><span class="s3">, </span><span class="s1">ConsumingNoFitTransformTransformer</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_feature_union_metadata_routing</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test that metadata is routed correctly for FeatureUnion.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]])</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
    <span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">metadata </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s4">&quot;a&quot;</span>

    <span class="s1">feature_union </span><span class="s3">= </span><span class="s1">FeatureUnion</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s4">&quot;sub_trans1&quot;</span><span class="s3">,</span>
                <span class="s1">transformer</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">=</span><span class="s1">_Registry</span><span class="s3">())</span>
                <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s4">&quot;sub_trans2&quot;</span><span class="s3">,</span>
                <span class="s1">transformer</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">=</span><span class="s1">_Registry</span><span class="s3">())</span>
                <span class="s3">.</span><span class="s1">set_fit_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s3">.</span><span class="s1">set_transform_request</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">metadata</span><span class="s3">=</span><span class="s2">True</span><span class="s3">),</span>
            <span class="s3">),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">kwargs </span><span class="s3">= {</span><span class="s4">&quot;sample_weight&quot;</span><span class="s3">: </span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s4">&quot;metadata&quot;</span><span class="s3">: </span><span class="s1">metadata</span><span class="s3">}</span>
    <span class="s1">feature_union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">feature_union</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">feature_union</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">transformer </span><span class="s2">in </span><span class="s1">feature_union</span><span class="s3">.</span><span class="s1">transformer_list</span><span class="s3">:</span>
        <span class="s6"># access sub-transformer in (name, trans) with transformer[1]</span>
        <span class="s1">registry </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">registry</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">registry</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">sub_trans </span><span class="s2">in </span><span class="s1">registry</span><span class="s3">:</span>
            <span class="s1">check_recorded_metadata</span><span class="s3">(</span>
                <span class="s1">obj</span><span class="s3">=</span><span class="s1">sub_trans</span><span class="s3">,</span>
                <span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;fit&quot;</span><span class="s3">,</span>
                <span class="s3">**</span><span class="s1">kwargs</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s6"># End of routing tests</span>
<span class="s6"># ====================</span>
</pre>
</body>
</html>