<html>
<head>
<title>threadpoolctl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
threadpoolctl.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;threadpoolctl 
 
This module provides utilities to introspect native libraries that relies on 
thread pools (notably BLAS and OpenMP implementations) and dynamically set the 
maximal number of threads they can use. 
&quot;&quot;&quot;</span>

<span class="s2"># License: BSD 3-Clause</span>

<span class="s2"># The code to introspect dynamically loaded libraries on POSIX systems is</span>
<span class="s2"># adapted from code by Intel developer @anton-malakhov available at</span>
<span class="s2"># https://github.com/IntelPython/smp (Copyright (c) 2017, Intel Corporation)</span>
<span class="s2"># and also published under the BSD 3-Clause license</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">import </span><span class="s1">ctypes</span>
<span class="s3">import </span><span class="s1">itertools</span>
<span class="s3">import </span><span class="s1">textwrap</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">final</span>
<span class="s3">import </span><span class="s1">warnings</span>
<span class="s3">from </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">util </span><span class="s3">import </span><span class="s1">find_library</span>
<span class="s3">from </span><span class="s1">abc </span><span class="s3">import </span><span class="s1">ABC</span><span class="s4">, </span><span class="s1">abstractmethod</span>
<span class="s3">from </span><span class="s1">functools </span><span class="s3">import </span><span class="s1">lru_cache</span>
<span class="s3">from </span><span class="s1">contextlib </span><span class="s3">import </span><span class="s1">ContextDecorator</span>

<span class="s1">__version__ </span><span class="s4">= </span><span class="s5">&quot;3.5.0&quot;</span>
<span class="s1">__all__ </span><span class="s4">= [</span>
    <span class="s5">&quot;threadpool_limits&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;threadpool_info&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;ThreadpoolController&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;LibController&quot;</span><span class="s4">,</span>
    <span class="s5">&quot;register&quot;</span><span class="s4">,</span>
<span class="s4">]</span>


<span class="s2"># One can get runtime errors or even segfaults due to multiple OpenMP libraries</span>
<span class="s2"># loaded simultaneously which can happen easily in Python when importing and</span>
<span class="s2"># using compiled extensions built with different compilers and therefore</span>
<span class="s2"># different OpenMP runtimes in the same program. In particular libiomp (used by</span>
<span class="s2"># Intel ICC) and libomp used by clang/llvm tend to crash. This can happen for</span>
<span class="s2"># instance when calling BLAS inside a prange. Setting the following environment</span>
<span class="s2"># variable allows multiple OpenMP libraries to be loaded. It should not degrade</span>
<span class="s2"># performances since we manually take care of potential over-subscription</span>
<span class="s2"># performance issues, in sections of the code where nested OpenMP loops can</span>
<span class="s2"># happen, by dynamically reconfiguring the inner OpenMP runtime to temporarily</span>
<span class="s2"># disable it while under the scope of the outer OpenMP parallel section.</span>
<span class="s1">os</span><span class="s4">.</span><span class="s1">environ</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s5">&quot;KMP_DUPLICATE_LIB_OK&quot;</span><span class="s4">, </span><span class="s5">&quot;True&quot;</span><span class="s4">)</span>

<span class="s2"># Structure to cast the info on dynamically loaded library. See</span>
<span class="s2"># https://linux.die.net/man/3/dl_iterate_phdr for more details.</span>
<span class="s1">_SYSTEM_UINT </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_uint64 </span><span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">maxsize </span><span class="s4">&gt; </span><span class="s6">2</span><span class="s4">**</span><span class="s6">32 </span><span class="s3">else </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_uint32</span>
<span class="s1">_SYSTEM_UINT_HALF </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_uint32 </span><span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">maxsize </span><span class="s4">&gt; </span><span class="s6">2</span><span class="s4">**</span><span class="s6">32 </span><span class="s3">else </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_uint16</span>


<span class="s3">class </span><span class="s1">_dl_phdr_info</span><span class="s4">(</span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">Structure</span><span class="s4">):</span>
    <span class="s1">_fields_ </span><span class="s4">= [</span>
        <span class="s4">(</span><span class="s5">&quot;dlpi_addr&quot;</span><span class="s4">, </span><span class="s1">_SYSTEM_UINT</span><span class="s4">),  </span><span class="s2"># Base address of object</span>
        <span class="s4">(</span><span class="s5">&quot;dlpi_name&quot;</span><span class="s4">, </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span><span class="s4">),  </span><span class="s2"># path to the library</span>
        <span class="s4">(</span><span class="s5">&quot;dlpi_phdr&quot;</span><span class="s4">, </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_void_p</span><span class="s4">),  </span><span class="s2"># pointer on dlpi_headers</span>
        <span class="s4">(</span><span class="s5">&quot;dlpi_phnum&quot;</span><span class="s4">, </span><span class="s1">_SYSTEM_UINT_HALF</span><span class="s4">),  </span><span class="s2"># number of elements in dlpi_phdr</span>
    <span class="s4">]</span>


<span class="s2"># The RTLD_NOLOAD flag for loading shared libraries is not defined on Windows.</span>
<span class="s3">try</span><span class="s4">:</span>
    <span class="s1">_RTLD_NOLOAD </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">RTLD_NOLOAD</span>
<span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
    <span class="s1">_RTLD_NOLOAD </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">DEFAULT_MODE</span>


<span class="s3">class </span><span class="s1">LibController</span><span class="s4">(</span><span class="s1">ABC</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Abstract base class for the individual library controllers 
 
    A library controller must expose the following class attributes: 
        - user_api : str 
            Usually the name of the library or generic specification the library 
            implements, e.g. &quot;blas&quot; is a specification with different implementations. 
        - internal_api : str 
            Usually the name of the library or concrete implementation of some 
            specification, e.g. &quot;openblas&quot; is an implementation of the &quot;blas&quot; 
            specification. 
        - filename_prefixes : tuple 
            Possible prefixes of the shared library's filename that allow to 
            identify the library. e.g. &quot;libopenblas&quot; for libopenblas.so. 
 
    and implement the following methods: `get_num_threads`, `set_num_threads` and 
    `get_version`. 
 
    Threadpoolctl loops through all the loaded shared libraries and tries to match 
    the filename of each library with the `filename_prefixes`. If a match is found, a 
    controller is instantiated and a handler to the library is stored in the `dynlib` 
    attribute as a `ctypes.CDLL` object. It can be used to access the necessary symbols 
    of the shared library to implement the above methods. 
 
    The following information will be exposed in the info dictionary: 
      - user_api : standardized API, if any, or a copy of internal_api. 
      - internal_api : implementation-specific API. 
      - num_threads : the current thread limit. 
      - prefix : prefix of the shared library's filename. 
      - filepath : path to the loaded shared library. 
      - version : version of the library (if available). 
 
    In addition, each library controller may expose internal API specific entries. They 
    must be set as attributes in the `set_additional_attributes` method. 
    &quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">final</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *, </span><span class="s1">filepath</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;This is not meant to be overriden by subclasses.&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">parent </span><span class="s4">= </span><span class="s1">parent</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">prefix </span><span class="s4">= </span><span class="s1">prefix</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">filepath </span><span class="s4">= </span><span class="s1">filepath</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">CDLL</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">, </span><span class="s1">mode</span><span class="s4">=</span><span class="s1">_RTLD_NOLOAD</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_symbol_prefix</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_symbol_suffix </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_find_affixes</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">version </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_version</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">set_additional_attributes</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">info</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return relevant info wrapped in a dict&quot;&quot;&quot;</span>
        <span class="s1">hidden_attrs </span><span class="s4">= (</span><span class="s5">&quot;dynlib&quot;</span><span class="s4">, </span><span class="s5">&quot;parent&quot;</span><span class="s4">, </span><span class="s5">&quot;_symbol_prefix&quot;</span><span class="s4">, </span><span class="s5">&quot;_symbol_suffix&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s5">&quot;user_api&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">user_api</span><span class="s4">,</span>
            <span class="s5">&quot;internal_api&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">internal_api</span><span class="s4">,</span>
            <span class="s5">&quot;num_threads&quot;</span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">num_threads</span><span class="s4">,</span>
            <span class="s4">**{</span><span class="s1">k</span><span class="s4">: </span><span class="s1">v </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">vars</span><span class="s4">(</span><span class="s1">self</span><span class="s4">).</span><span class="s1">items</span><span class="s4">() </span><span class="s3">if </span><span class="s1">k </span><span class="s3">not in </span><span class="s1">hidden_attrs</span><span class="s4">},</span>
        <span class="s4">}</span>

    <span class="s3">def </span><span class="s1">set_additional_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Set additional attributes meant to be exposed in the info dict&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Exposes the current thread limit as a dynamic property 
 
        This is not meant to be used or overriden by subclasses. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">get_num_threads</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">def </span><span class="s1">get_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the maximum number of threads available to use&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">def </span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_threads</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Set the maximum number of threads to use&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">def </span><span class="s1">get_version</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the version of the shared library&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">_find_affixes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the affixes for the symbols of the shared library&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s5">&quot;&quot;</span><span class="s4">, </span><span class="s5">&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">_get_symbol</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the symbol of the shared library accounding for the affixes&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">getattr</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_symbol_prefix</span><span class="s3">}{</span><span class="s1">name</span><span class="s3">}{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_symbol_suffix</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s3">None</span>
        <span class="s4">)</span>


<span class="s3">class </span><span class="s1">OpenBLASController</span><span class="s4">(</span><span class="s1">LibController</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Controller class for OpenBLAS&quot;&quot;&quot;</span>

    <span class="s1">user_api </span><span class="s4">= </span><span class="s5">&quot;blas&quot;</span>
    <span class="s1">internal_api </span><span class="s4">= </span><span class="s5">&quot;openblas&quot;</span>
    <span class="s1">filename_prefixes </span><span class="s4">= (</span><span class="s5">&quot;libopenblas&quot;</span><span class="s4">, </span><span class="s5">&quot;libblas&quot;</span><span class="s4">, </span><span class="s5">&quot;libscipy_openblas&quot;</span><span class="s4">)</span>

    <span class="s1">_symbol_prefixes </span><span class="s4">= (</span><span class="s5">&quot;&quot;</span><span class="s4">, </span><span class="s5">&quot;scipy_&quot;</span><span class="s4">)</span>
    <span class="s1">_symbol_suffixes </span><span class="s4">= (</span><span class="s5">&quot;&quot;</span><span class="s4">, </span><span class="s5">&quot;64_&quot;</span><span class="s4">, </span><span class="s5">&quot;_64&quot;</span><span class="s4">)</span>

    <span class="s2"># All variations of &quot;openblas_get_num_threads&quot;, accounting for the affixes</span>
    <span class="s1">check_symbols </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span>
        <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">}</span><span class="s5">openblas_get_num_threads</span><span class="s3">{</span><span class="s1">suffix</span><span class="s3">}</span><span class="s5">&quot;</span>
        <span class="s3">for </span><span class="s1">prefix</span><span class="s4">, </span><span class="s1">suffix </span><span class="s3">in </span><span class="s1">itertools</span><span class="s4">.</span><span class="s1">product</span><span class="s4">(</span><span class="s1">_symbol_prefixes</span><span class="s4">, </span><span class="s1">_symbol_suffixes</span><span class="s4">)</span>
    <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_find_affixes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">prefix</span><span class="s4">, </span><span class="s1">suffix </span><span class="s3">in </span><span class="s1">itertools</span><span class="s4">.</span><span class="s1">product</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_symbol_prefixes</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_symbol_suffixes</span>
        <span class="s4">):</span>
            <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">prefix</span><span class="s3">}</span><span class="s5">openblas_get_num_threads</span><span class="s3">{</span><span class="s1">suffix</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s1">prefix</span><span class="s4">, </span><span class="s1">suffix</span>

    <span class="s3">def </span><span class="s1">set_additional_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">threading_layer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_threading_layer</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">architecture </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_architecture</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">get_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_num_threads_func </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_symbol</span><span class="s4">(</span><span class="s5">&quot;openblas_get_num_threads&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_num_threads_func </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">get_num_threads_func</span><span class="s4">()</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_threads</span><span class="s4">):</span>
        <span class="s1">set_num_threads_func </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_symbol</span><span class="s4">(</span><span class="s5">&quot;openblas_set_num_threads&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">set_num_threads_func </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">set_num_threads_func</span><span class="s4">(</span><span class="s1">num_threads</span><span class="s4">)</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">get_version</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2"># None means OpenBLAS is not loaded or version &lt; 0.3.4, since OpenBLAS</span>
        <span class="s2"># did not expose its version before that.</span>
        <span class="s1">get_version_func </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_symbol</span><span class="s4">(</span><span class="s5">&quot;openblas_get_config&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_version_func </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">get_version_func</span><span class="s4">.</span><span class="s1">restype </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span>
            <span class="s1">config </span><span class="s4">= </span><span class="s1">get_version_func</span><span class="s4">().</span><span class="s1">split</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">config</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s7">b&quot;OpenBLAS&quot;</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">config</span><span class="s4">[</span><span class="s6">1</span><span class="s4">].</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
            <span class="s3">return None</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">_get_threading_layer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the threading layer of OpenBLAS&quot;&quot;&quot;</span>
        <span class="s1">get_threading_layer_func </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_symbol</span><span class="s4">(</span><span class="s5">&quot;openblas_get_parallel&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_threading_layer_func </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">threading_layer </span><span class="s4">= </span><span class="s1">get_threading_layer_func</span><span class="s4">()</span>
            <span class="s3">if </span><span class="s1">threading_layer </span><span class="s4">== </span><span class="s6">2</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;openmp&quot;</span>
            <span class="s3">elif </span><span class="s1">threading_layer </span><span class="s4">== </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">&quot;pthreads&quot;</span>
            <span class="s3">return </span><span class="s5">&quot;disabled&quot;</span>
        <span class="s3">return </span><span class="s5">&quot;unknown&quot;</span>

    <span class="s3">def </span><span class="s1">_get_architecture</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the architecture detected by OpenBLAS&quot;&quot;&quot;</span>
        <span class="s1">get_architecture_func </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_symbol</span><span class="s4">(</span><span class="s5">&quot;openblas_get_corename&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_architecture_func </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">get_architecture_func</span><span class="s4">.</span><span class="s1">restype </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span>
            <span class="s3">return </span><span class="s1">get_architecture_func</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
        <span class="s3">return None</span>


<span class="s3">class </span><span class="s1">BLISController</span><span class="s4">(</span><span class="s1">LibController</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Controller class for BLIS&quot;&quot;&quot;</span>

    <span class="s1">user_api </span><span class="s4">= </span><span class="s5">&quot;blas&quot;</span>
    <span class="s1">internal_api </span><span class="s4">= </span><span class="s5">&quot;blis&quot;</span>
    <span class="s1">filename_prefixes </span><span class="s4">= (</span><span class="s5">&quot;libblis&quot;</span><span class="s4">, </span><span class="s5">&quot;libblas&quot;</span><span class="s4">)</span>
    <span class="s1">check_symbols </span><span class="s4">= (</span>
        <span class="s5">&quot;bli_thread_get_num_threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;bli_thread_set_num_threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;bli_info_get_version_str&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;bli_info_get_enable_openmp&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;bli_info_get_enable_pthreads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;bli_arch_query_id&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;bli_arch_string&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">set_additional_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">threading_layer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_threading_layer</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">architecture </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_architecture</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">get_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_thread_get_num_threads&quot;</span><span class="s4">, </span><span class="s3">lambda</span><span class="s4">: </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">num_threads </span><span class="s4">= </span><span class="s1">get_func</span><span class="s4">()</span>
        <span class="s2"># by default BLIS is single-threaded and get_num_threads</span>
        <span class="s2"># returns -1. We map it to 1 for consistency with other libraries.</span>
        <span class="s3">return </span><span class="s6">1 </span><span class="s3">if </span><span class="s1">num_threads </span><span class="s4">== -</span><span class="s6">1 </span><span class="s3">else </span><span class="s1">num_threads</span>

    <span class="s3">def </span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_threads</span><span class="s4">):</span>
        <span class="s1">set_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_thread_set_num_threads&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">num_threads</span><span class="s4">: </span><span class="s3">None</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">set_func</span><span class="s4">(</span><span class="s1">num_threads</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_version</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_version_ </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_info_get_version_str&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_version_ </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s1">get_version_</span><span class="s4">.</span><span class="s1">restype </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span>
        <span class="s3">return </span><span class="s1">get_version_</span><span class="s4">().</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_get_threading_layer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the threading layer of BLIS&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_info_get_enable_openmp&quot;</span><span class="s4">, </span><span class="s3">lambda</span><span class="s4">: </span><span class="s3">False</span><span class="s4">)():</span>
            <span class="s3">return </span><span class="s5">&quot;openmp&quot;</span>
        <span class="s3">elif </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_info_get_enable_pthreads&quot;</span><span class="s4">, </span><span class="s3">lambda</span><span class="s4">: </span><span class="s3">False</span><span class="s4">)():</span>
            <span class="s3">return </span><span class="s5">&quot;pthreads&quot;</span>
        <span class="s3">return </span><span class="s5">&quot;disabled&quot;</span>

    <span class="s3">def </span><span class="s1">_get_architecture</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the architecture detected by BLIS&quot;&quot;&quot;</span>
        <span class="s1">bli_arch_query_id </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_arch_query_id&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">bli_arch_string </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;bli_arch_string&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">bli_arch_query_id </span><span class="s3">is None or </span><span class="s1">bli_arch_string </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s2"># the true restype should be BLIS' arch_t (enum) but int should work</span>
        <span class="s2"># for us:</span>
        <span class="s1">bli_arch_query_id</span><span class="s4">.</span><span class="s1">restype </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_int</span>
        <span class="s1">bli_arch_string</span><span class="s4">.</span><span class="s1">restype </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span>
        <span class="s3">return </span><span class="s1">bli_arch_string</span><span class="s4">(</span><span class="s1">bli_arch_query_id</span><span class="s4">()).</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">FlexiBLASController</span><span class="s4">(</span><span class="s1">LibController</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Controller class for FlexiBLAS&quot;&quot;&quot;</span>

    <span class="s1">user_api </span><span class="s4">= </span><span class="s5">&quot;blas&quot;</span>
    <span class="s1">internal_api </span><span class="s4">= </span><span class="s5">&quot;flexiblas&quot;</span>
    <span class="s1">filename_prefixes </span><span class="s4">= (</span><span class="s5">&quot;libflexiblas&quot;</span><span class="s4">,)</span>
    <span class="s1">check_symbols </span><span class="s4">= (</span>
        <span class="s5">&quot;flexiblas_get_num_threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;flexiblas_set_num_threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;flexiblas_get_version&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;flexiblas_list&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;flexiblas_list_loaded&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;flexiblas_current_backend&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">loaded_backends</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_backend_list</span><span class="s4">(</span><span class="s1">loaded</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">current_backend</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_current_backend</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">info</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return relevant info wrapped in a dict&quot;&quot;&quot;</span>
        <span class="s2"># We override the info method because the loaded and current backends</span>
        <span class="s2"># are dynamic properties</span>
        <span class="s1">exposed_attrs </span><span class="s4">= </span><span class="s1">super</span><span class="s4">().</span><span class="s1">info</span><span class="s4">()</span>
        <span class="s1">exposed_attrs</span><span class="s4">[</span><span class="s5">&quot;loaded_backends&quot;</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">loaded_backends</span>
        <span class="s1">exposed_attrs</span><span class="s4">[</span><span class="s5">&quot;current_backend&quot;</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">current_backend</span>

        <span class="s3">return </span><span class="s1">exposed_attrs</span>

    <span class="s3">def </span><span class="s1">set_additional_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">available_backends </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_backend_list</span><span class="s4">(</span><span class="s1">loaded</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_get_num_threads&quot;</span><span class="s4">, </span><span class="s3">lambda</span><span class="s4">: </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s1">num_threads </span><span class="s4">= </span><span class="s1">get_func</span><span class="s4">()</span>
        <span class="s2"># by default BLIS is single-threaded and get_num_threads</span>
        <span class="s2"># returns -1. We map it to 1 for consistency with other libraries.</span>
        <span class="s3">return </span><span class="s6">1 </span><span class="s3">if </span><span class="s1">num_threads </span><span class="s4">== -</span><span class="s6">1 </span><span class="s3">else </span><span class="s1">num_threads</span>

    <span class="s3">def </span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_threads</span><span class="s4">):</span>
        <span class="s1">set_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_set_num_threads&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">num_threads</span><span class="s4">: </span><span class="s3">None</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">set_func</span><span class="s4">(</span><span class="s1">num_threads</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_version</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_version_ </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_get_version&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_version_ </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s1">major </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_int</span><span class="s4">()</span>
        <span class="s1">minor </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_int</span><span class="s4">()</span>
        <span class="s1">patch </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_int</span><span class="s4">()</span>
        <span class="s1">get_version_</span><span class="s4">(</span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">major</span><span class="s4">), </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">minor</span><span class="s4">), </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">patch</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">major</span><span class="s4">.</span><span class="s1">value</span><span class="s3">}</span><span class="s5">.</span><span class="s3">{</span><span class="s1">minor</span><span class="s4">.</span><span class="s1">value</span><span class="s3">}</span><span class="s5">.</span><span class="s3">{</span><span class="s1">patch</span><span class="s4">.</span><span class="s1">value</span><span class="s3">}</span><span class="s5">&quot;</span>

    <span class="s3">def </span><span class="s1">_get_backend_list</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">loaded</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the list of available backends for FlexiBLAS. 
 
        If loaded is False, return the list of available backends from the FlexiBLAS 
        configuration. If loaded is True, return the list of actually loaded backends. 
        &quot;&quot;&quot;</span>
        <span class="s1">func_name </span><span class="s4">= </span><span class="s5">f&quot;flexiblas_list</span><span class="s3">{</span><span class="s5">'_loaded' </span><span class="s3">if </span><span class="s1">loaded </span><span class="s3">else </span><span class="s5">''</span><span class="s3">}</span><span class="s5">&quot;</span>
        <span class="s1">get_backend_list_ </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s1">func_name</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_backend_list_ </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s1">n_backends </span><span class="s4">= </span><span class="s1">get_backend_list_</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s6">0</span><span class="s4">, </span><span class="s6">0</span><span class="s4">)</span>

        <span class="s1">backends </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">n_backends</span><span class="s4">):</span>
            <span class="s1">backend_name </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">create_string_buffer</span><span class="s4">(</span><span class="s6">1024</span><span class="s4">)</span>
            <span class="s1">get_backend_list_</span><span class="s4">(</span><span class="s1">backend_name</span><span class="s4">, </span><span class="s6">1024</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">backend_name</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">) != </span><span class="s5">&quot;__FALLBACK__&quot;</span><span class="s4">:</span>
                <span class="s2"># We don't know when to expect __FALLBACK__ but it is not a real</span>
                <span class="s2"># backend and does not show up when running flexiblas list.</span>
                <span class="s1">backends</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">backend_name</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">backends</span>

    <span class="s3">def </span><span class="s1">_get_current_backend</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the backend of FlexiBLAS&quot;&quot;&quot;</span>
        <span class="s1">get_backend_ </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_current_backend&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">get_backend_ </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s1">backend </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">create_string_buffer</span><span class="s4">(</span><span class="s6">1024</span><span class="s4">)</span>
        <span class="s1">get_backend_</span><span class="s4">(</span><span class="s1">backend</span><span class="s4">, </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">sizeof</span><span class="s4">(</span><span class="s1">backend</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">backend</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">switch_backend</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">backend</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Switch the backend of FlexiBLAS 
 
        Parameters 
        ---------- 
        backend : str 
            The name or the path to the shared library of the backend to switch to. If 
            the backend is not already loaded, it will be loaded first. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">backend </span><span class="s3">not in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">loaded_backends</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">backend </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">available_backends</span><span class="s4">:</span>
                <span class="s1">load_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_load_backend&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">_</span><span class="s4">: -</span><span class="s6">1</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:  </span><span class="s2"># assume backend is a path to a shared library</span>
                <span class="s1">load_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_load_backend_library&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">_</span><span class="s4">: -</span><span class="s6">1</span>
                <span class="s4">)</span>
            <span class="s1">res </span><span class="s4">= </span><span class="s1">load_func</span><span class="s4">(</span><span class="s1">str</span><span class="s4">(</span><span class="s1">backend</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">))</span>
            <span class="s3">if </span><span class="s1">res </span><span class="s4">== -</span><span class="s6">1</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">RuntimeError</span><span class="s4">(</span>
                    <span class="s5">f&quot;Failed to load backend </span><span class="s3">{</span><span class="s1">backend</span><span class="s3">!r}</span><span class="s5">. It must either be the name of&quot;</span>
                    <span class="s5">&quot; a backend available in the FlexiBLAS configuration &quot;</span>
                    <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">available_backends</span><span class="s3">} </span><span class="s5">or the path to a valid shared library.&quot;</span>
                <span class="s4">)</span>

            <span class="s2"># Trigger a new search of loaded shared libraries since loading a new</span>
            <span class="s2"># backend caused a dlopen.</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">parent</span><span class="s4">.</span><span class="s1">_load_libraries</span><span class="s4">()</span>

        <span class="s1">switch_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;flexiblas_switch&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">_</span><span class="s4">: -</span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">idx </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">loaded_backends</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">backend</span><span class="s4">)</span>
        <span class="s1">res </span><span class="s4">= </span><span class="s1">switch_func</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">res </span><span class="s4">== -</span><span class="s6">1</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">RuntimeError</span><span class="s4">(</span><span class="s5">f&quot;Failed to switch to backend </span><span class="s3">{</span><span class="s1">backend</span><span class="s3">!r}</span><span class="s5">.&quot;</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">MKLController</span><span class="s4">(</span><span class="s1">LibController</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Controller class for MKL&quot;&quot;&quot;</span>

    <span class="s1">user_api </span><span class="s4">= </span><span class="s5">&quot;blas&quot;</span>
    <span class="s1">internal_api </span><span class="s4">= </span><span class="s5">&quot;mkl&quot;</span>
    <span class="s1">filename_prefixes </span><span class="s4">= (</span><span class="s5">&quot;libmkl_rt&quot;</span><span class="s4">, </span><span class="s5">&quot;mkl_rt&quot;</span><span class="s4">, </span><span class="s5">&quot;libblas&quot;</span><span class="s4">)</span>
    <span class="s1">check_symbols </span><span class="s4">= (</span>
        <span class="s5">&quot;MKL_Get_Max_Threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;MKL_Set_Num_Threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;MKL_Get_Version_String&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;MKL_Set_Threading_Layer&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">set_additional_attributes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">threading_layer </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_threading_layer</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">get_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;MKL_Get_Max_Threads&quot;</span><span class="s4">, </span><span class="s3">lambda</span><span class="s4">: </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">get_func</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_threads</span><span class="s4">):</span>
        <span class="s1">set_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;MKL_Set_Num_Threads&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">num_threads</span><span class="s4">: </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">set_func</span><span class="s4">(</span><span class="s1">num_threads</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_version</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;MKL_Get_Version_String&quot;</span><span class="s4">):</span>
            <span class="s3">return None</span>

        <span class="s1">res </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">create_string_buffer</span><span class="s4">(</span><span class="s6">200</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">.</span><span class="s1">MKL_Get_Version_String</span><span class="s4">(</span><span class="s1">res</span><span class="s4">, </span><span class="s6">200</span><span class="s4">)</span>

        <span class="s1">version </span><span class="s4">= </span><span class="s1">res</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
        <span class="s1">group </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">search</span><span class="s4">(</span><span class="s5">r&quot;Version ([^ ]+) &quot;</span><span class="s4">, </span><span class="s1">version</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">group </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">version </span><span class="s4">= </span><span class="s1">group</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">()[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s3">return </span><span class="s1">version</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_get_threading_layer</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the threading layer of MKL&quot;&quot;&quot;</span>
        <span class="s2"># The function mkl_set_threading_layer returns the current threading</span>
        <span class="s2"># layer. Calling it with an invalid threading layer allows us to safely</span>
        <span class="s2"># get the threading layer</span>
        <span class="s1">set_threading_layer </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;MKL_Set_Threading_Layer&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">layer</span><span class="s4">: -</span><span class="s6">1</span>
        <span class="s4">)</span>
        <span class="s1">layer_map </span><span class="s4">= {</span>
            <span class="s6">0</span><span class="s4">: </span><span class="s5">&quot;intel&quot;</span><span class="s4">,</span>
            <span class="s6">1</span><span class="s4">: </span><span class="s5">&quot;sequential&quot;</span><span class="s4">,</span>
            <span class="s6">2</span><span class="s4">: </span><span class="s5">&quot;pgi&quot;</span><span class="s4">,</span>
            <span class="s6">3</span><span class="s4">: </span><span class="s5">&quot;gnu&quot;</span><span class="s4">,</span>
            <span class="s6">4</span><span class="s4">: </span><span class="s5">&quot;tbb&quot;</span><span class="s4">,</span>
            <span class="s4">-</span><span class="s6">1</span><span class="s4">: </span><span class="s5">&quot;not specified&quot;</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s3">return </span><span class="s1">layer_map</span><span class="s4">[</span><span class="s1">set_threading_layer</span><span class="s4">(-</span><span class="s6">1</span><span class="s4">)]</span>


<span class="s3">class </span><span class="s1">OpenMPController</span><span class="s4">(</span><span class="s1">LibController</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Controller class for OpenMP&quot;&quot;&quot;</span>

    <span class="s1">user_api </span><span class="s4">= </span><span class="s5">&quot;openmp&quot;</span>
    <span class="s1">internal_api </span><span class="s4">= </span><span class="s5">&quot;openmp&quot;</span>
    <span class="s1">filename_prefixes </span><span class="s4">= (</span><span class="s5">&quot;libiomp&quot;</span><span class="s4">, </span><span class="s5">&quot;libgomp&quot;</span><span class="s4">, </span><span class="s5">&quot;libomp&quot;</span><span class="s4">, </span><span class="s5">&quot;vcomp&quot;</span><span class="s4">)</span>
    <span class="s1">check_symbols </span><span class="s4">= (</span>
        <span class="s5">&quot;omp_get_max_threads&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;omp_get_num_threads&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">get_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;omp_get_max_threads&quot;</span><span class="s4">, </span><span class="s3">lambda</span><span class="s4">: </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">get_func</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">num_threads</span><span class="s4">):</span>
        <span class="s1">set_func </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s5">&quot;omp_set_num_threads&quot;</span><span class="s4">, </span><span class="s3">lambda </span><span class="s1">num_threads</span><span class="s4">: </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">set_func</span><span class="s4">(</span><span class="s1">num_threads</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_version</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2"># There is no way to get the version number programmatically in OpenMP.</span>
        <span class="s3">return None</span>


<span class="s2"># Controllers for the libraries that we'll look for in the loaded libraries.</span>
<span class="s2"># Third party libraries can register their own controllers.</span>
<span class="s1">_ALL_CONTROLLERS </span><span class="s4">= [</span>
    <span class="s1">OpenBLASController</span><span class="s4">,</span>
    <span class="s1">BLISController</span><span class="s4">,</span>
    <span class="s1">MKLController</span><span class="s4">,</span>
    <span class="s1">OpenMPController</span><span class="s4">,</span>
    <span class="s1">FlexiBLASController</span><span class="s4">,</span>
<span class="s4">]</span>

<span class="s2"># Helpers for the doc and test names</span>
<span class="s1">_ALL_USER_APIS </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">set</span><span class="s4">(</span><span class="s1">lib</span><span class="s4">.</span><span class="s1">user_api </span><span class="s3">for </span><span class="s1">lib </span><span class="s3">in </span><span class="s1">_ALL_CONTROLLERS</span><span class="s4">))</span>
<span class="s1">_ALL_INTERNAL_APIS </span><span class="s4">= [</span><span class="s1">lib</span><span class="s4">.</span><span class="s1">internal_api </span><span class="s3">for </span><span class="s1">lib </span><span class="s3">in </span><span class="s1">_ALL_CONTROLLERS</span><span class="s4">]</span>
<span class="s1">_ALL_PREFIXES </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span>
    <span class="s1">set</span><span class="s4">(</span><span class="s1">prefix </span><span class="s3">for </span><span class="s1">lib </span><span class="s3">in </span><span class="s1">_ALL_CONTROLLERS </span><span class="s3">for </span><span class="s1">prefix </span><span class="s3">in </span><span class="s1">lib</span><span class="s4">.</span><span class="s1">filename_prefixes</span><span class="s4">)</span>
<span class="s4">)</span>
<span class="s1">_ALL_BLAS_LIBRARIES </span><span class="s4">= [</span>
    <span class="s1">lib</span><span class="s4">.</span><span class="s1">internal_api </span><span class="s3">for </span><span class="s1">lib </span><span class="s3">in </span><span class="s1">_ALL_CONTROLLERS </span><span class="s3">if </span><span class="s1">lib</span><span class="s4">.</span><span class="s1">user_api </span><span class="s4">== </span><span class="s5">&quot;blas&quot;</span>
<span class="s4">]</span>
<span class="s1">_ALL_OPENMP_LIBRARIES </span><span class="s4">= </span><span class="s1">OpenMPController</span><span class="s4">.</span><span class="s1">filename_prefixes</span>


<span class="s3">def </span><span class="s1">register</span><span class="s4">(</span><span class="s1">controller</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Register a new controller&quot;&quot;&quot;</span>
    <span class="s1">_ALL_CONTROLLERS</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">controller</span><span class="s4">)</span>
    <span class="s1">_ALL_USER_APIS</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">controller</span><span class="s4">.</span><span class="s1">user_api</span><span class="s4">)</span>
    <span class="s1">_ALL_INTERNAL_APIS</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">controller</span><span class="s4">.</span><span class="s1">internal_api</span><span class="s4">)</span>
    <span class="s1">_ALL_PREFIXES</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">controller</span><span class="s4">.</span><span class="s1">filename_prefixes</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">_format_docstring</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">decorator</span><span class="s4">(</span><span class="s1">o</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">o</span><span class="s4">.</span><span class="s1">__doc__ </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">o</span><span class="s4">.</span><span class="s1">__doc__ </span><span class="s4">= </span><span class="s1">o</span><span class="s4">.</span><span class="s1">__doc__</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">o</span>

    <span class="s3">return </span><span class="s1">decorator</span>


<span class="s4">@</span><span class="s1">lru_cache</span><span class="s4">(</span><span class="s1">maxsize</span><span class="s4">=</span><span class="s6">10000</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">_realpath</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Small caching wrapper around os.path.realpath to limit system calls&quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">realpath</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">_format_docstring</span><span class="s4">(</span><span class="s1">USER_APIS</span><span class="s4">=</span><span class="s1">list</span><span class="s4">(</span><span class="s1">_ALL_USER_APIS</span><span class="s4">), </span><span class="s1">INTERNAL_APIS</span><span class="s4">=</span><span class="s1">_ALL_INTERNAL_APIS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">threadpool_info</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Return the maximal number of threads for each detected library. 
 
    Return a list with all the supported libraries that have been found. Each 
    library is represented by a dict with the following information: 
 
      - &quot;user_api&quot; : user API. Possible values are {USER_APIS}. 
      - &quot;internal_api&quot;: internal API. Possible values are {INTERNAL_APIS}. 
      - &quot;prefix&quot; : filename prefix of the specific implementation. 
      - &quot;filepath&quot;: path to the loaded library. 
      - &quot;version&quot;: version of the library (if available). 
      - &quot;num_threads&quot;: the current thread limit. 
 
    In addition, each library may contain internal_api specific entries. 
    &quot;&quot;&quot;</span>
    <span class="s3">return </span><span class="s1">ThreadpoolController</span><span class="s4">().</span><span class="s1">info</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">_ThreadpoolLimiter</span><span class="s4">:</span>
    <span class="s0">&quot;&quot;&quot;The guts of ThreadpoolController.limit 
 
    Refer to the docstring of ThreadpoolController.limit for more details. 
 
    It will only act on the library controllers held by the provided `controller`. 
    Using the default constructor sets the limits right away such that it can be used as 
    a callable. Setting the limits can be delayed by using the `wrap` class method such 
    that it can be used as a decorator. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">controller</span><span class="s4">, *, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_controller </span><span class="s4">= </span><span class="s1">controller</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_limits</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_user_api</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_prefixes </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_check_params</span><span class="s4">(</span>
            <span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_original_info </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_controller</span><span class="s4">.</span><span class="s1">info</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_threadpool_limits</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">__enter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span>

    <span class="s3">def </span><span class="s1">__exit__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">type</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">traceback</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">restore_original_limits</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">controller</span><span class="s4">, *, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return an instance of this class that can be used as a decorator&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">_ThreadpoolLimiterDecorator</span><span class="s4">(</span>
            <span class="s1">controller</span><span class="s4">=</span><span class="s1">controller</span><span class="s4">, </span><span class="s1">limits</span><span class="s4">=</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s1">user_api</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">restore_original_limits</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Set the limits back to their original values&quot;&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">lib_controller</span><span class="s4">, </span><span class="s1">original_info </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_controller</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_original_info</span>
        <span class="s4">):</span>
            <span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">original_info</span><span class="s4">[</span><span class="s5">&quot;num_threads&quot;</span><span class="s4">])</span>

    <span class="s2"># Alias of `restore_original_limits` for backward compatibility</span>
    <span class="s1">unregister </span><span class="s4">= </span><span class="s1">restore_original_limits</span>

    <span class="s3">def </span><span class="s1">get_original_num_threads</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Original num_threads from before calling threadpool_limits 
 
        Return a dict `{user_api: num_threads}`. 
        &quot;&quot;&quot;</span>
        <span class="s1">num_threads </span><span class="s4">= {}</span>
        <span class="s1">warning_apis </span><span class="s4">= []</span>

        <span class="s3">for </span><span class="s1">user_api </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_user_api</span><span class="s4">:</span>
            <span class="s1">limits </span><span class="s4">= [</span>
                <span class="s1">lib_info</span><span class="s4">[</span><span class="s5">&quot;num_threads&quot;</span><span class="s4">]</span>
                <span class="s3">for </span><span class="s1">lib_info </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_original_info</span>
                <span class="s3">if </span><span class="s1">lib_info</span><span class="s4">[</span><span class="s5">&quot;user_api&quot;</span><span class="s4">] == </span><span class="s1">user_api</span>
            <span class="s4">]</span>
            <span class="s1">limits </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">)</span>
            <span class="s1">n_limits </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s1">n_limits </span><span class="s4">== </span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">limit </span><span class="s4">= </span><span class="s1">limits</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">()</span>
            <span class="s3">elif </span><span class="s1">n_limits </span><span class="s4">== </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">limit </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">limit </span><span class="s4">= </span><span class="s1">min</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">)</span>
                <span class="s1">warning_apis</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">user_api</span><span class="s4">)</span>

            <span class="s1">num_threads</span><span class="s4">[</span><span class="s1">user_api</span><span class="s4">] = </span><span class="s1">limit</span>

        <span class="s3">if </span><span class="s1">warning_apis</span><span class="s4">:</span>
            <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                <span class="s5">&quot;Multiple value possible for following user apis: &quot;</span>
                <span class="s4">+ </span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">warning_apis</span><span class="s4">)</span>
                <span class="s4">+ </span><span class="s5">&quot;. Returning the minimum.&quot;</span>
            <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">num_threads</span>

    <span class="s3">def </span><span class="s1">_check_params</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Suitable values for the _limits, _user_api and _prefixes attributes&quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">and </span><span class="s1">limits </span><span class="s4">== </span><span class="s5">&quot;sequential_blas_under_openmp&quot;</span><span class="s4">:</span>
            <span class="s4">(</span>
                <span class="s1">limits</span><span class="s4">,</span>
                <span class="s1">user_api</span><span class="s4">,</span>
            <span class="s4">) = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_controller</span><span class="s4">.</span><span class="s1">_get_params_for_sequential_blas_under_openmp</span><span class="s4">().</span><span class="s1">values</span><span class="s4">()</span>

        <span class="s3">if </span><span class="s1">limits </span><span class="s3">is None or </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">int</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">user_api </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">user_api </span><span class="s4">= </span><span class="s1">_ALL_USER_APIS</span>
            <span class="s3">elif </span><span class="s1">user_api </span><span class="s3">in </span><span class="s1">_ALL_USER_APIS</span><span class="s4">:</span>
                <span class="s1">user_api </span><span class="s4">= [</span><span class="s1">user_api</span><span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                    <span class="s5">f&quot;user_api must be either in </span><span class="s3">{</span><span class="s1">_ALL_USER_APIS</span><span class="s3">} </span><span class="s5">or None. Got &quot;</span>
                    <span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">user_api</span><span class="s3">} </span><span class="s5">instead.&quot;</span>
                <span class="s4">)</span>

            <span class="s3">if </span><span class="s1">limits </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">limits </span><span class="s4">= {</span><span class="s1">api</span><span class="s4">: </span><span class="s1">limits </span><span class="s3">for </span><span class="s1">api </span><span class="s3">in </span><span class="s1">user_api</span><span class="s4">}</span>
            <span class="s1">prefixes </span><span class="s4">= []</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">list</span><span class="s4">):</span>
                <span class="s2"># This should be a list of dicts of library info, for</span>
                <span class="s2"># compatibility with the result from threadpool_info.</span>
                <span class="s1">limits </span><span class="s4">= {</span>
                    <span class="s1">lib_info</span><span class="s4">[</span><span class="s5">&quot;prefix&quot;</span><span class="s4">]: </span><span class="s1">lib_info</span><span class="s4">[</span><span class="s5">&quot;num_threads&quot;</span><span class="s4">] </span><span class="s3">for </span><span class="s1">lib_info </span><span class="s3">in </span><span class="s1">limits</span>
                <span class="s4">}</span>
            <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">ThreadpoolController</span><span class="s4">):</span>
                <span class="s2"># To set the limits from the library controllers of a</span>
                <span class="s2"># ThreadpoolController object.</span>
                <span class="s1">limits </span><span class="s4">= {</span>
                    <span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">prefix</span><span class="s4">: </span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">num_threads</span>
                    <span class="s3">for </span><span class="s1">lib_controller </span><span class="s3">in </span><span class="s1">limits</span><span class="s4">.</span><span class="s1">lib_controllers</span>
                <span class="s4">}</span>

            <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">):</span>
                <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span>
                    <span class="s5">&quot;limits must either be an int, a list, a dict, or &quot;</span>
                    <span class="s5">f&quot;'sequential_blas_under_openmp'. Got </span><span class="s3">{</span><span class="s1">type</span><span class="s4">(</span><span class="s1">limits</span><span class="s4">)</span><span class="s3">} </span><span class="s5">instead&quot;</span>
                <span class="s4">)</span>

            <span class="s2"># With a dictionary, can set both specific limit for given</span>
            <span class="s2"># libraries and global limit for user_api. Fetch each separately.</span>
            <span class="s1">prefixes </span><span class="s4">= [</span><span class="s1">prefix </span><span class="s3">for </span><span class="s1">prefix </span><span class="s3">in </span><span class="s1">limits </span><span class="s3">if </span><span class="s1">prefix </span><span class="s3">in </span><span class="s1">_ALL_PREFIXES</span><span class="s4">]</span>
            <span class="s1">user_api </span><span class="s4">= [</span><span class="s1">api </span><span class="s3">for </span><span class="s1">api </span><span class="s3">in </span><span class="s1">limits </span><span class="s3">if </span><span class="s1">api </span><span class="s3">in </span><span class="s1">_ALL_USER_APIS</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">, </span><span class="s1">prefixes</span>

    <span class="s3">def </span><span class="s1">_set_threadpool_limits</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Change the maximal number of threads in selected thread pools. 
 
        Return a list with all the supported libraries that have been found 
        matching `self._prefixes` and `self._user_api`. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_limits </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s3">for </span><span class="s1">lib_controller </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_controller</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">:</span>
            <span class="s2"># self._limits is a dict {key: num_threads} where key is either</span>
            <span class="s2"># a prefix or a user_api. If a library matches both, the limit</span>
            <span class="s2"># corresponding to the prefix is chosen.</span>
            <span class="s3">if </span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">prefix </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_limits</span><span class="s4">:</span>
                <span class="s1">num_threads </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_limits</span><span class="s4">[</span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">prefix</span><span class="s4">]</span>
            <span class="s3">elif </span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">user_api </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_limits</span><span class="s4">:</span>
                <span class="s1">num_threads </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_limits</span><span class="s4">[</span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">user_api</span><span class="s4">]</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">continue</span>

            <span class="s3">if </span><span class="s1">num_threads </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">set_num_threads</span><span class="s4">(</span><span class="s1">num_threads</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">_ThreadpoolLimiterDecorator</span><span class="s4">(</span><span class="s1">_ThreadpoolLimiter</span><span class="s4">, </span><span class="s1">ContextDecorator</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Same as _ThreadpoolLimiter but to be used as a decorator&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">controller</span><span class="s4">, *, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_limits</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_user_api</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_prefixes </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_check_params</span><span class="s4">(</span>
            <span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_controller </span><span class="s4">= </span><span class="s1">controller</span>

    <span class="s3">def </span><span class="s1">__enter__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s2"># we need to set the limits here and not in the __init__ because we want the</span>
        <span class="s2"># limits to be set when calling the decorated function, not when creating the</span>
        <span class="s2"># decorator.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_original_info </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_controller</span><span class="s4">.</span><span class="s1">info</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_set_threadpool_limits</span><span class="s4">()</span>
        <span class="s3">return </span><span class="s1">self</span>


<span class="s4">@</span><span class="s1">_format_docstring</span><span class="s4">(</span>
    <span class="s1">USER_APIS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s5">f'&quot;</span><span class="s3">{</span><span class="s1">api</span><span class="s3">}</span><span class="s5">&quot;' </span><span class="s3">for </span><span class="s1">api </span><span class="s3">in </span><span class="s1">_ALL_USER_APIS</span><span class="s4">),</span>
    <span class="s1">BLAS_LIBS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">_ALL_BLAS_LIBRARIES</span><span class="s4">),</span>
    <span class="s1">OPENMP_LIBS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">_ALL_OPENMP_LIBRARIES</span><span class="s4">),</span>
<span class="s4">)</span>
<span class="s3">class </span><span class="s1">threadpool_limits</span><span class="s4">(</span><span class="s1">_ThreadpoolLimiter</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Change the maximal number of threads that can be used in thread pools. 
 
    This object can be used either as a callable (the construction of this object 
    limits the number of threads), as a context manager in a `with` block to 
    automatically restore the original state of the controlled libraries when exiting 
    the block, or as a decorator through its `wrap` method. 
 
    Set the maximal number of threads that can be used in thread pools used in 
    the supported libraries to `limit`. This function works for libraries that 
    are already loaded in the interpreter and can be changed dynamically. 
 
    This effect is global and impacts the whole Python process. There is no thread level 
    isolation as these libraries do not offer thread-local APIs to configure the number 
    of threads to use in nested parallel calls. 
 
    Parameters 
    ---------- 
    limits : int, dict, 'sequential_blas_under_openmp' or None (default=None) 
        The maximal number of threads that can be used in thread pools 
 
        - If int, sets the maximum number of threads to `limits` for each 
          library selected by `user_api`. 
 
        - If it is a dictionary `{{key: max_threads}}`, this function sets a 
          custom maximum number of threads for each `key` which can be either a 
          `user_api` or a `prefix` for a specific library. 
 
        - If 'sequential_blas_under_openmp', it will chose the appropriate `limits` 
          and `user_api` parameters for the specific use case of sequential BLAS 
          calls within an OpenMP parallel region. The `user_api` parameter is 
          ignored. 
 
        - If None, this function does not do anything. 
 
    user_api : {USER_APIS} or None (default=None) 
        APIs of libraries to limit. Used only if `limits` is an int. 
 
        - If &quot;blas&quot;, it will only limit BLAS supported libraries ({BLAS_LIBS}). 
 
        - If &quot;openmp&quot;, it will only limit OpenMP supported libraries 
          ({OPENMP_LIBS}). Note that it can affect the number of threads used 
          by the BLAS libraries if they rely on OpenMP. 
 
        - If None, this function will apply to all supported libraries. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">ThreadpoolController</span><span class="s4">(), </span><span class="s1">limits</span><span class="s4">=</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s1">user_api</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">ThreadpoolController</span><span class="s4">(), </span><span class="s1">limits</span><span class="s4">=</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s1">user_api</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">ThreadpoolController</span><span class="s4">:</span>
    <span class="s0">&quot;&quot;&quot;Collection of LibController objects for all loaded supported libraries 
 
    Attributes 
    ---------- 
    lib_controllers : list of `LibController` objects 
        The list of library controllers of all loaded supported libraries. 
    &quot;&quot;&quot;</span>

    <span class="s2"># Cache for libc under POSIX and a few system libraries under Windows.</span>
    <span class="s2"># We use a class level cache instead of an instance level cache because</span>
    <span class="s2"># it's very unlikely that a shared library will be unloaded and reloaded</span>
    <span class="s2"># during the lifetime of a program.</span>
    <span class="s1">_system_libraries </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_load_libraries</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_warn_if_incompatible_openmp</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">_from_controllers</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">lib_controllers</span><span class="s4">):</span>
        <span class="s1">new_controller </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">__new__</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">)</span>
        <span class="s1">new_controller</span><span class="s4">.</span><span class="s1">lib_controllers </span><span class="s4">= </span><span class="s1">lib_controllers</span>
        <span class="s3">return </span><span class="s1">new_controller</span>

    <span class="s3">def </span><span class="s1">info</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return lib_controllers info as a list of dicts&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">info</span><span class="s4">() </span><span class="s3">for </span><span class="s1">lib_controller </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">select</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return a ThreadpoolController containing a subset of its current 
        library controllers 
 
        It will select all libraries matching at least one pair (key, value) from kwargs 
        where key is an entry of the library info dict (like &quot;user_api&quot;, &quot;internal_api&quot;, 
        &quot;prefix&quot;, ...) and value is the value or a list of acceptable values for that 
        entry. 
 
        For instance, `ThreadpoolController().select(internal_api=[&quot;blis&quot;, &quot;openblas&quot;])` 
        will select all library controllers whose internal_api is either &quot;blis&quot; or 
        &quot;openblas&quot;. 
        &quot;&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">vals </span><span class="s3">in </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">kwargs</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = [</span><span class="s1">vals</span><span class="s4">] </span><span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">vals</span><span class="s4">, </span><span class="s1">list</span><span class="s4">) </span><span class="s3">else </span><span class="s1">vals</span>

        <span class="s1">lib_controllers </span><span class="s4">= [</span>
            <span class="s1">lib_controller</span>
            <span class="s3">for </span><span class="s1">lib_controller </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers</span>
            <span class="s3">if </span><span class="s1">any</span><span class="s4">(</span>
                <span class="s1">getattr</span><span class="s4">(</span><span class="s1">lib_controller</span><span class="s4">, </span><span class="s1">key</span><span class="s4">, </span><span class="s3">None</span><span class="s4">) </span><span class="s3">in </span><span class="s1">vals</span>
                <span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">vals </span><span class="s3">in </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
            <span class="s4">)</span>
        <span class="s4">]</span>

        <span class="s3">return </span><span class="s1">ThreadpoolController</span><span class="s4">.</span><span class="s1">_from_controllers</span><span class="s4">(</span><span class="s1">lib_controllers</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_get_params_for_sequential_blas_under_openmp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return appropriate params to use for a sequential BLAS call in an OpenMP loop 
 
        This function takes into account the unexpected behavior of OpenBLAS with the 
        OpenMP threading layer. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">select</span><span class="s4">(</span>
            <span class="s1">internal_api</span><span class="s4">=</span><span class="s5">&quot;openblas&quot;</span><span class="s4">, </span><span class="s1">threading_layer</span><span class="s4">=</span><span class="s5">&quot;openmp&quot;</span>
        <span class="s4">).</span><span class="s1">lib_controllers</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">{</span><span class="s5">&quot;limits&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">, </span><span class="s5">&quot;user_api&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>
        <span class="s3">return </span><span class="s4">{</span><span class="s5">&quot;limits&quot;</span><span class="s4">: </span><span class="s6">1</span><span class="s4">, </span><span class="s5">&quot;user_api&quot;</span><span class="s4">: </span><span class="s5">&quot;blas&quot;</span><span class="s4">}</span>

    <span class="s4">@</span><span class="s1">_format_docstring</span><span class="s4">(</span>
        <span class="s1">USER_APIS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s5">'&quot;{}&quot;'</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">api</span><span class="s4">) </span><span class="s3">for </span><span class="s1">api </span><span class="s3">in </span><span class="s1">_ALL_USER_APIS</span><span class="s4">),</span>
        <span class="s1">BLAS_LIBS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">_ALL_BLAS_LIBRARIES</span><span class="s4">),</span>
        <span class="s1">OPENMP_LIBS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">_ALL_OPENMP_LIBRARIES</span><span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s3">def </span><span class="s1">limit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Change the maximal number of threads that can be used in thread pools. 
 
        This function returns an object that can be used either as a callable (the 
        construction of this object limits the number of threads) or as a context 
        manager, in a `with` block to automatically restore the original state of the 
        controlled libraries when exiting the block. 
 
        Set the maximal number of threads that can be used in thread pools used in 
        the supported libraries to `limits`. This function works for libraries that 
        are already loaded in the interpreter and can be changed dynamically. 
 
        This effect is global and impacts the whole Python process. There is no thread 
        level isolation as these libraries do not offer thread-local APIs to configure 
        the number of threads to use in nested parallel calls. 
 
        Parameters 
        ---------- 
        limits : int, dict, 'sequential_blas_under_openmp' or None (default=None) 
            The maximal number of threads that can be used in thread pools 
 
            - If int, sets the maximum number of threads to `limits` for each 
              library selected by `user_api`. 
 
            - If it is a dictionary `{{key: max_threads}}`, this function sets a 
              custom maximum number of threads for each `key` which can be either a 
              `user_api` or a `prefix` for a specific library. 
 
            - If 'sequential_blas_under_openmp', it will chose the appropriate `limits` 
              and `user_api` parameters for the specific use case of sequential BLAS 
              calls within an OpenMP parallel region. The `user_api` parameter is 
              ignored. 
 
            - If None, this function does not do anything. 
 
        user_api : {USER_APIS} or None (default=None) 
            APIs of libraries to limit. Used only if `limits` is an int. 
 
            - If &quot;blas&quot;, it will only limit BLAS supported libraries ({BLAS_LIBS}). 
 
            - If &quot;openmp&quot;, it will only limit OpenMP supported libraries 
              ({OPENMP_LIBS}). Note that it can affect the number of threads used 
              by the BLAS libraries if they rely on OpenMP. 
 
            - If None, this function will apply to all supported libraries. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">_ThreadpoolLimiter</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">limits</span><span class="s4">=</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s1">user_api</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">_format_docstring</span><span class="s4">(</span>
        <span class="s1">USER_APIS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s5">'&quot;{}&quot;'</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">api</span><span class="s4">) </span><span class="s3">for </span><span class="s1">api </span><span class="s3">in </span><span class="s1">_ALL_USER_APIS</span><span class="s4">),</span>
        <span class="s1">BLAS_LIBS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">_ALL_BLAS_LIBRARIES</span><span class="s4">),</span>
        <span class="s1">OPENMP_LIBS</span><span class="s4">=</span><span class="s5">&quot;, &quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">_ALL_OPENMP_LIBRARIES</span><span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s3">def </span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *, </span><span class="s1">limits</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Change the maximal number of threads that can be used in thread pools. 
 
        This function returns an object that can be used as a decorator. 
 
        Set the maximal number of threads that can be used in thread pools used in 
        the supported libraries to `limits`. This function works for libraries that 
        are already loaded in the interpreter and can be changed dynamically. 
 
        Parameters 
        ---------- 
        limits : int, dict or None (default=None) 
            The maximal number of threads that can be used in thread pools 
 
            - If int, sets the maximum number of threads to `limits` for each 
              library selected by `user_api`. 
 
            - If it is a dictionary `{{key: max_threads}}`, this function sets a 
              custom maximum number of threads for each `key` which can be either a 
              `user_api` or a `prefix` for a specific library. 
 
            - If None, this function does not do anything. 
 
        user_api : {USER_APIS} or None (default=None) 
            APIs of libraries to limit. Used only if `limits` is an int. 
 
            - If &quot;blas&quot;, it will only limit BLAS supported libraries ({BLAS_LIBS}). 
 
            - If &quot;openmp&quot;, it will only limit OpenMP supported libraries 
              ({OPENMP_LIBS}). Note that it can affect the number of threads used 
              by the BLAS libraries if they rely on OpenMP. 
 
            - If None, this function will apply to all supported libraries. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">_ThreadpoolLimiter</span><span class="s4">.</span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">limits</span><span class="s4">=</span><span class="s1">limits</span><span class="s4">, </span><span class="s1">user_api</span><span class="s4">=</span><span class="s1">user_api</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__len__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_load_libraries</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Loop through loaded shared libraries and store the supported ones&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform </span><span class="s4">== </span><span class="s5">&quot;darwin&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_find_libraries_with_dyld</span><span class="s4">()</span>
        <span class="s3">elif </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">platform </span><span class="s4">== </span><span class="s5">&quot;win32&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_find_libraries_with_enum_process_module_ex</span><span class="s4">()</span>
        <span class="s3">elif </span><span class="s5">&quot;pyodide&quot; </span><span class="s3">in </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">modules</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_find_libraries_pyodide</span><span class="s4">()</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_find_libraries_with_dl_iterate_phdr</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_find_libraries_with_dl_iterate_phdr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Loop through loaded libraries and return binders on supported ones 
 
        This function is expected to work on POSIX system only. 
        This code is adapted from code by Intel developer @anton-malakhov 
        available at https://github.com/IntelPython/smp 
 
        Copyright (c) 2017, Intel Corporation published under the BSD 3-Clause 
        license 
        &quot;&quot;&quot;</span>
        <span class="s1">libc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_libc</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">libc</span><span class="s4">, </span><span class="s5">&quot;dl_iterate_phdr&quot;</span><span class="s4">):  </span><span class="s2"># pragma: no cover</span>
            <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                <span class="s5">&quot;Could not find dl_iterate_phdr in the C standard library.&quot;</span><span class="s4">,</span>
                <span class="s1">RuntimeWarning</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s2"># Callback function for `dl_iterate_phdr` which is called for every</span>
        <span class="s2"># library loaded in the current process until it returns 1.</span>
        <span class="s3">def </span><span class="s1">match_library_callback</span><span class="s4">(</span><span class="s1">info</span><span class="s4">, </span><span class="s1">size</span><span class="s4">, </span><span class="s1">data</span><span class="s4">):</span>
            <span class="s2"># Get the path of the current library</span>
            <span class="s1">filepath </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">contents</span><span class="s4">.</span><span class="s1">dlpi_name</span>
            <span class="s3">if </span><span class="s1">filepath</span><span class="s4">:</span>
                <span class="s1">filepath </span><span class="s4">= </span><span class="s1">filepath</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>

                <span class="s2"># Store the library controller if it is supported and selected</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_make_controller_from_path</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s6">0</span>

        <span class="s1">c_func_signature </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">CFUNCTYPE</span><span class="s4">(</span>
            <span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_int</span><span class="s4">,  </span><span class="s2"># Return type</span>
            <span class="s1">ctypes</span><span class="s4">.</span><span class="s1">POINTER</span><span class="s4">(</span><span class="s1">_dl_phdr_info</span><span class="s4">),</span>
            <span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_size_t</span><span class="s4">,</span>
            <span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">c_match_library_callback </span><span class="s4">= </span><span class="s1">c_func_signature</span><span class="s4">(</span><span class="s1">match_library_callback</span><span class="s4">)</span>

        <span class="s1">data </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span><span class="s4">(</span><span class="s7">b&quot;&quot;</span><span class="s4">)</span>
        <span class="s1">libc</span><span class="s4">.</span><span class="s1">dl_iterate_phdr</span><span class="s4">(</span><span class="s1">c_match_library_callback</span><span class="s4">, </span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_find_libraries_with_dyld</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Loop through loaded libraries and return binders on supported ones 
 
        This function is expected to work on OSX system only 
        &quot;&quot;&quot;</span>
        <span class="s1">libc </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_libc</span><span class="s4">()</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">libc</span><span class="s4">, </span><span class="s5">&quot;_dyld_image_count&quot;</span><span class="s4">):  </span><span class="s2"># pragma: no cover</span>
            <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                <span class="s5">&quot;Could not find _dyld_image_count in the C standard library.&quot;</span><span class="s4">,</span>
                <span class="s1">RuntimeWarning</span><span class="s4">,</span>
            <span class="s4">)</span>
            <span class="s3">return </span><span class="s4">[]</span>

        <span class="s1">n_dyld </span><span class="s4">= </span><span class="s1">libc</span><span class="s4">.</span><span class="s1">_dyld_image_count</span><span class="s4">()</span>
        <span class="s1">libc</span><span class="s4">.</span><span class="s1">_dyld_get_image_name</span><span class="s4">.</span><span class="s1">restype </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">c_char_p</span>

        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">n_dyld</span><span class="s4">):</span>
            <span class="s1">filepath </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">string_at</span><span class="s4">(</span><span class="s1">libc</span><span class="s4">.</span><span class="s1">_dyld_get_image_name</span><span class="s4">(</span><span class="s1">i</span><span class="s4">))</span>
            <span class="s1">filepath </span><span class="s4">= </span><span class="s1">filepath</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>

            <span class="s2"># Store the library controller if it is supported and selected</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_make_controller_from_path</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_find_libraries_with_enum_process_module_ex</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Loop through loaded libraries and return binders on supported ones 
 
        This function is expected to work on windows system only. 
        This code is adapted from code by Philipp Hagemeister @phihag available 
        at https://stackoverflow.com/questions/17474574 
        &quot;&quot;&quot;</span>
        <span class="s3">from </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">wintypes </span><span class="s3">import </span><span class="s1">DWORD</span><span class="s4">, </span><span class="s1">HMODULE</span><span class="s4">, </span><span class="s1">MAX_PATH</span>

        <span class="s1">PROCESS_QUERY_INFORMATION </span><span class="s4">= </span><span class="s6">0x0400</span>
        <span class="s1">PROCESS_VM_READ </span><span class="s4">= </span><span class="s6">0x0010</span>

        <span class="s1">LIST_LIBRARIES_ALL </span><span class="s4">= </span><span class="s6">0x03</span>

        <span class="s1">ps_api </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_windll</span><span class="s4">(</span><span class="s5">&quot;Psapi&quot;</span><span class="s4">)</span>
        <span class="s1">kernel_32 </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_get_windll</span><span class="s4">(</span><span class="s5">&quot;kernel32&quot;</span><span class="s4">)</span>

        <span class="s1">h_process </span><span class="s4">= </span><span class="s1">kernel_32</span><span class="s4">.</span><span class="s1">OpenProcess</span><span class="s4">(</span>
            <span class="s1">PROCESS_QUERY_INFORMATION </span><span class="s4">| </span><span class="s1">PROCESS_VM_READ</span><span class="s4">, </span><span class="s3">False</span><span class="s4">, </span><span class="s1">os</span><span class="s4">.</span><span class="s1">getpid</span><span class="s4">()</span>
        <span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">h_process</span><span class="s4">:  </span><span class="s2"># pragma: no cover</span>
            <span class="s3">raise </span><span class="s1">OSError</span><span class="s4">(</span><span class="s5">f&quot;Could not open PID </span><span class="s3">{</span><span class="s1">os</span><span class="s4">.</span><span class="s1">getpid</span><span class="s4">()</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">buf_count </span><span class="s4">= </span><span class="s6">256</span>
            <span class="s1">needed </span><span class="s4">= </span><span class="s1">DWORD</span><span class="s4">()</span>
            <span class="s2"># Grow the buffer until it becomes large enough to hold all the</span>
            <span class="s2"># module headers</span>
            <span class="s3">while True</span><span class="s4">:</span>
                <span class="s1">buf </span><span class="s4">= (</span><span class="s1">HMODULE </span><span class="s4">* </span><span class="s1">buf_count</span><span class="s4">)()</span>
                <span class="s1">buf_size </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">sizeof</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">)</span>
                <span class="s3">if not </span><span class="s1">ps_api</span><span class="s4">.</span><span class="s1">EnumProcessModulesEx</span><span class="s4">(</span>
                    <span class="s1">h_process</span><span class="s4">,</span>
                    <span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">),</span>
                    <span class="s1">buf_size</span><span class="s4">,</span>
                    <span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">needed</span><span class="s4">),</span>
                    <span class="s1">LIST_LIBRARIES_ALL</span><span class="s4">,</span>
                <span class="s4">):</span>
                    <span class="s3">raise </span><span class="s1">OSError</span><span class="s4">(</span><span class="s5">&quot;EnumProcessModulesEx failed&quot;</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">buf_size </span><span class="s4">&gt;= </span><span class="s1">needed</span><span class="s4">.</span><span class="s1">value</span><span class="s4">:</span>
                    <span class="s3">break</span>
                <span class="s1">buf_count </span><span class="s4">= </span><span class="s1">needed</span><span class="s4">.</span><span class="s1">value </span><span class="s4">// (</span><span class="s1">buf_size </span><span class="s4">// </span><span class="s1">buf_count</span><span class="s4">)</span>

            <span class="s1">count </span><span class="s4">= </span><span class="s1">needed</span><span class="s4">.</span><span class="s1">value </span><span class="s4">// (</span><span class="s1">buf_size </span><span class="s4">// </span><span class="s1">buf_count</span><span class="s4">)</span>
            <span class="s1">h_modules </span><span class="s4">= </span><span class="s1">map</span><span class="s4">(</span><span class="s1">HMODULE</span><span class="s4">, </span><span class="s1">buf</span><span class="s4">[:</span><span class="s1">count</span><span class="s4">])</span>

            <span class="s2"># Loop through all the module headers and get the library path</span>
            <span class="s1">buf </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">create_unicode_buffer</span><span class="s4">(</span><span class="s1">MAX_PATH</span><span class="s4">)</span>
            <span class="s1">n_size </span><span class="s4">= </span><span class="s1">DWORD</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">h_module </span><span class="s3">in </span><span class="s1">h_modules</span><span class="s4">:</span>
                <span class="s2"># Get the path of the current module</span>
                <span class="s3">if not </span><span class="s1">ps_api</span><span class="s4">.</span><span class="s1">GetModuleFileNameExW</span><span class="s4">(</span>
                    <span class="s1">h_process</span><span class="s4">, </span><span class="s1">h_module</span><span class="s4">, </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">), </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">byref</span><span class="s4">(</span><span class="s1">n_size</span><span class="s4">)</span>
                <span class="s4">):</span>
                    <span class="s3">raise </span><span class="s1">OSError</span><span class="s4">(</span><span class="s5">&quot;GetModuleFileNameEx failed&quot;</span><span class="s4">)</span>
                <span class="s1">filepath </span><span class="s4">= </span><span class="s1">buf</span><span class="s4">.</span><span class="s1">value</span>

                <span class="s2"># Store the library controller if it is supported and selected</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_make_controller_from_path</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">)</span>
        <span class="s3">finally</span><span class="s4">:</span>
            <span class="s1">kernel_32</span><span class="s4">.</span><span class="s1">CloseHandle</span><span class="s4">(</span><span class="s1">h_process</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_find_libraries_pyodide</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Pyodide specific implementation for finding loaded libraries. 
 
        Adapted from suggestion in https://github.com/joblib/threadpoolctl/pull/169#issuecomment-1946696449. 
 
        One day, we may have a simpler solution. libc dl_iterate_phdr needs to 
        be implemented in Emscripten and exposed in Pyodide, see 
        https://github.com/emscripten-core/emscripten/issues/21354 for more 
        details. 
        &quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">from </span><span class="s1">pyodide_js</span><span class="s4">.</span><span class="s1">_module </span><span class="s3">import </span><span class="s1">LDSO</span>
        <span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
            <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span>
                <span class="s5">&quot;Unable to import LDSO from pyodide_js._module. This should never &quot;</span>
                <span class="s5">&quot;happen.&quot;</span>
            <span class="s4">)</span>
            <span class="s3">return</span>

        <span class="s3">for </span><span class="s1">filepath </span><span class="s3">in </span><span class="s1">LDSO</span><span class="s4">.</span><span class="s1">loadedLibsByName</span><span class="s4">.</span><span class="s1">as_object_map</span><span class="s4">():</span>
            <span class="s2"># Some libraries are duplicated by Pyodide and do not exist in the</span>
            <span class="s2"># filesystem, so we first check for the existence of the file. For</span>
            <span class="s2"># more details, see</span>
            <span class="s2"># https://github.com/joblib/threadpoolctl/pull/169#issuecomment-1947946728</span>
            <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">exists</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">_make_controller_from_path</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_make_controller_from_path</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">filepath</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Store a library controller if it is supported and selected&quot;&quot;&quot;</span>
        <span class="s2"># Required to resolve symlinks</span>
        <span class="s1">filepath </span><span class="s4">= </span><span class="s1">_realpath</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">)</span>
        <span class="s2"># `lower` required to take account of OpenMP dll case on Windows</span>
        <span class="s2"># (vcomp, VCOMP, Vcomp, ...)</span>
        <span class="s1">filename </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">path</span><span class="s4">.</span><span class="s1">basename</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">).</span><span class="s1">lower</span><span class="s4">()</span>

        <span class="s2"># Loop through supported libraries to find if this filename corresponds</span>
        <span class="s2"># to a supported one.</span>
        <span class="s3">for </span><span class="s1">controller_class </span><span class="s3">in </span><span class="s1">_ALL_CONTROLLERS</span><span class="s4">:</span>
            <span class="s2"># check if filename matches a supported prefix</span>
            <span class="s1">prefix </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_check_prefix</span><span class="s4">(</span><span class="s1">filename</span><span class="s4">, </span><span class="s1">controller_class</span><span class="s4">.</span><span class="s1">filename_prefixes</span><span class="s4">)</span>

            <span class="s2"># filename does not match any of the prefixes of the candidate</span>
            <span class="s2"># library. move to next library.</span>
            <span class="s3">if </span><span class="s1">prefix </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s3">continue</span>

            <span class="s2"># workaround for BLAS libraries packaged by conda-forge on windows, which</span>
            <span class="s2"># are all renamed &quot;libblas.dll&quot;. We thus have to check to which BLAS</span>
            <span class="s2"># implementation it actually corresponds looking for implementation</span>
            <span class="s2"># specific symbols.</span>
            <span class="s3">if </span><span class="s1">prefix </span><span class="s4">== </span><span class="s5">&quot;libblas&quot;</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">filename</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s5">&quot;.dll&quot;</span><span class="s4">):</span>
                    <span class="s1">libblas </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">CDLL</span><span class="s4">(</span><span class="s1">filepath</span><span class="s4">, </span><span class="s1">_RTLD_NOLOAD</span><span class="s4">)</span>
                    <span class="s3">if not </span><span class="s1">any</span><span class="s4">(</span>
                        <span class="s1">hasattr</span><span class="s4">(</span><span class="s1">libblas</span><span class="s4">, </span><span class="s1">func</span><span class="s4">)</span>
                        <span class="s3">for </span><span class="s1">func </span><span class="s3">in </span><span class="s1">controller_class</span><span class="s4">.</span><span class="s1">check_symbols</span>
                    <span class="s4">):</span>
                        <span class="s3">continue</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s2"># We ignore libblas on other platforms than windows because there</span>
                    <span class="s2"># might be a libblas dso comming with openblas for instance that</span>
                    <span class="s2"># can't be used to instantiate a pertinent LibController (many</span>
                    <span class="s2"># symbols are missing) and would create confusion by making a</span>
                    <span class="s2"># duplicate entry in threadpool_info.</span>
                    <span class="s3">continue</span>

            <span class="s2"># filename matches a prefix. Now we check if the library has the symbols we</span>
            <span class="s2"># are looking for. If none of the symbols exists, it's very likely not the</span>
            <span class="s2"># expected library (e.g. a library having a common prefix with one of the</span>
            <span class="s2"># our supported libraries). Otherwise, create and store the library</span>
            <span class="s2"># controller.</span>
            <span class="s1">lib_controller </span><span class="s4">= </span><span class="s1">controller_class</span><span class="s4">(</span>
                <span class="s1">filepath</span><span class="s4">=</span><span class="s1">filepath</span><span class="s4">, </span><span class="s1">prefix</span><span class="s4">=</span><span class="s1">prefix</span><span class="s4">, </span><span class="s1">parent</span><span class="s4">=</span><span class="s1">self</span>
            <span class="s4">)</span>

            <span class="s3">if </span><span class="s1">filepath </span><span class="s3">in </span><span class="s4">(</span><span class="s1">lib</span><span class="s4">.</span><span class="s1">filepath </span><span class="s3">for </span><span class="s1">lib </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">):</span>
                <span class="s2"># We already have a controller for this library.</span>
                <span class="s3">continue</span>

            <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">controller_class</span><span class="s4">, </span><span class="s5">&quot;check_symbols&quot;</span><span class="s4">) </span><span class="s3">or </span><span class="s1">any</span><span class="s4">(</span>
                <span class="s1">hasattr</span><span class="s4">(</span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">dynlib</span><span class="s4">, </span><span class="s1">func</span><span class="s4">)</span>
                <span class="s3">for </span><span class="s1">func </span><span class="s3">in </span><span class="s1">controller_class</span><span class="s4">.</span><span class="s1">check_symbols</span>
            <span class="s4">):</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">lib_controller</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_check_prefix</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">library_basename</span><span class="s4">, </span><span class="s1">filename_prefixes</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Return the prefix library_basename starts with 
 
        Return None if none matches. 
        &quot;&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">prefix </span><span class="s3">in </span><span class="s1">filename_prefixes</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">library_basename</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s1">prefix</span><span class="s4">):</span>
                <span class="s3">return </span><span class="s1">prefix</span>
        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">_warn_if_incompatible_openmp</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Raise a warning if llvm-OpenMP and intel-OpenMP are both loaded&quot;&quot;&quot;</span>
        <span class="s1">prefixes </span><span class="s4">= [</span><span class="s1">lib_controller</span><span class="s4">.</span><span class="s1">prefix </span><span class="s3">for </span><span class="s1">lib_controller </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">lib_controllers</span><span class="s4">]</span>
        <span class="s1">msg </span><span class="s4">= </span><span class="s1">textwrap</span><span class="s4">.</span><span class="s1">dedent</span><span class="s4">(</span>
            <span class="s5">&quot;&quot;&quot; 
            Found Intel OpenMP ('libiomp') and LLVM OpenMP ('libomp') loaded at 
            the same time. Both libraries are known to be incompatible and this 
            can cause random crashes or deadlocks on Linux when loaded in the 
            same Python program. 
            Using threadpoolctl may cause crashes or deadlocks. For more 
            information and possible workarounds, please see 
                https://github.com/joblib/threadpoolctl/blob/master/multiple_openmp.md 
            &quot;&quot;&quot;</span>
        <span class="s4">)</span>
        <span class="s3">if </span><span class="s5">&quot;libomp&quot; </span><span class="s3">in </span><span class="s1">prefixes </span><span class="s3">and </span><span class="s5">&quot;libiomp&quot; </span><span class="s3">in </span><span class="s1">prefixes</span><span class="s4">:</span>
            <span class="s1">warnings</span><span class="s4">.</span><span class="s1">warn</span><span class="s4">(</span><span class="s1">msg</span><span class="s4">, </span><span class="s1">RuntimeWarning</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">_get_libc</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Load the lib-C for unix systems.&quot;&quot;&quot;</span>
        <span class="s1">libc </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">_system_libraries</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;libc&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">libc </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s2"># Remark: If libc is statically linked or if Python is linked against an</span>
            <span class="s2"># alternative implementation of libc like musl, find_library will return</span>
            <span class="s2"># None and CDLL will load the main program itself which should contain the</span>
            <span class="s2"># libc symbols. We still name it libc for convenience.</span>
            <span class="s2"># If the main program does not contain the libc symbols, it's ok because</span>
            <span class="s2"># we check their presence later anyway.</span>
            <span class="s1">libc </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">CDLL</span><span class="s4">(</span><span class="s1">find_library</span><span class="s4">(</span><span class="s5">&quot;c&quot;</span><span class="s4">), </span><span class="s1">mode</span><span class="s4">=</span><span class="s1">_RTLD_NOLOAD</span><span class="s4">)</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">_system_libraries</span><span class="s4">[</span><span class="s5">&quot;libc&quot;</span><span class="s4">] = </span><span class="s1">libc</span>
        <span class="s3">return </span><span class="s1">libc</span>

    <span class="s4">@</span><span class="s1">classmethod</span>
    <span class="s3">def </span><span class="s1">_get_windll</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">dll_name</span><span class="s4">):</span>
        <span class="s0">&quot;&quot;&quot;Load a windows DLL&quot;&quot;&quot;</span>
        <span class="s1">dll </span><span class="s4">= </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">_system_libraries</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">dll_name</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">dll </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">dll </span><span class="s4">= </span><span class="s1">ctypes</span><span class="s4">.</span><span class="s1">WinDLL</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">dll_name</span><span class="s3">}</span><span class="s5">.dll&quot;</span><span class="s4">)</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">_system_libraries</span><span class="s4">[</span><span class="s1">dll_name</span><span class="s4">] = </span><span class="s1">dll</span>
        <span class="s3">return </span><span class="s1">dll</span>


<span class="s3">def </span><span class="s1">_main</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Commandline interface to display thread-pool information and exit.&quot;&quot;&quot;</span>
    <span class="s3">import </span><span class="s1">argparse</span>
    <span class="s3">import </span><span class="s1">importlib</span>
    <span class="s3">import </span><span class="s1">json</span>
    <span class="s3">import </span><span class="s1">sys</span>

    <span class="s1">parser </span><span class="s4">= </span><span class="s1">argparse</span><span class="s4">.</span><span class="s1">ArgumentParser</span><span class="s4">(</span>
        <span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;python -m threadpoolctl -i numpy scipy.linalg xgboost&quot;</span><span class="s4">,</span>
        <span class="s1">description</span><span class="s4">=</span><span class="s5">&quot;Display thread-pool information and exit.&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span>
        <span class="s5">&quot;-i&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;--import&quot;</span><span class="s4">,</span>
        <span class="s1">dest</span><span class="s4">=</span><span class="s5">&quot;modules&quot;</span><span class="s4">,</span>
        <span class="s1">nargs</span><span class="s4">=</span><span class="s5">&quot;*&quot;</span><span class="s4">,</span>
        <span class="s1">default</span><span class="s4">=(),</span>
        <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;Python modules to import before introspecting thread-pools.&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">parser</span><span class="s4">.</span><span class="s1">add_argument</span><span class="s4">(</span>
        <span class="s5">&quot;-c&quot;</span><span class="s4">,</span>
        <span class="s5">&quot;--command&quot;</span><span class="s4">,</span>
        <span class="s1">help</span><span class="s4">=</span><span class="s5">&quot;a Python statement to execute before introspecting thread-pools.&quot;</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s1">options </span><span class="s4">= </span><span class="s1">parser</span><span class="s4">.</span><span class="s1">parse_args</span><span class="s4">(</span><span class="s1">sys</span><span class="s4">.</span><span class="s1">argv</span><span class="s4">[</span><span class="s6">1</span><span class="s4">:])</span>
    <span class="s3">for </span><span class="s1">module </span><span class="s3">in </span><span class="s1">options</span><span class="s4">.</span><span class="s1">modules</span><span class="s4">:</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">importlib</span><span class="s4">.</span><span class="s1">import_module</span><span class="s4">(</span><span class="s1">module</span><span class="s4">, </span><span class="s1">package</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
            <span class="s1">print</span><span class="s4">(</span><span class="s5">&quot;WARNING: could not import&quot;</span><span class="s4">, </span><span class="s1">module</span><span class="s4">, </span><span class="s1">file</span><span class="s4">=</span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">options</span><span class="s4">.</span><span class="s1">command</span><span class="s4">:</span>
        <span class="s1">exec</span><span class="s4">(</span><span class="s1">options</span><span class="s4">.</span><span class="s1">command</span><span class="s4">)</span>

    <span class="s1">print</span><span class="s4">(</span><span class="s1">json</span><span class="s4">.</span><span class="s1">dumps</span><span class="s4">(</span><span class="s1">threadpool_info</span><span class="s4">(), </span><span class="s1">indent</span><span class="s4">=</span><span class="s6">2</span><span class="s4">))</span>


<span class="s3">if </span><span class="s1">__name__ </span><span class="s4">== </span><span class="s5">&quot;__main__&quot;</span><span class="s4">:</span>
    <span class="s1">_main</span><span class="s4">()</span>
</pre>
</body>
</html>