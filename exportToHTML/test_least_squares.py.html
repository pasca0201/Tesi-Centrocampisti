<html>
<head>
<title>test_least_squares.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_least_squares.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s1">norm</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">,</span>
                           <span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse </span><span class="s0">import </span><span class="s1">issparse</span><span class="s2">, </span><span class="s1">lil_matrix</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s1">aslinearoperator</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize </span><span class="s0">import </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">Bounds</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">_lsq</span><span class="s2">.</span><span class="s1">least_squares </span><span class="s0">import </span><span class="s1">IMPLEMENTED_LOSSES</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">_lsq</span><span class="s2">.</span><span class="s1">common </span><span class="s0">import </span><span class="s1">EPS</span><span class="s2">, </span><span class="s1">make_strictly_feasible</span><span class="s2">, </span><span class="s1">CL_scaling_vector</span>


<span class="s0">def </span><span class="s1">fun_trivial</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">=</span><span class="s3">0</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s1">a</span><span class="s2">)**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5.0</span>


<span class="s0">def </span><span class="s1">jac_trivial</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">=</span><span class="s3">0.0</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s3">2 </span><span class="s2">* (</span><span class="s1">x </span><span class="s2">- </span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">fun_2d_trivial</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]])</span>


<span class="s0">def </span><span class="s1">jac_2d_trivial</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">fun_rosenbrock</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">10 </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] - </span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]**</span><span class="s3">2</span><span class="s2">), (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])])</span>


<span class="s0">def </span><span class="s1">jac_rosenbrock</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
        <span class="s2">[-</span><span class="s3">20 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">10</span><span class="s2">],</span>
        <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]</span>
    <span class="s2">])</span>


<span class="s0">def </span><span class="s1">jac_rosenbrock_bad_dim</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
        <span class="s2">[-</span><span class="s3">20 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s3">10</span><span class="s2">],</span>
        <span class="s2">[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">],</span>
        <span class="s2">[</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">]</span>
    <span class="s2">])</span>


<span class="s0">def </span><span class="s1">fun_rosenbrock_cropped</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">fun_rosenbrock</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">jac_rosenbrock_cropped</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">jac_rosenbrock</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)[</span><span class="s3">0</span><span class="s2">]</span>


<span class="s4"># When x is 1-D array, return is 2-D array.</span>
<span class="s0">def </span><span class="s1">fun_wrong_dimensions</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">**</span><span class="s3">2</span><span class="s2">, </span><span class="s1">x</span><span class="s2">**</span><span class="s3">3</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">jac_wrong_dimensions</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">=</span><span class="s3">0.0</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_3d</span><span class="s2">(</span><span class="s1">jac_trivial</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">=</span><span class="s1">a</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">fun_bvp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]))</span>
    <span class="s1">u </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">n </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">, </span><span class="s1">n </span><span class="s2">+ </span><span class="s3">2</span><span class="s2">))</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
    <span class="s1">u</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">x</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">u</span><span class="s2">[:-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">] + </span><span class="s1">u</span><span class="s2">[</span><span class="s3">2</span><span class="s2">:, </span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">] + </span><span class="s1">u</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">, :-</span><span class="s3">2</span><span class="s2">] + </span><span class="s1">u</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">:] - </span><span class="s3">4 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">+ </span><span class="s1">x</span><span class="s2">**</span><span class="s3">3</span>
    <span class="s0">return </span><span class="s1">y</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">BroydenTridiagonal</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">n</span><span class="s2">=</span><span class="s3">100</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'sparse'</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">n </span><span class="s2">= </span><span class="s1">n</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">= -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lb </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ub </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">lb </span><span class="s2">+= </span><span class="s3">0.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ub </span><span class="s2">+= </span><span class="s3">0.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">+= </span><span class="s3">0.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">= </span><span class="s1">make_strictly_feasible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ub</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">mode </span><span class="s2">== </span><span class="s5">'sparse'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sparsity </span><span class="s2">= </span><span class="s1">lil_matrix</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s3">1</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">] = </span><span class="s3">1</span>
            <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = </span><span class="s3">1</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">jac </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_jac</span>
        <span class="s0">elif </span><span class="s1">mode </span><span class="s2">== </span><span class="s5">'operator'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">jac </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">aslinearoperator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_jac</span><span class="s2">(</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s0">elif </span><span class="s1">mode </span><span class="s2">== </span><span class="s5">'dense'</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">sparsity </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">jac </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_jac</span><span class="s2">(</span><span class="s1">x</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">fun</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">f </span><span class="s2">= (</span><span class="s3">3 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">) * </span><span class="s1">x </span><span class="s2">+ </span><span class="s3">1</span>
        <span class="s1">f</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:] -= </span><span class="s1">x</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">f</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">] -= </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:]</span>
        <span class="s0">return </span><span class="s1">f</span>

    <span class="s0">def </span><span class="s1">_jac</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">J </span><span class="s2">= </span><span class="s1">lil_matrix</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">J</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s3">3 </span><span class="s2">- </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">J</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i </span><span class="s2">- </span><span class="s3">1</span><span class="s2">] = -</span><span class="s3">1</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">n </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">J</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">] = -</span><span class="s3">2</span>
        <span class="s0">return </span><span class="s1">J</span>


<span class="s0">class </span><span class="s1">ExponentialFittingProblem</span><span class="s2">:</span>
    <span class="s6">&quot;&quot;&quot;Provide data and function for exponential fitting in the form 
    y = a + exp(b * x) + noise.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">noise</span><span class="s2">, </span><span class="s1">n_outliers</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">x_range</span><span class="s2">=(-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                 <span class="s1">n_points</span><span class="s2">=</span><span class="s3">11</span><span class="s2">, </span><span class="s1">random_seed</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s1">random_seed</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">m </span><span class="s2">= </span><span class="s1">n_points</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">n </span><span class="s2">= </span><span class="s3">2</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">p0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">x_range</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">x_range</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">n_points</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">b </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">+= </span><span class="s1">noise </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">m</span><span class="s2">)</span>

        <span class="s1">outliers </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randint</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n_outliers</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">[</span><span class="s1">outliers</span><span class="s2">] += </span><span class="s3">50 </span><span class="s2">* </span><span class="s1">noise </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n_outliers</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">p_opt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">fun</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">) - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span>

    <span class="s0">def </span><span class="s1">jac</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
        <span class="s1">J </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">self</span><span class="s2">.</span><span class="s1">m</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">J</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">] = </span><span class="s3">1</span>
        <span class="s1">J</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">J</span>


<span class="s0">def </span><span class="s1">cubic_soft_l1</span><span class="s2">(</span><span class="s1">z</span><span class="s2">):</span>
    <span class="s1">rho </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s3">3</span><span class="s2">, </span><span class="s1">z</span><span class="s2">.</span><span class="s1">size</span><span class="s2">))</span>

    <span class="s1">t </span><span class="s2">= </span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">z</span>
    <span class="s1">rho</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] = </span><span class="s3">3 </span><span class="s2">* (</span><span class="s1">t</span><span class="s2">**(</span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">) - </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">rho</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] = </span><span class="s1">t </span><span class="s2">** (-</span><span class="s3">2</span><span class="s2">/</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">rho</span><span class="s2">[</span><span class="s3">2</span><span class="s2">] = -</span><span class="s3">2</span><span class="s2">/</span><span class="s3">3 </span><span class="s2">* </span><span class="s1">t</span><span class="s2">**(-</span><span class="s3">5</span><span class="s2">/</span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">rho</span>


<span class="s1">LOSSES </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">IMPLEMENTED_LOSSES</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()) + [</span><span class="s1">cubic_soft_l1</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">BaseMixin</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that the basic calling sequence works.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_args_kwargs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that args and kwargs are passed correctly to the functions.</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s3">3.0</span>
        <span class="s0">for </span><span class="s1">jac </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
                <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span>
                    <span class="s1">UserWarning</span><span class="s2">,</span>
                    <span class="s5">&quot;jac='(3-point|cs)' works equivalently to '2-point' for method='lm'&quot;</span>
                <span class="s2">)</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">a</span><span class="s2">,),</span>
                                    <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">res1 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">={</span><span class="s5">'a'</span><span class="s2">: </span><span class="s1">a</span><span class="s2">},</span>
                                    <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                          <span class="s1">args</span><span class="s2">=(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">,), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                          <span class="s1">kwargs</span><span class="s2">={</span><span class="s5">'kaboom'</span><span class="s2">: </span><span class="s3">3</span><span class="s2">}, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_jac_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">jac </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
                <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span>
                    <span class="s1">UserWarning</span><span class="s2">,</span>
                    <span class="s5">&quot;jac='(3-point|cs)' works equivalently to '2-point' for method='lm'&quot;</span>
                <span class="s2">)</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s5">'oops'</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nfev_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">max_nfev </span><span class="s0">in </span><span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s3">20</span><span class="s2">]:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">max_nfev</span><span class="s2">=</span><span class="s1">max_nfev</span><span class="s2">,</span>
                                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x_scale_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">x_scale </span><span class="s0">in </span><span class="s2">[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.5</span><span class="s2">]), </span><span class="s5">'jac'</span><span class="s2">]:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s1">x_scale</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s5">'auto'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">+</span><span class="s3">2.0j</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_diff_step</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># res1 and res2 should be equivalent.</span>
        <span class="s4"># res2 and res3 should be different.</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">diff_step</span><span class="s2">=</span><span class="s3">1e-1</span><span class="s2">,</span>
                             <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">diff_step</span><span class="s2">=-</span><span class="s3">1e-1</span><span class="s2">,</span>
                             <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                             <span class="s1">diff_step</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res3</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_incorrect_options_usage</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">options</span><span class="s2">={</span><span class="s5">'no_such_option'</span><span class="s2">: </span><span class="s3">100</span><span class="s2">})</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">options</span><span class="s2">={</span><span class="s5">'max_nfev'</span><span class="s2">: </span><span class="s3">100</span><span class="s2">})</span>

    <span class="s0">def </span><span class="s1">test_full_result</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># MINPACK doesn't work very well with factor=100 on this problem,</span>
        <span class="s4"># thus using low 'atol'.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">12.5</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-2</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">active_mask</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s5">'lm'</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">&lt; </span><span class="s3">30</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">njev </span><span class="s0">is None</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">&lt; </span><span class="s3">10</span><span class="s2">)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">njev </span><span class="s2">&lt; </span><span class="s3">10</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_full_result_single_fev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># MINPACK checks the number of nfev after the iteration,</span>
        <span class="s4"># so it's hard to tell what he is going to compute.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s5">'lm'</span><span class="s2">:</span>
            <span class="s0">return</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">40.5</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">9</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s3">4</span><span class="s2">]]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">36</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">36</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">active_mask</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0</span><span class="s2">]))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">njev</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rosenbrock</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">x_opt </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">, </span><span class="s1">tr_solver </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_rosenbrock</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">]), </span><span class="s5">'jac'</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s5">'exact'</span><span class="s2">, </span><span class="s5">'lsmr'</span><span class="s2">]):</span>
            <span class="s0">with </span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
                <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span>
                    <span class="s1">UserWarning</span><span class="s2">,</span>
                    <span class="s5">&quot;jac='(3-point|cs)' works equivalently to '2-point' for method='lm'&quot;</span>
                <span class="s2">)</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_rosenbrock</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s1">x_scale</span><span class="s2">,</span>
                                    <span class="s1">tr_solver</span><span class="s2">=</span><span class="s1">tr_solver</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x_opt</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rosenbrock_cropped</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s5">'lm'</span><span class="s2">:</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_rosenbrock_cropped</span><span class="s2">,</span>
                          <span class="s1">x0</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">, </span><span class="s1">tr_solver </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_rosenbrock_cropped</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">]), </span><span class="s5">'jac'</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s5">'exact'</span><span class="s2">, </span><span class="s5">'lsmr'</span><span class="s2">]):</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                    <span class="s1">fun_rosenbrock_cropped</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s1">x_scale</span><span class="s2">,</span>
                    <span class="s1">tr_solver</span><span class="s2">=</span><span class="s1">tr_solver</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fun_wrong_dimensions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_wrong_dimensions</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_jac_wrong_dimensions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac_wrong_dimensions</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fun_and_jac_inconsistent_dimensions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_rosenbrock</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">jac_rosenbrock_bad_dim</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x0_multidimensional</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s3">4</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x0_complex_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= </span><span class="s3">2.0 </span><span class="s2">+ </span><span class="s3">0.0</span><span class="s2">*</span><span class="s3">1j</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x0_complex_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0 </span><span class="s2">+ </span><span class="s3">0.0</span><span class="s2">*</span><span class="s3">1j</span><span class="s2">]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bvp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># This test was introduced with fix #5556. It turned out that</span>
        <span class="s4"># dogbox solver had a bug with trust-region radius update, which</span>
        <span class="s4"># could block its progress and create an infinite loop. And this</span>
        <span class="s4"># discrete boundary value problem is the one which triggers it.</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s3">10</span>
        <span class="s1">x0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">n</span><span class="s2">**</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s5">'lm'</span><span class="s2">:</span>
            <span class="s1">max_nfev </span><span class="s2">= </span><span class="s3">5000  </span><span class="s4"># To account for Jacobian estimation.</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">max_nfev </span><span class="s2">= </span><span class="s3">100</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_bvp</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">ftol</span><span class="s2">=</span><span class="s3">1e-2</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s1">max_nfev</span><span class="s2">)</span>

        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">&lt; </span><span class="s1">max_nfev</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost </span><span class="s2">&lt; </span><span class="s3">0.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_error_raised_when_all_tolerances_below_eps</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that all 0 tolerances are not allowed.</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">ftol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">xtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">gtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_convergence_with_only_one_tolerance_enabled</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">method </span><span class="s2">== </span><span class="s5">'lm'</span><span class="s2">:</span>
            <span class="s0">return  </span><span class="s4"># should not do test</span>
        <span class="s1">x0 </span><span class="s2">= [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">x_opt </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">ftol</span><span class="s2">, </span><span class="s1">xtol</span><span class="s2">, </span><span class="s1">gtol </span><span class="s0">in </span><span class="s2">[(</span><span class="s3">1e-8</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">1e-8</span><span class="s2">, </span><span class="s0">None</span><span class="s2">),</span>
                                  <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">1e-8</span><span class="s2">)]:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_rosenbrock</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac_rosenbrock</span><span class="s2">,</span>
                                <span class="s1">ftol</span><span class="s2">=</span><span class="s1">ftol</span><span class="s2">, </span><span class="s1">gtol</span><span class="s2">=</span><span class="s1">gtol</span><span class="s2">, </span><span class="s1">xtol</span><span class="s2">=</span><span class="s1">xtol</span><span class="s2">,</span>
                                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x_opt</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">BoundsMixin</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_inconsistent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">bounds</span><span class="s2">=(</span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_infeasible</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">bounds</span><span class="s2">=(</span><span class="s3">3.</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wrong_number</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">,</span>
                      <span class="s1">bounds</span><span class="s2">=(</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inconsistent_shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">bounds</span><span class="s2">=(</span><span class="s3">1.0</span><span class="s2">, [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">]), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s4"># 1-D array wont't be broadcasted</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_rosenbrock</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                      <span class="s1">bounds</span><span class="s2">=([</span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">]), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_in_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">jac </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">]:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">,</span>
                                <span class="s1">bounds</span><span class="s2">=(-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">active_mask</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">])</span>
            <span class="s1">assert_</span><span class="s2">(-</span><span class="s3">1 </span><span class="s2">&lt;= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s3">3</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">,</span>
                                <span class="s1">bounds</span><span class="s2">=(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">active_mask</span><span class="s2">, [-</span><span class="s3">1</span><span class="s2">])</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s3">0.5 </span><span class="s2">&lt;= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s3">3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bounds_shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">def </span><span class="s1">get_bounds_direct</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">ub</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">lb</span><span class="s2">, </span><span class="s1">ub</span>

        <span class="s0">def </span><span class="s1">get_bounds_instances</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">ub</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">ub</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">jac </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_2d_trivial</span><span class="s2">]:</span>
            <span class="s0">for </span><span class="s1">bounds_func </span><span class="s0">in </span><span class="s2">[</span><span class="s1">get_bounds_direct</span><span class="s2">, </span><span class="s1">get_bounds_instances</span><span class="s2">]:</span>
                <span class="s1">x0 </span><span class="s2">= [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_2d_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">])</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_2d_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">,</span>
                                    <span class="s1">bounds</span><span class="s2">=</span><span class="s1">bounds_func</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, [</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">]),</span>
                                    <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_2d_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">,</span>
                                    <span class="s1">bounds</span><span class="s2">=</span><span class="s1">bounds_func</span><span class="s2">([</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">], </span><span class="s3">3.0</span><span class="s2">),</span>
                                    <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">])</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                    <span class="s1">fun_2d_trivial</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">,</span>
                    <span class="s1">bounds</span><span class="s2">=</span><span class="s1">bounds_func</span><span class="s2">([-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">]),</span>
                    <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bounds_instances</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=</span><span class="s1">Bounds</span><span class="s2">())</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=</span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=</span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">=-</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">ub</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, -</span><span class="s3">3.0</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=</span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">ub</span><span class="s2">=-</span><span class="s3">1.0</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_2d_trivial</span><span class="s2">, [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">],</span>
                            <span class="s1">bounds</span><span class="s2">=</span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">=[-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">ub</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-5</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_2d_trivial</span><span class="s2">, [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">],</span>
                            <span class="s1">bounds</span><span class="s2">=</span><span class="s1">Bounds</span><span class="s2">(</span><span class="s1">lb</span><span class="s2">=[</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">]))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, [</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-5</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">fail_slow</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_rosenbrock_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0_1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">x0_2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>
        <span class="s1">x0_3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>
        <span class="s1">x0_4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">])</span>
        <span class="s1">x0_5 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>
        <span class="s1">problems </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">x0_1</span><span class="s2">, ([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s3">1.5</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">x0_2</span><span class="s2">, ([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">x0_3</span><span class="s2">, ([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">x0_4</span><span class="s2">, ([-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">], [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])),</span>
            <span class="s2">(</span><span class="s1">x0_2</span><span class="s2">, ([</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">], [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">])),</span>
            <span class="s2">(</span><span class="s1">x0_5</span><span class="s2">, ([-</span><span class="s3">50.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">], [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">100</span><span class="s2">]))</span>
        <span class="s2">]</span>
        <span class="s0">for </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">bounds </span><span class="s0">in </span><span class="s1">problems</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">, </span><span class="s1">tr_solver </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span>
                    <span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">jac_rosenbrock</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s3">1.0</span><span class="s2">, [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">], </span><span class="s5">'jac'</span><span class="s2">],</span>
                    <span class="s2">[</span><span class="s5">'exact'</span><span class="s2">, </span><span class="s5">'lsmr'</span><span class="s2">]):</span>
                <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_rosenbrock</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">,</span>
                                    <span class="s1">x_scale</span><span class="s2">=</span><span class="s1">x_scale</span><span class="s2">, </span><span class="s1">tr_solver</span><span class="s2">=</span><span class="s1">tr_solver</span><span class="s2">,</span>
                                    <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-5</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SparseMixin</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_exact_tr_solver</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">tr_solver</span><span class="s2">=</span><span class="s5">'exact'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">tr_solver</span><span class="s2">=</span><span class="s5">'exact'</span><span class="s2">, </span><span class="s1">jac_sparsity</span><span class="s2">=</span><span class="s1">p</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equivalence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sparse </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'sparse'</span><span class="s2">)</span>
        <span class="s1">dense </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'dense'</span><span class="s2">)</span>
        <span class="s1">res_sparse </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
            <span class="s1">sparse</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
            <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">res_dense </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
            <span class="s1">dense</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">dense</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
            <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tr_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">,</span>
                            <span class="s1">tr_options</span><span class="s2">={</span><span class="s5">'btol'</span><span class="s2">: </span><span class="s3">1e-10</span><span class="s2">})</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wrong_parameters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">tr_solver</span><span class="s2">=</span><span class="s5">'best'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">tr_solver</span><span class="s2">=</span><span class="s5">'lsmr'</span><span class="s2">, </span><span class="s1">tr_options</span><span class="s2">={</span><span class="s5">'tol'</span><span class="s2">: </span><span class="s3">1e-10</span><span class="s2">})</span>

    <span class="s0">def </span><span class="s1">test_solver_selection</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">sparse </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'sparse'</span><span class="s2">)</span>
        <span class="s1">dense </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'dense'</span><span class="s2">)</span>
        <span class="s1">res_sparse </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                                   <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">res_dense </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">dense</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">dense</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">dense</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                                  <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">issparse</span><span class="s2">(</span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_numerical_jac</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">jac </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">]:</span>
            <span class="s1">res_dense </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">res_sparse </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                <span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">,</span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">,</span>
                <span class="s1">jac_sparsity</span><span class="s2">=</span><span class="s1">p</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_dense</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_sparse</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">fail_slow</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_with_bounds</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">jac_sparsity </span><span class="s0">in </span><span class="s1">product</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">]):</span>
            <span class="s1">res_1 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                <span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">),</span>
                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">,</span><span class="s1">jac_sparsity</span><span class="s2">=</span><span class="s1">jac_sparsity</span><span class="s2">)</span>
            <span class="s1">res_2 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                <span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=(-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">ub</span><span class="s2">),</span>
                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">jac_sparsity</span><span class="s2">=</span><span class="s1">jac_sparsity</span><span class="s2">)</span>
            <span class="s1">res_3 </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                <span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">lb</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">ub</span><span class="s2">),</span>
                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">jac_sparsity</span><span class="s2">=</span><span class="s1">jac_sparsity</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_1</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_2</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_3</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wrong_jac_sparsity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s1">sparsity </span><span class="s2">= </span><span class="s1">p</span><span class="s2">.</span><span class="s1">sparsity</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">jac_sparsity</span><span class="s2">=</span><span class="s1">sparsity</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_linear_operator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'operator'</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">tr_solver</span><span class="s2">=</span><span class="s5">'exact'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x_scale_jac_scale</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">,</span>
                            <span class="s1">x_scale</span><span class="s2">=</span><span class="s5">'jac'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>

        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'operator'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">, </span><span class="s1">x_scale</span><span class="s2">=</span><span class="s5">'jac'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">LossFunctionMixin</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_options</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">loss </span><span class="s0">in </span><span class="s1">LOSSES</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s1">loss</span><span class="s2">,</span>
                                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">loss</span><span class="s2">=</span><span class="s5">'hinge'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fun</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that res.fun is actual residuals, and not modified by loss</span>
        <span class="s4"># function stuff.</span>
        <span class="s0">for </span><span class="s1">loss </span><span class="s0">in </span><span class="s1">LOSSES</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s1">loss</span><span class="s2">,</span>
                                <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_grad</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that res.grad is true gradient of loss function at the</span>
        <span class="s4"># solution. Use max_nfev = 1, to avoid reaching minimum.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">2.0</span><span class="s2">])  </span><span class="s4"># res.x will be this.</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'linear'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">))</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'huber'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'soft_l1'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">,</span>
                        <span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">) / (</span><span class="s3">1 </span><span class="s2">+ (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)**</span><span class="s3">0.5</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'cauchy'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">) / (</span><span class="s3">1 </span><span class="s2">+ (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">))</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'arctan'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">) / (</span><span class="s3">1 </span><span class="s2">+ (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">)**</span><span class="s3">4</span><span class="s2">))</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s1">cubic_soft_l1</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">,</span>
                        <span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">) / (</span><span class="s3">1 </span><span class="s2">+ (</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5</span><span class="s2">)**</span><span class="s3">2</span><span class="s2">)**(</span><span class="s3">2</span><span class="s2">/</span><span class="s3">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_jac</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s4"># Test that res.jac.T.dot(res.jac) gives Gauss-Newton approximation</span>
        <span class="s4"># of Hessian. This approximation is computed by doubly differentiating</span>
        <span class="s4"># the cost function and dropping the part containing second derivative</span>
        <span class="s4"># of f. For a scalar function it is computed as</span>
        <span class="s4"># H = (rho' + 2 * rho'' * f**2) * f'**2, if the expression inside the</span>
        <span class="s4"># brackets is less than EPS it is replaced by EPS. Here, we check</span>
        <span class="s4"># against the root of H.</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s3">2.0  </span><span class="s4"># res.x will be this.</span>
        <span class="s1">f </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">+ </span><span class="s3">5  </span><span class="s4"># res.fun will be this.</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'linear'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s4"># For `huber` loss the Jacobian correction is identically zero</span>
        <span class="s4"># in outlier region, in such cases it is modified to be equal EPS**0.5.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'huber'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* </span><span class="s1">EPS</span><span class="s2">**</span><span class="s3">0.5</span><span class="s2">)</span>

        <span class="s4"># Now, let's apply `loss_scale` to turn the residual into an inlier.</span>
        <span class="s4"># The loss function becomes linear.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'huber'</span><span class="s2">,</span>
                            <span class="s1">f_scale</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">)</span>

        <span class="s4"># 'soft_l1' always gives a positive scaling.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'soft_l1'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">f</span><span class="s2">**</span><span class="s3">2</span><span class="s2">)**-</span><span class="s3">0.75</span><span class="s2">)</span>

        <span class="s4"># For 'cauchy' the correction term turns out to be negative, and it</span>
        <span class="s4"># replaced by EPS**0.5.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'cauchy'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* </span><span class="s1">EPS</span><span class="s2">**</span><span class="s3">0.5</span><span class="s2">)</span>

        <span class="s4"># Now use scaling to turn the residual to inlier.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'cauchy'</span><span class="s2">,</span>
                            <span class="s1">f_scale</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">fs </span><span class="s2">= </span><span class="s1">f </span><span class="s2">/ </span><span class="s3">10</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">fs</span><span class="s2">**</span><span class="s3">2</span><span class="s2">)**</span><span class="s3">0.5 </span><span class="s2">/ (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">fs</span><span class="s2">**</span><span class="s3">2</span><span class="s2">))</span>

        <span class="s4"># 'arctan' gives an outlier.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'arctan'</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* </span><span class="s1">EPS</span><span class="s2">**</span><span class="s3">0.5</span><span class="s2">)</span>

        <span class="s4"># Turn to inlier.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'arctan'</span><span class="s2">,</span>
                            <span class="s1">f_scale</span><span class="s2">=</span><span class="s3">20.0</span><span class="s2">, </span><span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s1">fs </span><span class="s2">= </span><span class="s1">f </span><span class="s2">/ </span><span class="s3">20</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">- </span><span class="s3">3 </span><span class="s2">* </span><span class="s1">fs</span><span class="s2">**</span><span class="s3">4</span><span class="s2">)**</span><span class="s3">0.5 </span><span class="s2">/ (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">fs</span><span class="s2">**</span><span class="s3">4</span><span class="s2">))</span>

        <span class="s4"># cubic_soft_l1 will give an outlier.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s1">cubic_soft_l1</span><span class="s2">,</span>
                            <span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* </span><span class="s1">EPS</span><span class="s2">**</span><span class="s3">0.5</span><span class="s2">)</span>

        <span class="s4"># Turn to inlier.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">jac_trivial</span><span class="s2">,</span>
                            <span class="s1">loss</span><span class="s2">=</span><span class="s1">cubic_soft_l1</span><span class="s2">, </span><span class="s1">f_scale</span><span class="s2">=</span><span class="s3">6</span><span class="s2">, </span><span class="s1">max_nfev</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">fs </span><span class="s2">= </span><span class="s1">f </span><span class="s2">/ </span><span class="s3">6</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                        <span class="s3">2 </span><span class="s2">* </span><span class="s1">x </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">fs</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">/ </span><span class="s3">3</span><span class="s2">)**</span><span class="s3">0.5 </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">fs</span><span class="s2">**</span><span class="s3">2</span><span class="s2">)**(-</span><span class="s3">5</span><span class="s2">/</span><span class="s3">6</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_robustness</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">noise </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">]:</span>
            <span class="s1">p </span><span class="s2">= </span><span class="s1">ExponentialFittingProblem</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">noise</span><span class="s2">, </span><span class="s1">random_seed</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

            <span class="s0">for </span><span class="s1">jac </span><span class="s0">in </span><span class="s2">[</span><span class="s5">'2-point'</span><span class="s2">, </span><span class="s5">'3-point'</span><span class="s2">, </span><span class="s5">'cs'</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">]:</span>
                <span class="s1">res_lsq </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">,</span>
                                        <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_lsq</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-2</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">loss </span><span class="s0">in </span><span class="s1">LOSSES</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">loss </span><span class="s2">== </span><span class="s5">'linear'</span><span class="s2">:</span>
                        <span class="s0">continue</span>
                    <span class="s1">res_robust </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span>
                        <span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">p0</span><span class="s2">, </span><span class="s1">jac</span><span class="s2">=</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s1">loss</span><span class="s2">, </span><span class="s1">f_scale</span><span class="s2">=</span><span class="s1">noise</span><span class="s2">,</span>
                        <span class="s1">method</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">method</span><span class="s2">)</span>
                    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res_robust</span><span class="s2">.</span><span class="s1">optimality</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-2</span><span class="s2">)</span>
                    <span class="s1">assert_</span><span class="s2">(</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">res_robust</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">p</span><span class="s2">.</span><span class="s1">p_opt</span><span class="s2">) &lt;</span>
                            <span class="s1">norm</span><span class="s2">(</span><span class="s1">res_lsq</span><span class="s2">.</span><span class="s1">x </span><span class="s2">- </span><span class="s1">p</span><span class="s2">.</span><span class="s1">p_opt</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestDogbox</span><span class="s2">(</span><span class="s1">BaseMixin</span><span class="s2">, </span><span class="s1">BoundsMixin</span><span class="s2">, </span><span class="s1">SparseMixin</span><span class="s2">, </span><span class="s1">LossFunctionMixin</span><span class="s2">):</span>
    <span class="s1">method </span><span class="s2">= </span><span class="s5">'dogbox'</span>


<span class="s0">class </span><span class="s1">TestTRF</span><span class="s2">(</span><span class="s1">BaseMixin</span><span class="s2">, </span><span class="s1">BoundsMixin</span><span class="s2">, </span><span class="s1">SparseMixin</span><span class="s2">, </span><span class="s1">LossFunctionMixin</span><span class="s2">):</span>
    <span class="s1">method </span><span class="s2">= </span><span class="s5">'trf'</span>

    <span class="s0">def </span><span class="s1">test_lsmr_regularization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">regularize </span><span class="s0">in </span><span class="s2">[</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'trf'</span><span class="s2">,</span>
                                <span class="s1">tr_options</span><span class="s2">={</span><span class="s5">'regularize'</span><span class="s2">: </span><span class="s1">regularize</span><span class="s2">})</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">cost</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-20</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLM</span><span class="s2">(</span><span class="s1">BaseMixin</span><span class="s2">):</span>
    <span class="s1">method </span><span class="s2">= </span><span class="s5">'lm'</span>

    <span class="s0">def </span><span class="s1">test_bounds_not_supported</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">,</span>
                      <span class="s3">2.0</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=(-</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">), </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_m_less_n_not_supported</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x0 </span><span class="s2">= [-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_rosenbrock_cropped</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sparse_not_supported</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">()</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_jac_sparsity_not_supported</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">jac_sparsity</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_LinearOperator_not_supported</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">BroydenTridiagonal</span><span class="s2">(</span><span class="s1">mode</span><span class="s2">=</span><span class="s5">&quot;operator&quot;</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">p</span><span class="s2">.</span><span class="s1">jac</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_loss</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'linear'</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-4</span><span class="s2">)</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">,</span>
                      <span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">, </span><span class="s1">loss</span><span class="s2">=</span><span class="s5">'huber'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_basic</span><span class="s2">():</span>
    <span class="s4"># test that 'method' arg is really optional</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-10</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_small_tolerances_for_lm</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">ftol</span><span class="s2">, </span><span class="s1">xtol</span><span class="s2">, </span><span class="s1">gtol </span><span class="s0">in </span><span class="s2">[(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">1e-13</span><span class="s2">, </span><span class="s3">1e-13</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s3">1e-13</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">1e-13</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s3">1e-13</span><span class="s2">, </span><span class="s3">1e-13</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]:</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">least_squares</span><span class="s2">, </span><span class="s1">fun_trivial</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s1">xtol</span><span class="s2">=</span><span class="s1">xtol</span><span class="s2">,</span>
                      <span class="s1">ftol</span><span class="s2">=</span><span class="s1">ftol</span><span class="s2">, </span><span class="s1">gtol</span><span class="s2">=</span><span class="s1">gtol</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'lm'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_fp32_gh12991</span><span class="s2">():</span>
    <span class="s4"># checks that smaller FP sizes can be used in least_squares</span>
    <span class="s4"># this is the minimum working example reported for gh12991</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s3">1</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">100</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;float32&quot;</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s3">100</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;float32&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">p</span><span class="s2">[</span><span class="s3">0</span><span class="s2">] + </span><span class="s1">p</span><span class="s2">[</span><span class="s3">1</span><span class="s2">] * </span><span class="s1">x</span>

    <span class="s0">def </span><span class="s1">err</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">func</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">x</span><span class="s2">) - </span><span class="s1">y</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">err</span><span class="s2">, [-</span><span class="s3">1.0</span><span class="s2">, -</span><span class="s3">1.0</span><span class="s2">], </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">))</span>
    <span class="s4"># previously the initial jacobian calculated for this would be all 0</span>
    <span class="s4"># and the minimize would terminate immediately, with nfev=1, would</span>
    <span class="s4"># report a successful minimization (it shouldn't have done), but be</span>
    <span class="s4"># unchanged from the initial solution.</span>
    <span class="s4"># It was terminating early because the underlying approx_derivative</span>
    <span class="s4"># used a step size for FP64 when the working space was FP32.</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">&gt; </span><span class="s3">2</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.4082241</span><span class="s2">, </span><span class="s3">0.15530563</span><span class="s2">]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">5e-5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_gh_18793_and_19351</span><span class="s2">():</span>
    <span class="s1">answer </span><span class="s2">= </span><span class="s3">1e-12</span>
    <span class="s1">initial_guess </span><span class="s2">= </span><span class="s3">1.1e-12</span>

    <span class="s0">def </span><span class="s1">chi2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s1">answer</span><span class="s2">)**</span><span class="s3">2</span>

    <span class="s1">gtol </span><span class="s2">= </span><span class="s3">1e-15</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">chi2</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">=</span><span class="s1">initial_guess</span><span class="s2">, </span><span class="s1">gtol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>
    <span class="s4"># Original motivation: gh-18793</span>
    <span class="s4"># if we choose an initial condition that is close to the solution</span>
    <span class="s4"># we shouldn't return an answer that is further away from the solution</span>

    <span class="s4"># Update: gh-19351</span>
    <span class="s4"># However this requirement does not go well with 'trf' algorithm logic.</span>
    <span class="s4"># Some regressions were reported after the presumed fix.</span>
    <span class="s4"># The returned solution is good as long as it satisfies the convergence</span>
    <span class="s4"># conditions.</span>
    <span class="s4"># Specifically in this case the scaled gradient will be sufficiently low.</span>

    <span class="s1">scaling</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">CL_scaling_vector</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad</span><span class="s2">,</span>
                                   <span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_1d</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_1d</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status </span><span class="s2">== </span><span class="s3">1  </span><span class="s4"># Converged by gradient</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">grad </span><span class="s2">* </span><span class="s1">scaling</span><span class="s2">, </span><span class="s1">ord</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">) &lt; </span><span class="s1">gtol</span>


<span class="s0">def </span><span class="s1">test_gh_19103</span><span class="s2">():</span>
    <span class="s4"># Checks that least_squares trf method selects a strictly feasible point,</span>
    <span class="s4"># and thus succeeds instead of failing,</span>
    <span class="s4"># when the initial guess is reported exactly at a boundary point.</span>
    <span class="s4"># This is a reduced example from gh191303</span>

    <span class="s1">ydata </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">] * </span><span class="s3">66 </span><span class="s2">+ [</span>
        <span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">,</span>
        <span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">,</span>
        <span class="s3">0.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">6.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">8.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">, </span><span class="s3">4.</span><span class="s2">,</span>
        <span class="s3">6.</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">, </span><span class="s3">7.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">7.</span><span class="s2">, </span><span class="s3">8.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">, </span><span class="s3">13.</span><span class="s2">, </span><span class="s3">9.</span><span class="s2">, </span><span class="s3">8.</span><span class="s2">, </span><span class="s3">11.</span><span class="s2">,</span>
        <span class="s3">10.</span><span class="s2">, </span><span class="s3">13.</span><span class="s2">, </span><span class="s3">14.</span><span class="s2">, </span><span class="s3">19.</span><span class="s2">, </span><span class="s3">11.</span><span class="s2">, </span><span class="s3">15.</span><span class="s2">, </span><span class="s3">18.</span><span class="s2">, </span><span class="s3">26.</span><span class="s2">, </span><span class="s3">19.</span><span class="s2">, </span><span class="s3">32.</span><span class="s2">, </span><span class="s3">29.</span><span class="s2">,</span>
        <span class="s3">28.</span><span class="s2">, </span><span class="s3">36.</span><span class="s2">, </span><span class="s3">32.</span><span class="s2">, </span><span class="s3">35.</span><span class="s2">, </span><span class="s3">36.</span><span class="s2">, </span><span class="s3">43.</span><span class="s2">, </span><span class="s3">52.</span><span class="s2">, </span><span class="s3">32.</span><span class="s2">, </span><span class="s3">58.</span><span class="s2">, </span><span class="s3">56.</span><span class="s2">, </span><span class="s3">52.</span><span class="s2">,</span>
        <span class="s3">67.</span><span class="s2">, </span><span class="s3">53.</span><span class="s2">, </span><span class="s3">72.</span><span class="s2">, </span><span class="s3">88.</span><span class="s2">, </span><span class="s3">77.</span><span class="s2">, </span><span class="s3">95.</span><span class="s2">, </span><span class="s3">94.</span><span class="s2">, </span><span class="s3">84.</span><span class="s2">, </span><span class="s3">86.</span><span class="s2">, </span><span class="s3">101.</span><span class="s2">, </span><span class="s3">107.</span><span class="s2">,</span>
        <span class="s3">108.</span><span class="s2">, </span><span class="s3">118.</span><span class="s2">, </span><span class="s3">96.</span><span class="s2">, </span><span class="s3">115.</span><span class="s2">, </span><span class="s3">138.</span><span class="s2">, </span><span class="s3">137.</span><span class="s2">,</span>
    <span class="s2">])</span>
    <span class="s1">xdata </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">ydata</span><span class="s2">.</span><span class="s1">size</span><span class="s2">) * </span><span class="s3">0.1</span>

    <span class="s0">def </span><span class="s1">exponential_wrapped</span><span class="s2">(</span><span class="s1">params</span><span class="s2">):</span>
        <span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">x0 </span><span class="s2">= </span><span class="s1">params</span>
        <span class="s0">return </span><span class="s1">A </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">B </span><span class="s2">* (</span><span class="s1">xdata </span><span class="s2">- </span><span class="s1">x0</span><span class="s2">)) - </span><span class="s1">ydata</span>

    <span class="s1">x0 </span><span class="s2">= [</span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">5.</span><span class="s2">]</span>
    <span class="s1">bounds </span><span class="s2">= ((</span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">), (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s3">20.9</span><span class="s2">))</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">least_squares</span><span class="s2">(</span><span class="s1">exponential_wrapped</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'trf'</span><span class="s2">, </span><span class="s1">bounds</span><span class="s2">=</span><span class="s1">bounds</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span>
</pre>
</body>
</html>