<html>
<head>
<title>_libsvm_sparse.pyx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_libsvm_sparse.pyx</font>
</center></td></tr></table>
<pre><span class="s0">import  </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_cython_blas </span><span class="s0">cimport </span><span class="s1">_dot</span>
<span class="s0">from </span><span class="s2">..</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_typedefs </span><span class="s0">cimport </span><span class="s1">float64_t</span><span class="s2">, </span><span class="s1">int32_t</span><span class="s2">, </span><span class="s1">intp_t</span>

<span class="s0">cdef </span><span class="s1">extern </span><span class="s0">from </span><span class="s2">*:</span>
    <span class="s0">ctypedef </span><span class="s1">char</span><span class="s2">* </span><span class="s1">const_char_p </span><span class="s3">&quot;const char*&quot;</span>

<span class="s4">################################################################################</span>
<span class="s4"># Includes</span>

<span class="s0">cdef </span><span class="s1">extern </span><span class="s0">from </span><span class="s3">&quot;_svm_cython_blas_helpers.h&quot;</span><span class="s2">:</span>
    <span class="s0">ctypedef </span><span class="s1">double </span><span class="s2">(*</span><span class="s1">dot_func</span><span class="s2">)(</span><span class="s1">int</span><span class="s2">, </span><span class="s1">const double</span><span class="s2">*, </span><span class="s1">int</span><span class="s2">, </span><span class="s1">const double</span><span class="s2">*, </span><span class="s1">int</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">struct BlasFunctions</span><span class="s2">:</span>
        <span class="s1">dot_func dot</span>

<span class="s0">cdef </span><span class="s1">extern </span><span class="s0">from </span><span class="s3">&quot;svm.h&quot;</span><span class="s2">:</span>
    <span class="s0">cdef </span><span class="s1">struct svm_csr_node</span>
    <span class="s0">cdef </span><span class="s1">struct svm_csr_model</span>
    <span class="s0">cdef </span><span class="s1">struct svm_parameter</span>
    <span class="s0">cdef </span><span class="s1">struct svm_csr_problem</span>
    <span class="s1">char </span><span class="s2">*</span><span class="s1">svm_csr_check_parameter</span><span class="s2">(</span><span class="s1">svm_csr_problem </span><span class="s2">*, </span><span class="s1">svm_parameter </span><span class="s2">*)</span>
    <span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">svm_csr_train</span><span class="s2">(</span><span class="s1">svm_csr_problem </span><span class="s2">*, </span><span class="s1">svm_parameter </span><span class="s2">*, </span><span class="s1">int </span><span class="s2">*, </span><span class="s1">BlasFunctions </span><span class="s2">*) </span><span class="s1">nogil</span>
    <span class="s1">void svm_csr_free_and_destroy_model</span><span class="s2">(</span><span class="s1">svm_csr_model</span><span class="s2">** </span><span class="s1">model_ptr_ptr</span><span class="s2">)</span>

<span class="s0">cdef </span><span class="s1">extern </span><span class="s0">from </span><span class="s3">&quot;libsvm_sparse_helper.c&quot;</span><span class="s2">:</span>
    <span class="s4"># this file contains methods for accessing libsvm 'hidden' fields</span>
    <span class="s1">svm_csr_problem </span><span class="s2">* </span><span class="s1">csr_set_problem </span><span class="s2">(</span>
        <span class="s1">char </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">csr_set_model</span><span class="s2">(</span><span class="s1">svm_parameter </span><span class="s2">*</span><span class="s1">param</span><span class="s2">, </span><span class="s1">int nr_class</span><span class="s2">,</span>
                                 <span class="s1">char </span><span class="s2">*</span><span class="s1">SV_data</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">SV_indices_dims</span><span class="s2">,</span>
                                 <span class="s1">char </span><span class="s2">*</span><span class="s1">SV_indices</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">SV_intptr_dims</span><span class="s2">,</span>
                                 <span class="s1">char </span><span class="s2">*</span><span class="s1">SV_intptr</span><span class="s2">,</span>
                                 <span class="s1">char </span><span class="s2">*</span><span class="s1">sv_coef</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">rho</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">nSV</span><span class="s2">,</span>
                                 <span class="s1">char </span><span class="s2">*</span><span class="s1">probA</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">probB</span><span class="s2">)</span>
    <span class="s1">svm_parameter </span><span class="s2">*</span><span class="s1">set_parameter </span><span class="s2">(</span><span class="s1">int </span><span class="s2">, </span><span class="s1">int </span><span class="s2">, </span><span class="s1">int </span><span class="s2">, </span><span class="s1">double</span><span class="s2">, </span><span class="s1">double </span><span class="s2">,</span>
                                  <span class="s1">double </span><span class="s2">, </span><span class="s1">double </span><span class="s2">, </span><span class="s1">double </span><span class="s2">, </span><span class="s1">double</span><span class="s2">,</span>
                                  <span class="s1">double</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s1">int</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">int</span><span class="s2">,</span>
                                  <span class="s1">int</span><span class="s2">)</span>
    <span class="s1">void copy_sv_coef   </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">void copy_n_iter  </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">void copy_support   </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">void copy_intercept </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*)</span>
    <span class="s1">int copy_predict </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">BlasFunctions </span><span class="s2">*)</span>
    <span class="s1">int csr_copy_predict_values </span><span class="s2">(</span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">data_size</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">index_size</span><span class="s2">,</span>
                                 <span class="s1">char </span><span class="s2">*</span><span class="s1">index</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">intptr_size</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">size</span><span class="s2">,</span>
                                 <span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">dec_values</span><span class="s2">, </span><span class="s1">int nr_class</span><span class="s2">, </span><span class="s1">BlasFunctions </span><span class="s2">*)</span>
    <span class="s1">int csr_copy_predict </span><span class="s2">(</span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">data_size</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">index_size</span><span class="s2">,</span>
                          <span class="s1">char </span><span class="s2">*</span><span class="s1">index</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">intptr_size</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">size</span><span class="s2">,</span>
                          <span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">dec_values</span><span class="s2">, </span><span class="s1">BlasFunctions </span><span class="s2">*) </span><span class="s1">nogil</span>
    <span class="s1">int csr_copy_predict_proba </span><span class="s2">(</span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">data_size</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">data</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">index_size</span><span class="s2">,</span>
                                <span class="s1">char </span><span class="s2">*</span><span class="s1">index</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">intptr_size</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">size</span><span class="s2">,</span>
                                <span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">dec_values</span><span class="s2">, </span><span class="s1">BlasFunctions </span><span class="s2">*) </span><span class="s1">nogil</span>

    <span class="s1">int  copy_predict_values</span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*, </span><span class="s1">char </span><span class="s2">*, </span><span class="s1">int</span><span class="s2">, </span><span class="s1">BlasFunctions </span><span class="s2">*)</span>
    <span class="s1">int  csr_copy_SV </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*</span><span class="s1">values</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">n_indices</span><span class="s2">,</span>
                      <span class="s1">char </span><span class="s2">*</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">intp_t </span><span class="s2">*</span><span class="s1">n_indptr</span><span class="s2">, </span><span class="s1">char </span><span class="s2">*</span><span class="s1">indptr</span><span class="s2">,</span>
                      <span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span><span class="s2">, </span><span class="s1">int n_features</span><span class="s2">)</span>
    <span class="s1">intp_t get_nonzero_SV </span><span class="s2">(</span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">void copy_nSV     </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">void copy_probA   </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*)</span>
    <span class="s1">void copy_probB   </span><span class="s2">(</span><span class="s1">char </span><span class="s2">*, </span><span class="s1">svm_csr_model </span><span class="s2">*, </span><span class="s1">intp_t </span><span class="s2">*)</span>
    <span class="s1">intp_t  get_l  </span><span class="s2">(</span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">intp_t  get_nr </span><span class="s2">(</span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">int  free_problem   </span><span class="s2">(</span><span class="s1">svm_csr_problem </span><span class="s2">*)</span>
    <span class="s1">int  free_model     </span><span class="s2">(</span><span class="s1">svm_csr_model </span><span class="s2">*)</span>
    <span class="s1">int  free_param     </span><span class="s2">(</span><span class="s1">svm_parameter </span><span class="s2">*)</span>
    <span class="s1">int free_model_SV</span><span class="s2">(</span><span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">void set_verbosity</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">libsvm_sparse_train </span><span class="s2">(</span><span class="s1">int n_features</span><span class="s2">,</span>
                         <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">values</span><span class="s2">,</span>
                         <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">indices</span><span class="s2">,</span>
                         <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">indptr</span><span class="s2">,</span>
                         <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">Y</span><span class="s2">,</span>
                         <span class="s1">int svm_type</span><span class="s2">, </span><span class="s1">int kernel_type</span><span class="s2">, </span><span class="s1">int degree</span><span class="s2">, </span><span class="s1">double gamma</span><span class="s2">,</span>
                         <span class="s1">double coef0</span><span class="s2">, </span><span class="s1">double eps</span><span class="s2">, </span><span class="s1">double C</span><span class="s2">,</span>
                         <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">class_weight</span><span class="s2">,</span>
                         <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">sample_weight</span><span class="s2">,</span>
                         <span class="s1">double nu</span><span class="s2">, </span><span class="s1">double cache_size</span><span class="s2">, </span><span class="s1">double p</span><span class="s2">, </span><span class="s1">int</span>
                         <span class="s1">shrinking</span><span class="s2">, </span><span class="s1">int probability</span><span class="s2">, </span><span class="s1">int max_iter</span><span class="s2">,</span>
                         <span class="s1">int random_seed</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Wrap svm_train from libsvm using a scipy.sparse.csr matrix 
 
    Work in progress. 
 
    Parameters 
    ---------- 
    n_features : number of features. 
        XXX: can we retrieve this from any other parameter ? 
 
    X : array-like, dtype=float, size=[N, D] 
 
    Y : array, dtype=float, size=[N] 
        target vector 
 
    ... 
 
    Notes 
    ------------------- 
    See sklearn.svm.predict for a complete list of parameters. 
 
    &quot;&quot;&quot;</span>

    <span class="s0">cdef </span><span class="s1">svm_parameter </span><span class="s2">*</span><span class="s1">param</span>
    <span class="s0">cdef </span><span class="s1">svm_csr_problem </span><span class="s2">*</span><span class="s1">problem</span>
    <span class="s0">cdef </span><span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span>
    <span class="s0">cdef </span><span class="s1">const_char_p error_msg</span>

    <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">sample_weight</span><span class="s2">) == </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s1">sample_weight </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">sample_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] - </span><span class="s5">1</span><span class="s2">, </span><span class="s1">\</span>
               <span class="s3">&quot;sample_weight and X have incompatible shapes: &quot; </span><span class="s2">+ </span><span class="s1">\</span>
               <span class="s3">&quot;sample_weight has %s samples while X has %s&quot; </span><span class="s2">% </span><span class="s1">\</span>
               <span class="s2">(</span><span class="s1">sample_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] - </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s4"># we should never end up here with a precomputed kernel matrix,</span>
    <span class="s4"># as this is always dense.</span>
    <span class="s0">assert</span><span class="s2">(</span><span class="s1">kernel_type </span><span class="s2">!= </span><span class="s5">4</span><span class="s2">)</span>

    <span class="s4"># set libsvm problem</span>
    <span class="s1">problem </span><span class="s2">= </span><span class="s1">csr_set_problem</span><span class="s2">(</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">Y</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">sample_weight</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s1">kernel_type</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">\</span>
        <span class="s1">class_weight_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

    <span class="s4"># set parameters</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s1">set_parameter</span><span class="s2">(</span>
        <span class="s1">svm_type</span><span class="s2">,</span>
        <span class="s1">kernel_type</span><span class="s2">,</span>
        <span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">coef0</span><span class="s2">,</span>
        <span class="s1">nu</span><span class="s2">,</span>
        <span class="s1">cache_size</span><span class="s2">,</span>
        <span class="s1">C</span><span class="s2">,</span>
        <span class="s1">eps</span><span class="s2">,</span>
        <span class="s1">p</span><span class="s2">,</span>
        <span class="s1">shrinking</span><span class="s2">,</span>
        <span class="s1">probability</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight_label</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight_label</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">, </span><span class="s1">max_iter</span><span class="s2">,</span>
        <span class="s1">random_seed</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s4"># check parameters</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s1">param </span><span class="s2">== </span><span class="s1">NULL </span><span class="s0">or </span><span class="s1">problem </span><span class="s2">== </span><span class="s1">NULL</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s3">&quot;Seems we've run out of memory&quot;</span><span class="s2">)</span>
    <span class="s1">error_msg </span><span class="s2">= </span><span class="s1">svm_csr_check_parameter</span><span class="s2">(</span><span class="s1">problem</span><span class="s2">, </span><span class="s1">param</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">error_msg</span><span class="s2">:</span>
        <span class="s1">free_problem</span><span class="s2">(</span><span class="s1">problem</span><span class="s2">)</span>
        <span class="s1">free_param</span><span class="s2">(</span><span class="s1">param</span><span class="s2">)</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s1">error_msg</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">BlasFunctions blas_functions</span>
    <span class="s1">blas_functions</span><span class="s2">.</span><span class="s1">dot </span><span class="s2">= </span><span class="s1">_dot</span><span class="s2">[</span><span class="s1">double</span><span class="s2">]</span>
    <span class="s4"># call svm_train, this does the real work</span>
    <span class="s0">cdef </span><span class="s1">int fit_status </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s0">with </span><span class="s1">nogil</span><span class="s2">:</span>
        <span class="s1">model </span><span class="s2">= </span><span class="s1">svm_csr_train</span><span class="s2">(</span><span class="s1">problem</span><span class="s2">, </span><span class="s1">param</span><span class="s2">, &amp;</span><span class="s1">fit_status</span><span class="s2">, &amp;</span><span class="s1">blas_functions</span><span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">intp_t SV_len </span><span class="s2">= </span><span class="s1">get_l</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">intp_t n_class </span><span class="s2">= </span><span class="s1">get_nr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">int</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">n_iter</span>
    <span class="s1">n_iter </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">max</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_class </span><span class="s2">* (</span><span class="s1">n_class </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) // </span><span class="s5">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intc</span><span class="s2">)</span>
    <span class="s1">copy_n_iter</span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">n_iter</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">model</span><span class="s2">)</span>

    <span class="s4"># copy model.sv_coef</span>
    <span class="s4"># we create a new array instead of resizing, otherwise</span>
    <span class="s4"># it would not erase previous information</span>
    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">sv_coef_data</span>
    <span class="s1">sv_coef_data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">n_class</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)*</span><span class="s1">SV_len</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">copy_sv_coef </span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">sv_coef_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">sv_coef_data</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">, </span><span class="s1">model</span><span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">support</span>
    <span class="s1">support </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">SV_len</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">copy_support</span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">support</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">support</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">, </span><span class="s1">model</span><span class="s2">)</span>

    <span class="s4"># copy model.rho into the intercept</span>
    <span class="s4"># the intercept is just model.rho but with sign changed</span>
    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">]</span><span class="s1">intercept</span>
    <span class="s1">intercept </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">n_class</span><span class="s2">*(</span><span class="s1">n_class</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)//</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">copy_intercept </span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">intercept</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">model</span><span class="s2">, &lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">intercept</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>

    <span class="s4"># copy model.SV</span>
    <span class="s4"># we erase any previous information in SV</span>
    <span class="s4"># TODO: custom kernel</span>
    <span class="s0">cdef </span><span class="s1">intp_t nonzero_SV</span>
    <span class="s1">nonzero_SV </span><span class="s2">= </span><span class="s1">get_nonzero_SV </span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>

    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_data</span>
    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indices</span><span class="s2">, </span><span class="s1">SV_indptr</span>
    <span class="s1">SV_data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">nonzero_SV</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s1">SV_indices </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">nonzero_SV</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">SV_indptr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(&lt;</span><span class="s1">intp_t</span><span class="s2">&gt;</span><span class="s1">SV_len </span><span class="s2">+ </span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">csr_copy_SV</span><span class="s2">(</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_data</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s1">model</span><span class="s2">,</span>
        <span class="s1">n_features</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">support_vectors_ </span><span class="s2">= </span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">csr_matrix</span><span class="s2">(</span>
        <span class="s2">(</span><span class="s1">SV_data</span><span class="s2">, </span><span class="s1">SV_indices</span><span class="s2">, </span><span class="s1">SV_indptr</span><span class="s2">), (</span><span class="s1">SV_len</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s4"># copy model.nSV</span>
    <span class="s4"># TODO: do only in classification</span>
    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">]</span><span class="s1">n_class_SV</span>
    <span class="s1">n_class_SV </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">n_class</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">copy_nSV</span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">n_class_SV</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">model</span><span class="s2">)</span>

    <span class="s4"># # copy probabilities</span>
    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probA</span><span class="s2">, </span><span class="s1">probB</span>
    <span class="s0">if </span><span class="s1">probability </span><span class="s2">!= </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">svm_type </span><span class="s2">&lt; </span><span class="s5">2</span><span class="s2">:  </span><span class="s4"># SVC and NuSVC</span>
            <span class="s1">probA </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">n_class</span><span class="s2">*(</span><span class="s1">n_class</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)//</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
            <span class="s1">probB </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">n_class</span><span class="s2">*(</span><span class="s1">n_class</span><span class="s2">-</span><span class="s5">1</span><span class="s2">)//</span><span class="s5">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
            <span class="s1">copy_probB</span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probB</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">model</span><span class="s2">, &lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">probB</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">probA </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
            <span class="s1">probB </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">copy_probA</span><span class="s2">(&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probA</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">model</span><span class="s2">, &lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">probA</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">probA </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">probB </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s1">svm_csr_free_and_destroy_model </span><span class="s2">(&amp;</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_problem</span><span class="s2">(</span><span class="s1">problem</span><span class="s2">)</span>
    <span class="s1">free_param</span><span class="s2">(</span><span class="s1">param</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s2">(</span>
        <span class="s1">support</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
        <span class="s1">support_vectors_</span><span class="s2">,</span>
        <span class="s1">sv_coef_data</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
        <span class="s1">intercept</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
        <span class="s1">n_class_SV</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
        <span class="s1">probA</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
        <span class="s1">probB</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
        <span class="s1">fit_status</span><span class="s2">,</span>
        <span class="s1">n_iter</span><span class="s2">.</span><span class="s1">base</span><span class="s2">,</span>
    <span class="s2">)</span>


<span class="s0">def </span><span class="s1">libsvm_sparse_predict </span><span class="s2">(</span><span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_data</span><span class="s2">,</span>
                           <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_indices</span><span class="s2">,</span>
                           <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_indptr</span><span class="s2">,</span>
                           <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_data</span><span class="s2">,</span>
                           <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indices</span><span class="s2">,</span>
                           <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indptr</span><span class="s2">,</span>
                           <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">sv_coef</span><span class="s2">,</span>
                           <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">]</span>
                           <span class="s1">intercept</span><span class="s2">, </span><span class="s1">int svm_type</span><span class="s2">, </span><span class="s1">int kernel_type</span><span class="s2">, </span><span class="s1">int</span>
                           <span class="s1">degree</span><span class="s2">, </span><span class="s1">double gamma</span><span class="s2">, </span><span class="s1">double coef0</span><span class="s2">, </span><span class="s1">double</span>
                           <span class="s1">eps</span><span class="s2">, </span><span class="s1">double C</span><span class="s2">,</span>
                           <span class="s1">const float64_t</span><span class="s2">[:] </span><span class="s1">class_weight</span><span class="s2">,</span>
                           <span class="s1">double nu</span><span class="s2">, </span><span class="s1">double p</span><span class="s2">, </span><span class="s1">int</span>
                           <span class="s1">shrinking</span><span class="s2">, </span><span class="s1">int probability</span><span class="s2">,</span>
                           <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">nSV</span><span class="s2">,</span>
                           <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probA</span><span class="s2">,</span>
                           <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probB</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Predict values T given a model. 
 
    For speed, all real work is done at the C level in function 
    copy_predict (libsvm_helper.c). 
 
    We have to reconstruct model and parameters to make sure we stay 
    in sync with the python object. 
 
    See sklearn.svm.predict for a complete list of parameters. 
 
    Parameters 
    ---------- 
    X : array-like, dtype=float 
    Y : array 
        target vector 
 
    Returns 
    ------- 
    dec_values : array 
        predicted values. 
    &quot;&quot;&quot;</span>
    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">dec_values</span>
    <span class="s0">cdef </span><span class="s1">svm_parameter </span><span class="s2">*</span><span class="s1">param</span>
    <span class="s0">cdef </span><span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span>
    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">\</span>
        <span class="s1">class_weight_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">int rv</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s1">set_parameter</span><span class="s2">(</span>
        <span class="s1">svm_type</span><span class="s2">,</span>
        <span class="s1">kernel_type</span><span class="s2">,</span>
        <span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">coef0</span><span class="s2">,</span>
        <span class="s1">nu</span><span class="s2">,</span>
        <span class="s5">100.0</span><span class="s2">,  </span><span class="s4"># cache size has no effect on predict</span>
        <span class="s1">C</span><span class="s2">,</span>
        <span class="s1">eps</span><span class="s2">,</span>
        <span class="s1">p</span><span class="s2">,</span>
        <span class="s1">shrinking</span><span class="s2">,</span>
        <span class="s1">probability</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight_label</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight_label</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">-</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">-</span><span class="s5">1</span><span class="s2">,  </span><span class="s4"># random seed has no effect on predict either</span>
    <span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">csr_set_model</span><span class="s2">(</span>
        <span class="s1">param</span><span class="s2">, &lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">nSV</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_data</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt;</span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">sv_coef</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">sv_coef</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">intercept</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">nSV</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probA</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">probA</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probB</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">probB</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s4"># TODO: use check_model</span>
    <span class="s1">dec_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">T_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]-</span><span class="s5">1</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">BlasFunctions blas_functions</span>
    <span class="s1">blas_functions</span><span class="s2">.</span><span class="s1">dot </span><span class="s2">= </span><span class="s1">_dot</span><span class="s2">[</span><span class="s1">double</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">nogil</span><span class="s2">:</span>
        <span class="s1">rv </span><span class="s2">= </span><span class="s1">csr_copy_predict</span><span class="s2">(</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s1">model</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">dec_values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&amp;</span><span class="s1">blas_functions</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">rv </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s3">&quot;We've run out of memory&quot;</span><span class="s2">)</span>
    <span class="s4"># free model and param</span>
    <span class="s1">free_model_SV</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_model</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_param</span><span class="s2">(</span><span class="s1">param</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">dec_values</span><span class="s2">.</span><span class="s1">base</span>


<span class="s0">def </span><span class="s1">libsvm_sparse_predict_proba</span><span class="s2">(</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_data</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_indices</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_indptr</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_data</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indices</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indptr</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">sv_coef</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">intercept</span><span class="s2">, </span><span class="s1">int svm_type</span><span class="s2">, </span><span class="s1">int kernel_type</span><span class="s2">, </span><span class="s1">int</span>
    <span class="s1">degree</span><span class="s2">, </span><span class="s1">double gamma</span><span class="s2">, </span><span class="s1">double coef0</span><span class="s2">, </span><span class="s1">double</span>
    <span class="s1">eps</span><span class="s2">, </span><span class="s1">double C</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[:] </span><span class="s1">class_weight</span><span class="s2">,</span>
    <span class="s1">double nu</span><span class="s2">, </span><span class="s1">double p</span><span class="s2">, </span><span class="s1">int shrinking</span><span class="s2">, </span><span class="s1">int probability</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">nSV</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probA</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probB</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Predict values T given a model. 
    &quot;&quot;&quot;</span>
    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[:, ::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">dec_values</span>
    <span class="s0">cdef </span><span class="s1">svm_parameter </span><span class="s2">*</span><span class="s1">param</span>
    <span class="s0">cdef </span><span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span>
    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">\</span>
        <span class="s1">class_weight_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s1">set_parameter</span><span class="s2">(</span>
        <span class="s1">svm_type</span><span class="s2">,</span>
        <span class="s1">kernel_type</span><span class="s2">,</span>
        <span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">coef0</span><span class="s2">,</span>
        <span class="s1">nu</span><span class="s2">,</span>
        <span class="s5">100.0</span><span class="s2">,  </span><span class="s4"># cache size has no effect on predict</span>
        <span class="s1">C</span><span class="s2">,</span>
        <span class="s1">eps</span><span class="s2">,</span>
        <span class="s1">p</span><span class="s2">,</span>
        <span class="s1">shrinking</span><span class="s2">,</span>
        <span class="s1">probability</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight_label</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight_label</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">-</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">-</span><span class="s5">1</span><span class="s2">,  </span><span class="s4"># random seed has no effect on predict either</span>
    <span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">csr_set_model</span><span class="s2">(</span>
        <span class="s1">param</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">nSV</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_data</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">sv_coef</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">sv_coef</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">intercept</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">nSV</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probA</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">probA</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probB</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">probB</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s4"># TODO: use check_model</span>
    <span class="s0">cdef </span><span class="s1">intp_t n_class </span><span class="s2">= </span><span class="s1">get_nr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">int rv</span>
    <span class="s1">dec_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">T_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]-</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_class</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">BlasFunctions blas_functions</span>
    <span class="s1">blas_functions</span><span class="s2">.</span><span class="s1">dot </span><span class="s2">= </span><span class="s1">_dot</span><span class="s2">[</span><span class="s1">double</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">nogil</span><span class="s2">:</span>
        <span class="s1">rv </span><span class="s2">= </span><span class="s1">csr_copy_predict_proba</span><span class="s2">(</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s1">model</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">dec_values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&amp;</span><span class="s1">blas_functions</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">rv </span><span class="s2">&lt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s3">&quot;We've run out of memory&quot;</span><span class="s2">)</span>
    <span class="s4"># free model and param</span>
    <span class="s1">free_model_SV</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_model</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_param</span><span class="s2">(</span><span class="s1">param</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">dec_values</span><span class="s2">.</span><span class="s1">base</span>


<span class="s0">def </span><span class="s1">libsvm_sparse_decision_function</span><span class="s2">(</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_data</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_indices</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">T_indptr</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_data</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indices</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">SV_indptr</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">sv_coef</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">intercept</span><span class="s2">, </span><span class="s1">int svm_type</span><span class="s2">, </span><span class="s1">int kernel_type</span><span class="s2">, </span><span class="s1">int</span>
    <span class="s1">degree</span><span class="s2">, </span><span class="s1">double gamma</span><span class="s2">, </span><span class="s1">double coef0</span><span class="s2">, </span><span class="s1">double</span>
    <span class="s1">eps</span><span class="s2">, </span><span class="s1">double C</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[:] </span><span class="s1">class_weight</span><span class="s2">,</span>
    <span class="s1">double nu</span><span class="s2">, </span><span class="s1">double p</span><span class="s2">, </span><span class="s1">int shrinking</span><span class="s2">, </span><span class="s1">int probability</span><span class="s2">,</span>
    <span class="s1">const int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">nSV</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probA</span><span class="s2">,</span>
    <span class="s1">const float64_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">probB</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Predict margin (libsvm name for this is predict_values) 
 
    We have to reconstruct model and parameters to make sure we stay 
    in sync with the python object. 
    &quot;&quot;&quot;</span>
    <span class="s0">cdef </span><span class="s1">float64_t</span><span class="s2">[:, ::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">dec_values</span>
    <span class="s0">cdef </span><span class="s1">svm_parameter </span><span class="s2">*</span><span class="s1">param</span>
    <span class="s0">cdef </span><span class="s1">intp_t n_class</span>

    <span class="s0">cdef </span><span class="s1">svm_csr_model </span><span class="s2">*</span><span class="s1">model</span>
    <span class="s0">cdef </span><span class="s1">int32_t</span><span class="s2">[::</span><span class="s5">1</span><span class="s2">] </span><span class="s1">\</span>
        <span class="s1">class_weight_label </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">param </span><span class="s2">= </span><span class="s1">set_parameter</span><span class="s2">(</span>
        <span class="s1">svm_type</span><span class="s2">,</span>
        <span class="s1">kernel_type</span><span class="s2">,</span>
        <span class="s1">degree</span><span class="s2">,</span>
        <span class="s1">gamma</span><span class="s2">,</span>
        <span class="s1">coef0</span><span class="s2">,</span>
        <span class="s1">nu</span><span class="s2">,</span>
        <span class="s5">100.0</span><span class="s2">,  </span><span class="s4"># cache size has no effect on predict</span>
        <span class="s1">C</span><span class="s2">,</span>
        <span class="s1">eps</span><span class="s2">,</span>
        <span class="s1">p</span><span class="s2">,</span>
        <span class="s1">shrinking</span><span class="s2">,</span>
        <span class="s1">probability</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight_label</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight_label</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">class_weight</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">class_weight</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">-</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">-</span><span class="s5">1</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">csr_set_model</span><span class="s2">(</span>
        <span class="s1">param</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">int</span><span class="s2">&gt; </span><span class="s1">nSV</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_data</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indices</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">SV_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">SV_indptr</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">sv_coef</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">sv_coef</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">intercept</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">nSV</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probA</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">probA</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
        <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">probB</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] </span><span class="s0">if </span><span class="s1">probB</span><span class="s2">.</span><span class="s1">size </span><span class="s2">&gt; </span><span class="s5">0 </span><span class="s0">else </span><span class="s1">NULL</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s1">svm_type </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">:</span>
        <span class="s1">n_class </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">n_class </span><span class="s2">= </span><span class="s1">get_nr</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
        <span class="s1">n_class </span><span class="s2">= </span><span class="s1">n_class </span><span class="s2">* (</span><span class="s1">n_class </span><span class="s2">- </span><span class="s5">1</span><span class="s2">) // </span><span class="s5">2</span>

    <span class="s1">dec_values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">T_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] - </span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_class</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">cdef </span><span class="s1">BlasFunctions blas_functions</span>
    <span class="s1">blas_functions</span><span class="s2">.</span><span class="s1">dot </span><span class="s2">= </span><span class="s1">_dot</span><span class="s2">[</span><span class="s1">double</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">csr_copy_predict_values</span><span class="s2">(</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_data</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_indices</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_indices</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s2">&lt;</span><span class="s1">intp_t </span><span class="s2">*&gt; </span><span class="s1">T_indptr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">T_indptr</span><span class="s2">[</span><span class="s5">0</span><span class="s2">],</span>
            <span class="s1">model</span><span class="s2">,</span>
            <span class="s2">&lt;</span><span class="s1">char </span><span class="s2">*&gt; &amp;</span><span class="s1">dec_values</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">],</span>
            <span class="s1">n_class</span><span class="s2">,</span>
            <span class="s2">&amp;</span><span class="s1">blas_functions</span><span class="s2">,</span>
    <span class="s2">) &lt; </span><span class="s5">0</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">MemoryError</span><span class="s2">(</span><span class="s3">&quot;We've run out of memory&quot;</span><span class="s2">)</span>
    <span class="s4"># free model and param</span>
    <span class="s1">free_model_SV</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_model</span><span class="s2">(</span><span class="s1">model</span><span class="s2">)</span>
    <span class="s1">free_param</span><span class="s2">(</span><span class="s1">param</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">dec_values</span><span class="s2">.</span><span class="s1">base</span>


<span class="s0">def </span><span class="s1">set_verbosity_wrap</span><span class="s2">(</span><span class="s1">int verbosity</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Control verbosity of libsvm library 
    &quot;&quot;&quot;</span>
    <span class="s1">set_verbosity</span><span class="s2">(</span><span class="s1">verbosity</span><span class="s2">)</span>
</pre>
</body>
</html>