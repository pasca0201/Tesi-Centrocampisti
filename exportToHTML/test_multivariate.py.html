<html>
<head>
<title>test_multivariate.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_multivariate.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Test functions for multivariate normal distributions. 
 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">pickle</span>

<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_almost_equal</span><span class="s3">,</span>
                           <span class="s1">assert_array_almost_equal</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">,</span>
                           <span class="s1">assert_array_less</span><span class="s3">, </span><span class="s1">assert_</span><span class="s3">)</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">test_continuous_basic </span><span class="s2">import </span><span class="s1">check_distribution_rvs</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>

<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_multivariate </span><span class="s2">import </span><span class="s3">(</span><span class="s1">_PSD</span><span class="s3">,</span>
                                       <span class="s1">_lnB</span><span class="s3">,</span>
                                       <span class="s1">multivariate_normal_frozen</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats </span><span class="s2">import </span><span class="s3">(</span><span class="s1">multivariate_normal</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">,</span>
                         <span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">special_ortho_group</span><span class="s3">, </span><span class="s1">ortho_group</span><span class="s3">,</span>
                         <span class="s1">random_correlation</span><span class="s3">, </span><span class="s1">unitary_group</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">,</span>
                         <span class="s1">beta</span><span class="s3">, </span><span class="s1">wishart</span><span class="s3">, </span><span class="s1">multinomial</span><span class="s3">, </span><span class="s1">invwishart</span><span class="s3">, </span><span class="s1">chi2</span><span class="s3">,</span>
                         <span class="s1">invgamma</span><span class="s3">, </span><span class="s1">norm</span><span class="s3">, </span><span class="s1">uniform</span><span class="s3">, </span><span class="s1">ks_2samp</span><span class="s3">, </span><span class="s1">kstest</span><span class="s3">, </span><span class="s1">binom</span><span class="s3">,</span>
                         <span class="s1">hypergeom</span><span class="s3">, </span><span class="s1">multivariate_t</span><span class="s3">, </span><span class="s1">cauchy</span><span class="s3">, </span><span class="s1">normaltest</span><span class="s3">,</span>
                         <span class="s1">random_table</span><span class="s3">, </span><span class="s1">uniform_direction</span><span class="s3">, </span><span class="s1">vonmises_fisher</span><span class="s3">,</span>
                         <span class="s1">dirichlet_multinomial</span><span class="s3">, </span><span class="s1">vonmises</span><span class="s3">)</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats </span><span class="s2">import </span><span class="s1">_covariance</span><span class="s3">, </span><span class="s1">Covariance</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">stats</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">integrate </span><span class="s2">import </span><span class="s1">romb</span><span class="s3">, </span><span class="s1">qmc_quad</span><span class="s3">, </span><span class="s1">tplquad</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">special </span><span class="s2">import </span><span class="s1">multigammaln</span>

<span class="s2">from </span><span class="s3">.</span><span class="s1">common_tests </span><span class="s2">import </span><span class="s1">check_random_state_property</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">_mvt </span><span class="s2">import </span><span class="s1">_qsimvtv</span>

<span class="s2">from </span><span class="s1">unittest</span><span class="s3">.</span><span class="s1">mock </span><span class="s2">import </span><span class="s1">patch</span>


<span class="s2">def </span><span class="s1">assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s1">res</span><span class="s3">, </span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">res</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestCovariance</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The input `precision` must be a square, two-dimensional...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaPrecision</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`precision.shape` must equal `covariance.shape`.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaPrecision</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">), </span><span class="s1">covariance</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The input `diagonal` must be a one-dimensional array...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaDiagonal</span><span class="s3">(</span><span class="s4">&quot;alpaca&quot;</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The input `cholesky` must be a square, two-dimensional...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaCholesky</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The input `eigenvalues` must be a one-dimensional...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaEigendecomposition</span><span class="s3">((</span><span class="s4">&quot;alpaca&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)))</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The input `eigenvectors` must be a square...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaEigendecomposition</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s4">&quot;alpaca&quot;</span><span class="s3">))</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The shapes of `eigenvalues` and `eigenvectors` must be...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaEigendecomposition</span><span class="s3">(([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)))</span>

    <span class="s1">_covariance_preprocessing </span><span class="s3">= {</span><span class="s4">&quot;Diagonal&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">,</span>
                                 <span class="s4">&quot;Precision&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">inv</span><span class="s3">,</span>
                                 <span class="s4">&quot;Cholesky&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">cholesky</span><span class="s3">,</span>
                                 <span class="s4">&quot;Eigendecomposition&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigh</span><span class="s3">,</span>
                                 <span class="s4">&quot;PSD&quot;</span><span class="s3">: </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">:</span>
                                     <span class="s1">_PSD</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)}</span>
    <span class="s1">_all_covariance_types </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">_covariance_preprocessing</span><span class="s3">))</span>
    <span class="s1">_matrices </span><span class="s3">= {</span><span class="s4">&quot;diagonal full rank&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]),</span>
                 <span class="s4">&quot;general full rank&quot;</span><span class="s3">: [[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]],</span>
                 <span class="s4">&quot;diagonal singular&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]),</span>
                 <span class="s4">&quot;general singular&quot;</span><span class="s3">: [[</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]}</span>
    <span class="s1">_cov_types </span><span class="s3">= {</span><span class="s4">&quot;diagonal full rank&quot;</span><span class="s3">: </span><span class="s1">_all_covariance_types</span><span class="s3">,</span>
                  <span class="s4">&quot;general full rank&quot;</span><span class="s3">: </span><span class="s1">_all_covariance_types</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:],</span>
                  <span class="s4">&quot;diagonal singular&quot;</span><span class="s3">: </span><span class="s1">_all_covariance_types</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">]],</span>
                  <span class="s4">&quot;general singular&quot;</span><span class="s3">: </span><span class="s1">_all_covariance_types</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">:]}</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;cov_type_name&quot;</span><span class="s3">, </span><span class="s1">_all_covariance_types</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_factories</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cov_type_name</span><span class="s3">):</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= [-</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]</span>

        <span class="s1">cov_type </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_covariance</span><span class="s3">, </span><span class="s4">f&quot;CovVia</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">preprocessing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_covariance_preprocessing</span><span class="s3">[</span><span class="s1">cov_type_name</span><span class="s3">]</span>
        <span class="s1">factory </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">Covariance</span><span class="s3">, </span><span class="s4">f&quot;from_</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s3">.</span><span class="s1">lower</span><span class="s3">()</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">factory</span><span class="s3">(</span><span class="s1">preprocessing</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">cov_type</span><span class="s3">(</span><span class="s1">preprocessing</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">type</span><span class="s3">(</span><span class="s1">res</span><span class="s3">) == </span><span class="s1">type</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">whiten</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">whiten</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;matrix_type&quot;</span><span class="s3">, </span><span class="s1">list</span><span class="s3">(</span><span class="s1">_matrices</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;cov_type_name&quot;</span><span class="s3">, </span><span class="s1">_all_covariance_types</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_covariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">matrix_type</span><span class="s3">, </span><span class="s1">cov_type_name</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= (</span><span class="s4">f&quot;CovVia</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s2">} </span><span class="s4">does not support </span><span class="s2">{</span><span class="s1">matrix_type</span><span class="s2">} </span><span class="s4">&quot;</span>
                   <span class="s4">&quot;matrices&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">cov_type_name </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cov_types</span><span class="s3">[</span><span class="s1">matrix_type</span><span class="s3">]:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_matrices</span><span class="s3">[</span><span class="s1">matrix_type</span><span class="s3">]</span>
        <span class="s1">cov_type </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_covariance</span><span class="s3">, </span><span class="s4">f&quot;CovVia</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">preprocessing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_covariance_preprocessing</span><span class="s3">[</span><span class="s1">cov_type_name</span><span class="s3">]</span>

        <span class="s1">psd </span><span class="s3">= </span><span class="s1">_PSD</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s6"># test properties</span>
        <span class="s1">cov_object </span><span class="s3">= </span><span class="s1">cov_type</span><span class="s3">(</span><span class="s1">preprocessing</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">log_pdet</span><span class="s3">, </span><span class="s1">psd</span><span class="s3">.</span><span class="s1">log_pdet</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">rank</span><span class="s3">, </span><span class="s1">psd</span><span class="s3">.</span><span class="s1">rank</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">A</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">covariance</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>

        <span class="s6"># test whitening/coloring 1D x</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">5292808890472453840</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">whiten</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">x </span><span class="s3">@ </span><span class="s1">psd</span><span class="s3">.</span><span class="s1">U</span>
        <span class="s6"># res != ref in general; but res @ res == ref @ ref</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">res </span><span class="s3">@ </span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref </span><span class="s3">@ </span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">, </span><span class="s4">&quot;_colorize&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s4">&quot;singular&quot; </span><span class="s2">not in </span><span class="s1">matrix_type</span><span class="s3">:</span>
            <span class="s6"># CovViaPSD does not have _colorize</span>
            <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">colorize</span><span class="s3">(</span><span class="s1">res</span><span class="s3">), </span><span class="s1">x</span><span class="s3">)</span>

        <span class="s6"># test whitening/coloring 3D x</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">whiten</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">x </span><span class="s3">@ </span><span class="s1">psd</span><span class="s3">.</span><span class="s1">U</span>
        <span class="s1">assert_close</span><span class="s3">((</span><span class="s1">res</span><span class="s3">**</span><span class="s5">2</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">), (</span><span class="s1">ref</span><span class="s3">**</span><span class="s5">2</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">, </span><span class="s4">&quot;_colorize&quot;</span><span class="s3">) </span><span class="s2">and </span><span class="s4">&quot;singular&quot; </span><span class="s2">not in </span><span class="s1">matrix_type</span><span class="s3">:</span>
            <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">colorize</span><span class="s3">(</span><span class="s1">res</span><span class="s3">), </span><span class="s1">x</span><span class="s3">)</span>

        <span class="s6"># gh-19197 reported that multivariate normal `rvs` produced incorrect</span>
        <span class="s6"># results when a singular Covariance object was produce using</span>
        <span class="s6"># `from_eigenvalues`. This was due to an issue in `colorize` with</span>
        <span class="s6"># singular covariance matrices. Check this edge case, which is skipped</span>
        <span class="s6"># in the previous tests.</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">, </span><span class="s4">&quot;_colorize&quot;</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">colorize</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)))</span>
            <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">T </span><span class="s3">@ </span><span class="s1">res</span><span class="s3">, </span><span class="s1">A</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;size&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">(), </span><span class="s5">1</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;matrix_type&quot;</span><span class="s3">, </span><span class="s1">list</span><span class="s3">(</span><span class="s1">_matrices</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;cov_type_name&quot;</span><span class="s3">, </span><span class="s1">_all_covariance_types</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_mvn_with_covariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">matrix_type</span><span class="s3">, </span><span class="s1">cov_type_name</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= (</span><span class="s4">f&quot;CovVia</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s2">} </span><span class="s4">does not support </span><span class="s2">{</span><span class="s1">matrix_type</span><span class="s2">} </span><span class="s4">&quot;</span>
                   <span class="s4">&quot;matrices&quot;</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">cov_type_name </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cov_types</span><span class="s3">[</span><span class="s1">matrix_type</span><span class="s3">]:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s1">message</span><span class="s3">)</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_matrices</span><span class="s3">[</span><span class="s1">matrix_type</span><span class="s3">]</span>
        <span class="s1">cov_type </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_covariance</span><span class="s3">, </span><span class="s4">f&quot;CovVia</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">preprocessing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_covariance_preprocessing</span><span class="s3">[</span><span class="s1">cov_type_name</span><span class="s3">]</span>

        <span class="s1">mean </span><span class="s3">= [</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">]</span>
        <span class="s1">cov_object </span><span class="s3">= </span><span class="s1">cov_type</span><span class="s3">(</span><span class="s1">preprocessing</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>
        <span class="s1">mvn </span><span class="s3">= </span><span class="s1">multivariate_normal</span>
        <span class="s1">dist0 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">A</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">dist1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">5292808890472453840</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">A</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">5292808890472453840</span><span class="s3">)</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">mvn</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">5292808890472453840</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">mvn</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">).</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">cov_object</span><span class="s3">, </span><span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaPSD</span><span class="s3">):</span>
            <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">squeeze</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))  </span><span class="s6"># for backward compatibility</span>
            <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">squeeze</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
            <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">x1</span><span class="s3">)</span>

        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">mvn</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">mvn</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">mvn</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;size&quot;</span><span class="s3">, [</span><span class="s1">tuple</span><span class="s3">(), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;cov_type_name&quot;</span><span class="s3">, </span><span class="s1">_all_covariance_types</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_mvn_with_covariance_cdf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">cov_type_name</span><span class="s3">):</span>
        <span class="s6"># This is split from the test above because it's slow to be running</span>
        <span class="s6"># with all matrix types, and there's no need because _mvn.mvnun</span>
        <span class="s6"># does the calculation. All Covariance needs to do is pass is</span>
        <span class="s6"># provide the `covariance` attribute.</span>
        <span class="s1">matrix_type </span><span class="s3">= </span><span class="s4">&quot;diagonal full rank&quot;</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_matrices</span><span class="s3">[</span><span class="s1">matrix_type</span><span class="s3">]</span>
        <span class="s1">cov_type </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_covariance</span><span class="s3">, </span><span class="s4">f&quot;CovVia</span><span class="s2">{</span><span class="s1">cov_type_name</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">preprocessing </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_covariance_preprocessing</span><span class="s3">[</span><span class="s1">cov_type_name</span><span class="s3">]</span>

        <span class="s1">mean </span><span class="s3">= [</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">]</span>
        <span class="s1">cov_object </span><span class="s3">= </span><span class="s1">cov_type</span><span class="s3">(</span><span class="s1">preprocessing</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>
        <span class="s1">mvn </span><span class="s3">= </span><span class="s1">multivariate_normal</span>
        <span class="s1">dist0 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">A</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">dist1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">5292808890472453840</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">A</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">)</span>

        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">mvn</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">mvn</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>
        <span class="s1">assert_close</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dist0</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_covariance_instantiation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;The `Covariance` class cannot be instantiated directly.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotImplementedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">Covariance</span><span class="s3">()</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s4">&quot;ignore::RuntimeWarning&quot;</span><span class="s3">)  </span><span class="s6"># matrix not PSD</span>
    <span class="s2">def </span><span class="s1">test_gh9942</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Originally there was a mistake in the `multivariate_normal_frozen`</span>
        <span class="s6"># `rvs` method that caused all covariance objects to be processed as</span>
        <span class="s6"># a `_CovViaPSD`. Ensure that this is resolved.</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1e-8</span><span class="s3">])</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>

        <span class="s6"># Error if the matrix is processed as a `_CovViaPSD`</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;The input matrix must be...&quot;</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">A</span><span class="s3">).</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s6"># No error if it is provided as a `CovViaEigendecomposition`</span>
        <span class="s1">seed </span><span class="s3">= </span><span class="s5">3562050283508273023</span>
        <span class="s1">rng1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">rng2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">Covariance</span><span class="s3">.</span><span class="s1">from_eigendecomposition</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">A</span><span class="s3">))</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng1</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gh19197</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># gh-19197 reported that multivariate normal `rvs` produced incorrect</span>
        <span class="s6"># results when a singular Covariance object was produce using</span>
        <span class="s6"># `from_eigenvalues`. Check that this specific issue is resolved;</span>
        <span class="s6"># a more general test is included in `test_covariance`.</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">Covariance</span><span class="s3">.</span><span class="s1">from_eigendecomposition</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)))</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">)</span>

        <span class="s1">cov </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">Covariance</span><span class="s3">.</span><span class="s1">from_eigendecomposition</span><span class="s3">(</span>
            <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">400.</span><span class="s3">]])))</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">rvs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] != </span><span class="s1">mean</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">rvs</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] == </span><span class="s1">mean</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">_random_covariance</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">evals</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">, </span><span class="s1">singular</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s6"># Generates random covariance matrix with dimensionality `dim` and</span>
    <span class="s6"># eigenvalues `evals` using provided Generator `rng`. Randomly sets</span>
    <span class="s6"># some evals to zero if `singular` is True.</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">A </span><span class="s3">@ </span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">_</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">singular</span><span class="s3">:</span>
        <span class="s1">zero_eigs </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">) &gt; </span><span class="s5">0</span>
        <span class="s1">evals</span><span class="s3">[</span><span class="s1">zero_eigs</span><span class="s3">] = </span><span class="s5">0</span>
    <span class="s1">cov </span><span class="s3">= </span><span class="s1">v </span><span class="s3">@ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">evals</span><span class="s3">) @ </span><span class="s1">v</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s2">return </span><span class="s1">cov</span>


<span class="s2">def </span><span class="s1">_sample_orthonormal_matrix</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
    <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
    <span class="s1">u</span><span class="s3">, </span><span class="s1">s</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">svd</span><span class="s3">(</span><span class="s1">M</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">u</span>


<span class="s2">class </span><span class="s1">TestMultivariateNormal</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_input_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_scalar_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>

        <span class="s6"># When evaluated on scalar data, the pdf should return a scalar</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">1.7</span><span class="s3">, </span><span class="s5">2.5</span>
        <span class="s1">pdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

        <span class="s6"># When evaluated on a single vector, the pdf should return a scalar</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))  </span><span class="s6"># Diagonal values for cov. matrix</span>
        <span class="s1">pdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

        <span class="s6"># When evaluated on scalar data, the cdf should return a scalar</span>
        <span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s5">1.5</span><span class="s3">, </span><span class="s5">1.7</span><span class="s3">, </span><span class="s5">2.5</span>
        <span class="s1">cdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cdf</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

        <span class="s6"># When evaluated on a single vector, the cdf should return a scalar</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))  </span><span class="s6"># Diagonal values for cov. matrix</span>
        <span class="s1">cdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cdf</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_logpdf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the log of the pdf is in fact the logpdf</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">d2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_logpdf_default_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the log of the pdf is in fact the logpdf</span>
        <span class="s6"># with default parameters Mean=None and cov = 1</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s6"># check whether default values are being used</span>
        <span class="s1">d3 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">d4 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">d2</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">d4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_logcdf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the log of the cdf is in fact the logcdf</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">d2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_logcdf_default_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the log of the cdf is in fact the logcdf</span>
        <span class="s6"># with default parameters Mean=None and cov = 1</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s6"># check whether default values are being used</span>
        <span class="s1">d3 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">d4 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">d2</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">d4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_rank</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the rank is detected correctly.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">expected_rank </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">):</span>
            <span class="s1">s </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">expected_rank</span><span class="s3">)</span>
            <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
            <span class="s1">distn </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">distn</span><span class="s3">.</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">rank</span><span class="s3">, </span><span class="s1">expected_rank</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_degenerate_distributions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>

        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">):</span>
            <span class="s1">z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
                <span class="s6"># Sample a small covariance matrix.</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>
                <span class="s1">cov_kk </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">s</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

                <span class="s6"># Embed the small covariance matrix into a larger singular one.</span>
                <span class="s1">cov_nn </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
                <span class="s1">cov_nn</span><span class="s3">[:</span><span class="s1">k</span><span class="s3">, :</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">cov_kk</span>

                <span class="s6"># Embed part of the vector in the same way</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
                <span class="s1">x</span><span class="s3">[:</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">z</span><span class="s3">[:</span><span class="s1">k</span><span class="s3">]</span>

                <span class="s6"># Define a rotation of the larger low rank matrix.</span>
                <span class="s1">u </span><span class="s3">= </span><span class="s1">_sample_orthonormal_matrix</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
                <span class="s1">cov_rr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">cov_nn</span><span class="s3">, </span><span class="s1">u</span><span class="s3">.</span><span class="s1">T</span><span class="s3">))</span>
                <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

                <span class="s6"># Check some identities.</span>
                <span class="s1">distn_kk </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">k</span><span class="s3">), </span><span class="s1">cov_kk</span><span class="s3">,</span>
                                               <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">distn_nn </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">cov_nn</span><span class="s3">,</span>
                                               <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">distn_rr </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">cov_rr</span><span class="s3">,</span>
                                               <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">distn_kk</span><span class="s3">.</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">rank</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">distn_nn</span><span class="s3">.</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">rank</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">distn_rr</span><span class="s3">.</span><span class="s1">cov_object</span><span class="s3">.</span><span class="s1">rank</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>
                <span class="s1">pdf_kk </span><span class="s3">= </span><span class="s1">distn_kk</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:</span><span class="s1">k</span><span class="s3">])</span>
                <span class="s1">pdf_nn </span><span class="s3">= </span><span class="s1">distn_nn</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
                <span class="s1">pdf_rr </span><span class="s3">= </span><span class="s1">distn_rr</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdf_kk</span><span class="s3">, </span><span class="s1">pdf_nn</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdf_kk</span><span class="s3">, </span><span class="s1">pdf_rr</span><span class="s3">)</span>
                <span class="s1">logpdf_kk </span><span class="s3">= </span><span class="s1">distn_kk</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:</span><span class="s1">k</span><span class="s3">])</span>
                <span class="s1">logpdf_nn </span><span class="s3">= </span><span class="s1">distn_nn</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
                <span class="s1">logpdf_rr </span><span class="s3">= </span><span class="s1">distn_rr</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">logpdf_kk</span><span class="s3">, </span><span class="s1">logpdf_nn</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">logpdf_kk</span><span class="s3">, </span><span class="s1">logpdf_rr</span><span class="s3">)</span>

                <span class="s6"># Add an orthogonal component and find the density</span>
                <span class="s1">y_orth </span><span class="s3">= </span><span class="s1">y </span><span class="s3">+ </span><span class="s1">u</span><span class="s3">[:, -</span><span class="s5">1</span><span class="s3">]</span>
                <span class="s1">pdf_rr_orth </span><span class="s3">= </span><span class="s1">distn_rr</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">y_orth</span><span class="s3">)</span>
                <span class="s1">logpdf_rr_orth </span><span class="s3">= </span><span class="s1">distn_rr</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">y_orth</span><span class="s3">)</span>

                <span class="s6"># Ensure that this has zero probability</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pdf_rr_orth</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logpdf_rr_orth</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_degenerate_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that we can generate arrays of random variate from a degenerate</span>
        <span class="s6"># multivariate normal, and that the pdf for these samples is non-zero</span>
        <span class="s6"># (i.e. samples from the distribution lie on the subspace)</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">r </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
                <span class="s1">mn </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
                <span class="s1">u </span><span class="s3">= </span><span class="s1">_sample_orthonormal_matrix</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)[:, :</span><span class="s1">r</span><span class="s3">]</span>
                <span class="s1">vr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">u</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
                <span class="s1">X </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mn</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">vr</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">k</span><span class="s3">)</span>

                <span class="s1">pdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mn</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">vr</span><span class="s3">,</span>
                                              <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>
                <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">pdf </span><span class="s3">&gt; </span><span class="s5">0.0</span><span class="s3">)</span>

                <span class="s1">logpdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mn</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">vr</span><span class="s3">,</span>
                                                    <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logpdf</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s1">k</span><span class="s3">)</span>
                <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">logpdf </span><span class="s3">&gt; -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_large_pseudo_determinant</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that large pseudo-determinants are handled appropriately.</span>

        <span class="s6"># Construct a singular diagonal covariance matrix</span>
        <span class="s6"># whose pseudo determinant overflows double precision.</span>
        <span class="s1">large_total_log </span><span class="s3">= </span><span class="s5">1000.0</span>
        <span class="s1">npos </span><span class="s3">= </span><span class="s5">100</span>
        <span class="s1">nzero </span><span class="s3">= </span><span class="s5">2</span>
        <span class="s1">large_entry </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">large_total_log </span><span class="s3">/ </span><span class="s1">npos</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">npos </span><span class="s3">+ </span><span class="s1">nzero</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">fill_diagonal</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">large_entry</span><span class="s3">)</span>
        <span class="s1">cov</span><span class="s3">[-</span><span class="s1">nzero</span><span class="s3">:, -</span><span class="s1">nzero</span><span class="s3">:] = </span><span class="s5">0</span>

        <span class="s6"># Check some determinants.</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">), </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">[:</span><span class="s1">npos</span><span class="s3">, :</span><span class="s1">npos</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">slogdet</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">[:</span><span class="s1">npos</span><span class="s3">, :</span><span class="s1">npos</span><span class="s3">]),</span>
                        <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">large_total_log</span><span class="s3">))</span>

        <span class="s6"># Check the pseudo-determinant.</span>
        <span class="s1">psd </span><span class="s3">= </span><span class="s1">_PSD</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">psd</span><span class="s3">.</span><span class="s1">log_pdet</span><span class="s3">, </span><span class="s1">large_total_log</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">4</span>

        <span class="s6"># Construct a random covariance matrix.</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">data</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>

        <span class="s6"># Construct an ndarray which can be interpreted as</span>
        <span class="s6"># a 2x3 array whose elements are random data vectors.</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>

        <span class="s6"># Check that multiple data points can be evaluated at once.</span>
        <span class="s1">desired_pdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">desired_cdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">):</span>
                <span class="s1">actual </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">], </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">desired_pdf</span><span class="s3">[</span><span class="s1">i</span><span class="s3">,</span><span class="s1">j</span><span class="s3">])</span>
                <span class="s6"># Repeat for cdf</span>
                <span class="s1">actual </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">], </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">desired_cdf</span><span class="s3">[</span><span class="s1">i</span><span class="s3">,</span><span class="s1">j</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_normal_1D</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The probability density function for a 1D normal variable should</span>
        <span class="s6"># agree with the standard normal distribution in scipy.stats.distributions</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">mean</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s5">1.2</span><span class="s3">, </span><span class="s5">0.9</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">cov</span><span class="s3">**</span><span class="s5">0.5</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">norm</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">d2</span><span class="s3">)</span>
        <span class="s6"># The same should hold for the cumulative distribution function</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">norm</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">d2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_marginalization</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Integrating out one of the variables of a 2D Gaussian should</span>
        <span class="s6"># yield a 1D Gaussian</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2.5</span><span class="s3">, </span><span class="s5">3.5</span><span class="s3">])</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">.5</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">], [</span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">.6</span><span class="s3">]])</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">2 </span><span class="s3">** </span><span class="s5">8 </span><span class="s3">+ </span><span class="s5">1  </span><span class="s6"># Number of samples</span>
        <span class="s1">delta </span><span class="s3">= </span><span class="s5">6 </span><span class="s3">/ (</span><span class="s1">n </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)  </span><span class="s6"># Grid spacing</span>

        <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">xv</span><span class="s3">, </span><span class="s1">yv </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>
        <span class="s1">pos </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">pos</span><span class="s3">[:, :, </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">xv</span>
        <span class="s1">pos</span><span class="s3">[:, :, </span><span class="s5">1</span><span class="s3">] = </span><span class="s1">yv</span>
        <span class="s1">pdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

        <span class="s6"># Marginalize over x and y axis</span>
        <span class="s1">margin_x </span><span class="s3">= </span><span class="s1">romb</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">delta</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">margin_y </span><span class="s3">= </span><span class="s1">romb</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">delta</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Compare with standard normal distribution</span>
        <span class="s1">gauss_x </span><span class="s3">= </span><span class="s1">norm</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s1">mean</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">scale</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] ** </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">gauss_y </span><span class="s3">= </span><span class="s1">norm</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">=</span><span class="s1">mean</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">scale</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">] ** </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">margin_x</span><span class="s3">, </span><span class="s1">gauss_x</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">margin_y</span><span class="s3">, </span><span class="s1">gauss_y</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The frozen distribution should agree with the regular one</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">))</span>
        <span class="s1">norm_frozen </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">norm_frozen</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">norm_frozen</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">),</span>
                        <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">norm_frozen</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">norm_frozen</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">),</span>
                        <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">'covariance'</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">),</span>
            <span class="s1">Covariance</span><span class="s3">.</span><span class="s1">from_diagonal</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_frozen_multivariate_normal_exposes_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">covariance</span><span class="s3">):</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">,))</span>
        <span class="s1">cov_should_be </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">norm_frozen </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">covariance</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">allclose</span><span class="s3">(</span><span class="s1">norm_frozen</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">allclose</span><span class="s3">(</span><span class="s1">norm_frozen</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">cov_should_be</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pseudodet_pinv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Make sure that pseudo-inverse and pseudo-det agree on cutoff</span>

        <span class="s6"># Assemble random covariance matrix with large and small eigenvalues</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">u </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">s</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">1.0</span>
        <span class="s1">s</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] = </span><span class="s5">1e-7</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">s</span><span class="s3">), </span><span class="s1">u</span><span class="s3">.</span><span class="s1">T</span><span class="s3">))</span>

        <span class="s6"># Set cond so that the lowest eigenvalue is below the cutoff</span>
        <span class="s1">cond </span><span class="s3">= </span><span class="s5">1e-5</span>
        <span class="s1">psd </span><span class="s3">= </span><span class="s1">_PSD</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">cond</span><span class="s3">=</span><span class="s1">cond</span><span class="s3">)</span>
        <span class="s1">psd_pinv </span><span class="s3">= </span><span class="s1">_PSD</span><span class="s3">(</span><span class="s1">psd</span><span class="s3">.</span><span class="s1">pinv</span><span class="s3">, </span><span class="s1">cond</span><span class="s3">=</span><span class="s1">cond</span><span class="s3">)</span>

        <span class="s6"># Check that the log pseudo-determinant agrees with the sum</span>
        <span class="s6"># of the logs of all but the smallest eigenvalue</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">psd</span><span class="s3">.</span><span class="s1">log_pdet</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">s</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">])))</span>
        <span class="s6"># Check that the pseudo-determinant of the pseudo-inverse</span>
        <span class="s6"># agrees with 1 / pseudo-determinant</span>
        <span class="s1">assert_allclose</span><span class="s3">(-</span><span class="s1">psd</span><span class="s3">.</span><span class="s1">log_pdet</span><span class="s3">, </span><span class="s1">psd_pinv</span><span class="s3">.</span><span class="s1">log_pdet</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exception_nonsquare_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">_PSD</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exception_nonfinite_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov_nan </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">_PSD</span><span class="s3">, </span><span class="s1">cov_nan</span><span class="s3">)</span>
        <span class="s1">cov_inf </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">_PSD</span><span class="s3">, </span><span class="s1">cov_inf</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exception_non_psd_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">]]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">_PSD</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_exception_singular_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">))</span>
        <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">LinAlgError</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

        <span class="s6"># Message used to be &quot;singular matrix&quot;, but this is more accurate.</span>
        <span class="s6"># See gh-15508</span>
        <span class="s1">cov </span><span class="s3">= [[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]]</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;When `allow_singular is False`, the input matrix&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">LinAlgError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_R_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Compare the multivariate pdf with some values precomputed</span>
        <span class="s6"># in R version 3.0.1 (2013-05-16) on Mac OS X 10.6.</span>

        <span class="s6"># The values below were generated by the following R-script:</span>
        <span class="s6"># &gt; library(mnormt)</span>
        <span class="s6"># &gt; x &lt;- seq(0, 2, length=5)</span>
        <span class="s6"># &gt; y &lt;- 3*x - 2</span>
        <span class="s6"># &gt; z &lt;- x + cos(y)</span>
        <span class="s6"># &gt; mu &lt;- c(1, 3, 2)</span>
        <span class="s6"># &gt; Sigma &lt;- matrix(c(1,2,0,2,5,0.5,0,0.5,3), 3, 3)</span>
        <span class="s6"># &gt; r_pdf &lt;- dmnorm(cbind(x,y,z), mu, Sigma)</span>
        <span class="s1">r_pdf </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.0002214706</span><span class="s3">, </span><span class="s5">0.0013819953</span><span class="s3">, </span><span class="s5">0.0049138692</span><span class="s3">,</span>
                          <span class="s5">0.0103803050</span><span class="s3">, </span><span class="s5">0.0140250800</span><span class="s3">])</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s5">3 </span><span class="s3">* </span><span class="s1">x </span><span class="s3">- </span><span class="s5">2</span>
        <span class="s1">z </span><span class="s3">= </span><span class="s1">x </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">z</span><span class="s3">]).</span><span class="s1">T</span>

        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s4">'d'</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s4">'d'</span><span class="s3">)</span>

        <span class="s1">pdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">r_pdf</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">)</span>

        <span class="s6"># Compare the multivariate cdf with some values precomputed</span>
        <span class="s6"># in R version 3.3.2 (2016-10-31) on Debian GNU/Linux.</span>

        <span class="s6"># The values below were generated by the following R-script:</span>
        <span class="s6"># &gt; library(mnormt)</span>
        <span class="s6"># &gt; x &lt;- seq(0, 2, length=5)</span>
        <span class="s6"># &gt; y &lt;- 3*x - 2</span>
        <span class="s6"># &gt; z &lt;- x + cos(y)</span>
        <span class="s6"># &gt; mu &lt;- c(1, 3, 2)</span>
        <span class="s6"># &gt; Sigma &lt;- matrix(c(1,2,0,2,5,0.5,0,0.5,3), 3, 3)</span>
        <span class="s6"># &gt; r_cdf &lt;- pmnorm(cbind(x,y,z), mu, Sigma)</span>
        <span class="s1">r_cdf </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.0017866215</span><span class="s3">, </span><span class="s5">0.0267142892</span><span class="s3">, </span><span class="s5">0.0857098761</span><span class="s3">,</span>
                          <span class="s5">0.1063242573</span><span class="s3">, </span><span class="s5">0.2501068509</span><span class="s3">])</span>

        <span class="s1">cdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">r</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf</span><span class="s3">, </span><span class="s1">r_cdf</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">2e-5</span><span class="s3">)</span>

        <span class="s6"># Also test bivariate cdf with some values precomputed</span>
        <span class="s6"># in R version 3.3.2 (2016-10-31) on Debian GNU/Linux.</span>

        <span class="s6"># The values below were generated by the following R-script:</span>
        <span class="s6"># &gt; library(mnormt)</span>
        <span class="s6"># &gt; x &lt;- seq(0, 2, length=5)</span>
        <span class="s6"># &gt; y &lt;- 3*x - 2</span>
        <span class="s6"># &gt; mu &lt;- c(1, 3)</span>
        <span class="s6"># &gt; Sigma &lt;- matrix(c(1,2,2,5), 2, 2)</span>
        <span class="s6"># &gt; r_cdf2 &lt;- pmnorm(cbind(x,y), mu, Sigma)</span>
        <span class="s1">r_cdf2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.01262147</span><span class="s3">, </span><span class="s5">0.05838989</span><span class="s3">, </span><span class="s5">0.18389571</span><span class="s3">,</span>
                           <span class="s5">0.40696599</span><span class="s3">, </span><span class="s5">0.66470577</span><span class="s3">])</span>

        <span class="s1">r2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">]).</span><span class="s1">T</span>

        <span class="s1">mean2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s4">'d'</span><span class="s3">)</span>
        <span class="s1">cov2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]], </span><span class="s4">'d'</span><span class="s3">)</span>

        <span class="s1">cdf2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">r2</span><span class="s3">, </span><span class="s1">mean2</span><span class="s3">, </span><span class="s1">cov2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf2</span><span class="s3">, </span><span class="s1">r_cdf2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_multivariate_normal_rvs_zero_covariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">covariance </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">model </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">covariance</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">sample </span><span class="s3">= </span><span class="s1">model</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_rvs_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that rvs parses the mean and covariance correctly, and returns</span>
        <span class="s6"># an array of the right shape</span>
        <span class="s1">N </span><span class="s3">= </span><span class="s5">300</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">sample </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">d</span><span class="s3">), </span><span class="s1">cov</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">N</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">N</span><span class="s3">, </span><span class="s1">d</span><span class="s3">))</span>

        <span class="s1">sample </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                                         <span class="s1">cov</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">.1</span><span class="s3">], [</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]),</span>
                                         <span class="s1">size</span><span class="s3">=</span><span class="s1">N</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">N</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>

        <span class="s1">u </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">sample </span><span class="s3">= </span><span class="s1">u</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">N</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">N</span><span class="s3">, ))</span>

    <span class="s2">def </span><span class="s1">test_large_sample</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Generate large sample and compare sample mean and sample covariance</span>
        <span class="s6"># with mean and covariance matrix.</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">M</span><span class="s3">, </span><span class="s1">M</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s5">5000</span>

        <span class="s1">sample </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">size</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">.</span><span class="s1">T</span><span class="s3">), </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_entropy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">M</span><span class="s3">, </span><span class="s1">M</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s1">rv </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>

        <span class="s6"># Check that frozen distribution agrees with entropy function</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">))</span>
        <span class="s6"># Compare entropy with manually computed expression involving</span>
        <span class="s6"># the sum of the logs of the eigenvalues of the covariance matrix</span>
        <span class="s1">eigs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eig</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">desired </span><span class="s3">= </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">2 </span><span class="s3">* (</span><span class="s1">n </span><span class="s3">* (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s5">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">)))</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">desired</span><span class="s3">, </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">test_lnB</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">desired </span><span class="s3">= </span><span class="s5">.5  </span><span class="s6"># e^lnB = 1/2 for [1, 1, 1]</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">_lnB</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)), </span><span class="s1">desired</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdf_with_lower_limit_arrays</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test CDF with lower limit in several dimensions</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2408071309372769818</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))*</span><span class="s5">6 </span><span class="s3">- </span><span class="s5">3</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))*</span><span class="s5">6 </span><span class="s3">- </span><span class="s5">3</span>

        <span class="s1">cdf1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>

        <span class="s1">cdf2a </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">cdf2b </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">ab1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">((</span><span class="s1">a</span><span class="s3">[..., </span><span class="s5">0</span><span class="s3">:</span><span class="s5">1</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[..., </span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">]), </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">ab2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">((</span><span class="s1">a</span><span class="s3">[..., </span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[..., </span><span class="s5">0</span><span class="s3">:</span><span class="s5">1</span><span class="s3">]), </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">cdf2ab1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">ab1</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">cdf2ab2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">ab2</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">cdf2 </span><span class="s3">= </span><span class="s1">cdf2a </span><span class="s3">+ </span><span class="s1">cdf2b </span><span class="s3">- </span><span class="s1">cdf2ab1 </span><span class="s3">- </span><span class="s1">cdf2ab2</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf1</span><span class="s3">, </span><span class="s1">cdf2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdf_with_lower_limit_consistency</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># check that multivariate normal CDF functions are consistent</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2408071309372769818</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">cov </span><span class="s3">@ </span><span class="s1">cov</span><span class="s3">.</span><span class="s1">T</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))*</span><span class="s5">6 </span><span class="s3">- </span><span class="s5">3</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))*</span><span class="s5">6 </span><span class="s3">- </span><span class="s5">3</span>

        <span class="s1">cdf1 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">cdf2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">).</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">cdf3 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">))</span>
        <span class="s1">cdf4 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">).</span><span class="s1">logcdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">))</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf2</span><span class="s3">, </span><span class="s1">cdf1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf3</span><span class="s3">, </span><span class="s1">cdf1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf4</span><span class="s3">, </span><span class="s1">cdf1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdf_signs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># check that sign of output is correct when np.any(lower &gt; x)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]</span>
        <span class="s1">a </span><span class="s3">= [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]</span>
        <span class="s6"># when odd number of elements of b &lt; a, output is negative</span>
        <span class="s1">expected_signs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">cdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf</span><span class="s3">, </span><span class="s1">cdf</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]*</span><span class="s1">expected_signs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mean_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test the interaction between a Covariance object and mean</span>
        <span class="s1">P </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s5">1 </span><span class="s3">/ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]))</span>
        <span class="s1">cov_object </span><span class="s3">= </span><span class="s1">_covariance</span><span class="s3">.</span><span class="s1">CovViaPrecision</span><span class="s3">(</span><span class="s1">P</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`cov` represents a covariance matrix in 3 dimensions...&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">cov_object</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">cov_object</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= [</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">]</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">cov_object</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s1">ref </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">cov_object</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_object</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fit_wrong_fit_data_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">error_msg </span><span class="s3">= </span><span class="s4">&quot;`x` must be two-dimensional.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'dim'</span><span class="s3">, (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_fit_correctness</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">4385269356937404</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">100</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">mean_est</span><span class="s3">, </span><span class="s1">cov_est </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">mean_ref</span><span class="s3">, </span><span class="s1">cov_ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">ddof</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean_est</span><span class="s3">, </span><span class="s1">mean_ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov_est</span><span class="s3">, </span><span class="s1">cov_ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fit_both_parameters_fixed</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">mean_fixed </span><span class="s3">= </span><span class="s5">1.</span>
        <span class="s1">cov_fixed </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span><span class="s5">1.</span><span class="s3">)</span>
        <span class="s1">mean</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">fix_mean</span><span class="s3">=</span><span class="s1">mean_fixed</span><span class="s3">,</span>
                                            <span class="s1">fix_cov</span><span class="s3">=</span><span class="s1">cov_fixed</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">mean_fixed</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">cov_fixed</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'fix_mean'</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)),</span>
                                          <span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, ))])</span>
    <span class="s2">def </span><span class="s1">test_fit_fix_mean_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fix_mean</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= (</span><span class="s4">&quot;`fix_mean` must be a one-dimensional array the same &quot;</span>
                <span class="s4">&quot;length as the dimensionality of the vectors `x`.&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s1">fix_mean</span><span class="s3">=</span><span class="s1">fix_mean</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'fix_cov'</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, )),</span>
                                         <span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)),</span>
                                         <span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">))])</span>
    <span class="s2">def </span><span class="s1">test_fit_fix_cov_input_validation_dimension</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fix_cov</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= (</span><span class="s4">&quot;`fix_cov` must be a two-dimensional square array &quot;</span>
                <span class="s4">&quot;of same side length as the dimensionality of the &quot;</span>
                <span class="s4">&quot;vectors `x`.&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">), </span><span class="s1">fix_cov</span><span class="s3">=</span><span class="s1">fix_cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fit_fix_cov_not_positive_semidefinite</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">error_msg </span><span class="s3">= </span><span class="s4">&quot;`fix_cov` must be symmetric positive semidefinite.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">error_msg</span><span class="s3">):</span>
            <span class="s1">fix_cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, -</span><span class="s5">1.</span><span class="s3">]])</span>
            <span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s1">fix_cov</span><span class="s3">=</span><span class="s1">fix_cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fit_fix_mean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">4385269356937404</span><span class="s3">)</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">,</span>
                                          <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">mean_free</span><span class="s3">, </span><span class="s1">cov_free </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">)</span>
        <span class="s1">logp_free </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mean_free</span><span class="s3">,</span>
                                               <span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_free</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">mean_fix</span><span class="s3">, </span><span class="s1">cov_fix </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">fix_mean</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mean_fix</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">)</span>
        <span class="s1">logp_fix </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mean_fix</span><span class="s3">,</span>
                                              <span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_fix</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s6"># test that fixed parameters result in lower likelihood than free</span>
        <span class="s6"># parameters</span>
        <span class="s2">assert </span><span class="s1">logp_fix </span><span class="s3">&lt; </span><span class="s1">logp_free</span>
        <span class="s6"># test that a small perturbation of the resulting parameters</span>
        <span class="s6"># has lower likelihood than the estimated parameters</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s5">1e-8 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">cov_perturbed </span><span class="s3">= </span><span class="s1">cov_fix </span><span class="s3">+ </span><span class="s1">m</span>
        <span class="s1">logp_perturbed </span><span class="s3">= (</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">,</span>
                                                     <span class="s1">mean</span><span class="s3">=</span><span class="s1">mean_fix</span><span class="s3">,</span>
                                                     <span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_perturbed</span><span class="s3">)</span>
                                                     <span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">logp_perturbed </span><span class="s3">&lt; </span><span class="s1">logp_fix</span>


    <span class="s2">def </span><span class="s1">test_fit_fix_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">4385269356937404</span><span class="s3">)</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">,</span>
                                          <span class="s1">size</span><span class="s3">=</span><span class="s5">100</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">mean_free</span><span class="s3">, </span><span class="s1">cov_free </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">)</span>
        <span class="s1">logp_free </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mean_free</span><span class="s3">,</span>
                                               <span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_free</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">mean_fix</span><span class="s3">, </span><span class="s1">cov_fix </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">fix_cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mean_fix</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cov_fix</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s1">logp_fix </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">mean_fix</span><span class="s3">,</span>
                                              <span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_fix</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s6"># test that fixed parameters result in lower likelihood than free</span>
        <span class="s6"># parameters</span>
        <span class="s2">assert </span><span class="s1">logp_fix </span><span class="s3">&lt; </span><span class="s1">logp_free</span>
        <span class="s6"># test that a small perturbation of the resulting parameters</span>
        <span class="s6"># has lower likelihood than the estimated parameters</span>
        <span class="s1">mean_perturbed </span><span class="s3">= </span><span class="s1">mean_fix </span><span class="s3">+ </span><span class="s5">1e-8 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">logp_perturbed </span><span class="s3">= (</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">,</span>
                                                     <span class="s1">mean</span><span class="s3">=</span><span class="s1">mean_perturbed</span><span class="s3">,</span>
                                                     <span class="s1">cov</span><span class="s3">=</span><span class="s1">cov_fix</span><span class="s3">)</span>
                                                     <span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">logp_perturbed </span><span class="s3">&lt; </span><span class="s1">logp_fix</span>


<span class="s2">class </span><span class="s1">TestMatrixNormal</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_bad_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that bad inputs raise errors</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">num_cols </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">,</span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">U </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">), </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">V </span><span class="s3">= </span><span class="s5">0.7 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>

        <span class="s6"># Incorrect dimensions</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">5</span><span class="s3">,</span><span class="s5">4</span><span class="s3">,</span><span class="s5">3</span><span class="s3">)))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">10</span><span class="s3">), </span><span class="s1">V</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">U</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">10</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">U</span><span class="s3">, </span><span class="s1">U</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">V</span><span class="s3">, </span><span class="s1">V</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">U</span><span class="s3">, </span><span class="s1">V</span><span class="s3">)</span>

        <span class="s1">e </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">LinAlgError</span>
        <span class="s6"># Singular covariance for the rvs method of a non-frozen instance</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">,</span>
                      <span class="s1">M</span><span class="s3">, </span><span class="s1">U</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">)))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">,</span>
                      <span class="s1">M</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">)), </span><span class="s1">V</span><span class="s3">)</span>
        <span class="s6"># Singular covariance for a frozen instance</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">U</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">)))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">e</span><span class="s3">, </span><span class="s1">matrix_normal</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">)), </span><span class="s1">V</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_default_inputs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that default argument handling works</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">num_cols </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">,</span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">U </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">), </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">V </span><span class="s3">= </span><span class="s5">0.7 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">Z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">Zr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">Zc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">1</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">Ir </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">)</span>
        <span class="s1">Ic </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">)</span>
        <span class="s1">I1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">,</span>
                     <span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">).</span><span class="s1">rowcov</span><span class="s3">, </span><span class="s1">Ir</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">).</span><span class="s1">colcov</span><span class="s3">, </span><span class="s1">Ic</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">Zr</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">).</span><span class="s1">colcov</span><span class="s3">, </span><span class="s1">I1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">Zc</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">rowcov</span><span class="s3">, </span><span class="s1">I1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">).</span><span class="s1">colcov</span><span class="s3">, </span><span class="s1">Ic</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">rowcov</span><span class="s3">, </span><span class="s1">Ir</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">Z</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_covariance_expansion</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that covariance can be specified with scalar or vector</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">num_cols </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">Uv </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">)</span>
        <span class="s1">Us </span><span class="s3">= </span><span class="s5">0.2</span>
        <span class="s1">Vv </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">)</span>
        <span class="s1">Vs </span><span class="s3">= </span><span class="s5">0.1</span>

        <span class="s1">Ir </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">)</span>
        <span class="s1">Ic </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">Uv</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">Vv</span><span class="s3">).</span><span class="s1">rowcov</span><span class="s3">,</span>
                     <span class="s5">0.2</span><span class="s3">*</span><span class="s1">Ir</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">Uv</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">Vv</span><span class="s3">).</span><span class="s1">colcov</span><span class="s3">,</span>
                     <span class="s5">0.1</span><span class="s3">*</span><span class="s1">Ic</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">Us</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">Vs</span><span class="s3">).</span><span class="s1">rowcov</span><span class="s3">,</span>
                     <span class="s5">0.2</span><span class="s3">*</span><span class="s1">Ir</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">Us</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">Vs</span><span class="s3">).</span><span class="s1">colcov</span><span class="s3">,</span>
                     <span class="s5">0.1</span><span class="s3">*</span><span class="s1">Ic</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen_matrix_normal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">5</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">5</span><span class="s3">):</span>
                <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">i</span><span class="s3">,</span><span class="s1">j</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
                <span class="s1">U </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">i</span><span class="s3">,</span><span class="s1">i</span><span class="s3">), </span><span class="s5">0.5</span><span class="s3">)</span>
                <span class="s1">V </span><span class="s3">= </span><span class="s5">0.7 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">j</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">j</span><span class="s3">,</span><span class="s1">j</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>

                <span class="s1">frozen </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>

                <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
                <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">,</span>
                                         <span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>

                <span class="s1">X </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>

                <span class="s1">pdf1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
                <span class="s1">pdf2 </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pdf1</span><span class="s3">, </span><span class="s1">pdf2</span><span class="s3">)</span>

                <span class="s1">logpdf1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
                <span class="s1">logpdf2 </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logpdf1</span><span class="s3">, </span><span class="s1">logpdf2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_matches_multivariate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the pdfs match those obtained by vectorising and</span>
        <span class="s6"># treating as a multivariate normal.</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">5</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">5</span><span class="s3">):</span>
                <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">i</span><span class="s3">,</span><span class="s1">j</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
                <span class="s1">U </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">i</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">i</span><span class="s3">,</span><span class="s1">i</span><span class="s3">), </span><span class="s5">0.5</span><span class="s3">)</span>
                <span class="s1">V </span><span class="s3">= </span><span class="s5">0.7 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">j</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">j</span><span class="s3">,</span><span class="s1">j</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>

                <span class="s1">frozen </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
                <span class="s1">X </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
                <span class="s1">pdf1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
                <span class="s1">logpdf1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
                <span class="s1">entropy1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">()</span>

                <span class="s1">vecX </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">flatten</span><span class="s3">()</span>
                <span class="s1">vecM </span><span class="s3">= </span><span class="s1">M</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">flatten</span><span class="s3">()</span>
                <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">kron</span><span class="s3">(</span><span class="s1">V</span><span class="s3">,</span><span class="s1">U</span><span class="s3">)</span>
                <span class="s1">pdf2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">vecX</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">vecM</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>
                <span class="s1">logpdf2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">vecX</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">vecM</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>
                <span class="s1">entropy2 </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">vecM</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">)</span>

                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdf1</span><span class="s3">, </span><span class="s1">pdf2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1E-10</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">logpdf1</span><span class="s3">, </span><span class="s1">logpdf2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1E-10</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">entropy1</span><span class="s3">, </span><span class="s1">entropy2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_array_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check array of inputs has the same output as the separate entries.</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">num_cols </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">,</span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">U </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">), </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">V </span><span class="s3">= </span><span class="s5">0.7 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">N </span><span class="s3">= </span><span class="s5">10</span>

        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
        <span class="s1">X1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">N</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">N</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">4321</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">((</span><span class="s1">X1</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">,:,:,:],</span><span class="s1">X2</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">,:,:,:]), </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s1">N</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">))</span>

        <span class="s1">array_logpdf </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">array_logpdf</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s1">N</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">N</span><span class="s3">):</span>
                <span class="s1">separate_logpdf </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">i</span><span class="s3">,</span><span class="s1">j</span><span class="s3">], </span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">,</span>
                                                       <span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">separate_logpdf</span><span class="s3">, </span><span class="s1">array_logpdf</span><span class="s3">[</span><span class="s1">i</span><span class="s3">,</span><span class="s1">j</span><span class="s3">], </span><span class="s5">1E-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_moments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check that the sample moments match the parameters</span>
        <span class="s1">num_rows </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">num_cols </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">,</span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">U </span><span class="s3">= </span><span class="s5">0.5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_rows</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_rows</span><span class="s3">, </span><span class="s1">num_rows</span><span class="s3">), </span><span class="s5">0.5</span><span class="s3">)</span>
        <span class="s1">V </span><span class="s3">= </span><span class="s5">0.7 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">num_cols</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">num_cols</span><span class="s3">, </span><span class="s1">num_cols</span><span class="s3">), </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">N </span><span class="s3">= </span><span class="s5">1000</span>

        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">rowcov</span><span class="s3">=</span><span class="s1">U</span><span class="s3">, </span><span class="s1">colcov</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">N</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>

        <span class="s1">sample_mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">X</span><span class="s3">,</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">sample_mean</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

        <span class="s1">sample_colcov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">N</span><span class="s3">*</span><span class="s1">num_rows</span><span class="s3">,</span><span class="s1">num_cols</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">sample_colcov</span><span class="s3">, </span><span class="s1">V</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

        <span class="s1">sample_rowcov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">swapaxes</span><span class="s3">(</span><span class="s1">X</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span>
                                                        <span class="s1">N</span><span class="s3">*</span><span class="s1">num_cols</span><span class="s3">,</span><span class="s1">num_rows</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">sample_rowcov</span><span class="s3">, </span><span class="s1">U</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_samples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Regression test to ensure that we always generate the same stream of</span>
        <span class="s6"># random variates.</span>
        <span class="s1">actual </span><span class="s3">= </span><span class="s1">matrix_normal</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span>
            <span class="s1">mean</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]]),</span>
            <span class="s1">rowcov</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">4</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]),</span>
            <span class="s1">colcov</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]]),</span>
            <span class="s1">random_state</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">0</span><span class="s3">),</span>
            <span class="s1">size</span><span class="s3">=</span><span class="s5">2</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
            <span class="s3">[[[</span><span class="s5">1.56228264238181</span><span class="s3">, -</span><span class="s5">1.24136424071189</span><span class="s3">],</span>
              <span class="s3">[</span><span class="s5">2.46865788392114</span><span class="s3">, </span><span class="s5">6.22964440489445</span><span class="s3">]],</span>
             <span class="s3">[[</span><span class="s5">3.86405716144353</span><span class="s3">, </span><span class="s5">10.73714311429529</span><span class="s3">],</span>
              <span class="s3">[</span><span class="s5">2.59428444080606</span><span class="s3">, </span><span class="s5">5.79987854490876</span><span class="s3">]]]</span>
        <span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestDirichlet</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_frozen_dirichlet</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">32</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>

        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">))</span>
        <span class="s1">num_tests </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_tests</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]), </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">alpha</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]), </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">alpha</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_numpy_rvs_shape_compatibility</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">7</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s5">7</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alpha_with_zeros</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= [</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">]</span>
        <span class="s6"># don't pass invalid alpha to np.random.dirichlet</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">maximum</span><span class="s3">(</span><span class="s5">1e-9</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">), </span><span class="s1">size</span><span class="s3">=</span><span class="s5">7</span><span class="s3">).</span><span class="s1">T</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alpha_with_negative_entries</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= [</span><span class="s5">1.0</span><span class="s3">, -</span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">]</span>
        <span class="s6"># don't pass invalid alpha to np.random.dirichlet</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">maximum</span><span class="s3">(</span><span class="s5">1e-9</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">), </span><span class="s1">size</span><span class="s3">=</span><span class="s5">7</span><span class="s3">).</span><span class="s1">T</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_data_with_zeros</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">])</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">), </span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s5">6</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_data_with_zeros_and_small_alpha</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_data_with_negative_entries</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.1</span><span class="s3">, -</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_data_with_too_large_entries</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_data_too_deep_c</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">), </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">14</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alpha_too_deep</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">], [</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">]])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">7</span><span class="s3">), </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_alpha_correct_depth</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">), </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_non_simplex_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">), </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_data_vector_too_short</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">7</span><span class="s3">), </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_data_vector_too_long</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">5</span><span class="s3">, </span><span class="s5">7</span><span class="s3">), </span><span class="s5">1 </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">dirichlet</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mean_var_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Reference values calculated by hand and confirmed with Mathematica, e.g.</span>
        <span class="s6"># `Covariance[DirichletDistribution[{ 1, 0.8, 0.2, 10^-300}]]`</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.8</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">])</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)</span>

        <span class="s1">expected_mean </span><span class="s3">= [</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">]</span>
        <span class="s1">expected_var </span><span class="s3">= [</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">12.</span><span class="s3">, </span><span class="s5">0.08</span><span class="s3">, </span><span class="s5">0.03</span><span class="s3">]</span>
        <span class="s1">expected_cov </span><span class="s3">= [</span>
                <span class="s3">[ </span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">12</span><span class="s3">, -</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">15</span><span class="s3">, -</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">60</span><span class="s3">],</span>
                <span class="s3">[-</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">15</span><span class="s3">,  </span><span class="s5">2. </span><span class="s3">/ </span><span class="s5">25</span><span class="s3">, -</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">75</span><span class="s3">],</span>
                <span class="s3">[-</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">60</span><span class="s3">, -</span><span class="s5">1. </span><span class="s3">/ </span><span class="s5">75</span><span class="s3">,  </span><span class="s5">3. </span><span class="s3">/ </span><span class="s5">100</span><span class="s3">],</span>
        <span class="s3">]</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">expected_mean</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">expected_var</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(), </span><span class="s1">expected_cov</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_scalar_values</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.2</span><span class="s3">])</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)</span>

        <span class="s6"># For alpha of length 1, mean and var should be scalar instead of array</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">().</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">var</span><span class="s3">().</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">]).</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">]).</span><span class="s1">ndim</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_K_and_K_minus_1_calls_equal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that calls with K and K-1 entries yield the same results.</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">32</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>

        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">num_tests </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_tests</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]), </span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_multiple_entry_calls</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that calls with multiple x vectors as matrix work</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>

        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">32</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)</span>

        <span class="s1">num_tests </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s1">num_multiple </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">xm </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_tests</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">m </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_multiple</span><span class="s3">):</span>
                <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
                <span class="s1">x </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">xm </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">xm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">xm</span><span class="s3">, </span><span class="s1">x</span><span class="s3">))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">xm </span><span class="s3">= </span><span class="s1">x</span>
            <span class="s1">rm </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">xm</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
            <span class="s1">rs </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">for </span><span class="s1">xs </span><span class="s2">in </span><span class="s1">xm</span><span class="s3">:</span>
                <span class="s1">r </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">xs</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">rs </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">rs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">rs</span><span class="s3">, </span><span class="s1">r</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">rs </span><span class="s3">= </span><span class="s1">r</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">rm</span><span class="s3">, </span><span class="s1">rs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_2D_dirichlet_is_beta</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">2846</span><span class="s3">)</span>

        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">beta</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">alpha</span><span class="s3">[</span><span class="s5">1</span><span class="s3">])</span>

        <span class="s1">num_tests </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_tests</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">10e-10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">b</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">d</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">([</span><span class="s1">x</span><span class="s3">]))</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">b</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">d</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">b</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">d</span><span class="s3">.</span><span class="s1">var</span><span class="s3">()[</span><span class="s5">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_multivariate_normal_dimensions_mismatch</span><span class="s3">():</span>
    <span class="s6"># Regression test for GH #3493. Check that setting up a PDF with a mean of</span>
    <span class="s6"># length M and a covariance matrix of size (N, N), where M != N, raises a</span>
    <span class="s6"># ValueError with an informative error message.</span>
    <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.0</span><span class="s3">])</span>
    <span class="s1">sigma </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.0</span><span class="s3">]])</span>

    <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_normal</span><span class="s3">, </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">)</span>

    <span class="s6"># A simple check that the right error message was passed along. Checking</span>
    <span class="s6"># that the entire message is there, word for word, would be somewhat</span>
    <span class="s6"># fragile, so we just check for the leading part.</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">sigma</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ValueError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;Dimension mismatch&quot;</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)[:</span><span class="s1">len</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)], </span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestWishart</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_scale_dimensions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that we can call the Wishart with various scale dimensions</span>

        <span class="s6"># Test case: dim=1, scale=1</span>
        <span class="s1">true_scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">scales </span><span class="s3">= [</span>
            <span class="s5">1</span><span class="s3">,                    </span><span class="s6"># scalar</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">],                  </span><span class="s6"># iterable</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">),          </span><span class="s6"># 0-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],             </span><span class="s6"># 1-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)  </span><span class="s6"># 2-dim</span>
        <span class="s3">]</span>
        <span class="s2">for </span><span class="s1">scale </span><span class="s2">in </span><span class="s1">scales</span><span class="s3">:</span>
            <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">, </span><span class="s1">true_scale</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">true_scale</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s6"># Test case: dim=2, scale=[[1,0]</span>
        <span class="s6">#                          [0,2]</span>
        <span class="s1">true_scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],</span>
                               <span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">]])</span>
        <span class="s1">scales </span><span class="s3">= [</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">],             </span><span class="s6"># iterable</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">],        </span><span class="s6"># 1-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],   </span><span class="s6"># 2-dim</span>
                      <span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">]])</span>
        <span class="s3">]</span>
        <span class="s2">for </span><span class="s1">scale </span><span class="s2">in </span><span class="s1">scales</span><span class="s3">:</span>
            <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">, </span><span class="s1">true_scale</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">scale</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">true_scale</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s6"># We cannot call with a df &lt; dim - 1</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">wishart</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))</span>

        <span class="s6"># But we can call with dim - 1 &lt; df &lt; dim</span>
        <span class="s1">wishart</span><span class="s3">(</span><span class="s5">1.1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))  </span><span class="s6"># no error</span>
        <span class="s6"># see gh-5562</span>

        <span class="s6"># We cannot call with a 3-dimension array</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">wishart</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_quantile_dimensions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that we can call the Wishart rvs with various quantile dimensions</span>

        <span class="s6"># If dim == 1, consider x.shape = [1,1,1]</span>
        <span class="s1">X </span><span class="s3">= [</span>
            <span class="s5">1</span><span class="s3">,                      </span><span class="s6"># scalar</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">],                    </span><span class="s6"># iterable</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">),            </span><span class="s6"># 0-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s5">1</span><span class="s3">],               </span><span class="s6"># 1-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">2</span><span class="s3">),   </span><span class="s6"># 2-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">], </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)  </span><span class="s6"># 3-dim</span>
        <span class="s3">]</span>

        <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">density </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">3</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">X</span><span class="s3">:</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">density</span><span class="s3">)</span>

        <span class="s6"># If dim == 1, consider x.shape = [1,1,*]</span>
        <span class="s1">X </span><span class="s3">= [</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">],                     </span><span class="s6"># iterable</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">],                </span><span class="s6"># 1-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">], </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)   </span><span class="s6"># 3-dim</span>
        <span class="s3">]</span>

        <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">density </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">], </span><span class="s1">ndmin</span><span class="s3">=</span><span class="s5">3</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">X</span><span class="s3">:</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">density</span><span class="s3">)</span>

        <span class="s6"># If dim == 2, consider x.shape = [2,2,1]</span>
        <span class="s6"># where x[:,:,*] = np.eye(1)*2</span>
        <span class="s1">X </span><span class="s3">= [</span>
            <span class="s5">2</span><span class="s3">,                    </span><span class="s6"># scalar</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">],                </span><span class="s6"># iterable</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s5">2</span><span class="s3">),          </span><span class="s6"># 0-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s5">2</span><span class="s3">,</span><span class="s5">2</span><span class="s3">],           </span><span class="s6"># 1-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">]]),    </span><span class="s6"># 2-dim</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">]])[:,:,</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]  </span><span class="s6"># 3-dim</span>
        <span class="s3">]</span>

        <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">density </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],</span>
                                  <span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">]])[:,:,</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">])</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">X</span><span class="s3">:</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">density</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that the frozen and non-frozen Wishart gives the same answers</span>

        <span class="s6"># Construct an arbitrary positive definite scale matrix</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)+</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim </span><span class="s3">* (</span><span class="s1">dim</span><span class="s3">-</span><span class="s5">1</span><span class="s3">) // </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>

        <span class="s6"># Construct a collection of positive definite matrices to test the PDF</span>
        <span class="s1">X </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">5</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)+(</span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">x</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim </span><span class="s3">* (</span><span class="s1">dim</span><span class="s3">-</span><span class="s5">1</span><span class="s3">) // </span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">X</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span>

        <span class="s6"># Construct a 1D and 2D set of parameters</span>
        <span class="s1">parameters </span><span class="s3">= [</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)),  </span><span class="s6"># 1D case</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
        <span class="s3">]</span>

        <span class="s2">for </span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">x</span><span class="s3">) </span><span class="s2">in </span><span class="s1">parameters</span><span class="s3">:</span>
            <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">wishart</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">wishart</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">(), </span><span class="s1">wishart</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">wishart</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">wishart</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_wishart_2D_rvs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">10</span>

        <span class="s6"># Construct a simple non-diagonal positive definite matrix</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">] = </span><span class="s5">0.5</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0.5</span>

        <span class="s6"># Construct frozen Wishart random variables</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>

        <span class="s6"># Get the generated random variables from a known seed</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">248042</span><span class="s3">)</span>
        <span class="s1">w_rvs </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">248042</span><span class="s3">)</span>
        <span class="s1">frozen_w_rvs </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s6"># Manually calculate what it should be, based on the Bartlett (1933)</span>
        <span class="s6"># decomposition of a Wishart into D A A' D', where D is the Cholesky</span>
        <span class="s6"># factorization of the scale matrix and A is the lower triangular matrix</span>
        <span class="s6"># with the square root of chi^2 variates on the diagonal and N(0,1)</span>
        <span class="s6"># variates in the lower triangle.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">248042</span><span class="s3">)</span>
        <span class="s1">covariances </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">variances </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">chisquare</span><span class="s3">(</span><span class="s1">df</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">chisquare</span><span class="s3">(</span><span class="s1">df</span><span class="s3">-</span><span class="s5">1</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">chisquare</span><span class="s3">(</span><span class="s1">df</span><span class="s3">-</span><span class="s5">2</span><span class="s3">),</span>
        <span class="s3">]**</span><span class="s5">0.5</span>

        <span class="s6"># Construct the lower-triangular A matrix</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">variances</span><span class="s3">)</span>
        <span class="s1">A</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">covariances</span>

        <span class="s6"># Wishart random variate</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">cholesky</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">DA </span><span class="s3">= </span><span class="s1">D</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">manual_w_rvs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">DA</span><span class="s3">, </span><span class="s1">DA</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s6"># Test for equality</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w_rvs</span><span class="s3">, </span><span class="s1">manual_w_rvs</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">frozen_w_rvs</span><span class="s3">, </span><span class="s1">manual_w_rvs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_1D_is_chisquared</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The 1-dimensional Wishart with an identity scale matrix is just a</span>
        <span class="s6"># chi-squared distribution.</span>
        <span class="s6"># Test variance, mean, entropy, pdf</span>
        <span class="s6"># Kolgomorov-Smirnov test for rvs</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">482974</span><span class="s3">)</span>

        <span class="s1">sn </span><span class="s3">= </span><span class="s5">500</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>

        <span class="s1">df_range </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0.1</span><span class="s3">,</span><span class="s5">10</span><span class="s3">,</span><span class="s1">num</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">df </span><span class="s2">in </span><span class="s1">df_range</span><span class="s3">:</span>
            <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">c </span><span class="s3">= </span><span class="s1">chi2</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

            <span class="s6"># Statistics</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">var</span><span class="s3">())</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">())</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>

            <span class="s6"># PDF</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

            <span class="s6"># rvs</span>
            <span class="s1">rvs </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">sn</span><span class="s3">)</span>
            <span class="s1">args </span><span class="s3">= (</span><span class="s1">df</span><span class="s3">,)</span>
            <span class="s1">alpha </span><span class="s3">= </span><span class="s5">0.01</span>
            <span class="s1">check_distribution_rvs</span><span class="s3">(</span><span class="s4">'chi2'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">rvs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_scaled_chisquared</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The 2-dimensional Wishart with an arbitrary scale matrix can be</span>
        <span class="s6"># transformed to a scaled chi-squared distribution.</span>
        <span class="s6"># For :math:`S \sim W_p(V,n)` and :math:`\lambda \in \mathbb{R}^p` we have</span>
        <span class="s6"># :math:`\lambda' S \lambda \sim \lambda' V \lambda \times \chi^2(n)`</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">482974</span><span class="s3">)</span>

        <span class="s1">sn </span><span class="s3">= </span><span class="s5">500</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s6"># Construct an arbitrary positive definite matrix</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)+</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">6</span><span class="s3">)</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s6"># Use :math:`\lambda = [1, \dots, 1]'`</span>
        <span class="s1">lamda </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">dim</span><span class="s3">,</span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">sigma_lamda </span><span class="s3">= </span><span class="s1">lamda</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">).</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">lamda</span><span class="s3">).</span><span class="s1">squeeze</span><span class="s3">()</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s1">wishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">sigma_lamda</span><span class="s3">)</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">chi2</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s1">sigma_lamda</span><span class="s3">)</span>

        <span class="s6"># Statistics</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">var</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>

        <span class="s6"># PDF</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0.1</span><span class="s3">,</span><span class="s5">10</span><span class="s3">,</span><span class="s1">num</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

        <span class="s6"># rvs</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">w</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">sn</span><span class="s3">)</span>
        <span class="s1">args </span><span class="s3">= (</span><span class="s1">df</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s1">sigma_lamda</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s5">0.01</span>
        <span class="s1">check_distribution_rvs</span><span class="s3">(</span><span class="s4">'chi2'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">rvs</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">TestMultinomial</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_logpmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">vals1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">((</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s5">7</span><span class="s3">, (</span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals1</span><span class="s3">, -</span><span class="s5">1.483270127243324</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals2 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, [</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">vals2 </span><span class="s3">== -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

        <span class="s1">vals3 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, [</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">vals3 </span><span class="s3">== </span><span class="s5">0</span>

        <span class="s1">vals4 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, [-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reduces_binomial</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test that the multinomial pmf reduces to the binomial pmf in the 2d</span>
        <span class="s6"># case</span>
        <span class="s1">val1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s5">7</span><span class="s3">, (</span><span class="s5">0.3</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">))</span>
        <span class="s1">val2 </span><span class="s3">= </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">0.3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val1</span><span class="s3">, </span><span class="s1">val2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">val1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">((</span><span class="s5">6</span><span class="s3">, </span><span class="s5">8</span><span class="s3">), </span><span class="s5">14</span><span class="s3">, (</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">))</span>
        <span class="s1">val2 </span><span class="s3">= </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s5">6</span><span class="s3">, </span><span class="s5">14</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val1</span><span class="s3">, </span><span class="s1">val2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_R</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test against the values produced by this R code</span>
        <span class="s6"># (https://stat.ethz.ch/R-manual/R-devel/library/stats/html/Multinom.html)</span>
        <span class="s6"># X &lt;- t(as.matrix(expand.grid(0:3, 0:3))); X &lt;- X[, colSums(X) &lt;= 3]</span>
        <span class="s6"># X &lt;- rbind(X, 3:3 - colSums(X)); dimnames(X) &lt;- list(letters[1:3], NULL)</span>
        <span class="s6"># X</span>
        <span class="s6"># apply(X, 2, function(x) dmultinom(x, prob = c(1,2,5)))</span>

        <span class="s1">n</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s5">3</span><span class="s3">, [</span><span class="s5">1.</span><span class="s3">/</span><span class="s5">8</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">/</span><span class="s5">8</span><span class="s3">, </span><span class="s5">5.</span><span class="s3">/</span><span class="s5">8</span><span class="s3">]</span>
        <span class="s1">r_vals </span><span class="s3">= {(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">): </span><span class="s5">0.244140625</span><span class="s3">, (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">): </span><span class="s5">0.146484375</span><span class="s3">,</span>
                  <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">): </span><span class="s5">0.029296875</span><span class="s3">, (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): </span><span class="s5">0.001953125</span><span class="s3">,</span>
                  <span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">): </span><span class="s5">0.292968750</span><span class="s3">, (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">): </span><span class="s5">0.117187500</span><span class="s3">,</span>
                  <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): </span><span class="s5">0.011718750</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">): </span><span class="s5">0.117187500</span><span class="s3">,</span>
                  <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): </span><span class="s5">0.023437500</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): </span><span class="s5">0.015625000</span><span class="s3">}</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">r_vals</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">), </span><span class="s1">r_vals</span><span class="s3">[</span><span class="s1">x</span><span class="s3">], </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;n&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_rvs_np</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s6"># test that .rvs agrees w/numpy</span>
        <span class="s1">sc_rvs </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">/</span><span class="s5">4.</span><span class="s3">]*</span><span class="s5">3</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">7</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">rndm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">np_rvs </span><span class="s3">= </span><span class="s1">rndm</span><span class="s3">.</span><span class="s1">multinomial</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">/</span><span class="s5">4.</span><span class="s3">]*</span><span class="s5">3</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">7</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">sc_rvs</span><span class="s3">, </span><span class="s1">np_rvs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">vals0 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">((</span><span class="s5">5</span><span class="s3">,), </span><span class="s5">5</span><span class="s3">, (</span><span class="s5">1</span><span class="s3">,))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">((</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), </span><span class="s5">7</span><span class="s3">, (</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals1</span><span class="s3">, </span><span class="s5">.22689449999999994</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals2 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([[[</span><span class="s5">3</span><span class="s3">,</span><span class="s5">5</span><span class="s3">],[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">8</span><span class="s3">]], [[-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">9</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]], </span><span class="s5">8</span><span class="s3">,</span>
                                <span class="s3">(</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals2</span><span class="s3">, [[</span><span class="s5">.03306744</span><span class="s3">, </span><span class="s5">.43046721</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">vals3 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, (</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">vals3</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">))</span>

        <span class="s1">vals4 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">], </span><span class="s5">4</span><span class="s3">, (</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals4</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals5 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">6</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals5</span><span class="s3">, </span><span class="s5">0.219478737997</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals5 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">vals5 </span><span class="s3">== </span><span class="s5">1</span>

        <span class="s1">vals6 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">/</span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">vals6 </span><span class="s3">== </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">test_pmf_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">vals0 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s5">3</span><span class="s3">, [[</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">], [</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">]])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals0</span><span class="s3">, [</span><span class="s5">.243</span><span class="s3">, </span><span class="s5">.384</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals1</span><span class="s3">, [</span><span class="s5">.243</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals2 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]], </span><span class="s5">3</span><span class="s3">, [</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals2</span><span class="s3">, [[</span><span class="s5">.243</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals3 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [[[</span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">]]], [</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals3</span><span class="s3">, [[[</span><span class="s5">.243</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">]]], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">vals4 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">]], [[[[</span><span class="s5">3</span><span class="s3">]]]], [</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals4</span><span class="s3">, [[[[</span><span class="s5">.243</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]]], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;n&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">cov1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, (</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.5</span><span class="s3">))</span>
        <span class="s1">cov2 </span><span class="s3">= [[</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">*</span><span class="s5">.8</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">*</span><span class="s5">.5</span><span class="s3">],</span>
                <span class="s3">[-</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.7</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.5</span><span class="s3">],</span>
                <span class="s3">[-</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.5</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">, -</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.5</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s5">.5</span><span class="s3">*</span><span class="s5">.5</span><span class="s3">]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov1</span><span class="s3">, </span><span class="s1">cov2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cov_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, [[</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">], [</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">]])</span>
        <span class="s1">cov2 </span><span class="s3">= [[[</span><span class="s5">.45</span><span class="s3">, -</span><span class="s5">.45</span><span class="s3">],[-</span><span class="s5">.45</span><span class="s3">, </span><span class="s5">.45</span><span class="s3">]], [[</span><span class="s5">.8</span><span class="s3">, -</span><span class="s5">.8</span><span class="s3">], [-</span><span class="s5">.8</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">]]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov1</span><span class="s3">, </span><span class="s1">cov2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">cov3 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">([</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.9</span><span class="s3">])</span>
        <span class="s1">cov4 </span><span class="s3">= [[[</span><span class="s5">.36</span><span class="s3">, -</span><span class="s5">.36</span><span class="s3">], [-</span><span class="s5">.36</span><span class="s3">, </span><span class="s5">.36</span><span class="s3">]], [[</span><span class="s5">.45</span><span class="s3">, -</span><span class="s5">.45</span><span class="s3">], [-</span><span class="s5">.45</span><span class="s3">, </span><span class="s5">.45</span><span class="s3">]]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov3</span><span class="s3">, </span><span class="s1">cov4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">cov5 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">([</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [[</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">], [</span><span class="s5">.4</span><span class="s3">, </span><span class="s5">.6</span><span class="s3">]])</span>
        <span class="s1">cov6 </span><span class="s3">= [[[</span><span class="s5">4</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.7</span><span class="s3">, -</span><span class="s5">4</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.7</span><span class="s3">], [-</span><span class="s5">4</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">*</span><span class="s5">.3</span><span class="s3">*</span><span class="s5">.7</span><span class="s3">]],</span>
                <span class="s3">[[</span><span class="s5">5</span><span class="s3">*</span><span class="s5">.4</span><span class="s3">*</span><span class="s5">.6</span><span class="s3">, -</span><span class="s5">5</span><span class="s3">*</span><span class="s5">.4</span><span class="s3">*</span><span class="s5">.6</span><span class="s3">], [-</span><span class="s5">5</span><span class="s3">*</span><span class="s5">.4</span><span class="s3">*</span><span class="s5">.6</span><span class="s3">, </span><span class="s5">5</span><span class="s3">*</span><span class="s5">.4</span><span class="s3">*</span><span class="s5">.6</span><span class="s3">]]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov5</span><span class="s3">, </span><span class="s1">cov6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;n&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_entropy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s6"># this is equivalent to a binomial distribution with n=2, so the</span>
        <span class="s6"># entropy .77899774929 is easily computed &quot;by hand&quot;</span>
        <span class="s1">ent0 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, [</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ent0</span><span class="s3">, </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s5">.2</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_entropy_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">ent0 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ent0</span><span class="s3">, [</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">.2</span><span class="s3">), </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">.2</span><span class="s3">)],</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">ent1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">([</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], [[</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">], [</span><span class="s5">.4</span><span class="s3">, </span><span class="s5">.6</span><span class="s3">]])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ent1</span><span class="s3">, [</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">), </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">.4</span><span class="s3">)],</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">ent2 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">([[</span><span class="s5">7</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">]], [[</span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.7</span><span class="s3">], [</span><span class="s5">.4</span><span class="s3">, </span><span class="s5">.6</span><span class="s3">]])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">ent2</span><span class="s3">,</span>
                        <span class="s3">[[</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">), </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">7</span><span class="s3">, </span><span class="s5">.4</span><span class="s3">)],</span>
                         <span class="s3">[</span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">), </span><span class="s1">binom</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">.4</span><span class="s3">)]],</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;n&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_mean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">mean1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, [</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean1</span><span class="s3">, [</span><span class="s1">n</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">, </span><span class="s1">n</span><span class="s3">*</span><span class="s5">.8</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mean_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mean1 </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">([</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean1</span><span class="s3">, [[</span><span class="s5">5</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">*</span><span class="s5">.8</span><span class="s3">], [</span><span class="s5">6</span><span class="s3">*</span><span class="s5">.2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">*</span><span class="s5">.8</span><span class="s3">]], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The frozen distribution should agree with the regular one</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">12</span>
        <span class="s1">pvals </span><span class="s3">= (</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">.2</span><span class="s3">, </span><span class="s5">.3</span><span class="s3">, </span><span class="s5">.4</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= [[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">12</span><span class="s3">],[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">11</span><span class="s3">],[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">10</span><span class="s3">],[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">9</span><span class="s3">],[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">,</span><span class="s5">8</span><span class="s3">]]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">mn_frozen </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">pvals</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mn_frozen</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">pvals</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mn_frozen</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">pvals</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mn_frozen</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">pvals</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_gh_11860</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># gh-11860 reported cases in which the adjustments made by multinomial</span>
        <span class="s6"># to the last element of `p` can cause `nan`s even when the input is</span>
        <span class="s6"># essentially valid. Check that a pathological case returns a finite,</span>
        <span class="s6"># nonzero result. (This would fail in main before the PR.)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">88</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">8879715917488330089</span><span class="s3">)</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">p</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] = </span><span class="s5">1e-30</span>
        <span class="s1">p </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">logpmf </span><span class="s3">= </span><span class="s1">multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">logpmf</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">TestInvwishart</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that the frozen and non-frozen inverse Wishart gives the same</span>
        <span class="s6"># answers</span>

        <span class="s6"># Construct an arbitrary positive definite scale matrix</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)+</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">*(</span><span class="s1">dim</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)/</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>

        <span class="s6"># Construct a collection of positive definite matrices to test the PDF</span>
        <span class="s1">X </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">5</span><span class="s3">):</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)+(</span><span class="s1">i</span><span class="s3">+</span><span class="s5">1</span><span class="s3">)**</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">x</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">*(</span><span class="s1">dim</span><span class="s3">-</span><span class="s5">1</span><span class="s3">)/</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">X</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span>

        <span class="s6"># Construct a 1D and 2D set of parameters</span>
        <span class="s1">parameters </span><span class="s3">= [</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)),  </span><span class="s6"># 1D case</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
        <span class="s3">]</span>

        <span class="s2">for </span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">x</span><span class="s3">) </span><span class="s2">in </span><span class="s1">parameters</span><span class="s3">:</span>
            <span class="s1">iw </span><span class="s3">= </span><span class="s1">invwishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">invwishart</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">invwishart</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">(), </span><span class="s1">invwishart</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">invwishart</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_1D_is_invgamma</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The 1-dimensional inverse Wishart with an identity scale matrix is</span>
        <span class="s6"># just an inverse gamma distribution.</span>
        <span class="s6"># Test variance, mean, pdf, entropy</span>
        <span class="s6"># Kolgomorov-Smirnov test for rvs</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">482974</span><span class="s3">)</span>

        <span class="s1">sn </span><span class="s3">= </span><span class="s5">500</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">1</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>

        <span class="s1">df_range </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s5">0.1</span><span class="s3">,</span><span class="s5">10</span><span class="s3">,</span><span class="s1">num</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">df </span><span class="s2">in </span><span class="s1">df_range</span><span class="s3">:</span>
            <span class="s1">iw </span><span class="s3">= </span><span class="s1">invwishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">ig </span><span class="s3">= </span><span class="s1">invgamma</span><span class="s3">(</span><span class="s1">df</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s5">1.</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)</span>

            <span class="s6"># Statistics</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">ig</span><span class="s3">.</span><span class="s1">var</span><span class="s3">())</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">ig</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">())</span>

            <span class="s6"># PDF</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">ig</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

            <span class="s6"># rvs</span>
            <span class="s1">rvs </span><span class="s3">= </span><span class="s1">iw</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">sn</span><span class="s3">)</span>
            <span class="s1">args </span><span class="s3">= (</span><span class="s1">df</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">alpha </span><span class="s3">= </span><span class="s5">0.01</span>
            <span class="s1">check_distribution_rvs</span><span class="s3">(</span><span class="s4">'invgamma'</span><span class="s3">, </span><span class="s1">args</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">rvs</span><span class="s3">)</span>

            <span class="s6"># entropy</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">iw</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">ig</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>

    <span class="s2">def </span><span class="s1">test_invwishart_2D_rvs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">10</span>

        <span class="s6"># Construct a simple non-diagonal positive definite matrix</span>
        <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">] = </span><span class="s5">0.5</span>
        <span class="s1">scale</span><span class="s3">[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0.5</span>

        <span class="s6"># Construct frozen inverse-Wishart random variables</span>
        <span class="s1">iw </span><span class="s3">= </span><span class="s1">invwishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>

        <span class="s6"># Get the generated random variables from a known seed</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">608072</span><span class="s3">)</span>
        <span class="s1">iw_rvs </span><span class="s3">= </span><span class="s1">invwishart</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">608072</span><span class="s3">)</span>
        <span class="s1">frozen_iw_rvs </span><span class="s3">= </span><span class="s1">iw</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s6"># Manually calculate what it should be, based on the decomposition in</span>
        <span class="s6"># https://arxiv.org/abs/2310.15884 of an invers-Wishart into L L',</span>
        <span class="s6"># where L A = D, D is the Cholesky factorization of the scale matrix,</span>
        <span class="s6"># and A is the lower triangular matrix with the square root of chi^2</span>
        <span class="s6"># variates on the diagonal and N(0,1) variates in the lower triangle.</span>
        <span class="s6"># the diagonal chi^2 variates in this A are reversed compared to those</span>
        <span class="s6"># in the Bartlett decomposition A for Wishart rvs.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">608072</span><span class="s3">)</span>
        <span class="s1">covariances </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">variances </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">chisquare</span><span class="s3">(</span><span class="s1">df</span><span class="s3">-</span><span class="s5">2</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">chisquare</span><span class="s3">(</span><span class="s1">df</span><span class="s3">-</span><span class="s5">1</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">chisquare</span><span class="s3">(</span><span class="s1">df</span><span class="s3">),</span>
        <span class="s3">]**</span><span class="s5">0.5</span>

        <span class="s6"># Construct the lower-triangular A matrix</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">variances</span><span class="s3">)</span>
        <span class="s1">A</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">covariances</span>

        <span class="s6"># inverse-Wishart random variate</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">cholesky</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">)</span>
        <span class="s1">L </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">solve</span><span class="s3">(</span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">D</span><span class="s3">.</span><span class="s1">T</span><span class="s3">).</span><span class="s1">T</span>
        <span class="s1">manual_iw_rvs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">L</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s6"># Test for equality</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">iw_rvs</span><span class="s3">, </span><span class="s1">manual_iw_rvs</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">frozen_iw_rvs</span><span class="s3">, </span><span class="s1">manual_iw_rvs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_sample_mean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Test that sample mean consistent with known mean.&quot;&quot;&quot;</span>
        <span class="s6"># Construct an arbitrary positive definite scale matrix</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s1">sample_size </span><span class="s3">= </span><span class="s5">20_000</span>
        <span class="s2">for </span><span class="s1">dim </span><span class="s2">in </span><span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]:</span>
            <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">) + </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">scale</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tril_indices</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">dim </span><span class="s3">* (</span><span class="s1">dim </span><span class="s3">- </span><span class="s5">1</span><span class="s3">) / </span><span class="s5">2</span><span class="s3">)</span>
            <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>

            <span class="s1">dist </span><span class="s3">= </span><span class="s1">invwishart</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)</span>
            <span class="s1">Xmean_exp </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">()</span>
            <span class="s1">Xvar_exp </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">var</span><span class="s3">()</span>
            <span class="s1">Xmean_std </span><span class="s3">= (</span><span class="s1">Xvar_exp </span><span class="s3">/ </span><span class="s1">sample_size</span><span class="s3">)**</span><span class="s5">0.5  </span><span class="s6"># asymptotic SE of mean estimate</span>

            <span class="s1">X </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">sample_size</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
            <span class="s1">Xmean_est </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

            <span class="s1">ntests </span><span class="s3">= </span><span class="s1">dim</span><span class="s3">*(</span><span class="s1">dim </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)//</span><span class="s5">2</span>
            <span class="s1">fail_rate </span><span class="s3">= </span><span class="s5">0.01 </span><span class="s3">/ </span><span class="s1">ntests  </span><span class="s6"># correct for multiple tests</span>
            <span class="s1">max_diff </span><span class="s3">= </span><span class="s1">norm</span><span class="s3">.</span><span class="s1">ppf</span><span class="s3">(</span><span class="s5">1 </span><span class="s3">- </span><span class="s1">fail_rate </span><span class="s3">/ </span><span class="s5">2</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">allclose</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">Xmean_est </span><span class="s3">- </span><span class="s1">Xmean_exp</span><span class="s3">) / </span><span class="s1">Xmean_std</span><span class="s3">,</span>
                <span class="s5">0</span><span class="s3">,</span>
                <span class="s1">atol</span><span class="s3">=</span><span class="s1">max_diff</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_logpdf_4x4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Regression test for gh-8844.&quot;&quot;&quot;</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>
        <span class="s1">Psi </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">9</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                        <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]])</span>
        <span class="s1">nu </span><span class="s3">= </span><span class="s5">6</span>
        <span class="s1">prob </span><span class="s3">= </span><span class="s1">invwishart</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">nu</span><span class="s3">, </span><span class="s1">Psi</span><span class="s3">)</span>
        <span class="s6"># Explicit calculation from the formula on wikipedia.</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">sig</span><span class="s3">, </span><span class="s1">logdetX </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">slogdet</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">sig</span><span class="s3">, </span><span class="s1">logdetPsi </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">slogdet</span><span class="s3">(</span><span class="s1">Psi</span><span class="s3">)</span>
        <span class="s1">M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">solve</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Psi</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= ((</span><span class="s1">nu</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)*</span><span class="s1">logdetPsi</span>
                    <span class="s3">- (</span><span class="s1">nu</span><span class="s3">*</span><span class="s1">p</span><span class="s3">/</span><span class="s5">2</span><span class="s3">)*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
                    <span class="s3">- </span><span class="s1">multigammaln</span><span class="s3">(</span><span class="s1">nu</span><span class="s3">/</span><span class="s5">2</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)</span>
                    <span class="s3">- (</span><span class="s1">nu </span><span class="s3">+ </span><span class="s1">p </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)/</span><span class="s5">2</span><span class="s3">*</span><span class="s1">logdetX</span>
                    <span class="s3">- </span><span class="s5">0.5</span><span class="s3">*</span><span class="s1">M</span><span class="s3">.</span><span class="s1">trace</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">prob</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestSpecialOrthoGroup</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_reproducibility</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[-</span><span class="s5">0.99394515</span><span class="s3">, -</span><span class="s5">0.04527879</span><span class="s3">, </span><span class="s5">0.10011432</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">0.04821555</span><span class="s3">, -</span><span class="s5">0.99846897</span><span class="s3">, </span><span class="s5">0.02711042</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">0.09873351</span><span class="s3">, </span><span class="s5">0.03177334</span><span class="s3">, </span><span class="s5">0.99460653</span><span class="s3">]])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">random_state </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">random_state</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_dim</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">special_ortho_group</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>

        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_det_and_ortho</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">xs </span><span class="s3">= [</span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
              <span class="s2">for </span><span class="s1">dim </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s5">12</span><span class="s3">)</span>
              <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)]</span>

        <span class="s6"># Test that determinants are always +1</span>
        <span class="s1">dets </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dets</span><span class="s3">, [</span><span class="s5">1.</span><span class="s3">]*</span><span class="s5">30</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

        <span class="s6"># Test that these are orthogonal matrices</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">),</span>
                                      <span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]))</span>

    <span class="s2">def </span><span class="s1">test_haar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that the distribution is constant under rotation</span>
        <span class="s6"># Every column should have the same distribution</span>
        <span class="s6"># Additionally, the distribution should be invariant under another rotation</span>

        <span class="s6"># Generate samples</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s5">1000  </span><span class="s6"># Not too many, or the test takes too long</span>
        <span class="s1">ks_prob </span><span class="s3">= </span><span class="s5">.05</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">xs </span><span class="s3">= </span><span class="s1">special_ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">samples</span><span class="s3">)</span>

        <span class="s6"># Dot a few rows (0, 1, 2) with unit vectors (0, 2, 4, 3),</span>
        <span class="s6">#   effectively picking off entries in the matrices of xs.</span>
        <span class="s6">#   These projections should all have the same distribution,</span>
        <span class="s6">#     establishing rotational invariance. We use the two-sided</span>
        <span class="s6">#     KS test to confirm this.</span>
        <span class="s6">#   We could instead test that angles between random vectors</span>
        <span class="s6">#     are uniformly distributed, but the below is sufficient.</span>
        <span class="s6">#   It is not feasible to consider all pairs, so pick a few.</span>
        <span class="s1">els </span><span class="s3">= ((</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">), (</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">))</span>
        <span class="s6">#proj = {(er, ec): [x[er][ec] for x in xs] for er, ec in els}</span>
        <span class="s1">proj </span><span class="s3">= {(</span><span class="s1">er</span><span class="s3">, </span><span class="s1">ec</span><span class="s3">): </span><span class="s1">sorted</span><span class="s3">([</span><span class="s1">x</span><span class="s3">[</span><span class="s1">er</span><span class="s3">][</span><span class="s1">ec</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">]) </span><span class="s2">for </span><span class="s1">er</span><span class="s3">, </span><span class="s1">ec </span><span class="s2">in </span><span class="s1">els</span><span class="s3">}</span>
        <span class="s1">pairs </span><span class="s3">= [(</span><span class="s1">e0</span><span class="s3">, </span><span class="s1">e1</span><span class="s3">) </span><span class="s2">for </span><span class="s1">e0 </span><span class="s2">in </span><span class="s1">els </span><span class="s2">for </span><span class="s1">e1 </span><span class="s2">in </span><span class="s1">els </span><span class="s2">if </span><span class="s1">e0 </span><span class="s3">&gt; </span><span class="s1">e1</span><span class="s3">]</span>
        <span class="s1">ks_tests </span><span class="s3">= [</span><span class="s1">ks_2samp</span><span class="s3">(</span><span class="s1">proj</span><span class="s3">[</span><span class="s1">p0</span><span class="s3">], </span><span class="s1">proj</span><span class="s3">[</span><span class="s1">p1</span><span class="s3">])[</span><span class="s5">1</span><span class="s3">] </span><span class="s2">for </span><span class="s3">(</span><span class="s1">p0</span><span class="s3">, </span><span class="s1">p1</span><span class="s3">) </span><span class="s2">in </span><span class="s1">pairs</span><span class="s3">]</span>
        <span class="s1">assert_array_less</span><span class="s3">([</span><span class="s1">ks_prob</span><span class="s3">]*</span><span class="s1">len</span><span class="s3">(</span><span class="s1">pairs</span><span class="s3">), </span><span class="s1">ks_tests</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestOrthoGroup</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_reproducibility</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">seed </span><span class="s3">= </span><span class="s5">514</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s6"># Note this matrix has det -1, distinguishing O(N) from SO(N)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), -</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.381686</span><span class="s3">, -</span><span class="s5">0.090374</span><span class="s3">, </span><span class="s5">0.919863</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">0.905794</span><span class="s3">, -</span><span class="s5">0.161537</span><span class="s3">, -</span><span class="s5">0.391718</span><span class="s3">],</span>
                             <span class="s3">[-</span><span class="s5">0.183993</span><span class="s3">, -</span><span class="s5">0.98272</span><span class="s3">, -</span><span class="s5">0.020204</span><span class="s3">]])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_dim</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">frozen_seed </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>

        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">rvs3 </span><span class="s3">= </span><span class="s1">frozen_seed</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_det_and_ortho</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">xs </span><span class="s3">= [[</span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
               <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)]</span>
              <span class="s2">for </span><span class="s1">dim </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s5">12</span><span class="s3">)]</span>

        <span class="s6"># Test that abs determinants are always +1</span>
        <span class="s1">dets </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xx</span><span class="s3">] </span><span class="s2">for </span><span class="s1">xx </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">fabs</span><span class="s3">(</span><span class="s1">dets</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">dets</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

        <span class="s6"># Test that these are orthogonal matrices</span>
        <span class="s2">for </span><span class="s1">xx </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">:</span>
            <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xx</span><span class="s3">:</span>
                <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">),</span>
                                          <span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">20</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_det_distribution_gh18272</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s6"># Test that positive and negative determinants are equally likely.</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">6796248956179332344</span><span class="s3">)</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">5000</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">dets </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">)</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">dets </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">dets</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">binomtest</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">low</span><span class="s3">, </span><span class="s1">high </span><span class="s3">= </span><span class="s1">res</span><span class="s3">.</span><span class="s1">proportion_ci</span><span class="s3">(</span><span class="s1">confidence_level</span><span class="s3">=</span><span class="s5">0.95</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">low </span><span class="s3">&lt; </span><span class="s5">0.5 </span><span class="s3">&lt; </span><span class="s1">high</span>

    <span class="s2">def </span><span class="s1">test_haar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that the distribution is constant under rotation</span>
        <span class="s6"># Every column should have the same distribution</span>
        <span class="s6"># Additionally, the distribution should be invariant under another rotation</span>

        <span class="s6"># Generate samples</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s5">1000  </span><span class="s6"># Not too many, or the test takes too long</span>
        <span class="s1">ks_prob </span><span class="s3">= </span><span class="s5">.05</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">518</span><span class="s3">)  </span><span class="s6"># Note that the test is sensitive to seed too</span>
        <span class="s1">xs </span><span class="s3">= </span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">samples</span><span class="s3">)</span>

        <span class="s6"># Dot a few rows (0, 1, 2) with unit vectors (0, 2, 4, 3),</span>
        <span class="s6">#   effectively picking off entries in the matrices of xs.</span>
        <span class="s6">#   These projections should all have the same distribution,</span>
        <span class="s6">#     establishing rotational invariance. We use the two-sided</span>
        <span class="s6">#     KS test to confirm this.</span>
        <span class="s6">#   We could instead test that angles between random vectors</span>
        <span class="s6">#     are uniformly distributed, but the below is sufficient.</span>
        <span class="s6">#   It is not feasible to consider all pairs, so pick a few.</span>
        <span class="s1">els </span><span class="s3">= ((</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">), (</span><span class="s5">0</span><span class="s3">,</span><span class="s5">2</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">,</span><span class="s5">4</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">,</span><span class="s5">3</span><span class="s3">))</span>
        <span class="s6">#proj = {(er, ec): [x[er][ec] for x in xs] for er, ec in els}</span>
        <span class="s1">proj </span><span class="s3">= {(</span><span class="s1">er</span><span class="s3">, </span><span class="s1">ec</span><span class="s3">): </span><span class="s1">sorted</span><span class="s3">([</span><span class="s1">x</span><span class="s3">[</span><span class="s1">er</span><span class="s3">][</span><span class="s1">ec</span><span class="s3">] </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">]) </span><span class="s2">for </span><span class="s1">er</span><span class="s3">, </span><span class="s1">ec </span><span class="s2">in </span><span class="s1">els</span><span class="s3">}</span>
        <span class="s1">pairs </span><span class="s3">= [(</span><span class="s1">e0</span><span class="s3">, </span><span class="s1">e1</span><span class="s3">) </span><span class="s2">for </span><span class="s1">e0 </span><span class="s2">in </span><span class="s1">els </span><span class="s2">for </span><span class="s1">e1 </span><span class="s2">in </span><span class="s1">els </span><span class="s2">if </span><span class="s1">e0 </span><span class="s3">&gt; </span><span class="s1">e1</span><span class="s3">]</span>
        <span class="s1">ks_tests </span><span class="s3">= [</span><span class="s1">ks_2samp</span><span class="s3">(</span><span class="s1">proj</span><span class="s3">[</span><span class="s1">p0</span><span class="s3">], </span><span class="s1">proj</span><span class="s3">[</span><span class="s1">p1</span><span class="s3">])[</span><span class="s5">1</span><span class="s3">] </span><span class="s2">for </span><span class="s3">(</span><span class="s1">p0</span><span class="s3">, </span><span class="s1">p1</span><span class="s3">) </span><span class="s2">in </span><span class="s1">pairs</span><span class="s3">]</span>
        <span class="s1">assert_array_less</span><span class="s3">([</span><span class="s1">ks_prob</span><span class="s3">]*</span><span class="s1">len</span><span class="s3">(</span><span class="s1">pairs</span><span class="s3">), </span><span class="s1">ks_tests</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pairwise_distances</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that the distribution of pairwise distances is close to correct.</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">514</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">random_ortho</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">):</span>
            <span class="s1">u</span><span class="s3">, </span><span class="s1">_s</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">svd</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">)))</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">v</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">dim </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">):</span>
            <span class="s2">def </span><span class="s1">generate_test_statistics</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s5">1e-10</span><span class="s3">):</span>
                <span class="s1">stats </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span>
                    <span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">((</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">) - </span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">))**</span><span class="s5">2</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">N</span><span class="s3">)</span>
                <span class="s3">])</span>
                <span class="s6"># Add a bit of noise to account for numeric accuracy.</span>
                <span class="s1">stats </span><span class="s3">+= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">stats</span>

            <span class="s1">expected </span><span class="s3">= </span><span class="s1">generate_test_statistics</span><span class="s3">(</span><span class="s1">random_ortho</span><span class="s3">)</span>
            <span class="s1">actual </span><span class="s3">= </span><span class="s1">generate_test_statistics</span><span class="s3">(</span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ortho_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">)</span>

            <span class="s1">_D</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">ks_2samp</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">actual</span><span class="s3">)</span>

            <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s5">.05</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestRandomCorrelation</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_reproducibility</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">eigs </span><span class="s3">= (</span><span class="s5">.5</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">, </span><span class="s5">1.2</span><span class="s3">, </span><span class="s5">1.5</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.</span><span class="s3">, -</span><span class="s5">0.184851</span><span class="s3">, </span><span class="s5">0.109017</span><span class="s3">, -</span><span class="s5">0.227494</span><span class="s3">],</span>
                             <span class="s3">[-</span><span class="s5">0.184851</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.231236</span><span class="s3">, </span><span class="s5">0.326669</span><span class="s3">],</span>
                             <span class="s3">[</span><span class="s5">0.109017</span><span class="s3">, </span><span class="s5">0.231236</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">, -</span><span class="s5">0.178912</span><span class="s3">],</span>
                             <span class="s3">[-</span><span class="s5">0.227494</span><span class="s3">, </span><span class="s5">0.326669</span><span class="s3">, -</span><span class="s5">0.178912</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_eigs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s4">'test'</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, [</span><span class="s5">2.5</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s3">],[</span><span class="s5">3</span><span class="s3">,</span><span class="s5">4</span><span class="s3">]])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, [</span><span class="s5">2.5</span><span class="s3">, -</span><span class="s5">.5</span><span class="s3">])</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">.1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_frozen_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eigs </span><span class="s3">= (</span><span class="s5">.5</span><span class="s3">, </span><span class="s5">.8</span><span class="s3">, </span><span class="s5">1.2</span><span class="s3">, </span><span class="s5">1.5</span><span class="s3">)</span>
        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">)</span>
        <span class="s1">frozen_seed </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>

        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs3 </span><span class="s3">= </span><span class="s1">frozen_seed</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_definition</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test the definition of a correlation matrix in several dimensions:</span>
        <span class="s6">#</span>
        <span class="s6"># 1. Det is product of eigenvalues (and positive by construction</span>
        <span class="s6">#    in examples)</span>
        <span class="s6"># 2. 1's on diagonal</span>
        <span class="s6"># 3. Matrix is symmetric</span>

        <span class="s2">def </span><span class="s1">norm</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">e</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">i</span><span class="s3">*</span><span class="s1">e</span><span class="s3">/</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span>

        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">123</span><span class="s3">)</span>

        <span class="s1">eigs </span><span class="s3">= [</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">i</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">)]</span>
        <span class="s1">eigs</span><span class="s3">.</span><span class="s1">append</span><span class="s3">([</span><span class="s5">4</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">])</span>

        <span class="s1">ones </span><span class="s3">= [[</span><span class="s5">1.</span><span class="s3">]*</span><span class="s1">len</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">eigs</span><span class="s3">]</span>
        <span class="s1">xs </span><span class="s3">= [</span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">eigs</span><span class="s3">]</span>

        <span class="s6"># Test that determinants are products of eigenvalues</span>
        <span class="s6">#   These are positive by construction</span>
        <span class="s6"># Could also test that the eigenvalues themselves are correct,</span>
        <span class="s6">#   but this seems sufficient.</span>
        <span class="s1">dets </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">fabs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">det</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">]</span>
        <span class="s1">dets_known </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">prod</span><span class="s3">(</span><span class="s1">e</span><span class="s3">) </span><span class="s2">for </span><span class="s1">e </span><span class="s2">in </span><span class="s1">eigs</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dets</span><span class="s3">, </span><span class="s1">dets_known</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

        <span class="s6"># Test for 1's on the diagonal</span>
        <span class="s1">diags </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">diags</span><span class="s3">, </span><span class="s1">ones</span><span class="s3">):</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

        <span class="s6"># Correlation matrices are symmetric</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_corr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Check some corner cases in to_corr</span>

        <span class="s6"># ajj == 1</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">_to_corr</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">]]))</span>

        <span class="s6"># Floating point overflow; fails to compute the correct</span>
        <span class="s6"># rotation, but should still produce some valid rotation</span>
        <span class="s6"># rather than infs/nans</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">over</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
            <span class="s1">g </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]])</span>

            <span class="s1">m0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1e300</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
            <span class="s1">m </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">_to_corr</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">g</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">).</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">g</span><span class="s3">))</span>

            <span class="s1">m0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.9</span><span class="s3">, </span><span class="s5">1e300</span><span class="s3">], [</span><span class="s5">1e300</span><span class="s3">, </span><span class="s5">1.1</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
            <span class="s1">m </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">_to_corr</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">g</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">).</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">g</span><span class="s3">))</span>

        <span class="s6"># Zero discriminant; should set the first diag entry to 1</span>
        <span class="s1">m0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">_to_corr</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>

        <span class="s6"># Slightly negative discriminant; should be approx correct still</span>
        <span class="s1">m0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2 </span><span class="s3">+ </span><span class="s5">1e-7</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">random_correlation</span><span class="s3">.</span><span class="s1">_to_corr</span><span class="s3">(</span><span class="s1">m0</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestUniformDirection</span><span class="s3">:</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;size&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, (</span><span class="s5">5</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_samples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">size</span><span class="s3">):</span>
        <span class="s6"># test that samples have correct shape and norm 1</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2777937887058094419</span><span class="s3">)</span>
        <span class="s1">uniform_direction_dist </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">uniform_direction_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">mean</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">expected_shape </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">).</span><span class="s1">shape</span>
        <span class="s2">assert </span><span class="s1">samples</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">expected_shape</span>
        <span class="s1">norms </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">norms</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s5">2.5</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_invalid_dim</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= (</span><span class="s4">&quot;Dimension of vector must be specified, &quot;</span>
                   <span class="s4">&quot;and must be an integer greater than 0.&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">uniform_direction</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen_distribution</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">frozen_seed </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>

        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs3 </span><span class="s3">= </span><span class="s1">frozen_seed</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs3</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">8</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_uniform</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">1036978481269651776</span><span class="s3">)</span>
        <span class="s1">spherical_dist </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s6"># generate random, orthogonal vectors</span>
        <span class="s1">v1</span><span class="s3">, </span><span class="s1">v2 </span><span class="s3">= </span><span class="s1">spherical_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">v2 </span><span class="s3">-= </span><span class="s1">v1 </span><span class="s3">@ </span><span class="s1">v2 </span><span class="s3">* </span><span class="s1">v1</span>
        <span class="s1">v2 </span><span class="s3">/= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">v2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">v1 </span><span class="s3">@ </span><span class="s1">v2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)  </span><span class="s6"># orthogonal</span>
        <span class="s6"># generate data and project onto orthogonal vectors</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">spherical_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">)</span>
        <span class="s1">s1 </span><span class="s3">= </span><span class="s1">samples </span><span class="s3">@ </span><span class="s1">v1</span>
        <span class="s1">s2 </span><span class="s3">= </span><span class="s1">samples </span><span class="s3">@ </span><span class="s1">v2</span>
        <span class="s1">angles </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan2</span><span class="s3">(</span><span class="s1">s1</span><span class="s3">, </span><span class="s1">s2</span><span class="s3">)</span>
        <span class="s6"># test that angles follow a uniform distribution</span>
        <span class="s6"># normalize angles to range [0, 1]</span>
        <span class="s1">angles </span><span class="s3">+= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span>
        <span class="s1">angles </span><span class="s3">/= </span><span class="s5">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span>
        <span class="s6"># perform KS test</span>
        <span class="s1">uniform_dist </span><span class="s3">= </span><span class="s1">uniform</span><span class="s3">()</span>
        <span class="s1">kstest_result </span><span class="s3">= </span><span class="s1">kstest</span><span class="s3">(</span><span class="s1">angles</span><span class="s3">, </span><span class="s1">uniform_dist</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">kstest_result</span><span class="s3">.</span><span class="s1">pvalue </span><span class="s3">&gt; </span><span class="s5">0.05</span>


<span class="s2">class </span><span class="s1">TestUnitaryGroup</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_reproducibility</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">0.308771</span><span class="s3">+</span><span class="s5">0.360312j</span><span class="s3">, </span><span class="s5">0.044021</span><span class="s3">+</span><span class="s5">0.622082j</span><span class="s3">, </span><span class="s5">0.160327</span><span class="s3">+</span><span class="s5">0.600173j</span><span class="s3">],</span>
             <span class="s3">[</span><span class="s5">0.732757</span><span class="s3">+</span><span class="s5">0.297107j</span><span class="s3">, </span><span class="s5">0.076692</span><span class="s3">-</span><span class="s5">0.4614j</span><span class="s3">, -</span><span class="s5">0.394349</span><span class="s3">+</span><span class="s5">0.022613j</span><span class="s3">],</span>
             <span class="s3">[-</span><span class="s5">0.148844</span><span class="s3">+</span><span class="s5">0.357037j</span><span class="s3">, -</span><span class="s5">0.284602</span><span class="s3">-</span><span class="s5">0.557949j</span><span class="s3">, </span><span class="s5">0.607051</span><span class="s3">+</span><span class="s5">0.299257j</span><span class="s3">]]</span>
        <span class="s3">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_dim</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">, </span><span class="s5">2.5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">unitary_group</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">frozen_seed </span><span class="s3">= </span><span class="s1">unitary_group</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>

        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs3 </span><span class="s3">= </span><span class="s1">frozen_seed</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unitarity</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">xs </span><span class="s3">= [</span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
              <span class="s2">for </span><span class="s1">dim </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">,</span><span class="s5">12</span><span class="s3">)</span>
              <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)]</span>

        <span class="s6"># Test that these are unitary matrices</span>
        <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">conj</span><span class="s3">().</span><span class="s1">T</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]), </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_haar</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test that the eigenvalues, which lie on the unit circle in</span>
        <span class="s6"># the complex plane, are uncorrelated.</span>

        <span class="s6"># Generate samples</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s5">1000  </span><span class="s6"># Not too many, or the test takes too long</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">514</span><span class="s3">)  </span><span class="s6"># Note that the test is sensitive to seed too</span>
        <span class="s1">xs </span><span class="s3">= </span><span class="s1">unitary_group</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">samples</span><span class="s3">)</span>

        <span class="s6"># The angles &quot;x&quot; of the eigenvalues should be uniformly distributed</span>
        <span class="s6"># Overall this seems to be a necessary but weak test of the distribution.</span>
        <span class="s1">eigs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigvals</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">xs</span><span class="s3">])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan2</span><span class="s3">(</span><span class="s1">eigs</span><span class="s3">.</span><span class="s1">imag</span><span class="s3">, </span><span class="s1">eigs</span><span class="s3">.</span><span class="s1">real</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">kstest</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">uniform</span><span class="s3">(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">, </span><span class="s5">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">).</span><span class="s1">cdf</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">pvalue </span><span class="s3">&gt; </span><span class="s5">0.05</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMultivariateT</span><span class="s3">:</span>

    <span class="s6"># These tests were created by running vpa(mvtpdf(...)) in MATLAB. The</span>
    <span class="s6"># function takes no `mu` parameter. The tests were run as</span>
    <span class="s6">#</span>
    <span class="s6"># &gt;&gt; ans = vpa(mvtpdf(x - mu, shape, df));</span>
    <span class="s6">#</span>
    <span class="s1">PDF_TESTS </span><span class="s3">= [(</span>
        <span class="s6"># x</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
        <span class="s3">],</span>
        <span class="s6"># loc</span>
        <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
        <span class="s6"># shape</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s3">],</span>
        <span class="s6"># df</span>
        <span class="s5">4</span><span class="s3">,</span>
        <span class="s6"># ans</span>
        <span class="s3">[</span>
            <span class="s5">0.013972450422333741737457302178882</span><span class="s3">,</span>
            <span class="s5">0.0010998721906793330026219646100571</span><span class="s3">,</span>
            <span class="s5">0.013972450422333741737457302178882</span><span class="s3">,</span>
            <span class="s5">0.00073682844024025606101402363634634</span><span class="s3">,</span>
            <span class="s5">0.0010998721906793330026219646100571</span><span class="s3">,</span>
            <span class="s5">0.0010998721906793330026219646100571</span><span class="s3">,</span>
            <span class="s5">0.0020732579600816823488240725481546</span><span class="s3">,</span>
            <span class="s5">0.00095660371505271429414668515889275</span><span class="s3">,</span>
            <span class="s5">0.00021831953784896498569831346792114</span><span class="s3">,</span>
            <span class="s5">0.00037725616140301147447000396084604</span>
        <span class="s3">]</span>

    <span class="s3">), (</span>
        <span class="s6"># x</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">0.9718</span><span class="s3">, </span><span class="s5">0.1298</span><span class="s3">, </span><span class="s5">0.8134</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.4922</span><span class="s3">, </span><span class="s5">0.5522</span><span class="s3">, </span><span class="s5">0.7185</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.3010</span><span class="s3">, </span><span class="s5">0.1491</span><span class="s3">, </span><span class="s5">0.5008</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.5971</span><span class="s3">, </span><span class="s5">0.2585</span><span class="s3">, </span><span class="s5">0.8940</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.5434</span><span class="s3">, </span><span class="s5">0.5287</span><span class="s3">, </span><span class="s5">0.9507</span><span class="s3">],</span>
        <span class="s3">],</span>
        <span class="s6"># loc</span>
        <span class="s3">[-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">50</span><span class="s3">],</span>
        <span class="s6"># shape</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">1.0000</span><span class="s3">, </span><span class="s5">0.5000</span><span class="s3">, </span><span class="s5">0.2500</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.5000</span><span class="s3">, </span><span class="s5">1.0000</span><span class="s3">, -</span><span class="s5">0.1000</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.2500</span><span class="s3">, -</span><span class="s5">0.1000</span><span class="s3">, </span><span class="s5">1.0000</span><span class="s3">],</span>
        <span class="s3">],</span>
        <span class="s6"># df</span>
        <span class="s5">8</span><span class="s3">,</span>
        <span class="s6"># ans</span>
        <span class="s3">[</span>
            <span class="s5">0.00000000000000069609279697467772867405511133763</span><span class="s3">,</span>
            <span class="s5">0.00000000000000073700739052207366474839369535934</span><span class="s3">,</span>
            <span class="s5">0.00000000000000069522909962669171512174435447027</span><span class="s3">,</span>
            <span class="s5">0.00000000000000074212293557998314091880208889767</span><span class="s3">,</span>
            <span class="s5">0.00000000000000077039675154022118593323030449058</span><span class="s3">,</span>
        <span class="s3">]</span>
    <span class="s3">)]</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x, loc, shape, df, ans&quot;</span><span class="s3">, </span><span class="s1">PDF_TESTS</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_pdf_correctness</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">ans</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">ans</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;x, loc, shape, df, ans&quot;</span><span class="s3">, </span><span class="s1">PDF_TESTS</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_logpdf_correct</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">ans</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">val1 </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">val2 </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">val1</span><span class="s3">), </span><span class="s1">val2</span><span class="s3">)</span>

    <span class="s6"># https://github.com/scipy/scipy/issues/10042#issuecomment-576795195</span>
    <span class="s2">def </span><span class="s1">test_mvt_with_df_one_is_cauchy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= [</span><span class="s5">9</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, -</span><span class="s5">3</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">3</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">val </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">ans </span><span class="s3">= </span><span class="s1">cauchy</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">val</span><span class="s3">, </span><span class="s1">ans</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mvt_with_high_df_is_approx_normal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># `normaltest` returns the chi-squared statistic and the associated</span>
        <span class="s6"># p-value. The null hypothesis is that `x` came from a normal</span>
        <span class="s6"># distribution, so a low p-value represents rejecting the null, i.e.</span>
        <span class="s6"># that it is unlikely that `x` came a normal distribution.</span>
        <span class="s1">P_VAL_MIN </span><span class="s3">= </span><span class="s5">0.1</span>

        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s5">100000</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100000</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">normaltest</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">p </span><span class="s3">&gt; </span><span class="s1">P_VAL_MIN</span><span class="s3">)</span>

        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">([-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [[</span><span class="s5">10</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]], </span><span class="s1">df</span><span class="s3">=</span><span class="s5">100000</span><span class="s3">,</span>
                              <span class="s1">seed</span><span class="s3">=</span><span class="s5">42</span><span class="s3">)</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">100000</span><span class="s3">)</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">p </span><span class="s3">= </span><span class="s1">normaltest</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">((</span><span class="s1">p </span><span class="s3">&gt; </span><span class="s1">P_VAL_MIN</span><span class="s3">).</span><span class="s1">all</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">patch</span><span class="s3">(</span><span class="s4">'scipy.stats.multivariate_normal._logpdf'</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_mvt_with_inf_df_calls_normal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mock</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">7</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, </span><span class="s1">multivariate_normal_frozen</span><span class="s3">)</span>
        <span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">call_count </span><span class="s3">== </span><span class="s5">1</span>
        <span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">mock</span><span class="s3">.</span><span class="s1">call_count </span><span class="s3">== </span><span class="s5">2</span>

    <span class="s2">def </span><span class="s1">test_shape_correctness</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># pdf and logpdf should return scalar when the</span>
        <span class="s6"># number of samples in x is one.</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">shape </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">4.5</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">).</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">).</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

        <span class="s6"># pdf() and logpdf() should return probabilities of shape</span>
        <span class="s6"># (n_samples,) when x has n_samples.</span>
        <span class="s1">n_samples </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">).</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">,))</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">).</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_samples</span><span class="s3">,))</span>

        <span class="s6"># rvs() should return scalar unless a size argument is applied.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s5">1</span><span class="s3">).</span><span class="s1">rvs</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isscalar</span><span class="s3">(</span><span class="s1">res</span><span class="s3">)</span>

        <span class="s6"># rvs() should return vector of shape (size,) if size argument</span>
        <span class="s6"># is applied.</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s5">7</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s5">1</span><span class="s3">).</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">size</span><span class="s3">,))</span>

    <span class="s2">def </span><span class="s1">test_default_arguments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">()</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, [[</span><span class="s5">1</span><span class="s3">]])</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">df </span><span class="s3">== </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s1">DEFAULT_ARGS_TESTS </span><span class="s3">= [</span>
        <span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">7</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">None</span><span class="s3">, [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s2">None</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s5">1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s2">None</span><span class="s3">, [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s5">7</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s5">7</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s5">1</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], </span><span class="s2">None</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s5">7</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s2">None</span><span class="s3">, [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s5">1</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s5">7</span><span class="s3">, [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">7</span><span class="s3">]], </span><span class="s5">7</span><span class="s3">)</span>
    <span class="s3">]</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;loc, shape, df, loc_ans, shape_ans, df_ans&quot;</span><span class="s3">,</span>
                             <span class="s1">DEFAULT_ARGS_TESTS</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_default_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">loc_ans</span><span class="s3">, </span><span class="s1">shape_ans</span><span class="s3">, </span><span class="s1">df_ans</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">loc_ans</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">shape_ans</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">df </span><span class="s3">== </span><span class="s1">df_ans</span><span class="s3">)</span>

    <span class="s1">ARGS_SHAPES_TESTS </span><span class="s3">= [</span>
        <span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, [-</span><span class="s5">1</span><span class="s3">], [[</span><span class="s5">2</span><span class="s3">]], </span><span class="s5">3</span><span class="s3">),</span>
        <span class="s3">([-</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">], </span><span class="s5">3</span><span class="s3">, [-</span><span class="s5">1</span><span class="s3">], [[</span><span class="s5">2</span><span class="s3">]], </span><span class="s5">3</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">1</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">]), </span><span class="s5">3</span><span class="s3">, [-</span><span class="s5">1</span><span class="s3">], [[</span><span class="s5">2</span><span class="s3">]], </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s3">]</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;loc, shape, df, loc_ans, shape_ans, df_ans&quot;</span><span class="s3">,</span>
                             <span class="s1">ARGS_SHAPES_TESTS</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_scalar_list_and_ndarray_arguments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">loc_ans</span><span class="s3">,</span>
                                               <span class="s1">shape_ans</span><span class="s3">, </span><span class="s1">df_ans</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">loc_ans</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">shape_ans</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">df</span><span class="s3">, </span><span class="s1">df_ans</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_argument_error_handling</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># `loc` should be a one-dimensional vector.</span>
        <span class="s1">loc </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">,</span>
                      <span class="s1">multivariate_t</span><span class="s3">,</span>
                      <span class="s3">**</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">))</span>

        <span class="s6"># `shape` should be scalar or square matrix.</span>
        <span class="s1">shape </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">,</span>
                      <span class="s1">multivariate_t</span><span class="s3">,</span>
                      <span class="s3">**</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">))</span>

        <span class="s6"># `df` should be greater than zero.</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">shape </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= -</span><span class="s5">1</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">,</span>
                      <span class="s1">multivariate_t</span><span class="s3">,</span>
                      <span class="s3">**</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">))</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">,</span>
                      <span class="s1">multivariate_t</span><span class="s3">,</span>
                      <span class="s3">**</span><span class="s1">dict</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_reproducibility</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">shape </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">dist1 </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">dist2 </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">samples1 </span><span class="s3">= </span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">samples2 </span><span class="s3">= </span><span class="s1">dist2</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">samples1</span><span class="s3">, </span><span class="s1">samples2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_allow_singular</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Make shape singular and verify error was raised.</span>
        <span class="s1">args </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">], </span><span class="s1">shape</span><span class="s3">=[[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">0</span><span class="s3">],[</span><span class="s5">0</span><span class="s3">,</span><span class="s5">1</span><span class="s3">]], </span><span class="s1">df</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">LinAlgError</span><span class="s3">, </span><span class="s1">multivariate_t</span><span class="s3">, **</span><span class="s1">args</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;size&quot;</span><span class="s3">, [(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), (</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;df&quot;</span><span class="s3">, [</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">2.</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_rvs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">size</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">size </span><span class="s3">+ (</span><span class="s1">dim</span><span class="s3">, )</span>

    <span class="s2">def </span><span class="s1">test_cdf_signs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># check that sign of output is correct when np.any(lower &gt; x)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">10</span>
        <span class="s1">b </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]</span>
        <span class="s1">a </span><span class="s3">= [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]</span>
        <span class="s6"># when odd number of elements of b &lt; a, output is negative</span>
        <span class="s1">expected_signs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">cdf </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdf</span><span class="s3">, </span><span class="s1">cdf</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]*</span><span class="s1">expected_signs</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'dim'</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_cdf_against_multivariate_normal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s6"># Check accuracy against MVN randomly-generated cases</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cdf_against_mvn_test</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'dim'</span><span class="s3">, [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">9</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_cdf_against_multivariate_normal_singular</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s6"># Check accuracy against MVN for randomly-generated singular cases</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">cdf_against_mvn_test</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">cdf_against_mvn_test</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">singular</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s6"># Check for accuracy in the limit that df -&gt; oo and MVT -&gt; MVN</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">413722918996573</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">3</span>

        <span class="s1">w </span><span class="s3">= </span><span class="s5">10</span><span class="s3">**</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">_random_covariance</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">, </span><span class="s1">singular</span><span class="s3">)</span>

        <span class="s1">mean </span><span class="s3">= </span><span class="s5">10</span><span class="s3">**</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">a </span><span class="s3">= -</span><span class="s5">10</span><span class="s3">**</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">)) + </span><span class="s1">mean</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s5">10</span><span class="s3">**</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">)) + </span><span class="s1">mean</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">,</span>
                                       <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                                            <span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">5e-4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdf_against_univariate_t</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">413722918996573</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s5">2</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">))</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">3</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
                                       <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">))</span>
        <span class="s1">incorrect </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">))</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">5e-4</span><span class="s3">)  </span><span class="s6"># close to t</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">res </span><span class="s3">- </span><span class="s1">incorrect</span><span class="s3">) &gt; </span><span class="s5">1e-3</span><span class="s3">)  </span><span class="s6"># not close to normal</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;seed&quot;</span><span class="s3">, [</span><span class="s5">3363958638</span><span class="s3">, </span><span class="s5">7891119608</span><span class="s3">, </span><span class="s5">3887698049</span><span class="s3">,</span>
                                      <span class="s5">5013150848</span><span class="s3">, </span><span class="s5">1495033423</span><span class="s3">, </span><span class="s5">6170824608</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;singular&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_cdf_against_qsimvtv</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">, </span><span class="s1">singular</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">singular </span><span class="s2">and </span><span class="s1">seed </span><span class="s3">!= </span><span class="s5">3363958638</span><span class="s3">:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">'Agreement with qsimvtv is not great in singular case'</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s5">10</span><span class="s3">**</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">_random_covariance</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">, </span><span class="s1">singular</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= -</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() * </span><span class="s5">5</span>

        <span class="s6"># no lower limit</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">,</span>
                                       <span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
            <span class="s1">ref </span><span class="s3">= </span><span class="s1">_qsimvtv</span><span class="s3">(</span><span class="s5">20000</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">*</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">- </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">2e-4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

        <span class="s6"># with lower limit</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">,</span>
                                       <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">, </span><span class="s1">allow_singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">invalid</span><span class="s3">=</span><span class="s4">'ignore'</span><span class="s3">):</span>
            <span class="s1">ref </span><span class="s3">= </span><span class="s1">_qsimvtv</span><span class="s3">(</span><span class="s5">20000</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">a </span><span class="s3">- </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">b </span><span class="s3">- </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_cdf_against_generic_integrators</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Compare result against generic numerical integrators</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">3</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">41372291899657</span><span class="s3">)</span>
        <span class="s1">w </span><span class="s3">= </span><span class="s5">10 </span><span class="s3">** </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">_random_covariance</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">, </span><span class="s1">singular</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= -</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() * </span><span class="s5">5</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">,</span>
                                       <span class="s1">lower_limit</span><span class="s3">=</span><span class="s1">a</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">integrand</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s1">ref </span><span class="s3">= </span><span class="s1">qmc_quad</span><span class="s3">(</span><span class="s1">integrand</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">qrng</span><span class="s3">=</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">qmc</span><span class="s3">.</span><span class="s1">Halton</span><span class="s3">(</span><span class="s1">d</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">integrand</span><span class="s3">(*</span><span class="s1">zyx</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">zyx</span><span class="s3">[::-</span><span class="s5">1</span><span class="s3">], </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s1">ref </span><span class="s3">= </span><span class="s1">tplquad</span><span class="s3">(</span><span class="s1">integrand</span><span class="s3">, </span><span class="s1">a</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">a</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">a</span><span class="s3">[</span><span class="s5">2</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[</span><span class="s5">2</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_against_matlab</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Test against matlab mvtcdf:</span>
        <span class="s6"># C = [6.21786909  0.2333667 7.95506077;</span>
        <span class="s6">#      0.2333667 29.67390923 16.53946426;</span>
        <span class="s6">#      7.95506077 16.53946426 19.17725252]</span>
        <span class="s6"># df = 1.9559939787727658</span>
        <span class="s6"># mvtcdf([0, 0, 0], C, df)  % 0.2523</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2967390923</span><span class="s3">)</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[ </span><span class="s5">6.21786909</span><span class="s3">,  </span><span class="s5">0.2333667 </span><span class="s3">,  </span><span class="s5">7.95506077</span><span class="s3">],</span>
                        <span class="s3">[ </span><span class="s5">0.2333667 </span><span class="s3">, </span><span class="s5">29.67390923</span><span class="s3">, </span><span class="s5">16.53946426</span><span class="s3">],</span>
                        <span class="s3">[ </span><span class="s5">7.95506077</span><span class="s3">, </span><span class="s5">16.53946426</span><span class="s3">, </span><span class="s5">19.17725252</span><span class="s3">]])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">1.9559939787727658</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s5">0.2523</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">seed </span><span class="s3">= </span><span class="s5">4137229573</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">3</span><span class="s3">) + </span><span class="s1">loc</span>
        <span class="s1">shape </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">()</span>
        <span class="s1">args </span><span class="s3">= (</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s1">rng_frozen </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">rng_unfrozen </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng_frozen</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">),</span>
                     <span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng_unfrozen</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_vectorized</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">4</span>
        <span class="s1">n </span><span class="s3">= (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">413722918996573</span><span class="s3">)</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">A </span><span class="s3">@ </span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">n </span><span class="s3">+ (</span><span class="s1">dim</span><span class="s3">,))</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() * </span><span class="s5">5</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">_cdf_1d</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_qsimvtv</span><span class="s3">(</span><span class="s5">10000</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">*</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">-</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">rng</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">apply_along_axis</span><span class="s3">(</span><span class="s1">_cdf_1d</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">1e-4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_against_analytical</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">413722918996573</span><span class="s3">)</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">toeplitz</span><span class="s3">(</span><span class="s1">c</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">] + [</span><span class="s5">0.5</span><span class="s3">] * (</span><span class="s1">dim </span><span class="s3">- </span><span class="s5">1</span><span class="s3">))</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">A</span><span class="s3">).</span><span class="s1">cdf</span><span class="s3">([</span><span class="s5">0</span><span class="s3">] * </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s5">1 </span><span class="s3">/ (</span><span class="s1">dim </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">5e-5</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_entropy_inf_df</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
        <span class="s1">mvt_entropy </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">mvn_entropy </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">mvt_entropy </span><span class="s3">== </span><span class="s1">mvn_entropy</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;df&quot;</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_entropy_1d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">mvt_entropy </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s5">1.</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">t_entropy </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">t</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mvt_entropy</span><span class="s3">, </span><span class="s1">t_entropy</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

    <span class="s6"># entropy reference values were computed via numerical integration</span>
    <span class="s6">#</span>
    <span class="s6"># def integrand(x, y, mvt):</span>
    <span class="s6">#     vec = np.array([x, y])</span>
    <span class="s6">#     return mvt.logpdf(vec) * mvt.pdf(vec)</span>

    <span class="s6"># def multivariate_t_entropy_quad_2d(df, cov):</span>
    <span class="s6">#     dim = cov.shape[0]</span>
    <span class="s6">#     loc = np.zeros((dim, ))</span>
    <span class="s6">#     mvt = stats.multivariate_t(loc, cov, df)</span>
    <span class="s6">#     limit = 100</span>
    <span class="s6">#     return -integrate.dblquad(integrand, -limit, limit, -limit, limit,</span>
    <span class="s6">#                               args=(mvt, ))[0]</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;df, cov, ref, tol&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s5">3.0378770664093313</span><span class="s3">, </span><span class="s5">1e-14</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">100</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]]),</span>
                               <span class="s5">3.55102424550609</span><span class="s3">, </span><span class="s5">1e-8</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_entropy_vs_numerical_integration</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">):</span>
        <span class="s1">loc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, ))</span>
        <span class="s1">mvt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mvt</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;df, dim, ref, tol&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.5212624929756808</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.4289633653182439</span><span class="s3">, </span><span class="s5">1e-13</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">500</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.420939531869349</span><span class="s3">, </span><span class="s5">1e-14</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1e20</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.4189385332046727</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1e100</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.4189385332046727</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">15.069150450832911</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">14.19936546446673</span><span class="s3">, </span><span class="s5">1e-13</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1e20</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">14.189385332046728</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1e100</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">14.189385332046728</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">148.28902883192654</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">141.99155538003762</span><span class="s3">, </span><span class="s5">1e-14</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1e20</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">141.8938533204673</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
            <span class="s3">(</span><span class="s5">1e100</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">141.8938533204673</span><span class="s3">, </span><span class="s5">1e-15</span><span class="s3">),</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_extreme_entropy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">):</span>
        <span class="s6"># Reference values were calculated with mpmath:</span>
        <span class="s6"># from mpmath import mp</span>
        <span class="s6"># mp.dps = 500</span>
        <span class="s6">#</span>
        <span class="s6"># def mul_t_mpmath_entropy(dim, df=1):</span>
        <span class="s6">#     dim = mp.mpf(dim)</span>
        <span class="s6">#     df = mp.mpf(df)</span>
        <span class="s6">#     halfsum = (dim + df)/2</span>
        <span class="s6">#     half_df = df/2</span>
        <span class="s6">#</span>
        <span class="s6">#     return float(</span>
        <span class="s6">#         -mp.loggamma(halfsum) + mp.loggamma(half_df)</span>
        <span class="s6">#         + dim / 2 * mp.log(df * mp.pi)</span>
        <span class="s6">#         + halfsum * (mp.digamma(halfsum) - mp.digamma(half_df))</span>
        <span class="s6">#         + 0.0</span>
        <span class="s6">#     )</span>
        <span class="s1">mvt </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mvt</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_entropy_with_covariance</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># Generated using np.randn(5, 5) and then rounding</span>
        <span class="s6"># to two decimal places</span>
        <span class="s1">_A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span>
            <span class="s3">[</span><span class="s5">1.42</span><span class="s3">, </span><span class="s5">0.09</span><span class="s3">, -</span><span class="s5">0.49</span><span class="s3">, </span><span class="s5">0.17</span><span class="s3">, </span><span class="s5">0.74</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s5">1.13</span><span class="s3">, -</span><span class="s5">0.01</span><span class="s3">,  </span><span class="s5">0.71</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, -</span><span class="s5">0.56</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">1.07</span><span class="s3">, </span><span class="s5">0.44</span><span class="s3">, -</span><span class="s5">0.28</span><span class="s3">, -</span><span class="s5">0.44</span><span class="s3">, </span><span class="s5">0.29</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s5">1.5</span><span class="s3">, -</span><span class="s5">0.94</span><span class="s3">, -</span><span class="s5">0.67</span><span class="s3">, </span><span class="s5">0.73</span><span class="s3">, -</span><span class="s5">1.1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">0.17</span><span class="s3">, -</span><span class="s5">0.08</span><span class="s3">, </span><span class="s5">1.46</span><span class="s3">, -</span><span class="s5">0.32</span><span class="s3">, </span><span class="s5">1.36</span><span class="s3">]</span>
        <span class="s3">])</span>
        <span class="s6"># Set cov to be a symmetric positive semi-definite matrix</span>
        <span class="s1">cov </span><span class="s3">= </span><span class="s1">_A </span><span class="s3">@ </span><span class="s1">_A</span><span class="s3">.</span><span class="s1">T</span>

        <span class="s6"># Test the asymptotic case. For large degrees of freedom</span>
        <span class="s6"># the entropy approaches the multivariate normal entropy.</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s5">1e20</span>
        <span class="s1">mul_t_entropy </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">mul_norm_entropy </span><span class="s3">= </span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">).</span><span class="s1">entropy</span><span class="s3">()</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mul_t_entropy</span><span class="s3">, </span><span class="s1">mul_norm_entropy</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

        <span class="s6"># Test the regular case. For a dim of 5 the threshold comes out</span>
        <span class="s6"># to be approximately 766.45. So using slightly</span>
        <span class="s6"># different dfs on each site of the threshold, the entropies</span>
        <span class="s6"># are being compared.</span>
        <span class="s1">df1 </span><span class="s3">= </span><span class="s5">765</span>
        <span class="s1">df2 </span><span class="s3">= </span><span class="s5">768</span>
        <span class="s1">_entropy1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df1</span><span class="s3">)</span>
        <span class="s1">_entropy2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">multivariate_t</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">df</span><span class="s3">=</span><span class="s1">df2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">_entropy1</span><span class="s3">, </span><span class="s1">_entropy2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-5</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestMultivariateHypergeom</span><span class="s3">:</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;x, m, n, expected&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s6"># Ground truth value from R dmvhyper</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">7</span><span class="s3">, -</span><span class="s5">1.119814</span><span class="s3">),</span>
            <span class="s6"># test for `n=0`</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">0</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">),</span>
            <span class="s6"># test for `x &lt; 0`</span>
            <span class="s3">([-</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">7</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">),</span>
            <span class="s6"># test for `m &lt; 0` (RuntimeWarning issue)</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [-</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">7</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">),</span>
            <span class="s6"># test for all `m &lt; 0` and `x.sum() != n`</span>
            <span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]], [[-</span><span class="s5">4</span><span class="s3">, -</span><span class="s5">6</span><span class="s3">], [-</span><span class="s5">5</span><span class="s3">, -</span><span class="s5">10</span><span class="s3">]],</span>
             <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]),</span>
            <span class="s6"># test for `x &lt; 0` and `m &lt; 0` (RuntimeWarning issue)</span>
            <span class="s3">([-</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [-</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">),</span>
            <span class="s6"># test for `x &gt; m`</span>
            <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s5">12</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">),</span>
            <span class="s6"># test for `m &lt; 0` (RuntimeWarning issue)</span>
            <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], </span><span class="s5">12</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">),</span>
            <span class="s6"># test for `n &lt; 0`</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], -</span><span class="s5">7</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">),</span>
            <span class="s6"># test for `x.sum() != n`</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">7</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_logpmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">vals </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-6</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_reduces_hypergeom</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test that the multivariate_hypergeom pmf reduces to the</span>
        <span class="s6"># hypergeom pmf in the 2d case.</span>
        <span class="s1">val1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">m</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">val2 </span><span class="s3">= </span><span class="s1">hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">k</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">M</span><span class="s3">=</span><span class="s5">15</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val1</span><span class="s3">, </span><span class="s1">val2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">val1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">=[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">m</span><span class="s3">=[</span><span class="s5">15</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">val2 </span><span class="s3">= </span><span class="s1">hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">k</span><span class="s3">=</span><span class="s5">7</span><span class="s3">, </span><span class="s1">M</span><span class="s3">=</span><span class="s5">25</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s5">15</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">val1</span><span class="s3">, </span><span class="s1">val2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_rvs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test if `rvs` is unbiased and large sample size converges</span>
        <span class="s6"># to the true mean.</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_rvs_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">9</span><span class="s3">])</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">123</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'m, n'</span><span class="s3">, (</span>
        <span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">5</span><span class="s3">), ([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">),</span>
        <span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">), ([</span><span class="s5">0</span><span class="s3">], </span><span class="s5">0</span><span class="s3">)</span>
    <span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_gh16171</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">res_ex </span><span class="s3">= </span><span class="s1">m</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">res_ex</span><span class="s3">[</span><span class="s1">m </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">] = </span><span class="s1">n</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">res_ex</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;x, m, n, expected&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">([</span><span class="s5">5</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">], </span><span class="s5">5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">),</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s5">7</span><span class="s3">, </span><span class="s5">0.3263403</span><span class="s3">),</span>
            <span class="s6"># Ground truth value from R dmvhyper</span>
            <span class="s3">([[[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">8</span><span class="s3">]], [[-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">9</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]],</span>
             <span class="s3">[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], [[</span><span class="s5">8</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]],</span>
             <span class="s3">[[</span><span class="s5">0.3916084</span><span class="s3">, </span><span class="s5">0.006993007</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.4761905</span><span class="s3">]]),</span>
            <span class="s6"># test with empty arrays.</span>
            <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">), </span><span class="s5">0</span><span class="s3">, []),</span>
            <span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s5">5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">),</span>
            <span class="s6"># Ground truth value from R dmvhyper</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], </span><span class="s5">6</span><span class="s3">, </span><span class="s5">0.01077354</span><span class="s3">)</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_pmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">vals </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s4">&quot;x, m, n, expected&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">]], </span><span class="s5">7</span><span class="s3">, [</span><span class="s5">0.3263403</span><span class="s3">, </span><span class="s5">0.3407531</span><span class="s3">]),</span>
            <span class="s3">([[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">]], [[</span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
            <span class="s3">([[[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">]]], [[</span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]]),</span>
            <span class="s3">([[</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">]], [[[[</span><span class="s5">3</span><span class="s3">]]]], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [[[</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]]])</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_pmf_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s1">vals </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vals</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">12</span><span class="s3">)</span>
        <span class="s1">cov2 </span><span class="s3">= [[</span><span class="s5">0.64421053</span><span class="s3">, -</span><span class="s5">0.26526316</span><span class="s3">, -</span><span class="s5">0.37894737</span><span class="s3">],</span>
                <span class="s3">[-</span><span class="s5">0.26526316</span><span class="s3">, </span><span class="s5">1.14947368</span><span class="s3">, -</span><span class="s5">0.88421053</span><span class="s3">],</span>
                <span class="s3">[-</span><span class="s5">0.37894737</span><span class="s3">, -</span><span class="s5">0.88421053</span><span class="s3">, </span><span class="s5">1.26315789</span><span class="s3">]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov1</span><span class="s3">, </span><span class="s1">cov2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cov_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">9</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">8</span><span class="s3">, </span><span class="s5">12</span><span class="s3">])</span>
        <span class="s1">cov2 </span><span class="s3">= [[[</span><span class="s5">1.05</span><span class="s3">, -</span><span class="s5">1.05</span><span class="s3">], [-</span><span class="s5">1.05</span><span class="s3">, </span><span class="s5">1.05</span><span class="s3">]],</span>
                <span class="s3">[[</span><span class="s5">1.56</span><span class="s3">, -</span><span class="s5">1.56</span><span class="s3">], [-</span><span class="s5">1.56</span><span class="s3">, </span><span class="s5">1.56</span><span class="s3">]]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov1</span><span class="s3">, </span><span class="s1">cov2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">cov3 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">4</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
        <span class="s1">cov4 </span><span class="s3">= [[[</span><span class="s5">0.</span><span class="s3">]], [[</span><span class="s5">0.</span><span class="s3">]]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov3</span><span class="s3">, </span><span class="s1">cov4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">cov5 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">7</span><span class="s3">, </span><span class="s5">9</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">8</span><span class="s3">, </span><span class="s5">12</span><span class="s3">])</span>
        <span class="s1">cov6 </span><span class="s3">= [[[</span><span class="s5">1.05</span><span class="s3">, -</span><span class="s5">1.05</span><span class="s3">], [-</span><span class="s5">1.05</span><span class="s3">, </span><span class="s5">1.05</span><span class="s3">]],</span>
                <span class="s3">[[</span><span class="s5">0.7875</span><span class="s3">, -</span><span class="s5">0.7875</span><span class="s3">], [-</span><span class="s5">0.7875</span><span class="s3">, </span><span class="s5">0.7875</span><span class="s3">]]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov5</span><span class="s3">, </span><span class="s1">cov6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_var</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test with hypergeom</span>
        <span class="s1">var0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">var1 </span><span class="s3">= </span><span class="s1">hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">M</span><span class="s3">=</span><span class="s5">15</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var0</span><span class="s3">, </span><span class="s1">var1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_var_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">var0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">8</span><span class="s3">])</span>
        <span class="s1">var1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">var2 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">8</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var0</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">var1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var0</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">var2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">var3 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">14</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">8</span><span class="s3">])</span>
        <span class="s1">var4 </span><span class="s3">= [[</span><span class="s5">0.6984127</span><span class="s3">, </span><span class="s5">0.6984127</span><span class="s3">], [</span><span class="s5">1.352657</span><span class="s3">, </span><span class="s5">1.352657</span><span class="s3">]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var3</span><span class="s3">, </span><span class="s1">var4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">var5 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">5</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">])</span>
        <span class="s1">var6 </span><span class="s3">= [[</span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var5</span><span class="s3">, </span><span class="s1">var6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test with hypergeom</span>
        <span class="s1">mean0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">mean1 </span><span class="s3">= </span><span class="s1">hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">M</span><span class="s3">=</span><span class="s5">15</span><span class="s3">, </span><span class="s1">n</span><span class="s3">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">N</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean0</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">mean1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

        <span class="s1">mean2 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">12</span><span class="s3">, </span><span class="s5">8</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">mean3 </span><span class="s3">= [</span><span class="s5">12.</span><span class="s3">*</span><span class="s5">10.</span><span class="s3">/</span><span class="s5">20.</span><span class="s3">, </span><span class="s5">8.</span><span class="s3">*</span><span class="s5">10.</span><span class="s3">/</span><span class="s5">20.</span><span class="s3">]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean2</span><span class="s3">, </span><span class="s1">mean3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mean_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mean0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">8</span><span class="s3">])</span>
        <span class="s1">mean1 </span><span class="s3">= [[</span><span class="s5">3.</span><span class="s3">*</span><span class="s5">4.</span><span class="s3">/</span><span class="s5">8.</span><span class="s3">, </span><span class="s5">5.</span><span class="s3">*</span><span class="s5">4.</span><span class="s3">/</span><span class="s5">8.</span><span class="s3">], [</span><span class="s5">10.</span><span class="s3">*</span><span class="s5">8.</span><span class="s3">/</span><span class="s5">15.</span><span class="s3">, </span><span class="s5">5.</span><span class="s3">*</span><span class="s5">8.</span><span class="s3">/</span><span class="s5">15.</span><span class="s3">]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean0</span><span class="s3">, </span><span class="s1">mean1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-8</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_mean_edge_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mean0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mean0</span><span class="s3">, [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>

        <span class="s1">mean1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mean1</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>

        <span class="s1">mean2 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mean2</span><span class="s3">, [[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">], [</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]],</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-17</span><span class="s3">)</span>

        <span class="s1">mean3 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">), </span><span class="s1">n</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">mean3</span><span class="s3">, [])</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">mean3</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">, ))</span>

    <span class="s2">def </span><span class="s1">test_var_edge_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">var0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var0</span><span class="s3">, [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-16</span><span class="s3">)</span>

        <span class="s1">var1 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">var1</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">])</span>

        <span class="s1">var2 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">var2</span><span class="s3">, [[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]],</span>
                        <span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-17</span><span class="s3">)</span>

        <span class="s1">var3 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">), </span><span class="s1">n</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">var3</span><span class="s3">, [])</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">var3</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">, ))</span>

    <span class="s2">def </span><span class="s1">test_cov_edge_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">cov0 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">cov1 </span><span class="s3">= [[</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]]</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov0</span><span class="s3">, </span><span class="s1">cov1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-17</span><span class="s3">)</span>

        <span class="s1">cov3 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">n</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">cov4 </span><span class="s3">= [[</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">], [</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cov3</span><span class="s3">, </span><span class="s1">cov4</span><span class="s3">)</span>

        <span class="s1">cov5 </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">), </span><span class="s1">n</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">cov6 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov5</span><span class="s3">, </span><span class="s1">cov6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-17</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">cov5</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># The frozen distribution should agree with the regular one</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">seed</span><span class="s3">(</span><span class="s5">1234</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">12</span>
        <span class="s1">m </span><span class="s3">= [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">11</span><span class="s3">, </span><span class="s5">13</span><span class="s3">]</span>
        <span class="s1">x </span><span class="s3">= [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">12</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">11</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">],</span>
             <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">9</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">8</span><span class="s3">]]</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">int</span><span class="s3">)</span>
        <span class="s1">mhg_frozen </span><span class="s3">= </span><span class="s1">multivariate_hypergeom</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mhg_frozen</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">),</span>
                        <span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mhg_frozen</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">),</span>
                        <span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mhg_frozen</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mhg_frozen</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(), </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_invalid_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, [</span><span class="s5">10</span><span class="s3">], </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">, [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">], </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">, [</span><span class="s5">5.5</span><span class="s3">, </span><span class="s5">4.5</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">], </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">, [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">10.5</span><span class="s3">, </span><span class="s5">15.5</span><span class="s3">], </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">multivariate_hypergeom</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">, [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">4</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">], </span><span class="s5">5.5</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestRandomTable</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">get_rng</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">628174795866951638</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_process_parameters</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`row` must be one-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`col` must be one-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;each element of `row` must be non-negative&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;each element of `col` must be non-negative&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;sums over `row` and `col` must be equal&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;each element of `row` must be an integer&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([</span><span class="s5">2.1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;each element of `col` must be an integer&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">1.1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>

        <span class="s1">row </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">r</span><span class="s3">, </span><span class="s1">c</span><span class="s3">, </span><span class="s1">n </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">_process_parameters</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">r</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">col</span><span class="s3">, </span><span class="s1">c</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">n </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">row</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;scale,method&quot;</span><span class="s3">,</span>
                             <span class="s3">((</span><span class="s5">1</span><span class="s3">, </span><span class="s4">&quot;boyett&quot;</span><span class="s3">), (</span><span class="s5">100</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">)))</span>
    <span class="s2">def </span><span class="s1">test_process_rvs_method_on_None</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">row </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]) * </span><span class="s1">scale</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]) * </span><span class="s1">scale</span>

        <span class="s1">ct </span><span class="s3">= </span><span class="s1">random_table</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">got </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">got</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_process_rvs_method_bad_argument</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>

        <span class="s6"># order of items in set is random, so cannot check that</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;'foo' not recognized, must be one of&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;foo&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'frozen'</span><span class="s3">, (</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'log'</span><span class="s3">, (</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_pmf_logpmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">frozen</span><span class="s3">, </span><span class="s1">log</span><span class="s3">):</span>
        <span class="s6"># The pmf is tested through random sample generation</span>
        <span class="s6"># with Boyett's algorithm, whose implementation is simple</span>
        <span class="s6"># enough to verify manually for correctness.</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">()</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">,</span>
                               <span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>

        <span class="s1">obj </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">) </span><span class="s2">if </span><span class="s1">frozen </span><span class="s2">else </span><span class="s1">random_table</span>
        <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s4">&quot;logpmf&quot; </span><span class="s2">if </span><span class="s1">log </span><span class="s2">else </span><span class="s4">&quot;pmf&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">frozen</span><span class="s3">:</span>
            <span class="s1">original_method </span><span class="s3">= </span><span class="s1">method</span>

            <span class="s2">def </span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s1">original_method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">pmf </span><span class="s3">= (</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">))) </span><span class="s2">if </span><span class="s1">log </span><span class="s2">else </span><span class="s1">method</span>

        <span class="s1">unique_rvs</span><span class="s3">, </span><span class="s1">counts </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">return_counts</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s6"># rough accuracy check</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">unique_rvs</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">), </span><span class="s1">counts</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>

        <span class="s6"># accept any iterable</span>
        <span class="s1">p2 </span><span class="s3">= </span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">unique_rvs</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">p2</span><span class="s3">, </span><span class="s1">p</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

        <span class="s6"># accept high-dimensional input and 2d input</span>
        <span class="s1">rvs_nd </span><span class="s3">= </span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">) + </span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:])</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">rvs_nd</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">p</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">10</span><span class="s3">, </span><span class="s5">100</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]):</span>
                <span class="s1">pij </span><span class="s3">= </span><span class="s1">p</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">]</span>
                <span class="s1">rvij </span><span class="s3">= </span><span class="s1">rvs_nd</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">]</span>
                <span class="s1">qij </span><span class="s3">= </span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">rvij</span><span class="s3">)</span>
                <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pij</span><span class="s3">, </span><span class="s1">qij</span><span class="s3">)</span>

        <span class="s6"># probability is zero if column marginal does not match</span>
        <span class="s1">x </span><span class="s3">= [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">), </span><span class="s1">row</span><span class="s3">)</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">p </span><span class="s3">== </span><span class="s5">0</span>

        <span class="s6"># probability is zero if row marginal does not match</span>
        <span class="s1">x </span><span class="s3">= [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">2</span><span class="s3">), </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">p </span><span class="s3">== </span><span class="s5">0</span>

        <span class="s6"># response to invalid inputs</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`x` must be at least two-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">pmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`x` must contain only integral values&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">pmf</span><span class="s3">([[</span><span class="s5">1.1</span><span class="s3">]])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`x` must contain only integral values&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">pmf</span><span class="s3">([[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`x` must contain only non-negative values&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">pmf</span><span class="s3">([[-</span><span class="s5">1</span><span class="s3">]])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;shape of `x` must agree with `row`&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">pmf</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]])</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;shape of `x` must agree with `col`&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">pmf</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
                 <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, (</span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_mean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s6"># test if `rvs` is unbiased and large sample size converges</span>
        <span class="s6"># to the true mean.</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">()</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                               <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">mean </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">row</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s5">0</span><span class="s3">), </span><span class="s1">mean</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.05</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_to</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, (</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">2</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_to</span><span class="s3">(</span><span class="s1">col</span><span class="s3">, (</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_rvs_cov</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test if `rvs` generated with patefield and boyett algorithms</span>
        <span class="s6"># produce approximately the same covariance matrix</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">()</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;boyett&quot;</span><span class="s3">,</span>
                                <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s4">&quot;patefield&quot;</span><span class="s3">,</span>
                                <span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">cov1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">cov2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">rvs2</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov1</span><span class="s3">, </span><span class="s1">cov2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">0.02</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, (</span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_size</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>

        <span class="s6"># test size `None`</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                              <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">rv</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

        <span class="s6"># test size 1</span>
        <span class="s1">rv2 </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                               <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">rv2</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">, </span><span class="s1">rv2</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>

        <span class="s6"># test size 0</span>
        <span class="s1">rv3 </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                               <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">rv3</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

        <span class="s6"># test other valid size</span>
        <span class="s1">rv4 </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">20</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                               <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">rv4</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">20</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

        <span class="s1">rv5 </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">), </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                               <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">rv5</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">rv5</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), </span><span class="s1">rv4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

        <span class="s6"># test invalid size</span>
        <span class="s1">message </span><span class="s3">= </span><span class="s4">&quot;`size` must be a non-negative integer or `None`&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                             <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                             <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, (</span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s6"># This test assumes that pmf is correct and checks that random samples</span>
        <span class="s6"># follow this probability distribution. This seems like a circular</span>
        <span class="s6"># argument, since pmf is checked in test_pmf_logpmf with random samples</span>
        <span class="s6"># generated with the rvs method. This test is not redundant, because</span>
        <span class="s6"># test_pmf_logpmf intentionally uses rvs generation with Boyett only,</span>
        <span class="s6"># but here we test both Boyett and Patefield.</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>

        <span class="s1">ct </span><span class="s3">= </span><span class="s1">random_table</span>
        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">100000</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                     <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>

        <span class="s1">unique_rvs</span><span class="s3">, </span><span class="s1">counts </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">return_counts</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s6"># generated frequencies should match expected frequencies</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">ct</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">unique_rvs</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">rvs</span><span class="s3">), </span><span class="s1">counts</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0.02</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, (</span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_with_zeros_in_col_row</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">1000</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">row</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">col</span><span class="s3">)))</span>
        <span class="s1">expected</span><span class="s3">[...] = [[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">],</span>
                         <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, (</span><span class="s2">None</span><span class="s3">, </span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;col&quot;</span><span class="s3">, ([], [</span><span class="s5">0</span><span class="s3">]))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;row&quot;</span><span class="s3">, ([], [</span><span class="s5">0</span><span class="s3">]))</span>
    <span class="s2">def </span><span class="s1">test_rvs_with_edge_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">):</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">10</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">row</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">col</span><span class="s3">)))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'v'</span><span class="s3">, (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_rcont</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">v</span><span class="s3">):</span>
        <span class="s6"># This test checks the internal low-level interface.</span>
        <span class="s6"># It is implicitly also checked by the other test_rvs* calls.</span>
        <span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_rcont </span><span class="s2">as </span><span class="s1">_rcont</span>

        <span class="s1">row </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s1">col </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>

        <span class="s1">rvs </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">_rcont</span><span class="s3">, </span><span class="s4">f&quot;rvs_rcont</span><span class="s2">{</span><span class="s1">v</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">)</span>

        <span class="s1">ntot </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">row</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">ntot</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>

        <span class="s2">assert </span><span class="s1">result</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">1</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">row</span><span class="s3">), </span><span class="s1">len</span><span class="s3">(</span><span class="s1">col</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">result</span><span class="s3">) == </span><span class="s1">ntot</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>

        <span class="s1">sample </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">d</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">())</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">d</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">))</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">, </span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">d</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">sample</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, (</span><span class="s4">&quot;boyett&quot;</span><span class="s3">, </span><span class="s4">&quot;patefield&quot;</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_rvs_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">row </span><span class="s3">= [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]</span>
        <span class="s1">col </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">random_table</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">col</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">,</span>
                                    <span class="s1">random_state</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rng</span><span class="s3">())</span>
        <span class="s1">got </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">got</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_pickling</span><span class="s3">(</span><span class="s1">distfn</span><span class="s3">, </span><span class="s1">args</span><span class="s3">):</span>
    <span class="s6"># check that a distribution instance pickles and unpickles</span>
    <span class="s6"># pay special attention to the random_state property</span>

    <span class="s6"># save the random_state (restore later)</span>
    <span class="s1">rndm </span><span class="s3">= </span><span class="s1">distfn</span><span class="s3">.</span><span class="s1">random_state</span>

    <span class="s1">distfn</span><span class="s3">.</span><span class="s1">random_state </span><span class="s3">= </span><span class="s5">1234</span>
    <span class="s1">distfn</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">8</span><span class="s3">)</span>
    <span class="s1">s </span><span class="s3">= </span><span class="s1">pickle</span><span class="s3">.</span><span class="s1">dumps</span><span class="s3">(</span><span class="s1">distfn</span><span class="s3">)</span>
    <span class="s1">r0 </span><span class="s3">= </span><span class="s1">distfn</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">8</span><span class="s3">)</span>

    <span class="s1">unpickled </span><span class="s3">= </span><span class="s1">pickle</span><span class="s3">.</span><span class="s1">loads</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
    <span class="s1">r1 </span><span class="s3">= </span><span class="s1">unpickled</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">8</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">r0</span><span class="s3">, </span><span class="s1">r1</span><span class="s3">)</span>

    <span class="s6"># restore the random_state</span>
    <span class="s1">distfn</span><span class="s3">.</span><span class="s1">random_state </span><span class="s3">= </span><span class="s1">rndm</span>


<span class="s2">def </span><span class="s1">test_random_state_property</span><span class="s3">():</span>
    <span class="s1">scale </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">scale</span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">] = </span><span class="s5">0.5</span>
    <span class="s1">scale</span><span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">] = </span><span class="s5">0.5</span>
    <span class="s1">dists </span><span class="s3">= [</span>
        <span class="s3">[</span><span class="s1">multivariate_normal</span><span class="s3">, ()],</span>
        <span class="s3">[</span><span class="s1">dirichlet</span><span class="s3">, (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">]), )],</span>
        <span class="s3">[</span><span class="s1">wishart</span><span class="s3">, (</span><span class="s5">10</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)],</span>
        <span class="s3">[</span><span class="s1">invwishart</span><span class="s3">, (</span><span class="s5">10</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">)],</span>
        <span class="s3">[</span><span class="s1">multinomial</span><span class="s3">, (</span><span class="s5">5</span><span class="s3">, [</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">])],</span>
        <span class="s3">[</span><span class="s1">ortho_group</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">,)],</span>
        <span class="s3">[</span><span class="s1">special_ortho_group</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">,)]</span>
    <span class="s3">]</span>
    <span class="s2">for </span><span class="s1">distfn</span><span class="s3">, </span><span class="s1">args </span><span class="s2">in </span><span class="s1">dists</span><span class="s3">:</span>
        <span class="s1">check_random_state_property</span><span class="s3">(</span><span class="s1">distfn</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">check_pickling</span><span class="s3">(</span><span class="s1">distfn</span><span class="s3">, </span><span class="s1">args</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestVonMises_Fisher</span><span class="s3">:</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">6</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;size&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, (</span><span class="s5">5</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_samples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">size</span><span class="s3">):</span>
        <span class="s6"># test that samples have correct shape and norm 1</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2777937887058094419</span><span class="s3">)</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">dim</span><span class="s3">, ), </span><span class="s5">1</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">vmf_dist </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">vmf_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s1">mean</span><span class="s3">, </span><span class="s1">cov </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">expected_shape </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">multivariate_normal</span><span class="s3">(</span><span class="s1">mean</span><span class="s3">, </span><span class="s1">cov</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">size</span><span class="s3">).</span><span class="s1">shape</span>
        <span class="s2">assert </span><span class="s1">samples</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">expected_shape</span>
        <span class="s1">norms </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">norms</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">8</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;kappa&quot;</span><span class="s3">, [</span><span class="s5">1e15</span><span class="s3">, </span><span class="s5">1e20</span><span class="s3">, </span><span class="s5">1e30</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_sampling_high_concentration</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">):</span>
        <span class="s6"># test that no warnings are encountered for high values</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2777937887058094419</span><span class="s3">)</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">dim</span><span class="s3">, ), </span><span class="s5">1</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">vmf_dist </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">vmf_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_two_dimensional_mu</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'mu' must have one-dimensional shape.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_wrong_norm_mu</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, ))</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'mu' must be a unit vector of norm 1.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_one_entry_mu</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">1</span><span class="s3">, ))</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'mu' must have at least two entries.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;kappa&quot;</span><span class="s3">, [-</span><span class="s5">1</span><span class="s3">, (</span><span class="s5">5</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_kappa_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'kappa' must be a positive scalar.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">kappa</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;kappa&quot;</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_kappa_zero</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= (</span><span class="s4">&quot;For 'kappa=0' the von Mises-Fisher distribution &quot;</span>
               <span class="s4">&quot;becomes the uniform distribution on the sphere &quot;</span>
               <span class="s4">&quot;surface. Consider using 'scipy.stats.uniform_direction' &quot;</span>
               <span class="s4">&quot;instead.&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">kappa</span><span class="s3">)</span>


    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">,</span>
                                        <span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_invalid_shapes_pdf_logpdf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">msg </span><span class="s3">= (</span><span class="s4">&quot;The dimensionality of the last axis of 'x' must &quot;</span>
               <span class="s4">&quot;match the dimensionality of the von Mises Fisher &quot;</span>
               <span class="s4">&quot;distribution.&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">,</span>
                                        <span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_unnormalized_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">])</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'x' must be unit vectors of norm 1 along last dimension.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)</span>

    <span class="s6"># Expected values of the vonmises-fisher logPDF were computed via mpmath</span>
    <span class="s6"># from mpmath import mp</span>
    <span class="s6"># import numpy as np</span>
    <span class="s6"># mp.dps = 50</span>
    <span class="s6"># def logpdf_mpmath(x, mu, kappa):</span>
    <span class="s6">#     dim = mu.size</span>
    <span class="s6">#     halfdim = mp.mpf(0.5 * dim)</span>
    <span class="s6">#     kappa = mp.mpf(kappa)</span>
    <span class="s6">#     const = (kappa**(halfdim - mp.one)/((2*mp.pi)**halfdim * \</span>
    <span class="s6">#              mp.besseli(halfdim -mp.one, kappa)))</span>
    <span class="s6">#     return float(const * mp.exp(kappa*mp.fdot(x, mu)))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x, mu, kappa, reference'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">1e-4</span><span class="s3">, </span><span class="s5">0.0795854295583605</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]),</span>
                               <span class="s5">1e-4</span><span class="s3">, </span><span class="s5">0.07957747141331854</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">100</span><span class="s3">, </span><span class="s5">15.915494309189533</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]),</span>
                               <span class="s5">100</span><span class="s3">, </span><span class="s5">5.920684802611232e-43</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.98</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.02</span><span class="s3">), </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">5.930499050746588e-07</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">318.3098861837907</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">101371.86957712633</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.98</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.02</span><span class="s3">), </span><span class="s5">0.</span><span class="s3">,</span>
                                         <span class="s5">0</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">0.00018886808182653578</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.8</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.2</span><span class="s3">), </span><span class="s5">0.</span><span class="s3">,</span>
                                         <span class="s5">0</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">2.0255393314603194e-87</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_pdf_accuracy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">reference</span><span class="s3">):</span>
        <span class="s1">pdf </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">).</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdf</span><span class="s3">, </span><span class="s1">reference</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-13</span><span class="s3">)</span>

    <span class="s6"># Expected values of the vonmises-fisher logPDF were computed via mpmath</span>
    <span class="s6"># from mpmath import mp</span>
    <span class="s6"># import numpy as np</span>
    <span class="s6"># mp.dps = 50</span>
    <span class="s6"># def logpdf_mpmath(x, mu, kappa):</span>
    <span class="s6">#     dim = mu.size</span>
    <span class="s6">#     halfdim = mp.mpf(0.5 * dim)</span>
    <span class="s6">#     kappa = mp.mpf(kappa)</span>
    <span class="s6">#     two = mp.mpf(2.)</span>
    <span class="s6">#     const = (kappa**(halfdim - mp.one)/((two*mp.pi)**halfdim * \</span>
    <span class="s6">#              mp.besseli(halfdim - mp.one, kappa)))</span>
    <span class="s6">#     return float(mp.log(const * mp.exp(kappa*mp.fdot(x, mu))))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'x, mu, kappa, reference'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">1e-4</span><span class="s3">, -</span><span class="s5">2.5309242486359573</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]),</span>
                               <span class="s5">1e-4</span><span class="s3">, -</span><span class="s5">2.5310242486359575</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">100</span><span class="s3">, </span><span class="s5">2.767293119578746</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">1.</span><span class="s3">]),</span>
                               <span class="s5">100</span><span class="s3">, -</span><span class="s5">97.23270688042125</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.98</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.02</span><span class="s3">), </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, -</span><span class="s5">14.337987284534103</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">5.763025393132737</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, </span><span class="s5">11.526550911307156</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.98</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.02</span><span class="s3">), </span><span class="s5">0.</span><span class="s3">,</span>
                                         <span class="s5">0</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, -</span><span class="s5">8.574461766359684</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.8</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">0.2</span><span class="s3">), </span><span class="s5">0.</span><span class="s3">,</span>
                                         <span class="s5">0</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">]),</span>
                               <span class="s5">2000</span><span class="s3">, -</span><span class="s5">199.61906708886113</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_logpdf_accuracy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">reference</span><span class="s3">):</span>
        <span class="s1">logpdf </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">).</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">logpdf</span><span class="s3">, </span><span class="s1">reference</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-14</span><span class="s3">)</span>

    <span class="s6"># Expected values of the vonmises-fisher entropy were computed via mpmath</span>
    <span class="s6"># from mpmath import mp</span>
    <span class="s6"># import numpy as np</span>
    <span class="s6"># mp.dps = 50</span>
    <span class="s6"># def entropy_mpmath(dim, kappa):</span>
    <span class="s6">#     mu = np.full((dim, ), 1/np.sqrt(dim))</span>
    <span class="s6">#     kappa = mp.mpf(kappa)</span>
    <span class="s6">#     halfdim = mp.mpf(0.5 * dim)</span>
    <span class="s6">#     logconstant = (mp.log(kappa**(halfdim - mp.one)</span>
    <span class="s6">#                    /((2*mp.pi)**halfdim</span>
    <span class="s6">#                    * mp.besseli(halfdim -mp.one, kappa)))</span>
    <span class="s6">#     return float(-logconstant - kappa * mp.besseli(halfdim, kappa)/</span>
    <span class="s6">#             mp.besseli(halfdim -1, kappa))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'dim, kappa, reference'</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1e-4</span><span class="s3">, </span><span class="s5">2.531024245302624</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, -</span><span class="s5">1.7672931195787458</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5000</span><span class="s3">, -</span><span class="s5">11.359032310024453</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3.4189526482545527</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_entropy_accuracy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">reference</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">dim</span><span class="s3">, ), </span><span class="s5">1</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">entropy </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">).</span><span class="s1">entropy</span><span class="s3">()</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">entropy</span><span class="s3">, </span><span class="s1">reference</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">2e-14</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;method&quot;</span><span class="s3">, [</span><span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">,</span>
                                        <span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_broadcasting</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s6"># test that pdf and logpdf values are correctly broadcasted</span>
        <span class="s1">testshape </span><span class="s3">= (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2777937887058094419</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">(</span><span class="s5">3</span><span class="s3">).</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">testshape</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, ), </span><span class="s5">1</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">kappa </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">result_all </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result_all</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">testshape</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">testshape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">testshape</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]):</span>
                <span class="s1">current_val </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">, :], </span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">)</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">current_val</span><span class="s3">, </span><span class="s1">result_all</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-15</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_vs_vonmises_2d</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># test that in 2D, von Mises-Fisher yields the same results</span>
        <span class="s6"># as the von Mises distribution</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2777937887058094419</span><span class="s3">)</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">mu_angle </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan2</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">mu</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">kappa </span><span class="s3">= </span><span class="s5">20</span>
        <span class="s1">vmf </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">)</span>
        <span class="s1">vonmises_dist </span><span class="s3">= </span><span class="s1">vonmises</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s1">mu_angle</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">=</span><span class="s1">kappa</span><span class="s3">)</span>
        <span class="s1">vectors </span><span class="s3">= </span><span class="s1">uniform_direction</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">rvs</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">angles </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan2</span><span class="s3">(</span><span class="s1">vectors</span><span class="s3">[:, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">vectors</span><span class="s3">[:, </span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vonmises_dist</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">(), </span><span class="s1">vmf</span><span class="s3">.</span><span class="s1">entropy</span><span class="s3">())</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vonmises_dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">angles</span><span class="s3">), </span><span class="s1">vmf</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">vectors</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">vonmises_dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">angles</span><span class="s3">), </span><span class="s1">vmf</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">vectors</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;dim&quot;</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">6</span><span class="s3">])</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;kappa, mu_tol, kappa_tol&quot;</span><span class="s3">,</span>
                             <span class="s3">[(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">5e-2</span><span class="s3">, </span><span class="s5">5e-2</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">1e-2</span><span class="s3">, </span><span class="s5">1e-2</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">5e-3</span><span class="s3">, </span><span class="s5">2e-2</span><span class="s3">),</span>
                              <span class="s3">(</span><span class="s5">1000</span><span class="s3">, </span><span class="s5">1e-3</span><span class="s3">, </span><span class="s5">2e-2</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_fit_accuracy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">mu_tol</span><span class="s3">, </span><span class="s1">kappa_tol</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s1">dim</span><span class="s3">, ), </span><span class="s5">1</span><span class="s3">/</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">dim</span><span class="s3">))</span>
        <span class="s1">vmf_dist </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">)</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2777937887058094419</span><span class="s3">)</span>
        <span class="s1">n_samples </span><span class="s3">= </span><span class="s5">10000</span>
        <span class="s1">samples </span><span class="s3">= </span><span class="s1">vmf_dist</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>
        <span class="s1">mu_fit</span><span class="s3">, </span><span class="s1">kappa_fit </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">samples</span><span class="s3">)</span>
        <span class="s1">angular_error </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arccos</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">mu_fit</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">angular_error</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">mu_tol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">kappa_fit</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">kappa_tol</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fit_error_one_dimensional_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, ))</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'x' must be two dimensional.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_fit_error_unnormalized_data</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'x' must be unit vectors of norm 1 along last dimension.&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_frozen_distribution</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">mu </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">kappa </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">frozen </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">)</span>
        <span class="s1">frozen_seed </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>

        <span class="s1">rvs1 </span><span class="s3">= </span><span class="s1">frozen</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs2 </span><span class="s3">= </span><span class="s1">vonmises_fisher</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">(</span><span class="s1">mu</span><span class="s3">, </span><span class="s1">kappa</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">514</span><span class="s3">)</span>
        <span class="s1">rvs3 </span><span class="s3">= </span><span class="s1">frozen_seed</span><span class="s3">.</span><span class="s1">rvs</span><span class="s3">()</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rvs1</span><span class="s3">, </span><span class="s1">rvs3</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestDirichletMultinomial</span><span class="s3">:</span>
    <span class="s3">@</span><span class="s1">classmethod</span>
    <span class="s2">def </span><span class="s1">get_params</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">28469824356873456</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s1">m</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">x</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">rng</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x</span>

    <span class="s2">def </span><span class="s1">test_frozen</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">28469824356873456</span><span class="s3">)</span>

        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>

        <span class="s1">d </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(), </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_pmf_logpmf_against_R</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># # Compare PMF against R's extraDistr ddirmnon</span>
        <span class="s6"># # library(extraDistr)</span>
        <span class="s6"># # options(digits=16)</span>
        <span class="s6"># ddirmnom(c(1, 2, 3), 6, c(3, 4, 5))</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">logres </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s5">0.08484162895927638</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">logres</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== ()</span>

        <span class="s6"># library(extraDistr)</span>
        <span class="s6"># options(digits=16)</span>
        <span class="s6"># ddirmnom(c(4, 3, 2, 0, 2, 3, 5, 7, 4, 7), 37,</span>
        <span class="s6">#          c(45.01025314, 21.98739582, 15.14851365, 80.21588671,</span>
        <span class="s6">#            52.84935481, 25.20905262, 53.85373737, 4.88568118,</span>
        <span class="s6">#            89.06440654, 20.11359466))</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">28469824356873456</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">logres </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s5">3.65409306285992e-16</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_pmf_logpmf_support</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># when the sum of the category counts does not equal the number of</span>
        <span class="s6"># trials, the PMF is zero</span>
        <span class="s1">rng</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>

        <span class="s1">rng</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s5">10</span><span class="s3">) &gt; </span><span class="s5">0.5</span>
        <span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] * </span><span class="s5">2</span><span class="s3">)  </span><span class="s6"># sum of these x does not equal n</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s1">i</span><span class="s3">], </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[</span><span class="s1">i</span><span class="s3">], -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[~</span><span class="s1">i</span><span class="s3">] &gt; </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)[~</span><span class="s1">i</span><span class="s3">] &gt; -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dimensionality_one</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># if the dimensionality is one, there is only one possible outcome</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s5">6  </span><span class="s6"># number of trials</span>
        <span class="s1">alpha </span><span class="s3">= [</span><span class="s5">10</span><span class="s3">]  </span><span class="s6"># concentration parameters</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">n</span><span class="s3">])  </span><span class="s6"># counts</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">+</span><span class="s5">1</span><span class="s3">), </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">+</span><span class="s5">1</span><span class="s3">), -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(), </span><span class="s5">0</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'method_name'</span><span class="s3">, [</span><span class="s4">'pmf'</span><span class="s3">, </span><span class="s4">'logpmf'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_against_betabinom_pmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method_name</span><span class="s3">):</span>
        <span class="s1">rng</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>

        <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">method_name</span><span class="s3">)</span>
        <span class="s1">ref_method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">betabinom</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, *</span><span class="s1">alpha</span><span class="s3">.</span><span class="s1">T</span><span class="s3">), </span><span class="s1">method_name</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">ref_method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'method_name'</span><span class="s3">, [</span><span class="s4">'mean'</span><span class="s3">, </span><span class="s4">'var'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_against_betabinom_moments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method_name</span><span class="s3">):</span>
        <span class="s1">rng</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">x </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_params</span><span class="s3">(</span><span class="s5">100</span><span class="s3">)</span>

        <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">method_name</span><span class="s3">)</span>
        <span class="s1">ref_method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">betabinom</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, *</span><span class="s1">alpha</span><span class="s3">.</span><span class="s1">T</span><span class="s3">), </span><span class="s1">method_name</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">method</span><span class="s3">()[:, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">ref_method</span><span class="s3">()</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_moments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">28469824356873456</span><span class="s3">)</span>
        <span class="s1">dim </span><span class="s3">= </span><span class="s5">5</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">100</span><span class="s3">)</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">dim</span><span class="s3">) * </span><span class="s5">10</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">dirichlet_multinomial</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>

        <span class="s6"># Generate a random sample from the distribution using NumPy</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s5">100000</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">dirichlet</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">multinomial</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">m</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">5e-3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">().</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">var</span><span class="s3">().</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">dim</span><span class="s3">,)</span>

        <span class="s1">cov </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">cov</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">dim</span><span class="s3">, </span><span class="s1">dim</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">T</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">2e-2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">), </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">var</span><span class="s3">())</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">cov</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">] &gt; </span><span class="s5">0</span><span class="s3">)  </span><span class="s6"># positive definite</span>

    <span class="s2">def </span><span class="s1">test_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s6"># valid inputs</span>
        <span class="s1">x0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">n0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">x0</span><span class="s3">)</span>
        <span class="s1">alpha0 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>

        <span class="s1">text </span><span class="s3">= </span><span class="s4">&quot;`x` must contain only non-negative integers.&quot;</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">alpha0</span><span class="s3">, </span><span class="s1">n0</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2.1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">alpha0</span><span class="s3">, </span><span class="s1">n0</span><span class="s3">)</span>

        <span class="s1">text </span><span class="s3">= </span><span class="s4">&quot;`alpha` must contain only positive values.&quot;</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x0</span><span class="s3">, [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], </span><span class="s1">n0</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x0</span><span class="s3">, [</span><span class="s5">3</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], </span><span class="s1">n0</span><span class="s3">)</span>

        <span class="s1">text </span><span class="s3">= </span><span class="s4">&quot;`n` must be a positive integer.&quot;</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">alpha0</span><span class="s3">, </span><span class="s5">49.1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x0</span><span class="s3">, </span><span class="s1">alpha0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>

        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">])</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">])</span>
        <span class="s1">text </span><span class="s3">= </span><span class="s4">&quot;`x` and `alpha` must be broadcastable.&quot;</span>
        <span class="s2">with </span><span class="s1">assert_raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">text</span><span class="s3">):</span>
            <span class="s1">dirichlet_multinomial</span><span class="s3">.</span><span class="s1">logpmf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">())</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'method'</span><span class="s3">, [</span><span class="s4">'pmf'</span><span class="s3">, </span><span class="s4">'logpmf'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_broadcasting_pmf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]])</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">]])</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]).</span><span class="s1">reshape</span><span class="s3">((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">))</span>
        <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)):</span>
                <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)):</span>
                    <span class="s1">res_ijk </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">, </span><span class="s1">k</span><span class="s3">]</span>
                    <span class="s1">ref </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s1">i</span><span class="s3">].</span><span class="s1">squeeze</span><span class="s3">(), </span><span class="s1">alpha</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">squeeze</span><span class="s3">(), </span><span class="s1">n</span><span class="s3">[</span><span class="s1">j</span><span class="s3">].</span><span class="s1">squeeze</span><span class="s3">())</span>
                    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res_ijk</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">'method_name'</span><span class="s3">, [</span><span class="s4">'mean'</span><span class="s3">, </span><span class="s4">'var'</span><span class="s3">, </span><span class="s4">'cov'</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_broadcasting_moments</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">method_name</span><span class="s3">):</span>
        <span class="s1">alpha </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">7</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]])</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">], [</span><span class="s5">8</span><span class="s3">]])</span>
        <span class="s1">method </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">dirichlet_multinomial</span><span class="s3">, </span><span class="s1">method_name</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">) </span><span class="s2">if </span><span class="s1">method_name </span><span class="s3">!= </span><span class="s4">'cov' </span><span class="s2">else </span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)):</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">)):</span>
                <span class="s1">res_ijk </span><span class="s3">= </span><span class="s1">res</span><span class="s3">[</span><span class="s1">j</span><span class="s3">, </span><span class="s1">k</span><span class="s3">]</span>
                <span class="s1">ref </span><span class="s3">= </span><span class="s1">method</span><span class="s3">(</span><span class="s1">alpha</span><span class="s3">[</span><span class="s1">k</span><span class="s3">].</span><span class="s1">squeeze</span><span class="s3">(), </span><span class="s1">n</span><span class="s3">[</span><span class="s1">j</span><span class="s3">].</span><span class="s1">squeeze</span><span class="s3">())</span>
                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res_ijk</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>
</pre>
</body>
</html>