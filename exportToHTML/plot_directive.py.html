<html>
<head>
<title>plot_directive.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
plot_directive.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
A directive for including a Matplotlib plot in a Sphinx document 
================================================================ 
 
This is a Sphinx extension providing a reStructuredText directive 
``.. plot::`` for including a plot in a Sphinx document. 
 
In HTML output, ``.. plot::`` will include a .png file with a link 
to a high-res .png and .pdf.  In LaTeX output, it will include a .pdf. 
 
The plot content may be defined in one of three ways: 
 
1. **A path to a source file** as the argument to the directive:: 
 
     .. plot:: path/to/plot.py 
 
   When a path to a source file is given, the content of the 
   directive may optionally contain a caption for the plot:: 
 
     .. plot:: path/to/plot.py 
 
        The plot caption. 
 
   Additionally, one may specify the name of a function to call (with 
   no arguments) immediately after importing the module:: 
 
     .. plot:: path/to/plot.py plot_function1 
 
2. Included as **inline content** to the directive:: 
 
     .. plot:: 
 
        import matplotlib.pyplot as plt 
        plt.plot([1, 2, 3], [4, 5, 6]) 
        plt.title(&quot;A plotting exammple&quot;) 
 
3. Using **doctest** syntax:: 
 
     .. plot:: 
 
        A plotting example: 
        &gt;&gt;&gt; import matplotlib.pyplot as plt 
        &gt;&gt;&gt; plt.plot([1, 2, 3], [4, 5, 6]) 
 
Options 
------- 
 
The ``.. plot::`` directive supports the following options: 
 
``:format:`` : {'python', 'doctest'} 
    The format of the input.  If unset, the format is auto-detected. 
 
``:include-source:`` : bool 
    Whether to display the source code. The default can be changed using 
    the ``plot_include_source`` variable in :file:`conf.py` (which itself 
    defaults to False). 
 
``:show-source-link:`` : bool 
    Whether to show a link to the source in HTML. The default can be 
    changed using the ``plot_html_show_source_link`` variable in 
    :file:`conf.py` (which itself defaults to True). 
 
``:context:`` : bool or str 
    If provided, the code will be run in the context of all previous plot 
    directives for which the ``:context:`` option was specified.  This only 
    applies to inline code plot directives, not those run from files. If 
    the ``:context: reset`` option is specified, the context is reset 
    for this and future plots, and previous figures are closed prior to 
    running the code. ``:context: close-figs`` keeps the context but closes 
    previous figures before running the code. 
 
``:nofigs:`` : bool 
    If specified, the code block will be run, but no figures will be 
    inserted.  This is usually useful with the ``:context:`` option. 
 
``:caption:`` : str 
    If specified, the option's argument will be used as a caption for the 
    figure. This overwrites the caption given in the content, when the plot 
    is generated from a file. 
 
Additionally, this directive supports all the options of the `image directive 
&lt;https://docutils.sourceforge.io/docs/ref/rst/directives.html#image&gt;`_, 
except for ``:target:`` (since plot will add its own target).  These include 
``:alt:``, ``:height:``, ``:width:``, ``:scale:``, ``:align:`` and ``:class:``. 
 
Configuration options 
--------------------- 
 
The plot directive has the following configuration options: 
 
plot_include_source 
    Default value for the include-source option (default: False). 
 
plot_html_show_source_link 
    Whether to show a link to the source in HTML (default: True). 
 
plot_pre_code 
    Code that should be executed before each plot. If None (the default), 
    it will default to a string containing:: 
 
        import numpy as np 
        from matplotlib import pyplot as plt 
 
plot_basedir 
    Base directory, to which ``plot::`` file names are relative to. 
    If None or empty (the default), file names are relative to the 
    directory where the file containing the directive is. 
 
plot_formats 
    File formats to generate (default: ['png', 'hires.png', 'pdf']). 
    List of tuples or strings:: 
 
        [(suffix, dpi), suffix, ...] 
 
    that determine the file format and the DPI. For entries whose 
    DPI was omitted, sensible defaults are chosen. When passing from 
    the command line through sphinx_build the list should be passed as 
    suffix:dpi,suffix:dpi, ... 
 
plot_html_show_formats 
    Whether to show links to the files in HTML (default: True). 
 
plot_rcparams 
    A dictionary containing any non-standard rcParams that should 
    be applied before each plot (default: {}). 
 
plot_apply_rcparams 
    By default, rcParams are applied when ``:context:`` option is not used 
    in a plot directive.  If set, this configuration option overrides this 
    behavior and applies rcParams before each plot. 
 
plot_working_directory 
    By default, the working directory will be changed to the directory of 
    the example, so the code can get at its data files, if any.  Also its 
    path will be added to `sys.path` so it can import any helper modules 
    sitting beside it.  This configuration option can be used to specify 
    a central directory (also added to `sys.path`) where data files and 
    helper modules for all code are located. 
 
plot_template 
    Provide a customized template for preparing restructured text. 
 
plot_srcset 
    Allow the srcset image option for responsive image resolutions. List of 
    strings with the multiplicative factors followed by an &quot;x&quot;. 
    e.g. [&quot;2.0x&quot;, &quot;1.5x&quot;].  &quot;2.0x&quot; will create a png with the default &quot;png&quot; 
    resolution from plot_formats, multiplied by 2. If plot_srcset is 
    specified, the plot directive uses the 
    :doc:`/api/sphinxext_figmpl_directive_api` (instead of the usual figure 
    directive) in the intermediary rst file that is generated. 
    The plot_srcset option is incompatible with *singlehtml* builds, and an 
    error will be raised. 
 
Notes on how it works 
--------------------- 
 
The plot directive runs the code it is given, either in the source file or the 
code under the directive. The figure created (if any) is saved in the sphinx 
build directory under a subdirectory named ``plot_directive``.  It then creates 
an intermediate rst file that calls a ``.. figure:`` directive (or 
``.. figmpl::`` directive if ``plot_srcset`` is being used) and has links to 
the ``*.png`` files in the ``plot_directive`` directory.  These translations can 
be customized by changing the *plot_template*.  See the source of 
:doc:`/api/sphinxext_plot_directive_api` for the templates defined in *TEMPLATE* 
and *TEMPLATE_SRCSET*. 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">contextlib</span>
<span class="s2">import </span><span class="s1">doctest</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">StringIO</span>
<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">relpath</span>
<span class="s2">from </span><span class="s1">pathlib </span><span class="s2">import </span><span class="s1">Path</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">textwrap</span>
<span class="s2">import </span><span class="s1">traceback</span>

<span class="s2">from </span><span class="s1">docutils</span><span class="s3">.</span><span class="s1">parsers</span><span class="s3">.</span><span class="s1">rst </span><span class="s2">import </span><span class="s1">directives</span><span class="s3">, </span><span class="s1">Directive</span>
<span class="s2">from </span><span class="s1">docutils</span><span class="s3">.</span><span class="s1">parsers</span><span class="s3">.</span><span class="s1">rst</span><span class="s3">.</span><span class="s1">directives</span><span class="s3">.</span><span class="s1">images </span><span class="s2">import </span><span class="s1">Image</span>
<span class="s2">import </span><span class="s1">jinja2  </span><span class="s4"># Sphinx dependency.</span>

<span class="s2">from </span><span class="s1">sphinx</span><span class="s3">.</span><span class="s1">errors </span><span class="s2">import </span><span class="s1">ExtensionError</span>

<span class="s2">import </span><span class="s1">matplotlib</span>
<span class="s2">from </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">backend_bases </span><span class="s2">import </span><span class="s1">FigureManagerBase</span>
<span class="s2">import </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">pyplot </span><span class="s2">as </span><span class="s1">plt</span>
<span class="s2">from </span><span class="s1">matplotlib </span><span class="s2">import </span><span class="s1">_pylab_helpers</span><span class="s3">, </span><span class="s1">cbook</span>

<span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">use</span><span class="s3">(</span><span class="s5">&quot;agg&quot;</span><span class="s3">)</span>

<span class="s1">__version__ </span><span class="s3">= </span><span class="s6">2</span>


<span class="s4"># -----------------------------------------------------------------------------</span>
<span class="s4"># Registration hook</span>
<span class="s4"># -----------------------------------------------------------------------------</span>


<span class="s2">def </span><span class="s1">_option_boolean</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">):</span>
    <span class="s2">if not </span><span class="s1">arg </span><span class="s2">or not </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">():</span>
        <span class="s4"># no argument given, assume used as a flag</span>
        <span class="s2">return True</span>
    <span class="s2">elif </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">in </span><span class="s3">(</span><span class="s5">'no'</span><span class="s3">, </span><span class="s5">'0'</span><span class="s3">, </span><span class="s5">'false'</span><span class="s3">):</span>
        <span class="s2">return False</span>
    <span class="s2">elif </span><span class="s1">arg</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">lower</span><span class="s3">() </span><span class="s2">in </span><span class="s3">(</span><span class="s5">'yes'</span><span class="s3">, </span><span class="s5">'1'</span><span class="s3">, </span><span class="s5">'true'</span><span class="s3">):</span>
        <span class="s2">return True</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">f'</span><span class="s2">{</span><span class="s1">arg</span><span class="s2">!r} </span><span class="s5">unknown boolean'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_option_context</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">arg </span><span class="s2">in </span><span class="s3">[</span><span class="s2">None</span><span class="s3">, </span><span class="s5">'reset'</span><span class="s3">, </span><span class="s5">'close-figs'</span><span class="s3">]:</span>
        <span class="s2">return </span><span class="s1">arg</span>
    <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s5">&quot;Argument should be None or 'reset' or 'close-figs'&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_option_format</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">choice</span><span class="s3">(</span><span class="s1">arg</span><span class="s3">, (</span><span class="s5">'python'</span><span class="s3">, </span><span class="s5">'doctest'</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">mark_plot_labels</span><span class="s3">(</span><span class="s1">app</span><span class="s3">, </span><span class="s1">document</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    To make plots referenceable, we need to move the reference from the 
    &quot;htmlonly&quot; (or &quot;latexonly&quot;) node to the actual figure node itself. 
    &quot;&quot;&quot;</span>
    <span class="s2">for </span><span class="s1">name</span><span class="s3">, </span><span class="s1">explicit </span><span class="s2">in </span><span class="s1">document</span><span class="s3">.</span><span class="s1">nametypes</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
        <span class="s2">if not </span><span class="s1">explicit</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s1">labelid </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">nameids</span><span class="s3">[</span><span class="s1">name</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">labelid </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s1">node </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">ids</span><span class="s3">[</span><span class="s1">labelid</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">node</span><span class="s3">.</span><span class="s1">tagname </span><span class="s2">in </span><span class="s3">(</span><span class="s5">'html_only'</span><span class="s3">, </span><span class="s5">'latex_only'</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">node</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">n</span><span class="s3">.</span><span class="s1">tagname </span><span class="s3">== </span><span class="s5">'figure'</span><span class="s3">:</span>
                    <span class="s1">sectname </span><span class="s3">= </span><span class="s1">name</span>
                    <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">n</span><span class="s3">:</span>
                        <span class="s2">if </span><span class="s1">c</span><span class="s3">.</span><span class="s1">tagname </span><span class="s3">== </span><span class="s5">'caption'</span><span class="s3">:</span>
                            <span class="s1">sectname </span><span class="s3">= </span><span class="s1">c</span><span class="s3">.</span><span class="s1">astext</span><span class="s3">()</span>
                            <span class="s2">break</span>

                    <span class="s1">node</span><span class="s3">[</span><span class="s5">'ids'</span><span class="s3">].</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">labelid</span><span class="s3">)</span>
                    <span class="s1">node</span><span class="s3">[</span><span class="s5">'names'</span><span class="s3">].</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">n</span><span class="s3">[</span><span class="s5">'ids'</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">labelid</span><span class="s3">)</span>
                    <span class="s1">n</span><span class="s3">[</span><span class="s5">'names'</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">document</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">env</span><span class="s3">.</span><span class="s1">labels</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">\</span>
                        <span class="s1">document</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">env</span><span class="s3">.</span><span class="s1">docname</span><span class="s3">, </span><span class="s1">labelid</span><span class="s3">, </span><span class="s1">sectname</span>
                    <span class="s2">break</span>


<span class="s2">class </span><span class="s1">PlotDirective</span><span class="s3">(</span><span class="s1">Directive</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;The ``.. plot::`` directive, as documented in the module's docstring.&quot;&quot;&quot;</span>

    <span class="s1">has_content </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s1">required_arguments </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s1">optional_arguments </span><span class="s3">= </span><span class="s6">2</span>
    <span class="s1">final_argument_whitespace </span><span class="s3">= </span><span class="s2">False</span>
    <span class="s1">option_spec </span><span class="s3">= {</span>
        <span class="s5">'alt'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">unchanged</span><span class="s3">,</span>
        <span class="s5">'height'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">length_or_unitless</span><span class="s3">,</span>
        <span class="s5">'width'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">length_or_percentage_or_unitless</span><span class="s3">,</span>
        <span class="s5">'scale'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">nonnegative_int</span><span class="s3">,</span>
        <span class="s5">'align'</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">align</span><span class="s3">,</span>
        <span class="s5">'class'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">class_option</span><span class="s3">,</span>
        <span class="s5">'include-source'</span><span class="s3">: </span><span class="s1">_option_boolean</span><span class="s3">,</span>
        <span class="s5">'show-source-link'</span><span class="s3">: </span><span class="s1">_option_boolean</span><span class="s3">,</span>
        <span class="s5">'format'</span><span class="s3">: </span><span class="s1">_option_format</span><span class="s3">,</span>
        <span class="s5">'context'</span><span class="s3">: </span><span class="s1">_option_context</span><span class="s3">,</span>
        <span class="s5">'nofigs'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">flag</span><span class="s3">,</span>
        <span class="s5">'caption'</span><span class="s3">: </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">unchanged</span><span class="s3">,</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot;Run the plot directive.&quot;&quot;&quot;</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">run</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">arguments</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">content</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">options</span><span class="s3">,</span>
                       <span class="s1">self</span><span class="s3">.</span><span class="s1">state_machine</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">state</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">lineno</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">e</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">_copy_css_file</span><span class="s3">(</span><span class="s1">app</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">exc </span><span class="s2">is None and </span><span class="s1">app</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s5">'html'</span><span class="s3">:</span>
        <span class="s1">src </span><span class="s3">= </span><span class="s1">cbook</span><span class="s3">.</span><span class="s1">_get_data_path</span><span class="s3">(</span><span class="s5">'plot_directive/plot_directive.css'</span><span class="s3">)</span>
        <span class="s1">dst </span><span class="s3">= </span><span class="s1">app</span><span class="s3">.</span><span class="s1">outdir </span><span class="s3">/ </span><span class="s1">Path</span><span class="s3">(</span><span class="s5">'_static'</span><span class="s3">)</span>
        <span class="s1">dst</span><span class="s3">.</span><span class="s1">mkdir</span><span class="s3">(</span><span class="s1">exist_ok</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s4"># Use copyfile because we do not want to copy src's permissions.</span>
        <span class="s1">shutil</span><span class="s3">.</span><span class="s1">copyfile</span><span class="s3">(</span><span class="s1">src</span><span class="s3">, </span><span class="s1">dst </span><span class="s3">/ </span><span class="s1">Path</span><span class="s3">(</span><span class="s5">'plot_directive.css'</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">setup</span><span class="s3">(</span><span class="s1">app</span><span class="s3">):</span>
    <span class="s1">setup</span><span class="s3">.</span><span class="s1">app </span><span class="s3">= </span><span class="s1">app</span>
    <span class="s1">setup</span><span class="s3">.</span><span class="s1">config </span><span class="s3">= </span><span class="s1">app</span><span class="s3">.</span><span class="s1">config</span>
    <span class="s1">setup</span><span class="s3">.</span><span class="s1">confdir </span><span class="s3">= </span><span class="s1">app</span><span class="s3">.</span><span class="s1">confdir</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_directive</span><span class="s3">(</span><span class="s5">'plot'</span><span class="s3">, </span><span class="s1">PlotDirective</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_pre_code'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_include_source'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_html_show_source_link'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_formats'</span><span class="s3">, [</span><span class="s5">'png'</span><span class="s3">, </span><span class="s5">'hires.png'</span><span class="s3">, </span><span class="s5">'pdf'</span><span class="s3">], </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_basedir'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_html_show_formats'</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_rcparams'</span><span class="s3">, {}, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_apply_rcparams'</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_working_directory'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_template'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_config_value</span><span class="s3">(</span><span class="s5">'plot_srcset'</span><span class="s3">, [], </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s5">'doctree-read'</span><span class="s3">, </span><span class="s1">mark_plot_labels</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">add_css_file</span><span class="s3">(</span><span class="s5">'plot_directive.css'</span><span class="s3">)</span>
    <span class="s1">app</span><span class="s3">.</span><span class="s1">connect</span><span class="s3">(</span><span class="s5">'build-finished'</span><span class="s3">, </span><span class="s1">_copy_css_file</span><span class="s3">)</span>
    <span class="s1">metadata </span><span class="s3">= {</span><span class="s5">'parallel_read_safe'</span><span class="s3">: </span><span class="s2">True</span><span class="s3">, </span><span class="s5">'parallel_write_safe'</span><span class="s3">: </span><span class="s2">True</span><span class="s3">,</span>
                <span class="s5">'version'</span><span class="s3">: </span><span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">}</span>
    <span class="s2">return </span><span class="s1">metadata</span>


<span class="s4"># -----------------------------------------------------------------------------</span>
<span class="s4"># Doctest handling</span>
<span class="s4"># -----------------------------------------------------------------------------</span>


<span class="s2">def </span><span class="s1">contains_doctest</span><span class="s3">(</span><span class="s1">text</span><span class="s3">):</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s4"># check if it's valid Python as-is</span>
        <span class="s1">compile</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s5">'&lt;string&gt;'</span><span class="s3">, </span><span class="s5">'exec'</span><span class="s3">)</span>
        <span class="s2">return False</span>
    <span class="s2">except </span><span class="s1">SyntaxError</span><span class="s3">:</span>
        <span class="s2">pass</span>
    <span class="s1">r </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s5">r'^\s*&gt;&gt;&gt;'</span><span class="s3">, </span><span class="s1">re</span><span class="s3">.</span><span class="s1">M</span><span class="s3">)</span>
    <span class="s1">m </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">search</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_split_code_at_show</span><span class="s3">(</span><span class="s1">text</span><span class="s3">, </span><span class="s1">function_name</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Split code at plt.show().&quot;&quot;&quot;</span>

    <span class="s1">is_doctest </span><span class="s3">= </span><span class="s1">contains_doctest</span><span class="s3">(</span><span class="s1">text</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">function_name </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">parts </span><span class="s3">= []</span>
        <span class="s1">part </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">text</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s3">((</span><span class="s2">not </span><span class="s1">is_doctest </span><span class="s2">and </span><span class="s1">line</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">'plt.show('</span><span class="s3">)) </span><span class="s2">or</span>
                   <span class="s3">(</span><span class="s1">is_doctest </span><span class="s2">and </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">() == </span><span class="s5">'&gt;&gt;&gt; plt.show()'</span><span class="s3">)):</span>
                <span class="s1">part</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
                <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">part</span><span class="s3">))</span>
                <span class="s1">part </span><span class="s3">= []</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">part</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">line</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">part</span><span class="s3">).</span><span class="s1">strip</span><span class="s3">():</span>
            <span class="s1">parts</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">part</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">parts </span><span class="s3">= [</span><span class="s1">text</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">is_doctest</span><span class="s3">, </span><span class="s1">parts</span>


<span class="s4"># -----------------------------------------------------------------------------</span>
<span class="s4"># Template</span>
<span class="s4"># -----------------------------------------------------------------------------</span>

<span class="s1">_SOURCECODE </span><span class="s3">= </span><span class="s5">&quot;&quot;&quot; 
{{ source_code }} 
 
.. only:: html 
 
   {% if src_name or (html_show_formats and not multi_image) %} 
   ( 
   {%- if src_name -%} 
   :download:`Source code &lt;{{ build_dir }}/{{ src_name }}&gt;` 
   {%- endif -%} 
   {%- if html_show_formats and not multi_image -%} 
     {%- for img in images -%} 
       {%- for fmt in img.formats -%} 
         {%- if src_name or not loop.first -%}, {% endif -%} 
         :download:`{{ fmt }} &lt;{{ build_dir }}/{{ img.basename }}.{{ fmt }}&gt;` 
       {%- endfor -%} 
     {%- endfor -%} 
   {%- endif -%} 
   ) 
   {% endif %} 
&quot;&quot;&quot;</span>

<span class="s1">TEMPLATE_SRCSET </span><span class="s3">= </span><span class="s1">_SOURCECODE </span><span class="s3">+ </span><span class="s5">&quot;&quot;&quot; 
   {% for img in images %} 
   .. figure-mpl:: {{ build_dir }}/{{ img.basename }}.{{ default_fmt }} 
      {% for option in options -%} 
      {{ option }} 
      {% endfor %} 
      {%- if caption -%} 
      {{ caption }}  {# appropriate leading whitespace added beforehand #} 
      {% endif -%} 
      {%- if srcset -%} 
        :srcset: {{ build_dir }}/{{ img.basename }}.{{ default_fmt }} 
        {%- for sr in srcset -%} 
            , {{ build_dir }}/{{ img.basename }}.{{ sr }}.{{ default_fmt }} {{sr}} 
        {%- endfor -%} 
      {% endif %} 
 
   {% if html_show_formats and multi_image %} 
   ( 
    {%- for fmt in img.formats -%} 
    {%- if not loop.first -%}, {% endif -%} 
    :download:`{{ fmt }} &lt;{{ build_dir }}/{{ img.basename }}.{{ fmt }}&gt;` 
    {%- endfor -%} 
   ) 
   {% endif %} 
 
 
   {% endfor %} 
 
.. only:: not html 
 
   {% for img in images %} 
   .. figure-mpl:: {{ build_dir }}/{{ img.basename }}.* 
      {% for option in options -%} 
      {{ option }} 
      {% endfor -%} 
 
      {{ caption }}  {# appropriate leading whitespace added beforehand #} 
   {% endfor %} 
 
&quot;&quot;&quot;</span>

<span class="s1">TEMPLATE </span><span class="s3">= </span><span class="s1">_SOURCECODE </span><span class="s3">+ </span><span class="s5">&quot;&quot;&quot; 
 
   {% for img in images %} 
   .. figure:: {{ build_dir }}/{{ img.basename }}.{{ default_fmt }} 
      {% for option in options -%} 
      {{ option }} 
      {% endfor %} 
 
      {% if html_show_formats and multi_image -%} 
        ( 
        {%- for fmt in img.formats -%} 
        {%- if not loop.first -%}, {% endif -%} 
        :download:`{{ fmt }} &lt;{{ build_dir }}/{{ img.basename }}.{{ fmt }}&gt;` 
        {%- endfor -%} 
        ) 
      {%- endif -%} 
 
      {{ caption }}  {# appropriate leading whitespace added beforehand #} 
   {% endfor %} 
 
.. only:: not html 
 
   {% for img in images %} 
   .. figure:: {{ build_dir }}/{{ img.basename }}.* 
      {% for option in options -%} 
      {{ option }} 
      {% endfor -%} 
 
      {{ caption }}  {# appropriate leading whitespace added beforehand #} 
   {% endfor %} 
 
&quot;&quot;&quot;</span>

<span class="s1">exception_template </span><span class="s3">= </span><span class="s5">&quot;&quot;&quot; 
.. only:: html 
 
   [`source code &lt;%(linkdir)s/%(basename)s.py&gt;`__] 
 
Exception occurred rendering plot. 
 
&quot;&quot;&quot;</span>

<span class="s4"># the context of the plot for all directives specified with the</span>
<span class="s4"># :context: option</span>
<span class="s1">plot_context </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">()</span>


<span class="s2">class </span><span class="s1">ImageFile</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">basename</span><span class="s3">, </span><span class="s1">dirname</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">basename </span><span class="s3">= </span><span class="s1">basename</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">dirname </span><span class="s3">= </span><span class="s1">dirname</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">formats </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">filename</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">format</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">, </span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">basename</span><span class="s2">}</span><span class="s5">.</span><span class="s2">{</span><span class="s1">format</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">filenames</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">[</span><span class="s1">self</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">) </span><span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">out_of_date</span><span class="s3">(</span><span class="s1">original</span><span class="s3">, </span><span class="s1">derived</span><span class="s3">, </span><span class="s1">includes</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Return whether *derived* is out-of-date relative to *original* or any of 
    the RST files included in it using the RST include directive (*includes*). 
    *derived* and *original* are full paths, and *includes* is optionally a 
    list of full paths which may have been included in the *original*. 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">derived</span><span class="s3">):</span>
        <span class="s2">return True</span>

    <span class="s2">if </span><span class="s1">includes </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">includes </span><span class="s3">= []</span>
    <span class="s1">files_to_check </span><span class="s3">= [</span><span class="s1">original</span><span class="s3">, *</span><span class="s1">includes</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">out_of_date_one</span><span class="s3">(</span><span class="s1">original</span><span class="s3">, </span><span class="s1">derived_mtime</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">original</span><span class="s3">) </span><span class="s2">and</span>
                <span class="s1">derived_mtime </span><span class="s3">&lt; </span><span class="s1">os</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">(</span><span class="s1">original</span><span class="s3">).</span><span class="s1">st_mtime</span><span class="s3">)</span>

    <span class="s1">derived_mtime </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">stat</span><span class="s3">(</span><span class="s1">derived</span><span class="s3">).</span><span class="s1">st_mtime</span>
    <span class="s2">return </span><span class="s1">any</span><span class="s3">(</span><span class="s1">out_of_date_one</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">derived_mtime</span><span class="s3">) </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">files_to_check</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">PlotError</span><span class="s3">(</span><span class="s1">RuntimeError</span><span class="s3">):</span>
    <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">_run_code</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">code_path</span><span class="s3">, </span><span class="s1">ns</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">function_name</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Import a Python module from a path, and run the function given by 
    name, if function_name is not None. 
    &quot;&quot;&quot;</span>

    <span class="s4"># Change the working directory to the directory of the example, so</span>
    <span class="s4"># it can get at its data files, if any.  Add its path to sys.path</span>
    <span class="s4"># so it can import any helper modules sitting beside it.</span>
    <span class="s1">pwd </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">setup</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_working_directory </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">setup</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_working_directory</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">OSError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s5">f'</span><span class="s2">{</span><span class="s1">err</span><span class="s2">}\n</span><span class="s5">`plot_working_directory` option in '</span>
                          <span class="s5">f'Sphinx configuration file must be a valid '</span>
                          <span class="s5">f'directory path'</span><span class="s3">) </span><span class="s2">from </span><span class="s1">err</span>
        <span class="s2">except </span><span class="s1">TypeError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">TypeError</span><span class="s3">(</span><span class="s5">f'</span><span class="s2">{</span><span class="s1">err</span><span class="s2">}\n</span><span class="s5">`plot_working_directory` option in '</span>
                            <span class="s5">f'Sphinx configuration file must be a string or '</span>
                            <span class="s5">f'None'</span><span class="s3">) </span><span class="s2">from </span><span class="s1">err</span>
    <span class="s2">elif </span><span class="s1">code_path </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">dirname </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">code_path</span><span class="s3">))</span>
        <span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">dirname</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">cbook</span><span class="s3">.</span><span class="s1">_setattr_cm</span><span class="s3">(</span>
            <span class="s1">sys</span><span class="s3">, </span><span class="s1">argv</span><span class="s3">=[</span><span class="s1">code_path</span><span class="s3">], </span><span class="s1">path</span><span class="s3">=[</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">(), *</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">path</span><span class="s3">]), </span><span class="s1">\</span>
            <span class="s1">contextlib</span><span class="s3">.</span><span class="s1">redirect_stdout</span><span class="s3">(</span><span class="s1">StringIO</span><span class="s3">()):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ns </span><span class="s2">is None</span><span class="s3">:</span>
                <span class="s1">ns </span><span class="s3">= {}</span>
            <span class="s2">if not </span><span class="s1">ns</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">setup</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_pre_code </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s1">exec</span><span class="s3">(</span><span class="s5">'import numpy as np</span><span class="s2">\n</span><span class="s5">'</span>
                         <span class="s5">'from matplotlib import pyplot as plt</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">, </span><span class="s1">ns</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">exec</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">setup</span><span class="s3">.</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_pre_code</span><span class="s3">), </span><span class="s1">ns</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s5">&quot;__main__&quot; </span><span class="s2">in </span><span class="s1">code</span><span class="s3">:</span>
                <span class="s1">ns</span><span class="s3">[</span><span class="s5">'__name__'</span><span class="s3">] = </span><span class="s5">'__main__'</span>

            <span class="s4"># Patch out non-interactive show() to avoid triggering a warning.</span>
            <span class="s2">with </span><span class="s1">cbook</span><span class="s3">.</span><span class="s1">_setattr_cm</span><span class="s3">(</span><span class="s1">FigureManagerBase</span><span class="s3">, </span><span class="s1">show</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">self</span><span class="s3">: </span><span class="s2">None</span><span class="s3">):</span>
                <span class="s1">exec</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">ns</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">function_name </span><span class="s2">is not None</span><span class="s3">:</span>
                    <span class="s1">exec</span><span class="s3">(</span><span class="s1">function_name </span><span class="s3">+ </span><span class="s5">&quot;()&quot;</span><span class="s3">, </span><span class="s1">ns</span><span class="s3">)</span>

        <span class="s2">except </span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">, </span><span class="s1">SystemExit</span><span class="s3">) </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">PlotError</span><span class="s3">(</span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">format_exc</span><span class="s3">()) </span><span class="s2">from </span><span class="s1">err</span>
        <span class="s2">finally</span><span class="s3">:</span>
            <span class="s1">os</span><span class="s3">.</span><span class="s1">chdir</span><span class="s3">(</span><span class="s1">pwd</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">ns</span>


<span class="s2">def </span><span class="s1">clear_state</span><span class="s3">(</span><span class="s1">plot_rcparams</span><span class="s3">, </span><span class="s1">close</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">close</span><span class="s3">:</span>
        <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">(</span><span class="s5">'all'</span><span class="s3">)</span>
    <span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">rc_file_defaults</span><span class="s3">()</span>
    <span class="s1">matplotlib</span><span class="s3">.</span><span class="s1">rcParams</span><span class="s3">.</span><span class="s1">update</span><span class="s3">(</span><span class="s1">plot_rcparams</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">get_plot_formats</span><span class="s3">(</span><span class="s1">config</span><span class="s3">):</span>
    <span class="s1">default_dpi </span><span class="s3">= {</span><span class="s5">'png'</span><span class="s3">: </span><span class="s6">80</span><span class="s3">, </span><span class="s5">'hires.png'</span><span class="s3">: </span><span class="s6">200</span><span class="s3">, </span><span class="s5">'pdf'</span><span class="s3">: </span><span class="s6">200</span><span class="s3">}</span>
    <span class="s1">formats </span><span class="s3">= []</span>
    <span class="s1">plot_formats </span><span class="s3">= </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_formats</span>
    <span class="s2">for </span><span class="s1">fmt </span><span class="s2">in </span><span class="s1">plot_formats</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s5">':' </span><span class="s2">in </span><span class="s1">fmt</span><span class="s3">:</span>
                <span class="s1">suffix</span><span class="s3">, </span><span class="s1">dpi </span><span class="s3">= </span><span class="s1">fmt</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">':'</span><span class="s3">)</span>
                <span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">str</span><span class="s3">(</span><span class="s1">suffix</span><span class="s3">), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">dpi</span><span class="s3">)))</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">fmt</span><span class="s3">, </span><span class="s1">default_dpi</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">, </span><span class="s6">80</span><span class="s3">)))</span>
        <span class="s2">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">, (</span><span class="s1">tuple</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)) </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">) == </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">str</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]), </span><span class="s1">int</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">PlotError</span><span class="s3">(</span><span class="s5">'invalid image format &quot;%r&quot; in plot_formats' </span><span class="s3">% </span><span class="s1">fmt</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">formats</span>


<span class="s2">def </span><span class="s1">_parse_srcset</span><span class="s3">(</span><span class="s1">entries</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Parse srcset for multiples... 
    &quot;&quot;&quot;</span>
    <span class="s1">srcset </span><span class="s3">= {}</span>
    <span class="s2">for </span><span class="s1">entry </span><span class="s2">in </span><span class="s1">entries</span><span class="s3">:</span>
        <span class="s1">entry </span><span class="s3">= </span><span class="s1">entry</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">entry</span><span class="s3">) &gt;= </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">mult </span><span class="s3">= </span><span class="s1">entry</span><span class="s3">[:-</span><span class="s6">1</span><span class="s3">]</span>
            <span class="s1">srcset</span><span class="s3">[</span><span class="s1">float</span><span class="s3">(</span><span class="s1">mult</span><span class="s3">)] = </span><span class="s1">entry</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">raise </span><span class="s1">ExtensionError</span><span class="s3">(</span><span class="s5">f'srcset argument </span><span class="s2">{</span><span class="s1">entry</span><span class="s2">!r} </span><span class="s5">is invalid.'</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">srcset</span>


<span class="s2">def </span><span class="s1">render_figures</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">code_path</span><span class="s3">, </span><span class="s1">output_dir</span><span class="s3">, </span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">context</span><span class="s3">,</span>
                   <span class="s1">function_name</span><span class="s3">, </span><span class="s1">config</span><span class="s3">, </span><span class="s1">context_reset</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                   <span class="s1">close_figs</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                   <span class="s1">code_includes</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Run a pyplot script and save the images in *output_dir*. 
 
    Save the images under *output_dir* with file names derived from 
    *output_base* 
    &quot;&quot;&quot;</span>

    <span class="s2">if </span><span class="s1">function_name </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">output_base </span><span class="s3">= </span><span class="s5">f'</span><span class="s2">{</span><span class="s1">output_base</span><span class="s2">}</span><span class="s5">_</span><span class="s2">{</span><span class="s1">function_name</span><span class="s2">}</span><span class="s5">'</span>
    <span class="s1">formats </span><span class="s3">= </span><span class="s1">get_plot_formats</span><span class="s3">(</span><span class="s1">config</span><span class="s3">)</span>

    <span class="s4"># Try to determine if all images already exist</span>

    <span class="s1">is_doctest</span><span class="s3">, </span><span class="s1">code_pieces </span><span class="s3">= </span><span class="s1">_split_code_at_show</span><span class="s3">(</span><span class="s1">code</span><span class="s3">, </span><span class="s1">function_name</span><span class="s3">)</span>
    <span class="s4"># Look for single-figure output files first</span>
    <span class="s1">img </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">(</span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">output_dir</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">format</span><span class="s3">, </span><span class="s1">dpi </span><span class="s2">in </span><span class="s1">formats</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">context </span><span class="s2">or </span><span class="s1">out_of_date</span><span class="s3">(</span><span class="s1">code_path</span><span class="s3">, </span><span class="s1">img</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">(</span><span class="s1">format</span><span class="s3">),</span>
                                  <span class="s1">includes</span><span class="s3">=</span><span class="s1">code_includes</span><span class="s3">):</span>
            <span class="s1">all_exists </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">break</span>
        <span class="s1">img</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">format</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">all_exists </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">if </span><span class="s1">all_exists</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s3">[(</span><span class="s1">code</span><span class="s3">, [</span><span class="s1">img</span><span class="s3">])]</span>

    <span class="s4"># Then look for multi-figure output files</span>
    <span class="s1">results </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">code_piece </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">code_pieces</span><span class="s3">):</span>
        <span class="s1">images </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">count</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">code_pieces</span><span class="s3">) &gt; </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">img </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">(</span><span class="s5">'%s_%02d_%02d' </span><span class="s3">% (</span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">),</span>
                                <span class="s1">output_dir</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">img </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">(</span><span class="s5">'%s_%02d' </span><span class="s3">% (</span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">j</span><span class="s3">), </span><span class="s1">output_dir</span><span class="s3">)</span>
            <span class="s2">for </span><span class="s1">fmt</span><span class="s3">, </span><span class="s1">dpi </span><span class="s2">in </span><span class="s1">formats</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">context </span><span class="s2">or </span><span class="s1">out_of_date</span><span class="s3">(</span><span class="s1">code_path</span><span class="s3">, </span><span class="s1">img</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">),</span>
                                          <span class="s1">includes</span><span class="s3">=</span><span class="s1">code_includes</span><span class="s3">):</span>
                    <span class="s1">all_exists </span><span class="s3">= </span><span class="s2">False</span>
                    <span class="s2">break</span>
                <span class="s1">img</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">)</span>

            <span class="s4"># assume that if we have one, we have them all</span>
            <span class="s2">if not </span><span class="s1">all_exists</span><span class="s3">:</span>
                <span class="s1">all_exists </span><span class="s3">= (</span><span class="s1">j </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">)</span>
                <span class="s2">break</span>
            <span class="s1">images</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">img</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">all_exists</span><span class="s3">:</span>
            <span class="s2">break</span>
        <span class="s1">results</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">code_piece</span><span class="s3">, </span><span class="s1">images</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">all_exists </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s2">if </span><span class="s1">all_exists</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">results</span>

    <span class="s4"># We didn't find the files, so build them</span>

    <span class="s1">results </span><span class="s3">= []</span>
    <span class="s1">ns </span><span class="s3">= </span><span class="s1">plot_context </span><span class="s2">if </span><span class="s1">context </span><span class="s2">else </span><span class="s3">{}</span>

    <span class="s2">if </span><span class="s1">context_reset</span><span class="s3">:</span>
        <span class="s1">clear_state</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_rcparams</span><span class="s3">)</span>
        <span class="s1">plot_context</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>

    <span class="s1">close_figs </span><span class="s3">= </span><span class="s2">not </span><span class="s1">context </span><span class="s2">or </span><span class="s1">close_figs</span>

    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">code_piece </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">code_pieces</span><span class="s3">):</span>

        <span class="s2">if not </span><span class="s1">context </span><span class="s2">or </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_apply_rcparams</span><span class="s3">:</span>
            <span class="s1">clear_state</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_rcparams</span><span class="s3">, </span><span class="s1">close_figs</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">close_figs</span><span class="s3">:</span>
            <span class="s1">plt</span><span class="s3">.</span><span class="s1">close</span><span class="s3">(</span><span class="s5">'all'</span><span class="s3">)</span>

        <span class="s1">_run_code</span><span class="s3">(</span><span class="s1">doctest</span><span class="s3">.</span><span class="s1">script_from_examples</span><span class="s3">(</span><span class="s1">code_piece</span><span class="s3">) </span><span class="s2">if </span><span class="s1">is_doctest</span>
                  <span class="s2">else </span><span class="s1">code_piece</span><span class="s3">,</span>
                  <span class="s1">code_path</span><span class="s3">, </span><span class="s1">ns</span><span class="s3">, </span><span class="s1">function_name</span><span class="s3">)</span>

        <span class="s1">images </span><span class="s3">= []</span>
        <span class="s1">fig_managers </span><span class="s3">= </span><span class="s1">_pylab_helpers</span><span class="s3">.</span><span class="s1">Gcf</span><span class="s3">.</span><span class="s1">get_all_fig_managers</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">j</span><span class="s3">, </span><span class="s1">figman </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">fig_managers</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">fig_managers</span><span class="s3">) == </span><span class="s6">1 </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">code_pieces</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">img </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">(</span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">output_dir</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">len</span><span class="s3">(</span><span class="s1">code_pieces</span><span class="s3">) == </span><span class="s6">1</span><span class="s3">:</span>
                <span class="s1">img </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">(</span><span class="s5">&quot;%s_%02d&quot; </span><span class="s3">% (</span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">j</span><span class="s3">), </span><span class="s1">output_dir</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">img </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">(</span><span class="s5">&quot;%s_%02d_%02d&quot; </span><span class="s3">% (</span><span class="s1">output_base</span><span class="s3">, </span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">),</span>
                                <span class="s1">output_dir</span><span class="s3">)</span>
            <span class="s1">images</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">img</span><span class="s3">)</span>

            <span class="s2">for </span><span class="s1">fmt</span><span class="s3">, </span><span class="s1">dpi </span><span class="s2">in </span><span class="s1">formats</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">figman</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">.</span><span class="s1">savefig</span><span class="s3">(</span><span class="s1">img</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">), </span><span class="s1">dpi</span><span class="s3">=</span><span class="s1">dpi</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">fmt </span><span class="s3">== </span><span class="s1">formats</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">0</span><span class="s3">] </span><span class="s2">and </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_srcset</span><span class="s3">:</span>
                        <span class="s4"># save a 2x, 3x etc version of the default...</span>
                        <span class="s1">srcset </span><span class="s3">= </span><span class="s1">_parse_srcset</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_srcset</span><span class="s3">)</span>
                        <span class="s2">for </span><span class="s1">mult</span><span class="s3">, </span><span class="s1">suffix </span><span class="s2">in </span><span class="s1">srcset</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                            <span class="s1">fm </span><span class="s3">= </span><span class="s5">f'</span><span class="s2">{</span><span class="s1">suffix</span><span class="s2">}</span><span class="s5">.</span><span class="s2">{</span><span class="s1">fmt</span><span class="s2">}</span><span class="s5">'</span>
                            <span class="s1">img</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">fm</span><span class="s3">)</span>
                            <span class="s1">figman</span><span class="s3">.</span><span class="s1">canvas</span><span class="s3">.</span><span class="s1">figure</span><span class="s3">.</span><span class="s1">savefig</span><span class="s3">(</span><span class="s1">img</span><span class="s3">.</span><span class="s1">filename</span><span class="s3">(</span><span class="s1">fm</span><span class="s3">),</span>
                                                         <span class="s1">dpi</span><span class="s3">=</span><span class="s1">int</span><span class="s3">(</span><span class="s1">dpi </span><span class="s3">* </span><span class="s1">mult</span><span class="s3">))</span>
                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">PlotError</span><span class="s3">(</span><span class="s1">traceback</span><span class="s3">.</span><span class="s1">format_exc</span><span class="s3">()) </span><span class="s2">from </span><span class="s1">err</span>
                <span class="s1">img</span><span class="s3">.</span><span class="s1">formats</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">fmt</span><span class="s3">)</span>

        <span class="s1">results</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">code_piece</span><span class="s3">, </span><span class="s1">images</span><span class="s3">))</span>

    <span class="s2">if not </span><span class="s1">context </span><span class="s2">or </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_apply_rcparams</span><span class="s3">:</span>
        <span class="s1">clear_state</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_rcparams</span><span class="s3">, </span><span class="s1">close</span><span class="s3">=</span><span class="s2">not </span><span class="s1">context</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">results</span>


<span class="s2">def </span><span class="s1">run</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">, </span><span class="s1">content</span><span class="s3">, </span><span class="s1">options</span><span class="s3">, </span><span class="s1">state_machine</span><span class="s3">, </span><span class="s1">state</span><span class="s3">, </span><span class="s1">lineno</span><span class="s3">):</span>
    <span class="s1">document </span><span class="s3">= </span><span class="s1">state_machine</span><span class="s3">.</span><span class="s1">document</span>
    <span class="s1">config </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">settings</span><span class="s3">.</span><span class="s1">env</span><span class="s3">.</span><span class="s1">config</span>
    <span class="s1">nofigs </span><span class="s3">= </span><span class="s5">'nofigs' </span><span class="s2">in </span><span class="s1">options</span>

    <span class="s2">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_srcset </span><span class="s2">and </span><span class="s1">setup</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s5">'singlehtml'</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">ExtensionError</span><span class="s3">(</span>
            <span class="s5">'plot_srcset option not compatible with single HTML writer'</span><span class="s3">)</span>

    <span class="s1">formats </span><span class="s3">= </span><span class="s1">get_plot_formats</span><span class="s3">(</span><span class="s1">config</span><span class="s3">)</span>
    <span class="s1">default_fmt </span><span class="s3">= </span><span class="s1">formats</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">0</span><span class="s3">]</span>

    <span class="s1">options</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">'include-source'</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_include_source</span><span class="s3">)</span>
    <span class="s1">options</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">'show-source-link'</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_html_show_source_link</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s5">'class' </span><span class="s2">in </span><span class="s1">options</span><span class="s3">:</span>
        <span class="s4"># classes are parsed into a list of string, and output by simply</span>
        <span class="s4"># printing the list, abusing the fact that RST guarantees to strip</span>
        <span class="s4"># non-conforming characters</span>
        <span class="s1">options</span><span class="s3">[</span><span class="s5">'class'</span><span class="s3">] = [</span><span class="s5">'plot-directive'</span><span class="s3">] + </span><span class="s1">options</span><span class="s3">[</span><span class="s5">'class'</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">options</span><span class="s3">.</span><span class="s1">setdefault</span><span class="s3">(</span><span class="s5">'class'</span><span class="s3">, [</span><span class="s5">'plot-directive'</span><span class="s3">])</span>
    <span class="s1">keep_context </span><span class="s3">= </span><span class="s5">'context' </span><span class="s2">in </span><span class="s1">options</span>
    <span class="s1">context_opt </span><span class="s3">= </span><span class="s2">None if not </span><span class="s1">keep_context </span><span class="s2">else </span><span class="s1">options</span><span class="s3">[</span><span class="s5">'context'</span><span class="s3">]</span>

    <span class="s1">rst_file </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">attributes</span><span class="s3">[</span><span class="s5">'source'</span><span class="s3">]</span>
    <span class="s1">rst_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">rst_file</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">):</span>
        <span class="s2">if not </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_basedir</span><span class="s3">:</span>
            <span class="s1">source_file_name </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">setup</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">builder</span><span class="s3">.</span><span class="s1">srcdir</span><span class="s3">,</span>
                                            <span class="s1">directives</span><span class="s3">.</span><span class="s1">uri</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">source_file_name </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">setup</span><span class="s3">.</span><span class="s1">confdir</span><span class="s3">, </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_basedir</span><span class="s3">,</span>
                                            <span class="s1">directives</span><span class="s3">.</span><span class="s1">uri</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s4"># If there is content, it will be passed as a caption.</span>
        <span class="s1">caption </span><span class="s3">= </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">content</span><span class="s3">)</span>

        <span class="s4"># Enforce unambiguous use of captions.</span>
        <span class="s2">if </span><span class="s5">&quot;caption&quot; </span><span class="s2">in </span><span class="s1">options</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">caption</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                    <span class="s5">'Caption specified in both content and options.'</span>
                    <span class="s5">' Please remove ambiguity.'</span>
                <span class="s3">)</span>
            <span class="s4"># Use caption option</span>
            <span class="s1">caption </span><span class="s3">= </span><span class="s1">options</span><span class="s3">[</span><span class="s5">&quot;caption&quot;</span><span class="s3">]</span>

        <span class="s4"># If the optional function name is provided, use it</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">arguments</span><span class="s3">) == </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">function_name </span><span class="s3">= </span><span class="s1">arguments</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">function_name </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">code </span><span class="s3">= </span><span class="s1">Path</span><span class="s3">(</span><span class="s1">source_file_name</span><span class="s3">).</span><span class="s1">read_text</span><span class="s3">(</span><span class="s1">encoding</span><span class="s3">=</span><span class="s5">'utf-8'</span><span class="s3">)</span>
        <span class="s1">output_base </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">source_file_name</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">source_file_name </span><span class="s3">= </span><span class="s1">rst_file</span>
        <span class="s1">code </span><span class="s3">= </span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">dedent</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">map</span><span class="s3">(</span><span class="s1">str</span><span class="s3">, </span><span class="s1">content</span><span class="s3">)))</span>
        <span class="s1">counter </span><span class="s3">= </span><span class="s1">document</span><span class="s3">.</span><span class="s1">attributes</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'_plot_counter'</span><span class="s3">, </span><span class="s6">0</span><span class="s3">) + </span><span class="s6">1</span>
        <span class="s1">document</span><span class="s3">.</span><span class="s1">attributes</span><span class="s3">[</span><span class="s5">'_plot_counter'</span><span class="s3">] = </span><span class="s1">counter</span>
        <span class="s1">base</span><span class="s3">, </span><span class="s1">ext </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">basename</span><span class="s3">(</span><span class="s1">source_file_name</span><span class="s3">))</span>
        <span class="s1">output_base </span><span class="s3">= </span><span class="s5">'%s-%d.py' </span><span class="s3">% (</span><span class="s1">base</span><span class="s3">, </span><span class="s1">counter</span><span class="s3">)</span>
        <span class="s1">function_name </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">caption </span><span class="s3">= </span><span class="s1">options</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">'caption'</span><span class="s3">, </span><span class="s5">''</span><span class="s3">)</span>

    <span class="s1">base</span><span class="s3">, </span><span class="s1">source_ext </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">splitext</span><span class="s3">(</span><span class="s1">output_base</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">source_ext </span><span class="s2">in </span><span class="s3">(</span><span class="s5">'.py'</span><span class="s3">, </span><span class="s5">'.rst'</span><span class="s3">, </span><span class="s5">'.txt'</span><span class="s3">):</span>
        <span class="s1">output_base </span><span class="s3">= </span><span class="s1">base</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">source_ext </span><span class="s3">= </span><span class="s5">''</span>

    <span class="s4"># ensure that LaTeX includegraphics doesn't choke in foo.bar.pdf filenames</span>
    <span class="s1">output_base </span><span class="s3">= </span><span class="s1">output_base</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s5">'.'</span><span class="s3">, </span><span class="s5">'-'</span><span class="s3">)</span>

    <span class="s4"># is it in doctest format?</span>
    <span class="s1">is_doctest </span><span class="s3">= </span><span class="s1">contains_doctest</span><span class="s3">(</span><span class="s1">code</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s5">'format' </span><span class="s2">in </span><span class="s1">options</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">options</span><span class="s3">[</span><span class="s5">'format'</span><span class="s3">] == </span><span class="s5">'python'</span><span class="s3">:</span>
            <span class="s1">is_doctest </span><span class="s3">= </span><span class="s2">False</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">is_doctest </span><span class="s3">= </span><span class="s2">True</span>

    <span class="s4"># determine output directory name fragment</span>
    <span class="s1">source_rel_name </span><span class="s3">= </span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">source_file_name</span><span class="s3">, </span><span class="s1">setup</span><span class="s3">.</span><span class="s1">confdir</span><span class="s3">)</span>
    <span class="s1">source_rel_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">source_rel_name</span><span class="s3">).</span><span class="s1">lstrip</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">)</span>

    <span class="s4"># build_dir: where to place output files (temporarily)</span>
    <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">setup</span><span class="s3">.</span><span class="s1">app</span><span class="s3">.</span><span class="s1">doctreedir</span><span class="s3">),</span>
                             <span class="s5">'plot_directive'</span><span class="s3">,</span>
                             <span class="s1">source_rel_dir</span><span class="s3">)</span>
    <span class="s4"># get rid of .. in paths, also changes pathsep</span>
    <span class="s4"># see note in Python docs for warning about symbolic links on Windows.</span>
    <span class="s4"># need to compare source and dest paths at end</span>
    <span class="s1">build_dir </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">normpath</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">)</span>
    <span class="s1">os</span><span class="s3">.</span><span class="s1">makedirs</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">exist_ok</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s4"># how to link to files from the RST file</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">build_dir_link </span><span class="s3">= </span><span class="s1">relpath</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">rst_dir</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">sep</span><span class="s3">, </span><span class="s5">'/'</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
        <span class="s4"># on Windows, relpath raises ValueError when path and start are on</span>
        <span class="s4"># different mounts/drives</span>
        <span class="s1">build_dir_link </span><span class="s3">= </span><span class="s1">build_dir</span>

    <span class="s4"># get list of included rst files so that the output is updated when any</span>
    <span class="s4"># plots in the included files change. These attributes are modified by the</span>
    <span class="s4"># include directive (see the docutils.parsers.rst.directives.misc module).</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">source_file_includes </span><span class="s3">= [</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getcwd</span><span class="s3">(), </span><span class="s1">t</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
                                <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">state</span><span class="s3">.</span><span class="s1">document</span><span class="s3">.</span><span class="s1">include_log</span><span class="s3">]</span>
    <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
        <span class="s4"># the document.include_log attribute only exists in docutils &gt;=0.17,</span>
        <span class="s4"># before that we need to inspect the state machine</span>
        <span class="s1">possible_sources </span><span class="s3">= {</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">setup</span><span class="s3">.</span><span class="s1">confdir</span><span class="s3">, </span><span class="s1">t</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
                            <span class="s2">for </span><span class="s1">t </span><span class="s2">in </span><span class="s1">state_machine</span><span class="s3">.</span><span class="s1">input_lines</span><span class="s3">.</span><span class="s1">items</span><span class="s3">}</span>
        <span class="s1">source_file_includes </span><span class="s3">= [</span><span class="s1">f </span><span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">possible_sources</span>
                                <span class="s2">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)]</span>
    <span class="s4"># remove the source file itself from the includes</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">source_file_includes</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">source_file_name</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
        <span class="s2">pass</span>

    <span class="s4"># save script (if necessary)</span>
    <span class="s2">if </span><span class="s1">options</span><span class="s3">[</span><span class="s5">'show-source-link'</span><span class="s3">]:</span>
        <span class="s1">Path</span><span class="s3">(</span><span class="s1">build_dir</span><span class="s3">, </span><span class="s1">output_base </span><span class="s3">+ </span><span class="s1">source_ext</span><span class="s3">).</span><span class="s1">write_text</span><span class="s3">(</span>
            <span class="s1">doctest</span><span class="s3">.</span><span class="s1">script_from_examples</span><span class="s3">(</span><span class="s1">code</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">source_file_name </span><span class="s3">== </span><span class="s1">rst_file </span><span class="s2">and </span><span class="s1">is_doctest</span>
            <span class="s2">else </span><span class="s1">code</span><span class="s3">,</span>
            <span class="s1">encoding</span><span class="s3">=</span><span class="s5">'utf-8'</span><span class="s3">)</span>

    <span class="s4"># make figures</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">results </span><span class="s3">= </span><span class="s1">render_figures</span><span class="s3">(</span><span class="s1">code</span><span class="s3">=</span><span class="s1">code</span><span class="s3">,</span>
                                 <span class="s1">code_path</span><span class="s3">=</span><span class="s1">source_file_name</span><span class="s3">,</span>
                                 <span class="s1">output_dir</span><span class="s3">=</span><span class="s1">build_dir</span><span class="s3">,</span>
                                 <span class="s1">output_base</span><span class="s3">=</span><span class="s1">output_base</span><span class="s3">,</span>
                                 <span class="s1">context</span><span class="s3">=</span><span class="s1">keep_context</span><span class="s3">,</span>
                                 <span class="s1">function_name</span><span class="s3">=</span><span class="s1">function_name</span><span class="s3">,</span>
                                 <span class="s1">config</span><span class="s3">=</span><span class="s1">config</span><span class="s3">,</span>
                                 <span class="s1">context_reset</span><span class="s3">=</span><span class="s1">context_opt </span><span class="s3">== </span><span class="s5">'reset'</span><span class="s3">,</span>
                                 <span class="s1">close_figs</span><span class="s3">=</span><span class="s1">context_opt </span><span class="s3">== </span><span class="s5">'close-figs'</span><span class="s3">,</span>
                                 <span class="s1">code_includes</span><span class="s3">=</span><span class="s1">source_file_includes</span><span class="s3">)</span>
        <span class="s1">errors </span><span class="s3">= []</span>
    <span class="s2">except </span><span class="s1">PlotError </span><span class="s2">as </span><span class="s1">err</span><span class="s3">:</span>
        <span class="s1">reporter </span><span class="s3">= </span><span class="s1">state</span><span class="s3">.</span><span class="s1">memo</span><span class="s3">.</span><span class="s1">reporter</span>
        <span class="s1">sm </span><span class="s3">= </span><span class="s1">reporter</span><span class="s3">.</span><span class="s1">system_message</span><span class="s3">(</span>
            <span class="s6">2</span><span class="s3">, </span><span class="s5">&quot;Exception occurred in plotting {}</span><span class="s2">\n </span><span class="s5">from {}:</span><span class="s2">\n</span><span class="s5">{}&quot;</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span>
                <span class="s1">output_base</span><span class="s3">, </span><span class="s1">source_file_name</span><span class="s3">, </span><span class="s1">err</span><span class="s3">),</span>
            <span class="s1">line</span><span class="s3">=</span><span class="s1">lineno</span><span class="s3">)</span>
        <span class="s1">results </span><span class="s3">= [(</span><span class="s1">code</span><span class="s3">, [])]</span>
        <span class="s1">errors </span><span class="s3">= [</span><span class="s1">sm</span><span class="s3">]</span>

    <span class="s4"># Properly indent the caption</span>
    <span class="s2">if </span><span class="s1">caption </span><span class="s2">and </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_srcset</span><span class="s3">:</span>
        <span class="s1">caption </span><span class="s3">= </span><span class="s5">f':caption: </span><span class="s2">{</span><span class="s1">caption</span><span class="s2">}</span><span class="s5">'</span>
    <span class="s2">elif </span><span class="s1">caption</span><span class="s3">:</span>
        <span class="s1">caption </span><span class="s3">= </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">' </span><span class="s3">+ </span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s5">'      ' </span><span class="s3">+ </span><span class="s1">line</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">()</span>
                                   <span class="s2">for </span><span class="s1">line </span><span class="s2">in </span><span class="s1">caption</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">'</span><span class="s2">\n</span><span class="s5">'</span><span class="s3">))</span>
    <span class="s4"># generate output restructuredtext</span>
    <span class="s1">total_lines </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">j</span><span class="s3">, (</span><span class="s1">code_piece</span><span class="s3">, </span><span class="s1">images</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">results</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">options</span><span class="s3">[</span><span class="s5">'include-source'</span><span class="s3">]:</span>
            <span class="s2">if </span><span class="s1">is_doctest</span><span class="s3">:</span>
                <span class="s1">lines </span><span class="s3">= [</span><span class="s5">''</span><span class="s3">, *</span><span class="s1">code_piece</span><span class="s3">.</span><span class="s1">splitlines</span><span class="s3">()]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">lines </span><span class="s3">= [</span><span class="s5">'.. code-block:: python'</span><span class="s3">, </span><span class="s5">''</span><span class="s3">,</span>
                         <span class="s3">*</span><span class="s1">textwrap</span><span class="s3">.</span><span class="s1">indent</span><span class="s3">(</span><span class="s1">code_piece</span><span class="s3">, </span><span class="s5">'    '</span><span class="s3">).</span><span class="s1">splitlines</span><span class="s3">()]</span>
            <span class="s1">source_code </span><span class="s3">= </span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">lines</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">source_code </span><span class="s3">= </span><span class="s5">&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">nofigs</span><span class="s3">:</span>
            <span class="s1">images </span><span class="s3">= []</span>

        <span class="s1">opts </span><span class="s3">= [</span>
            <span class="s5">f':</span><span class="s2">{</span><span class="s1">key</span><span class="s2">}</span><span class="s5">: </span><span class="s2">{</span><span class="s1">val</span><span class="s2">}</span><span class="s5">' </span><span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">val </span><span class="s2">in </span><span class="s1">options</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">key </span><span class="s2">in </span><span class="s3">(</span><span class="s5">'alt'</span><span class="s3">, </span><span class="s5">'height'</span><span class="s3">, </span><span class="s5">'width'</span><span class="s3">, </span><span class="s5">'scale'</span><span class="s3">, </span><span class="s5">'align'</span><span class="s3">, </span><span class="s5">'class'</span><span class="s3">)]</span>

        <span class="s4"># Not-None src_name signals the need for a source download in the</span>
        <span class="s4"># generated html</span>
        <span class="s2">if </span><span class="s1">j </span><span class="s3">== </span><span class="s6">0 </span><span class="s2">and </span><span class="s1">options</span><span class="s3">[</span><span class="s5">'show-source-link'</span><span class="s3">]:</span>
            <span class="s1">src_name </span><span class="s3">= </span><span class="s1">output_base </span><span class="s3">+ </span><span class="s1">source_ext</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">src_name </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_srcset</span><span class="s3">:</span>
            <span class="s1">srcset </span><span class="s3">= [*</span><span class="s1">_parse_srcset</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_srcset</span><span class="s3">).</span><span class="s1">values</span><span class="s3">()]</span>
            <span class="s1">template </span><span class="s3">= </span><span class="s1">TEMPLATE_SRCSET</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">srcset </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">template </span><span class="s3">= </span><span class="s1">TEMPLATE</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">jinja2</span><span class="s3">.</span><span class="s1">Template</span><span class="s3">(</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_template </span><span class="s2">or </span><span class="s1">template</span><span class="s3">).</span><span class="s1">render</span><span class="s3">(</span>
            <span class="s1">default_fmt</span><span class="s3">=</span><span class="s1">default_fmt</span><span class="s3">,</span>
            <span class="s1">build_dir</span><span class="s3">=</span><span class="s1">build_dir_link</span><span class="s3">,</span>
            <span class="s1">src_name</span><span class="s3">=</span><span class="s1">src_name</span><span class="s3">,</span>
            <span class="s1">multi_image</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">images</span><span class="s3">) &gt; </span><span class="s6">1</span><span class="s3">,</span>
            <span class="s1">options</span><span class="s3">=</span><span class="s1">opts</span><span class="s3">,</span>
            <span class="s1">srcset</span><span class="s3">=</span><span class="s1">srcset</span><span class="s3">,</span>
            <span class="s1">images</span><span class="s3">=</span><span class="s1">images</span><span class="s3">,</span>
            <span class="s1">source_code</span><span class="s3">=</span><span class="s1">source_code</span><span class="s3">,</span>
            <span class="s1">html_show_formats</span><span class="s3">=</span><span class="s1">config</span><span class="s3">.</span><span class="s1">plot_html_show_formats </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">images</span><span class="s3">),</span>
            <span class="s1">caption</span><span class="s3">=</span><span class="s1">caption</span><span class="s3">)</span>
        <span class="s1">total_lines</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">))</span>
        <span class="s1">total_lines</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s5">&quot;</span><span class="s2">\n</span><span class="s5">&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">total_lines</span><span class="s3">:</span>
        <span class="s1">state_machine</span><span class="s3">.</span><span class="s1">insert_input</span><span class="s3">(</span><span class="s1">total_lines</span><span class="s3">, </span><span class="s1">source</span><span class="s3">=</span><span class="s1">source_file_name</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">errors</span>
</pre>
</body>
</html>