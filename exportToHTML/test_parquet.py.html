<html>
<head>
<title>test_parquet.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_parquet.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; test parquet compat &quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">datetime</span>
<span class="s2">from </span><span class="s1">decimal </span><span class="s2">import </span><span class="s1">Decimal</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">BytesIO</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">pathlib</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_config </span><span class="s2">import </span><span class="s1">using_copy_on_write</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_config</span><span class="s3">.</span><span class="s1">config </span><span class="s2">import </span><span class="s1">_get_option</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">compat </span><span class="s2">import </span><span class="s1">is_platform_windows</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">compat</span><span class="s3">.</span><span class="s1">pyarrow </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">pa_version_under11p0</span><span class="s3">,</span>
    <span class="s1">pa_version_under13p0</span><span class="s3">,</span>
    <span class="s1">pa_version_under15p0</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">as </span><span class="s1">tm</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">version </span><span class="s2">import </span><span class="s1">Version</span>

<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">parquet </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">FastParquetImpl</span><span class="s3">,</span>
    <span class="s1">PyArrowImpl</span><span class="s3">,</span>
    <span class="s1">get_engine</span><span class="s3">,</span>
    <span class="s1">read_parquet</span><span class="s3">,</span>
    <span class="s1">to_parquet</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">pyarrow</span>

    <span class="s1">_HAVE_PYARROW </span><span class="s3">= </span><span class="s2">True</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">_HAVE_PYARROW </span><span class="s3">= </span><span class="s2">False</span>

<span class="s2">try</span><span class="s3">:</span>
    <span class="s2">import </span><span class="s1">fastparquet</span>

    <span class="s1">_HAVE_FASTPARQUET </span><span class="s3">= </span><span class="s2">True</span>
<span class="s2">except </span><span class="s1">ImportError</span><span class="s3">:</span>
    <span class="s1">_HAVE_FASTPARQUET </span><span class="s3">= </span><span class="s2">False</span>


<span class="s4"># TODO(ArrayManager) fastparquet relies on BlockManager internals</span>

<span class="s1">pytestmark </span><span class="s3">= [</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s5">&quot;ignore:DataFrame._data is deprecated:FutureWarning&quot;</span><span class="s3">),</span>
    <span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span>
        <span class="s5">&quot;ignore:Passing a BlockManager to DataFrame:DeprecationWarning&quot;</span>
    <span class="s3">),</span>
<span class="s3">]</span>


<span class="s4"># setup engines &amp; skips</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span>
    <span class="s1">params</span><span class="s3">=[</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">param</span><span class="s3">(</span>
            <span class="s5">&quot;fastparquet&quot;</span><span class="s3">,</span>
            <span class="s1">marks</span><span class="s3">=</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span>
                <span class="s2">not </span><span class="s1">_HAVE_FASTPARQUET</span>
                <span class="s2">or </span><span class="s1">_get_option</span><span class="s3">(</span><span class="s5">&quot;mode.data_manager&quot;</span><span class="s3">, </span><span class="s1">silent</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) == </span><span class="s5">&quot;array&quot;</span><span class="s3">,</span>
                <span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;fastparquet is not installed or ArrayManager is used&quot;</span><span class="s3">,</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">param</span><span class="s3">(</span>
            <span class="s5">&quot;pyarrow&quot;</span><span class="s3">,</span>
            <span class="s1">marks</span><span class="s3">=</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span>
                <span class="s2">not </span><span class="s1">_HAVE_PYARROW</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;pyarrow is not installed&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
    <span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">engine</span><span class="s3">(</span><span class="s1">request</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">pa</span><span class="s3">():</span>
    <span class="s2">if not </span><span class="s1">_HAVE_PYARROW</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">&quot;pyarrow is not installed&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s5">&quot;pyarrow&quot;</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">fp</span><span class="s3">():</span>
    <span class="s2">if not </span><span class="s1">_HAVE_FASTPARQUET</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">&quot;fastparquet is not installed&quot;</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">_get_option</span><span class="s3">(</span><span class="s5">&quot;mode.data_manager&quot;</span><span class="s3">, </span><span class="s1">silent</span><span class="s3">=</span><span class="s2">True</span><span class="s3">) == </span><span class="s5">&quot;array&quot;</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">&quot;ArrayManager is not supported with fastparquet&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s5">&quot;fastparquet&quot;</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">df_compat</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s5">&quot;B&quot;</span><span class="s3">: </span><span class="s5">&quot;foo&quot;</span><span class="s3">})</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">df_cross_compat</span><span class="s3">():</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;b&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)),</span>
            <span class="s4"># 'c': np.arange(3, 6).astype('u1'),</span>
            <span class="s5">&quot;d&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">7.0</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;float64&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;e&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">],</span>
            <span class="s5">&quot;f&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">),</span>
            <span class="s4"># 'g': pd.date_range('20130101', periods=3,</span>
            <span class="s4">#                    tz='US/Eastern'),</span>
            <span class="s4"># 'h': pd.date_range('20130101', periods=3, freq='ns')</span>
        <span class="s3">}</span>
    <span class="s3">)</span>
    <span class="s2">return </span><span class="s1">df</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span>
<span class="s2">def </span><span class="s1">df_full</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
        <span class="s3">{</span>
            <span class="s5">&quot;string&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;string_with_nan&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;string_with_none&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;bytes&quot;</span><span class="s3">: [</span><span class="s7">b&quot;foo&quot;</span><span class="s3">, </span><span class="s7">b&quot;bar&quot;</span><span class="s3">, </span><span class="s7">b&quot;baz&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;unicode&quot;</span><span class="s3">: [</span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">],</span>
            <span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)),</span>
            <span class="s5">&quot;uint&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">3</span><span class="s3">, </span><span class="s6">6</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s5">&quot;u1&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;float&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">4.0</span><span class="s3">, </span><span class="s6">7.0</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;float64&quot;</span><span class="s3">),</span>
            <span class="s5">&quot;float_with_nan&quot;</span><span class="s3">: [</span><span class="s6">2.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">],</span>
            <span class="s5">&quot;bool&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">],</span>
            <span class="s5">&quot;datetime&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">),</span>
            <span class="s5">&quot;datetime_with_nat&quot;</span><span class="s3">: [</span>
                <span class="s1">pd</span><span class="s3">.</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">),</span>
                <span class="s1">pd</span><span class="s3">.</span><span class="s1">NaT</span><span class="s3">,</span>
                <span class="s1">pd</span><span class="s3">.</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">&quot;20130103&quot;</span><span class="s3">),</span>
            <span class="s3">],</span>
        <span class="s3">}</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span>
    <span class="s1">params</span><span class="s3">=[</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">(</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timezone</span><span class="s3">.</span><span class="s1">utc</span><span class="s3">),</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">(</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timezone</span><span class="s3">.</span><span class="s1">min</span><span class="s3">),</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">now</span><span class="s3">(</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timezone</span><span class="s3">.</span><span class="s1">max</span><span class="s3">),</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">strptime</span><span class="s3">(</span><span class="s5">&quot;2019-01-04T16:41:24+0200&quot;</span><span class="s3">, </span><span class="s5">&quot;%Y-%m-%dT%H:%M:%S%z&quot;</span><span class="s3">),</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">strptime</span><span class="s3">(</span><span class="s5">&quot;2019-01-04T16:41:24+0215&quot;</span><span class="s3">, </span><span class="s5">&quot;%Y-%m-%dT%H:%M:%S%z&quot;</span><span class="s3">),</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">strptime</span><span class="s3">(</span><span class="s5">&quot;2019-01-04T16:41:24-0200&quot;</span><span class="s3">, </span><span class="s5">&quot;%Y-%m-%dT%H:%M:%S%z&quot;</span><span class="s3">),</span>
        <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">strptime</span><span class="s3">(</span><span class="s5">&quot;2019-01-04T16:41:24-0215&quot;</span><span class="s3">, </span><span class="s5">&quot;%Y-%m-%dT%H:%M:%S%z&quot;</span><span class="s3">),</span>
    <span class="s3">]</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">timezone_aware_date_list</span><span class="s3">(</span><span class="s1">request</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span>


<span class="s2">def </span><span class="s1">check_round_trip</span><span class="s3">(</span>
    <span class="s1">df</span><span class="s3">,</span>
    <span class="s1">engine</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">path</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">write_kwargs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">read_kwargs</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">expected</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
    <span class="s1">check_names</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s1">check_like</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
    <span class="s1">check_dtype</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
    <span class="s1">repeat</span><span class="s3">=</span><span class="s6">2</span><span class="s3">,</span>
<span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Verify parquet serializer and deserializer produce the same results. 
 
    Performs a pandas to disk and disk to pandas round trip, 
    then compares the 2 resulting DataFrames to verify equality. 
 
    Parameters 
    ---------- 
    df: Dataframe 
    engine: str, optional 
        'pyarrow' or 'fastparquet' 
    path: str, optional 
    write_kwargs: dict of str:str, optional 
    read_kwargs: dict of str:str, optional 
    expected: DataFrame, optional 
        Expected deserialization result, otherwise will be equal to `df` 
    check_names: list of str, optional 
        Closed set of column names to be compared 
    check_like: bool, optional 
        If True, ignore the order of index &amp; columns. 
    repeat: int, optional 
        How many times to repeat the test 
    &quot;&quot;&quot;</span>
    <span class="s1">write_kwargs </span><span class="s3">= </span><span class="s1">write_kwargs </span><span class="s2">or </span><span class="s3">{</span><span class="s5">&quot;compression&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">}</span>
    <span class="s1">read_kwargs </span><span class="s3">= </span><span class="s1">read_kwargs </span><span class="s2">or </span><span class="s3">{}</span>

    <span class="s2">if </span><span class="s1">expected </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span>

    <span class="s2">if </span><span class="s1">engine</span><span class="s3">:</span>
        <span class="s1">write_kwargs</span><span class="s3">[</span><span class="s5">&quot;engine&quot;</span><span class="s3">] = </span><span class="s1">engine</span>
        <span class="s1">read_kwargs</span><span class="s3">[</span><span class="s5">&quot;engine&quot;</span><span class="s3">] = </span><span class="s1">engine</span>

    <span class="s2">def </span><span class="s1">compare</span><span class="s3">(</span><span class="s1">repeat</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">repeat</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, **</span><span class="s1">write_kwargs</span><span class="s3">)</span>
            <span class="s1">actual </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, **</span><span class="s1">read_kwargs</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s5">&quot;string_with_nan&quot; </span><span class="s2">in </span><span class="s1">expected</span><span class="s3">:</span>
                <span class="s1">expected</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s5">&quot;string_with_nan&quot;</span><span class="s3">] = </span><span class="s2">None</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span>
                <span class="s1">expected</span><span class="s3">,</span>
                <span class="s1">actual</span><span class="s3">,</span>
                <span class="s1">check_names</span><span class="s3">=</span><span class="s1">check_names</span><span class="s3">,</span>
                <span class="s1">check_like</span><span class="s3">=</span><span class="s1">check_like</span><span class="s3">,</span>
                <span class="s1">check_dtype</span><span class="s3">=</span><span class="s1">check_dtype</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">path </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">compare</span><span class="s3">(</span><span class="s1">repeat</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">compare</span><span class="s3">(</span><span class="s1">repeat</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_partition_names</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check partitions of a parquet file are as expected. 
 
    Parameters 
    ---------- 
    path: str 
        Path of the dataset. 
    expected: iterable of str 
        Expected partition names. 
    &quot;&quot;&quot;</span>
    <span class="s2">import </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">dataset </span><span class="s2">as </span><span class="s1">ds</span>

    <span class="s1">dataset </span><span class="s3">= </span><span class="s1">ds</span><span class="s3">.</span><span class="s1">dataset</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">partitioning</span><span class="s3">=</span><span class="s5">&quot;hive&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dataset</span><span class="s3">.</span><span class="s1">partitioning</span><span class="s3">.</span><span class="s1">schema</span><span class="s3">.</span><span class="s1">names </span><span class="s3">== </span><span class="s1">expected</span>


<span class="s2">def </span><span class="s1">test_invalid_engine</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">):</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;engine must be one of 'pyarrow', 'fastparquet'&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_options_py</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
    <span class="s4"># use the set option</span>

    <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;io.parquet.engine&quot;</span><span class="s3">, </span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">):</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_options_fp</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
    <span class="s4"># use the set option</span>

    <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;io.parquet.engine&quot;</span><span class="s3">, </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">):</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_options_auto</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
    <span class="s4"># use the set option</span>

    <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;io.parquet.engine&quot;</span><span class="s3">, </span><span class="s5">&quot;auto&quot;</span><span class="s3">):</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_options_get_engine</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">), </span><span class="s1">PyArrowImpl</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">), </span><span class="s1">FastParquetImpl</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;io.parquet.engine&quot;</span><span class="s3">, </span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">), </span><span class="s1">PyArrowImpl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">), </span><span class="s1">PyArrowImpl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">), </span><span class="s1">FastParquetImpl</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;io.parquet.engine&quot;</span><span class="s3">, </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">), </span><span class="s1">FastParquetImpl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">), </span><span class="s1">PyArrowImpl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">), </span><span class="s1">FastParquetImpl</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;io.parquet.engine&quot;</span><span class="s3">, </span><span class="s5">&quot;auto&quot;</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">), </span><span class="s1">PyArrowImpl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">), </span><span class="s1">PyArrowImpl</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">), </span><span class="s1">FastParquetImpl</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_get_engine_auto_error_message</span><span class="s3">():</span>
    <span class="s4"># Expect different error messages from get_engine(engine=&quot;auto&quot;)</span>
    <span class="s4"># if engines aren't installed vs. are installed but bad version</span>
    <span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">compat</span><span class="s3">.</span><span class="s1">_optional </span><span class="s2">import </span><span class="s1">VERSIONS</span>

    <span class="s4"># Do we have engines installed, but a bad version of them?</span>
    <span class="s1">pa_min_ver </span><span class="s3">= </span><span class="s1">VERSIONS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
    <span class="s1">fp_min_ver </span><span class="s3">= </span><span class="s1">VERSIONS</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">)</span>
    <span class="s1">have_pa_bad_version </span><span class="s3">= (</span>
        <span class="s2">False</span>
        <span class="s2">if not </span><span class="s1">_HAVE_PYARROW</span>
        <span class="s2">else </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &lt; </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">pa_min_ver</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s1">have_fp_bad_version </span><span class="s3">= (</span>
        <span class="s2">False</span>
        <span class="s2">if not </span><span class="s1">_HAVE_FASTPARQUET</span>
        <span class="s2">else </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">fastparquet</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &lt; </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">fp_min_ver</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s4"># Do we have usable engines installed?</span>
    <span class="s1">have_usable_pa </span><span class="s3">= </span><span class="s1">_HAVE_PYARROW </span><span class="s2">and not </span><span class="s1">have_pa_bad_version</span>
    <span class="s1">have_usable_fp </span><span class="s3">= </span><span class="s1">_HAVE_FASTPARQUET </span><span class="s2">and not </span><span class="s1">have_fp_bad_version</span>

    <span class="s2">if not </span><span class="s1">have_usable_pa </span><span class="s2">and not </span><span class="s1">have_usable_fp</span><span class="s3">:</span>
        <span class="s4"># No usable engines found.</span>
        <span class="s2">if </span><span class="s1">have_pa_bad_version</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s5">f&quot;Pandas requires version .</span><span class="s2">{</span><span class="s1">pa_min_ver</span><span class="s2">}</span><span class="s5">. or newer of .pyarrow.&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
                <span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s5">&quot;Missing optional dependency .pyarrow.&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
                <span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">have_fp_bad_version</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s5">f&quot;Pandas requires version .</span><span class="s2">{</span><span class="s1">fp_min_ver</span><span class="s2">}</span><span class="s5">. or newer of .fastparquet.&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
                <span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s5">&quot;Missing optional dependency .fastparquet.&quot;</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ImportError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">match</span><span class="s3">):</span>
                <span class="s1">get_engine</span><span class="s3">(</span><span class="s5">&quot;auto&quot;</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cross_engine_pa_fp</span><span class="s3">(</span><span class="s1">df_cross_compat</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
    <span class="s4"># cross-compat with differing reading/writing engines</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">df_cross_compat</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">fp</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">[[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">test_cross_engine_fp_pa</span><span class="s3">(</span><span class="s1">df_cross_compat</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
    <span class="s4"># cross-compat with differing reading/writing engines</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">df_cross_compat</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">[[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">test_parquet_pos_args_deprecation</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">):</span>
    <span class="s4"># GH-54229</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]})</span>
    <span class="s1">msg </span><span class="s3">= (</span>
        <span class="s5">r&quot;Starting with pandas version 3.0 all arguments of to_parquet except for the &quot;</span>
        <span class="s5">r&quot;argument 'path' will be keyword-only.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span>
            <span class="s1">FutureWarning</span><span class="s3">,</span>
            <span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">,</span>
            <span class="s1">check_stacklevel</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
            <span class="s1">raise_on_extra_warnings</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">Base</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s4"># check that we are raising the exception on writing</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
                <span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_external_error_on_write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">exc</span><span class="s3">):</span>
        <span class="s4"># check that an external library is raising the exception on writing</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">external_error_raised</span><span class="s3">(</span><span class="s1">exc</span><span class="s3">):</span>
                <span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">network</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">single_cpu</span>
    <span class="s2">def </span><span class="s1">test_parquet_read_from_url</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">httpserver</span><span class="s3">, </span><span class="s1">datapath</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">engine </span><span class="s3">!= </span><span class="s5">&quot;auto&quot;</span><span class="s3">:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">datapath</span><span class="s3">(</span><span class="s5">&quot;io&quot;</span><span class="s3">, </span><span class="s5">&quot;data&quot;</span><span class="s3">, </span><span class="s5">&quot;parquet&quot;</span><span class="s3">, </span><span class="s5">&quot;simple.parquet&quot;</span><span class="s3">), </span><span class="s1">mode</span><span class="s3">=</span><span class="s5">&quot;rb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
            <span class="s1">httpserver</span><span class="s3">.</span><span class="s1">serve_content</span><span class="s3">(</span><span class="s1">content</span><span class="s3">=</span><span class="s1">f</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">httpserver</span><span class="s3">.</span><span class="s1">url</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestBasic</span><span class="s3">(</span><span class="s1">Base</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">test_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s3">[</span>
            <span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]),</span>
            <span class="s6">1</span><span class="s3">,</span>
            <span class="s5">&quot;foo&quot;</span><span class="s3">,</span>
            <span class="s1">pd</span><span class="s3">.</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">),</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]),</span>
        <span class="s3">]:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;to_parquet only supports IO with DataFrames&quot;</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">obj</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_columns_dtypes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;string&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">), </span><span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))})</span>

        <span class="s4"># unicode</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">]</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;compression&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;gzip&quot;</span><span class="s3">, </span><span class="s5">&quot;snappy&quot;</span><span class="s3">, </span><span class="s5">&quot;brotli&quot;</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_compression</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">write_kwargs</span><span class="s3">={</span><span class="s5">&quot;compression&quot;</span><span class="s3">: </span><span class="s1">compression</span><span class="s3">})</span>

    <span class="s2">def </span><span class="s1">test_read_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s4"># GH18154</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;string&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">), </span><span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))})</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;string&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">)})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;columns&quot;</span><span class="s3">: [</span><span class="s5">&quot;string&quot;</span><span class="s3">]}</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_filters</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">4</span><span class="s3">)),</span>
                <span class="s5">&quot;part&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;aabb&quot;</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;int&quot;</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">,</span>
            <span class="s1">engine</span><span class="s3">,</span>
            <span class="s1">path</span><span class="s3">=</span><span class="s1">tmp_path</span><span class="s3">,</span>
            <span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">,</span>
            <span class="s1">write_kwargs</span><span class="s3">={</span><span class="s5">&quot;partition_cols&quot;</span><span class="s3">: [</span><span class="s5">&quot;part&quot;</span><span class="s3">]},</span>
            <span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;filters&quot;</span><span class="s3">: [(</span><span class="s5">&quot;part&quot;</span><span class="s3">, </span><span class="s5">&quot;==&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">)], </span><span class="s5">&quot;columns&quot;</span><span class="s3">: [</span><span class="s5">&quot;int&quot;</span><span class="s3">]},</span>
            <span class="s1">repeat</span><span class="s3">=</span><span class="s6">1</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s1">check_names </span><span class="s3">= </span><span class="s1">engine </span><span class="s3">!= </span><span class="s5">&quot;fastparquet&quot;</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

        <span class="s1">indexes </span><span class="s3">= [</span>
            <span class="s3">[</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">],</span>
            <span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">),</span>
            <span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">),</span>
            <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">],</span>
        <span class="s3">]</span>
        <span class="s4"># non-default index</span>
        <span class="s2">for </span><span class="s1">index </span><span class="s2">in </span><span class="s1">indexes</span><span class="s3">:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">index</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">index</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DatetimeIndex</span><span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">_with_freq</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)  </span><span class="s4"># freq doesn't round-trip</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">check_names</span><span class="s3">=</span><span class="s1">check_names</span><span class="s3">)</span>

        <span class="s4"># index with meta-data</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;foo&quot;</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_multiindex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># Not supported in fastparquet as of 0.1.3 or older pyarrow version</span>
        <span class="s1">engine </span><span class="s3">= </span><span class="s1">pa</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]})</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">([(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), (</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), (</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)])</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">index</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_multiindex_with_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s1">engine </span><span class="s3">= </span><span class="s1">pa</span>
        <span class="s1">dates </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;01-Jan-2018&quot;</span><span class="s3">, </span><span class="s5">&quot;01-Dec-2018&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s5">&quot;MS&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">2 </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">dates</span><span class="s3">), </span><span class="s6">3</span><span class="s3">)),</span>
            <span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;ABC&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">index1 </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_product</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">&quot;Level1&quot;</span><span class="s3">, </span><span class="s5">&quot;Level2&quot;</span><span class="s3">], </span><span class="s1">dates</span><span class="s3">], </span><span class="s1">names</span><span class="s3">=[</span><span class="s5">&quot;level&quot;</span><span class="s3">, </span><span class="s5">&quot;date&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">index2 </span><span class="s3">= </span><span class="s1">index1</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">names</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">index </span><span class="s2">in </span><span class="s3">[</span><span class="s1">index1</span><span class="s3">, </span><span class="s1">index2</span><span class="s3">]:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">index</span>

            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span>
                <span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;columns&quot;</span><span class="s3">: [</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;B&quot;</span><span class="s3">]}, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">df</span><span class="s3">[[</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;B&quot;</span><span class="s3">]]</span>
            <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_ignoring_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s4"># ENH 20768</span>
        <span class="s4"># Ensure index=False omits the index from the written Parquet file.</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s5">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">&quot;q&quot;</span><span class="s3">, </span><span class="s5">&quot;r&quot;</span><span class="s3">, </span><span class="s5">&quot;s&quot;</span><span class="s3">]})</span>

        <span class="s1">write_kwargs </span><span class="s3">= {</span><span class="s5">&quot;compression&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;index&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">}</span>

        <span class="s4"># Because we're dropping the index, we expect the loaded dataframe to</span>
        <span class="s4"># have the default integer index.</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">(</span><span class="s1">drop</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">write_kwargs</span><span class="s3">=</span><span class="s1">write_kwargs</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Ignore custom index</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s5">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">&quot;q&quot;</span><span class="s3">, </span><span class="s5">&quot;r&quot;</span><span class="s3">, </span><span class="s5">&quot;s&quot;</span><span class="s3">]}, </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">&quot;zyx&quot;</span><span class="s3">, </span><span class="s5">&quot;wvu&quot;</span><span class="s3">, </span><span class="s5">&quot;tsr&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">write_kwargs</span><span class="s3">=</span><span class="s1">write_kwargs</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Ignore multi-indexes as well.</span>
        <span class="s1">arrays </span><span class="s3">= [</span>
            <span class="s3">[</span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">],</span>
        <span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s5">&quot;one&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">8</span><span class="s3">)), </span><span class="s5">&quot;two&quot;</span><span class="s3">: [-</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">8</span><span class="s3">)]}, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">arrays</span>
        <span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">(</span><span class="s1">drop</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">write_kwargs</span><span class="s3">=</span><span class="s1">write_kwargs</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_column_multiindex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s4"># Not able to write column multi-indexes with non-string column names.</span>
        <span class="s1">mi_columns </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">([(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), (</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), (</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">4</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">mi_columns</span>
        <span class="s3">)</span>

        <span class="s2">if </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span>
                <span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">TypeError</span><span class="s3">, </span><span class="s5">&quot;Column name must be a string&quot;</span>
            <span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">:</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_column_multiindex_nonstring</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s4"># GH #34777</span>

        <span class="s4"># Not able to write column multi-indexes with non-string column names</span>
        <span class="s1">arrays </span><span class="s3">= [</span>
            <span class="s3">[</span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">],</span>
        <span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">8</span><span class="s3">, </span><span class="s6">8</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">arrays</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">names </span><span class="s3">= [</span><span class="s5">&quot;Level1&quot;</span><span class="s3">, </span><span class="s5">&quot;Level2&quot;</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s5">&quot;Column name&quot;</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">:</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_column_multiindex_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH #34777</span>
        <span class="s4"># Not supported in fastparquet as of 0.1.3</span>
        <span class="s1">engine </span><span class="s3">= </span><span class="s1">pa</span>

        <span class="s4"># Write column multi-indexes with string column names</span>
        <span class="s1">arrays </span><span class="s3">= [</span>
            <span class="s3">[</span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">, </span><span class="s5">&quot;one&quot;</span><span class="s3">, </span><span class="s5">&quot;two&quot;</span><span class="s3">],</span>
        <span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">8</span><span class="s3">, </span><span class="s6">8</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">arrays</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">names </span><span class="s3">= [</span><span class="s5">&quot;ColLevel1&quot;</span><span class="s3">, </span><span class="s5">&quot;ColLevel2&quot;</span><span class="s3">]</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_column_index_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH #34777</span>
        <span class="s4"># Not supported in fastparquet as of 0.1.3</span>
        <span class="s1">engine </span><span class="s3">= </span><span class="s1">pa</span>

        <span class="s4"># Write column indexes with string column names</span>
        <span class="s1">arrays </span><span class="s3">= [</span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;qux&quot;</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">8</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">arrays</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;StringCol&quot;</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_column_index_nonstring</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s4"># GH #34777</span>

        <span class="s4"># Write column indexes with string column names</span>
        <span class="s1">arrays </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">8</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">arrays</span>
        <span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;NonStringCol&quot;</span>
        <span class="s2">if </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span>
                <span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">TypeError</span><span class="s3">, </span><span class="s5">&quot;Column name must be a string&quot;</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_dtype_backend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">, </span><span class="s1">request</span><span class="s3">):</span>
        <span class="s1">pq </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow.parquet&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">:</span>
            <span class="s4"># We are manually disabling fastparquet's</span>
            <span class="s4"># nullable dtype support pending discussion</span>
            <span class="s1">mark </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span>
                <span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;Fastparquet nullable dtype support is disabled&quot;</span>
            <span class="s3">)</span>
            <span class="s1">request</span><span class="s3">.</span><span class="s1">applymarker</span><span class="s3">(</span><span class="s1">mark</span><span class="s3">)</span>

        <span class="s1">table </span><span class="s3">= </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">table</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s5">&quot;int64&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;b&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s5">&quot;uint8&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;c&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]),</span>
                <span class="s5">&quot;d&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">]),</span>
                <span class="s4"># Test that nullable dtypes used even in absence of nulls</span>
                <span class="s5">&quot;e&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], </span><span class="s5">&quot;int64&quot;</span><span class="s3">),</span>
                <span class="s4"># GH 45694</span>
                <span class="s5">&quot;f&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s5">&quot;float32&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;g&quot;</span><span class="s3">: </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s5">&quot;float64&quot;</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s4"># write manually with pyarrow to write integers</span>
            <span class="s1">pq</span><span class="s3">.</span><span class="s1">write_table</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)</span>
            <span class="s1">result1 </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">engine</span><span class="s3">)</span>
            <span class="s1">result2 </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">engine</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">=</span><span class="s5">&quot;numpy_nullable&quot;</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">result1</span><span class="s3">[</span><span class="s5">&quot;a&quot;</span><span class="s3">].</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s5">&quot;float64&quot;</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;b&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;UInt8&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;c&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;d&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;boolean&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;e&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;f&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Float32&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;g&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Float64&quot;</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">engine </span><span class="s3">== </span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">:</span>
            <span class="s4"># Fastparquet doesn't support string columns yet</span>
            <span class="s4"># Only int and boolean</span>
            <span class="s1">result2 </span><span class="s3">= </span><span class="s1">result2</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">drop</span><span class="s3">(</span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s5">&quot;dtype&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s5">&quot;Int64&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;UInt8&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;boolean&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;object&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;datetime64[ns, UTC]&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;float&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;period[D]&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;Float64&quot;</span><span class="s3">,</span>
            <span class="s5">&quot;string&quot;</span><span class="s3">,</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_read_empty_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s4"># GH #41241</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">&quot;value&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s4"># GH 45694</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">dtype </span><span class="s3">== </span><span class="s5">&quot;float&quot;</span><span class="s3">:</span>
            <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
                <span class="s3">{</span>
                    <span class="s5">&quot;value&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Float64&quot;</span><span class="s3">),</span>
                <span class="s3">}</span>
            <span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;dtype_backend&quot;</span><span class="s3">: </span><span class="s5">&quot;numpy_nullable&quot;</span><span class="s3">}, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span>
        <span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestParquetPyArrow</span><span class="s3">(</span><span class="s1">Base</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>

        <span class="s4"># additional supported types for pyarrow</span>
        <span class="s1">dti </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s5">&quot;Europe/Brussels&quot;</span><span class="s3">)</span>
        <span class="s1">dti </span><span class="s3">= </span><span class="s1">dti</span><span class="s3">.</span><span class="s1">_with_freq</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)  </span><span class="s4"># freq doesn't round-trip</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;datetime_tz&quot;</span><span class="s3">] = </span><span class="s1">dti</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;bool_with_none&quot;</span><span class="s3">] = [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_basic_subset_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH18628</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s4"># additional supported types for pyarrow</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;datetime_tz&quot;</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s5">&quot;Europe/Brussels&quot;</span><span class="s3">)</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">,</span>
            <span class="s1">pa</span><span class="s3">,</span>
            <span class="s1">expected</span><span class="s3">=</span><span class="s1">df</span><span class="s3">[[</span><span class="s5">&quot;string&quot;</span><span class="s3">, </span><span class="s5">&quot;int&quot;</span><span class="s3">]],</span>
            <span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;columns&quot;</span><span class="s3">: [</span><span class="s5">&quot;string&quot;</span><span class="s3">, </span><span class="s5">&quot;int&quot;</span><span class="s3">]},</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_to_bytes_without_path_or_buf_provided</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH 37105</span>
        <span class="s1">buf_bytes </span><span class="s3">= </span><span class="s1">df_full</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">buf_bytes</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">)</span>

        <span class="s1">buf_stream </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">(</span><span class="s1">buf_bytes</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">buf_stream</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df_full</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s5">&quot;string_with_nan&quot;</span><span class="s3">] = </span><span class="s2">None</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_duplicate_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># not currently able to handle duplicate columns</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">12</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">4</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;aaa&quot;</span><span class="s3">)).</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s5">&quot;Duplicate column names found&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_timedelta</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">timedelta_range</span><span class="s3">(</span><span class="s5">&quot;1 day&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unsupported</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># mixed python objects</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]})</span>
        <span class="s4"># pyarrow 0.11 raises ArrowTypeError</span>
        <span class="s4"># older pyarrows raise ArrowInvalid</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_external_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">ArrowException</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unsupported_float16</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># #44847, #44914</span>
        <span class="s4"># Not able to write float 16 column using pyarrow.</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">=</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;fp16&quot;</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">pa_version_under15p0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_external_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">ArrowException</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span>
        <span class="s1">is_platform_windows</span><span class="s3">(),</span>
        <span class="s1">reason</span><span class="s3">=(</span>
            <span class="s5">&quot;PyArrow does not cleanup of partial files dumps when unsupported &quot;</span>
            <span class="s5">&quot;dtypes are passed to_parquet function in windows&quot;</span>
        <span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s2">not </span><span class="s1">pa_version_under15p0</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;float16 works on 15&quot;</span><span class="s3">)</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;path_type&quot;</span><span class="s3">, [</span><span class="s1">str</span><span class="s3">, </span><span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_unsupported_float16_cleanup</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">path_type</span><span class="s3">):</span>
        <span class="s4"># #44847, #44914</span>
        <span class="s4"># Not able to write float 16 column using pyarrow.</span>
        <span class="s4"># Tests cleanup by pyarrow in case of an error</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">=</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;fp16&quot;</span><span class="s3">])</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path_str</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">path_type</span><span class="s3">(</span><span class="s1">path_str</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">external_error_raised</span><span class="s3">(</span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">ArrowException</span><span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">=</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
            <span class="s2">assert not </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">isfile</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_categorical</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># supported in &gt;= 0.7.0</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;a&quot;</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Categorical</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abcdef&quot;</span><span class="s3">))</span>

        <span class="s4"># test for null, out-of-order values, and unobserved category</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;b&quot;</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Categorical</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">],</span>
            <span class="s1">dtype</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">CategoricalDtype</span><span class="s3">([</span><span class="s5">&quot;foo&quot;</span><span class="s3">, </span><span class="s5">&quot;bar&quot;</span><span class="s3">, </span><span class="s5">&quot;baz&quot;</span><span class="s3">]),</span>
        <span class="s3">)</span>

        <span class="s4"># test for ordered flag</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;c&quot;</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Categorical</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">], </span><span class="s1">categories</span><span class="s3">=[</span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">, </span><span class="s5">&quot;d&quot;</span><span class="s3">], </span><span class="s1">ordered</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">single_cpu</span>
    <span class="s2">def </span><span class="s1">test_s3_roundtrip_explicit_fs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">s3_public_bucket</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">s3so</span><span class="s3">):</span>
        <span class="s1">s3fs </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;s3fs&quot;</span><span class="s3">)</span>
        <span class="s1">s3 </span><span class="s3">= </span><span class="s1">s3fs</span><span class="s3">.</span><span class="s1">S3FileSystem</span><span class="s3">(**</span><span class="s1">s3so</span><span class="s3">)</span>
        <span class="s1">kw </span><span class="s3">= {</span><span class="s5">&quot;filesystem&quot;</span><span class="s3">: </span><span class="s1">s3</span><span class="s3">}</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df_compat</span><span class="s3">,</span>
            <span class="s1">pa</span><span class="s3">,</span>
            <span class="s1">path</span><span class="s3">=</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">s3_public_bucket</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s5">/pyarrow.parquet&quot;</span><span class="s3">,</span>
            <span class="s1">read_kwargs</span><span class="s3">=</span><span class="s1">kw</span><span class="s3">,</span>
            <span class="s1">write_kwargs</span><span class="s3">=</span><span class="s1">kw</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">single_cpu</span>
    <span class="s2">def </span><span class="s1">test_s3_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">s3_public_bucket</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">s3so</span><span class="s3">):</span>
        <span class="s4"># GH #19134</span>
        <span class="s1">s3so </span><span class="s3">= {</span><span class="s5">&quot;storage_options&quot;</span><span class="s3">: </span><span class="s1">s3so</span><span class="s3">}</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df_compat</span><span class="s3">,</span>
            <span class="s1">pa</span><span class="s3">,</span>
            <span class="s1">path</span><span class="s3">=</span><span class="s5">f&quot;s3://</span><span class="s2">{</span><span class="s1">s3_public_bucket</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s5">/pyarrow.parquet&quot;</span><span class="s3">,</span>
            <span class="s1">read_kwargs</span><span class="s3">=</span><span class="s1">s3so</span><span class="s3">,</span>
            <span class="s1">write_kwargs</span><span class="s3">=</span><span class="s1">s3so</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">single_cpu</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s5">&quot;partition_col&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">&quot;A&quot;</span><span class="s3">],</span>
            <span class="s3">[],</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_s3_roundtrip_for_dir</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">s3_public_bucket</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">partition_col</span><span class="s3">, </span><span class="s1">s3so</span>
    <span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;s3fs&quot;</span><span class="s3">)</span>
        <span class="s4"># GH #26388</span>
        <span class="s1">expected_df </span><span class="s3">= </span><span class="s1">df_compat</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

        <span class="s4"># GH #35791</span>
        <span class="s2">if </span><span class="s1">partition_col</span><span class="s3">:</span>
            <span class="s1">expected_df </span><span class="s3">= </span><span class="s1">expected_df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dict</span><span class="s3">.</span><span class="s1">fromkeys</span><span class="s3">(</span><span class="s1">partition_col</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">))</span>
            <span class="s1">partition_col_type </span><span class="s3">= </span><span class="s5">&quot;category&quot;</span>

            <span class="s1">expected_df</span><span class="s3">[</span><span class="s1">partition_col</span><span class="s3">] = </span><span class="s1">expected_df</span><span class="s3">[</span><span class="s1">partition_col</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span>
                <span class="s1">partition_col_type</span>
            <span class="s3">)</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df_compat</span><span class="s3">,</span>
            <span class="s1">pa</span><span class="s3">,</span>
            <span class="s1">expected</span><span class="s3">=</span><span class="s1">expected_df</span><span class="s3">,</span>
            <span class="s1">path</span><span class="s3">=</span><span class="s5">f&quot;s3://</span><span class="s2">{</span><span class="s1">s3_public_bucket</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s5">/parquet_dir&quot;</span><span class="s3">,</span>
            <span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;storage_options&quot;</span><span class="s3">: </span><span class="s1">s3so</span><span class="s3">},</span>
            <span class="s1">write_kwargs</span><span class="s3">={</span>
                <span class="s5">&quot;partition_cols&quot;</span><span class="s3">: </span><span class="s1">partition_col</span><span class="s3">,</span>
                <span class="s5">&quot;compression&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">,</span>
                <span class="s5">&quot;storage_options&quot;</span><span class="s3">: </span><span class="s1">s3so</span><span class="s3">,</span>
            <span class="s3">},</span>
            <span class="s1">check_like</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
            <span class="s1">repeat</span><span class="s3">=</span><span class="s6">1</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_file_like_obj_support</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">buffer </span><span class="s3">= </span><span class="s1">BytesIO</span><span class="s3">()</span>
        <span class="s1">df_compat</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">)</span>
        <span class="s1">df_from_buf </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">buffer</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">df_from_buf</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_expand_user</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">monkeypatch</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setenv</span><span class="s3">(</span><span class="s5">&quot;HOME&quot;</span><span class="s3">, </span><span class="s5">&quot;TestingUser&quot;</span><span class="s3">)</span>
        <span class="s1">monkeypatch</span><span class="s3">.</span><span class="s1">setenv</span><span class="s3">(</span><span class="s5">&quot;USERPROFILE&quot;</span><span class="s3">, </span><span class="s5">&quot;TestingUser&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">OSError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">r&quot;.*TestingUser.*&quot;</span><span class="s3">):</span>
            <span class="s1">read_parquet</span><span class="s3">(</span><span class="s5">&quot;~/file.parquet&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">OSError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">r&quot;.*TestingUser.*&quot;</span><span class="s3">):</span>
            <span class="s1">df_compat</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s5">&quot;~/file.parquet&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_partition_cols_supported</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH #23283</span>
        <span class="s1">partition_cols </span><span class="s3">= [</span><span class="s5">&quot;bool&quot;</span><span class="s3">, </span><span class="s5">&quot;int&quot;</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">partition_cols</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">check_partition_names</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">partition_cols</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">).</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">df</span><span class="s3">.</span><span class="s1">shape</span>

    <span class="s2">def </span><span class="s1">test_partition_cols_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH #27117</span>
        <span class="s1">partition_cols </span><span class="s3">= </span><span class="s5">&quot;bool&quot;</span>
        <span class="s1">partition_cols_list </span><span class="s3">= [</span><span class="s1">partition_cols</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">partition_cols</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">check_partition_names</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">partition_cols_list</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">).</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">df</span><span class="s3">.</span><span class="s1">shape</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s5">&quot;path_type&quot;</span><span class="s3">, [</span><span class="s1">str</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">], </span><span class="s1">ids</span><span class="s3">=[</span><span class="s5">&quot;string&quot;</span><span class="s3">, </span><span class="s5">&quot;pathlib.Path&quot;</span><span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_partition_cols_pathlib</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">path_type</span><span class="s3">):</span>
        <span class="s4"># GH 35902</span>

        <span class="s1">partition_cols </span><span class="s3">= </span><span class="s5">&quot;B&quot;</span>
        <span class="s1">partition_cols_list </span><span class="s3">= [</span><span class="s1">partition_cols</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_compat</span>

        <span class="s1">path </span><span class="s3">= </span><span class="s1">path_type</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">partition_cols</span><span class="s3">=</span><span class="s1">partition_cols_list</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">).</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">df</span><span class="s3">.</span><span class="s1">shape</span>

    <span class="s2">def </span><span class="s1">test_empty_dataframe</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH #27339</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=[], </span><span class="s1">columns</span><span class="s3">=[])</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_write_with_schema</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">pyarrow</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;x&quot;</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]})</span>
        <span class="s1">schema </span><span class="s3">= </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">schema</span><span class="s3">([</span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">field</span><span class="s3">(</span><span class="s5">&quot;x&quot;</span><span class="s3">, </span><span class="s1">type</span><span class="s3">=</span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">bool_</span><span class="s3">())])</span>
        <span class="s1">out_df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">bool</span><span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">write_kwargs</span><span class="s3">={</span><span class="s5">&quot;schema&quot;</span><span class="s3">: </span><span class="s1">schema</span><span class="s3">}, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">out_df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_additional_extension_arrays</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># test additional ExtensionArrays that are supported through the</span>
        <span class="s4"># __arrow_array__ protocol</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Int64&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;b&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;UInt32&quot;</span><span class="s3">),</span>
                <span class="s5">&quot;c&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string&quot;</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s2">None</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;Int64&quot;</span><span class="s3">)})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pyarrow_backed_string_array</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">):</span>
        <span class="s4"># test ArrowStringArray supported through the __arrow_array__ protocol</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Series</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[pyarrow]&quot;</span><span class="s3">)})</span>
        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;string_storage&quot;</span><span class="s3">, </span><span class="s1">string_storage</span><span class="s3">):</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">df</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s5">f&quot;string[</span><span class="s2">{</span><span class="s1">string_storage</span><span class="s2">}</span><span class="s5">]&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_additional_extension_types</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># test additional ExtensionArrays that are supported through the</span>
        <span class="s4"># __arrow_array__ protocol + by defining a custom ExtensionType</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">&quot;c&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">IntervalIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">([(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">), (</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)]),</span>
                <span class="s5">&quot;d&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">period_range</span><span class="s3">(</span><span class="s5">&quot;2012-01-01&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s5">&quot;D&quot;</span><span class="s3">),</span>
                <span class="s4"># GH-45881 issue with interval with datetime64[ns] subtype</span>
                <span class="s5">&quot;e&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">IntervalIndex</span><span class="s3">.</span><span class="s1">from_breaks</span><span class="s3">(</span>
                    <span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;2012-01-01&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">4</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s5">&quot;D&quot;</span><span class="s3">)</span>
                <span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_timestamp_nanoseconds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># with version 2.6, pyarrow defaults to writing the nanoseconds, so</span>
        <span class="s4"># this should work without error</span>
        <span class="s4"># Note in previous pyarrows(&lt;7.0.0), only the pseudo-version 2.0 was available</span>
        <span class="s1">ver </span><span class="s3">= </span><span class="s5">&quot;2.6&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;2017-01-01&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s5">&quot;1ns&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">10</span><span class="s3">)})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">write_kwargs</span><span class="s3">={</span><span class="s5">&quot;version&quot;</span><span class="s3">: </span><span class="s1">ver</span><span class="s3">})</span>

    <span class="s2">def </span><span class="s1">test_timezone_aware_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">request</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">timezone_aware_date_list</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">timezone_aware_date_list</span><span class="s3">.</span><span class="s1">tzinfo </span><span class="s3">!= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timezone</span><span class="s3">.</span><span class="s1">utc</span><span class="s3">:</span>
            <span class="s1">request</span><span class="s3">.</span><span class="s1">applymarker</span><span class="s3">(</span>
                <span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span>
                    <span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;temporary skip this test until it is properly resolved: &quot;</span>
                    <span class="s5">&quot;https://github.com/pandas-dev/pandas/issues/37286&quot;</span>
                <span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s6">5 </span><span class="s3">* [</span><span class="s1">timezone_aware_date_list</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;index_as_col&quot;</span><span class="s3">: </span><span class="s1">idx</span><span class="s3">})</span>

        <span class="s4"># see gh-36004</span>
        <span class="s4"># compare time(zone) values only, skip their class:</span>
        <span class="s4"># pyarrow always creates fixed offset timezones using pytz.FixedOffset()</span>
        <span class="s4"># even if it was datetime.timezone() originally</span>
        <span class="s4">#</span>
        <span class="s4"># technically they are the same:</span>
        <span class="s4"># they both implement datetime.tzinfo</span>
        <span class="s4"># they both wrap datetime.timedelta()</span>
        <span class="s4"># this use-case sets the resolution to 1 minute</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">check_dtype</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_filter_row_groups</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/26551</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">3</span><span class="s3">))})</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">filters</span><span class="s3">=[(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;==&quot;</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)])</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">result</span><span class="s3">) == </span><span class="s6">1</span>

    <span class="s2">def </span><span class="s1">test_read_parquet_manager</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">using_array_manager</span><span class="s3">):</span>
        <span class="s4"># ensure that read_parquet honors the pandas.options.mode.data_manager option</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s6">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s6">10</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)), </span><span class="s1">columns</span><span class="s3">=[</span><span class="s5">&quot;A&quot;</span><span class="s3">, </span><span class="s5">&quot;B&quot;</span><span class="s3">, </span><span class="s5">&quot;C&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">using_array_manager</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">_mgr</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">internals</span><span class="s3">.</span><span class="s1">ArrayManager</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">_mgr</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">internals</span><span class="s3">.</span><span class="s1">BlockManager</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_dtype_backend_pyarrow_config</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s2">import </span><span class="s1">pyarrow</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>

        <span class="s4"># additional supported types for pyarrow</span>
        <span class="s1">dti </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s5">&quot;Europe/Brussels&quot;</span><span class="s3">)</span>
        <span class="s1">dti </span><span class="s3">= </span><span class="s1">dti</span><span class="s3">.</span><span class="s1">_with_freq</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)  </span><span class="s4"># freq doesn't round-trip</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;datetime_tz&quot;</span><span class="s3">] = </span><span class="s1">dti</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;bool_with_none&quot;</span><span class="s3">] = [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]</span>

        <span class="s1">pa_table </span><span class="s3">= </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">Table</span><span class="s3">.</span><span class="s1">from_pandas</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pa_table</span><span class="s3">.</span><span class="s1">to_pandas</span><span class="s3">(</span><span class="s1">types_mapper</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">ArrowDtype</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">pa_version_under13p0</span><span class="s3">:</span>
            <span class="s4"># pyarrow infers datetimes as us instead of ns</span>
            <span class="s1">expected</span><span class="s3">[</span><span class="s5">&quot;datetime&quot;</span><span class="s3">] = </span><span class="s1">expected</span><span class="s3">[</span><span class="s5">&quot;datetime&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s5">&quot;timestamp[us][pyarrow]&quot;</span><span class="s3">)</span>
            <span class="s1">expected</span><span class="s3">[</span><span class="s5">&quot;datetime_with_nat&quot;</span><span class="s3">] = </span><span class="s1">expected</span><span class="s3">[</span><span class="s5">&quot;datetime_with_nat&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span>
                <span class="s5">&quot;timestamp[us][pyarrow]&quot;</span>
            <span class="s3">)</span>
            <span class="s1">expected</span><span class="s3">[</span><span class="s5">&quot;datetime_tz&quot;</span><span class="s3">] = </span><span class="s1">expected</span><span class="s3">[</span><span class="s5">&quot;datetime_tz&quot;</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span>
                <span class="s1">pd</span><span class="s3">.</span><span class="s1">ArrowDtype</span><span class="s3">(</span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">timestamp</span><span class="s3">(</span><span class="s1">unit</span><span class="s3">=</span><span class="s5">&quot;us&quot;</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s5">&quot;Europe/Brussels&quot;</span><span class="s3">))</span>
            <span class="s3">)</span>

        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">,</span>
            <span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">,</span>
            <span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;dtype_backend&quot;</span><span class="s3">: </span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">},</span>
            <span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_read_dtype_backend_pyarrow_config_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]}, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;test&quot;</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;int64[pyarrow]&quot;</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s2">import </span><span class="s1">pyarrow</span>

        <span class="s2">if </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &gt; </span><span class="s1">Version</span><span class="s3">(</span><span class="s5">&quot;11.0.0&quot;</span><span class="s3">):</span>
            <span class="s1">expected</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s5">&quot;int64[pyarrow]&quot;</span><span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">,</span>
            <span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">,</span>
            <span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;dtype_backend&quot;</span><span class="s3">: </span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">},</span>
            <span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_columns_dtypes_not_invalid</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;string&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">), </span><span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))})</span>

        <span class="s4"># numeric</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

        <span class="s4"># bytes</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s7">b&quot;foo&quot;</span><span class="s3">, </span><span class="s7">b&quot;bar&quot;</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotImplementedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;|S3&quot;</span><span class="s3">):</span>
            <span class="s4"># Bytes fails on read_parquet</span>
            <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

        <span class="s4"># python object</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span>
            <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">(</span><span class="s6">2011</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
            <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">(</span><span class="s6">2011</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">]</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_empty_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH 52034</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;custom name&quot;</span><span class="s3">))</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_df_attrs_persistence</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">tmp_path </span><span class="s3">/ </span><span class="s5">&quot;test_df_metadata.p&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s6">1</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">]})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">attrs </span><span class="s3">= {</span><span class="s5">&quot;test_attribute&quot;</span><span class="s3">: </span><span class="s6">1</span><span class="s3">}</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
        <span class="s1">new_df </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">new_df</span><span class="s3">.</span><span class="s1">attrs </span><span class="s3">== </span><span class="s1">df</span><span class="s3">.</span><span class="s1">attrs</span>

    <span class="s2">def </span><span class="s1">test_string_inference</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH#54431</span>
        <span class="s1">path </span><span class="s3">= </span><span class="s1">tmp_path </span><span class="s3">/ </span><span class="s5">&quot;test_string_inference.p&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">&quot;x&quot;</span><span class="s3">, </span><span class="s5">&quot;y&quot;</span><span class="s3">]}, </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">])</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;future.infer_string&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">&quot;x&quot;</span><span class="s3">, </span><span class="s5">&quot;y&quot;</span><span class="s3">]},</span>
            <span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[pyarrow_numpy]&quot;</span><span class="s3">,</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[pyarrow_numpy]&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s1">pa_version_under11p0</span><span class="s3">, </span><span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;not supported before 11.0&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_roundtrip_decimal</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH#54768</span>
        <span class="s2">import </span><span class="s1">pyarrow </span><span class="s2">as </span><span class="s1">pa</span>

        <span class="s1">path </span><span class="s3">= </span><span class="s1">tmp_path </span><span class="s3">/ </span><span class="s5">&quot;decimal.p&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s1">Decimal</span><span class="s3">(</span><span class="s5">&quot;123.00&quot;</span><span class="s3">)]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[pyarrow]&quot;</span><span class="s3">)</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">schema</span><span class="s3">=</span><span class="s1">pa</span><span class="s3">.</span><span class="s1">schema</span><span class="s3">([(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">.</span><span class="s1">decimal128</span><span class="s3">(</span><span class="s6">5</span><span class="s3">))]))</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">&quot;123&quot;</span><span class="s3">]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[python]&quot;</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_infer_string_large_string_type</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">pa</span><span class="s3">):</span>
        <span class="s4"># GH#54798</span>
        <span class="s2">import </span><span class="s1">pyarrow </span><span class="s2">as </span><span class="s1">pa</span>
        <span class="s2">import </span><span class="s1">pyarrow</span><span class="s3">.</span><span class="s1">parquet </span><span class="s2">as </span><span class="s1">pq</span>

        <span class="s1">path </span><span class="s3">= </span><span class="s1">tmp_path </span><span class="s3">/ </span><span class="s5">&quot;large_string.p&quot;</span>

        <span class="s1">table </span><span class="s3">= </span><span class="s1">pa</span><span class="s3">.</span><span class="s1">table</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pa</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">], </span><span class="s1">pa</span><span class="s3">.</span><span class="s1">large_string</span><span class="s3">())})</span>
        <span class="s1">pq</span><span class="s3">.</span><span class="s1">write_table</span><span class="s3">(</span><span class="s1">table</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">option_context</span><span class="s3">(</span><span class="s5">&quot;future.infer_string&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">]},</span>
            <span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[pyarrow_numpy]&quot;</span><span class="s3">,</span>
            <span class="s1">columns</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;string[pyarrow_numpy]&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s4"># NOTE: this test is not run by default, because it requires a lot of memory (&gt;5GB)</span>
    <span class="s4"># @pytest.mark.slow</span>
    <span class="s4"># def test_string_column_above_2GB(self, tmp_path, pa):</span>
    <span class="s4">#     # https://github.com/pandas-dev/pandas/issues/55606</span>
    <span class="s4">#     # above 2GB of string data</span>
    <span class="s4">#     v1 = b&quot;x&quot; * 100000000</span>
    <span class="s4">#     v2 = b&quot;x&quot; * 147483646</span>
    <span class="s4">#     df = pd.DataFrame({&quot;strings&quot;: [v1] * 20 + [v2] + [&quot;x&quot;] * 20}, dtype=&quot;string&quot;)</span>
    <span class="s4">#     df.to_parquet(tmp_path / &quot;test.parquet&quot;)</span>
    <span class="s4">#     result = read_parquet(tmp_path / &quot;test.parquet&quot;)</span>
    <span class="s4">#     assert result[&quot;strings&quot;].dtype == &quot;string&quot;</span>


<span class="s2">class </span><span class="s1">TestParquetFastParquet</span><span class="s3">(</span><span class="s1">Base</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>

        <span class="s1">dti </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">date_range</span><span class="s3">(</span><span class="s5">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">, </span><span class="s1">tz</span><span class="s3">=</span><span class="s5">&quot;US/Eastern&quot;</span><span class="s3">)</span>
        <span class="s1">dti </span><span class="s3">= </span><span class="s1">dti</span><span class="s3">.</span><span class="s1">_with_freq</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)  </span><span class="s4"># freq doesn't round-trip</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;datetime_tz&quot;</span><span class="s3">] = </span><span class="s1">dti</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s5">&quot;timedelta&quot;</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">timedelta_range</span><span class="s3">(</span><span class="s5">&quot;1 day&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_columns_dtypes_invalid</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;string&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">), </span><span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))})</span>

        <span class="s1">err </span><span class="s3">= </span><span class="s1">TypeError</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Column name must be a string&quot;</span>

        <span class="s4"># numeric</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">err</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s4"># bytes</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span><span class="s7">b&quot;foo&quot;</span><span class="s3">, </span><span class="s7">b&quot;bar&quot;</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">err</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s4"># python object</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= [</span>
            <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">(</span><span class="s6">2011</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">),</span>
            <span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">(</span><span class="s6">2011</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">),</span>
        <span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">err</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_duplicate_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s4"># not currently able to handle duplicate columns</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">12</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">4</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;aaa&quot;</span><span class="s3">)).</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Cannot create parquet dataset with duplicate column names&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span>
        <span class="s1">Version</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &gt;= </span><span class="s1">Version</span><span class="s3">(</span><span class="s5">&quot;2.0.0&quot;</span><span class="s3">),</span>
        <span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;fastparquet uses np.float_ in numpy2&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_bool_with_none</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]})</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">]}, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s5">&quot;float16&quot;</span><span class="s3">)</span>
        <span class="s4"># Fastparquet bug in 0.7.1 makes it so that this dtype becomes</span>
        <span class="s4"># float64</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">check_dtype</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unsupported</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s4"># period</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">period_range</span><span class="s3">(</span><span class="s5">&quot;2013&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s5">&quot;M&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)})</span>
        <span class="s4"># error from fastparquet -&gt; don't check exact error message</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

        <span class="s4"># mixed</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]})</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Can't infer object conversion type&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_error_on_write</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_categorical</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Categorical</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abc&quot;</span><span class="s3">))})</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_filter_row_groups</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s1">d </span><span class="s3">= {</span><span class="s5">&quot;a&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">3</span><span class="s3">))}</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">d</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">row_group_offsets</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">filters</span><span class="s3">=[(</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;==&quot;</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)])</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">result</span><span class="s3">) == </span><span class="s6">1</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">single_cpu</span>
    <span class="s2">def </span><span class="s1">test_s3_roundtrip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df_compat</span><span class="s3">, </span><span class="s1">s3_public_bucket</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">s3so</span><span class="s3">):</span>
        <span class="s4"># GH #19134</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span>
            <span class="s1">df_compat</span><span class="s3">,</span>
            <span class="s1">fp</span><span class="s3">,</span>
            <span class="s1">path</span><span class="s3">=</span><span class="s5">f&quot;s3://</span><span class="s2">{</span><span class="s1">s3_public_bucket</span><span class="s3">.</span><span class="s1">name</span><span class="s2">}</span><span class="s5">/fastparquet.parquet&quot;</span><span class="s3">,</span>
            <span class="s1">read_kwargs</span><span class="s3">={</span><span class="s5">&quot;storage_options&quot;</span><span class="s3">: </span><span class="s1">s3so</span><span class="s3">},</span>
            <span class="s1">write_kwargs</span><span class="s3">={</span><span class="s5">&quot;compression&quot;</span><span class="s3">: </span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;storage_options&quot;</span><span class="s3">: </span><span class="s1">s3so</span><span class="s3">},</span>
        <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_partition_cols_supported</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH #23283</span>
        <span class="s1">partition_cols </span><span class="s3">= [</span><span class="s5">&quot;bool&quot;</span><span class="s3">, </span><span class="s5">&quot;int&quot;</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span>
            <span class="s1">tmp_path</span><span class="s3">,</span>
            <span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">,</span>
            <span class="s1">partition_cols</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">,</span>
            <span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">)</span>
        <span class="s2">import </span><span class="s1">fastparquet</span>

        <span class="s1">actual_partition_cols </span><span class="s3">= </span><span class="s1">fastparquet</span><span class="s3">.</span><span class="s1">ParquetFile</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">), </span><span class="s2">False</span><span class="s3">).</span><span class="s1">cats</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">actual_partition_cols</span><span class="s3">) == </span><span class="s6">2</span>

    <span class="s2">def </span><span class="s1">test_partition_cols_string</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH #27117</span>
        <span class="s1">partition_cols </span><span class="s3">= </span><span class="s5">&quot;bool&quot;</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span>
            <span class="s1">tmp_path</span><span class="s3">,</span>
            <span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">,</span>
            <span class="s1">partition_cols</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">,</span>
            <span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">)</span>
        <span class="s2">import </span><span class="s1">fastparquet</span>

        <span class="s1">actual_partition_cols </span><span class="s3">= </span><span class="s1">fastparquet</span><span class="s3">.</span><span class="s1">ParquetFile</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">), </span><span class="s2">False</span><span class="s3">).</span><span class="s1">cats</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">actual_partition_cols</span><span class="s3">) == </span><span class="s6">1</span>

    <span class="s2">def </span><span class="s1">test_partition_on_supported</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">df_full</span><span class="s3">):</span>
        <span class="s4"># GH #23283</span>
        <span class="s1">partition_cols </span><span class="s3">= [</span><span class="s5">&quot;bool&quot;</span><span class="s3">, </span><span class="s5">&quot;int&quot;</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span>
            <span class="s1">tmp_path</span><span class="s3">,</span>
            <span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">,</span>
            <span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
            <span class="s1">partition_on</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">exists</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">)</span>
        <span class="s2">import </span><span class="s1">fastparquet</span>

        <span class="s1">actual_partition_cols </span><span class="s3">= </span><span class="s1">fastparquet</span><span class="s3">.</span><span class="s1">ParquetFile</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">tmp_path</span><span class="s3">), </span><span class="s2">False</span><span class="s3">).</span><span class="s1">cats</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">actual_partition_cols</span><span class="s3">) == </span><span class="s6">2</span>

    <span class="s2">def </span><span class="s1">test_error_on_using_partition_cols_and_partition_on</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">tmp_path</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">df_full</span>
    <span class="s3">):</span>
        <span class="s4"># GH #23283</span>
        <span class="s1">partition_cols </span><span class="s3">= [</span><span class="s5">&quot;bool&quot;</span><span class="s3">, </span><span class="s5">&quot;int&quot;</span><span class="s3">]</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df_full</span>
        <span class="s1">msg </span><span class="s3">= (</span>
            <span class="s5">&quot;Cannot use both partition_on and partition_cols. Use partition_cols for &quot;</span>
            <span class="s5">&quot;partitioning data&quot;</span>
        <span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span>
                <span class="s1">tmp_path</span><span class="s3">,</span>
                <span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">,</span>
                <span class="s1">compression</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                <span class="s1">partition_on</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">,</span>
                <span class="s1">partition_cols</span><span class="s3">=</span><span class="s1">partition_cols</span><span class="s3">,</span>
            <span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s1">using_copy_on_write</span><span class="s3">(), </span><span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;fastparquet writes into Index&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_empty_dataframe</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s4"># GH #27339</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span>
        <span class="s1">_HAVE_FASTPARQUET </span><span class="s2">and </span><span class="s1">Version</span><span class="s3">(</span><span class="s1">fastparquet</span><span class="s3">.</span><span class="s1">__version__</span><span class="s3">) &gt; </span><span class="s1">Version</span><span class="s3">(</span><span class="s5">&quot;2022.12&quot;</span><span class="s3">),</span>
        <span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;fastparquet bug, see https://github.com/dask/fastparquet/issues/929&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_timezone_aware_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">timezone_aware_date_list</span><span class="s3">):</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s6">5 </span><span class="s3">* [</span><span class="s1">timezone_aware_date_list</span><span class="s3">]</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">, </span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;index_as_col&quot;</span><span class="s3">: </span><span class="s1">idx</span><span class="s3">})</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s5">&quot;index&quot;</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_use_nullable_dtypes_not_supported</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;a&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]})</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;not supported for the fastparquet&quot;</span><span class="s3">):</span>
                <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">):</span>
                    <span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">, </span><span class="s1">use_nullable_dtypes</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;not supported for the fastparquet&quot;</span><span class="s3">):</span>
                <span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_close_file_handle_on_read_error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s5">&quot;test.parquet&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">).</span><span class="s1">write_bytes</span><span class="s3">(</span><span class="s7">b&quot;breakit&quot;</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;&quot;</span><span class="s3">):  </span><span class="s4"># Not important which exception</span>
                <span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">)</span>
            <span class="s4"># The next line raises an error on Windows if the file is still open</span>
            <span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">).</span><span class="s1">unlink</span><span class="s3">(</span><span class="s1">missing_ok</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_bytes_file_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s4"># GH#48944</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]})</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s5">&quot;test.parquet&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">open</span><span class="s3">(</span><span class="s1">path</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(), </span><span class="s5">&quot;wb&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">f</span><span class="s3">:</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>

            <span class="s1">result </span><span class="s3">= </span><span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s1">engine</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_filesystem_notimplemented</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]})</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">NotImplementedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;filesystem is not implemented&quot;</span>
            <span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">, </span><span class="s1">filesystem</span><span class="s3">=</span><span class="s5">&quot;foo&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">).</span><span class="s1">write_bytes</span><span class="s3">(</span><span class="s7">b&quot;foo&quot;</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">NotImplementedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;filesystem is not implemented&quot;</span>
            <span class="s3">):</span>
                <span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;fastparquet&quot;</span><span class="s3">, </span><span class="s1">filesystem</span><span class="s3">=</span><span class="s5">&quot;foo&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_filesystem</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]})</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;filesystem must be a pyarrow or fsspec FileSystem&quot;</span>
            <span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s1">filesystem</span><span class="s3">=</span><span class="s5">&quot;foo&quot;</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">).</span><span class="s1">write_bytes</span><span class="s3">(</span><span class="s7">b&quot;foo&quot;</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;filesystem must be a pyarrow or fsspec FileSystem&quot;</span>
            <span class="s3">):</span>
                <span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">, </span><span class="s1">filesystem</span><span class="s3">=</span><span class="s5">&quot;foo&quot;</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_unsupported_pa_filesystem_storage_options</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">pa_fs </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pyarrow.fs&quot;</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">={</span><span class="s5">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s5">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]})</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">NotImplementedError</span><span class="s3">,</span>
                <span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;storage_options not supported with a pyarrow FileSystem.&quot;</span><span class="s3">,</span>
            <span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span>
                    <span class="s1">path</span><span class="s3">,</span>
                    <span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">,</span>
                    <span class="s1">filesystem</span><span class="s3">=</span><span class="s1">pa_fs</span><span class="s3">.</span><span class="s1">LocalFileSystem</span><span class="s3">(),</span>
                    <span class="s1">storage_options</span><span class="s3">={</span><span class="s5">&quot;foo&quot;</span><span class="s3">: </span><span class="s5">&quot;bar&quot;</span><span class="s3">},</span>
                <span class="s3">)</span>

        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">() </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">pathlib</span><span class="s3">.</span><span class="s1">Path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">).</span><span class="s1">write_bytes</span><span class="s3">(</span><span class="s7">b&quot;foo&quot;</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
                <span class="s1">NotImplementedError</span><span class="s3">,</span>
                <span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;storage_options not supported with a pyarrow FileSystem.&quot;</span><span class="s3">,</span>
            <span class="s3">):</span>
                <span class="s1">read_parquet</span><span class="s3">(</span>
                    <span class="s1">path</span><span class="s3">,</span>
                    <span class="s1">engine</span><span class="s3">=</span><span class="s5">&quot;pyarrow&quot;</span><span class="s3">,</span>
                    <span class="s1">filesystem</span><span class="s3">=</span><span class="s1">pa_fs</span><span class="s3">.</span><span class="s1">LocalFileSystem</span><span class="s3">(),</span>
                    <span class="s1">storage_options</span><span class="s3">={</span><span class="s5">&quot;foo&quot;</span><span class="s3">: </span><span class="s5">&quot;bar&quot;</span><span class="s3">},</span>
                <span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_invalid_dtype_backend</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">engine</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= (</span>
            <span class="s5">&quot;dtype_backend numpy is invalid, only 'numpy_nullable' and &quot;</span>
            <span class="s5">&quot;'pyarrow' are allowed.&quot;</span>
        <span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">&quot;int&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">4</span><span class="s3">))})</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">ensure_clean</span><span class="s3">(</span><span class="s5">&quot;tmp.parquet&quot;</span><span class="s3">) </span><span class="s2">as </span><span class="s1">path</span><span class="s3">:</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">to_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
                <span class="s1">read_parquet</span><span class="s3">(</span><span class="s1">path</span><span class="s3">, </span><span class="s1">dtype_backend</span><span class="s3">=</span><span class="s5">&quot;numpy&quot;</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">skipif</span><span class="s3">(</span><span class="s1">using_copy_on_write</span><span class="s3">(), </span><span class="s1">reason</span><span class="s3">=</span><span class="s5">&quot;fastparquet writes into Index&quot;</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_empty_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s4"># GH 52034</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;custom name&quot;</span><span class="s3">))</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Index</span><span class="s3">([</span><span class="s5">&quot;a&quot;</span><span class="s3">, </span><span class="s5">&quot;b&quot;</span><span class="s3">, </span><span class="s5">&quot;c&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s5">&quot;custom name&quot;</span><span class="s3">))</span>
        <span class="s1">check_round_trip</span><span class="s3">(</span><span class="s1">df</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">=</span><span class="s1">expected</span><span class="s3">)</span>
</pre>
</body>
</html>