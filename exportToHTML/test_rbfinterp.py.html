<html>
<head>
<title>test_rbfinterp.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_rbfinterp.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pickle</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s1">LinAlgError</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">qmc </span><span class="s0">import </span><span class="s1">Halton</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">spatial </span><span class="s0">import </span><span class="s1">cKDTree</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate</span><span class="s2">.</span><span class="s1">_rbfinterp </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_AVAILABLE</span><span class="s2">, </span><span class="s1">_SCALE_INVARIANT</span><span class="s2">, </span><span class="s1">_NAME_TO_MIN_DEGREE</span><span class="s2">, </span><span class="s1">_monomial_powers</span><span class="s2">,</span>
    <span class="s1">RBFInterpolator</span>
    <span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate </span><span class="s0">import </span><span class="s1">_rbfinterp_pythran</span>


<span class="s0">def </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">):</span>
    <span class="s3"># Returns a matrix of monomials that span polynomials with the specified</span>
    <span class="s3"># degree evaluated at x.</span>
    <span class="s1">powers </span><span class="s2">= </span><span class="s1">_monomial_powers</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">degree</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">_rbfinterp_pythran</span><span class="s2">.</span><span class="s1">_polynomial_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">powers</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s3"># Test function used in Wahba's &quot;Spline Models for Observational Data&quot;.</span>
    <span class="s3"># domain ~= (0, 3), range ~= (-1.0, 0.2)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s4">4.26</span><span class="s2">*(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-</span><span class="s1">x</span><span class="s2">) - </span><span class="s4">4</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-</span><span class="s4">2</span><span class="s2">*</span><span class="s1">x</span><span class="s2">) + </span><span class="s4">3</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-</span><span class="s4">3</span><span class="s2">*</span><span class="s1">x</span><span class="s2">))</span>
    <span class="s0">return </span><span class="s1">y</span>


<span class="s0">def </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s3"># Franke's test function.</span>
    <span class="s3"># domain ~= (0, 1) X (0, 1), range ~= (0.0, 1.2)</span>
    <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">term1 </span><span class="s2">= </span><span class="s4">0.75 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x1</span><span class="s2">-</span><span class="s4">2</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">/</span><span class="s4">4 </span><span class="s2">- (</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x2</span><span class="s2">-</span><span class="s4">2</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">/</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">term2 </span><span class="s2">= </span><span class="s4">0.75 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x1</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">/</span><span class="s4">49 </span><span class="s2">- (</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)/</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">term3 </span><span class="s2">= </span><span class="s4">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x1</span><span class="s2">-</span><span class="s4">7</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">/</span><span class="s4">4 </span><span class="s2">- (</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x2</span><span class="s2">-</span><span class="s4">3</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">/</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">term4 </span><span class="s2">= -</span><span class="s4">0.2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-(</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x1</span><span class="s2">-</span><span class="s4">4</span><span class="s2">)**</span><span class="s4">2 </span><span class="s2">- (</span><span class="s4">9</span><span class="s2">*</span><span class="s1">x2</span><span class="s2">-</span><span class="s4">7</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">term1 </span><span class="s2">+ </span><span class="s1">term2 </span><span class="s2">+ </span><span class="s1">term3 </span><span class="s2">+ </span><span class="s1">term4</span>
    <span class="s0">return </span><span class="s1">y</span>


<span class="s0">def </span><span class="s1">_is_conditionally_positive_definite</span><span class="s2">(</span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">m</span><span class="s2">):</span>
    <span class="s3"># Tests whether the kernel is conditionally positive definite of order m.</span>
    <span class="s3"># See chapter 7 of Fasshauer's &quot;Meshfree Approximation Methods with</span>
    <span class="s3"># MATLAB&quot;.</span>
    <span class="s1">nx </span><span class="s2">= </span><span class="s4">10</span>
    <span class="s1">ntests </span><span class="s2">= </span><span class="s4">100</span>
    <span class="s0">for </span><span class="s1">ndim </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]:</span>
        <span class="s3"># Generate sample points with a Halton sequence to avoid samples that</span>
        <span class="s3"># are too close to each other, which can make the matrix singular.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s1">ndim</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ntests</span><span class="s2">):</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s4">2</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">nx</span><span class="s2">) - </span><span class="s4">1</span>
            <span class="s1">A </span><span class="s2">= </span><span class="s1">_rbfinterp_pythran</span><span class="s2">.</span><span class="s1">_kernel_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">)</span>
            <span class="s1">P </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">m </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">Q</span><span class="s2">, </span><span class="s1">R </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">qr</span><span class="s2">(</span><span class="s1">P</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s5">'complete'</span><span class="s2">)</span>
            <span class="s3"># Q2 forms a basis spanning the space where P.T.dot(x) = 0. Project</span>
            <span class="s3"># A onto this space, and then see if it is positive definite using</span>
            <span class="s3"># the Cholesky decomposition. If not, then the kernel is not c.p.d.</span>
            <span class="s3"># of order m.</span>
            <span class="s1">Q2 </span><span class="s2">= </span><span class="s1">Q</span><span class="s2">[:, </span><span class="s1">P</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]:]</span>
            <span class="s1">B </span><span class="s2">= </span><span class="s1">Q2</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">A</span><span class="s2">).</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">Q2</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">cholesky</span><span class="s2">(</span><span class="s1">B</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">LinAlgError</span><span class="s2">:</span>
                <span class="s0">return False</span>

    <span class="s0">return True</span>


<span class="s3"># Sorting the parametrize arguments is necessary to avoid a parallelization</span>
<span class="s3"># issue described here: https://github.com/pytest-dev/pytest-xdist/issues/432.</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_AVAILABLE</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_conditionally_positive_definite</span><span class="s2">(</span><span class="s1">kernel</span><span class="s2">):</span>
    <span class="s3"># Test if each kernel in _AVAILABLE is conditionally positive definite of</span>
    <span class="s3"># order m, where m comes from _NAME_TO_MIN_DEGREE. This is a necessary</span>
    <span class="s3"># condition for the smoothed RBF interpolant to be well-posed in general.</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">_NAME_TO_MIN_DEGREE</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">kernel</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">) + </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">_is_conditionally_positive_definite</span><span class="s2">(</span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_TestRBFInterpolator</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_SCALE_INVARIANT</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_scale_invariance_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">):</span>
        <span class="s3"># Verify that the functions in _SCALE_INVARIANT are insensitive to the</span>
        <span class="s3"># shape parameter (when smoothing == 0) in 1d.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_SCALE_INVARIANT</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_scale_invariance_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">):</span>
        <span class="s3"># Verify that the functions in _SCALE_INVARIANT are insensitive to the</span>
        <span class="s3"># shape parameter (when smoothing == 0) in 2d.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_AVAILABLE</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_extreme_domains</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">):</span>
        <span class="s3"># Make sure the interpolant remains numerically stable for very</span>
        <span class="s3"># large/small domains.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>
        <span class="s1">scale </span><span class="s2">= </span><span class="s4">1e50</span>
        <span class="s1">shift </span><span class="s2">= </span><span class="s4">1e55</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">kernel </span><span class="s0">in </span><span class="s1">_SCALE_INVARIANT</span><span class="s2">:</span>
            <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
            <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span>
                <span class="s1">x</span><span class="s2">*</span><span class="s1">scale </span><span class="s2">+ </span><span class="s1">shift</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
                <span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span>
                <span class="s2">)(</span><span class="s1">xitp</span><span class="s2">*</span><span class="s1">scale </span><span class="s2">+ </span><span class="s1">shift</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">5.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
            <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span>
                <span class="s1">x</span><span class="s2">*</span><span class="s1">scale </span><span class="s2">+ </span><span class="s1">shift</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
                <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">5.0</span><span class="s2">/</span><span class="s1">scale</span><span class="s2">,</span>
                <span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span>
                <span class="s2">)(</span><span class="s1">xitp</span><span class="s2">*</span><span class="s1">scale </span><span class="s2">+ </span><span class="s1">shift</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_polynomial_reproduction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># If the observed data comes from a polynomial, then the interpolant</span>
        <span class="s3"># should be able to reproduce the polynomial exactly, provided that</span>
        <span class="s3"># `degree` is sufficiently high.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">degree </span><span class="s2">= </span><span class="s4">3</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">P </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">Pitp </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>

        <span class="s1">poly_coeffs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">P</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">P</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">poly_coeffs</span><span class="s2">)</span>
        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">Pitp</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">poly_coeffs</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_chunking</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
        <span class="s3"># If the observed data comes from a polynomial, then the interpolant</span>
        <span class="s3"># should be able to reproduce the polynomial exactly, provided that</span>
        <span class="s3"># `degree` is sufficiently high.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">degree </span><span class="s2">= </span><span class="s4">3</span>

        <span class="s1">largeN </span><span class="s2">= </span><span class="s4">1000 </span><span class="s2">+ </span><span class="s4">33</span>
        <span class="s3"># this is large to check that chunking of the RBFInterpolator is tested</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">largeN</span><span class="s2">)</span>

        <span class="s1">P </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">Pitp </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>

        <span class="s1">poly_coeffs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">P</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">P</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">poly_coeffs</span><span class="s2">)</span>
        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">Pitp</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">poly_coeffs</span><span class="s2">)</span>
        <span class="s1">interp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">ce_real </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">.</span><span class="s1">_chunk_evaluator</span>

        <span class="s0">def </span><span class="s1">_chunk_evaluator</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">kwargs</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">memory_budget</span><span class="s2">=</span><span class="s4">100</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">ce_real</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">, </span><span class="s5">'_chunk_evaluator'</span><span class="s2">, </span><span class="s1">_chunk_evaluator</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_vector_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Make sure interpolating a vector field is the same as interpolating</span>
        <span class="s3"># each component separately.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">),</span>
                      <span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, ::-</span><span class="s4">1</span><span class="s2">])]).</span><span class="s1">T</span>

        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">])(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp3 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">])(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">yitp2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">yitp3</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_complex_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Interpolating complex input should be the same as interpolating the</span>
        <span class="s3"># real and complex components.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, ::-</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp3 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">yitp3</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_AVAILABLE</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_interpolation_misfit_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">):</span>
        <span class="s3"># Make sure that each kernel, with its default `degree` and an</span>
        <span class="s3"># appropriate `epsilon`, does a good job at interpolation in 1d.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">ytrue </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">5.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">mse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">((</span><span class="s1">yitp </span><span class="s2">- </span><span class="s1">ytrue</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">mse </span><span class="s2">&lt; </span><span class="s4">1.0e-4</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_AVAILABLE</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_interpolation_misfit_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">):</span>
        <span class="s3"># Make sure that each kernel, with its default `degree` and an</span>
        <span class="s3"># appropriate `epsilon`, does a good job at interpolation in 2d.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">ytrue </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">5.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">mse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">((</span><span class="s1">yitp </span><span class="s2">- </span><span class="s1">ytrue</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">mse </span><span class="s2">&lt; </span><span class="s4">2.0e-4</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'kernel'</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">_AVAILABLE</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_smoothing_misfit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">):</span>
        <span class="s3"># Make sure we can find a smoothing parameter for each kernel that</span>
        <span class="s3"># removes a sufficient amount of noise.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

        <span class="s1">noise </span><span class="s2">= </span><span class="s4">0.2</span>
        <span class="s1">rmse_tol </span><span class="s2">= </span><span class="s4">0.1</span>
        <span class="s1">smoothing_range </span><span class="s2">= </span><span class="s4">10</span><span class="s2">**</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) + </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">noise</span><span class="s2">, (</span><span class="s4">100</span><span class="s2">,))</span>
        <span class="s1">ytrue </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">rmse_within_tol </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">for </span><span class="s1">smoothing </span><span class="s0">in </span><span class="s1">smoothing_range</span><span class="s2">:</span>
            <span class="s1">ysmooth </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span>
                <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
                <span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">,</span>
                <span class="s1">smoothing</span><span class="s2">=</span><span class="s1">smoothing</span><span class="s2">,</span>
                <span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">rmse </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">((</span><span class="s1">ysmooth </span><span class="s2">- </span><span class="s1">ytrue</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">))</span>
            <span class="s0">if </span><span class="s1">rmse </span><span class="s2">&lt; </span><span class="s1">rmse_tol</span><span class="s2">:</span>
                <span class="s1">rmse_within_tol </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">break</span>

        <span class="s0">assert </span><span class="s1">rmse_within_tol</span>

    <span class="s0">def </span><span class="s1">test_array_smoothing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Test using an array for `smoothing` to give less weight to a known</span>
        <span class="s3"># outlier.</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">degree </span><span class="s2">= </span><span class="s4">2</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">P </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">poly_coeffs </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">P</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">P</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">poly_coeffs</span><span class="s2">)</span>
        <span class="s1">y_with_outlier </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">y_with_outlier</span><span class="s2">[</span><span class="s4">10</span><span class="s2">] += </span><span class="s4">1.0</span>
        <span class="s1">smoothing </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">50</span><span class="s2">,))</span>
        <span class="s1">smoothing</span><span class="s2">[</span><span class="s4">10</span><span class="s2">] = </span><span class="s4">1000.0</span>
        <span class="s1">yitp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_with_outlier</span><span class="s2">, </span><span class="s1">smoothing</span><span class="s2">=</span><span class="s1">smoothing</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s3"># Should be able to reproduce the uncorrupted data almost exactly.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inconsistent_x_dimensions_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># ValueError should be raised if the observation points and evaluation</span>
        <span class="s3"># points have a different number of dimensions.</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">()).</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">()).</span><span class="s1">random</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'Expected the second axis of `x`'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inconsistent_d_length_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'Expected the first axis of `d`'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_y_not_2d_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'`y` must be a 2-dimensional array.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_inconsistent_smoothing_length_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">smoothing </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'Expected `smoothing` to be'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">smoothing</span><span class="s2">=</span><span class="s1">smoothing</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_kernel_name_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'`kernel` must be one of'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s5">'test'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_epsilon_not_specified_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">kernel </span><span class="s0">in </span><span class="s1">_AVAILABLE</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">kernel </span><span class="s0">in </span><span class="s1">_SCALE_INVARIANT</span><span class="s2">:</span>
                <span class="s0">continue</span>

            <span class="s1">match </span><span class="s2">= </span><span class="s5">'`epsilon` must be specified'</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x_not_2d_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'`x` must be a 2-dimensional array.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_enough_observations_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'At least 2 data points are required'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s5">'thin_plate_spline'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_degree_warning</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">deg </span><span class="s0">in </span><span class="s1">_NAME_TO_MIN_DEGREE</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s3"># Only test for kernels that its minimum degree is not 0.</span>
            <span class="s0">if </span><span class="s1">deg </span><span class="s2">&gt;= </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">match </span><span class="s2">= </span><span class="s5">f'`degree` should not be below </span><span class="s0">{</span><span class="s1">deg</span><span class="s0">}</span><span class="s5">'</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">Warning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=</span><span class="s1">deg</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_minus_one_degree</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Make sure a degree of -1 is accepted without any warning.</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">_NAME_TO_MIN_DEGREE</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">epsilon</span><span class="s2">=</span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s1">kernel</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rank_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># An error should be raised when `kernel` is &quot;thin_plate_spline&quot; and</span>
        <span class="s3"># observations are 2-D and collinear.</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">], [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">]])</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">])</span>
        <span class="s1">match </span><span class="s2">= </span><span class="s5">'does not have full column rank'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">LinAlgError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s5">'thin_plate_spline'</span><span class="s2">)(</span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_point</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Make sure interpolation still works with only one point (in 1, 2, and</span>
        <span class="s3"># 3 dimensions).</span>
        <span class="s0">for </span><span class="s1">dim </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]:</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">dim</span><span class="s2">))</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s4">1</span><span class="s2">,))</span>
            <span class="s1">f </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">kernel</span><span class="s2">=</span><span class="s5">'linear'</span><span class="s2">)(</span><span class="s1">y</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">f</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pickleable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Make sure we can pickle and unpickle the interpolant without any</span>
        <span class="s3"># changes in the behavior.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">2305982309</span><span class="s2">))</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">interp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">interp</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">interp</span><span class="s2">))(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-16</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRBFInterpolatorNeighborsNone</span><span class="s2">(</span><span class="s1">_TestRBFInterpolator</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">RBFInterpolator</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_smoothing_limit_1d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># For large smoothing parameters, the interpolant should approach a</span>
        <span class="s3"># least squares fit of a polynomial with the specified degree.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">degree </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">smoothing </span><span class="s2">= </span><span class="s4">1e8</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
            <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
            <span class="s1">smoothing</span><span class="s2">=</span><span class="s1">smoothing</span>
            <span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">P </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">Pitp </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">Pitp</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">lstsq</span><span class="s2">(</span><span class="s1">P</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_smoothing_limit_2d</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># For large smoothing parameters, the interpolant should approach a</span>
        <span class="s3"># least squares fit of a polynomial with the specified degree.</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">degree </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">smoothing </span><span class="s2">= </span><span class="s4">1e8</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span>
            <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">,</span>
            <span class="s1">degree</span><span class="s2">=</span><span class="s1">degree</span><span class="s2">,</span>
            <span class="s1">smoothing</span><span class="s2">=</span><span class="s1">smoothing</span>
            <span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">P </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">Pitp </span><span class="s2">= </span><span class="s1">_vandermonde</span><span class="s2">(</span><span class="s1">xitp</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">Pitp</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">lstsq</span><span class="s2">(</span><span class="s1">P</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRBFInterpolatorNeighbors20</span><span class="s2">(</span><span class="s1">_TestRBFInterpolator</span><span class="s2">):</span>
    <span class="s3"># RBFInterpolator using 20 nearest neighbors.</span>
    <span class="s0">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">RBFInterpolator</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">neighbors</span><span class="s2">=</span><span class="s4">20</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equivalent_to_rbf_interpolator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_2d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">yitp2 </span><span class="s2">= []</span>
        <span class="s1">tree </span><span class="s2">= </span><span class="s1">cKDTree</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">xi </span><span class="s0">in </span><span class="s1">xitp</span><span class="s2">:</span>
            <span class="s1">_</span><span class="s2">, </span><span class="s1">nbr </span><span class="s2">= </span><span class="s1">tree</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)</span>
            <span class="s1">yitp2</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">RBFInterpolator</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">nbr</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[</span><span class="s1">nbr</span><span class="s2">])(</span><span class="s1">xi</span><span class="s2">[</span><span class="s0">None</span><span class="s2">])[</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestRBFInterpolatorNeighborsInf</span><span class="s2">(</span><span class="s1">TestRBFInterpolatorNeighborsNone</span><span class="s2">):</span>
    <span class="s3"># RBFInterpolator using neighbors=np.inf. This should give exactly the same</span>
    <span class="s3"># results as neighbors=None, but it will be slower.</span>
    <span class="s0">def </span><span class="s1">build</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">RBFInterpolator</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">neighbors</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_equivalent_to_rbf_interpolator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">seq </span><span class="s2">= </span><span class="s1">Halton</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">scramble</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">())</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xitp </span><span class="s2">= </span><span class="s4">3</span><span class="s2">*</span><span class="s1">seq</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">50</span><span class="s2">)</span>

        <span class="s1">y </span><span class="s2">= </span><span class="s1">_1d_test_function</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">yitp1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">build</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>
        <span class="s1">yitp2 </span><span class="s2">= </span><span class="s1">RBFInterpolator</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)(</span><span class="s1">xitp</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yitp1</span><span class="s2">, </span><span class="s1">yitp2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-8</span><span class="s2">)</span>
</pre>
</body>
</html>