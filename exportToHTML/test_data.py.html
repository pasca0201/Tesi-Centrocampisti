<html>
<head>
<title>test_data.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_data.py</font>
</center></td></tr></table>
<pre><span class="s0"># Authors:</span>
<span class="s0">#</span>
<span class="s0">#          Giorgio Patrini</span>
<span class="s0">#</span>
<span class="s0"># License: BSD 3 clause</span>

<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">warnings</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">linalg </span><span class="s2">as </span><span class="s1">la</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">sparse</span><span class="s3">, </span><span class="s1">stats</span>

<span class="s2">from </span><span class="s1">sklearn </span><span class="s2">import </span><span class="s1">datasets</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">base </span><span class="s2">import </span><span class="s1">clone</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">NotFittedError</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">pairwise </span><span class="s2">import </span><span class="s1">linear_kernel</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection </span><span class="s2">import </span><span class="s1">cross_val_predict</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">pipeline </span><span class="s2">import </span><span class="s1">Pipeline</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">preprocessing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">Binarizer</span><span class="s3">,</span>
    <span class="s1">KernelCenterer</span><span class="s3">,</span>
    <span class="s1">MaxAbsScaler</span><span class="s3">,</span>
    <span class="s1">MinMaxScaler</span><span class="s3">,</span>
    <span class="s1">Normalizer</span><span class="s3">,</span>
    <span class="s1">PowerTransformer</span><span class="s3">,</span>
    <span class="s1">QuantileTransformer</span><span class="s3">,</span>
    <span class="s1">RobustScaler</span><span class="s3">,</span>
    <span class="s1">StandardScaler</span><span class="s3">,</span>
    <span class="s1">add_dummy_feature</span><span class="s3">,</span>
    <span class="s1">maxabs_scale</span><span class="s3">,</span>
    <span class="s1">minmax_scale</span><span class="s3">,</span>
    <span class="s1">normalize</span><span class="s3">,</span>
    <span class="s1">power_transform</span><span class="s3">,</span>
    <span class="s1">quantile_transform</span><span class="s3">,</span>
    <span class="s1">robust_scale</span><span class="s3">,</span>
    <span class="s1">scale</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">preprocessing</span><span class="s3">.</span><span class="s1">_data </span><span class="s2">import </span><span class="s1">BOUNDS_THRESHOLD</span><span class="s3">, </span><span class="s1">_handle_zeros_in_scale</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">svm </span><span class="s2">import </span><span class="s1">SVR</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">gen_batches</span><span class="s3">, </span><span class="s1">shuffle</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_array_api </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">yield_namespace_device_dtype_combinations</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_convert_container</span><span class="s3">,</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">,</span>
    <span class="s1">assert_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_less</span><span class="s3">,</span>
    <span class="s1">skip_if_32bit</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">estimator_checks </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">_get_check_estimator_ids</span><span class="s3">,</span>
    <span class="s1">check_array_api_input_and_values</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">COO_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">CSC_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">CSR_CONTAINERS</span><span class="s3">,</span>
    <span class="s1">LIL_CONTAINERS</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">sparsefuncs </span><span class="s2">import </span><span class="s1">mean_variance_axis</span>

<span class="s1">iris </span><span class="s3">= </span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">load_iris</span><span class="s3">()</span>

<span class="s0"># Make some data to be used many times</span>
<span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
<span class="s1">n_features </span><span class="s3">= </span><span class="s4">30</span>
<span class="s1">n_samples </span><span class="s3">= </span><span class="s4">1000</span>
<span class="s1">offsets </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_features</span><span class="s3">)</span>
<span class="s1">scales </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_features</span><span class="s3">)</span>
<span class="s1">X_2d </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">) * </span><span class="s1">scales </span><span class="s3">+ </span><span class="s1">offsets</span>
<span class="s1">X_1row </span><span class="s3">= </span><span class="s1">X_2d</span><span class="s3">[</span><span class="s4">0</span><span class="s3">, :].</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
<span class="s1">X_1col </span><span class="s3">= </span><span class="s1">X_2d</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">].</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
<span class="s1">X_list_1row </span><span class="s3">= </span><span class="s1">X_1row</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">()</span>
<span class="s1">X_list_1col </span><span class="s3">= </span><span class="s1">X_1col</span><span class="s3">.</span><span class="s1">tolist</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">a</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s5">&quot;toarray&quot;</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>
    <span class="s2">return </span><span class="s1">a</span>


<span class="s2">def </span><span class="s1">_check_dim_1axis</span><span class="s3">(</span><span class="s1">a</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">a</span><span class="s3">).</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">assert_correct_incr</span><span class="s3">(</span><span class="s1">i</span><span class="s3">, </span><span class="s1">batch_start</span><span class="s3">, </span><span class="s1">batch_stop</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">, </span><span class="s1">n_samples_seen</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">batch_stop </span><span class="s3">!= </span><span class="s1">n</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">) * </span><span class="s1">chunk_size </span><span class="s3">== </span><span class="s1">n_samples_seen</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">i </span><span class="s3">* </span><span class="s1">chunk_size </span><span class="s3">+ (</span><span class="s1">batch_stop </span><span class="s3">- </span><span class="s1">batch_start</span><span class="s3">) == </span><span class="s1">n_samples_seen</span>


<span class="s2">def </span><span class="s1">test_raises_value_error_if_sample_weights_greater_than_1d</span><span class="s3">():</span>
    <span class="s0"># Sample weights must be either scalar or 1D</span>

    <span class="s1">n_sampless </span><span class="s3">= [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]</span>
    <span class="s1">n_featuress </span><span class="s3">= [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">n_sampless</span><span class="s3">, </span><span class="s1">n_featuress</span><span class="s3">):</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>

        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>

        <span class="s0"># make sure Error is raised the sample weights greater than 1d</span>
        <span class="s1">sample_weight_notOK </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s4">1</span><span class="s3">) ** </span><span class="s4">2</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight_notOK</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s3">[</span><span class="s5">&quot;Xw&quot;</span><span class="s3">, </span><span class="s5">&quot;X&quot;</span><span class="s3">, </span><span class="s5">&quot;sample_weight&quot;</span><span class="s3">],</span>
    <span class="s3">[</span>
        <span class="s3">([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">]], [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">]], [</span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">]),</span>
        <span class="s3">(</span>
            <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]],</span>
            <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]],</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]),</span>
        <span class="s3">),</span>
        <span class="s3">(</span>
            <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]],</span>
            <span class="s3">[</span>
                <span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
                <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
                <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
                <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
            <span class="s3">],</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]),</span>
        <span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;array_constructor&quot;</span><span class="s3">, [</span><span class="s5">&quot;array&quot;</span><span class="s3">, </span><span class="s5">&quot;sparse_csr&quot;</span><span class="s3">, </span><span class="s5">&quot;sparse_csc&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_sample_weight</span><span class="s3">(</span><span class="s1">Xw</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">array_constructor</span><span class="s3">):</span>
    <span class="s1">with_mean </span><span class="s3">= </span><span class="s2">not </span><span class="s1">array_constructor</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s5">&quot;sparse&quot;</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">array_constructor</span><span class="s3">)</span>
    <span class="s1">Xw </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span><span class="s1">Xw</span><span class="s3">, </span><span class="s1">array_constructor</span><span class="s3">)</span>

    <span class="s0"># weighted StandardScaler</span>
    <span class="s1">yw </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">Xw</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>
    <span class="s1">scaler_w </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s1">with_mean</span><span class="s3">)</span>
    <span class="s1">scaler_w</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">Xw</span><span class="s3">, </span><span class="s1">yw</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>

    <span class="s0"># unweighted, but with repeated samples</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s1">with_mean</span><span class="s3">)</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">X_test </span><span class="s3">= [[</span><span class="s4">1.5</span><span class="s3">, </span><span class="s4">2.5</span><span class="s3">, </span><span class="s4">3.5</span><span class="s3">], [</span><span class="s4">3.5</span><span class="s3">, </span><span class="s4">4.5</span><span class="s3">, </span><span class="s4">5.5</span><span class="s3">]]</span>

    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">scaler_w</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">scaler_w</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">), </span><span class="s1">scaler_w</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_standard_scaler_1d</span><span class="s3">():</span>
    <span class="s0"># Test scaling of dataset along single axis</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">[</span><span class="s1">X_1row</span><span class="s3">, </span><span class="s1">X_1col</span><span class="s3">, </span><span class="s1">X_list_1row</span><span class="s3">, </span><span class="s1">X_list_1row</span><span class="s3">]:</span>
        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)  </span><span class="s0"># cast only after scaling done</span>

        <span class="s2">if </span><span class="s1">_check_dim_1axis</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">())</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">())</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">std</span><span class="s3">())</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

        <span class="s0"># check inverse transform</span>
        <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled_back</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Constant feature</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;add_sample_weight&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_dtype</span><span class="s3">(</span><span class="s1">add_sample_weight</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># Ensure scaling does not affect dtype</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">10</span>
    <span class="s1">n_features </span><span class="s3">= </span><span class="s4">3</span>
    <span class="s2">if </span><span class="s1">add_sample_weight</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s1">with_mean </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s0"># scipy sparse containers do not support float16, see</span>
        <span class="s0"># https://github.com/scipy/scipy/issues/7408 for more details.</span>
        <span class="s1">supported_dtype </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">]</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">supported_dtype </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">supported_dtype</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">with_mean </span><span class="s3">= </span><span class="s2">False</span>

        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s1">with_mean</span><span class="s3">)</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">dtype</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;scaler&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
        <span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;add_sample_weight&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;dtype&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;constant&quot;</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">100.0</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_constant_features</span><span class="s3">(</span>
    <span class="s1">scaler</span><span class="s3">, </span><span class="s1">add_sample_weight</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">constant</span>
<span class="s3">):</span>
    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">RobustScaler</span><span class="s3">) </span><span class="s2">and </span><span class="s1">add_sample_weight</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">f&quot;</span><span class="s2">{</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">} </span><span class="s5">does not yet support sample_weight&quot;</span><span class="s3">)</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">100</span>
    <span class="s1">n_features </span><span class="s3">= </span><span class="s4">1</span>
    <span class="s2">if </span><span class="s1">add_sample_weight</span><span class="s3">:</span>
        <span class="s1">fit_params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">) * </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">fit_params </span><span class="s3">= {}</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">), </span><span class="s1">fill_value</span><span class="s3">=</span><span class="s1">constant</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_array </span><span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is None else </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, **</span><span class="s1">fit_params</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">):</span>
        <span class="s0"># The variance info should be close to zero for constant features.</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]), </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-7</span><span class="s3">)</span>

    <span class="s0"># Constant features should not be scaled (scale of 1.):</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]))</span>

    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X  </span><span class="s0"># make sure we make a copy</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">, </span><span class="s1">StandardScaler</span><span class="s3">) </span><span class="s2">and not </span><span class="s1">add_sample_weight</span><span class="s3">:</span>
        <span class="s0"># Also check consistency with the standard scale function.</span>
        <span class="s1">X_scaled_2 </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">with_mean</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_scaled_2 </span><span class="s2">is not </span><span class="s1">X  </span><span class="s0"># make sure we did a copy</span>
        <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">X_scaled_2</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;n_samples&quot;</span><span class="s3">, [</span><span class="s4">10</span><span class="s3">, </span><span class="s4">100</span><span class="s3">, </span><span class="s4">10_000</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;average&quot;</span><span class="s3">, [</span><span class="s4">1e-10</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1e10</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;dtype&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_near_constant_features</span><span class="s3">(</span>
    <span class="s1">n_samples</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">, </span><span class="s1">average</span><span class="s3">, </span><span class="s1">dtype</span>
<span class="s3">):</span>
    <span class="s0"># Check that when the variance is too small (var &lt;&lt; mean**2) the feature</span>
    <span class="s0"># is considered constant and not scaled.</span>

    <span class="s1">scale_min</span><span class="s3">, </span><span class="s1">scale_max </span><span class="s3">= -</span><span class="s4">30</span><span class="s3">, </span><span class="s4">19</span>
    <span class="s1">scales </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">10</span><span class="s3">**</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">scale_min</span><span class="s3">, </span><span class="s1">scale_max </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>

    <span class="s1">n_features </span><span class="s3">= </span><span class="s1">scales</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s0"># Make a dataset of known var = scales**2 and mean = average</span>
    <span class="s1">X</span><span class="s3">[: </span><span class="s1">n_samples </span><span class="s3">// </span><span class="s4">2</span><span class="s3">, :] = </span><span class="s1">average </span><span class="s3">+ </span><span class="s1">scales</span>
    <span class="s1">X</span><span class="s3">[</span><span class="s1">n_samples </span><span class="s3">// </span><span class="s4">2 </span><span class="s3">:, :] = </span><span class="s1">average </span><span class="s3">- </span><span class="s1">scales</span>
    <span class="s1">X_array </span><span class="s3">= </span><span class="s1">X </span><span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is None else </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_array</span><span class="s3">)</span>

    <span class="s0"># StandardScaler uses float64 accumulators even if the data has a float32</span>
    <span class="s0"># dtype.</span>
    <span class="s1">eps </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">eps</span>

    <span class="s0"># if var &lt; bound = N.eps.var + N².eps².mean², the feature is considered</span>
    <span class="s0"># constant and the scale_ attribute is set to 1.</span>
    <span class="s1">bounds </span><span class="s3">= </span><span class="s1">n_samples </span><span class="s3">* </span><span class="s1">eps </span><span class="s3">* </span><span class="s1">scales</span><span class="s3">**</span><span class="s4">2 </span><span class="s3">+ </span><span class="s1">n_samples</span><span class="s3">**</span><span class="s4">2 </span><span class="s3">* </span><span class="s1">eps</span><span class="s3">**</span><span class="s4">2 </span><span class="s3">* </span><span class="s1">average</span><span class="s3">**</span><span class="s4">2</span>
    <span class="s1">within_bounds </span><span class="s3">= </span><span class="s1">scales</span><span class="s3">**</span><span class="s4">2 </span><span class="s3">&lt;= </span><span class="s1">bounds</span>

    <span class="s0"># Check that scale_min is small enough to have some scales below the</span>
    <span class="s0"># bound and therefore detected as constant:</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">within_bounds</span><span class="s3">)</span>

    <span class="s0"># Check that such features are actually treated as constant by the scaler:</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">[</span><span class="s1">within_bounds</span><span class="s3">] &lt;= </span><span class="s1">bounds</span><span class="s3">[</span><span class="s1">within_bounds</span><span class="s3">])</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">[</span><span class="s1">within_bounds</span><span class="s3">], </span><span class="s4">1.0</span><span class="s3">)</span>

    <span class="s0"># Depending the on the dtype of X, some features might not actually be</span>
    <span class="s0"># representable as non constant for small scales (even if above the</span>
    <span class="s0"># precision bound of the float64 variance estimate). Such feature should</span>
    <span class="s0"># be correctly detected as constants with 0 variance by StandardScaler.</span>
    <span class="s1">representable_diff </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[</span><span class="s4">0</span><span class="s3">, :] - </span><span class="s1">X</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">, :] != </span><span class="s4">0</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logical_not</span><span class="s3">(</span><span class="s1">representable_diff</span><span class="s3">)], </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">logical_not</span><span class="s3">(</span><span class="s1">representable_diff</span><span class="s3">)], </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s0"># The other features are scaled and scale_ is equal to sqrt(var_) assuming</span>
    <span class="s0"># that scales are large enough for average + scale and average - scale to</span>
    <span class="s0"># be distinct in X (depending on X's dtype).</span>
    <span class="s1">common_mask </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">logical_and</span><span class="s3">(</span><span class="s1">scales</span><span class="s3">**</span><span class="s4">2 </span><span class="s3">&gt; </span><span class="s1">bounds</span><span class="s3">, </span><span class="s1">representable_diff</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">[</span><span class="s1">common_mask</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">)[</span><span class="s1">common_mask</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_scale_1d</span><span class="s3">():</span>
    <span class="s0"># 1-d inputs</span>
    <span class="s1">X_list </span><span class="s3">= [</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">5.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">]</span>
    <span class="s1">X_arr </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X_list</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">[</span><span class="s1">X_list</span><span class="s3">, </span><span class="s1">X_arr</span><span class="s3">]:</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s4">0.0</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(), </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">skip_if_32bit</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_numerical_stability</span><span class="s3">():</span>
    <span class="s0"># Test numerical stability of scaling</span>
    <span class="s0"># np.log(1e-5) is taken because of its floating point representation</span>
    <span class="s0"># was empirically found to cause numerical problems with np.mean &amp; np.std.</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s4">8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s4">1e-5</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s0"># This does not raise a warning as the number of samples is too low</span>
    <span class="s0"># to trigger the problem in recent numpy</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, </span><span class="s1">UserWarning</span><span class="s3">)</span>
        <span class="s1">scale</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">(</span><span class="s1">x</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s4">8</span><span class="s3">))</span>

    <span class="s0"># with 2 more samples, the std computation run into numerical issues:</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s4">1e-5</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= </span><span class="s5">&quot;standard deviation of the data is probably very close to 0&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">x_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x_scaled</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s4">10</span><span class="s3">))</span>

    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1e-100</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, </span><span class="s1">UserWarning</span><span class="s3">)</span>
        <span class="s1">x_small_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x_small_scaled</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s4">10</span><span class="s3">))</span>

    <span class="s0"># Large values can cause (often recoverable) numerical stability issues:</span>
    <span class="s1">x_big </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1e100</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">warning_message </span><span class="s3">= </span><span class="s5">&quot;Dataset may contain too large values&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">x_big_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">x_big</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x_big_scaled</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x_big_scaled</span><span class="s3">, </span><span class="s1">x_small_scaled</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">x_big_centered </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">x_big</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x_big_centered</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">x_big_centered</span><span class="s3">, </span><span class="s1">x_small_scaled</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_scaler_2d_arrays</span><span class="s3">():</span>
    <span class="s0"># Test scaling of 2d array along first axis</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_features </span><span class="s3">= </span><span class="s4">5</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">4</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0.0  </span><span class="s0"># first feature is always of zero</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">n_samples</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">n_features </span><span class="s3">* [</span><span class="s4">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s0"># Check that X has been copied</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X</span>

    <span class="s0"># check inverse transform</span>
    <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_scaled_back </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">X_scaled_back </span><span class="s2">is not </span><span class="s1">X_scaled</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled_back</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">n_samples </span><span class="s3">* [</span><span class="s4">0.0</span><span class="s3">])</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">n_samples </span><span class="s3">* [</span><span class="s4">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s1">n_samples </span><span class="s3">* [</span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s0"># Check that the data hasn't been modified</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X</span>

    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">n_features </span><span class="s3">* [</span><span class="s4">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s0"># Check that X has not been copied</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is </span><span class="s1">X</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">1.0  </span><span class="s0"># first feature is a constant, non zero feature</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">n_features </span><span class="s3">* [</span><span class="s4">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s0"># Check that X has not been copied</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X</span>


<span class="s2">def </span><span class="s1">test_scaler_float16_overflow</span><span class="s3">():</span>
    <span class="s0"># Test if the scaler will not overflow on float16 numpy arrays</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s0"># float16 has a maximum of 65500.0. On the worst case 5 * 200000 is 100000</span>
    <span class="s0"># which is enough to overflow the data type</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, [</span><span class="s4">200000</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float16</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">over</span><span class="s3">=</span><span class="s5">&quot;raise&quot;</span><span class="s3">):</span>
        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Calculate the float64 equivalent to verify result</span>
    <span class="s1">X_scaled_f64 </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">))</span>

    <span class="s0"># Overflow calculations may cause -inf, inf, or nan. Since there is no nan</span>
    <span class="s0"># input, all of the outputs should be finite. This may be redundant since a</span>
    <span class="s0"># FloatingPointError exception will be thrown on overflow above.</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>

    <span class="s0"># The normal distribution is very unlikely to go above 4. At 4.0-8.0 the</span>
    <span class="s0"># float16 precision is 2^-8 which is around 0.004. Thus only 2 decimals are</span>
    <span class="s0"># checked to account for precision differences.</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">, </span><span class="s1">X_scaled_f64</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_handle_zeros_in_scale</span><span class="s3">():</span>
    <span class="s1">s1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1e-16</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])</span>
    <span class="s1">s2 </span><span class="s3">= </span><span class="s1">_handle_zeros_in_scale</span><span class="s3">(</span><span class="s1">s1</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">s1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1e-16</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">s2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]))</span>


<span class="s2">def </span><span class="s1">test_minmax_scaler_partial_fit</span><span class="s3">():</span>
    <span class="s0"># Test if partial_fit run over many batches of size 1 and 50</span>
    <span class="s0"># gives the same results as fit</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_2d</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">chunk_size </span><span class="s2">in </span><span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">42</span><span class="s3">]:</span>
        <span class="s0"># Test mean at the end of the process</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">):</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">data_min_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">data_min_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">data_max_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">data_max_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">data_range_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">data_range_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">min_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">min_</span><span class="s3">)</span>

        <span class="s0"># Test std after 1 step</span>
        <span class="s1">batch0 </span><span class="s3">= </span><span class="s1">slice</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">)</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">])</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">().</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">])</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">data_min_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">data_min_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">data_max_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">data_max_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">data_range_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">data_range_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">min_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">min_</span><span class="s3">)</span>

        <span class="s0"># Test std until the end of partial fits, and</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">()  </span><span class="s0"># Clean estimator</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">)):</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
            <span class="s1">assert_correct_incr</span><span class="s3">(</span>
                <span class="s1">i</span><span class="s3">,</span>
                <span class="s1">batch_start</span><span class="s3">=</span><span class="s1">batch</span><span class="s3">.</span><span class="s1">start</span><span class="s3">,</span>
                <span class="s1">batch_stop</span><span class="s3">=</span><span class="s1">batch</span><span class="s3">.</span><span class="s1">stop</span><span class="s3">,</span>
                <span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">,</span>
                <span class="s1">chunk_size</span><span class="s3">=</span><span class="s1">chunk_size</span><span class="s3">,</span>
                <span class="s1">n_samples_seen</span><span class="s3">=</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_standard_scaler_partial_fit</span><span class="s3">():</span>
    <span class="s0"># Test if partial_fit run over many batches of size 1 and 50</span>
    <span class="s0"># gives the same results as fit</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_2d</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">chunk_size </span><span class="s2">in </span><span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">42</span><span class="s3">]:</span>
        <span class="s0"># Test mean at the end of the process</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">):</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">var_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_  </span><span class="s0"># Nones</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>

        <span class="s0"># Test std after 1 step</span>
        <span class="s1">batch0 </span><span class="s3">= </span><span class="s1">slice</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">)</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">])</span>
        <span class="s2">if </span><span class="s1">chunk_size </span><span class="s3">== </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                <span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_</span>
            <span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                <span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
                <span class="s1">np</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">], </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span>
            <span class="s3">)  </span><span class="s0"># no constants</span>

        <span class="s0"># Test std until the end of partial fits, and</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()  </span><span class="s0"># Clean estimator</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">)):</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
            <span class="s1">assert_correct_incr</span><span class="s3">(</span>
                <span class="s1">i</span><span class="s3">,</span>
                <span class="s1">batch_start</span><span class="s3">=</span><span class="s1">batch</span><span class="s3">.</span><span class="s1">start</span><span class="s3">,</span>
                <span class="s1">batch_stop</span><span class="s3">=</span><span class="s1">batch</span><span class="s3">.</span><span class="s1">stop</span><span class="s3">,</span>
                <span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">,</span>
                <span class="s1">chunk_size</span><span class="s3">=</span><span class="s1">chunk_size</span><span class="s3">,</span>
                <span class="s1">n_samples_seen</span><span class="s3">=</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_partial_fit_numerical_stability</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># Test if the incremental computation introduces significative errors</span>
    <span class="s0"># for large datasets with values of large magniture</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_features </span><span class="s3">= </span><span class="s4">2</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">100</span>
    <span class="s1">offsets </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(-</span><span class="s4">1e15</span><span class="s3">, </span><span class="s4">1e15</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">scales </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s4">1e3</span><span class="s3">, </span><span class="s4">1e6</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_features</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">) * </span><span class="s1">scales </span><span class="s3">+ </span><span class="s1">offsets</span>

    <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">chunk </span><span class="s2">in </span><span class="s1">X</span><span class="s3">:</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">))</span>

    <span class="s0"># Regardless of abs values, they must not be more diff 6 significant digits</span>
    <span class="s1">tol </span><span class="s3">= </span><span class="s4">10 </span><span class="s3">** (-</span><span class="s4">6</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>
    <span class="s0"># NOTE Be aware that for much larger offsets std is very unstable (last</span>
    <span class="s0"># assert) while mean is OK.</span>

    <span class="s0"># Sparse input</span>
    <span class="s1">size </span><span class="s3">= (</span><span class="s4">100</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">scale </span><span class="s3">= </span><span class="s4">1e20</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">) * </span><span class="s1">scale</span><span class="s3">)</span>

    <span class="s0"># with_mean=False is required with sparse input</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">chunk </span><span class="s2">in </span><span class="s1">X</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">chunk</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s0"># Sparse arrays can be 1D (in scipy 1.14 and later) while old</span>
            <span class="s0"># sparse matrix instances are always 2D.</span>
            <span class="s1">chunk </span><span class="s3">= </span><span class="s1">chunk</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)</span>

    <span class="s0"># Regardless of magnitude, they must not differ more than of 6 digits</span>
    <span class="s1">tol </span><span class="s3">= </span><span class="s4">10 </span><span class="s3">** (-</span><span class="s4">6</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_ </span><span class="s2">is not None</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">tol</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sample_weight&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_partial_fit_sparse_input</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># Check that sparsity is not destroyed</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">1.0</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">], [</span><span class="s4">5.0</span><span class="s3">]]))</span>

    <span class="s2">if </span><span class="s1">sample_weight</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>

    <span class="s1">null_transform </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">X_null </span><span class="s3">= </span><span class="s1">null_transform</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_null</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>
    <span class="s1">X_orig </span><span class="s3">= </span><span class="s1">null_transform</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_null</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_orig</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_null</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_orig</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sample_weight&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_trasform_with_partial_fit</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">):</span>
    <span class="s0"># Check some postconditions after applying partial_fit and transform</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_2d</span><span class="s3">[:</span><span class="s4">100</span><span class="s3">, :]</span>

    <span class="s2">if </span><span class="s1">sample_weight</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>

    <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">1</span><span class="s3">)):</span>
        <span class="s1">X_sofar </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[: (</span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">), :]</span>
        <span class="s1">chunks_copy </span><span class="s3">= </span><span class="s1">X_sofar</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">sample_weight </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">scaled_batch </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sofar</span><span class="s3">)</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">scaled_batch </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit_transform</span><span class="s3">(</span>
                <span class="s1">X_sofar</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">[: </span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">]</span>
            <span class="s3">)</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span>
                <span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">], </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">]</span>
            <span class="s3">)</span>
        <span class="s1">scaled_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_sofar</span><span class="s3">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaled_batch</span><span class="s3">, </span><span class="s1">scaled_incr</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sofar</span><span class="s3">, </span><span class="s1">chunks_copy</span><span class="s3">)  </span><span class="s0"># No change</span>
        <span class="s1">right_input </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">scaled_incr</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sofar</span><span class="s3">, </span><span class="s1">right_input</span><span class="s3">)</span>

        <span class="s1">zero </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">])</span>
        <span class="s1">epsilon </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">float</span><span class="s3">).</span><span class="s1">eps</span>
        <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">zero</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">var_ </span><span class="s3">+ </span><span class="s1">epsilon</span><span class="s3">)  </span><span class="s0"># as less or equal</span>
        <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">zero</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_ </span><span class="s3">+ </span><span class="s1">epsilon</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">sample_weight </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s0"># (i+1) because the Scaler has been already fitted</span>
            <span class="s2">assert </span><span class="s3">(</span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">) == </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">[: </span><span class="s1">i </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">]) == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span>
                <span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_standard_check_array_of_inverse_transform</span><span class="s3">():</span>
    <span class="s0"># Check if StandardScaler inverse_transform is</span>
    <span class="s0"># converting the integer array to float</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
        <span class="s3">],</span>
        <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">,</span>
    <span class="s3">)</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">()</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s0"># The of inverse_transform should be converted</span>
    <span class="s0"># to a float array.</span>
    <span class="s0"># If not X *= self.scale_ will fail.</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;array_namespace, device, dtype_name&quot;</span><span class="s3">, </span><span class="s1">yield_namespace_device_dtype_combinations</span><span class="s3">()</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;check&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s1">check_array_api_input_and_values</span><span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=</span><span class="s1">_get_check_estimator_ids</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;estimator&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">MaxAbsScaler</span><span class="s3">(),</span>
        <span class="s1">MinMaxScaler</span><span class="s3">(),</span>
        <span class="s1">KernelCenterer</span><span class="s3">(),</span>
        <span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s5">&quot;l1&quot;</span><span class="s3">),</span>
        <span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s5">&quot;l2&quot;</span><span class="s3">),</span>
        <span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s5">&quot;max&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=</span><span class="s1">_get_check_estimator_ids</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scaler_array_api_compliance</span><span class="s3">(</span>
    <span class="s1">estimator</span><span class="s3">, </span><span class="s1">check</span><span class="s3">, </span><span class="s1">array_namespace</span><span class="s3">, </span><span class="s1">device</span><span class="s3">, </span><span class="s1">dtype_name</span>
<span class="s3">):</span>
    <span class="s1">name </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span>
    <span class="s1">check</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">array_namespace</span><span class="s3">, </span><span class="s1">device</span><span class="s3">=</span><span class="s1">device</span><span class="s3">, </span><span class="s1">dtype_name</span><span class="s3">=</span><span class="s1">dtype_name</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_min_max_scaler_iris</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">()</span>
    <span class="s0"># default params</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>

    <span class="s0"># not default params: min=1, max=2</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">(</span><span class="s1">feature_range</span><span class="s3">=(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">))</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>

    <span class="s0"># min=-.5, max=.6</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">(</span><span class="s1">feature_range</span><span class="s3">=(-</span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">0.6</span><span class="s3">))</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), -</span><span class="s4">0.5</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.6</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>

    <span class="s0"># raises on invalid range</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">(</span><span class="s1">feature_range</span><span class="s3">=(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_min_max_scaler_zero_variance_features</span><span class="s3">():</span>
    <span class="s0"># Check min max scaler on toy data with zero variance features</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">0.5</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.1</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">1.1</span><span class="s3">]]</span>

    <span class="s1">X_new </span><span class="s3">= [[+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [-</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">], [+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.5</span><span class="s3">]]</span>

    <span class="s0"># default params</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">()</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_expected_0_1 </span><span class="s3">= [[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected_0_1</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>

    <span class="s1">X_trans_new </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_new</span><span class="s3">)</span>
    <span class="s1">X_expected_0_1_new </span><span class="s3">= [[+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.500</span><span class="s3">], [-</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.083</span><span class="s3">], [+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.333</span><span class="s3">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans_new</span><span class="s3">, </span><span class="s1">X_expected_0_1_new</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s0"># not default params</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">(</span><span class="s1">feature_range</span><span class="s3">=(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">))</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_expected_1_2 </span><span class="s3">= [[</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.5</span><span class="s3">], [</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">], [</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected_1_2</span><span class="s3">)</span>

    <span class="s0"># function interface</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">minmax_scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected_0_1</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">minmax_scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">feature_range</span><span class="s3">=(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected_1_2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_minmax_scale_axis1</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">minmax_scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_min_max_scaler_1d</span><span class="s3">():</span>
    <span class="s0"># Test scaling of dataset along single axis</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">[</span><span class="s1">X_1row</span><span class="s3">, </span><span class="s1">X_1col</span><span class="s3">, </span><span class="s1">X_list_1row</span><span class="s3">, </span><span class="s1">X_list_1row</span><span class="s3">]:</span>
        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)  </span><span class="s0"># cast only after scaling done</span>

        <span class="s2">if </span><span class="s1">_check_dim_1axis</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

        <span class="s0"># check inverse transform</span>
        <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled_back</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Constant feature</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">()</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">min</span><span class="s3">() &gt;= </span><span class="s4">0.0</span>
    <span class="s2">assert </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">max</span><span class="s3">() &lt;= </span><span class="s4">1.0</span>
    <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s0"># Function interface</span>
    <span class="s1">X_1d </span><span class="s3">= </span><span class="s1">X_1row</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()</span>
    <span class="s1">min_ </span><span class="s3">= </span><span class="s1">X_1d</span><span class="s3">.</span><span class="s1">min</span><span class="s3">()</span>
    <span class="s1">max_ </span><span class="s3">= </span><span class="s1">X_1d</span><span class="s3">.</span><span class="s1">max</span><span class="s3">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">X_1d </span><span class="s3">- </span><span class="s1">min_</span><span class="s3">) / (</span><span class="s1">max_ </span><span class="s3">- </span><span class="s1">min_</span><span class="s3">), </span><span class="s1">minmax_scale</span><span class="s3">(</span><span class="s1">X_1d</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sample_weight&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">None</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scaler_without_centering</span><span class="s3">(</span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0.0  </span><span class="s0"># first feature is always of zero</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sample_weight</span><span class="s3">:</span>
        <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>

    <span class="s1">scaler_sparse </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span>
    <span class="s3">)</span>
    <span class="s1">X_sparse_scaled </span><span class="s3">= </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_sparse_scaled</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">n_samples_seen_</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sample_weight </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
            <span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">0.01</span><span class="s3">, </span><span class="s4">2.24</span><span class="s3">, -</span><span class="s4">0.35</span><span class="s3">, -</span><span class="s4">0.78</span><span class="s3">], </span><span class="s4">2</span>
        <span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>

    <span class="s1">X_sparse_scaled_mean</span><span class="s3">, </span><span class="s1">X_sparse_scaled_var </span><span class="s3">= </span><span class="s1">mean_variance_axis</span><span class="s3">(</span><span class="s1">X_sparse_scaled</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse_scaled_mean</span><span class="s3">, </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse_scaled_var</span><span class="s3">, </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>

    <span class="s0"># Check that X has not been modified (copy)</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">X_sparse_scaled </span><span class="s2">is not </span><span class="s1">X_sparse</span>

    <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_scaled_back </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">X_scaled_back </span><span class="s2">is not </span><span class="s1">X_scaled</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled_back</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_sparse_scaled_back </span><span class="s3">= </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_sparse_scaled</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_sparse_scaled_back </span><span class="s2">is not </span><span class="s1">X_sparse</span>
    <span class="s2">assert </span><span class="s1">X_sparse_scaled_back </span><span class="s2">is not </span><span class="s1">X_sparse_scaled</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse_scaled_back</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">in </span><span class="s1">CSR_CONTAINERS</span><span class="s3">:</span>
        <span class="s1">null_transform </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">X_null </span><span class="s3">= </span><span class="s1">null_transform</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_null</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">X_orig </span><span class="s3">= </span><span class="s1">null_transform</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_null</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_orig</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;with_mean&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;with_std&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scaler_n_samples_seen_with_nan</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">10</span><span class="s3">], [</span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">], [</span><span class="s4">8</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
    <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) </span><span class="s2">and </span><span class="s1">with_mean</span><span class="s3">:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">&quot;'with_mean=True' cannot be used with sparse matrix.&quot;</span><span class="s3">)</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s1">with_mean</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s1">with_std</span><span class="s3">)</span>
    <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">n_samples_seen_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">2</span><span class="s3">]))</span>


<span class="s2">def </span><span class="s1">_check_identity_scalers_attributes</span><span class="s3">(</span><span class="s1">scaler_1</span><span class="s3">, </span><span class="s1">scaler_2</span><span class="s3">):</span>
    <span class="s2">assert </span><span class="s1">scaler_1</span><span class="s3">.</span><span class="s1">mean_ </span><span class="s2">is </span><span class="s1">scaler_2</span><span class="s3">.</span><span class="s1">mean_ </span><span class="s2">is None</span>
    <span class="s2">assert </span><span class="s1">scaler_1</span><span class="s3">.</span><span class="s1">var_ </span><span class="s2">is </span><span class="s1">scaler_2</span><span class="s3">.</span><span class="s1">var_ </span><span class="s2">is None</span>
    <span class="s2">assert </span><span class="s1">scaler_1</span><span class="s3">.</span><span class="s1">scale_ </span><span class="s2">is </span><span class="s1">scaler_2</span><span class="s3">.</span><span class="s1">scale_ </span><span class="s2">is None</span>
    <span class="s2">assert </span><span class="s1">scaler_1</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_2</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scaler_return_identity</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># test that the scaler return identity when with_mean and with_std are</span>
    <span class="s0"># False</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">8</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>

    <span class="s1">transformer_dense </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X_trans_dense </span><span class="s3">= </span><span class="s1">transformer_dense</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_trans_dense</span><span class="s3">, </span><span class="s1">X_dense</span><span class="s3">)</span>

    <span class="s1">transformer_sparse </span><span class="s3">= </span><span class="s1">clone</span><span class="s3">(</span><span class="s1">transformer_dense</span><span class="s3">)</span>
    <span class="s1">X_trans_sparse </span><span class="s3">= </span><span class="s1">transformer_sparse</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s3">(</span><span class="s1">X_trans_sparse</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">)</span>

    <span class="s1">_check_identity_scalers_attributes</span><span class="s3">(</span><span class="s1">transformer_dense</span><span class="s3">, </span><span class="s1">transformer_sparse</span><span class="s3">)</span>

    <span class="s1">transformer_dense</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">transformer_sparse</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">_check_identity_scalers_attributes</span><span class="s3">(</span><span class="s1">transformer_dense</span><span class="s3">, </span><span class="s1">transformer_sparse</span><span class="s3">)</span>

    <span class="s1">transformer_dense</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">transformer_sparse</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">_check_identity_scalers_attributes</span><span class="s3">(</span><span class="s1">transformer_dense</span><span class="s3">, </span><span class="s1">transformer_sparse</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scaler_int</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># test that scaler converts integer input to floating</span>
    <span class="s0"># for both sparse and dense matrices</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">20</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">))</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0  </span><span class="s0"># first feature is always of zero</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
        <span class="s1">scaler_sparse </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
        <span class="s1">X_sparse_scaled </span><span class="s3">= </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_sparse_scaled</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">mean_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.109</span><span class="s3">, </span><span class="s4">1.856</span><span class="s3">, </span><span class="s4">21.0</span><span class="s3">, </span><span class="s4">1.559</span><span class="s3">], </span><span class="s4">2</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>

    <span class="s1">X_sparse_scaled_mean</span><span class="s3">, </span><span class="s1">X_sparse_scaled_std </span><span class="s3">= </span><span class="s1">mean_variance_axis</span><span class="s3">(</span>
        <span class="s1">X_sparse_scaled</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">float</span><span class="s3">), </span><span class="s4">0</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse_scaled_mean</span><span class="s3">, </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse_scaled_std</span><span class="s3">, </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>

    <span class="s0"># Check that X has not been modified (copy)</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">X_sparse_scaled </span><span class="s2">is not </span><span class="s1">X_sparse</span>

    <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_scaled_back </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">X_scaled_back </span><span class="s2">is not </span><span class="s1">X_scaled</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled_back</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_sparse_scaled_back </span><span class="s3">= </span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_sparse_scaled</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_sparse_scaled_back </span><span class="s2">is not </span><span class="s1">X_sparse</span>
    <span class="s2">assert </span><span class="s1">X_sparse_scaled_back </span><span class="s2">is not </span><span class="s1">X_sparse_scaled</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse_scaled_back</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">sparse_container </span><span class="s2">in </span><span class="s1">CSR_CONTAINERS</span><span class="s3">:</span>
        <span class="s1">null_transform </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">(</span><span class="s1">record</span><span class="s3">=</span><span class="s2">True</span><span class="s3">):</span>
            <span class="s1">X_null </span><span class="s3">= </span><span class="s1">null_transform</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_null</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">X_orig </span><span class="s3">= </span><span class="s1">null_transform</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_null</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_orig</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scaler_without_copy</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># Check that StandardScaler.fit does not change input</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0.0  </span><span class="s0"># first feature is always of zero</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_copy </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_copy</span><span class="s3">)</span>

    <span class="s1">X_sparse_copy </span><span class="s3">= </span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_sparse_copy</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scale_sparse_with_mean_raise_exception</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># check scaling and fit with direct calls on sparse data</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">scale</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>

    <span class="s0"># check transform and inverse_transform after a fit on a dense array</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>

    <span class="s1">X_transformed_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_transformed_sparse</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_scale_input_finiteness_validation</span><span class="s3">():</span>
    <span class="s0"># Check if non finite inputs raise ValueError</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s3">]]</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
        <span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;Input contains infinity or a value too large&quot;</span>
    <span class="s3">):</span>
        <span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_error_sparse</span><span class="s3">():</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s4">1000</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s5">&quot;Cannot center sparse matrices&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;with_centering&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;with_scaling&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;X&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">3</span><span class="s3">), </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s4">0.5</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_robust_scaler_attributes</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">with_centering</span><span class="s3">, </span><span class="s1">with_scaling</span><span class="s3">):</span>
    <span class="s0"># check consistent type of attributes</span>
    <span class="s2">if </span><span class="s1">with_centering </span><span class="s2">and </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">&quot;RobustScaler cannot center sparse matrix&quot;</span><span class="s3">)</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s1">with_centering</span><span class="s3">, </span><span class="s1">with_scaling</span><span class="s3">=</span><span class="s1">with_scaling</span><span class="s3">)</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">with_centering</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">center_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">center_ </span><span class="s2">is None</span>
    <span class="s2">if </span><span class="s1">with_scaling</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_ </span><span class="s2">is None</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_robust_scaler_col_zero_sparse</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># check that the scaler is working when there is not data materialized in a</span>
    <span class="s0"># column of a sparse matrix</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, [</span><span class="s4">0</span><span class="s3">]].</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_trans</span><span class="s3">[:, [</span><span class="s4">0</span><span class="s3">]].</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_2d_arrays</span><span class="s3">():</span>
    <span class="s0"># Test robust scaling of 2d array along first axis</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0.0  </span><span class="s0"># first feature is always of zero</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">()</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">median</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">5 </span><span class="s3">* [</span><span class="s4">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">0</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;density&quot;</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.05</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;strictly_signed&quot;</span><span class="s3">, [</span><span class="s5">&quot;positive&quot;</span><span class="s3">, </span><span class="s5">&quot;negative&quot;</span><span class="s3">, </span><span class="s5">&quot;zeros&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_robust_scaler_equivalence_dense_sparse</span><span class="s3">(</span><span class="s1">density</span><span class="s3">, </span><span class="s1">strictly_signed</span><span class="s3">):</span>
    <span class="s0"># Check the equivalence of the fitting with dense and sparse matrices</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s4">1000</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s1">density</span><span class="s3">).</span><span class="s1">tocsc</span><span class="s3">()</span>
    <span class="s2">if </span><span class="s1">strictly_signed </span><span class="s3">== </span><span class="s5">&quot;positive&quot;</span><span class="s3">:</span>
        <span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">strictly_signed </span><span class="s3">== </span><span class="s5">&quot;negative&quot;</span><span class="s3">:</span>
        <span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">strictly_signed </span><span class="s3">== </span><span class="s5">&quot;zeros&quot;</span><span class="s3">:</span>
        <span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

    <span class="s1">scaler_sparse </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">scaler_dense </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">scaler_dense</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">scaler_sparse</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_dense</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_robust_scaler_transform_one_row_csr</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Check RobustScaler on transforming csr matrix with one row</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">single_row </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">1.0</span><span class="s3">]])</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">with_centering</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">row_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">single_row</span><span class="s3">))</span>
    <span class="s1">row_expected </span><span class="s3">= </span><span class="s1">single_row </span><span class="s3">/ </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">scale_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">row_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">row_expected</span><span class="s3">)</span>
    <span class="s1">row_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">row_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">single_row</span><span class="s3">, </span><span class="s1">row_scaled_back</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_iris</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">()</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">median</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">percentile</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">q</span><span class="s3">=(</span><span class="s4">25</span><span class="s3">, </span><span class="s4">75</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">iqr </span><span class="s3">= </span><span class="s1">q</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">q</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">iqr</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_iris_quantiles</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">quantile_range</span><span class="s3">=(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">90</span><span class="s3">))</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">median</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">percentile</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">q</span><span class="s3">=(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">90</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">q_range </span><span class="s3">= </span><span class="s1">q</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">q</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">q_range</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csc_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_quantile_transform_iris</span><span class="s3">(</span><span class="s1">csc_container</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s0"># uniform output distribution</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">30</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>
    <span class="s0"># normal output distribution</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">30</span><span class="s3">, </span><span class="s1">output_distribution</span><span class="s3">=</span><span class="s5">&quot;normal&quot;</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>
    <span class="s0"># make sure it is possible to take the inverse of a sparse matrix</span>
    <span class="s0"># which contain negative value; this is the case in the iris dataset</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_sparse_tran </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">X_sparse_tran_inv </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_sparse_tran</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_sparse_tran_inv</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csc_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_quantile_transform_check_error</span><span class="s3">(</span><span class="s1">csc_container</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">transpose</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">25</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">75</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">100</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2.6</span><span class="s3">, </span><span class="s4">4.1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">9.5</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_neg </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">transpose</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">25</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">75</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">100</span><span class="s3">],</span>
            <span class="s3">[-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2.6</span><span class="s3">, </span><span class="s4">4.1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">9.5</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">X_neg </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">(</span><span class="s1">X_neg</span><span class="s3">)</span>

    <span class="s1">err_msg </span><span class="s3">= (</span>
        <span class="s5">&quot;The number of quantiles cannot be greater than &quot;</span>
        <span class="s5">&quot;the number of samples used. Got 1000 quantiles &quot;</span>
        <span class="s5">&quot;and 10 samples.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">subsample</span><span class="s3">=</span><span class="s4">10</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s5">&quot;QuantileTransformer only accepts non-negative sparse matrices.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_neg</span><span class="s3">)</span>
    <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s5">&quot;QuantileTransformer only accepts non-negative sparse matrices.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_neg</span><span class="s3">)</span>

    <span class="s1">X_bad_feat </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">transpose</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">25</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">75</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">100</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2.6</span><span class="s3">, </span><span class="s4">4.1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">9.5</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">]]</span>
    <span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= (</span>
        <span class="s5">&quot;X has 2 features, but QuantileTransformer is expecting 3 features as input.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_bad_feat</span><span class="s3">)</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">10</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s0"># check that an error is raised if input is scalar</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;Expected 2D array, got scalar array instead&quot;</span><span class="s3">):</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s0"># check that a warning is raised is n_quantiles &gt; n_samples</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">100</span><span class="s3">)</span>
    <span class="s1">warn_msg </span><span class="s3">= </span><span class="s5">&quot;n_quantiles is set to n_samples&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warn_msg</span><span class="s3">) </span><span class="s2">as </span><span class="s1">record</span><span class="s3">:</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">record</span><span class="s3">) == </span><span class="s4">1</span>
    <span class="s2">assert </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">n_quantiles_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csc_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_quantile_transform_sparse_ignore_zeros</span><span class="s3">(</span><span class="s1">csc_container</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]])</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">ignore_implicit_zeros</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>

    <span class="s0"># dense case -&gt; warning raise</span>
    <span class="s1">warning_message </span><span class="s3">= (</span>
        <span class="s5">&quot;'ignore_implicit_zeros' takes effect&quot;</span>
        <span class="s5">&quot; only with sparse matrix. This parameter has no&quot;</span>
        <span class="s5">&quot; effect.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_message</span><span class="s3">):</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">, </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s0"># consider the case where sparse entries are missing values and user-given</span>
    <span class="s0"># zeros are to be considered</span>
    <span class="s1">X_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
    <span class="s1">X_col </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>
    <span class="s1">X_row </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s3">])</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">((</span><span class="s1">X_data</span><span class="s3">, (</span><span class="s1">X_row</span><span class="s3">, </span><span class="s1">X_col</span><span class="s3">)))</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">, </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">ignore_implicit_zeros</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>
    <span class="s1">X_col </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>
    <span class="s1">X_row </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">])</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">((</span><span class="s1">X_data</span><span class="s3">, (</span><span class="s1">X_row</span><span class="s3">, </span><span class="s1">X_col</span><span class="s3">)))</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.375</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.375</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.375</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">, </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span>
        <span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">()</span>
    <span class="s3">)</span>

    <span class="s0"># check in conjunction with subsampling</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span>
        <span class="s1">ignore_implicit_zeros</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">subsample</span><span class="s3">=</span><span class="s4">8</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span>
    <span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">, </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span>
        <span class="s1">X_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">).</span><span class="s1">toarray</span><span class="s3">()</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_quantile_transform_dense_toy</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2.6</span><span class="s3">], [</span><span class="s4">25</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4.1</span><span class="s3">], [</span><span class="s4">50</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">], [</span><span class="s4">75</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">9.5</span><span class="s3">], [</span><span class="s4">100</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">]]</span>
    <span class="s3">)</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># using a uniform output, each entry of X should be map between 0 and 1</span>
    <span class="s0"># and equally spaced</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">tile</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s4">5</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)).</span><span class="s1">T</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">X_expected</span><span class="s3">)</span>

    <span class="s1">X_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">101</span><span class="s3">, </span><span class="s4">11</span><span class="s3">, </span><span class="s4">10</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">), </span><span class="s1">X_expected</span><span class="s3">)</span>

    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_quantile_transform_subsampling</span><span class="s3">():</span>
    <span class="s0"># Test that subsampling the input yield to a consistent results We check</span>
    <span class="s0"># that the computed quantiles are almost mapped to a [0, 1] vector where</span>
    <span class="s0"># values are equally spaced. The infinite norm is checked to be smaller</span>
    <span class="s0"># than a given threshold. This is repeated 5 times.</span>

    <span class="s0"># dense support</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">1000000</span>
    <span class="s1">n_quantiles </span><span class="s3">= </span><span class="s4">1000</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">sample</span><span class="s3">((</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">ROUND </span><span class="s3">= </span><span class="s4">5</span>
    <span class="s1">inf_norm_arr </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">random_state </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ROUND</span><span class="s3">):</span>
        <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span>
            <span class="s1">random_state</span><span class="s3">=</span><span class="s1">random_state</span><span class="s3">,</span>
            <span class="s1">n_quantiles</span><span class="s3">=</span><span class="s1">n_quantiles</span><span class="s3">,</span>
            <span class="s1">subsample</span><span class="s3">=</span><span class="s1">n_samples </span><span class="s3">// </span><span class="s4">10</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">diff </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">) - </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">quantiles_</span><span class="s3">)</span>
        <span class="s1">inf_norm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">diff</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">inf_norm </span><span class="s3">&lt; </span><span class="s4">1e-2</span>
        <span class="s1">inf_norm_arr</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inf_norm</span><span class="s3">)</span>
    <span class="s0"># each random subsampling yield a unique approximation to the expected</span>
    <span class="s0"># linspace CDF</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">inf_norm_arr</span><span class="s3">)) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">inf_norm_arr</span><span class="s3">)</span>

    <span class="s0"># sparse support</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s4">0.99</span><span class="s3">, </span><span class="s1">format</span><span class="s3">=</span><span class="s5">&quot;csc&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">inf_norm_arr </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">random_state </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ROUND</span><span class="s3">):</span>
        <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span>
            <span class="s1">random_state</span><span class="s3">=</span><span class="s1">random_state</span><span class="s3">,</span>
            <span class="s1">n_quantiles</span><span class="s3">=</span><span class="s1">n_quantiles</span><span class="s3">,</span>
            <span class="s1">subsample</span><span class="s3">=</span><span class="s1">n_samples </span><span class="s3">// </span><span class="s4">10</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">diff </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">) - </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">quantiles_</span><span class="s3">)</span>
        <span class="s1">inf_norm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">diff</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">inf_norm </span><span class="s3">&lt; </span><span class="s4">1e-1</span>
        <span class="s1">inf_norm_arr</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">inf_norm</span><span class="s3">)</span>
    <span class="s0"># each random subsampling yield a unique approximation to the expected</span>
    <span class="s0"># linspace CDF</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">inf_norm_arr</span><span class="s3">)) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">inf_norm_arr</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_quantile_transform_subsampling_disabled</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Check the behaviour of `QuantileTransformer` when `subsample=None`.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">).</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s4">200</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>

    <span class="s1">n_quantiles </span><span class="s3">= </span><span class="s4">5</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s1">n_quantiles</span><span class="s3">, </span><span class="s1">subsample</span><span class="s3">=</span><span class="s2">None</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">expected_references </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">references_</span><span class="s3">, </span><span class="s1">expected_references</span><span class="s3">)</span>
    <span class="s1">expected_quantiles </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">quantile</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">expected_references</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">quantiles_</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">expected_quantiles</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csc_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_quantile_transform_sparse_toy</span><span class="s3">(</span><span class="s1">csc_container</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">25.0</span><span class="s3">, </span><span class="s4">4.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">50.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.6</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">4.1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">6.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">8.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">75.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">10.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">9.5</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s4">100.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">],</span>
        <span class="s3">]</span>
    <span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">1.0</span><span class="s3">)</span>

    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_trans_inv</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s1">transformer_dense </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">10</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer_dense</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s4">1.0</span><span class="s3">)</span>

    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">transformer_dense</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_trans_inv</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_quantile_transform_axis1</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">25</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s4">75</span><span class="s3">, </span><span class="s4">100</span><span class="s3">], [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">10</span><span class="s3">], [</span><span class="s4">2.6</span><span class="s3">, </span><span class="s4">4.1</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">, </span><span class="s4">9.5</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">]])</span>

    <span class="s1">X_trans_a0 </span><span class="s3">= </span><span class="s1">quantile_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X_trans_a1 </span><span class="s3">= </span><span class="s1">quantile_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans_a0</span><span class="s3">, </span><span class="s1">X_trans_a1</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csc_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_quantile_transform_bounds</span><span class="s3">(</span><span class="s1">csc_container</span><span class="s3">):</span>
    <span class="s0"># Lower and upper bounds are manually mapped. We checked that in the case</span>
    <span class="s0"># of a constant feature and binary feature, the bounds are properly mapped.</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]])</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csc_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>

    <span class="s0"># check sparse and dense are consistent</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">).</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">X_trans_sp </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">).</span><span class="s1">fit_transform</span><span class="s3">(</span>
        <span class="s1">X_sparse</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans_sp</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_trans_sp</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s0"># check the consistency of the bounds by learning on 1 matrix</span>
    <span class="s0"># and transforming another</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]])</span>
    <span class="s1">X1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">]])</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X1</span><span class="s3">)</span>

    <span class="s0"># check that values outside of the range learned will be mapped properly.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s4">1000</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">()</span>
    <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">([[-</span><span class="s4">10</span><span class="s3">]]) == </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">([[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)]])</span>
    <span class="s2">assert </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">([[</span><span class="s4">10</span><span class="s3">]]) == </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">([[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)]])</span>
    <span class="s2">assert </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[-</span><span class="s4">10</span><span class="s3">]]) == </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">references_</span><span class="s3">)]]</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">([[</span><span class="s4">10</span><span class="s3">]]) == </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span>
        <span class="s3">[[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">references_</span><span class="s3">)]]</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_quantile_transform_and_inverse</span><span class="s3">():</span>
    <span class="s1">X_1 </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">X_2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0.0</span><span class="s3">], [</span><span class="s1">BOUNDS_THRESHOLD </span><span class="s3">/ </span><span class="s4">10</span><span class="s3">], [</span><span class="s4">1.5</span><span class="s3">], [</span><span class="s4">2</span><span class="s3">], [</span><span class="s4">3</span><span class="s3">], [</span><span class="s4">3</span><span class="s3">], [</span><span class="s4">4</span><span class="s3">]])</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">[</span><span class="s1">X_1</span><span class="s3">, </span><span class="s1">X_2</span><span class="s3">]:</span>
        <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">1000</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">9</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_quantile_transform_nan</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]])</span>

    <span class="s1">transformer </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s4">10</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">transformer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># check that the quantile of the first column is all NaN</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">quantiles_</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>
    <span class="s0"># all other column should not contain NaN</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">transformer</span><span class="s3">.</span><span class="s1">quantiles_</span><span class="s3">[:, </span><span class="s4">1</span><span class="s3">:]).</span><span class="s1">any</span><span class="s3">()</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;array_type&quot;</span><span class="s3">, [</span><span class="s5">&quot;array&quot;</span><span class="s3">, </span><span class="s5">&quot;sparse&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_quantile_transformer_sorted_quantiles</span><span class="s3">(</span><span class="s1">array_type</span><span class="s3">):</span>
    <span class="s0"># Non-regression test for:</span>
    <span class="s0"># https://github.com/scikit-learn/scikit-learn/issues/15733</span>
    <span class="s0"># Taken from upstream bug report:</span>
    <span class="s0"># https://github.com/numpy/numpy/issues/14685</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">7</span><span class="s3">] * </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s4">0.1 </span><span class="s3">* </span><span class="s1">X</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">_convert_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">array_type</span><span class="s3">)</span>

    <span class="s1">n_quantiles </span><span class="s3">= </span><span class="s4">100</span>
    <span class="s1">qt </span><span class="s3">= </span><span class="s1">QuantileTransformer</span><span class="s3">(</span><span class="s1">n_quantiles</span><span class="s3">=</span><span class="s1">n_quantiles</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Check that the estimated quantile thresholds are monotically</span>
    <span class="s0"># increasing:</span>
    <span class="s1">quantiles </span><span class="s3">= </span><span class="s1">qt</span><span class="s3">.</span><span class="s1">quantiles_</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">quantiles</span><span class="s3">) == </span><span class="s4">100</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diff</span><span class="s3">(</span><span class="s1">quantiles</span><span class="s3">) &gt;= </span><span class="s4">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_invalid_range</span><span class="s3">():</span>
    <span class="s2">for </span><span class="s1">range_ </span><span class="s2">in </span><span class="s3">[</span>
        <span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">90</span><span class="s3">),</span>
        <span class="s3">(-</span><span class="s4">2</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">101</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">100.5</span><span class="s3">, </span><span class="s4">101</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s4">90</span><span class="s3">, </span><span class="s4">50</span><span class="s3">),</span>
    <span class="s3">]:</span>
        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">quantile_range</span><span class="s3">=</span><span class="s1">range_</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">r&quot;Invalid quantile range: \(&quot;</span><span class="s3">):</span>
            <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_scale_function_without_centering</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s4">0.0  </span><span class="s0"># first feature is always of zero</span>
    <span class="s1">X_csr </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">))</span>

    <span class="s1">X_csr_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_csr_scaled</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s0"># test csc has same outcome</span>
    <span class="s1">X_csc_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">.</span><span class="s1">tocsc</span><span class="s3">(), </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">, </span><span class="s1">X_csc_scaled</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>

    <span class="s0"># raises value error on axis != 0</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">scale</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">0.01</span><span class="s3">, </span><span class="s4">2.24</span><span class="s3">, -</span><span class="s4">0.35</span><span class="s3">, -</span><span class="s4">0.78</span><span class="s3">], </span><span class="s4">2</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">])</span>
    <span class="s0"># Check that X has not been copied</span>
    <span class="s2">assert </span><span class="s1">X_scaled </span><span class="s2">is not </span><span class="s1">X</span>

    <span class="s1">X_csr_scaled_mean</span><span class="s3">, </span><span class="s1">X_csr_scaled_std </span><span class="s3">= </span><span class="s1">mean_variance_axis</span><span class="s3">(</span><span class="s1">X_csr_scaled</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_csr_scaled_mean</span><span class="s3">, </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_csr_scaled_std</span><span class="s3">, </span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">))</span>

    <span class="s0"># null scale</span>
    <span class="s1">X_csr_scaled </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">, </span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_csr_scaled</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_robust_scale_axis1</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">robust_scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">median</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">), </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">percentile</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">q</span><span class="s3">=(</span><span class="s4">25</span><span class="s3">, </span><span class="s4">75</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">iqr </span><span class="s3">= </span><span class="s1">q</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">q</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">iqr</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_robust_scale_1d_array</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[:, </span><span class="s4">1</span><span class="s3">]</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">robust_scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">median</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">), </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">q </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">percentile</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">q</span><span class="s3">=(</span><span class="s4">25</span><span class="s3">, </span><span class="s4">75</span><span class="s3">))</span>
    <span class="s1">iqr </span><span class="s3">= </span><span class="s1">q</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] - </span><span class="s1">q</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">iqr</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_zero_variance_features</span><span class="s3">():</span>
    <span class="s0"># Check RobustScaler on toy data with zero variance features</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">0.5</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.1</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">1.1</span><span class="s3">]]</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">()</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># NOTE: for such a small sample size, what we expect in the third column</span>
    <span class="s0"># depends HEAVILY on the method used to calculate quantiles. The values</span>
    <span class="s0"># here were calculated to fit the quantiles produces by np.percentile</span>
    <span class="s0"># using numpy 1.9 Calculating quantiles with</span>
    <span class="s0"># scipy.stats.mstats.scoreatquantile or scipy.stats.mstats.mquantiles</span>
    <span class="s0"># would yield very different results!</span>
    <span class="s1">X_expected </span><span class="s3">= [[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, +</span><span class="s4">0.0</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">1.0</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, +</span><span class="s4">1.0</span><span class="s3">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>

    <span class="s0"># make sure new data gets transformed correctly</span>
    <span class="s1">X_new </span><span class="s3">= [[+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [-</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">], [+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.5</span><span class="s3">]]</span>
    <span class="s1">X_trans_new </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_new</span><span class="s3">)</span>
    <span class="s1">X_expected_new </span><span class="s3">= [[+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">0.0</span><span class="s3">], [-</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">0.83333</span><span class="s3">], [+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, +</span><span class="s4">1.66667</span><span class="s3">]]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans_new</span><span class="s3">, </span><span class="s1">X_expected_new</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_robust_scaler_unit_variance</span><span class="s3">():</span>
    <span class="s0"># Check RobustScaler with unit_variance=True on standard normal data with</span>
    <span class="s0"># outliers</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">42</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">1000000</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">X_with_outliers </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">100</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)) * </span><span class="s4">100</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">100</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)) * -</span><span class="s4">100</span><span class="s3">])</span>

    <span class="s1">quantile_range </span><span class="s3">= (</span><span class="s4">1</span><span class="s3">, </span><span class="s4">99</span><span class="s3">)</span>
    <span class="s1">robust_scaler </span><span class="s3">= </span><span class="s1">RobustScaler</span><span class="s3">(</span><span class="s1">quantile_range</span><span class="s3">=</span><span class="s1">quantile_range</span><span class="s3">, </span><span class="s1">unit_variance</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X_with_outliers</span>
    <span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">robust_scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">robust_scaler</span><span class="s3">.</span><span class="s1">center_ </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">abs</span><span class="s3">=</span><span class="s4">1e-3</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">robust_scaler</span><span class="s3">.</span><span class="s1">scale_ </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">abs</span><span class="s3">=</span><span class="s4">1e-2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">std</span><span class="s3">() == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">abs</span><span class="s3">=</span><span class="s4">1e-2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_maxabs_scaler_zero_variance_features</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s0"># Check MaxAbsScaler on toy data with zero variance features</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">0.5</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.3</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">1.5</span><span class="s3">], [</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, +</span><span class="s4">0.0</span><span class="s3">]]</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= [</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0 </span><span class="s3">/ </span><span class="s4">3.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.2</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
    <span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected</span><span class="s3">)</span>
    <span class="s1">X_trans_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_inv</span><span class="s3">)</span>

    <span class="s0"># make sure new data gets transformed correctly</span>
    <span class="s1">X_new </span><span class="s3">= [[+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">], [-</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">], [+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.5</span><span class="s3">]]</span>
    <span class="s1">X_trans_new </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_new</span><span class="s3">)</span>
    <span class="s1">X_expected_new </span><span class="s3">= [[+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">1.0 </span><span class="s3">/ </span><span class="s4">3.0</span><span class="s3">], [-</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">], [+</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">]]</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans_new</span><span class="s3">, </span><span class="s1">X_expected_new</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s0"># function interface</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">maxabs_scale</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected</span><span class="s3">)</span>

    <span class="s0"># sparse data</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans_sparse </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= [</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0 </span><span class="s3">/ </span><span class="s4">3.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.2</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
    <span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans_sparse</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_expected</span><span class="s3">)</span>
    <span class="s1">X_trans_sparse_inv </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans_sparse</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_trans_sparse_inv</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_maxabs_scaler_large_negative_value</span><span class="s3">():</span>
    <span class="s0"># Check MaxAbsScaler on toy data with a large negative value</span>
    <span class="s1">X </span><span class="s3">= [</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, +</span><span class="s4">0.5</span><span class="s3">, -</span><span class="s4">1.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.3</span><span class="s3">, -</span><span class="s4">0.5</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">100.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, +</span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">2.0</span><span class="s3">],</span>
    <span class="s3">]</span>

    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= [</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.005</span><span class="s3">, -</span><span class="s4">0.5</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">0.003</span><span class="s3">, -</span><span class="s4">0.25</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, -</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">],</span>
        <span class="s3">[</span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, -</span><span class="s4">1.0</span><span class="s3">],</span>
    <span class="s3">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X_expected</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_maxabs_scaler_transform_one_row_csr</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Check MaxAbsScaler on transforming csr matrix with one row</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">([[</span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">]])</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">([[</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">]])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_expected</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>
    <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_scaled_back</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_maxabs_scaler_1d</span><span class="s3">():</span>
    <span class="s0"># Test scaling of dataset along single axis</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">[</span><span class="s1">X_1row</span><span class="s3">, </span><span class="s1">X_1col</span><span class="s3">, </span><span class="s1">X_list_1row</span><span class="s3">, </span><span class="s1">X_list_1row</span><span class="s3">]:</span>
        <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)  </span><span class="s0"># cast only after scaling done</span>

        <span class="s2">if </span><span class="s1">_check_dim_1axis</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s4">1</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_features</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)), </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

        <span class="s0"># check inverse transform</span>
        <span class="s1">X_scaled_back </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_scaled_back</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Constant feature</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
    <span class="s1">X_scaled </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_scaled</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)), </span><span class="s4">1.0</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s0"># function interface</span>
    <span class="s1">X_1d </span><span class="s3">= </span><span class="s1">X_1row</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()</span>
    <span class="s1">max_abs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_1d</span><span class="s3">).</span><span class="s1">max</span><span class="s3">()</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_1d </span><span class="s3">/ </span><span class="s1">max_abs</span><span class="s3">, </span><span class="s1">maxabs_scale</span><span class="s3">(</span><span class="s1">X_1d</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_maxabs_scaler_partial_fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Test if partial_fit run over many batches of size 1 and 50</span>
    <span class="s0"># gives the same results as fit</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_2d</span><span class="s3">[:</span><span class="s4">100</span><span class="s3">, :]</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">chunk_size </span><span class="s2">in </span><span class="s3">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">50</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">42</span><span class="s3">]:</span>
        <span class="s0"># Test mean at the end of the process</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
        <span class="s1">scaler_incr_csr </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
        <span class="s1">scaler_incr_csc </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">):</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
            <span class="s1">X_csr </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
            <span class="s1">scaler_incr_csr </span><span class="s3">= </span><span class="s1">scaler_incr_csr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X_csr</span><span class="s3">)</span>
            <span class="s1">X_csc </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
            <span class="s1">scaler_incr_csc </span><span class="s3">= </span><span class="s1">scaler_incr_csc</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X_csc</span><span class="s3">)</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">, </span><span class="s1">scaler_incr_csr</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">, </span><span class="s1">scaler_incr_csc</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr_csr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr_csc</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_incr_csr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_incr_csc</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

        <span class="s0"># Test std after 1 step</span>
        <span class="s1">batch0 </span><span class="s3">= </span><span class="s1">slice</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">)</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">])</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">().</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch0</span><span class="s3">])</span>

        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">max_abs_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">n_samples_seen_ </span><span class="s3">== </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">, </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">scale_</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">scaler_batch</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

        <span class="s0"># Test std until the end of partial fits, and</span>
        <span class="s1">scaler_batch </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">MaxAbsScaler</span><span class="s3">()  </span><span class="s0"># Clean estimator</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, </span><span class="s1">batch </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">gen_batches</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">chunk_size</span><span class="s3">)):</span>
            <span class="s1">scaler_incr </span><span class="s3">= </span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">batch</span><span class="s3">])</span>
            <span class="s1">assert_correct_incr</span><span class="s3">(</span>
                <span class="s1">i</span><span class="s3">,</span>
                <span class="s1">batch_start</span><span class="s3">=</span><span class="s1">batch</span><span class="s3">.</span><span class="s1">start</span><span class="s3">,</span>
                <span class="s1">batch_stop</span><span class="s3">=</span><span class="s1">batch</span><span class="s3">.</span><span class="s1">stop</span><span class="s3">,</span>
                <span class="s1">n</span><span class="s3">=</span><span class="s1">n</span><span class="s3">,</span>
                <span class="s1">chunk_size</span><span class="s3">=</span><span class="s1">chunk_size</span><span class="s3">,</span>
                <span class="s1">n_samples_seen</span><span class="s3">=</span><span class="s1">scaler_incr</span><span class="s3">.</span><span class="s1">n_samples_seen_</span><span class="s3">,</span>
            <span class="s3">)</span>


<span class="s2">def </span><span class="s1">check_normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">X_norm</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Convenient checking function for `test_normalizer_l1_l2_max` and 
    `test_normalizer_l1_l2_max_non_csr` 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">norm </span><span class="s3">== </span><span class="s5">&quot;l1&quot;</span><span class="s3">:</span>
        <span class="s1">row_sums </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">3</span><span class="s3">):</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">row_sums</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">row_sums</span><span class="s3">[</span><span class="s4">3</span><span class="s3">], </span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">norm </span><span class="s3">== </span><span class="s5">&quot;l2&quot;</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">3</span><span class="s3">):</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">la</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]), </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">la</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">[</span><span class="s4">3</span><span class="s3">]), </span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">norm </span><span class="s3">== </span><span class="s5">&quot;max&quot;</span><span class="s3">:</span>
        <span class="s1">row_maxs </span><span class="s3">= </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">).</span><span class="s1">max</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">3</span><span class="s3">):</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">row_maxs</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s4">1.0</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">row_maxs</span><span class="s3">[</span><span class="s4">3</span><span class="s3">], </span><span class="s4">0.0</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;norm&quot;</span><span class="s3">, [</span><span class="s5">&quot;l1&quot;</span><span class="s3">, </span><span class="s5">&quot;l2&quot;</span><span class="s3">, </span><span class="s5">&quot;max&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_normalizer_l1_l2_max</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X_sparse_unpruned </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>

    <span class="s0"># set the row number 3 to zero</span>
    <span class="s1">X_dense</span><span class="s3">[</span><span class="s4">3</span><span class="s3">, :] = </span><span class="s4">0.0</span>

    <span class="s0"># set the row number 3 to zero without pruning (can happen in real life)</span>
    <span class="s1">indptr_3 </span><span class="s3">= </span><span class="s1">X_sparse_unpruned</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">[</span><span class="s4">3</span><span class="s3">]</span>
    <span class="s1">indptr_4 </span><span class="s3">= </span><span class="s1">X_sparse_unpruned</span><span class="s3">.</span><span class="s1">indptr</span><span class="s3">[</span><span class="s4">4</span><span class="s3">]</span>
    <span class="s1">X_sparse_unpruned</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">indptr_3</span><span class="s3">:</span><span class="s1">indptr_4</span><span class="s3">] = </span><span class="s4">0.0</span>

    <span class="s0"># build the pruned variant using the regular constructor</span>
    <span class="s1">X_sparse_pruned </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>

    <span class="s0"># check inputs that support the no-copy optim</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">, </span><span class="s1">X_sparse_pruned</span><span class="s3">, </span><span class="s1">X_sparse_unpruned</span><span class="s3">):</span>
        <span class="s1">normalizer </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">X_norm1 </span><span class="s3">= </span><span class="s1">normalizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_norm1 </span><span class="s2">is not </span><span class="s1">X</span>
        <span class="s1">X_norm1 </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_norm1</span><span class="s3">)</span>

        <span class="s1">normalizer </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">X_norm2 </span><span class="s3">= </span><span class="s1">normalizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_norm2 </span><span class="s2">is </span><span class="s1">X</span>
        <span class="s1">X_norm2 </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_norm2</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">X_norm </span><span class="s2">in </span><span class="s3">(</span><span class="s1">X_norm1</span><span class="s3">, </span><span class="s1">X_norm2</span><span class="s3">):</span>
            <span class="s1">check_normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">X_norm</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;norm&quot;</span><span class="s3">, [</span><span class="s5">&quot;l1&quot;</span><span class="s3">, </span><span class="s5">&quot;l2&quot;</span><span class="s3">, </span><span class="s5">&quot;max&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">LIL_CONTAINERS</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_normalizer_l1_l2_max_non_csr</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>

    <span class="s0"># set the row number 3 to zero</span>
    <span class="s1">X_dense</span><span class="s3">[</span><span class="s4">3</span><span class="s3">, :] = </span><span class="s4">0.0</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">X_norm </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">X_norm </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">) </span><span class="s2">and </span><span class="s1">X_norm</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s5">&quot;csr&quot;</span>

    <span class="s1">X_norm </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">)</span>
    <span class="s1">check_normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">X_norm</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_normalizer_max_sign</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># check that we normalize by a positive number even for negative data</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s0"># set the row number 3 to zero</span>
    <span class="s1">X_dense</span><span class="s3">[</span><span class="s4">3</span><span class="s3">, :] = </span><span class="s4">0.0</span>
    <span class="s0"># check for mixed data where the value with</span>
    <span class="s0"># largest magnitude is negative</span>
    <span class="s1">X_dense</span><span class="s3">[</span><span class="s4">2</span><span class="s3">, </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">[</span><span class="s4">2</span><span class="s3">, :]).</span><span class="s1">argmax</span><span class="s3">()] *= -</span><span class="s4">1</span>
    <span class="s1">X_all_neg </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">X_all_neg_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_all_neg</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">, </span><span class="s1">X_all_neg</span><span class="s3">, </span><span class="s1">X_all_neg_sparse</span><span class="s3">):</span>
        <span class="s1">normalizer </span><span class="s3">= </span><span class="s1">Normalizer</span><span class="s3">(</span><span class="s1">norm</span><span class="s3">=</span><span class="s5">&quot;max&quot;</span><span class="s3">)</span>
        <span class="s1">X_norm </span><span class="s3">= </span><span class="s1">normalizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">X_norm </span><span class="s2">is not </span><span class="s1">X</span>
        <span class="s1">X_norm </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_normalize</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Test normalize function</span>
    <span class="s0"># Only tests functionality not used by the tests for Normalizer.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">37</span><span class="s3">).</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">rs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">5</span><span class="s3">)</span>
    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s1">ones </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">10</span><span class="s3">))</span>
    <span class="s2">for </span><span class="s1">X </span><span class="s2">in </span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">, </span><span class="s1">X_sparse</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">norm </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;l1&quot;</span><span class="s3">, </span><span class="s5">&quot;l2&quot;</span><span class="s3">):</span>
                <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">)</span>
                <span class="s1">X_norm </span><span class="s3">= </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">norm</span><span class="s3">=</span><span class="s1">norm</span><span class="s3">)</span>
                <span class="s2">assert </span><span class="s1">X_norm</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>

                <span class="s1">X_norm </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">norm </span><span class="s3">== </span><span class="s5">&quot;l1&quot;</span><span class="s3">:</span>
                    <span class="s1">row_sums </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_norm</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">X_norm_squared </span><span class="s3">= </span><span class="s1">X_norm</span><span class="s3">**</span><span class="s4">2</span>
                    <span class="s1">row_sums </span><span class="s3">= </span><span class="s1">X_norm_squared</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>

                <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">row_sums</span><span class="s3">, </span><span class="s1">ones</span><span class="s3">)</span>

    <span class="s0"># Test return_norm</span>
    <span class="s1">X_dense </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">4.0</span><span class="s3">], [</span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">], [</span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">0.0</span><span class="s3">]])</span>
    <span class="s2">for </span><span class="s1">norm </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;l1&quot;</span><span class="s3">, </span><span class="s5">&quot;l2&quot;</span><span class="s3">, </span><span class="s5">&quot;max&quot;</span><span class="s3">):</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">norms </span><span class="s3">= </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">, </span><span class="s1">norm</span><span class="s3">=</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">return_norm</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">norm </span><span class="s3">== </span><span class="s5">&quot;l1&quot;</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">norms</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">7.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">5.0</span><span class="s3">]))</span>
        <span class="s2">elif </span><span class="s1">norm </span><span class="s3">== </span><span class="s5">&quot;l2&quot;</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">norms</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">5.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3.60555127</span><span class="s3">]))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">norms</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">4.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">]))</span>

    <span class="s1">X_sparse </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X_dense</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">norm </span><span class="s2">in </span><span class="s3">(</span><span class="s5">&quot;l1&quot;</span><span class="s3">, </span><span class="s5">&quot;l2&quot;</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotImplementedError</span><span class="s3">):</span>
            <span class="s1">normalize</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">norm</span><span class="s3">=</span><span class="s1">norm</span><span class="s3">, </span><span class="s1">return_norm</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">_</span><span class="s3">, </span><span class="s1">norms </span><span class="s3">= </span><span class="s1">normalize</span><span class="s3">(</span><span class="s1">X_sparse</span><span class="s3">, </span><span class="s1">norm</span><span class="s3">=</span><span class="s5">&quot;max&quot;</span><span class="s3">, </span><span class="s1">return_norm</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">norms</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">4.0</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">]))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;constructor&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">, </span><span class="s1">list</span><span class="s3">] + </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_binarizer</span><span class="s3">(</span><span class="s1">constructor</span><span class="s3">):</span>
    <span class="s1">X_ </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">5</span><span class="s3">], [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]])</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">constructor</span><span class="s3">(</span><span class="s1">X_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())</span>

    <span class="s1">binarizer </span><span class="s3">= </span><span class="s1">Binarizer</span><span class="s3">(</span><span class="s1">threshold</span><span class="s3">=</span><span class="s4">2.0</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">0</span><span class="s3">) == </span><span class="s4">4</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">1</span><span class="s3">) == </span><span class="s4">2</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) == </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X_bin</span><span class="s3">)</span>

    <span class="s1">binarizer </span><span class="s3">= </span><span class="s1">Binarizer</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">X_bin </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">0</span><span class="s3">) == </span><span class="s4">2</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">1</span><span class="s3">) == </span><span class="s4">4</span>

    <span class="s1">binarizer </span><span class="s3">= </span><span class="s1">Binarizer</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_bin </span><span class="s2">is not </span><span class="s1">X</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_bin</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">0</span><span class="s3">) == </span><span class="s4">2</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">1</span><span class="s3">) == </span><span class="s4">4</span>

    <span class="s1">binarizer </span><span class="s3">= </span><span class="s1">Binarizer</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">constructor </span><span class="s2">is not </span><span class="s1">list</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">X_bin </span><span class="s2">is </span><span class="s1">X</span>

    <span class="s1">binarizer </span><span class="s3">= </span><span class="s1">Binarizer</span><span class="s3">(</span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X_float </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">5</span><span class="s3">], [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_float</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">constructor </span><span class="s2">is not </span><span class="s1">list</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">X_bin </span><span class="s2">is </span><span class="s1">X_float</span>

    <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">X_bin</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">0</span><span class="s3">) == </span><span class="s4">2</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">1</span><span class="s3">) == </span><span class="s4">4</span>

    <span class="s1">binarizer </span><span class="s3">= </span><span class="s1">Binarizer</span><span class="s3">(</span><span class="s1">threshold</span><span class="s3">=-</span><span class="s4">0.5</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">constructor </span><span class="s2">in </span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">, </span><span class="s1">list</span><span class="s3">):</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">constructor</span><span class="s3">(</span><span class="s1">X_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">())</span>

        <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">toarray</span><span class="s3">(</span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">0</span><span class="s3">) == </span><span class="s4">1</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">X_bin </span><span class="s3">== </span><span class="s4">1</span><span class="s3">) == </span><span class="s4">5</span>
        <span class="s1">X_bin </span><span class="s3">= </span><span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Cannot use threshold &lt; 0 for sparse</span>
    <span class="s2">if </span><span class="s1">constructor </span><span class="s2">in </span><span class="s1">CSC_CONTAINERS</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">binarizer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">constructor</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_center_kernel</span><span class="s3">():</span>
    <span class="s0"># Test that KernelCenterer is equivalent to StandardScaler</span>
    <span class="s0"># in feature space</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_fit </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">((</span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s3">))</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_fit</span><span class="s3">)</span>
    <span class="s1">X_fit_centered </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_fit</span><span class="s3">)</span>
    <span class="s1">K_fit </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_fit</span><span class="s3">, </span><span class="s1">X_fit</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s0"># center fit time matrix</span>
    <span class="s1">centerer </span><span class="s3">= </span><span class="s1">KernelCenterer</span><span class="s3">()</span>
    <span class="s1">K_fit_centered </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_fit_centered</span><span class="s3">, </span><span class="s1">X_fit_centered</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">K_fit_centered2 </span><span class="s3">= </span><span class="s1">centerer</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">K_fit</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">K_fit_centered</span><span class="s3">, </span><span class="s1">K_fit_centered2</span><span class="s3">)</span>

    <span class="s0"># center predict time matrix</span>
    <span class="s1">X_pred </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">))</span>
    <span class="s1">K_pred </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_pred</span><span class="s3">, </span><span class="s1">X_fit</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">X_pred_centered </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_pred</span><span class="s3">)</span>
    <span class="s1">K_pred_centered </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X_pred_centered</span><span class="s3">, </span><span class="s1">X_fit_centered</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">K_pred_centered2 </span><span class="s3">= </span><span class="s1">centerer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">K_pred</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">K_pred_centered</span><span class="s3">, </span><span class="s1">K_pred_centered2</span><span class="s3">)</span>

    <span class="s0"># check the results coherence with the method proposed in:</span>
    <span class="s0"># B. Schölkopf, A. Smola, and K.R. Müller,</span>
    <span class="s0"># &quot;Nonlinear component analysis as a kernel eigenvalue problem&quot;</span>
    <span class="s0"># equation (B.3)</span>

    <span class="s0"># K_centered3 = (I - 1_M) K (I - 1_M)</span>
    <span class="s0">#             =  K - 1_M K - K 1_M + 1_M K 1_M</span>
    <span class="s1">ones_M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">K_fit</span><span class="s3">) / </span><span class="s1">K_fit</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">K_fit_centered3 </span><span class="s3">= </span><span class="s1">K_fit </span><span class="s3">- </span><span class="s1">ones_M </span><span class="s3">@ </span><span class="s1">K_fit </span><span class="s3">- </span><span class="s1">K_fit </span><span class="s3">@ </span><span class="s1">ones_M </span><span class="s3">+ </span><span class="s1">ones_M </span><span class="s3">@ </span><span class="s1">K_fit </span><span class="s3">@ </span><span class="s1">ones_M</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">K_fit_centered</span><span class="s3">, </span><span class="s1">K_fit_centered3</span><span class="s3">)</span>

    <span class="s0"># K_test_centered3 = (K_test - 1'_M K)(I - 1_M)</span>
    <span class="s0">#                  = K_test - 1'_M K - K_test 1_M + 1'_M K 1_M</span>
    <span class="s1">ones_prime_M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">K_pred</span><span class="s3">) / </span><span class="s1">K_fit</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">K_pred_centered3 </span><span class="s3">= (</span>
        <span class="s1">K_pred </span><span class="s3">- </span><span class="s1">ones_prime_M </span><span class="s3">@ </span><span class="s1">K_fit </span><span class="s3">- </span><span class="s1">K_pred </span><span class="s3">@ </span><span class="s1">ones_M </span><span class="s3">+ </span><span class="s1">ones_prime_M </span><span class="s3">@ </span><span class="s1">K_fit </span><span class="s3">@ </span><span class="s1">ones_M</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">K_pred_centered</span><span class="s3">, </span><span class="s1">K_pred_centered3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_kernelcenterer_non_linear_kernel</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Check kernel centering for non-linear kernel.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">X_test </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">100</span><span class="s3">, </span><span class="s4">50</span><span class="s3">), </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s4">20</span><span class="s3">, </span><span class="s4">50</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">phi</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
        <span class="s6">&quot;&quot;&quot;Our mapping function phi.&quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">(</span>
            <span class="s3">[</span>
                <span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">a_min</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">a_max</span><span class="s3">=</span><span class="s2">None</span><span class="s3">),</span>
                <span class="s3">-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">clip</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">a_min</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">a_max</span><span class="s3">=</span><span class="s4">0</span><span class="s3">),</span>
            <span class="s3">]</span>
        <span class="s3">)</span>

    <span class="s1">phi_X </span><span class="s3">= </span><span class="s1">phi</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">phi_X_test </span><span class="s3">= </span><span class="s1">phi</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>

    <span class="s0"># centered the projection</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">phi_X_center </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">phi_X</span><span class="s3">)</span>
    <span class="s1">phi_X_test_center </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">phi_X_test</span><span class="s3">)</span>

    <span class="s0"># create the different kernel</span>
    <span class="s1">K </span><span class="s3">= </span><span class="s1">phi_X </span><span class="s3">@ </span><span class="s1">phi_X</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">K_test </span><span class="s3">= </span><span class="s1">phi_X_test </span><span class="s3">@ </span><span class="s1">phi_X</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">K_center </span><span class="s3">= </span><span class="s1">phi_X_center </span><span class="s3">@ </span><span class="s1">phi_X_center</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">K_test_center </span><span class="s3">= </span><span class="s1">phi_X_test_center </span><span class="s3">@ </span><span class="s1">phi_X_center</span><span class="s3">.</span><span class="s1">T</span>

    <span class="s1">kernel_centerer </span><span class="s3">= </span><span class="s1">KernelCenterer</span><span class="s3">()</span>
    <span class="s1">kernel_centerer</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">K</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">kernel_centerer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">K</span><span class="s3">), </span><span class="s1">K_center</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">kernel_centerer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">K_test</span><span class="s3">), </span><span class="s1">K_test_center</span><span class="s3">)</span>

    <span class="s0"># check the results coherence with the method proposed in:</span>
    <span class="s0"># B. Schölkopf, A. Smola, and K.R. Müller,</span>
    <span class="s0"># &quot;Nonlinear component analysis as a kernel eigenvalue problem&quot;</span>
    <span class="s0"># equation (B.3)</span>

    <span class="s0"># K_centered = (I - 1_M) K (I - 1_M)</span>
    <span class="s0">#            =  K - 1_M K - K 1_M + 1_M K 1_M</span>
    <span class="s1">ones_M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">K</span><span class="s3">) / </span><span class="s1">K</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">K_centered </span><span class="s3">= </span><span class="s1">K </span><span class="s3">- </span><span class="s1">ones_M </span><span class="s3">@ </span><span class="s1">K </span><span class="s3">- </span><span class="s1">K </span><span class="s3">@ </span><span class="s1">ones_M </span><span class="s3">+ </span><span class="s1">ones_M </span><span class="s3">@ </span><span class="s1">K </span><span class="s3">@ </span><span class="s1">ones_M</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">kernel_centerer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">K</span><span class="s3">), </span><span class="s1">K_centered</span><span class="s3">)</span>

    <span class="s0"># K_test_centered = (K_test - 1'_M K)(I - 1_M)</span>
    <span class="s0">#                 = K_test - 1'_M K - K_test 1_M + 1'_M K 1_M</span>
    <span class="s1">ones_prime_M </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones_like</span><span class="s3">(</span><span class="s1">K_test</span><span class="s3">) / </span><span class="s1">K</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">K_test_centered </span><span class="s3">= (</span>
        <span class="s1">K_test </span><span class="s3">- </span><span class="s1">ones_prime_M </span><span class="s3">@ </span><span class="s1">K </span><span class="s3">- </span><span class="s1">K_test </span><span class="s3">@ </span><span class="s1">ones_M </span><span class="s3">+ </span><span class="s1">ones_prime_M </span><span class="s3">@ </span><span class="s1">K </span><span class="s3">@ </span><span class="s1">ones_M</span>
    <span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">kernel_centerer</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">K_test</span><span class="s3">), </span><span class="s1">K_test_centered</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cv_pipeline_precomputed</span><span class="s3">():</span>
    <span class="s0"># Cross-validate a regression on four coplanar points with the same</span>
    <span class="s0"># value. Use precomputed kernel to ensure Pipeline with KernelCenterer</span>
    <span class="s0"># is treated as a pairwise operation.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]])</span>
    <span class="s1">y_true </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">4</span><span class="s3">,))</span>
    <span class="s1">K </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">kcent </span><span class="s3">= </span><span class="s1">KernelCenterer</span><span class="s3">()</span>
    <span class="s1">pipeline </span><span class="s3">= </span><span class="s1">Pipeline</span><span class="s3">([(</span><span class="s5">&quot;kernel_centerer&quot;</span><span class="s3">, </span><span class="s1">kcent</span><span class="s3">), (</span><span class="s5">&quot;svr&quot;</span><span class="s3">, </span><span class="s1">SVR</span><span class="s3">())])</span>

    <span class="s0"># did the pipeline set the pairwise attribute?</span>
    <span class="s2">assert </span><span class="s1">pipeline</span><span class="s3">.</span><span class="s1">_get_tags</span><span class="s3">()[</span><span class="s5">&quot;pairwise&quot;</span><span class="s3">]</span>

    <span class="s0"># test cross-validation, score should be almost perfect</span>
    <span class="s0"># NB: this test is pretty vacuous -- it's mainly to test integration</span>
    <span class="s0">#     of Pipeline and KernelCenterer</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">cross_val_predict</span><span class="s3">(</span><span class="s1">pipeline</span><span class="s3">, </span><span class="s1">K</span><span class="s3">, </span><span class="s1">y_true</span><span class="s3">, </span><span class="s1">cv</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">y_true</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fit_transform</span><span class="s3">():</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">((</span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s3">))</span>
    <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s3">(</span><span class="s1">StandardScaler</span><span class="s3">(), </span><span class="s1">Normalizer</span><span class="s3">(), </span><span class="s1">Binarizer</span><span class="s3">()):</span>
        <span class="s1">X_transformed </span><span class="s3">= </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">X_transformed2 </span><span class="s3">= </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X_transformed</span><span class="s3">, </span><span class="s1">X_transformed2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_add_dummy_feature</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">add_dummy_feature</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;sparse_container&quot;</span><span class="s3">, </span><span class="s1">COO_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s3">+ </span><span class="s1">CSR_CONTAINERS</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_add_dummy_feature_sparse</span><span class="s3">(</span><span class="s1">sparse_container</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">sparse_container</span><span class="s3">([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]])</span>
    <span class="s1">desired_format </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">format</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">add_dummy_feature</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">issparse</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) </span><span class="s2">and </span><span class="s1">X</span><span class="s3">.</span><span class="s1">format </span><span class="s3">== </span><span class="s1">desired_format</span><span class="s3">, </span><span class="s1">X</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">test_fit_cold_start</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">X_2d </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[:, :</span><span class="s4">2</span><span class="s3">]</span>

    <span class="s0"># Scalers that have a partial_fit method</span>
    <span class="s1">scalers </span><span class="s3">= [</span>
        <span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">with_std</span><span class="s3">=</span><span class="s2">False</span><span class="s3">),</span>
        <span class="s1">MinMaxScaler</span><span class="s3">(),</span>
        <span class="s1">MaxAbsScaler</span><span class="s3">(),</span>
    <span class="s3">]</span>

    <span class="s2">for </span><span class="s1">scaler </span><span class="s2">in </span><span class="s1">scalers</span><span class="s3">:</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s0"># with a different shape, this may break the scaler unless the internal</span>
        <span class="s0"># state is reset</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_notfitted</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_1col</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;standardize&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;X&quot;</span><span class="s3">, [</span><span class="s1">X_1col</span><span class="s3">, </span><span class="s1">X_2d</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_inverse</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">, </span><span class="s1">X</span><span class="s3">):</span>
    <span class="s0"># Make sure we get the original input when applying transform and then</span>
    <span class="s0"># inverse transform</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) </span><span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;box-cox&quot; </span><span class="s2">else </span><span class="s1">X</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_power_transformer_1d</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_1col</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">standardize </span><span class="s2">in </span><span class="s3">[</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]:</span>
        <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">)</span>

        <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">X_trans_func </span><span class="s3">= </span><span class="s1">power_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">)</span>

        <span class="s1">X_expected</span><span class="s3">, </span><span class="s1">lambda_expected </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">flatten</span><span class="s3">())</span>

        <span class="s2">if </span><span class="s1">standardize</span><span class="s3">:</span>
            <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">), </span><span class="s1">X_trans</span><span class="s3">)</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">), </span><span class="s1">X_trans_func</span><span class="s3">)</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">))</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">lambda_expected</span><span class="s3">, </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>

        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">) == </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_power_transformer_2d</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">standardize </span><span class="s2">in </span><span class="s3">[</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]:</span>
        <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">)</span>

        <span class="s1">X_trans_class </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">X_trans_func </span><span class="s3">= </span><span class="s1">power_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">X_trans </span><span class="s2">in </span><span class="s3">[</span><span class="s1">X_trans_class</span><span class="s3">, </span><span class="s1">X_trans_func</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]):</span>
                <span class="s1">X_expected</span><span class="s3">, </span><span class="s1">lmbda </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">boxcox</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, </span><span class="s1">j</span><span class="s3">].</span><span class="s1">flatten</span><span class="s3">())</span>

                <span class="s2">if </span><span class="s1">standardize</span><span class="s3">:</span>
                    <span class="s1">X_expected </span><span class="s3">= </span><span class="s1">scale</span><span class="s3">(</span><span class="s1">X_expected</span><span class="s3">)</span>

                <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">[:, </span><span class="s1">j</span><span class="s3">], </span><span class="s1">X_expected</span><span class="s3">)</span>
                <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">[</span><span class="s1">j</span><span class="s3">])</span>

            <span class="s0"># Test inverse transformation</span>
            <span class="s1">X_inv </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_inv</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">) == </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_power_transformer_boxcox_strictly_positive_exception</span><span class="s3">():</span>
    <span class="s0"># Exceptions should be raised for negative arrays and zero arrays when</span>
    <span class="s0"># method is boxcox</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">)</span>
    <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">))</span>
    <span class="s1">X_with_negatives </span><span class="s3">= </span><span class="s1">X_2d</span>
    <span class="s1">not_positive_message </span><span class="s3">= </span><span class="s5">&quot;strictly positive&quot;</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">not_positive_message</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_with_negatives</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">not_positive_message</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_with_negatives</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">not_positive_message</span><span class="s3">):</span>
        <span class="s1">power_transform</span><span class="s3">(</span><span class="s1">X_with_negatives</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">not_positive_message</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">))</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">not_positive_message</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">))</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">not_positive_message</span><span class="s3">):</span>
        <span class="s1">power_transform</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">), </span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;X&quot;</span><span class="s3">, [</span><span class="s1">X_2d</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">), -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_yeojohnson_any_input</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
    <span class="s0"># Yeo-Johnson method should support any kind of input</span>
    <span class="s1">power_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_shape_exception</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">)</span>
    <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># Exceptions should be raised for arrays with different num_columns</span>
    <span class="s0"># than during fitting</span>
    <span class="s1">wrong_shape_message </span><span class="s3">= (</span>
        <span class="s5">r&quot;X has \d+ features, but PowerTransformer is &quot; r&quot;expecting \d+ features&quot;</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">wrong_shape_message</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">:</span><span class="s4">1</span><span class="s3">])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">wrong_shape_message</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">:</span><span class="s4">1</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_power_transformer_lambda_zero</span><span class="s3">():</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">)[:, </span><span class="s4">0</span><span class="s3">:</span><span class="s4">1</span><span class="s3">]</span>

    <span class="s0"># Test the lambda = 0 case</span>
    <span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_ </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">), </span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_power_transformer_lambda_one</span><span class="s3">():</span>
    <span class="s0"># Make sure lambda = 1 corresponds to the identity for yeo-johnson</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">)[:, </span><span class="s4">0</span><span class="s3">:</span><span class="s4">1</span><span class="s3">]</span>

    <span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_ </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">])</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;method, lmbda&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_optimization_power_transformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">lmbda</span><span class="s3">):</span>
    <span class="s0"># Test the optimization procedure:</span>
    <span class="s0"># - set a predefined value for lambda</span>
    <span class="s0"># - apply inverse_transform to a normal dist (we get X_inv)</span>
    <span class="s0"># - apply fit_transform to X_inv (we get X_inv_trans)</span>
    <span class="s0"># - check that X_inv_trans is roughly equal to X</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s4">20000</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">loc</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">scale</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_ </span><span class="s3">= [</span><span class="s1">lmbda</span><span class="s3">]</span>
    <span class="s1">X_inv </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">X_inv_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_inv</span><span class="s3">)</span>

    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">X </span><span class="s3">- </span><span class="s1">X_inv_trans</span><span class="s3">) / </span><span class="s1">n_samples</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">X_inv_trans</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">X_inv_trans</span><span class="s3">.</span><span class="s1">std</span><span class="s3">(), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_yeo_johnson_darwin_example</span><span class="s3">():</span>
    <span class="s0"># test from original paper &quot;A new family of power transformations to</span>
    <span class="s0"># improve normality or symmetry&quot; by Yeo and Johnson.</span>
    <span class="s1">X </span><span class="s3">= [</span><span class="s4">6.1</span><span class="s3">, -</span><span class="s4">8.4</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">0.7</span><span class="s3">, </span><span class="s4">2.9</span><span class="s3">, </span><span class="s4">3.5</span><span class="s3">, </span><span class="s4">5.1</span><span class="s3">, </span><span class="s4">1.8</span><span class="s3">, </span><span class="s4">3.6</span><span class="s3">, </span><span class="s4">7.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">9.3</span><span class="s3">, </span><span class="s4">7.5</span><span class="s3">, -</span><span class="s4">6.0</span><span class="s3">]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">lmbda </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">lambdas_</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">allclose</span><span class="s3">(</span><span class="s1">lmbda</span><span class="s3">, </span><span class="s4">1.305</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-3</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_nans</span><span class="s3">(</span><span class="s1">method</span><span class="s3">):</span>
    <span class="s0"># Make sure lambda estimation is not influenced by NaN values</span>
    <span class="s0"># and that transform() supports NaN silently</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X_1col</span><span class="s3">)</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s1">method</span><span class="s3">)</span>
    <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">lmbda_no_nans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s0"># concat nans at the end and check lambda stays the same</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full_like</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)])</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">lmbda_nans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>

    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">lmbda_no_nans</span><span class="s3">, </span><span class="s1">lmbda_nans</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">5</span><span class="s3">)</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;standardize&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_fit_transform</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">):</span>
    <span class="s0"># check that fit_transform() and fit().transform() return the same values</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_1col</span>
    <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;box-cox&quot;</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;standardize&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_copy_True</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">):</span>
    <span class="s0"># Check that neither fit, transform, fit_transform nor inverse_transform</span>
    <span class="s0"># modify X inplace when copy=True</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_1col</span>
    <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;box-cox&quot;</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_original </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">X </span><span class="s2">is not </span><span class="s1">X_original  </span><span class="s0"># sanity checks</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_original</span><span class="s3">)</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_original</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans </span><span class="s2">is not </span><span class="s1">X</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_original</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans </span><span class="s2">is not </span><span class="s1">X</span>

    <span class="s1">X_inv_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans </span><span class="s2">is not </span><span class="s1">X_inv_trans</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;method&quot;</span><span class="s3">, [</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">, </span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;standardize&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_copy_False</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">):</span>
    <span class="s0"># check that when copy=False fit doesn't change X inplace but transform,</span>
    <span class="s0"># fit_transform and inverse_transform do.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X_1col</span>
    <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;box-cox&quot;</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">X_original </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">X </span><span class="s2">is not </span><span class="s1">X_original  </span><span class="s0"># sanity checks</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_original</span><span class="s3">)</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X_original</span><span class="s3">)  </span><span class="s0"># fit didn't change X</span>

    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans </span><span class="s2">is </span><span class="s1">X</span>

    <span class="s2">if </span><span class="s1">method </span><span class="s3">== </span><span class="s5">&quot;box-cox&quot;</span><span class="s3">:</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans </span><span class="s2">is </span><span class="s1">X</span>

    <span class="s1">X_inv_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans </span><span class="s2">is </span><span class="s1">X_inv_trans</span>


<span class="s2">def </span><span class="s1">test_power_transformer_box_cox_raise_all_nans_col</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Check that box-cox raises informative when a column contains all nans. 
 
    Non-regression test for gh-26303 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">((</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">))</span>
    <span class="s1">X</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>

    <span class="s1">err_msg </span><span class="s3">= </span><span class="s5">&quot;Column must not be all nan.&quot;</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;box-cox&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;X_2&quot;</span><span class="s3">,</span>
    <span class="s3">[</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s4">0.8</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)]</span>
    <span class="s3">+ [</span>
        <span class="s1">csr_container</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">full</span><span class="s3">((</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1</span><span class="s3">), </span><span class="s1">fill_value</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">csr_container </span><span class="s2">in </span><span class="s1">CSR_CONTAINERS</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_standard_scaler_sparse_partial_fit_finite_variance</span><span class="s3">(</span><span class="s1">X_2</span><span class="s3">):</span>
    <span class="s0"># non-regression test for:</span>
    <span class="s0"># https://github.com/scikit-learn/scikit-learn/issues/16448</span>
    <span class="s1">X_1 </span><span class="s3">= </span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">density</span><span class="s3">=</span><span class="s4">0.8</span><span class="s3">)</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">(</span><span class="s1">with_mean</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">scaler</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_1</span><span class="s3">).</span><span class="s1">partial_fit</span><span class="s3">(</span><span class="s1">X_2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isfinite</span><span class="s3">(</span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">var_</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;feature_range&quot;</span><span class="s3">, [(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">), (-</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_minmax_scaler_clip</span><span class="s3">(</span><span class="s1">feature_range</span><span class="s3">):</span>
    <span class="s0"># test behaviour of the parameter 'clip' in MinMaxScaler</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">MinMaxScaler</span><span class="s3">(</span><span class="s1">feature_range</span><span class="s3">=</span><span class="s1">feature_range</span><span class="s3">, </span><span class="s1">clip</span><span class="s3">=</span><span class="s2">True</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">X_min</span><span class="s3">, </span><span class="s1">X_max </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X_test </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">X_min</span><span class="s3">[:</span><span class="s4">2</span><span class="s3">] - </span><span class="s4">10</span><span class="s3">, </span><span class="s1">X_max</span><span class="s3">[</span><span class="s4">2</span><span class="s3">:] + </span><span class="s4">10</span><span class="s3">]]</span>
    <span class="s1">X_transformed </span><span class="s3">= </span><span class="s1">scaler</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span>
        <span class="s1">X_transformed</span><span class="s3">,</span>
        <span class="s3">[[</span><span class="s1">feature_range</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">feature_range</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">feature_range</span><span class="s3">[</span><span class="s4">1</span><span class="s3">], </span><span class="s1">feature_range</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]]],</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_standard_scaler_raise_error_for_1d_input</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Check that `inverse_transform` from `StandardScaler` raises an error 
    with 1D array. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/19518 
    &quot;&quot;&quot;</span>
    <span class="s1">scaler </span><span class="s3">= </span><span class="s1">StandardScaler</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">)</span>
    <span class="s1">err_msg </span><span class="s3">= </span><span class="s5">&quot;Expected 2D array, got 1D array instead&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">scaler</span><span class="s3">.</span><span class="s1">inverse_transform</span><span class="s3">(</span><span class="s1">X_2d</span><span class="s3">[:, </span><span class="s4">0</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_power_transformer_significantly_non_gaussian</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Check that significantly non-Gaussian data before transforms correctly. 
 
    For some explored lambdas, the transformed data may be constant and will 
    be rejected. Non-regression test for 
    https://github.com/scikit-learn/scikit-learn/issues/14959 
    &quot;&quot;&quot;</span>

    <span class="s1">X_non_gaussian </span><span class="s3">= </span><span class="s4">1e6 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s4">0.6</span><span class="s3">, </span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">4.0</span><span class="s3">] * </span><span class="s4">4 </span><span class="s3">+ [</span><span class="s4">11</span><span class="s3">, </span><span class="s4">12</span><span class="s3">, </span><span class="s4">12</span><span class="s3">, </span><span class="s4">16</span><span class="s3">, </span><span class="s4">17</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">85</span><span class="s3">, </span><span class="s4">90</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span>
    <span class="s3">).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">()</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, </span><span class="s1">RuntimeWarning</span><span class="s3">)</span>
        <span class="s1">X_trans </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X_non_gaussian</span><span class="s3">)</span>

    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">X_trans</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">() == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s4">0.0</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">std</span><span class="s3">() == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s4">1.0</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">min</span><span class="s3">() &gt; -</span><span class="s4">2</span>
    <span class="s2">assert </span><span class="s1">X_trans</span><span class="s3">.</span><span class="s1">max</span><span class="s3">() &lt; </span><span class="s4">2</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;Transformer&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">MinMaxScaler</span><span class="s3">,</span>
        <span class="s1">MaxAbsScaler</span><span class="s3">,</span>
        <span class="s1">RobustScaler</span><span class="s3">,</span>
        <span class="s1">StandardScaler</span><span class="s3">,</span>
        <span class="s1">QuantileTransformer</span><span class="s3">,</span>
        <span class="s1">PowerTransformer</span><span class="s3">,</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_one_to_one_features</span><span class="s3">(</span><span class="s1">Transformer</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Check one-to-one transformers give correct feature names.&quot;&quot;&quot;</span>
    <span class="s1">tr </span><span class="s3">= </span><span class="s1">Transformer</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">names_out </span><span class="s3">= </span><span class="s1">tr</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names_out</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;Transformer&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">MinMaxScaler</span><span class="s3">,</span>
        <span class="s1">MaxAbsScaler</span><span class="s3">,</span>
        <span class="s1">RobustScaler</span><span class="s3">,</span>
        <span class="s1">StandardScaler</span><span class="s3">,</span>
        <span class="s1">QuantileTransformer</span><span class="s3">,</span>
        <span class="s1">PowerTransformer</span><span class="s3">,</span>
        <span class="s1">Normalizer</span><span class="s3">,</span>
        <span class="s1">Binarizer</span><span class="s3">,</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_one_to_one_features_pandas</span><span class="s3">(</span><span class="s1">Transformer</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Check one-to-one transformers give correct feature names.&quot;&quot;&quot;</span>
    <span class="s1">pd </span><span class="s3">= </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">importorskip</span><span class="s3">(</span><span class="s5">&quot;pandas&quot;</span><span class="s3">)</span>

    <span class="s1">df </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">)</span>
    <span class="s1">tr </span><span class="s3">= </span><span class="s1">Transformer</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">df</span><span class="s3">)</span>

    <span class="s1">names_out_df_default </span><span class="s3">= </span><span class="s1">tr</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names_out_df_default</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">)</span>

    <span class="s1">names_out_df_valid_in </span><span class="s3">= </span><span class="s1">tr</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names_out_df_valid_in</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">feature_names</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">escape</span><span class="s3">(</span><span class="s5">&quot;input_features is not equal to feature_names_in_&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">invalid_names </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s5">&quot;abcd&quot;</span><span class="s3">)</span>
        <span class="s1">tr</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">(</span><span class="s1">invalid_names</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_kernel_centerer_feature_names_out</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Test that kernel centerer `feature_names_out`.&quot;&quot;&quot;</span>

    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random_sample</span><span class="s3">((</span><span class="s4">6</span><span class="s3">, </span><span class="s4">4</span><span class="s3">))</span>
    <span class="s1">X_pairwise </span><span class="s3">= </span><span class="s1">linear_kernel</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">centerer </span><span class="s3">= </span><span class="s1">KernelCenterer</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_pairwise</span><span class="s3">)</span>

    <span class="s1">names_out </span><span class="s3">= </span><span class="s1">centerer</span><span class="s3">.</span><span class="s1">get_feature_names_out</span><span class="s3">()</span>
    <span class="s1">samples_out2 </span><span class="s3">= </span><span class="s1">X_pairwise</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">names_out</span><span class="s3">, [</span><span class="s5">f&quot;kernelcenterer</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s5">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">samples_out2</span><span class="s3">)])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;standardize&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_power_transformer_constant_feature</span><span class="s3">(</span><span class="s1">standardize</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Check that PowerTransfomer leaves constant features unchanged.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= [[-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">], [-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">], [-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">]]</span>

    <span class="s1">pt </span><span class="s3">= </span><span class="s1">PowerTransformer</span><span class="s3">(</span><span class="s1">method</span><span class="s3">=</span><span class="s5">&quot;yeo-johnson&quot;</span><span class="s3">, </span><span class="s1">standardize</span><span class="s3">=</span><span class="s1">standardize</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pt</span><span class="s3">.</span><span class="s1">lambdas_</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>

    <span class="s1">Xft </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">fit_transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">Xt </span><span class="s3">= </span><span class="s1">pt</span><span class="s3">.</span><span class="s1">transform</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">Xt_ </span><span class="s2">in </span><span class="s3">[</span><span class="s1">Xft</span><span class="s3">, </span><span class="s1">Xt</span><span class="s3">]:</span>
        <span class="s2">if </span><span class="s1">standardize</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Xt_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Xt_</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
</pre>
</body>
</html>