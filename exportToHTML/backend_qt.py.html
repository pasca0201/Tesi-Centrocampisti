<html>
<head>
<title>backend_qt.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
backend_qt.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">traceback</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_api</span><span class="s2">, </span><span class="s1">backend_tools</span><span class="s2">, </span><span class="s1">cbook</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">_pylab_helpers </span><span class="s0">import </span><span class="s1">Gcf</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_Backend</span><span class="s2">, </span><span class="s1">FigureCanvasBase</span><span class="s2">, </span><span class="s1">FigureManagerBase</span><span class="s2">, </span><span class="s1">NavigationToolbar2</span><span class="s2">,</span>
    <span class="s1">TimerBase</span><span class="s2">, </span><span class="s1">cursors</span><span class="s2">, </span><span class="s1">ToolContainerBase</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">,</span>
    <span class="s1">CloseEvent</span><span class="s2">, </span><span class="s1">KeyEvent</span><span class="s2">, </span><span class="s1">LocationEvent</span><span class="s2">, </span><span class="s1">MouseEvent</span><span class="s2">, </span><span class="s1">ResizeEvent</span><span class="s2">,</span>
    <span class="s1">_allow_interrupt</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">qt_editor</span><span class="s2">.</span><span class="s1">figureoptions </span><span class="s0">as </span><span class="s1">figureoptions</span>
<span class="s0">from </span><span class="s2">. </span><span class="s0">import </span><span class="s1">qt_compat</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">qt_compat </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">QtCore</span><span class="s2">, </span><span class="s1">QtGui</span><span class="s2">, </span><span class="s1">QtWidgets</span><span class="s2">, </span><span class="s1">__version__</span><span class="s2">, </span><span class="s1">QT_API</span><span class="s2">, </span><span class="s1">_to_int</span><span class="s2">, </span><span class="s1">_isdeleted</span><span class="s2">)</span>


<span class="s3"># SPECIAL_KEYS are Qt::Key that do *not* return their Unicode name</span>
<span class="s3"># instead they have manually specified names.</span>
<span class="s1">SPECIAL_KEYS </span><span class="s2">= {</span>
    <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">Key</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)): </span><span class="s1">v </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Escape&quot;</span><span class="s2">, </span><span class="s4">&quot;escape&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Tab&quot;</span><span class="s2">, </span><span class="s4">&quot;tab&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Backspace&quot;</span><span class="s2">, </span><span class="s4">&quot;backspace&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Return&quot;</span><span class="s2">, </span><span class="s4">&quot;enter&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Enter&quot;</span><span class="s2">, </span><span class="s4">&quot;enter&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Insert&quot;</span><span class="s2">, </span><span class="s4">&quot;insert&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Delete&quot;</span><span class="s2">, </span><span class="s4">&quot;delete&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Pause&quot;</span><span class="s2">, </span><span class="s4">&quot;pause&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_SysReq&quot;</span><span class="s2">, </span><span class="s4">&quot;sysreq&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Clear&quot;</span><span class="s2">, </span><span class="s4">&quot;clear&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Home&quot;</span><span class="s2">, </span><span class="s4">&quot;home&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_End&quot;</span><span class="s2">, </span><span class="s4">&quot;end&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Left&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Up&quot;</span><span class="s2">, </span><span class="s4">&quot;up&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Right&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Down&quot;</span><span class="s2">, </span><span class="s4">&quot;down&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_PageUp&quot;</span><span class="s2">, </span><span class="s4">&quot;pageup&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_PageDown&quot;</span><span class="s2">, </span><span class="s4">&quot;pagedown&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Shift&quot;</span><span class="s2">, </span><span class="s4">&quot;shift&quot;</span><span class="s2">),</span>
        <span class="s3"># In macOS, the control and super (aka cmd/apple) keys are switched.</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Control&quot;</span><span class="s2">, </span><span class="s4">&quot;control&quot; </span><span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">&quot;darwin&quot; </span><span class="s0">else </span><span class="s4">&quot;cmd&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Meta&quot;</span><span class="s2">, </span><span class="s4">&quot;meta&quot; </span><span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">&quot;darwin&quot; </span><span class="s0">else </span><span class="s4">&quot;control&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Alt&quot;</span><span class="s2">, </span><span class="s4">&quot;alt&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_CapsLock&quot;</span><span class="s2">, </span><span class="s4">&quot;caps_lock&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F1&quot;</span><span class="s2">, </span><span class="s4">&quot;f1&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F2&quot;</span><span class="s2">, </span><span class="s4">&quot;f2&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F3&quot;</span><span class="s2">, </span><span class="s4">&quot;f3&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F4&quot;</span><span class="s2">, </span><span class="s4">&quot;f4&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F5&quot;</span><span class="s2">, </span><span class="s4">&quot;f5&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F6&quot;</span><span class="s2">, </span><span class="s4">&quot;f6&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F7&quot;</span><span class="s2">, </span><span class="s4">&quot;f7&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F8&quot;</span><span class="s2">, </span><span class="s4">&quot;f8&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F9&quot;</span><span class="s2">, </span><span class="s4">&quot;f9&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F10&quot;</span><span class="s2">, </span><span class="s4">&quot;f10&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F10&quot;</span><span class="s2">, </span><span class="s4">&quot;f11&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_F12&quot;</span><span class="s2">, </span><span class="s4">&quot;f12&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Super_L&quot;</span><span class="s2">, </span><span class="s4">&quot;super&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;Key_Super_R&quot;</span><span class="s2">, </span><span class="s4">&quot;super&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
<span class="s2">}</span>
<span class="s3"># Define which modifier keys are collected on keyboard events.</span>
<span class="s3"># Elements are (Qt::KeyboardModifiers, Qt::Key) tuples.</span>
<span class="s3"># Order determines the modifier order (ctrl+alt+...) reported by Matplotlib.</span>
<span class="s1">_MODIFIER_KEYS </span><span class="s2">= [</span>
    <span class="s2">(</span><span class="s1">_to_int</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">KeyboardModifier</span><span class="s2">, </span><span class="s1">mod</span><span class="s2">)),</span>
     <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">Key</span><span class="s2">, </span><span class="s1">key</span><span class="s2">)))</span>
    <span class="s0">for </span><span class="s1">mod</span><span class="s2">, </span><span class="s1">key </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s2">(</span><span class="s4">&quot;ControlModifier&quot;</span><span class="s2">, </span><span class="s4">&quot;Key_Control&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;AltModifier&quot;</span><span class="s2">, </span><span class="s4">&quot;Key_Alt&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;ShiftModifier&quot;</span><span class="s2">, </span><span class="s4">&quot;Key_Shift&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">&quot;MetaModifier&quot;</span><span class="s2">, </span><span class="s4">&quot;Key_Meta&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
<span class="s2">]</span>
<span class="s1">cursord </span><span class="s2">= {</span>
    <span class="s1">k</span><span class="s2">: </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">CursorShape</span><span class="s2">, </span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">MOVE</span><span class="s2">, </span><span class="s4">&quot;SizeAllCursor&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">HAND</span><span class="s2">, </span><span class="s4">&quot;PointingHandCursor&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">POINTER</span><span class="s2">, </span><span class="s4">&quot;ArrowCursor&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">SELECT_REGION</span><span class="s2">, </span><span class="s4">&quot;CrossCursor&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">WAIT</span><span class="s2">, </span><span class="s4">&quot;WaitCursor&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">RESIZE_HORIZONTAL</span><span class="s2">, </span><span class="s4">&quot;SizeHorCursor&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">cursors</span><span class="s2">.</span><span class="s1">RESIZE_VERTICAL</span><span class="s2">, </span><span class="s4">&quot;SizeVerCursor&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
<span class="s2">}</span>


<span class="s3"># lru_cache keeps a reference to the QApplication instance, keeping it from</span>
<span class="s3"># being GC'd.</span>
<span class="s2">@</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">lru_cache</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">_create_qApp</span><span class="s2">():</span>
    <span class="s1">app </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">()</span>

    <span class="s3"># Create a new QApplication and configure it if none exists yet, as only</span>
    <span class="s3"># one QApplication can exist at a time.</span>
    <span class="s0">if </span><span class="s1">app </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s3"># display_is_valid returns False only if on Linux and neither X11</span>
        <span class="s3"># nor Wayland display can be opened.</span>
        <span class="s0">if not </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">_c_internal_utils</span><span class="s2">.</span><span class="s1">display_is_valid</span><span class="s2">():</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">'Invalid DISPLAY variable'</span><span class="s2">)</span>

        <span class="s3"># Check to make sure a QApplication from a different major version</span>
        <span class="s3"># of Qt is not instantiated in the process</span>
        <span class="s0">if </span><span class="s1">QT_API </span><span class="s0">in </span><span class="s2">{</span><span class="s4">'PyQt6'</span><span class="s2">, </span><span class="s4">'PySide6'</span><span class="s2">}:</span>
            <span class="s1">other_bindings </span><span class="s2">= (</span><span class="s4">'PyQt5'</span><span class="s2">, </span><span class="s4">'PySide2'</span><span class="s2">)</span>
            <span class="s1">qt_version </span><span class="s2">= </span><span class="s5">6</span>
        <span class="s0">elif </span><span class="s1">QT_API </span><span class="s0">in </span><span class="s2">{</span><span class="s4">'PyQt5'</span><span class="s2">, </span><span class="s4">'PySide2'</span><span class="s2">}:</span>
            <span class="s1">other_bindings </span><span class="s2">= (</span><span class="s4">'PyQt6'</span><span class="s2">, </span><span class="s4">'PySide6'</span><span class="s2">)</span>
            <span class="s1">qt_version </span><span class="s2">= </span><span class="s5">5</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;Should never be here&quot;</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">binding </span><span class="s0">in </span><span class="s1">other_bindings</span><span class="s2">:</span>
            <span class="s1">mod </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">binding</span><span class="s0">}</span><span class="s4">.QtWidgets'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">mod </span><span class="s0">is not None and </span><span class="s1">mod</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">() </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">other_core </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">binding</span><span class="s0">}</span><span class="s4">.QtCore'</span><span class="s2">)</span>
                <span class="s1">_api</span><span class="s2">.</span><span class="s1">warn_external</span><span class="s2">(</span>
                    <span class="s4">f'Matplotlib is using </span><span class="s0">{</span><span class="s1">QT_API</span><span class="s0">} </span><span class="s4">which wraps '</span>
                    <span class="s4">f'</span><span class="s0">{</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">qVersion</span><span class="s2">()</span><span class="s0">} </span><span class="s4">however an instantiated '</span>
                    <span class="s4">f'QApplication from </span><span class="s0">{</span><span class="s1">binding</span><span class="s0">} </span><span class="s4">which wraps '</span>
                    <span class="s4">f'</span><span class="s0">{</span><span class="s1">other_core</span><span class="s2">.</span><span class="s1">qVersion</span><span class="s2">()</span><span class="s0">} </span><span class="s4">exists.  Mixing Qt major '</span>
                    <span class="s4">'versions may not work as expected.'</span>
                <span class="s2">)</span>
                <span class="s0">break</span>
        <span class="s0">if </span><span class="s1">qt_version </span><span class="s2">== </span><span class="s5">5</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AA_EnableHighDpiScaling</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:  </span><span class="s3"># Only for Qt&gt;=5.6, &lt;6.</span>
                <span class="s0">pass</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">setHighDpiScaleFactorRoundingPolicy</span><span class="s2">(</span>
                <span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">HighDpiScaleFactorRoundingPolicy</span><span class="s2">.</span><span class="s1">PassThrough</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:  </span><span class="s3"># Only for Qt&gt;=5.14.</span>
            <span class="s0">pass</span>
        <span class="s1">app </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">([</span><span class="s4">&quot;matplotlib&quot;</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">== </span><span class="s4">&quot;darwin&quot;</span><span class="s2">:</span>
            <span class="s1">image </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_get_data_path</span><span class="s2">(</span><span class="s4">'images/matplotlib.svg'</span><span class="s2">))</span>
            <span class="s1">icon </span><span class="s2">= </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QIcon</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
            <span class="s1">app</span><span class="s2">.</span><span class="s1">setWindowIcon</span><span class="s2">(</span><span class="s1">icon</span><span class="s2">)</span>
        <span class="s1">app</span><span class="s2">.</span><span class="s1">setQuitOnLastWindowClosed</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">cbook</span><span class="s2">.</span><span class="s1">_setup_new_guiapp</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">qt_version </span><span class="s2">== </span><span class="s5">5</span><span class="s2">:</span>
            <span class="s1">app</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AA_UseHighDpiPixmaps</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">app</span>


<span class="s0">def </span><span class="s1">_allow_interrupt_qt</span><span class="s2">(</span><span class="s1">qapp_or_eventloop</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;A context manager that allows terminating a plot by sending a SIGINT.&quot;&quot;&quot;</span>

    <span class="s3"># Use QSocketNotifier to read the socketpair while the Qt event loop runs.</span>

    <span class="s0">def </span><span class="s1">prepare_notifier</span><span class="s2">(</span><span class="s1">rsock</span><span class="s2">):</span>
        <span class="s1">sn </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QSocketNotifier</span><span class="s2">(</span><span class="s1">rsock</span><span class="s2">.</span><span class="s1">fileno</span><span class="s2">(), </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QSocketNotifier</span><span class="s2">.</span><span class="s1">Type</span><span class="s2">.</span><span class="s1">Read</span><span class="s2">)</span>

        <span class="s2">@</span><span class="s1">sn</span><span class="s2">.</span><span class="s1">activated</span><span class="s2">.</span><span class="s1">connect</span>
        <span class="s0">def </span><span class="s1">_may_clear_sock</span><span class="s2">():</span>
            <span class="s3"># Running a Python function on socket activation gives the interpreter a</span>
            <span class="s3"># chance to handle the signal in Python land.  We also need to drain the</span>
            <span class="s3"># socket with recv() to re-arm it, because it will be written to as part of</span>
            <span class="s3"># the wakeup.  (We need this in case set_wakeup_fd catches a signal other</span>
            <span class="s3"># than SIGINT and we shall continue waiting.)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">rsock</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">BlockingIOError</span><span class="s2">:</span>
                <span class="s3"># This may occasionally fire too soon or more than once on Windows, so</span>
                <span class="s3"># be forgiving about reading an empty socket.</span>
                <span class="s0">pass</span>

        <span class="s0">return </span><span class="s1">sn  </span><span class="s3"># Actually keep the notifier alive.</span>

    <span class="s0">def </span><span class="s1">handle_sigint</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">qapp_or_eventloop</span><span class="s2">, </span><span class="s4">'closeAllWindows'</span><span class="s2">):</span>
            <span class="s1">qapp_or_eventloop</span><span class="s2">.</span><span class="s1">closeAllWindows</span><span class="s2">()</span>
        <span class="s1">qapp_or_eventloop</span><span class="s2">.</span><span class="s1">quit</span><span class="s2">()</span>

    <span class="s0">return </span><span class="s1">_allow_interrupt</span><span class="s2">(</span><span class="s1">prepare_notifier</span><span class="s2">, </span><span class="s1">handle_sigint</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TimerQT</span><span class="s2">(</span><span class="s1">TimerBase</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Subclass of `.TimerBase` using QTimer events.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s3"># Create a new timer and connect the timeout() signal to the</span>
        <span class="s3"># _on_timer method.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QTimer</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer</span><span class="s2">.</span><span class="s1">timeout</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_timer</span><span class="s2">)</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__del__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># The check for deletedness is needed to avoid an error at animation</span>
        <span class="s3"># shutdown with PySide2.</span>
        <span class="s0">if not </span><span class="s1">_isdeleted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_timer</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer_stop</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_timer_set_single_shot</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer</span><span class="s2">.</span><span class="s1">setSingleShot</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_single</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_timer_set_interval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer</span><span class="s2">.</span><span class="s1">setInterval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_interval</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_timer_start</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_timer_stop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_timer</span><span class="s2">.</span><span class="s1">stop</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">FigureCanvasQT</span><span class="s2">(</span><span class="s1">FigureCanvasBase</span><span class="s2">, </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QWidget</span><span class="s2">):</span>
    <span class="s1">required_interactive_framework </span><span class="s2">= </span><span class="s4">&quot;qt&quot;</span>
    <span class="s1">_timer_cls </span><span class="s2">= </span><span class="s1">TimerQT</span>
    <span class="s1">manager_class </span><span class="s2">= </span><span class="s1">_api</span><span class="s2">.</span><span class="s1">classproperty</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">cls</span><span class="s2">: </span><span class="s1">FigureManagerQT</span><span class="s2">)</span>

    <span class="s1">buttond </span><span class="s2">= {</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">MouseButton</span><span class="s2">, </span><span class="s1">k</span><span class="s2">): </span><span class="s1">v </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s4">&quot;LeftButton&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;RightButton&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">RIGHT</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;MiddleButton&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">MIDDLE</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;XButton1&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">BACK</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s4">&quot;XButton2&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">FORWARD</span><span class="s2">),</span>
        <span class="s2">]</span>
    <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">_create_qApp</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">figure</span><span class="s2">=</span><span class="s1">figure</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_pending </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_drawing </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_rect_callback </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">painter</span><span class="s2">: </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_in_resize_event </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">setAttribute</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">WidgetAttribute</span><span class="s2">.</span><span class="s1">WA_OpaquePaintEvent</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setMouseTracking</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">resize</span><span class="s2">(*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_width_height</span><span class="s2">())</span>

        <span class="s1">palette </span><span class="s2">= </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QPalette</span><span class="s2">(</span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QColor</span><span class="s2">(</span><span class="s4">&quot;white&quot;</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setPalette</span><span class="s2">(</span><span class="s1">palette</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_update_pixel_ratio</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_set_device_pixel_ratio</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">devicePixelRatioF</span><span class="s2">() </span><span class="s0">or </span><span class="s5">1</span><span class="s2">):  </span><span class="s3"># rarely, devicePixelRatioF=0</span>
            <span class="s3"># The easiest way to resize the canvas is to emit a resizeEvent</span>
            <span class="s3"># since we implement all the logic for resizing the canvas for</span>
            <span class="s3"># that event.</span>
            <span class="s1">event </span><span class="s2">= </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QResizeEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">(), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">size</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">resizeEvent</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_update_screen</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">screen</span><span class="s2">):</span>
        <span class="s3"># Handler for changes to a window's attached screen.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_pixel_ratio</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">screen </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">screen</span><span class="s2">.</span><span class="s1">physicalDotsPerInchChanged</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_pixel_ratio</span><span class="s2">)</span>
            <span class="s1">screen</span><span class="s2">.</span><span class="s1">logicalDotsPerInchChanged</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_pixel_ratio</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">showEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s3"># Set up correct pixel ratio, and connect to any signal changes for it,</span>
        <span class="s3"># once the window is shown (and thus has these attributes).</span>
        <span class="s1">window </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">().</span><span class="s1">windowHandle</span><span class="s2">()</span>
        <span class="s1">window</span><span class="s2">.</span><span class="s1">screenChanged</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_update_screen</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_screen</span><span class="s2">(</span><span class="s1">window</span><span class="s2">.</span><span class="s1">screen</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">set_cursor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">):</span>
        <span class="s3"># docstring inherited</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setCursor</span><span class="s2">(</span><span class="s1">_api</span><span class="s2">.</span><span class="s1">check_getitem</span><span class="s2">(</span><span class="s1">cursord</span><span class="s2">, </span><span class="s1">cursor</span><span class="s2">=</span><span class="s1">cursor</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pos</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Calculate mouse coordinates in physical pixels. 
 
        Qt uses logical pixels, but the figure is scaled to physical 
        pixels for rendering.  Transform to physical pixels so that 
        all of the down-stream transforms work as expected. 
 
        Also, the origin is different and needs to be corrected. 
        &quot;&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">pos </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">mapFromGlobal</span><span class="s2">(</span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QCursor</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">, </span><span class="s4">&quot;position&quot;</span><span class="s2">):  </span><span class="s3"># qt6 QtGui.QEvent</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">position</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">, </span><span class="s4">&quot;pos&quot;</span><span class="s2">):  </span><span class="s3"># qt5 QtCore.QEvent</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">pos</span><span class="s2">()</span>
        <span class="s3"># (otherwise, it's already a QPoint)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x</span><span class="s2">()</span>
        <span class="s3"># flip y so y=0 is bottom of canvas</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">height </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio </span><span class="s2">- </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">x </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span><span class="s2">, </span><span class="s1">y </span><span class="s2">* </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span>

    <span class="s0">def </span><span class="s1">enterEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s3"># Force querying of the modifiers, as the cached modifier state can</span>
        <span class="s3"># have been invalidated while the window was out of focus.</span>
        <span class="s1">mods </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">().</span><span class="s1">queryKeyboardModifiers</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">LocationEvent</span><span class="s2">(</span><span class="s4">&quot;figure_enter_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                      <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">event</span><span class="s2">),</span>
                      <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(</span><span class="s1">mods</span><span class="s2">),</span>
                      <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">leaveEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">restoreOverrideCursor</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">LocationEvent</span><span class="s2">(</span><span class="s4">&quot;figure_leave_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                      <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(),</span>
                      <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(),</span>
                      <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">mousePressEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">button </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttond</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">button</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">button </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s4">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                       <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">event</span><span class="s2">), </span><span class="s1">button</span><span class="s2">,</span>
                       <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(),</span>
                       <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">mouseDoubleClickEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">button </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttond</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">button</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">button </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s4">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                       <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">event</span><span class="s2">), </span><span class="s1">button</span><span class="s2">, </span><span class="s1">dblclick</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                       <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(),</span>
                       <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">mouseMoveEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s4">&quot;motion_notify_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                   <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">event</span><span class="s2">),</span>
                   <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(),</span>
                   <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">mouseReleaseEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">button </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">buttond</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">button</span><span class="s2">())</span>
        <span class="s0">if </span><span class="s1">button </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s4">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                       <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">event</span><span class="s2">), </span><span class="s1">button</span><span class="s2">,</span>
                       <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(),</span>
                       <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">wheelEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s3"># from QWheelEvent::pixelDelta doc: pixelDelta is sometimes not</span>
        <span class="s3"># provided (`isNull()`) and is unreliable on X11 (&quot;xcb&quot;).</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">pixelDelta</span><span class="s2">().</span><span class="s1">isNull</span><span class="s2">()</span>
                <span class="s0">or </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">().</span><span class="s1">platformName</span><span class="s2">() == </span><span class="s4">&quot;xcb&quot;</span><span class="s2">):</span>
            <span class="s1">steps </span><span class="s2">= </span><span class="s1">event</span><span class="s2">.</span><span class="s1">angleDelta</span><span class="s2">().</span><span class="s1">y</span><span class="s2">() / </span><span class="s5">120</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">steps </span><span class="s2">= </span><span class="s1">event</span><span class="s2">.</span><span class="s1">pixelDelta</span><span class="s2">().</span><span class="s1">y</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">steps </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s4">&quot;scroll_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                       <span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(</span><span class="s1">event</span><span class="s2">), </span><span class="s1">step</span><span class="s2">=</span><span class="s1">steps</span><span class="s2">,</span>
                       <span class="s1">modifiers</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(),</span>
                       <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">keyPressEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_key</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s4">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                     <span class="s1">key</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(),</span>
                     <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">keyReleaseEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">key </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_key</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">is not None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s4">&quot;key_release_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">,</span>
                     <span class="s1">key</span><span class="s2">, *</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mouseEventCoords</span><span class="s2">(),</span>
                     <span class="s1">guiEvent</span><span class="s2">=</span><span class="s1">event</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">resizeEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_in_resize_event</span><span class="s2">:  </span><span class="s3"># Prevent PyQt6 recursion</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_in_resize_event </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s1">event</span><span class="s2">.</span><span class="s1">size</span><span class="s2">().</span><span class="s1">width</span><span class="s2">() * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span>
            <span class="s1">h </span><span class="s2">= </span><span class="s1">event</span><span class="s2">.</span><span class="s1">size</span><span class="s2">().</span><span class="s1">height</span><span class="s2">() * </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span>
            <span class="s1">dpival </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">dpi</span>
            <span class="s1">winch </span><span class="s2">= </span><span class="s1">w </span><span class="s2">/ </span><span class="s1">dpival</span>
            <span class="s1">hinch </span><span class="s2">= </span><span class="s1">h </span><span class="s2">/ </span><span class="s1">dpival</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">set_size_inches</span><span class="s2">(</span><span class="s1">winch</span><span class="s2">, </span><span class="s1">hinch</span><span class="s2">, </span><span class="s1">forward</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s3"># pass back into Qt to let it finish</span>
            <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QWidget</span><span class="s2">.</span><span class="s1">resizeEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">)</span>
            <span class="s3"># emit our resize events</span>
            <span class="s1">ResizeEvent</span><span class="s2">(</span><span class="s4">&quot;resize_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">draw_idle</span><span class="s2">()</span>
        <span class="s0">finally</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_in_resize_event </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">sizeHint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">get_width_height</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QSize</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">minumumSizeHint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QSize</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">_mpl_modifiers</span><span class="s2">(</span><span class="s1">modifiers</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, *, </span><span class="s1">exclude</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">modifiers </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">modifiers </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">().</span><span class="s1">keyboardModifiers</span><span class="s2">()</span>
        <span class="s1">modifiers </span><span class="s2">= </span><span class="s1">_to_int</span><span class="s2">(</span><span class="s1">modifiers</span><span class="s2">)</span>
        <span class="s3"># get names of the pressed modifier keys</span>
        <span class="s3"># 'control' is named 'control' when a standalone key, but 'ctrl' when a</span>
        <span class="s3"># modifier</span>
        <span class="s3"># bit twiddling to pick out modifier keys from modifiers bitmask,</span>
        <span class="s3"># if exclude is a MODIFIER, it should not be duplicated in mods</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">SPECIAL_KEYS</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">'control'</span><span class="s2">, </span><span class="s4">'ctrl'</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">mask</span><span class="s2">, </span><span class="s1">key </span><span class="s0">in </span><span class="s1">_MODIFIER_KEYS</span>
                <span class="s0">if </span><span class="s1">exclude </span><span class="s2">!= </span><span class="s1">key </span><span class="s0">and </span><span class="s1">modifiers </span><span class="s2">&amp; </span><span class="s1">mask</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">_get_key</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">event_key </span><span class="s2">= </span><span class="s1">event</span><span class="s2">.</span><span class="s1">key</span><span class="s2">()</span>
        <span class="s1">mods </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_mpl_modifiers</span><span class="s2">(</span><span class="s1">exclude</span><span class="s2">=</span><span class="s1">event_key</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s3"># for certain keys (enter, left, backspace, etc) use a word for the</span>
            <span class="s3"># key, rather than Unicode</span>
            <span class="s1">key </span><span class="s2">= </span><span class="s1">SPECIAL_KEYS</span><span class="s2">[</span><span class="s1">event_key</span><span class="s2">]</span>
        <span class="s0">except </span><span class="s1">KeyError</span><span class="s2">:</span>
            <span class="s3"># Unicode defines code points up to 0x10ffff (sys.maxunicode)</span>
            <span class="s3"># QT will use Key_Codes larger than that for keyboard keys that are</span>
            <span class="s3"># not Unicode characters (like multimedia keys)</span>
            <span class="s3"># skip these</span>
            <span class="s3"># if you really want them, you should add them to SPECIAL_KEYS</span>
            <span class="s0">if </span><span class="s1">event_key </span><span class="s2">&gt; </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">maxunicode</span><span class="s2">:</span>
                <span class="s0">return None</span>

            <span class="s1">key </span><span class="s2">= </span><span class="s1">chr</span><span class="s2">(</span><span class="s1">event_key</span><span class="s2">)</span>
            <span class="s3"># qt delivers capitalized letters.  fix capitalization</span>
            <span class="s3"># note that capslock is ignored</span>
            <span class="s0">if </span><span class="s4">'shift' </span><span class="s0">in </span><span class="s1">mods</span><span class="s2">:</span>
                <span class="s1">mods</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s4">'shift'</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">key </span><span class="s2">= </span><span class="s1">key</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>

        <span class="s0">return </span><span class="s4">'+'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">mods </span><span class="s2">+ [</span><span class="s1">key</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">flush_events</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># docstring inherited</span>
        <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">().</span><span class="s1">processEvents</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">start_event_loop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">timeout</span><span class="s2">=</span><span class="s5">0</span><span class="s2">):</span>
        <span class="s3"># docstring inherited</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_event_loop&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_event_loop</span><span class="s2">.</span><span class="s1">isRunning</span><span class="s2">():</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;Event loop already running&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_event_loop </span><span class="s2">= </span><span class="s1">event_loop </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QEventLoop</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">timeout </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">:</span>
            <span class="s1">_ </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QTimer</span><span class="s2">.</span><span class="s1">singleShot</span><span class="s2">(</span><span class="s1">int</span><span class="s2">(</span><span class="s1">timeout </span><span class="s2">* </span><span class="s5">1000</span><span class="s2">), </span><span class="s1">event_loop</span><span class="s2">.</span><span class="s1">quit</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">_allow_interrupt_qt</span><span class="s2">(</span><span class="s1">event_loop</span><span class="s2">):</span>
            <span class="s1">qt_compat</span><span class="s2">.</span><span class="s1">_exec</span><span class="s2">(</span><span class="s1">event_loop</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">stop_event_loop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s3"># docstring inherited</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_event_loop&quot;</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_event_loop</span><span class="s2">.</span><span class="s1">quit</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">draw</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Render the figure, and queue a request for a Qt draw.&quot;&quot;&quot;</span>
        <span class="s3"># The renderer draw is done here; delaying causes problems with code</span>
        <span class="s3"># that uses the result of the draw() to update plot elements.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_drawing</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">with </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_setattr_cm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">_is_drawing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">super</span><span class="s2">().</span><span class="s1">draw</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">draw_idle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Queue redraw of the Agg buffer and request Qt paintEvent.&quot;&quot;&quot;</span>
        <span class="s3"># The Agg draw needs to be handled by the same thread Matplotlib</span>
        <span class="s3"># modifies the scene graph from. Post Agg draw request to the</span>
        <span class="s3"># current event loop in order to ensure thread affinity and to</span>
        <span class="s3"># accumulate multiple draw requests from event handling.</span>
        <span class="s3"># TODO: queued signal connection might be safer than singleShot</span>
        <span class="s0">if not </span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'_draw_pending'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">'_is_drawing'</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_pending </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s1">QtCore</span><span class="s2">.</span><span class="s1">QTimer</span><span class="s2">.</span><span class="s1">singleShot</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_idle</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">blit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bbox</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s3"># docstring inherited</span>
        <span class="s0">if </span><span class="s1">bbox </span><span class="s0">is None and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">:</span>
            <span class="s1">bbox </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">bbox  </span><span class="s3"># Blit the entire canvas if bbox is None.</span>
        <span class="s3"># repaint uses logical pixels, not physical pixels like the renderer.</span>
        <span class="s1">l</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">pt </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span><span class="s2">) </span><span class="s0">for </span><span class="s1">pt </span><span class="s0">in </span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">bounds</span><span class="s2">]</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">b </span><span class="s2">+ </span><span class="s1">h</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">repaint</span><span class="s2">(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">rect</span><span class="s2">().</span><span class="s1">height</span><span class="s2">() - </span><span class="s1">t</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_draw_idle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_idle_draw_cntx</span><span class="s2">():</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_pending</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_pending </span><span class="s2">= </span><span class="s0">False</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">height</span><span class="s2">() &lt;= </span><span class="s5">0 </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">width</span><span class="s2">() &lt;= </span><span class="s5">0</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
            <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
                <span class="s3"># Uncaught exceptions are fatal for PyQt5, so catch them.</span>
                <span class="s1">traceback</span><span class="s2">.</span><span class="s1">print_exc</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">drawRectangle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">rect</span><span class="s2">):</span>
        <span class="s3"># Draw the zoom rectangle to the QPainter.  _draw_rect_callback needs</span>
        <span class="s3"># to be called at the end of paintEvent.</span>
        <span class="s0">if </span><span class="s1">rect </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">h </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">pt </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span><span class="s2">) </span><span class="s0">for </span><span class="s1">pt </span><span class="s0">in </span><span class="s1">rect</span><span class="s2">]</span>
            <span class="s1">x1 </span><span class="s2">= </span><span class="s1">x0 </span><span class="s2">+ </span><span class="s1">w</span>
            <span class="s1">y1 </span><span class="s2">= </span><span class="s1">y0 </span><span class="s2">+ </span><span class="s1">h</span>
            <span class="s0">def </span><span class="s1">_draw_rect_callback</span><span class="s2">(</span><span class="s1">painter</span><span class="s2">):</span>
                <span class="s1">pen </span><span class="s2">= </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QPen</span><span class="s2">(</span>
                    <span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QColor</span><span class="s2">(</span><span class="s4">&quot;black&quot;</span><span class="s2">),</span>
                    <span class="s5">1 </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span>
                <span class="s2">)</span>

                <span class="s1">pen</span><span class="s2">.</span><span class="s1">setDashPattern</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">])</span>
                <span class="s0">for </span><span class="s1">color</span><span class="s2">, </span><span class="s1">offset </span><span class="s0">in </span><span class="s2">[</span>
                        <span class="s2">(</span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QColor</span><span class="s2">(</span><span class="s4">&quot;black&quot;</span><span class="s2">), </span><span class="s5">0</span><span class="s2">),</span>
                        <span class="s2">(</span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QColor</span><span class="s2">(</span><span class="s4">&quot;white&quot;</span><span class="s2">), </span><span class="s5">3</span><span class="s2">),</span>
                <span class="s2">]:</span>
                    <span class="s1">pen</span><span class="s2">.</span><span class="s1">setDashOffset</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">)</span>
                    <span class="s1">pen</span><span class="s2">.</span><span class="s1">setColor</span><span class="s2">(</span><span class="s1">color</span><span class="s2">)</span>
                    <span class="s1">painter</span><span class="s2">.</span><span class="s1">setPen</span><span class="s2">(</span><span class="s1">pen</span><span class="s2">)</span>
                    <span class="s3"># Draw the lines from x0, y0 towards x1, y1 so that the</span>
                    <span class="s3"># dashes don't &quot;jump&quot; when moving the zoom box.</span>
                    <span class="s1">painter</span><span class="s2">.</span><span class="s1">drawLine</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
                    <span class="s1">painter</span><span class="s2">.</span><span class="s1">drawLine</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">)</span>
                    <span class="s1">painter</span><span class="s2">.</span><span class="s1">drawLine</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
                    <span class="s1">painter</span><span class="s2">.</span><span class="s1">drawLine</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">_draw_rect_callback</span><span class="s2">(</span><span class="s1">painter</span><span class="s2">):</span>
                <span class="s0">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_draw_rect_callback </span><span class="s2">= </span><span class="s1">_draw_rect_callback</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">update</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">MainWindow</span><span class="s2">(</span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QMainWindow</span><span class="s2">):</span>
    <span class="s1">closing </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Signal</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">closeEvent</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">closeEvent</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">FigureManagerQT</span><span class="s2">(</span><span class="s1">FigureManagerBase</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Attributes 
    ---------- 
    canvas : `FigureCanvas` 
        The FigureCanvas instance 
    num : int or str 
        The Figure number 
    toolbar : qt.QToolBar 
        The qt.QToolBar 
    window : qt.QMainWindow 
        The qt.QMainWindow 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">num</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window </span><span class="s2">= </span><span class="s1">MainWindow</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">num</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_widgetclosed</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">platform </span><span class="s2">!= </span><span class="s4">&quot;darwin&quot;</span><span class="s2">:</span>
            <span class="s1">image </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_get_data_path</span><span class="s2">(</span><span class="s4">'images/matplotlib.svg'</span><span class="s2">))</span>
            <span class="s1">icon </span><span class="s2">= </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QIcon</span><span class="s2">(</span><span class="s1">image</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">setWindowIcon</span><span class="s2">(</span><span class="s1">icon</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_destroying </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">addToolBar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">)</span>
            <span class="s1">tbs_height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">.</span><span class="s1">sizeHint</span><span class="s2">().</span><span class="s1">height</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">tbs_height </span><span class="s2">= </span><span class="s5">0</span>

        <span class="s3"># resize the main window so it will display the canvas with the</span>
        <span class="s3"># requested size:</span>
        <span class="s1">cs </span><span class="s2">= </span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">sizeHint</span><span class="s2">()</span>
        <span class="s1">cs_height </span><span class="s2">= </span><span class="s1">cs</span><span class="s2">.</span><span class="s1">height</span><span class="s2">()</span>
        <span class="s1">height </span><span class="s2">= </span><span class="s1">cs_height </span><span class="s2">+ </span><span class="s1">tbs_height</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">resize</span><span class="s2">(</span><span class="s1">cs</span><span class="s2">.</span><span class="s1">width</span><span class="s2">(), </span><span class="s1">height</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">setCentralWidget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">is_interactive</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw_idle</span><span class="s2">()</span>

        <span class="s3"># Give the keyboard focus to the figure instead of the manager:</span>
        <span class="s3"># StrongFocus accepts both tab and click to focus and will enable the</span>
        <span class="s3"># canvas to process event without clicking.</span>
        <span class="s3"># https://doc.qt.io/qt-5/qt.html#FocusPolicy-enum</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">setFocusPolicy</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">FocusPolicy</span><span class="s2">.</span><span class="s1">StrongFocus</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">setFocus</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">raise_</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">full_screen_toggle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">isFullScreen</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">showNormal</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">showFullScreen</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_widgetclosed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">CloseEvent</span><span class="s2">(</span><span class="s4">&quot;close_event&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_destroying</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_destroying </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">Gcf</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">pass</span>
            <span class="s3"># It seems that when the python session is killed,</span>
            <span class="s3"># Gcf can get destroyed before the Gcf.destroy</span>
            <span class="s3"># line is run, leading to a useless AttributeError.</span>

    <span class="s0">def </span><span class="s1">resize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">):</span>
        <span class="s3"># The Qt methods return sizes in 'virtual' pixels so we do need to</span>
        <span class="s3"># rescale from physical to logical pixels.</span>
        <span class="s1">width </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">width </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span><span class="s2">)</span>
        <span class="s1">height </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">height </span><span class="s2">/ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">device_pixel_ratio</span><span class="s2">)</span>
        <span class="s1">extra_width </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">width</span><span class="s2">() - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">width</span><span class="s2">()</span>
        <span class="s1">extra_height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">height</span><span class="s2">() - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">height</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">resize</span><span class="s2">(</span><span class="s1">width</span><span class="s2">, </span><span class="s1">height</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">resize</span><span class="s2">(</span><span class="s1">width </span><span class="s2">+ </span><span class="s1">extra_width</span><span class="s2">, </span><span class="s1">height </span><span class="s2">+ </span><span class="s1">extra_height</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">start_main_loop</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s1">qapp </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">qapp</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">_allow_interrupt_qt</span><span class="s2">(</span><span class="s1">qapp</span><span class="s2">):</span>
                <span class="s1">qt_compat</span><span class="s2">.</span><span class="s1">_exec</span><span class="s2">(</span><span class="s1">qapp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">show</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_destroying </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'figure.raise_window'</span><span class="s2">]:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">activateWindow</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">raise_</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">destroy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s3"># check for qApp first, as PySide deletes it in its atexit handler</span>
        <span class="s0">if </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">() </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_destroying</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">_destroying </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">toolbar</span><span class="s2">.</span><span class="s1">destroy</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">get_window_title</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">windowTitle</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">set_window_title</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">title</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">window</span><span class="s2">.</span><span class="s1">setWindowTitle</span><span class="s2">(</span><span class="s1">title</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">NavigationToolbar2QT</span><span class="s2">(</span><span class="s1">NavigationToolbar2</span><span class="s2">, </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QToolBar</span><span class="s2">):</span>
    <span class="s1">_message </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Signal</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)  </span><span class="s3"># Remove once deprecation below elapses.</span>
    <span class="s1">message </span><span class="s2">= </span><span class="s1">_api</span><span class="s2">.</span><span class="s1">deprecate_privatize_attribute</span><span class="s2">(</span><span class="s4">&quot;3.8&quot;</span><span class="s2">)</span>

    <span class="s1">toolitems </span><span class="s2">= [*</span><span class="s1">NavigationToolbar2</span><span class="s2">.</span><span class="s1">toolitems</span><span class="s2">]</span>
    <span class="s1">toolitems</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span>
        <span class="s3"># Add 'customize' action after 'subplots'</span>
        <span class="s2">[</span><span class="s1">name </span><span class="s0">for </span><span class="s1">name</span><span class="s2">, *</span><span class="s1">_ </span><span class="s0">in </span><span class="s1">toolitems</span><span class="s2">].</span><span class="s1">index</span><span class="s2">(</span><span class="s4">&quot;Subplots&quot;</span><span class="s2">) + </span><span class="s5">1</span><span class="s2">,</span>
        <span class="s2">(</span><span class="s4">&quot;Customize&quot;</span><span class="s2">, </span><span class="s4">&quot;Edit axis, curve and image parameters&quot;</span><span class="s2">,</span>
         <span class="s4">&quot;qt4_editor_options&quot;</span><span class="s2">, </span><span class="s4">&quot;edit_parameters&quot;</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">coordinates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;coordinates: should we show the coordinates on the right?&quot;&quot;&quot;</span>
        <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QToolBar</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setAllowedAreas</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">ToolBarArea</span><span class="s2">(</span>
            <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">ToolBarArea</span><span class="s2">.</span><span class="s1">TopToolBarArea</span><span class="s2">) |</span>
            <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">ToolBarArea</span><span class="s2">.</span><span class="s1">BottomToolBarArea</span><span class="s2">)))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">coordinates </span><span class="s2">= </span><span class="s1">coordinates</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_actions </span><span class="s2">= {}  </span><span class="s3"># mapping of toolitem method names to QActions.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">for </span><span class="s1">text</span><span class="s2">, </span><span class="s1">tooltip_text</span><span class="s2">, </span><span class="s1">image_file</span><span class="s2">, </span><span class="s1">callback </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">toolitems</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">text </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">addSeparator</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">slot </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">)</span>
                <span class="s3"># https://bugreports.qt.io/browse/PYSIDE-2512</span>
                <span class="s1">slot </span><span class="s2">= </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">slot</span><span class="s2">)(</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">slot</span><span class="s2">))</span>
                <span class="s1">slot </span><span class="s2">= </span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Slot</span><span class="s2">()(</span><span class="s1">slot</span><span class="s2">)</span>

                <span class="s1">a </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addAction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_icon</span><span class="s2">(</span><span class="s1">image_file </span><span class="s2">+ </span><span class="s4">'.png'</span><span class="s2">),</span>
                                   <span class="s1">text</span><span class="s2">, </span><span class="s1">slot</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">[</span><span class="s1">callback</span><span class="s2">] = </span><span class="s1">a</span>
                <span class="s0">if </span><span class="s1">callback </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'zoom'</span><span class="s2">, </span><span class="s4">'pan'</span><span class="s2">]:</span>
                    <span class="s1">a</span><span class="s2">.</span><span class="s1">setCheckable</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">tooltip_text </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">a</span><span class="s2">.</span><span class="s1">setToolTip</span><span class="s2">(</span><span class="s1">tooltip_text</span><span class="s2">)</span>

        <span class="s3"># Add the (x, y) location widget at the right side of the toolbar</span>
        <span class="s3"># The stretch factor is 1 which means any resizing of the toolbar</span>
        <span class="s3"># will resize this label instead of the buttons.</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">coordinates</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">locLabel </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QLabel</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">locLabel</span><span class="s2">.</span><span class="s1">setAlignment</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AlignmentFlag</span><span class="s2">(</span>
                <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AlignmentFlag</span><span class="s2">.</span><span class="s1">AlignRight</span><span class="s2">) |</span>
                <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AlignmentFlag</span><span class="s2">.</span><span class="s1">AlignVCenter</span><span class="s2">)))</span>

            <span class="s1">self</span><span class="s2">.</span><span class="s1">locLabel</span><span class="s2">.</span><span class="s1">setSizePolicy</span><span class="s2">(</span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QSizePolicy</span><span class="s2">(</span>
                <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QSizePolicy</span><span class="s2">.</span><span class="s1">Policy</span><span class="s2">.</span><span class="s1">Expanding</span><span class="s2">,</span>
                <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QSizePolicy</span><span class="s2">.</span><span class="s1">Policy</span><span class="s2">.</span><span class="s1">Ignored</span><span class="s2">,</span>
            <span class="s2">))</span>
            <span class="s1">labelAction </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addWidget</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">locLabel</span><span class="s2">)</span>
            <span class="s1">labelAction</span><span class="s2">.</span><span class="s1">setVisible</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">NavigationToolbar2</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">canvas</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_icon</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Construct a `.QIcon` from an image file *name*, including the extension 
        and relative to Matplotlib's &quot;images&quot; data directory. 
        &quot;&quot;&quot;</span>
        <span class="s3"># use a high-resolution icon with suffix '_large' if available</span>
        <span class="s3"># note: user-provided icons may not have '_large' versions</span>
        <span class="s1">path_regular </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_get_data_path</span><span class="s2">(</span><span class="s4">'images'</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">path_large </span><span class="s2">= </span><span class="s1">path_regular</span><span class="s2">.</span><span class="s1">with_name</span><span class="s2">(</span>
            <span class="s1">path_regular</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">'.png'</span><span class="s2">, </span><span class="s4">'_large.png'</span><span class="s2">))</span>
        <span class="s1">filename </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">path_large </span><span class="s0">if </span><span class="s1">path_large</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">() </span><span class="s0">else </span><span class="s1">path_regular</span><span class="s2">)</span>

        <span class="s1">pm </span><span class="s2">= </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QPixmap</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">)</span>
        <span class="s1">pm</span><span class="s2">.</span><span class="s1">setDevicePixelRatio</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">devicePixelRatioF</span><span class="s2">() </span><span class="s0">or </span><span class="s5">1</span><span class="s2">)  </span><span class="s3"># rarely, devicePixelRatioF=0</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">palette</span><span class="s2">().</span><span class="s1">color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">backgroundRole</span><span class="s2">()).</span><span class="s1">value</span><span class="s2">() &lt; </span><span class="s5">128</span><span class="s2">:</span>
            <span class="s1">icon_color </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">palette</span><span class="s2">().</span><span class="s1">color</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">foregroundRole</span><span class="s2">())</span>
            <span class="s1">mask </span><span class="s2">= </span><span class="s1">pm</span><span class="s2">.</span><span class="s1">createMaskFromColor</span><span class="s2">(</span>
                <span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QColor</span><span class="s2">(</span><span class="s4">'black'</span><span class="s2">),</span>
                <span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">MaskMode</span><span class="s2">.</span><span class="s1">MaskOutColor</span><span class="s2">)</span>
            <span class="s1">pm</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">(</span><span class="s1">icon_color</span><span class="s2">)</span>
            <span class="s1">pm</span><span class="s2">.</span><span class="s1">setMask</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QIcon</span><span class="s2">(</span><span class="s1">pm</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">edit_parameters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">axes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">get_axes</span><span class="s2">()</span>
        <span class="s0">if not </span><span class="s1">axes</span><span class="s2">:</span>
            <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QMessageBox</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">(), </span><span class="s4">&quot;Error&quot;</span><span class="s2">, </span><span class="s4">&quot;There are no Axes to edit.&quot;</span><span class="s2">)</span>
            <span class="s0">return</span>
        <span class="s0">elif </span><span class="s1">len</span><span class="s2">(</span><span class="s1">axes</span><span class="s2">) == </span><span class="s5">1</span><span class="s2">:</span>
            <span class="s1">ax</span><span class="s2">, = </span><span class="s1">axes</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">titles </span><span class="s2">= [</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">get_label</span><span class="s2">() </span><span class="s0">or</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">get_title</span><span class="s2">() </span><span class="s0">or</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">get_title</span><span class="s2">(</span><span class="s4">&quot;left&quot;</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">get_title</span><span class="s2">(</span><span class="s4">&quot;right&quot;</span><span class="s2">) </span><span class="s0">or</span>
                <span class="s4">&quot; - &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">filter</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, [</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlabel</span><span class="s2">(), </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylabel</span><span class="s2">()])) </span><span class="s0">or</span>
                <span class="s4">f&quot;&lt;anonymous </span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">).</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">&gt;&quot;</span>
                <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axes</span><span class="s2">]</span>
            <span class="s1">duplicate_titles </span><span class="s2">= [</span>
                <span class="s1">title </span><span class="s0">for </span><span class="s1">title </span><span class="s0">in </span><span class="s1">titles </span><span class="s0">if </span><span class="s1">titles</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s1">title</span><span class="s2">) &gt; </span><span class="s5">1</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axes</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">titles</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] </span><span class="s0">in </span><span class="s1">duplicate_titles</span><span class="s2">:</span>
                    <span class="s1">titles</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] += </span><span class="s4">f&quot; (id: </span><span class="s0">{</span><span class="s1">id</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span><span class="s0">:</span><span class="s4">#x</span><span class="s0">}</span><span class="s4">)&quot;  </span><span class="s3"># Deduplicate titles.</span>
            <span class="s1">item</span><span class="s2">, </span><span class="s1">ok </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QInputDialog</span><span class="s2">.</span><span class="s1">getItem</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">(),</span>
                <span class="s4">'Customize'</span><span class="s2">, </span><span class="s4">'Select Axes:'</span><span class="s2">, </span><span class="s1">titles</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">ok</span><span class="s2">:</span>
                <span class="s0">return</span>
            <span class="s1">ax </span><span class="s2">= </span><span class="s1">axes</span><span class="s2">[</span><span class="s1">titles</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)]</span>
        <span class="s1">figureoptions</span><span class="s2">.</span><span class="s1">figure_edit</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">self</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_update_buttons_checked</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># sync button checkstates to match active mode</span>
        <span class="s0">if </span><span class="s4">'pan' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">[</span><span class="s4">'pan'</span><span class="s2">].</span><span class="s1">setChecked</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mode</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">'PAN'</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s4">'zoom' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">[</span><span class="s4">'zoom'</span><span class="s2">].</span><span class="s1">setChecked</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">mode</span><span class="s2">.</span><span class="s1">name </span><span class="s2">== </span><span class="s4">'ZOOM'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">pan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">pan</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_buttons_checked</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">zoom</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">zoom</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_update_buttons_checked</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">set_message</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_message</span><span class="s2">.</span><span class="s1">emit</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">coordinates</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">locLabel</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">draw_rubberband</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">):</span>
        <span class="s1">height </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">bbox</span><span class="s2">.</span><span class="s1">height</span>
        <span class="s1">y1 </span><span class="s2">= </span><span class="s1">height </span><span class="s2">- </span><span class="s1">y1</span>
        <span class="s1">y0 </span><span class="s2">= </span><span class="s1">height </span><span class="s2">- </span><span class="s1">y0</span>
        <span class="s1">rect </span><span class="s2">= [</span><span class="s1">int</span><span class="s2">(</span><span class="s1">val</span><span class="s2">) </span><span class="s0">for </span><span class="s1">val </span><span class="s0">in </span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y1 </span><span class="s2">- </span><span class="s1">y0</span><span class="s2">)]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">drawRectangle</span><span class="s2">(</span><span class="s1">rect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove_rubberband</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">drawRectangle</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">configure_subplots</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog </span><span class="s2">= </span><span class="s1">SubplotToolQt</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">())</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span>
                <span class="s4">&quot;close_event&quot;</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">e</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog</span><span class="s2">.</span><span class="s1">reject</span><span class="s2">())</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog</span><span class="s2">.</span><span class="s1">update_from_current_subplotpars</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog</span><span class="s2">.</span><span class="s1">setModal</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog</span>

    <span class="s0">def </span><span class="s1">save_figure</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">filetypes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_supported_filetypes_grouped</span><span class="s2">()</span>
        <span class="s1">sorted_filetypes </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">filetypes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())</span>
        <span class="s1">default_filetype </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_default_filetype</span><span class="s2">()</span>

        <span class="s1">startpath </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">expanduser</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'savefig.directory'</span><span class="s2">])</span>
        <span class="s1">start </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">startpath</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_default_filename</span><span class="s2">())</span>
        <span class="s1">filters </span><span class="s2">= []</span>
        <span class="s1">selectedFilter </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">exts </span><span class="s0">in </span><span class="s1">sorted_filetypes</span><span class="s2">:</span>
            <span class="s1">exts_list </span><span class="s2">= </span><span class="s4">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s4">'*.%s' </span><span class="s2">% </span><span class="s1">ext </span><span class="s0">for </span><span class="s1">ext </span><span class="s0">in </span><span class="s1">exts</span><span class="s2">])</span>
            <span class="s1">filter </span><span class="s2">= </span><span class="s4">f'</span><span class="s0">{</span><span class="s1">name</span><span class="s0">} </span><span class="s4">(</span><span class="s0">{</span><span class="s1">exts_list</span><span class="s0">}</span><span class="s4">)'</span>
            <span class="s0">if </span><span class="s1">default_filetype </span><span class="s0">in </span><span class="s1">exts</span><span class="s2">:</span>
                <span class="s1">selectedFilter </span><span class="s2">= </span><span class="s1">filter</span>
            <span class="s1">filters</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">filter</span><span class="s2">)</span>
        <span class="s1">filters </span><span class="s2">= </span><span class="s4">';;'</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">filters</span><span class="s2">)</span>

        <span class="s1">fname</span><span class="s2">, </span><span class="s1">filter </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QFileDialog</span><span class="s2">.</span><span class="s1">getSaveFileName</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">parent</span><span class="s2">(), </span><span class="s4">&quot;Choose a filename to save to&quot;</span><span class="s2">, </span><span class="s1">start</span><span class="s2">,</span>
            <span class="s1">filters</span><span class="s2">, </span><span class="s1">selectedFilter</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">fname</span><span class="s2">:</span>
            <span class="s3"># Save dir for next time, unless empty str (i.e., use cwd).</span>
            <span class="s0">if </span><span class="s1">startpath </span><span class="s2">!= </span><span class="s4">&quot;&quot;</span><span class="s2">:</span>
                <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'savefig.directory'</span><span class="s2">] = </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">Exception </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
                <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QMessageBox</span><span class="s2">.</span><span class="s1">critical</span><span class="s2">(</span>
                    <span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;Error saving file&quot;</span><span class="s2">, </span><span class="s1">str</span><span class="s2">(</span><span class="s1">e</span><span class="s2">),</span>
                    <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QMessageBox</span><span class="s2">.</span><span class="s1">StandardButton</span><span class="s2">.</span><span class="s1">Ok</span><span class="s2">,</span>
                    <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QMessageBox</span><span class="s2">.</span><span class="s1">StandardButton</span><span class="s2">.</span><span class="s1">NoButton</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">set_history_buttons</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">can_backward </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nav_stack</span><span class="s2">.</span><span class="s1">_pos </span><span class="s2">&gt; </span><span class="s5">0</span>
        <span class="s1">can_forward </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nav_stack</span><span class="s2">.</span><span class="s1">_pos </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_nav_stack</span><span class="s2">) - </span><span class="s5">1</span>
        <span class="s0">if </span><span class="s4">'back' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">[</span><span class="s4">'back'</span><span class="s2">].</span><span class="s1">setEnabled</span><span class="s2">(</span><span class="s1">can_backward</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s4">'forward' </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_actions</span><span class="s2">[</span><span class="s4">'forward'</span><span class="s2">].</span><span class="s1">setEnabled</span><span class="s2">(</span><span class="s1">can_forward</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SubplotToolQt</span><span class="s2">(</span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QDialog</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">targetfig</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setWindowIcon</span><span class="s2">(</span><span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QIcon</span><span class="s2">(</span>
            <span class="s1">str</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_get_data_path</span><span class="s2">(</span><span class="s4">&quot;images/matplotlib.png&quot;</span><span class="s2">))))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setObjectName</span><span class="s2">(</span><span class="s4">&quot;SubplotTool&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_spinboxes </span><span class="s2">= {}</span>
        <span class="s1">main_layout </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QHBoxLayout</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setLayout</span><span class="s2">(</span><span class="s1">main_layout</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">group</span><span class="s2">, </span><span class="s1">spinboxes</span><span class="s2">, </span><span class="s1">buttons </span><span class="s0">in </span><span class="s2">[</span>
                <span class="s2">(</span><span class="s4">&quot;Borders&quot;</span><span class="s2">,</span>
                 <span class="s2">[</span><span class="s4">&quot;top&quot;</span><span class="s2">, </span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;left&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s2">],</span>
                 <span class="s2">[(</span><span class="s4">&quot;Export values&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_export_values</span><span class="s2">)]),</span>
                <span class="s2">(</span><span class="s4">&quot;Spacings&quot;</span><span class="s2">,</span>
                 <span class="s2">[</span><span class="s4">&quot;hspace&quot;</span><span class="s2">, </span><span class="s4">&quot;wspace&quot;</span><span class="s2">],</span>
                 <span class="s2">[(</span><span class="s4">&quot;Tight layout&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_tight_layout</span><span class="s2">),</span>
                  <span class="s2">(</span><span class="s4">&quot;Reset&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_reset</span><span class="s2">),</span>
                  <span class="s2">(</span><span class="s4">&quot;Close&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">)])]:</span>
            <span class="s1">layout </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QVBoxLayout</span><span class="s2">()</span>
            <span class="s1">main_layout</span><span class="s2">.</span><span class="s1">addLayout</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">)</span>
            <span class="s1">box </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QGroupBox</span><span class="s2">(</span><span class="s1">group</span><span class="s2">)</span>
            <span class="s1">layout</span><span class="s2">.</span><span class="s1">addWidget</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s1">inner </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QFormLayout</span><span class="s2">(</span><span class="s1">box</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">spinboxes</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_spinboxes</span><span class="s2">[</span><span class="s1">name</span><span class="s2">] = </span><span class="s1">spinbox </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QDoubleSpinBox</span><span class="s2">()</span>
                <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setRange</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
                <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setDecimals</span><span class="s2">(</span><span class="s5">3</span><span class="s2">)</span>
                <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setSingleStep</span><span class="s2">(</span><span class="s5">0.005</span><span class="s2">)</span>
                <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setKeyboardTracking</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">valueChanged</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_on_value_changed</span><span class="s2">)</span>
                <span class="s1">inner</span><span class="s2">.</span><span class="s1">addRow</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">spinbox</span><span class="s2">)</span>
            <span class="s1">layout</span><span class="s2">.</span><span class="s1">addStretch</span><span class="s2">(</span><span class="s5">1</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">method </span><span class="s0">in </span><span class="s1">buttons</span><span class="s2">:</span>
                <span class="s1">button </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QPushButton</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
                <span class="s3"># Don't trigger on &lt;enter&gt;, which is used to input values.</span>
                <span class="s1">button</span><span class="s2">.</span><span class="s1">setAutoDefault</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">button</span><span class="s2">.</span><span class="s1">clicked</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">method</span><span class="s2">)</span>
                <span class="s1">layout</span><span class="s2">.</span><span class="s1">addWidget</span><span class="s2">(</span><span class="s1">button</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s4">&quot;Close&quot;</span><span class="s2">:</span>
                    <span class="s1">button</span><span class="s2">.</span><span class="s1">setFocus</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_figure </span><span class="s2">= </span><span class="s1">targetfig</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_defaults </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_export_values_dialog </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">update_from_current_subplotpars</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">update_from_current_subplotpars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_defaults </span><span class="s2">= {</span><span class="s1">spinbox</span><span class="s2">: </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_figure</span><span class="s2">.</span><span class="s1">subplotpars</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>
                          <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_spinboxes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_reset</span><span class="s2">()  </span><span class="s3"># Set spinbox current values without triggering signals.</span>

    <span class="s0">def </span><span class="s1">_export_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Explicitly round to 3 decimals (which is also the spinbox precision)</span>
        <span class="s3"># to avoid numbers of the form 0.100...001.</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_export_values_dialog </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QDialog</span><span class="s2">()</span>
        <span class="s1">layout </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QVBoxLayout</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_export_values_dialog</span><span class="s2">.</span><span class="s1">setLayout</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">)</span>
        <span class="s1">text </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QPlainTextEdit</span><span class="s2">()</span>
        <span class="s1">text</span><span class="s2">.</span><span class="s1">setReadOnly</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">layout</span><span class="s2">.</span><span class="s1">addWidget</span><span class="s2">(</span><span class="s1">text</span><span class="s2">)</span>
        <span class="s1">text</span><span class="s2">.</span><span class="s1">setPlainText</span><span class="s2">(</span>
            <span class="s4">&quot;,</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">attr</span><span class="s0">}</span><span class="s4">=</span><span class="s0">{</span><span class="s1">spinbox</span><span class="s2">.</span><span class="s1">value</span><span class="s2">()</span><span class="s0">:</span><span class="s4">.3</span><span class="s0">}</span><span class="s4">&quot;</span>
                       <span class="s0">for </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_spinboxes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()))</span>
        <span class="s3"># Adjust the height of the text widget to fit the whole text, plus</span>
        <span class="s3"># some padding.</span>
        <span class="s1">size </span><span class="s2">= </span><span class="s1">text</span><span class="s2">.</span><span class="s1">maximumSize</span><span class="s2">()</span>
        <span class="s1">size</span><span class="s2">.</span><span class="s1">setHeight</span><span class="s2">(</span>
            <span class="s1">QtGui</span><span class="s2">.</span><span class="s1">QFontMetrics</span><span class="s2">(</span><span class="s1">text</span><span class="s2">.</span><span class="s1">document</span><span class="s2">().</span><span class="s1">defaultFont</span><span class="s2">())</span>
            <span class="s2">.</span><span class="s1">size</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">text</span><span class="s2">.</span><span class="s1">toPlainText</span><span class="s2">()).</span><span class="s1">height</span><span class="s2">() + </span><span class="s5">20</span><span class="s2">)</span>
        <span class="s1">text</span><span class="s2">.</span><span class="s1">setMaximumSize</span><span class="s2">(</span><span class="s1">size</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_export_values_dialog</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_on_value_changed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">spinboxes </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_spinboxes</span>
        <span class="s3"># Set all mins and maxes, so that this can also be used in _reset().</span>
        <span class="s0">for </span><span class="s1">lower</span><span class="s2">, </span><span class="s1">higher </span><span class="s0">in </span><span class="s2">[(</span><span class="s4">&quot;bottom&quot;</span><span class="s2">, </span><span class="s4">&quot;top&quot;</span><span class="s2">), (</span><span class="s4">&quot;left&quot;</span><span class="s2">, </span><span class="s4">&quot;right&quot;</span><span class="s2">)]:</span>
            <span class="s1">spinboxes</span><span class="s2">[</span><span class="s1">higher</span><span class="s2">].</span><span class="s1">setMinimum</span><span class="s2">(</span><span class="s1">spinboxes</span><span class="s2">[</span><span class="s1">lower</span><span class="s2">].</span><span class="s1">value</span><span class="s2">() + </span><span class="s5">.001</span><span class="s2">)</span>
            <span class="s1">spinboxes</span><span class="s2">[</span><span class="s1">lower</span><span class="s2">].</span><span class="s1">setMaximum</span><span class="s2">(</span><span class="s1">spinboxes</span><span class="s2">[</span><span class="s1">higher</span><span class="s2">].</span><span class="s1">value</span><span class="s2">() - </span><span class="s5">.001</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_figure</span><span class="s2">.</span><span class="s1">subplots_adjust</span><span class="s2">(</span>
            <span class="s2">**{</span><span class="s1">attr</span><span class="s2">: </span><span class="s1">spinbox</span><span class="s2">.</span><span class="s1">value</span><span class="s2">() </span><span class="s0">for </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">spinboxes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()})</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_figure</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw_idle</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_tight_layout</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_figure</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">attr</span><span class="s2">, </span><span class="s1">spinbox </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_spinboxes</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">blockSignals</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setValue</span><span class="s2">(</span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_figure</span><span class="s2">.</span><span class="s1">subplotpars</span><span class="s2">, </span><span class="s1">attr</span><span class="s2">))</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">blockSignals</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_figure</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw_idle</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">_reset</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">spinbox</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_defaults</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setRange</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">blockSignals</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">setValue</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">spinbox</span><span class="s2">.</span><span class="s1">blockSignals</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_on_value_changed</span><span class="s2">()</span>


<span class="s0">class </span><span class="s1">ToolbarQt</span><span class="s2">(</span><span class="s1">ToolContainerBase</span><span class="s2">, </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QToolBar</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">toolmanager</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">ToolContainerBase</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">toolmanager</span><span class="s2">)</span>
        <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QToolBar</span><span class="s2">.</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parent</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">setAllowedAreas</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">ToolBarArea</span><span class="s2">(</span>
            <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">ToolBarArea</span><span class="s2">.</span><span class="s1">TopToolBarArea</span><span class="s2">) |</span>
            <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">ToolBarArea</span><span class="s2">.</span><span class="s1">BottomToolBarArea</span><span class="s2">)))</span>
        <span class="s1">message_label </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QLabel</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">)</span>
        <span class="s1">message_label</span><span class="s2">.</span><span class="s1">setAlignment</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AlignmentFlag</span><span class="s2">(</span>
            <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AlignmentFlag</span><span class="s2">.</span><span class="s1">AlignRight</span><span class="s2">) |</span>
            <span class="s1">_to_int</span><span class="s2">(</span><span class="s1">QtCore</span><span class="s2">.</span><span class="s1">Qt</span><span class="s2">.</span><span class="s1">AlignmentFlag</span><span class="s2">.</span><span class="s1">AlignVCenter</span><span class="s2">)))</span>
        <span class="s1">message_label</span><span class="s2">.</span><span class="s1">setSizePolicy</span><span class="s2">(</span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QSizePolicy</span><span class="s2">(</span>
            <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QSizePolicy</span><span class="s2">.</span><span class="s1">Policy</span><span class="s2">.</span><span class="s1">Expanding</span><span class="s2">,</span>
            <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QSizePolicy</span><span class="s2">.</span><span class="s1">Policy</span><span class="s2">.</span><span class="s1">Ignored</span><span class="s2">,</span>
        <span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_message_action </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">addWidget</span><span class="s2">(</span><span class="s1">message_label</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_toolitems </span><span class="s2">= {}</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_groups </span><span class="s2">= {}</span>

    <span class="s0">def </span><span class="s1">add_toolitem</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">group</span><span class="s2">, </span><span class="s1">position</span><span class="s2">, </span><span class="s1">image_file</span><span class="s2">, </span><span class="s1">description</span><span class="s2">, </span><span class="s1">toggle</span><span class="s2">):</span>

        <span class="s1">button </span><span class="s2">= </span><span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QToolButton</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">image_file</span><span class="s2">:</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">setIcon</span><span class="s2">(</span><span class="s1">NavigationToolbar2QT</span><span class="s2">.</span><span class="s1">_icon</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">image_file</span><span class="s2">))</span>
        <span class="s1">button</span><span class="s2">.</span><span class="s1">setText</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">description</span><span class="s2">:</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">setToolTip</span><span class="s2">(</span><span class="s1">description</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">handler</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">trigger_tool</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">toggle</span><span class="s2">:</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">setCheckable</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">toggled</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">clicked</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">_toolitems</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, [])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_add_to_group</span><span class="s2">(</span><span class="s1">group</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">button</span><span class="s2">, </span><span class="s1">position</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_toolitems</span><span class="s2">[</span><span class="s1">name</span><span class="s2">].</span><span class="s1">append</span><span class="s2">((</span><span class="s1">button</span><span class="s2">, </span><span class="s1">handler</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">_add_to_group</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">group</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">button</span><span class="s2">, </span><span class="s1">position</span><span class="s2">):</span>
        <span class="s1">gr </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_groups</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">group</span><span class="s2">, [])</span>
        <span class="s0">if not </span><span class="s1">gr</span><span class="s2">:</span>
            <span class="s1">sep </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">insertSeparator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_message_action</span><span class="s2">)</span>
            <span class="s1">gr</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">sep</span><span class="s2">)</span>
        <span class="s1">before </span><span class="s2">= </span><span class="s1">gr</span><span class="s2">[</span><span class="s1">position</span><span class="s2">]</span>
        <span class="s1">widget </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">insertWidget</span><span class="s2">(</span><span class="s1">before</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>
        <span class="s1">gr</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">position</span><span class="s2">, </span><span class="s1">widget</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_groups</span><span class="s2">[</span><span class="s1">group</span><span class="s2">] = </span><span class="s1">gr</span>

    <span class="s0">def </span><span class="s1">toggle_toolitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">toggled</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_toolitems</span><span class="s2">:</span>
            <span class="s0">return</span>
        <span class="s0">for </span><span class="s1">button</span><span class="s2">, </span><span class="s1">handler </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_toolitems</span><span class="s2">[</span><span class="s1">name</span><span class="s2">]:</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">toggled</span><span class="s2">.</span><span class="s1">disconnect</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">)</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">setChecked</span><span class="s2">(</span><span class="s1">toggled</span><span class="s2">)</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">toggled</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove_toolitem</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">button</span><span class="s2">, </span><span class="s1">handler </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_toolitems</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, []):</span>
            <span class="s1">button</span><span class="s2">.</span><span class="s1">setParent</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">set_message</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">widgetForAction</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_message_action</span><span class="s2">).</span><span class="s1">setText</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">_register_tool_class</span><span class="s2">(</span><span class="s1">FigureCanvasQT</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">ConfigureSubplotsQt</span><span class="s2">(</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">ConfigureSubplotsBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_subplot_dialog </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">NavigationToolbar2QT</span><span class="s2">.</span><span class="s1">configure_subplots</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">_register_tool_class</span><span class="s2">(</span><span class="s1">FigureCanvasQT</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">SaveFigureQt</span><span class="s2">(</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">SaveFigureBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">NavigationToolbar2QT</span><span class="s2">.</span><span class="s1">save_figure</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_make_classic_style_pseudo_toolbar</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">_register_tool_class</span><span class="s2">(</span><span class="s1">FigureCanvasQT</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">RubberbandQt</span><span class="s2">(</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">RubberbandBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">draw_rubberband</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">):</span>
        <span class="s1">NavigationToolbar2QT</span><span class="s2">.</span><span class="s1">draw_rubberband</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_make_classic_style_pseudo_toolbar</span><span class="s2">(), </span><span class="s0">None</span><span class="s2">, </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">y0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">remove_rubberband</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">NavigationToolbar2QT</span><span class="s2">.</span><span class="s1">remove_rubberband</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_make_classic_style_pseudo_toolbar</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">_register_tool_class</span><span class="s2">(</span><span class="s1">FigureCanvasQT</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">HelpQt</span><span class="s2">(</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">ToolHelpBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QMessageBox</span><span class="s2">.</span><span class="s1">information</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s4">&quot;Help&quot;</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_help_html</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">_register_tool_class</span><span class="s2">(</span><span class="s1">FigureCanvasQT</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">ToolCopyToClipboardQT</span><span class="s2">(</span><span class="s1">backend_tools</span><span class="s2">.</span><span class="s1">ToolCopyToClipboardBase</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">trigger</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
        <span class="s1">pixmap </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">grab</span><span class="s2">()</span>
        <span class="s1">QtWidgets</span><span class="s2">.</span><span class="s1">QApplication</span><span class="s2">.</span><span class="s1">instance</span><span class="s2">().</span><span class="s1">clipboard</span><span class="s2">().</span><span class="s1">setPixmap</span><span class="s2">(</span><span class="s1">pixmap</span><span class="s2">)</span>


<span class="s1">FigureManagerQT</span><span class="s2">.</span><span class="s1">_toolbar2_class </span><span class="s2">= </span><span class="s1">NavigationToolbar2QT</span>
<span class="s1">FigureManagerQT</span><span class="s2">.</span><span class="s1">_toolmanager_toolbar_class </span><span class="s2">= </span><span class="s1">ToolbarQt</span>


<span class="s2">@</span><span class="s1">_Backend</span><span class="s2">.</span><span class="s1">export</span>
<span class="s0">class </span><span class="s1">_BackendQT</span><span class="s2">(</span><span class="s1">_Backend</span><span class="s2">):</span>
    <span class="s1">backend_version </span><span class="s2">= </span><span class="s1">__version__</span>
    <span class="s1">FigureCanvas </span><span class="s2">= </span><span class="s1">FigureCanvasQT</span>
    <span class="s1">FigureManager </span><span class="s2">= </span><span class="s1">FigureManagerQT</span>
    <span class="s1">mainloop </span><span class="s2">= </span><span class="s1">FigureManagerQT</span><span class="s2">.</span><span class="s1">start_main_loop</span>
</pre>
</body>
</html>