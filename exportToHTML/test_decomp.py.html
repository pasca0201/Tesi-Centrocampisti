<html>
<head>
<title>test_decomp.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_decomp.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">platform</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_almost_equal</span><span class="s2">,</span>
                           <span class="s1">assert_array_almost_equal</span><span class="s2">, </span><span class="s1">assert_array_equal</span><span class="s2">,</span>
                           <span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">)</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">import </span><span class="s2">(</span><span class="s1">eig</span><span class="s2">, </span><span class="s1">eigvals</span><span class="s2">, </span><span class="s1">lu</span><span class="s2">, </span><span class="s1">svd</span><span class="s2">, </span><span class="s1">svdvals</span><span class="s2">, </span><span class="s1">cholesky</span><span class="s2">, </span><span class="s1">qr</span><span class="s2">,</span>
                          <span class="s1">schur</span><span class="s2">, </span><span class="s1">rsf2csf</span><span class="s2">, </span><span class="s1">lu_solve</span><span class="s2">, </span><span class="s1">lu_factor</span><span class="s2">, </span><span class="s1">solve</span><span class="s2">, </span><span class="s1">diagsvd</span><span class="s2">,</span>
                          <span class="s1">hessenberg</span><span class="s2">, </span><span class="s1">rq</span><span class="s2">, </span><span class="s1">eig_banded</span><span class="s2">, </span><span class="s1">eigvals_banded</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">,</span>
                          <span class="s1">eigvalsh</span><span class="s2">, </span><span class="s1">qr_multiply</span><span class="s2">, </span><span class="s1">qz</span><span class="s2">, </span><span class="s1">orth</span><span class="s2">, </span><span class="s1">ordqz</span><span class="s2">,</span>
                          <span class="s1">subspace_angles</span><span class="s2">, </span><span class="s1">hadamard</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">,</span>
                          <span class="s1">eigh_tridiagonal</span><span class="s2">, </span><span class="s1">null_space</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">LinAlgError</span><span class="s2">)</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">lapack </span><span class="s0">import </span><span class="s2">(</span><span class="s1">dgbtrf</span><span class="s2">, </span><span class="s1">dgbtrs</span><span class="s2">, </span><span class="s1">zgbtrf</span><span class="s2">, </span><span class="s1">zgbtrs</span><span class="s2">, </span><span class="s1">dsbev</span><span class="s2">,</span>
                                 <span class="s1">dsbevd</span><span class="s2">, </span><span class="s1">dsbevx</span><span class="s2">, </span><span class="s1">zhbevd</span><span class="s2">, </span><span class="s1">zhbevx</span><span class="s2">)</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">_misc </span><span class="s0">import </span><span class="s1">norm</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">_decomp_qz </span><span class="s0">import </span><span class="s1">_select_function</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">stats </span><span class="s0">import </span><span class="s1">ortho_group</span>

<span class="s0">from </span><span class="s1">numpy </span><span class="s0">import </span><span class="s2">(</span><span class="s1">array</span><span class="s2">, </span><span class="s1">diag</span><span class="s2">, </span><span class="s1">full</span><span class="s2">, </span><span class="s1">linalg</span><span class="s2">, </span><span class="s1">argsort</span><span class="s2">, </span><span class="s1">zeros</span><span class="s2">, </span><span class="s1">arange</span><span class="s2">,</span>
                   <span class="s1">float32</span><span class="s2">, </span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">ravel</span><span class="s2">, </span><span class="s1">sqrt</span><span class="s2">, </span><span class="s1">iscomplex</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">,</span>
                   <span class="s1">sign</span><span class="s2">, </span><span class="s1">asarray</span><span class="s2">, </span><span class="s1">isfinite</span><span class="s2">, </span><span class="s1">ndarray</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">,)</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">_testutils </span><span class="s0">import </span><span class="s1">assert_no_overwrite</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">_sputils </span><span class="s0">import </span><span class="s1">matrix</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_testutils </span><span class="s0">import </span><span class="s1">check_free_memory</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">blas </span><span class="s0">import </span><span class="s1">HAS_ILP64</span>
<span class="s0">try</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">__config__ </span><span class="s0">import </span><span class="s1">CONFIG</span>
<span class="s0">except </span><span class="s1">ImportError</span><span class="s2">:</span>
    <span class="s1">CONFIG </span><span class="s2">= </span><span class="s0">None</span>


<span class="s0">def </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">posdef</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">):</span>
    <span class="s3">&quot;Generate random sym/hermitian array of the given size n&quot;</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">COMPLEX_DTYPES</span><span class="s2">:</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)*</span><span class="s4">1.0j</span>
        <span class="s1">A </span><span class="s2">= (</span><span class="s1">A </span><span class="s2">+ </span><span class="s1">A</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">)/</span><span class="s4">2</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">A </span><span class="s2">= (</span><span class="s1">A </span><span class="s2">+ </span><span class="s1">A</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)/</span><span class="s4">2</span>

    <span class="s0">if </span><span class="s1">posdef</span><span class="s2">:</span>
        <span class="s1">A </span><span class="s2">+= </span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">*</span><span class="s1">n</span><span class="s2">)*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">A</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>


<span class="s1">REAL_DTYPES </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]</span>
<span class="s1">COMPLEX_DTYPES </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">]</span>
<span class="s1">DTYPES </span><span class="s2">= </span><span class="s1">REAL_DTYPES </span><span class="s2">+ </span><span class="s1">COMPLEX_DTYPES</span>


<span class="s5"># XXX: This function should not be defined here, but somewhere in</span>
<span class="s5">#      scipy.linalg namespace</span>
<span class="s0">def </span><span class="s1">symrand</span><span class="s2">(</span><span class="s1">dim_or_eigv</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot;Return a random symmetric (Hermitian) matrix. 
 
    If 'dim_or_eigv' is an integer N, return a NxN matrix, with eigenvalues 
        uniformly distributed on (-1,1). 
 
    If 'dim_or_eigv' is  1-D real array 'a', return a matrix whose 
                      eigenvalues are 'a'. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dim_or_eigv</span><span class="s2">, </span><span class="s1">int</span><span class="s2">):</span>
        <span class="s1">dim </span><span class="s2">= </span><span class="s1">dim_or_eigv</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">dim</span><span class="s2">)*</span><span class="s4">2 </span><span class="s2">- </span><span class="s4">1</span>
    <span class="s0">elif </span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">dim_or_eigv</span><span class="s2">, </span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and</span>
          <span class="s1">len</span><span class="s2">(</span><span class="s1">dim_or_eigv</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">) == </span><span class="s4">1</span><span class="s2">):</span>
        <span class="s1">dim </span><span class="s2">= </span><span class="s1">dim_or_eigv</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">dim_or_eigv</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">TypeError</span><span class="s2">(</span><span class="s6">&quot;input type not supported.&quot;</span><span class="s2">)</span>

    <span class="s1">v </span><span class="s2">= </span><span class="s1">ortho_group</span><span class="s2">.</span><span class="s1">rvs</span><span class="s2">(</span><span class="s1">dim</span><span class="s2">)</span>
    <span class="s1">h </span><span class="s2">= </span><span class="s1">v</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">() @ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">d</span><span class="s2">) @ </span><span class="s1">v</span>
    <span class="s5"># to avoid roundoff errors, symmetrize the matrix (again)</span>
    <span class="s1">h </span><span class="s2">= </span><span class="s4">0.5</span><span class="s2">*(</span><span class="s1">h</span><span class="s2">.</span><span class="s1">T</span><span class="s2">+</span><span class="s1">h</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">h</span>


<span class="s0">class </span><span class="s1">TestEigVals</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">exact_w </span><span class="s2">= [(</span><span class="s4">9</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, (</span><span class="s4">9</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">exact_w</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]], </span><span class="s6">'d'</span><span class="s2">).</span><span class="s1">T</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">T</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">exact_w </span><span class="s2">= [(</span><span class="s4">9</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, (</span><span class="s4">9</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">exact_w</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">+</span><span class="s4">1j</span><span class="s2">]]</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">exact_w </span><span class="s2">= [(</span><span class="s4">9</span><span class="s2">+</span><span class="s4">1j</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">92</span><span class="s2">+</span><span class="s4">6j</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">,</span>
                   <span class="s4">0</span><span class="s2">,</span>
                   <span class="s2">(</span><span class="s4">9</span><span class="s2">+</span><span class="s4">1j</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">92</span><span class="s2">+</span><span class="s4">6j</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">exact_w</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">exact_w </span><span class="s2">= [(</span><span class="s4">9</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, (</span><span class="s4">9</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">exact_w</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)).</span><span class="s1">dtype</span>

        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">homogeneous_eigvals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)).</span><span class="s1">dtype</span>


<span class="s0">class </span><span class="s1">TestEig</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">exact_w </span><span class="s2">= [(</span><span class="s4">9</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, (</span><span class="s4">9</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">v0 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">)/</span><span class="s4">3</span><span class="s2">)/</span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">v1 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">v2 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">)/</span><span class="s4">3</span><span class="s2">)/</span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">v0 </span><span class="s2">= </span><span class="s1">v0 </span><span class="s2">/ </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">v0</span><span class="s2">)</span>
        <span class="s1">v1 </span><span class="s2">= </span><span class="s1">v1 </span><span class="s2">/ </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">v1</span><span class="s2">)</span>
        <span class="s1">v2 </span><span class="s2">= </span><span class="s1">v2 </span><span class="s2">/ </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">v2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">exact_w</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">v0</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">]*</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">]*</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">v2</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">]*</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">v</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]*</span><span class="s1">v</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">left</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">right</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">v</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]*</span><span class="s1">v</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_eig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">vl</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">left</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">right</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">+</span><span class="s4">2j</span><span class="s2">, </span><span class="s4">1</span><span class="s2">-</span><span class="s4">2j</span><span class="s2">]))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">vr</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]*</span><span class="s1">vr</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vl</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">],</span>
                                      <span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">conj</span><span class="s2">()*</span><span class="s1">vl</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">+</span><span class="s4">1j</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">vl</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">left</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">right</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">vr</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]*</span><span class="s1">vr</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vl</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">],</span>
                                      <span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">conj</span><span class="s2">()*</span><span class="s1">vl</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_gh_3054</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">]]</span>
        <span class="s1">b </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">]]</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">homogeneous_eigvals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] != </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">w</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">atol_homog</span><span class="s2">=</span><span class="s4">1e-13</span><span class="s2">, </span><span class="s1">rtol_homog</span><span class="s2">=</span><span class="s4">1e-13</span><span class="s2">,</span>
                                   <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-13</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-13</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">B </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">A</span><span class="s2">, </span><span class="s1">B </span><span class="s2">= </span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">A</span><span class="s2">), </span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">B</span><span class="s2">)</span>
            <span class="s1">B0 </span><span class="s2">= </span><span class="s1">B</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">A </span><span class="s2">= </span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">A</span><span class="s2">)</span>
            <span class="s1">B0 </span><span class="s2">= </span><span class="s1">B</span>
            <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(*</span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s6">f&quot;</span><span class="s0">\n{</span><span class="s1">A</span><span class="s0">!r}\n{</span><span class="s1">B</span><span class="s0">!r}</span><span class="s6">&quot;</span>

        <span class="s5"># Eigenvalues in homogeneous coordinates</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B0</span><span class="s2">, </span><span class="s1">homogeneous_eigvals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">wt </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B0</span><span class="s2">, </span><span class="s1">homogeneous_eigvals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">val1 </span><span class="s2">= </span><span class="s1">A </span><span class="s2">@ </span><span class="s1">vr </span><span class="s2">* </span><span class="s1">w</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, :]</span>
        <span class="s1">val2 </span><span class="s2">= </span><span class="s1">B </span><span class="s2">@ </span><span class="s1">vr </span><span class="s2">* </span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, :]</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">val1</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">val1</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">val2</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">],</span>
                            <span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol_homog</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol_homog</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">B0 </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, :], </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">wt</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, :], </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">perm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lexsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)</span>
        <span class="s1">permt </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">lexsort</span><span class="s2">(</span><span class="s1">wt</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[:, </span><span class="s1">perm</span><span class="s2">], </span><span class="s1">wt</span><span class="s2">[:, </span><span class="s1">permt</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">,</span>
                        <span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s1">length </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">))</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">)):</span>
            <span class="s1">length</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">length</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">length</span><span class="s2">.</span><span class="s1">size</span><span class="s2">), </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">)</span>

        <span class="s5"># Convert homogeneous coordinates</span>
        <span class="s1">beta_nonzero </span><span class="s2">= (</span><span class="s1">w</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, :] != </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">wh </span><span class="s2">= </span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">beta_nonzero</span><span class="s2">] / </span><span class="s1">w</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">beta_nonzero</span><span class="s2">]</span>

        <span class="s5"># Eigenvalues in standard coordinates</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B0</span><span class="s2">)</span>
        <span class="s1">wt </span><span class="s2">= </span><span class="s1">eigvals</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B0</span><span class="s2">)</span>
        <span class="s1">val1 </span><span class="s2">= </span><span class="s1">A </span><span class="s2">@ </span><span class="s1">vr</span>
        <span class="s1">val2 </span><span class="s2">= </span><span class="s1">B </span><span class="s2">@ </span><span class="s1">vr </span><span class="s2">* </span><span class="s1">w</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">val1 </span><span class="s2">- </span><span class="s1">val2</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]):</span>
            <span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])):</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s4">0</span><span class="s2">,</span>
                                <span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s5"># try to consistently order eigenvalues, including complex conjugate pairs</span>
        <span class="s1">w_fin </span><span class="s2">= </span><span class="s1">w</span><span class="s2">[</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
        <span class="s1">wt_fin </span><span class="s2">= </span><span class="s1">wt</span><span class="s2">[</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">wt</span><span class="s2">)]</span>

        <span class="s5"># prune noise in the real parts</span>
        <span class="s1">w_fin </span><span class="s2">= -</span><span class="s4">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">real_if_close</span><span class="s2">(</span><span class="s4">1j</span><span class="s2">*</span><span class="s1">w_fin</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>
        <span class="s1">wt_fin </span><span class="s2">= -</span><span class="s4">1j </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">real_if_close</span><span class="s2">(</span><span class="s4">1j</span><span class="s2">*</span><span class="s1">wt_fin</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>

        <span class="s1">perm </span><span class="s2">= </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">w_fin</span><span class="s2">) + </span><span class="s1">w_fin</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)</span>
        <span class="s1">permt </span><span class="s2">= </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">wt_fin</span><span class="s2">) + </span><span class="s1">wt_fin</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w_fin</span><span class="s2">[</span><span class="s1">perm</span><span class="s2">], </span><span class="s1">wt_fin</span><span class="s2">[</span><span class="s1">permt</span><span class="s2">],</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s1">length </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">)):</span>
            <span class="s1">length</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">length</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">length</span><span class="s2">.</span><span class="s1">size</span><span class="s2">), </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">)</span>

        <span class="s5"># Compare homogeneous and nonhomogeneous versions</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">wh</span><span class="s2">), </span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]))</span>

    <span class="s0">def </span><span class="s1">test_singular</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Example taken from</span>
        <span class="s5"># https://web.archive.org/web/20040903121217/http://www.cs.umu.se/research/nla/singular_pairs/guptri/matlab.html</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">22</span><span class="s2">, </span><span class="s4">34</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">17</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">45</span><span class="s2">, </span><span class="s4">45</span><span class="s2">, </span><span class="s4">42</span><span class="s2">, </span><span class="s4">19</span><span class="s2">, </span><span class="s4">29</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">39</span><span class="s2">, </span><span class="s4">47</span><span class="s2">, </span><span class="s4">49</span><span class="s2">, </span><span class="s4">26</span><span class="s2">, </span><span class="s4">34</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">27</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">26</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">15</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">38</span><span class="s2">, </span><span class="s4">44</span><span class="s2">, </span><span class="s4">44</span><span class="s2">, </span><span class="s4">24</span><span class="s2">, </span><span class="s4">30</span><span class="s2">]])</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">13</span><span class="s2">, </span><span class="s4">26</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">17</span><span class="s2">, </span><span class="s4">24</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">31</span><span class="s2">, </span><span class="s4">46</span><span class="s2">, </span><span class="s4">40</span><span class="s2">, </span><span class="s4">26</span><span class="s2">, </span><span class="s4">37</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">26</span><span class="s2">, </span><span class="s4">40</span><span class="s2">, </span><span class="s4">19</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">25</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">16</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">27</span><span class="s2">, </span><span class="s4">14</span><span class="s2">, </span><span class="s4">23</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">24</span><span class="s2">, </span><span class="s4">35</span><span class="s2">, </span><span class="s4">18</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">22</span><span class="s2">]])</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">'ignore'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">atol_homog</span><span class="s2">=</span><span class="s4">5e-13</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-13</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_falker</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test matrices giving some Nan generalized eigenvalues.</span>
        <span class="s1">M </span><span class="s2">= </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]))</span>
        <span class="s1">K </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(([</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]))</span>
        <span class="s1">D </span><span class="s2">= </span><span class="s1">array</span><span class="s2">(([</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]))</span>
        <span class="s1">Z </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">I3 </span><span class="s2">= </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">block</span><span class="s2">([[</span><span class="s1">I3</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">], [</span><span class="s1">Z</span><span class="s2">, -</span><span class="s1">K</span><span class="s2">]])</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">block</span><span class="s2">([[</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">I3</span><span class="s2">], [</span><span class="s1">M</span><span class="s2">, </span><span class="s1">D</span><span class="s2">]])</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">'ignore'</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_geneig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Ticket #709 (strange return values from DGGEV)</span>

        <span class="s0">def </span><span class="s1">matrices</span><span class="s2">(</span><span class="s1">omega</span><span class="s2">):</span>
            <span class="s1">c1 </span><span class="s2">= -</span><span class="s4">9 </span><span class="s2">+ </span><span class="s1">omega</span><span class="s2">**</span><span class="s4">2</span>
            <span class="s1">c2 </span><span class="s2">= </span><span class="s4">2</span><span class="s2">*</span><span class="s1">omega</span>
            <span class="s1">A </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">c1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">c1</span><span class="s2">]]</span>
            <span class="s1">B </span><span class="s2">= [[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s1">c2</span><span class="s2">],</span>
                 <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
            <span class="s0">return </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span>

        <span class="s5"># With a buggy LAPACK, this can fail for different omega on different</span>
        <span class="s5"># machines -- so we need to test several values</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">'ignore'</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">):</span>
                <span class="s1">A</span><span class="s2">, </span><span class="s1">B </span><span class="s2">= </span><span class="s1">matrices</span><span class="s2">(</span><span class="s1">omega</span><span class="s2">=</span><span class="s1">k</span><span class="s2">*</span><span class="s4">5.</span><span class="s2">/</span><span class="s4">100</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_make_eigvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Step through all paths in _make_eigvals</span>
        <span class="s5"># Real eigenvalues</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">symrand</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">symrand</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s5"># Complex eigenvalues</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_check_gen_eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">exact_w </span><span class="s2">= [(</span><span class="s4">9</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, (</span><span class="s4">9</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">))/</span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">v0 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">+</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">)/</span><span class="s4">3</span><span class="s2">)/</span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">v1 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">v2 </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">-</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">93</span><span class="s2">)/</span><span class="s4">3</span><span class="s2">)/</span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">v0 </span><span class="s2">= </span><span class="s1">v0 </span><span class="s2">/ </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">v0</span><span class="s2">)</span>
        <span class="s1">v1 </span><span class="s2">= </span><span class="s1">v1 </span><span class="s2">/ </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">v1</span><span class="s2">)</span>
        <span class="s1">v2 </span><span class="s2">= </span><span class="s1">v2 </span><span class="s2">/ </span><span class="s1">norm</span><span class="s2">(</span><span class="s1">v2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">exact_w</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">v0</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[:, </span><span class="s4">0</span><span class="s2">]*</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">v1</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">]*</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">v2</span><span class="s2">, </span><span class="s1">v</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">]*</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">v</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">v</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">w</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]*</span><span class="s1">v</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_not_square_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Check that passing a non-square array raises a ValueError.&quot;&quot;&quot;</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eig</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_shape_mismatch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Check that passing arrays of with different shapes 
        raises a ValueError.&quot;&quot;&quot;</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">9.0</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eig</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eig</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gh_11577</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># https://github.com/scipy/scipy/issues/11577</span>
        <span class="s5"># `A - lambda B` should have 4 and 8 among the eigenvalues, and this</span>
        <span class="s5"># was apparently broken on some platforms</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">12.0</span><span class="s2">, </span><span class="s4">28.0</span><span class="s2">, </span><span class="s4">76.0</span><span class="s2">, </span><span class="s4">220.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">16.0</span><span class="s2">, </span><span class="s4">32.0</span><span class="s2">, </span><span class="s4">80.0</span><span class="s2">, </span><span class="s4">224.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">24.0</span><span class="s2">, </span><span class="s4">40.0</span><span class="s2">, </span><span class="s4">88.0</span><span class="s2">, </span><span class="s4">232.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">40.0</span><span class="s2">, </span><span class="s4">56.0</span><span class="s2">, </span><span class="s4">104.0</span><span class="s2">, </span><span class="s4">248.0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">'float64'</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">10.0</span><span class="s2">, </span><span class="s4">28.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">11.0</span><span class="s2">, </span><span class="s4">29.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">, </span><span class="s4">13.0</span><span class="s2">, </span><span class="s4">31.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">9.0</span><span class="s2">, </span><span class="s4">11.0</span><span class="s2">, </span><span class="s4">17.0</span><span class="s2">, </span><span class="s4">35.0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s6">'float64'</span><span class="s2">)</span>

        <span class="s1">D</span><span class="s2">, </span><span class="s1">V </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

        <span class="s5"># The problem is ill-conditioned, and two other eigenvalues</span>
        <span class="s5"># depend on ATLAS/OpenBLAS version, compiler version etc</span>
        <span class="s5"># see gh-11577 for discussion</span>
        <span class="s5">#</span>
        <span class="s5"># NB: it is tempting to use `assert_allclose(D[:2], [4, 8])` instead but</span>
        <span class="s5"># the ordering of eigenvalues also comes out different on different</span>
        <span class="s5"># systems depending on who knows what.</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">suppress_warnings</span><span class="s2">() </span><span class="s0">as </span><span class="s1">sup</span><span class="s2">:</span>
            <span class="s5"># isclose chokes on inf/nan values</span>
            <span class="s1">sup</span><span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">RuntimeWarning</span><span class="s2">, </span><span class="s6">&quot;invalid value encountered in multiply&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isclose</span><span class="s2">(</span><span class="s1">D</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isclose</span><span class="s2">(</span><span class="s1">D</span><span class="s2">, </span><span class="s4">8.0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

        <span class="s1">w_n</span><span class="s2">, </span><span class="s1">vr_n </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">w_n</span><span class="s2">.</span><span class="s1">dtype  </span><span class="s5">#eigvals(np.eye(2, dtype=dt)).dtype</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">vr</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>
        <span class="s0">assert </span><span class="s1">vr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">vr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">vr_n</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">w</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">homogeneous_eigvals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">w_n</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s0">assert </span><span class="s1">vr</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">vr</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">vr_n</span><span class="s2">.</span><span class="s1">dtype</span>



<span class="s0">class </span><span class="s1">TestEigBanded</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">create_bandmat</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">create_bandmat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Create the full matrix `self.fullmat` and 
           the corresponding band matrix `self.bandmat`.&quot;&quot;&quot;</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">KL </span><span class="s2">= </span><span class="s4">2   </span><span class="s5"># number of subdiagonals (below the diagonal)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">KU </span><span class="s2">= </span><span class="s4">2   </span><span class="s5"># number of superdiagonals (above the diagonal)</span>

        <span class="s5"># symmetric band matrix</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">sym_mat </span><span class="s2">= (</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>
                        <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">), -</span><span class="s4">1</span><span class="s2">) + </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
                        <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2.0</span><span class="s2">), -</span><span class="s4">2</span><span class="s2">) + </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2.0</span><span class="s2">), </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s5"># hermitian band matrix</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">herm_mat </span><span class="s2">= (</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">))</span>
                         <span class="s2">+ </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), -</span><span class="s4">1</span><span class="s2">)</span>
                         <span class="s2">- </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2.0</span><span class="s2">), -</span><span class="s4">2</span><span class="s2">)</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2.0</span><span class="s2">), </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s5"># general real band matrix</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat </span><span class="s2">= (</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">), -</span><span class="s4">1</span><span class="s2">) + </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3.0</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">), -</span><span class="s4">2</span><span class="s2">) + </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2.0</span><span class="s2">), </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s5"># general complex band matrix</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat </span><span class="s2">= (</span><span class="s4">1j</span><span class="s2">*</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">))</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">), -</span><span class="s4">1</span><span class="s2">)</span>
                         <span class="s2">+ </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">3.0</span><span class="s2">), </span><span class="s4">1</span><span class="s2">)</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">), -</span><span class="s4">2</span><span class="s2">)</span>
                         <span class="s2">+ </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2.0</span><span class="s2">), </span><span class="s4">2</span><span class="s2">))</span>

        <span class="s5"># Eigenvalues and -vectors from linalg.eig</span>
        <span class="s1">ew</span><span class="s2">, </span><span class="s1">ev </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sym_mat</span><span class="s2">)</span>
        <span class="s1">ew </span><span class="s2">= </span><span class="s1">ew</span><span class="s2">.</span><span class="s1">real</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">ew</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin </span><span class="s2">= </span><span class="s1">ew</span><span class="s2">[</span><span class="s1">args</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin </span><span class="s2">= </span><span class="s1">ev</span><span class="s2">[:, </span><span class="s1">args</span><span class="s2">]</span>

        <span class="s1">ew</span><span class="s2">, </span><span class="s1">ev </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">herm_mat</span><span class="s2">)</span>
        <span class="s1">ew </span><span class="s2">= </span><span class="s1">ew</span><span class="s2">.</span><span class="s1">real</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">ew</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin </span><span class="s2">= </span><span class="s1">ew</span><span class="s2">[</span><span class="s1">args</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">evec_herm_lin </span><span class="s2">= </span><span class="s1">ev</span><span class="s2">[:, </span><span class="s1">args</span><span class="s2">]</span>

        <span class="s5"># Extract upper bands from symmetric and hermitian band matrices</span>
        <span class="s5"># (for use in dsbevd, dsbevx, zhbevd, zhbevx</span>
        <span class="s5">#  and their single precision versions)</span>
        <span class="s1">LDAB </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU </span><span class="s2">+ </span><span class="s4">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">LDAB</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">LDAB</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">LDAB</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">[</span><span class="s1">LDAB</span><span class="s2">-</span><span class="s1">i</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">:</span><span class="s1">N</span><span class="s2">] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sym_mat</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">[</span><span class="s1">LDAB</span><span class="s2">-</span><span class="s1">i</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">:</span><span class="s1">N</span><span class="s2">] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">herm_mat</span><span class="s2">, </span><span class="s1">i</span><span class="s2">)</span>

        <span class="s5"># Extract bands from general real and complex band matrix</span>
        <span class="s5"># (for use in dgbtrf, dgbtrs and their single precision versions)</span>
        <span class="s1">LDAB </span><span class="s2">= </span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU </span><span class="s2">+ </span><span class="s4">1</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_real </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">LDAB</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_real</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, :] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat</span><span class="s2">)  </span><span class="s5"># diagonal</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">):</span>
            <span class="s5"># superdiagonals</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_real</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">-</span><span class="s4">1</span><span class="s2">-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:</span><span class="s1">N</span><span class="s2">] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s5"># subdiagonals</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_real</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">+</span><span class="s4">1</span><span class="s2">+</span><span class="s1">i</span><span class="s2">, </span><span class="s4">0</span><span class="s2">:</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">-</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat</span><span class="s2">,</span>
                                                             <span class="s2">-</span><span class="s1">i</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_comp </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">LDAB</span><span class="s2">, </span><span class="s1">N</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_comp</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, :] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat</span><span class="s2">)  </span><span class="s5"># diagonal</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">):</span>
            <span class="s5"># superdiagonals</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_comp</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">-</span><span class="s4">1</span><span class="s2">-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:</span><span class="s1">N</span><span class="s2">] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s5"># subdiagonals</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_comp</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">+</span><span class="s4">1</span><span class="s2">+</span><span class="s1">i</span><span class="s2">, </span><span class="s4">0</span><span class="s2">:</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">-</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat</span><span class="s2">,</span>
                                                             <span class="s2">-</span><span class="s1">i</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s5"># absolute value for linear equation system A*x = b</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">b </span><span class="s2">= </span><span class="s4">1.0</span><span class="s2">*</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">N</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">bc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b </span><span class="s2">* (</span><span class="s4">1 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">)</span>

    <span class="s5">#####################################################################</span>

    <span class="s0">def </span><span class="s1">test_dsbev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare dsbev eigenvalues and eigenvectors with 
           the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">evec</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">dsbev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">, </span><span class="s1">compute_v</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">evec_ </span><span class="s2">= </span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_dsbevd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare dsbevd eigenvalues and eigenvectors with 
           the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">evec</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">dsbevd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">, </span><span class="s1">compute_v</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">evec_ </span><span class="s2">= </span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_dsbevx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare dsbevx eigenvalues and eigenvectors 
           with the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">N</span><span class="s2">, </span><span class="s1">N </span><span class="s2">= </span><span class="s1">shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">sym_mat</span><span class="s2">)</span>
        <span class="s5"># Achtung: Argumente 0.0,0.0,range?</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">evec</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">ifail</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">dsbevx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">,</span>
                                           <span class="s1">compute_v</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">range</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">evec_ </span><span class="s2">= </span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_zhbevd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare zhbevd eigenvalues and eigenvectors 
           with the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">evec</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">zhbevd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">, </span><span class="s1">compute_v</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">evec_ </span><span class="s2">= </span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_herm_lin</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_zhbevx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare zhbevx eigenvalues and eigenvectors 
           with the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">N</span><span class="s2">, </span><span class="s1">N </span><span class="s2">= </span><span class="s1">shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">herm_mat</span><span class="s2">)</span>
        <span class="s5"># Achtung: Argumente 0.0,0.0,range?</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">evec</span><span class="s2">, </span><span class="s1">num</span><span class="s2">, </span><span class="s1">ifail</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">zhbevx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">N</span><span class="s2">,</span>
                                           <span class="s1">compute_v</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">range</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">evec_ </span><span class="s2">= </span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_herm_lin</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare eigenvalues of eigvals_banded with those of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w_sym </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">)</span>
        <span class="s1">w_sym </span><span class="s2">= </span><span class="s1">w_sym</span><span class="s2">.</span><span class="s1">real</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>

        <span class="s1">w_herm </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">)</span>
        <span class="s1">w_herm </span><span class="s2">= </span><span class="s1">w_herm</span><span class="s2">.</span><span class="s1">real</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_herm</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">)</span>

        <span class="s5"># extracting eigenvalues with respect to an index range</span>
        <span class="s1">ind1 </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">ind2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">longlong</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">w_sym_ind </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">,</span>
                                   <span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym_ind</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">w_herm_ind </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">,</span>
                                    <span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_herm_ind</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s5"># extracting eigenvalues with respect to a value range</span>
        <span class="s1">v_lower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">] - </span><span class="s4">1.0e-5</span>
        <span class="s1">v_upper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind2</span><span class="s2">] + </span><span class="s4">1.0e-5</span>
        <span class="s1">w_sym_val </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">,</span>
                                   <span class="s1">select</span><span class="s2">=</span><span class="s6">'v'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">v_lower</span><span class="s2">, </span><span class="s1">v_upper</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym_val</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">v_lower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">] - </span><span class="s4">1.0e-5</span>
        <span class="s1">v_upper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind2</span><span class="s2">] + </span><span class="s4">1.0e-5</span>
        <span class="s1">w_herm_val </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">,</span>
                                    <span class="s1">select</span><span class="s2">=</span><span class="s6">'v'</span><span class="s2">,</span>
                                    <span class="s1">select_range</span><span class="s2">=(</span><span class="s1">v_lower</span><span class="s2">, </span><span class="s1">v_upper</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_herm_val</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">w_sym </span><span class="s2">= </span><span class="s1">eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">w_sym </span><span class="s2">= </span><span class="s1">w_sym</span><span class="s2">.</span><span class="s1">real</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare eigenvalues and eigenvectors of eig_banded 
           with those of linalg.eig. &quot;&quot;&quot;</span>
        <span class="s1">w_sym</span><span class="s2">, </span><span class="s1">evec_sym </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">)</span>
        <span class="s1">evec_sym_ </span><span class="s2">= </span><span class="s1">evec_sym</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w_sym</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_sym_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">))</span>

        <span class="s1">w_herm</span><span class="s2">, </span><span class="s1">evec_herm </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">)</span>
        <span class="s1">evec_herm_ </span><span class="s2">= </span><span class="s1">evec_herm</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w_herm</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_herm</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_herm_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_herm_lin</span><span class="s2">))</span>

        <span class="s5"># extracting eigenvalues with respect to an index range</span>
        <span class="s1">ind1 </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">ind2 </span><span class="s2">= </span><span class="s4">6</span>
        <span class="s1">w_sym_ind</span><span class="s2">, </span><span class="s1">evec_sym_ind </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">,</span>
                                             <span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">,</span>
                                             <span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym_ind</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_sym_ind</span><span class="s2">),</span>
                                  <span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">[:, </span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s1">w_herm_ind</span><span class="s2">, </span><span class="s1">evec_herm_ind </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">,</span>
                                               <span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">,</span>
                                               <span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_herm_ind</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_herm_ind</span><span class="s2">),</span>
                                  <span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_herm_lin</span><span class="s2">[:, </span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s5"># extracting eigenvalues with respect to a value range</span>
        <span class="s1">v_lower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">] - </span><span class="s4">1.0e-5</span>
        <span class="s1">v_upper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind2</span><span class="s2">] + </span><span class="s4">1.0e-5</span>
        <span class="s1">w_sym_val</span><span class="s2">, </span><span class="s1">evec_sym_val </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">,</span>
                                             <span class="s1">select</span><span class="s2">=</span><span class="s6">'v'</span><span class="s2">,</span>
                                             <span class="s1">select_range</span><span class="s2">=(</span><span class="s1">v_lower</span><span class="s2">, </span><span class="s1">v_upper</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym_val</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_sym_val</span><span class="s2">),</span>
                                  <span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">[:, </span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s1">v_lower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">] - </span><span class="s4">1.0e-5</span>
        <span class="s1">v_upper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind2</span><span class="s2">] + </span><span class="s4">1.0e-5</span>
        <span class="s1">w_herm_val</span><span class="s2">, </span><span class="s1">evec_herm_val </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_herm</span><span class="s2">,</span>
                                               <span class="s1">select</span><span class="s2">=</span><span class="s6">'v'</span><span class="s2">,</span>
                                               <span class="s1">select_range</span><span class="s2">=(</span><span class="s1">v_lower</span><span class="s2">, </span><span class="s1">v_upper</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_herm_val</span><span class="s2">),</span>
                                  <span class="s1">self</span><span class="s2">.</span><span class="s1">w_herm_lin</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_herm_val</span><span class="s2">),</span>
                                  <span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_herm_lin</span><span class="s2">[:, </span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s1">w_sym</span><span class="s2">, </span><span class="s1">evec_sym </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_sym</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">evec_sym_ </span><span class="s2">= </span><span class="s1">evec_sym</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w_sym</span><span class="s2">.</span><span class="s1">real</span><span class="s2">)]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_sym</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w_sym_lin</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_sym_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec_sym_lin</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_dgbtrf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare dgbtrf  LU factorisation with the LU factorisation result 
           of linalg.lu.&quot;&quot;&quot;</span>
        <span class="s1">M</span><span class="s2">, </span><span class="s1">N </span><span class="s2">= </span><span class="s1">shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat</span><span class="s2">)</span>
        <span class="s1">lu_symm_band</span><span class="s2">, </span><span class="s1">ipiv</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">dgbtrf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_real</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">)</span>

        <span class="s5"># extract matrix u from lu_symm_band</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">lu_symm_band</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, :])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">):</span>
            <span class="s1">u </span><span class="s2">+= </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">lu_symm_band</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">-</span><span class="s4">1</span><span class="s2">-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:</span><span class="s1">N</span><span class="s2">], </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">p_lin</span><span class="s2">, </span><span class="s1">l_lin</span><span class="s2">, </span><span class="s1">u_lin </span><span class="s2">= </span><span class="s1">lu</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat</span><span class="s2">, </span><span class="s1">permute_l</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">u_lin</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zgbtrf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare zgbtrf  LU factorisation with the LU factorisation result 
           of linalg.lu.&quot;&quot;&quot;</span>
        <span class="s1">M</span><span class="s2">, </span><span class="s1">N </span><span class="s2">= </span><span class="s1">shape</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat</span><span class="s2">)</span>
        <span class="s1">lu_symm_band</span><span class="s2">, </span><span class="s1">ipiv</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">zgbtrf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_comp</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">)</span>

        <span class="s5"># extract matrix u from lu_symm_band</span>
        <span class="s1">u </span><span class="s2">= </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">lu_symm_band</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, :])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL </span><span class="s2">+ </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">):</span>
            <span class="s1">u </span><span class="s2">+= </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">lu_symm_band</span><span class="s2">[</span><span class="s4">2</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">-</span><span class="s4">1</span><span class="s2">-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:</span><span class="s1">N</span><span class="s2">], </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">p_lin</span><span class="s2">, </span><span class="s1">l_lin</span><span class="s2">, </span><span class="s1">u_lin </span><span class="s2">= </span><span class="s1">lu</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat</span><span class="s2">, </span><span class="s1">permute_l</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">u_lin</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dgbtrs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare dgbtrs  solutions for linear equation system  A*x = b 
           with solutions of linalg.solve.&quot;&quot;&quot;</span>

        <span class="s1">lu_symm_band</span><span class="s2">, </span><span class="s1">ipiv</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">dgbtrf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_real</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">dgbtrs</span><span class="s2">(</span><span class="s1">lu_symm_band</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">ipiv</span><span class="s2">)</span>

        <span class="s1">y_lin </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">solve</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">real_mat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_lin</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_zgbtrs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare zgbtrs  solutions for linear equation system  A*x = b 
           with solutions of linalg.solve.&quot;&quot;&quot;</span>

        <span class="s1">lu_symm_band</span><span class="s2">, </span><span class="s1">ipiv</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">zgbtrf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">bandmat_comp</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">, </span><span class="s1">info </span><span class="s2">= </span><span class="s1">zgbtrs</span><span class="s2">(</span><span class="s1">lu_symm_band</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KL</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">KU</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bc</span><span class="s2">, </span><span class="s1">ipiv</span><span class="s2">)</span>

        <span class="s1">y_lin </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">solve</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">comp_mat</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">bc</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y_lin</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a_band </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">a_band</span><span class="s2">)</span>

        <span class="s1">w_n</span><span class="s2">, </span><span class="s1">v_n </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">w_n</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">v_n</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">w </span><span class="s2">= </span><span class="s1">eig_banded</span><span class="s2">(</span><span class="s1">a_band</span><span class="s2">, </span><span class="s1">eigvals_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">w_n</span><span class="s2">.</span><span class="s1">dtype</span>

<span class="s0">class </span><span class="s1">TestEigTridiagonal</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">create_trimat</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">create_trimat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Create the full matrix `self.fullmat`, `self.d`, and `self.e`.&quot;&quot;&quot;</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s4">10</span>

        <span class="s5"># symmetric band matrix</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">d </span><span class="s2">= </span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">e </span><span class="s2">= </span><span class="s1">full</span><span class="s2">(</span><span class="s1">N</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">full_mat </span><span class="s2">= (</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">) + </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">) + </span><span class="s1">diag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>

        <span class="s1">ew</span><span class="s2">, </span><span class="s1">ev </span><span class="s2">= </span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">full_mat</span><span class="s2">)</span>
        <span class="s1">ew </span><span class="s2">= </span><span class="s1">ew</span><span class="s2">.</span><span class="s1">real</span>
        <span class="s1">args </span><span class="s2">= </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">ew</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">w </span><span class="s2">= </span><span class="s1">ew</span><span class="s2">[</span><span class="s1">args</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">evec </span><span class="s2">= </span><span class="s1">ev</span><span class="s2">[:, </span><span class="s1">args</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_degenerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Test error conditions.&quot;&quot;&quot;</span>
        <span class="s5"># Wrong sizes</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s5"># Must be real</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e </span><span class="s2">* </span><span class="s4">1j</span><span class="s2">)</span>
        <span class="s5"># Bad driver</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">,</span>
                      <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s4">1.</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">,</span>
                      <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s6">'foo'</span><span class="s2">)</span>
        <span class="s5"># Bad bounds</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">,</span>
                      <span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_eigvalsh_tridiagonal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare eigenvalues of eigvalsh_tridiagonal with those of eig.&quot;&quot;&quot;</span>
        <span class="s5"># can't use ?STERF with subselection</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s2">(</span><span class="s6">'sterf'</span><span class="s2">, </span><span class="s6">'stev'</span><span class="s2">, </span><span class="s6">'stebz'</span><span class="s2">, </span><span class="s6">'stemr'</span><span class="s2">, </span><span class="s6">'auto'</span><span class="s2">):</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s2">(</span><span class="s6">'sterf'</span><span class="s2">, </span><span class="s6">'stev'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">,</span>
                          <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s6">'stev'</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">,</span>
                          <span class="s1">select_range</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s2">(</span><span class="s6">'stebz'</span><span class="s2">, </span><span class="s6">'stemr'</span><span class="s2">, </span><span class="s6">'auto'</span><span class="s2">):</span>
            <span class="s5"># extracting eigenvalues with respect to the full index range</span>
            <span class="s1">w_ind </span><span class="s2">= </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">)-</span><span class="s4">1</span><span class="s2">),</span>
                <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_ind</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">)</span>

            <span class="s5"># extracting eigenvalues with respect to an index range</span>
            <span class="s1">ind1 </span><span class="s2">= </span><span class="s4">2</span>
            <span class="s1">ind2 </span><span class="s2">= </span><span class="s4">6</span>
            <span class="s1">w_ind </span><span class="s2">= </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">),</span>
                <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_ind</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

            <span class="s5"># extracting eigenvalues with respect to a value range</span>
            <span class="s1">v_lower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">] - </span><span class="s4">1.0e-5</span>
            <span class="s1">v_upper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind2</span><span class="s2">] + </span><span class="s4">1.0e-5</span>
            <span class="s1">w_val </span><span class="s2">= </span><span class="s1">eigvalsh_tridiagonal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'v'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">v_lower</span><span class="s2">, </span><span class="s1">v_upper</span><span class="s2">),</span>
                <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w_val</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_eigh_tridiagonal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;Compare eigenvalues and eigenvectors of eigh_tridiagonal 
           with those of eig. &quot;&quot;&quot;</span>
        <span class="s5"># can't use ?STERF when eigenvectors are requested</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">,</span>
                      <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s6">'sterf'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s2">(</span><span class="s6">'stebz'</span><span class="s2">, </span><span class="s6">'stev'</span><span class="s2">, </span><span class="s6">'stemr'</span><span class="s2">, </span><span class="s6">'auto'</span><span class="s2">):</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">evec </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">evec_ </span><span class="s2">= </span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">)]</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec_</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec</span><span class="s2">))</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh_tridiagonal</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">,</span>
                      <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s6">'stev'</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s2">(</span><span class="s6">'stebz'</span><span class="s2">, </span><span class="s6">'stemr'</span><span class="s2">, </span><span class="s6">'auto'</span><span class="s2">):</span>
            <span class="s5"># extracting eigenvalues with respect to an index range</span>
            <span class="s1">ind1 </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s1">ind2 </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">)-</span><span class="s4">1</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">evec </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">),</span>
                <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec</span><span class="s2">), </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec</span><span class="s2">))</span>
            <span class="s1">ind1 </span><span class="s2">= </span><span class="s4">2</span>
            <span class="s1">ind2 </span><span class="s2">= </span><span class="s4">6</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">evec </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'i'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">ind1</span><span class="s2">, </span><span class="s1">ind2</span><span class="s2">),</span>
                <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec</span><span class="s2">),</span>
                                      <span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>

            <span class="s5"># extracting eigenvalues with respect to a value range</span>
            <span class="s1">v_lower </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">] - </span><span class="s4">1.0e-5</span>
            <span class="s1">v_upper </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind2</span><span class="s2">] + </span><span class="s4">1.0e-5</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">evec </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">d</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">e</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">'v'</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s1">v_lower</span><span class="s2">, </span><span class="s1">v_upper</span><span class="s2">),</span>
                <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">w</span><span class="s2">[</span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">evec</span><span class="s2">),</span>
                                      <span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">evec</span><span class="s2">[:, </span><span class="s1">ind1</span><span class="s2">:</span><span class="s1">ind2</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]))</span>

    <span class="s0">def </span><span class="s1">test_eigh_tridiagonal_1x1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3">&quot;&quot;&quot;See gh-20075&quot;&quot;&quot;</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s4">2.0</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([])</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">eigvals_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">V </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">&quot;i&quot;</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">V</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">== </span><span class="s4">2</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">V</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">]]))</span>

        <span class="s1">x</span><span class="s2">, </span><span class="s1">V </span><span class="s2">= </span><span class="s1">eigh_tridiagonal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">select</span><span class="s2">=</span><span class="s6">&quot;v&quot;</span><span class="s2">, </span><span class="s1">select_range</span><span class="s2">=(-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">V</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestEigh</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_wrong_inputs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Nonsquare a</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]))</span>
        <span class="s5"># Nonsquare b</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s5"># Incompatible a, b sizes</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]))</span>
        <span class="s5"># Wrong type parameter for generalized problem</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">type</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s5"># Both value and index subsets requested</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">subset_by_value</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
        <span class="s5"># Invalid upper index spec</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
        <span class="s5"># Invalid lower index</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">subset_by_index</span><span class="s2">=[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s5"># Invalid index spec #2</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s5"># Invalid value spec</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">subset_by_value</span><span class="s2">=[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s5"># Invalid driver name</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]), </span><span class="s1">driver</span><span class="s2">=</span><span class="s6">'wrong'</span><span class="s2">)</span>
        <span class="s5"># Generalized driver selection without b</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s0">None</span><span class="s2">, </span><span class="s1">driver</span><span class="s2">=</span><span class="s6">'gvx'</span><span class="s2">)</span>
        <span class="s5"># Standard driver with b</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">driver</span><span class="s2">=</span><span class="s6">'evr'</span><span class="s2">)</span>
        <span class="s5"># Subset request from invalid driver</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">driver</span><span class="s2">=</span><span class="s6">'gvd'</span><span class="s2">, </span><span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]),</span>
                      <span class="s1">driver</span><span class="s2">=</span><span class="s6">'gvd'</span><span class="s2">, </span><span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_nonpositive_b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">LinAlgError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]))</span>

    <span class="s5"># index based subsets are done in the legacy test_eigh()</span>
    <span class="s0">def </span><span class="s1">test_value_subsets</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">ind</span><span class="s2">, </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">DTYPES</span><span class="s2">):</span>

            <span class="s1">a </span><span class="s2">= </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s4">20</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">subset_by_value</span><span class="s2">=[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">len</span><span class="s2">(</span><span class="s1">w</span><span class="s2">))</span>
            <span class="s0">assert </span><span class="s1">all</span><span class="s2">((</span><span class="s1">w </span><span class="s2">&gt; -</span><span class="s4">2</span><span class="s2">) &amp; (</span><span class="s1">w </span><span class="s2">&lt; </span><span class="s4">2</span><span class="s2">))</span>

            <span class="s1">b </span><span class="s2">= </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s4">20</span><span class="s2">, </span><span class="s1">posdef</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">subset_by_value</span><span class="s2">=[-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">len</span><span class="s2">(</span><span class="s1">w</span><span class="s2">))</span>
            <span class="s0">assert </span><span class="s1">all</span><span class="s2">((</span><span class="s1">w </span><span class="s2">&gt; -</span><span class="s4">2</span><span class="s2">) &amp; (</span><span class="s1">w </span><span class="s2">&lt; </span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_eigh_integer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_eigh_of_sparse</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This tests the rejection of inputs that eigh cannot currently handle.</span>
        <span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">tocsc</span><span class="s2">()</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_2d</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">eigh</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dtype_'</span><span class="s2">, </span><span class="s1">DTYPES</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'driver'</span><span class="s2">, (</span><span class="s6">&quot;ev&quot;</span><span class="s2">, </span><span class="s6">&quot;evd&quot;</span><span class="s2">, </span><span class="s6">&quot;evr&quot;</span><span class="s2">, </span><span class="s6">&quot;evx&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_various_drivers_standard</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">driver</span><span class="s2">, </span><span class="s1">dtype_</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype_</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">v </span><span class="s2">- (</span><span class="s1">v </span><span class="s2">* </span><span class="s1">w</span><span class="s2">), </span><span class="s4">0.</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype_</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">,</span>
                        <span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'driver'</span><span class="s2">, (</span><span class="s6">&quot;ev&quot;</span><span class="s2">, </span><span class="s6">&quot;evd&quot;</span><span class="s2">, </span><span class="s6">&quot;evr&quot;</span><span class="s2">, </span><span class="s6">&quot;evx&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_1x1_lwork</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">driver</span><span class="s2">):</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">]]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s5"># complex case now</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">([[</span><span class="s4">1j</span><span class="s2">]], </span><span class="s1">driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.</span><span class="s2">]]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'type'</span><span class="s2">, (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'driver'</span><span class="s2">, (</span><span class="s6">&quot;gv&quot;</span><span class="s2">, </span><span class="s6">&quot;gvd&quot;</span><span class="s2">, </span><span class="s6">&quot;gvx&quot;</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_various_drivers_generalized</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">driver</span><span class="s2">, </span><span class="s1">type</span><span class="s2">):</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">spacing</span><span class="s2">(</span><span class="s4">5000.</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s4">20</span><span class="s2">, </span><span class="s1">posdef</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">=</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">=</span><span class="s1">b</span><span class="s2">, </span><span class="s1">driver</span><span class="s2">=</span><span class="s1">driver</span><span class="s2">, </span><span class="s1">type</span><span class="s2">=</span><span class="s1">type</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">type </span><span class="s2">== </span><span class="s4">1</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">v </span><span class="s2">- </span><span class="s1">w</span><span class="s2">*(</span><span class="s1">b </span><span class="s2">@ </span><span class="s1">v</span><span class="s2">), </span><span class="s4">0.</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">type </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">a </span><span class="s2">@ </span><span class="s1">b </span><span class="s2">@ </span><span class="s1">v </span><span class="s2">- </span><span class="s1">v </span><span class="s2">* </span><span class="s1">w</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">v </span><span class="s2">- </span><span class="s1">v </span><span class="s2">* </span><span class="s1">w</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0.</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_eigvalsh_new_args</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">_random_hermitian_matrix</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigvalsh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">w</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>

        <span class="s1">w2 </span><span class="s2">= </span><span class="s1">eigvalsh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">subset_by_index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">w2</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">w2</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">1.3</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">w3 </span><span class="s2">= </span><span class="s1">eigvalsh</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">subset_by_value</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">w3</span><span class="s2">), </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">1.3</span><span class="s2">]))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

        <span class="s1">w_n</span><span class="s2">, </span><span class="s1">v_n </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>

        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">w_n</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">v_n</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">w </span><span class="s2">= </span><span class="s1">eigh</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eigvals_only</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>

        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">,)</span>
        <span class="s0">assert </span><span class="s1">w</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">w_n</span><span class="s2">.</span><span class="s1">dtype</span>

<span class="s0">class </span><span class="s1">TestSVD_GESDD</span><span class="s2">:</span>
    <span class="s1">lapack_driver </span><span class="s2">= </span><span class="s6">'gesdd'</span>

    <span class="s0">def </span><span class="s1">test_degenerate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">svd</span><span class="s2">, [[</span><span class="s4">1.</span><span class="s2">]], </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s4">1.</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">svd</span><span class="s2">, [[</span><span class="s4">1.</span><span class="s2">]], </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s6">'foo'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                           <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
            <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_singular</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                           <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
            <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_underdet</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                           <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]))</span>
            <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_overdet</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                           <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
            <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">15</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">[</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m</span><span class="s2">]), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])]:</span>
                <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                                   <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
                    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>
                    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">vh </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]))</span>
                    <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                        <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2j</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                           <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]))</span>
            <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">15</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">[</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">m</span><span class="s2">]), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])]:</span>
                    <span class="s1">a </span><span class="s2">= </span><span class="s1">a </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
                    <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s1">full_matrices</span><span class="s2">,</span>
                                   <span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
                    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">,</span>
                                              <span class="s1">eye</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]))</span>
                    <span class="s5"># This fails when [m,n]</span>
                    <span class="s5"># assert_array_almost_equal(vh.conj().T @ vh,</span>
                    <span class="s5">#                        eye(len(vh),dtype=vh.dtype.char))</span>
                    <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
                        <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
                    <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_crash_1580</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">sizes </span><span class="s2">= [(</span><span class="s4">13</span><span class="s2">, </span><span class="s4">23</span><span class="s2">), (</span><span class="s4">30</span><span class="s2">, </span><span class="s4">50</span><span class="s2">), (</span><span class="s4">60</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">sz </span><span class="s0">in </span><span class="s1">sizes</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">]:</span>
                <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(*</span><span class="s1">sz</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>
                <span class="s5"># should not crash</span>
                <span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">vh</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">sigma </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">vh</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)):</span>
            <span class="s1">sigma</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] = </span><span class="s1">s</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">sigma </span><span class="s2">@ </span><span class="s1">vh</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gh_5039</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># This is a smoke test for https://github.com/scipy/scipy/issues/5039</span>
        <span class="s5">#</span>
        <span class="s5"># The following is reported to raise &quot;ValueError: On entry to DGESDD</span>
        <span class="s5"># parameter number 12 had an illegal value&quot;.</span>
        <span class="s5"># `interp1d([1,2,3,4], [1,2,3,4], kind='cubic')`</span>
        <span class="s5"># This is reported to only show up on LAPACK 3.0.3.</span>
        <span class="s5">#</span>
        <span class="s5"># The matrix below is taken from the call to</span>
        <span class="s5"># `B = _fitpack._bsplmat(order, xk)` in interpolate._find_smoothest</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.66666667</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.66666667</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.66666667</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.66666667</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">]])</span>
        <span class="s1">svd</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">lapack_driver</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">HAS_ILP64</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;64-bit LAPACK required&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_large_matrix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">check_free_memory</span><span class="s2">(</span><span class="s1">free_mb</span><span class="s2">=</span><span class="s4">17000</span><span class="s2">)</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">31</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">A</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">] = </span><span class="s4">1</span>
        <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">vh </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">1.0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] * </span><span class="s1">vh</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1.0</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;m&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;n&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dtype'</span><span class="s2">, </span><span class="s1">DTYPES</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_shape_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">dchar </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">char</span>
        <span class="s1">real_dchar </span><span class="s2">= </span><span class="s1">dchar</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">if </span><span class="s1">dchar </span><span class="s0">in </span><span class="s6">'FD' </span><span class="s0">else </span><span class="s1">dchar</span>

        <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">m</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">real_dchar</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">k</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">u</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">real_dchar</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">s </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">compute_uv</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">real_dchar</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">((</span><span class="s6">&quot;m&quot;</span><span class="s2">, </span><span class="s6">&quot;n&quot;</span><span class="s2">), [(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">a0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">u0</span><span class="s2">, </span><span class="s1">s0</span><span class="s2">, </span><span class="s1">v0 </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>

        <span class="s0">assert </span><span class="s1">u</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">s0</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">u</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>

        <span class="s0">assert </span><span class="s1">u</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">u0</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">v0</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">s0</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">s </span><span class="s2">= </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">compute_uv</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>

        <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">s0</span><span class="s2">.</span><span class="s1">dtype</span>

<span class="s0">class </span><span class="s1">TestSVD_GESVD</span><span class="s2">(</span><span class="s1">TestSVD_GESDD</span><span class="s2">):</span>
    <span class="s1">lapack_driver </span><span class="s2">= </span><span class="s6">'gesvd'</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">fail_slow</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_svd_gesdd_nofegfault</span><span class="s2">():</span>
    <span class="s5"># svd(a) with {U,VT}.size &gt; INT_MAX does not segfault</span>
    <span class="s5"># cf https://github.com/scipy/scipy/issues/14001</span>
    <span class="s1">df</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s4">4799</span><span class="s2">, </span><span class="s4">53130</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">svd</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSVDVals</span><span class="s2">:</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s2">[[]], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">0</span><span class="s2">))</span>

            <span class="s1">s0 </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
            <span class="s0">assert </span><span class="s1">s</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">s0</span><span class="s2">.</span><span class="s1">dtype</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_underdet</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_overdet</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">3j</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_underdet_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5j</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_simple_overdet_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">3j</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] &gt;= </span><span class="s1">s</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_crash_2609</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">1500</span><span class="s2">, </span><span class="s4">2800</span><span class="s2">)</span>
        <span class="s5"># Shouldn't crash:</span>
        <span class="s1">svdvals</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDiagSVD</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">diagsvd</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">),</span>
                                  <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>


<span class="s0">class </span><span class="s1">TestQR</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_left_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_right_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_trap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_trap_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># full version</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># full version pivoting</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_e</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># economy version</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_e_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># economy version pivoting</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">], </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s1">overwrite_c</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">], </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">qc</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_left_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">kpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">jpvt</span><span class="s2">, </span><span class="s1">kpvt</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">qc</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_right_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># full version</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># full version pivoting</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_e</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># economy version</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_e_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># economy version pivoting</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">], </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">qc</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_left_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">qc</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_right_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_complex_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">3j</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">2j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s1">overwrite_c</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">], </span><span class="s1">qc</span><span class="s2">)</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">qc</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_left_conjugate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s1">conjugate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">() @ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_tall_left_conjugate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">2j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s1">conjugate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">() @ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_right_conjugate</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">])</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">conjugate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_left_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_right_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]])</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">]</span>
        <span class="s1">qc</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">jpvt </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
            <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
            <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_tall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s5"># full version</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s5"># full version</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
            <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">qc</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s5"># full version</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">&quot;economic&quot;</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">])</span>
            <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
            <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s5"># full version pivoting</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_e</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s5"># economy version</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_random_tall_e_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s5"># economy version pivoting</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">], </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_trap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_trap_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_left</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">c</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>
            <span class="s1">qc</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s6">&quot;left&quot;</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">qc</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_right</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">c </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>
            <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">cq</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_pivoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">r</span><span class="s2">))</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] &lt;= </span><span class="s1">d</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[:, </span><span class="s1">p</span><span class="s2">])</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">q2</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">r</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lwork</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s5"># Get comparison values</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">lwork</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>

        <span class="s5"># Test against minimum valid lwork</span>
        <span class="s1">q2</span><span class="s2">, </span><span class="s1">r2 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">lwork</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r2</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>

        <span class="s5"># Test against larger lwork</span>
        <span class="s1">q3</span><span class="s2">, </span><span class="s1">r3 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">lwork</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q3</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r3</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>

        <span class="s5"># Test against explicit lwork=-1</span>
        <span class="s1">q4</span><span class="s2">, </span><span class="s1">r4 </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">lwork</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q4</span><span class="s2">, </span><span class="s1">q</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r4</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>

        <span class="s5"># Test against invalid lwork</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">, </span><span class="s1">qr</span><span class="s2">, (</span><span class="s1">a</span><span class="s2">,), {</span><span class="s6">'lwork'</span><span class="s2">: </span><span class="s4">0</span><span class="s2">})</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">, </span><span class="s1">qr</span><span class="s2">, (</span><span class="s1">a</span><span class="s2">,), {</span><span class="s6">'lwork'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">})</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;m&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;n&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;pivoting&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dtype'</span><span class="s2">, </span><span class="s1">DTYPES</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_shape_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, *</span><span class="s1">other </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s1">pivoting</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">m</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">) == (</span><span class="s4">1 </span><span class="s0">if </span><span class="s1">pivoting </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">pivoting</span><span class="s2">:</span>
            <span class="s1">p</span><span class="s2">, = </span><span class="s1">other</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">,))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, *</span><span class="s1">other </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'r'</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s1">pivoting</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">) == (</span><span class="s4">1 </span><span class="s0">if </span><span class="s1">pivoting </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">pivoting</span><span class="s2">:</span>
            <span class="s1">p</span><span class="s2">, = </span><span class="s1">other</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">,))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, *</span><span class="s1">other </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s1">pivoting</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">k</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">) == (</span><span class="s4">1 </span><span class="s0">if </span><span class="s1">pivoting </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">pivoting</span><span class="s2">:</span>
            <span class="s1">p</span><span class="s2">, = </span><span class="s1">other</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">,))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s2">(</span><span class="s1">raw</span><span class="s2">, </span><span class="s1">tau</span><span class="s2">), </span><span class="s1">r</span><span class="s2">, *</span><span class="s1">other </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'raw'</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s1">pivoting</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">raw</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">raw</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">tau</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">,))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">tau</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">other</span><span class="s2">) == (</span><span class="s4">1 </span><span class="s0">if </span><span class="s1">pivoting </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">pivoting</span><span class="s2">:</span>
            <span class="s1">p</span><span class="s2">, = </span><span class="s1">other</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">,))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">p</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">((</span><span class="s6">&quot;m&quot;</span><span class="s2">, </span><span class="s6">&quot;n&quot;</span><span class="s2">), [(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>

        <span class="s1">q</span><span class="s2">, </span><span class="s1">r</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">pivoting</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>

        <span class="s1">r</span><span class="s2">, = </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'r'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>

        <span class="s1">q</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>

        <span class="s2">(</span><span class="s1">raw</span><span class="s2">, </span><span class="s1">tau</span><span class="s2">), </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'raw'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">raw</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tau</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">k</span><span class="s2">,)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_multiply_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">cq</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= </span><span class="s1">qr_multiply</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cq</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)))</span>


<span class="s0">class </span><span class="s1">TestRQ</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_r</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">r2 </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'r'</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">r2</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_trap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">+</span><span class="s4">4j</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">+</span><span class="s4">7j</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_tall</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_trap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_trap_economic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">m</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_random_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_economic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">m</span><span class="s2">))</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">m</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">r </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;m&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">&quot;n&quot;</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dtype'</span><span class="s2">, </span><span class="s1">DTYPES</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_shape_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'r'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">m</span><span class="s2">, </span><span class="s1">k</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">r</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">((</span><span class="s6">&quot;m&quot;</span><span class="s2">, </span><span class="s6">&quot;n&quot;</span><span class="s2">), [(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">identity</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>

        <span class="s1">r </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'r'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>

        <span class="s1">r</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">rq</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">=</span><span class="s6">'economic'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">r</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>


<span class="s0">class </span><span class="s1">TestSchur</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">check_schur</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">):</span>
        <span class="s5"># Check that the Schur decomposition is correct.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">t </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">,</span>
                        <span class="s1">err_msg</span><span class="s2">=</span><span class="s6">&quot;Schur decomposition does not match 'a'&quot;</span><span class="s2">)</span>
        <span class="s5"># The expected value of u @ u.H - I is all zeros, so test</span>
        <span class="s5"># with absolute tolerance only.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u </span><span class="s2">@ </span><span class="s1">u</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">u</span><span class="s2">)), </span><span class="s4">0</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">,</span>
                        <span class="s1">err_msg</span><span class="s2">=</span><span class="s6">&quot;u is not unitary&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-15</span><span class="s2">)</span>
        <span class="s1">tc</span><span class="s2">, </span><span class="s1">zc </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s6">'complex'</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">iscomplex</span><span class="s2">(</span><span class="s1">zc</span><span class="s2">))) </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">ravel</span><span class="s2">(</span><span class="s1">iscomplex</span><span class="s2">(</span><span class="s1">tc</span><span class="s2">))))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">tc</span><span class="s2">, </span><span class="s1">zc</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-15</span><span class="s2">)</span>
        <span class="s1">tc2</span><span class="s2">, </span><span class="s1">zc2 </span><span class="s2">= </span><span class="s1">rsf2csf</span><span class="s2">(</span><span class="s1">tc</span><span class="s2">, </span><span class="s1">zc</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">tc2</span><span class="s2">, </span><span class="s1">zc2</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-15</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s6">'sort, expected_diag'</span><span class="s2">,</span>
        <span class="s2">[(</span><span class="s6">'lhp'</span><span class="s2">, [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), -</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">]),</span>
         <span class="s2">(</span><span class="s6">'rhp'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), -</span><span class="s4">0.5</span><span class="s2">]),</span>
         <span class="s2">(</span><span class="s6">'iuc'</span><span class="s2">, [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)]),</span>
         <span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), -</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]),</span>
         <span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s4">0.0</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">2</span><span class="s2">), -</span><span class="s4">0.5</span><span class="s2">])]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_sort</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">, </span><span class="s1">expected_diag</span><span class="s2">):</span>
        <span class="s5"># The exact eigenvalues of this matrix are</span>
        <span class="s5">#   -sqrt(2), sqrt(2), -1/2, 1/2.</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">4.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, -</span><span class="s4">1.</span><span class="s2">],</span>
             <span class="s2">[-</span><span class="s4">4.5</span><span class="s2">, -</span><span class="s4">3.5</span><span class="s2">, -</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">9.</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">, -</span><span class="s4">4.</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">6.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, -</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">]]</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">sdim </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s1">sort</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">u</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">t</span><span class="s2">), </span><span class="s1">expected_diag</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">sdim</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sort_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">4.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, -</span><span class="s4">1.</span><span class="s2">],</span>
             <span class="s2">[-</span><span class="s4">4.5</span><span class="s2">, -</span><span class="s4">3.5</span><span class="s2">, -</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">9.</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">, -</span><span class="s4">4.</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">6.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, -</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">]]</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">schur</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s6">'unsupported'</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">schur</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">8</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]]</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">z </span><span class="s2">@ </span><span class="s1">t </span><span class="s2">@ </span><span class="s1">z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">t0</span><span class="s2">, </span><span class="s1">z0 </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>
        <span class="s0">assert </span><span class="s1">t</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">t0</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">assert </span><span class="s1">z</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">z0</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">t</span><span class="s2">, </span><span class="s1">z</span><span class="s2">, </span><span class="s1">sdim </span><span class="s2">= </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s6">'lhp'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">sdim</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">t</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">t0</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s0">assert </span><span class="s1">z</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">z0</span><span class="s2">.</span><span class="s1">dtype</span>


<span class="s0">class </span><span class="s1">TestHessenberg</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[-</span><span class="s4">149</span><span class="s2">, -</span><span class="s4">50</span><span class="s2">, -</span><span class="s4">154</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">537</span><span class="s2">, </span><span class="s4">180</span><span class="s2">, </span><span class="s4">546</span><span class="s2">],</span>
             <span class="s2">[-</span><span class="s4">27</span><span class="s2">, -</span><span class="s4">9</span><span class="s2">, -</span><span class="s4">25</span><span class="s2">]]</span>
        <span class="s1">h1 </span><span class="s2">= [[-</span><span class="s4">149.0000</span><span class="s2">, </span><span class="s4">42.2037</span><span class="s2">, -</span><span class="s4">156.3165</span><span class="s2">],</span>
              <span class="s2">[-</span><span class="s4">537.6783</span><span class="s2">, </span><span class="s4">152.5511</span><span class="s2">, -</span><span class="s4">554.9272</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.0728</span><span class="s2">, </span><span class="s4">2.4489</span><span class="s2">]]</span>
        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">h1</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[-</span><span class="s4">149</span><span class="s2">, -</span><span class="s4">50</span><span class="s2">, -</span><span class="s4">154</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">537</span><span class="s2">, </span><span class="s4">180j</span><span class="s2">, </span><span class="s4">546</span><span class="s2">],</span>
             <span class="s2">[-</span><span class="s4">27j</span><span class="s2">, -</span><span class="s4">9</span><span class="s2">, -</span><span class="s4">25</span><span class="s2">]]</span>
        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]]</span>
        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s4">2</span>
        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
            <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[-</span><span class="s4">149</span><span class="s2">, -</span><span class="s4">50</span><span class="s2">, -</span><span class="s4">154</span><span class="s2">],</span>
             <span class="s2">[</span><span class="s4">537</span><span class="s2">, </span><span class="s4">180</span><span class="s2">, </span><span class="s4">546</span><span class="s2">],</span>
             <span class="s2">[-</span><span class="s4">27</span><span class="s2">, -</span><span class="s4">9</span><span class="s2">, -</span><span class="s4">25</span><span class="s2">]]</span>
        <span class="s1">h1 </span><span class="s2">= [[-</span><span class="s4">149.0000</span><span class="s2">, </span><span class="s4">42.2037</span><span class="s2">, -</span><span class="s4">156.3165</span><span class="s2">],</span>
              <span class="s2">[-</span><span class="s4">537.6783</span><span class="s2">, </span><span class="s4">152.5511</span><span class="s2">, -</span><span class="s4">554.9272</span><span class="s2">],</span>
              <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.0728</span><span class="s2">, </span><span class="s4">2.4489</span><span class="s2">]]</span>
        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">a </span><span class="s2">@ </span><span class="s1">q</span><span class="s2">, </span><span class="s1">h</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">h1</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2x2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">12</span><span class="s2">]]</span>

        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">h</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= [[</span><span class="s4">2</span><span class="s2">-</span><span class="s4">7j</span><span class="s2">, </span><span class="s4">1</span><span class="s2">+</span><span class="s4">2j</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">+</span><span class="s4">3j</span><span class="s2">, </span><span class="s4">12</span><span class="s2">-</span><span class="s4">2j</span><span class="s2">]]</span>
        <span class="s1">h2</span><span class="s2">, </span><span class="s1">q2 </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">q2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">complex64</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
        <span class="s1">h </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">h</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">h</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)).</span><span class="s1">dtype</span>

        <span class="s1">h</span><span class="s2">, </span><span class="s1">q </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">h3</span><span class="s2">, </span><span class="s1">q3 </span><span class="s2">= </span><span class="s1">hessenberg</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">calc_q</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">h</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">h</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">h3</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s0">assert </span><span class="s1">q</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">q</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">q3</span><span class="s2">.</span><span class="s1">dtype</span>


<span class="s1">blas_provider </span><span class="s2">= </span><span class="s1">blas_version </span><span class="s2">= </span><span class="s0">None</span>
<span class="s0">if </span><span class="s1">CONFIG </span><span class="s0">is not None</span><span class="s2">:</span>
    <span class="s1">blas_provider </span><span class="s2">= </span><span class="s1">CONFIG</span><span class="s2">[</span><span class="s6">'Build Dependencies'</span><span class="s2">][</span><span class="s6">'blas'</span><span class="s2">][</span><span class="s6">'name'</span><span class="s2">]</span>
    <span class="s1">blas_version </span><span class="s2">= </span><span class="s1">CONFIG</span><span class="s2">[</span><span class="s6">'Build Dependencies'</span><span class="s2">][</span><span class="s6">'blas'</span><span class="s2">][</span><span class="s6">'version'</span><span class="s2">]</span>


<span class="s0">class </span><span class="s1">TestQZ</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_qz_single</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">) &gt;= </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_qz_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">) &gt;= </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_qz_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">) &gt;= </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">).</span><span class="s1">imag </span><span class="s2">== </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_qz_complex64</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">A </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">]) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">complex64</span><span class="s2">)</span>
        <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s1">decimal</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">) &gt;= </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">).</span><span class="s1">imag </span><span class="s2">== </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_qz_double_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">output</span><span class="s2">=</span><span class="s6">'complex'</span><span class="s2">)</span>
        <span class="s1">aa </span><span class="s2">= </span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">bb </span><span class="s2">= </span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">bb</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">bb</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">().</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">) &gt;= </span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_qz_double_sort</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># from https://www.nag.com/lapack-ex/node119.html</span>
        <span class="s5"># NOTE: These matrices may be ill-conditioned and lead to a</span>
        <span class="s5"># seg fault on certain python versions when compiled with</span>
        <span class="s5"># sse2 or sse3 older ATLAS/LAPACK binaries for windows</span>
        <span class="s5"># A =   np.array([[3.9,  12.5, -34.5,  -0.5],</span>
        <span class="s5">#                [ 4.3,  21.5, -47.5,   7.5],</span>
        <span class="s5">#                [ 4.3,  21.5, -43.5,   3.5],</span>
        <span class="s5">#                [ 4.4,  26.0, -46.0,   6.0 ]])</span>

        <span class="s5"># B = np.array([[ 1.0,   2.0,  -3.0,   1.0],</span>
        <span class="s5">#              [1.0,   3.0,  -5.0,   4.0],</span>
        <span class="s5">#              [1.0,   3.0,  -4.0,   3.0],</span>
        <span class="s5">#              [1.0,   3.0,  -4.0,   4.0]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3.9</span><span class="s2">, </span><span class="s4">12.5</span><span class="s2">, -</span><span class="s4">34.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">4.3</span><span class="s2">, </span><span class="s4">21.5</span><span class="s2">, -</span><span class="s4">47.5</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">4.3</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, -</span><span class="s4">43.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">4.4</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, -</span><span class="s4">46.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">]])</span>

        <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, -</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, -</span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">4.4</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, -</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
                      <span class="s2">[</span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, -</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">]])</span>

        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">qz</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">ar</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">: </span><span class="s1">ai </span><span class="s2">== </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s0">if False</span><span class="s2">:</span>
            <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">, </span><span class="s1">sdim </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">ar</span><span class="s2">, </span><span class="s1">ai</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">: </span><span class="s1">ai </span><span class="s2">== </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s5"># assert_(sdim == 2)</span>
            <span class="s1">assert_</span><span class="s2">(</span><span class="s1">sdim </span><span class="s2">== </span><span class="s4">4</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

            <span class="s5"># test absolute values bc the sign is ambiguous and</span>
            <span class="s5"># might be platform dependent</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">AA</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                            <span class="s2">[[</span><span class="s4">35.7864</span><span class="s2">, -</span><span class="s4">80.9061</span><span class="s2">, -</span><span class="s4">12.0629</span><span class="s2">, -</span><span class="s4">9.498</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">2.7638</span><span class="s2">, -</span><span class="s4">2.3505</span><span class="s2">, </span><span class="s4">7.3256</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.6258</span><span class="s2">, -</span><span class="s4">0.0398</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, -</span><span class="s4">12.8217</span><span class="s2">]])), </span><span class="s4">4</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                            <span class="s2">[[</span><span class="s4">4.5324</span><span class="s2">, -</span><span class="s4">8.7878</span><span class="s2">, </span><span class="s4">3.2357</span><span class="s2">, -</span><span class="s4">3.5526</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.4314</span><span class="s2">, -</span><span class="s4">2.1894</span><span class="s2">, </span><span class="s4">0.9709</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.3126</span><span class="s2">, -</span><span class="s4">0.3468</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.559</span><span class="s2">]])), </span><span class="s4">4</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">Q</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                            <span class="s2">[[-</span><span class="s4">0.4193</span><span class="s2">, -</span><span class="s4">0.605</span><span class="s2">, -</span><span class="s4">0.1894</span><span class="s2">, -</span><span class="s4">0.6498</span><span class="s2">],</span>
                             <span class="s2">[-</span><span class="s4">0.5495</span><span class="s2">, </span><span class="s4">0.6987</span><span class="s2">, </span><span class="s4">0.2654</span><span class="s2">, -</span><span class="s4">0.3734</span><span class="s2">],</span>
                             <span class="s2">[-</span><span class="s4">0.4973</span><span class="s2">, -</span><span class="s4">0.3682</span><span class="s2">, </span><span class="s4">0.6194</span><span class="s2">, </span><span class="s4">0.4832</span><span class="s2">],</span>
                             <span class="s2">[-</span><span class="s4">0.5243</span><span class="s2">, </span><span class="s4">0.1008</span><span class="s2">, -</span><span class="s4">0.7142</span><span class="s2">, </span><span class="s4">0.4526</span><span class="s2">]])), </span><span class="s4">4</span><span class="s2">)</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                            <span class="s2">[[-</span><span class="s4">0.9471</span><span class="s2">, -</span><span class="s4">0.2971</span><span class="s2">, -</span><span class="s4">0.1217</span><span class="s2">, </span><span class="s4">0.0055</span><span class="s2">],</span>
                             <span class="s2">[-</span><span class="s4">0.0367</span><span class="s2">, </span><span class="s4">0.1209</span><span class="s2">, </span><span class="s4">0.0358</span><span class="s2">, </span><span class="s4">0.9913</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.3171</span><span class="s2">, -</span><span class="s4">0.9041</span><span class="s2">, -</span><span class="s4">0.2547</span><span class="s2">, </span><span class="s4">0.1312</span><span class="s2">],</span>
                             <span class="s2">[</span><span class="s4">0.0346</span><span class="s2">, </span><span class="s4">0.2824</span><span class="s2">, -</span><span class="s4">0.9587</span><span class="s2">, </span><span class="s4">0.0014</span><span class="s2">]])), </span><span class="s4">4</span><span class="s2">)</span>

        <span class="s5"># test absolute values bc the sign is ambiguous and might be platform</span>
        <span class="s5"># dependent</span>
        <span class="s5"># assert_array_almost_equal(abs(AA), abs(np.array([</span>
        <span class="s5">#                [3.8009, -69.4505, 50.3135, -43.2884],</span>
        <span class="s5">#                [0.0000, 9.2033, -0.2001, 5.9881],</span>
        <span class="s5">#                [0.0000, 0.0000, 1.4279, 4.4453],</span>
        <span class="s5">#                [0.0000, 0.0000, 0.9019, -1.1962]])), 4)</span>
        <span class="s5"># assert_array_almost_equal(abs(BB), abs(np.array([</span>
        <span class="s5">#                [1.9005, -10.2285, 0.8658, -5.2134],</span>
        <span class="s5">#                [0.0000,   2.3008, 0.7915,  0.4262],</span>
        <span class="s5">#                [0.0000,   0.0000, 0.8101,  0.0000],</span>
        <span class="s5">#                [0.0000,   0.0000, 0.0000, -0.2823]])), 4)</span>
        <span class="s5"># assert_array_almost_equal(abs(Q), abs(np.array([</span>
        <span class="s5">#                [0.4642,  0.7886,  0.2915, -0.2786],</span>
        <span class="s5">#                [0.5002, -0.5986,  0.5638, -0.2713],</span>
        <span class="s5">#                [0.5002,  0.0154, -0.0107,  0.8657],</span>
        <span class="s5">#                [0.5331, -0.1395, -0.7727, -0.3151]])), 4)</span>
        <span class="s5"># assert_array_almost_equal(dot(Q,Q.T), eye(4))</span>
        <span class="s5"># assert_array_almost_equal(abs(Z), abs(np.array([</span>
        <span class="s5">#                [0.9961, -0.0014,  0.0887, -0.0026],</span>
        <span class="s5">#                [0.0057, -0.0404, -0.0938, -0.9948],</span>
        <span class="s5">#                [0.0626,  0.7194, -0.6908,  0.0363],</span>
        <span class="s5">#                [0.0626, -0.6934, -0.7114,  0.0956]])), 4)</span>
        <span class="s5"># assert_array_almost_equal(dot(Z,Z.T), eye(4))</span>

    <span class="s5"># def test_qz_complex_sort(self):</span>
    <span class="s5">#    cA = np.array([</span>
    <span class="s5">#   [-21.10+22.50*1j, 53.50+-50.50*1j, -34.50+127.50*1j, 7.50+  0.50*1j],</span>
    <span class="s5">#   [-0.46+ -7.78*1j, -3.50+-37.50*1j, -15.50+ 58.50*1j,-10.50+ -1.50*1j],</span>
    <span class="s5">#   [ 4.30+ -5.50*1j, 39.70+-17.10*1j, -68.50+ 12.50*1j, -7.50+ -3.50*1j],</span>
    <span class="s5">#   [ 5.50+  4.40*1j, 14.40+ 43.30*1j, -32.50+-46.00*1j,-19.00+-32.50*1j]])</span>

    <span class="s5">#    cB =  np.array([</span>
    <span class="s5">#   [1.00+ -5.00*1j, 1.60+  1.20*1j,-3.00+  0.00*1j, 0.00+ -1.00*1j],</span>
    <span class="s5">#   [0.80+ -0.60*1j, 3.00+ -5.00*1j,-4.00+  3.00*1j,-2.40+ -3.20*1j],</span>
    <span class="s5">#   [1.00+  0.00*1j, 2.40+  1.80*1j,-4.00+ -5.00*1j, 0.00+ -3.00*1j],</span>
    <span class="s5">#   [0.00+  1.00*1j,-1.80+  2.40*1j, 0.00+ -4.00*1j, 4.00+ -5.00*1j]])</span>

    <span class="s5">#    AAS,BBS,QS,ZS,sdim = qz(cA,cB,sort='lhp')</span>

    <span class="s5">#    eigenvalues = diag(AAS)/diag(BBS)</span>
    <span class="s5">#    assert_(np.all(np.real(eigenvalues[:sdim] &lt; 0)))</span>
    <span class="s5">#    assert_(np.all(np.real(eigenvalues[sdim:] &gt; 0)))</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">([</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">])</span>
        <span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z </span><span class="s2">= </span><span class="s1">qz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">check_finite</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">eye</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">) &gt;= </span><span class="s4">0</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">TestOrdQZ</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
        <span class="s5"># https://www.nag.com/lapack-ex/node119.html</span>
        <span class="s1">A1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">21.10 </span><span class="s2">- </span><span class="s4">22.50j</span><span class="s2">, </span><span class="s4">53.5 </span><span class="s2">- </span><span class="s4">50.5j</span><span class="s2">, -</span><span class="s4">34.5 </span><span class="s2">+ </span><span class="s4">127.5j</span><span class="s2">,</span>
                        <span class="s4">7.5 </span><span class="s2">+ </span><span class="s4">0.5j</span><span class="s2">],</span>
                       <span class="s2">[-</span><span class="s4">0.46 </span><span class="s2">- </span><span class="s4">7.78j</span><span class="s2">, -</span><span class="s4">3.5 </span><span class="s2">- </span><span class="s4">37.5j</span><span class="s2">, -</span><span class="s4">15.5 </span><span class="s2">+ </span><span class="s4">58.5j</span><span class="s2">,</span>
                        <span class="s2">-</span><span class="s4">10.5 </span><span class="s2">- </span><span class="s4">1.5j</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">4.30 </span><span class="s2">- </span><span class="s4">5.50j</span><span class="s2">, </span><span class="s4">39.7 </span><span class="s2">- </span><span class="s4">17.1j</span><span class="s2">, -</span><span class="s4">68.5 </span><span class="s2">+ </span><span class="s4">12.5j</span><span class="s2">,</span>
                        <span class="s2">-</span><span class="s4">7.5 </span><span class="s2">- </span><span class="s4">3.5j</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">5.50 </span><span class="s2">+ </span><span class="s4">4.40j</span><span class="s2">, </span><span class="s4">14.4 </span><span class="s2">+ </span><span class="s4">43.3j</span><span class="s2">, -</span><span class="s4">32.5 </span><span class="s2">- </span><span class="s4">46.0j</span><span class="s2">,</span>
                        <span class="s2">-</span><span class="s4">19.0 </span><span class="s2">- </span><span class="s4">32.5j</span><span class="s2">]])</span>

        <span class="s1">B1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1.0 </span><span class="s2">- </span><span class="s4">5.0j</span><span class="s2">, </span><span class="s4">1.6 </span><span class="s2">+ </span><span class="s4">1.2j</span><span class="s2">, -</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">0j</span><span class="s2">, </span><span class="s4">0.0 </span><span class="s2">- </span><span class="s4">1.0j</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">0.8 </span><span class="s2">- </span><span class="s4">0.6j</span><span class="s2">, </span><span class="s4">.0 </span><span class="s2">- </span><span class="s4">5.0j</span><span class="s2">, -</span><span class="s4">4 </span><span class="s2">+ </span><span class="s4">3j</span><span class="s2">, -</span><span class="s4">2.4 </span><span class="s2">- </span><span class="s4">3.2j</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1.0 </span><span class="s2">+ </span><span class="s4">0.0j</span><span class="s2">, </span><span class="s4">2.4 </span><span class="s2">+ </span><span class="s4">1.8j</span><span class="s2">, -</span><span class="s4">4 </span><span class="s2">- </span><span class="s4">5j</span><span class="s2">, </span><span class="s4">0.0 </span><span class="s2">- </span><span class="s4">3.0j</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">0.0 </span><span class="s2">+ </span><span class="s4">1.0j</span><span class="s2">, -</span><span class="s4">1.8 </span><span class="s2">+ </span><span class="s4">2.4j</span><span class="s2">, </span><span class="s4">0 </span><span class="s2">- </span><span class="s4">4j</span><span class="s2">, </span><span class="s4">4.0 </span><span class="s2">- </span><span class="s4">5.0j</span><span class="s2">]])</span>

        <span class="s5"># https://www.nag.com/numeric/fl/nagdoc_fl23/xhtml/F08/f08yuf.xml</span>
        <span class="s1">A2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">3.9</span><span class="s2">, </span><span class="s4">12.5</span><span class="s2">, -</span><span class="s4">34.5</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">4.3</span><span class="s2">, </span><span class="s4">21.5</span><span class="s2">, -</span><span class="s4">47.5</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">4.3</span><span class="s2">, </span><span class="s4">21.5</span><span class="s2">, -</span><span class="s4">43.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">4.4</span><span class="s2">, </span><span class="s4">26.0</span><span class="s2">, -</span><span class="s4">46.0</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">]])</span>

        <span class="s1">B2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, -</span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, -</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, -</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>

        <span class="s5"># example with the eigenvalues</span>
        <span class="s5"># -0.33891648, 1.61217396+0.74013521j, 1.61217396-0.74013521j,</span>
        <span class="s5"># 0.61244091</span>
        <span class="s5"># thus featuring:</span>
        <span class="s5">#  * one complex conjugate eigenvalue pair,</span>
        <span class="s5">#  * one eigenvalue in the lhp</span>
        <span class="s5">#  * 2 eigenvalues in the unit circle</span>
        <span class="s5">#  * 2 non-real eigenvalues</span>
        <span class="s1">A3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">5.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">4.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">7.</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">7.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">8.</span><span class="s2">, </span><span class="s4">7.</span><span class="s2">]])</span>
        <span class="s1">B3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">8.</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">, </span><span class="s4">10.</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">7.</span><span class="s2">, </span><span class="s4">7.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">9.</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">9.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">5.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">7.</span><span class="s2">]])</span>

        <span class="s5"># example with infinite eigenvalues</span>
        <span class="s1">A4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">B4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>

        <span class="s5"># example with (alpha, beta) = (0, 0)</span>
        <span class="s1">A5 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>

        <span class="s1">cls</span><span class="s2">.</span><span class="s1">A </span><span class="s2">= [</span><span class="s1">A1</span><span class="s2">, </span><span class="s1">A2</span><span class="s2">, </span><span class="s1">A3</span><span class="s2">, </span><span class="s1">A4</span><span class="s2">, </span><span class="s1">A5</span><span class="s2">]</span>
        <span class="s1">cls</span><span class="s2">.</span><span class="s1">B </span><span class="s2">= [</span><span class="s1">B1</span><span class="s2">, </span><span class="s1">B2</span><span class="s2">, </span><span class="s1">B3</span><span class="s2">, </span><span class="s1">B4</span><span class="s2">, </span><span class="s1">A5</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">qz_decomp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">all</span><span class="s2">=</span><span class="s6">'raise'</span><span class="s2">):</span>
            <span class="s1">ret </span><span class="s2">= [</span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">Ai</span><span class="s2">, </span><span class="s1">Bi</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s1">sort</span><span class="s2">) </span><span class="s0">for </span><span class="s1">Ai</span><span class="s2">, </span><span class="s1">Bi </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">A</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">B</span><span class="s2">)]</span>
        <span class="s0">return </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">, </span><span class="s1">AA</span><span class="s2">, </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">, </span><span class="s1">Q</span><span class="s2">, </span><span class="s1">Z</span><span class="s2">):</span>
        <span class="s1">Id </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(*</span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s5"># make sure Q and Z are orthogonal</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">Q</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">Id</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Z </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">.</span><span class="s1">conj</span><span class="s2">(), </span><span class="s1">Id</span><span class="s2">)</span>
        <span class="s5"># check factorization</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">AA</span><span class="s2">, </span><span class="s1">A </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">Q </span><span class="s2">@ </span><span class="s1">BB</span><span class="s2">, </span><span class="s1">B </span><span class="s2">@ </span><span class="s1">Z</span><span class="s2">)</span>
        <span class="s5"># check shape of AA and BB</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tril</span><span class="s2">(</span><span class="s1">AA</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">AA</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">tril</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">))</span>
        <span class="s5"># check eigenvalues</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]):</span>
            <span class="s5"># does the current diagonal element belong to a 2-by-2 block</span>
            <span class="s5"># that was already checked?</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">A</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i </span><span class="s2">- </span><span class="s4">1</span><span class="s2">] != </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s0">continue</span>
            <span class="s5"># take care of 2-by-2 blocks</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">AA</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] - </span><span class="s4">1 </span><span class="s0">and </span><span class="s1">AA</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">] != </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">evals</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">eig</span><span class="s2">(</span><span class="s1">AA</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">, </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">], </span><span class="s1">BB</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">, </span><span class="s1">i</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">])</span>
                <span class="s5"># make sure the pair of complex conjugate eigenvalues</span>
                <span class="s5"># is ordered consistently (positive imaginary part first)</span>
                <span class="s0">if </span><span class="s1">evals</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">imag </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">evals </span><span class="s2">= </span><span class="s1">evals</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
                <span class="s1">tmp </span><span class="s2">= </span><span class="s1">alpha</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">]/</span><span class="s1">beta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">tmp</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">imag </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">tmp </span><span class="s2">= </span><span class="s1">tmp</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]]</span>
                <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">evals</span><span class="s2">, </span><span class="s1">tmp</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">alpha</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">beta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">AA</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">], </span><span class="s4">0</span><span class="s2">)</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">], </span><span class="s4">0</span><span class="s2">)</span>
                <span class="s0">elif </span><span class="s1">beta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] == </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">BB</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">], </span><span class="s4">0</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">AA</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">]/</span><span class="s1">BB</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]/</span><span class="s1">beta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>
        <span class="s1">sortfun </span><span class="s2">= </span><span class="s1">_select_function</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>
        <span class="s1">lastsort </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]):</span>
            <span class="s1">cursort </span><span class="s2">= </span><span class="s1">sortfun</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">alpha</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">beta</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]]))</span>
            <span class="s5"># once the sorting criterion was not matched all subsequent</span>
            <span class="s5"># eigenvalues also shouldn't match</span>
            <span class="s0">if not </span><span class="s1">lastsort</span><span class="s2">:</span>
                <span class="s0">assert not </span><span class="s1">cursort</span>
            <span class="s1">lastsort </span><span class="s2">= </span><span class="s1">cursort</span>

    <span class="s0">def </span><span class="s1">check_all</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">):</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">qz_decomp</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">reti</span><span class="s2">, </span><span class="s1">Ai</span><span class="s2">, </span><span class="s1">Bi </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">A</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">B</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">check</span><span class="s2">(</span><span class="s1">Ai</span><span class="s2">, </span><span class="s1">Bi</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">, *</span><span class="s1">reti</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lhp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_all</span><span class="s2">(</span><span class="s6">'lhp'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rhp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_all</span><span class="s2">(</span><span class="s6">'rhp'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_iuc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_all</span><span class="s2">(</span><span class="s6">'iuc'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ouc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_all</span><span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ref</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># real eigenvalues first (top-left corner)</span>
        <span class="s0">def </span><span class="s1">sort</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
            <span class="s1">nonzero </span><span class="s2">= (</span><span class="s1">y </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">[~</span><span class="s1">nonzero</span><span class="s2">] = </span><span class="s0">False</span>
            <span class="s1">out</span><span class="s2">[</span><span class="s1">nonzero</span><span class="s2">] = (</span><span class="s1">x</span><span class="s2">[</span><span class="s1">nonzero</span><span class="s2">]/</span><span class="s1">y</span><span class="s2">[</span><span class="s1">nonzero</span><span class="s2">]).</span><span class="s1">imag </span><span class="s2">== </span><span class="s4">0</span>
            <span class="s0">return </span><span class="s1">out</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_all</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cef</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># complex eigenvalues first (top-left corner)</span>
        <span class="s0">def </span><span class="s1">sort</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
            <span class="s1">out </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)</span>
            <span class="s1">nonzero </span><span class="s2">= (</span><span class="s1">y </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s1">out</span><span class="s2">[~</span><span class="s1">nonzero</span><span class="s2">] = </span><span class="s0">False</span>
            <span class="s1">out</span><span class="s2">[</span><span class="s1">nonzero</span><span class="s2">] = (</span><span class="s1">x</span><span class="s2">[</span><span class="s1">nonzero</span><span class="s2">]/</span><span class="s1">y</span><span class="s2">[</span><span class="s1">nonzero</span><span class="s2">]).</span><span class="s1">imag </span><span class="s2">!= </span><span class="s4">0</span>
            <span class="s0">return </span><span class="s1">out</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">check_all</span><span class="s2">(</span><span class="s1">sort</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_diff_input_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">ret </span><span class="s2">= </span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">A</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">B</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">sort</span><span class="s2">=</span><span class="s6">'lhp'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">A</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">B</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s6">'lhp'</span><span class="s2">, *</span><span class="s1">ret</span><span class="s2">)</span>

        <span class="s1">ret </span><span class="s2">= </span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">B</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">A</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">sort</span><span class="s2">=</span><span class="s6">'lhp'</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">check</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">B</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">A</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s6">'lhp'</span><span class="s2">, *</span><span class="s1">ret</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sort_explicit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test order of the eigenvalues in the 2 x 2 case where we can</span>
        <span class="s5"># explicitly compute the solution</span>
        <span class="s1">A1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">B1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s1">expected1 </span><span class="s2">= [(</span><span class="s6">'lhp'</span><span class="s2">, [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'rhp'</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'iuc'</span><span class="s2">, [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">])]</span>
        <span class="s1">A2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">B2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([-</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">, </span><span class="s4">0.5 </span><span class="s2">+ </span><span class="s4">0.5j</span><span class="s2">])</span>
        <span class="s1">expected2 </span><span class="s2">= [(</span><span class="s6">'lhp'</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">/(-</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">), </span><span class="s4">1</span><span class="s2">/(</span><span class="s4">0.5 </span><span class="s2">+ </span><span class="s4">0.5j</span><span class="s2">)]),</span>
                     <span class="s2">(</span><span class="s6">'rhp'</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">/(</span><span class="s4">0.5 </span><span class="s2">+ </span><span class="s4">0.5j</span><span class="s2">), </span><span class="s4">1</span><span class="s2">/(-</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">)]),</span>
                     <span class="s2">(</span><span class="s6">'iuc'</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">/(-</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">), </span><span class="s4">1</span><span class="s2">/(</span><span class="s4">0.5 </span><span class="s2">+ </span><span class="s4">0.5j</span><span class="s2">)]),</span>
                     <span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">/(</span><span class="s4">0.5 </span><span class="s2">+ </span><span class="s4">0.5j</span><span class="s2">), </span><span class="s4">1</span><span class="s2">/(-</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">)])]</span>
        <span class="s5"># 'lhp' is ambiguous so don't test it</span>
        <span class="s1">A3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">B3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">expected3 </span><span class="s2">= [(</span><span class="s6">'rhp'</span><span class="s2">, [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'iuc'</span><span class="s2">, [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])]</span>
        <span class="s5"># 'rhp' is ambiguous so don't test it</span>
        <span class="s1">A4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">B4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
        <span class="s1">expected4 </span><span class="s2">= [(</span><span class="s6">'lhp'</span><span class="s2">, [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'iuc'</span><span class="s2">, [-</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">])]</span>
        <span class="s1">A5 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">B5 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">])</span>
        <span class="s5"># 'lhp' and 'iuc' are ambiguous so don't test them</span>
        <span class="s1">expected5 </span><span class="s2">= [(</span><span class="s6">'rhp'</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]),</span>
                     <span class="s2">(</span><span class="s6">'ouc'</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])]</span>

        <span class="s1">A </span><span class="s2">= [</span><span class="s1">A1</span><span class="s2">, </span><span class="s1">A2</span><span class="s2">, </span><span class="s1">A3</span><span class="s2">, </span><span class="s1">A4</span><span class="s2">, </span><span class="s1">A5</span><span class="s2">]</span>
        <span class="s1">B </span><span class="s2">= [</span><span class="s1">B1</span><span class="s2">, </span><span class="s1">B2</span><span class="s2">, </span><span class="s1">B3</span><span class="s2">, </span><span class="s1">B4</span><span class="s2">, </span><span class="s1">B5</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s1">expected1</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">, </span><span class="s1">expected3</span><span class="s2">, </span><span class="s1">expected4</span><span class="s2">, </span><span class="s1">expected5</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">Ai</span><span class="s2">, </span><span class="s1">Bi</span><span class="s2">, </span><span class="s1">expectedi </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">sortstr</span><span class="s2">, </span><span class="s1">expected_eigvals </span><span class="s0">in </span><span class="s1">expectedi</span><span class="s2">:</span>
                <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">Ai</span><span class="s2">, </span><span class="s1">Bi</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s1">sortstr</span><span class="s2">)</span>
                <span class="s1">azero </span><span class="s2">= (</span><span class="s1">alpha </span><span class="s2">== </span><span class="s4">0</span><span class="s2">)</span>
                <span class="s1">bzero </span><span class="s2">= (</span><span class="s1">beta </span><span class="s2">== </span><span class="s4">0</span><span class="s2">)</span>
                <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty_like</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">)</span>
                <span class="s1">x</span><span class="s2">[</span><span class="s1">azero </span><span class="s2">&amp; </span><span class="s1">bzero</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
                <span class="s1">x</span><span class="s2">[~</span><span class="s1">azero </span><span class="s2">&amp; </span><span class="s1">bzero</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
                <span class="s1">x</span><span class="s2">[~</span><span class="s1">bzero</span><span class="s2">] = </span><span class="s1">alpha</span><span class="s2">[~</span><span class="s1">bzero</span><span class="s2">]/</span><span class="s1">beta</span><span class="s2">[~</span><span class="s1">bzero</span><span class="s2">]</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">expected_eigvals</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestOrdQZWorkspaceSize</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">fail_slow</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_decompose</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s4">202</span>
        <span class="s5"># raises error if lwork parameter to dtrsen is too small</span>
        <span class="s0">for </span><span class="s1">ddtype </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">]:</span>
            <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">ddtype</span><span class="s2">)</span>
            <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">ddtype</span><span class="s2">)</span>
            <span class="s5"># sort = lambda ar, ai, b: ar**2 + ai**2 &lt; b**2</span>
            <span class="s1">_ </span><span class="s2">= </span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">: </span><span class="s1">alpha </span><span class="s2">&lt; </span><span class="s1">beta</span><span class="s2">,</span>
                      <span class="s1">output</span><span class="s2">=</span><span class="s6">'real'</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">ddtype </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">]:</span>
            <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">ddtype</span><span class="s2">)</span>
            <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">ddtype</span><span class="s2">)</span>
            <span class="s1">_ </span><span class="s2">= </span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">: </span><span class="s1">alpha </span><span class="s2">&lt; </span><span class="s1">beta</span><span class="s2">,</span>
                      <span class="s1">output</span><span class="s2">=</span><span class="s6">'complex'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_decompose_ouc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">N </span><span class="s2">= </span><span class="s4">202</span>
        <span class="s5"># segfaults if lwork parameter to dtrsen is too small</span>
        <span class="s0">for </span><span class="s1">ddtype </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">]:</span>
            <span class="s1">A </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">ddtype</span><span class="s2">)</span>
            <span class="s1">B </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">N</span><span class="s2">, </span><span class="s1">N</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">ddtype</span><span class="s2">)</span>
            <span class="s1">S</span><span class="s2">, </span><span class="s1">T</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">beta</span><span class="s2">, </span><span class="s1">U</span><span class="s2">, </span><span class="s1">V </span><span class="s2">= </span><span class="s1">ordqz</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">, </span><span class="s1">sort</span><span class="s2">=</span><span class="s6">'ouc'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDatacopied</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_datacopied</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">_decomp </span><span class="s0">import </span><span class="s1">_datacopied</span>

        <span class="s1">M </span><span class="s2">= </span><span class="s1">matrix</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">M</span><span class="s2">)</span>
        <span class="s1">L </span><span class="s2">= </span><span class="s1">M</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">()</span>
        <span class="s1">M2 </span><span class="s2">= </span><span class="s1">M</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s0">class </span><span class="s1">Fake1</span><span class="s2">:</span>
            <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
                <span class="s0">return </span><span class="s1">A</span>

        <span class="s0">class </span><span class="s1">Fake2</span><span class="s2">:</span>
            <span class="s1">__array_interface__ </span><span class="s2">= </span><span class="s1">A</span><span class="s2">.</span><span class="s1">__array_interface__</span>

        <span class="s1">F1 </span><span class="s2">= </span><span class="s1">Fake1</span><span class="s2">()</span>
        <span class="s1">F2 </span><span class="s2">= </span><span class="s1">Fake2</span><span class="s2">()</span>

        <span class="s0">for </span><span class="s1">item</span><span class="s2">, </span><span class="s1">status </span><span class="s0">in </span><span class="s2">[(</span><span class="s1">M</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s1">A</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s1">L</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
                             <span class="s2">(</span><span class="s1">M2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s1">F1</span><span class="s2">, </span><span class="s0">False</span><span class="s2">), (</span><span class="s1">F2</span><span class="s2">, </span><span class="s0">False</span><span class="s2">)]:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">item</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">_datacopied</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">item</span><span class="s2">), </span><span class="s1">status</span><span class="s2">,</span>
                         <span class="s1">err_msg</span><span class="s2">=</span><span class="s1">repr</span><span class="s2">(</span><span class="s1">item</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_aligned_mem_float</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check linalg works with non-aligned memory (float32)&quot;&quot;&quot;</span>
    <span class="s5"># Allocate 402 bytes of memory (allocated on boundary)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s4">402</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>

    <span class="s5"># Create an array with boundary offset 4</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float32</span><span class="s2">)</span>
    <span class="s1">z</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span>

    <span class="s1">eig</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">eig</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s6">'ppc64le'</span><span class="s2">,</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;crashes on ppc64le&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_aligned_mem</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check linalg works with non-aligned memory (float64)&quot;&quot;&quot;</span>
    <span class="s5"># Allocate 804 bytes of memory (allocated on boundary)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">arange</span><span class="s2">(</span><span class="s4">804</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>

    <span class="s5"># Create an array with boundary offset 4</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">z</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span>

    <span class="s1">eig</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">eig</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_aligned_mem_complex</span><span class="s2">():</span>
    <span class="s3">&quot;&quot;&quot;Check that complex objects don't need to be completely aligned&quot;&quot;&quot;</span>
    <span class="s5"># Allocate 1608 bytes of memory (allocated on boundary)</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">zeros</span><span class="s2">(</span><span class="s4">1608</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>

    <span class="s5"># Create an array with boundary offset 8</span>
    <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s4">8</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">complex</span><span class="s2">)</span>
    <span class="s1">z</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span>

    <span class="s1">eig</span><span class="s2">(</span><span class="s1">z</span><span class="s2">, </span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s5"># This does not need special handling</span>
    <span class="s1">eig</span><span class="s2">(</span><span class="s1">z</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_lapack_misaligned</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">):</span>
    <span class="s1">args </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">args</span><span class="s2">[:]</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>
            <span class="s5"># Try misaligning a[i]</span>
            <span class="s1">aa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">size</span><span class="s2">*</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">itemsize</span><span class="s2">+</span><span class="s4">8</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
            <span class="s1">aa </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">size</span><span class="s2">,</span>
                               <span class="s1">dtype</span><span class="s2">=</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s1">aa</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">shape</span>
            <span class="s1">aa</span><span class="s2">[...] = </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">aa</span>
            <span class="s1">func</span><span class="s2">(*</span><span class="s1">a</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">shape</span><span class="s2">) &gt; </span><span class="s4">1</span><span class="s2">:</span>
                <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">T</span>
                <span class="s1">func</span><span class="s2">(*</span><span class="s1">a</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">run</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                   <span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;Ticket #1152, triggers a segfault in rare cases.&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_lapack_misaligned</span><span class="s2">():</span>
    <span class="s1">M </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">R </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">100</span><span class="s2">)</span>
    <span class="s1">R</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span>
    <span class="s1">S </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">20000</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
    <span class="s1">S </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">frombuffer</span><span class="s2">(</span><span class="s1">S</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">count</span><span class="s2">=</span><span class="s4">100</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">S</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">= </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">LU</span><span class="s2">, </span><span class="s1">piv </span><span class="s2">= </span><span class="s1">lu_factor</span><span class="s2">(</span><span class="s1">S</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">) </span><span class="s0">in </span><span class="s2">[</span>
            <span class="s2">(</span><span class="s1">eig</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">(</span><span class="s1">eigvals</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">lu</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">lu_factor</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">lu_solve</span><span class="s2">, ((</span><span class="s1">LU</span><span class="s2">, </span><span class="s1">piv</span><span class="s2">), </span><span class="s1">b</span><span class="s2">), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_b</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">solve</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">overwrite_b</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s1">svd</span><span class="s2">, (</span><span class="s1">M</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">svd</span><span class="s2">, (</span><span class="s1">R</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">svd</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">(</span><span class="s1">svdvals</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">()),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">svdvals</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">(</span><span class="s1">cholesky</span><span class="s2">, (</span><span class="s1">M</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># no crash</span>
            <span class="s2">(</span><span class="s1">qr</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">(</span><span class="s1">rq</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">(</span><span class="s1">hessenberg</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">(</span><span class="s1">schur</span><span class="s2">, (</span><span class="s1">S</span><span class="s2">,), </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">overwrite_a</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)),  </span><span class="s5"># crash</span>
            <span class="s2">]:</span>
        <span class="s1">check_lapack_misaligned</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">)</span>
<span class="s5"># not properly tested</span>
<span class="s5"># cholesky, rsf2csf, lu_solve, solve, eig_banded, eigvals_banded, eigh, diagsvd</span>


<span class="s0">class </span><span class="s1">TestOverwrite</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_eig</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eig</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eig</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_eigh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eigh</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eigh</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_eig_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eig_banded</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_eigvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eigvals</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_eigvalsh</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eigvalsh</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_eigvals_banded</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">eigvals_banded</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_hessenberg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">hessenberg</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_lu_factor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">lu_factor</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_lu_solve</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">], [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]])</span>
        <span class="s1">xlu </span><span class="s2">= </span><span class="s1">lu_factor</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">b</span><span class="s2">: </span><span class="s1">lu_solve</span><span class="s2">(</span><span class="s1">xlu</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), [(</span><span class="s4">3</span><span class="s2">,)])</span>

    <span class="s0">def </span><span class="s1">test_lu</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">lu</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_qr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">qr</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_rq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">rq</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_schur</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">schur</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_schur_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">schur</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s6">'complex'</span><span class="s2">), [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)],</span>
                            <span class="s1">dtypes</span><span class="s2">=[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_svd</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">svd</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s2">: </span><span class="s1">svd</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">lapack_driver</span><span class="s2">=</span><span class="s6">'gesvd'</span><span class="s2">), [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_svdvals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">assert_no_overwrite</span><span class="s2">(</span><span class="s1">svdvals</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)])</span>


<span class="s0">def </span><span class="s1">_check_orth</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">skip_big</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span>
    <span class="s1">tol </span><span class="s2">= </span><span class="s4">1000 </span><span class="s2">* </span><span class="s1">eps</span>

    <span class="s1">Y </span><span class="s2">= </span><span class="s1">orth</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>

    <span class="s1">Y </span><span class="s2">= </span><span class="s1">orth</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>
    <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">n </span><span class="s2">&gt; </span><span class="s4">5 </span><span class="s0">and not </span><span class="s1">skip_big</span><span class="s2">:</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">) @ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">X </span><span class="s2">+ </span><span class="s4">1e-4 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">1</span><span class="s2">) @ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">Y </span><span class="s2">= </span><span class="s1">orth</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>

        <span class="s1">Y </span><span class="s2">= </span><span class="s1">orth</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">).</span><span class="s1">itemsize </span><span class="s2">&lt; </span><span class="s4">8</span><span class="s2">,</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s6">&quot;test only on 64-bit, else too slow&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_orth_memory_efficiency</span><span class="s2">():</span>
    <span class="s5"># Pick n so that 16*n bytes is reasonable but 8*n*n bytes is unreasonable.</span>
    <span class="s5"># Keep in mind that @pytest.mark.slow tests are likely to be running</span>
    <span class="s5"># under configurations that support 4Gb+ memory for tests related to</span>
    <span class="s5"># 32 bit overflow.</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span><span class="s2">*</span><span class="s4">1000</span><span class="s2">*</span><span class="s4">1000</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">_check_orth</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">skip_big</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">MemoryError </span><span class="s0">as </span><span class="s1">e</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span>
            <span class="s6">'memory error perhaps caused by orth regression'</span>
        <span class="s2">) </span><span class="s0">from </span><span class="s1">e</span>


<span class="s0">def </span><span class="s1">test_orth</span><span class="s2">():</span>
    <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">]</span>
    <span class="s1">sizes </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">100</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">):</span>
        <span class="s1">_check_orth</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">)</span>

<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_orth_empty</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">):</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
    <span class="s1">a0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>

    <span class="s1">oa </span><span class="s2">= </span><span class="s1">orth</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">oa</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">orth</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">).</span><span class="s1">dtype</span>
    <span class="s0">assert </span><span class="s1">oa</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_null_space</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">dtypes </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex128</span><span class="s2">]</span>
    <span class="s1">sizes </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">100</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">sizes</span><span class="s2">):</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>

        <span class="s1">eps </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">).</span><span class="s1">eps</span>
        <span class="s1">tol </span><span class="s2">= </span><span class="s4">1000 </span><span class="s2">* </span><span class="s1">eps</span>

        <span class="s1">Y </span><span class="s2">= </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">-</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X </span><span class="s2">@ </span><span class="s1">Y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>

        <span class="s1">Y </span><span class="s2">= </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T </span><span class="s2">@ </span><span class="s1">Y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>

        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">n</span><span class="s2">//</span><span class="s4">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">Y </span><span class="s2">= </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s4">1 </span><span class="s2">- </span><span class="s1">n</span><span class="s2">//</span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X </span><span class="s2">@ </span><span class="s1">Y</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">n </span><span class="s2">&gt; </span><span class="s4">5</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">) @ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">X </span><span class="s2">= </span><span class="s1">X </span><span class="s2">+ </span><span class="s4">1e-4 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">1</span><span class="s2">) @ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">)</span>

            <span class="s1">Y </span><span class="s2">= </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s4">5</span><span class="s2">))</span>

            <span class="s1">Y </span><span class="s2">= </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s4">6</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s6">'dt'</span><span class="s2">, [</span><span class="s1">int</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">complex</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">complex64</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_null_space_empty</span><span class="s2">(</span><span class="s1">dt</span><span class="s2">):</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
    <span class="s1">a0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dt</span><span class="s2">)</span>
    <span class="s1">nsa </span><span class="s2">= </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">nsa</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">nsa</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">null_space</span><span class="s2">(</span><span class="s1">a0</span><span class="s2">).</span><span class="s1">dtype</span>


<span class="s0">def </span><span class="s1">test_subspace_angles</span><span class="s2">():</span>
    <span class="s1">H </span><span class="s2">= </span><span class="s1">hadamard</span><span class="s2">(</span><span class="s4">8</span><span class="s2">, </span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">H</span><span class="s2">[:, :</span><span class="s4">3</span><span class="s2">]</span>
    <span class="s1">B </span><span class="s2">= </span><span class="s1">H</span><span class="s2">[:, </span><span class="s4">3</span><span class="s2">:]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">), [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s4">2.</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">B</span><span class="s2">, </span><span class="s1">A</span><span class="s2">), [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">/ </span><span class="s4">2.</span><span class="s2">] * </span><span class="s4">3</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">):</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]),</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s5"># From MATLAB function &quot;subspace&quot;, which effectively only returns the</span>
    <span class="s5"># last value that we calculate</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0.537667139546100</span><span class="s2">, </span><span class="s4">0.318765239858981</span><span class="s2">, </span><span class="s4">3.578396939725760</span><span class="s2">, </span><span class="s4">0.725404224946106</span><span class="s2">],  </span><span class="s5"># noqa: E501</span>
         <span class="s2">[</span><span class="s4">1.833885014595086</span><span class="s2">, -</span><span class="s4">1.307688296305273</span><span class="s2">, </span><span class="s4">2.769437029884877</span><span class="s2">, -</span><span class="s4">0.063054873189656</span><span class="s2">],  </span><span class="s5"># noqa: E501</span>
         <span class="s2">[-</span><span class="s4">2.258846861003648</span><span class="s2">, -</span><span class="s4">0.433592022305684</span><span class="s2">, -</span><span class="s4">1.349886940156521</span><span class="s2">, </span><span class="s4">0.714742903826096</span><span class="s2">],  </span><span class="s5"># noqa: E501</span>
         <span class="s2">[</span><span class="s4">0.862173320368121</span><span class="s2">, </span><span class="s4">0.342624466538650</span><span class="s2">, </span><span class="s4">3.034923466331855</span><span class="s2">, -</span><span class="s4">0.204966058299775</span><span class="s2">]])  </span><span class="s5"># noqa: E501</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">1.481454682101605</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">2</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">:])[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">,</span>
                    <span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, </span><span class="s4">2</span><span class="s2">:], </span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">2</span><span class="s2">])[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">,</span>
                    <span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">0.746361174247302</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">2</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[:, [</span><span class="s4">2</span><span class="s2">]]), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, [</span><span class="s4">2</span><span class="s2">]], </span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">2</span><span class="s2">]), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">0.487163718534313</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">3</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[:, [</span><span class="s4">3</span><span class="s2">]]), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, [</span><span class="s4">3</span><span class="s2">]], </span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">3</span><span class="s2">]), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">0.328950515907756</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:, :</span><span class="s4">2</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[:, </span><span class="s4">1</span><span class="s2">:]), [</span><span class="s1">expected</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                    <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>
    <span class="s5"># Degenerate conditions</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">subspace_angles</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">subspace_angles</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">subspace_angles</span><span class="s2">, </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">x</span><span class="s2">)</span>

    <span class="s5"># Test branch if mask.any is True:</span>
    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]])</span>
    <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                  <span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">/</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>

    <span class="s5"># Complex</span>
    <span class="s5"># second column in &quot;b&quot; does not affect result, just there so that</span>
    <span class="s5"># b can have more cols than a, and vice-versa (both conditional code paths)</span>
    <span class="s1">a </span><span class="s2">= [[</span><span class="s4">1 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s1">b </span><span class="s2">= [[</span><span class="s4">1 </span><span class="s2">- </span><span class="s4">1j</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s4">0.</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), </span><span class="s4">0.</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s5"># Empty</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>
    <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">subspace_angles</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">,)))</span>


<span class="s0">class </span><span class="s1">TestCDF2RDF</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">einsum</span><span class="s2">(</span><span class="s6">'...ij,...jk-&gt;...ik'</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">w</span><span class="s2">),</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">matmul</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_array0x0real</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># eig doesn't support 0x0 in old versions of numpy</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_array2x2_real</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_array2x2_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_array3x3_real</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_array3x3_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_1d_stacked_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># cannot test M == 0 due to bug in old numpy</span>
        <span class="s0">for </span><span class="s1">M </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">):</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">999999999</span><span class="s2">)</span>
            <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">100</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">M</span><span class="s2">)</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
            <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_random_2d_stacked_arrays</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># cannot test M == 0 due to bug in old numpy</span>
        <span class="s0">for </span><span class="s1">M </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">):</span>
            <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">M</span><span class="s2">, </span><span class="s1">M</span><span class="s2">)</span>
            <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
            <span class="s1">wr</span><span class="s2">, </span><span class="s1">vr </span><span class="s2">= </span><span class="s1">cdf2rdf</span><span class="s2">(</span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">assert_eig_valid</span><span class="s2">(</span><span class="s1">wr</span><span class="s2">, </span><span class="s1">vr</span><span class="s2">, </span><span class="s1">X</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_low_dimensionality_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">(()), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">((</span><span class="s4">2</span><span class="s2">,))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_square_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that passing a non-square array raises a ValueError.</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_swapped_v_w_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that exchanging places of w and v raises ValueError.</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">v</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_associated_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that passing non-associated eigenvectors raises a ValueError.</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">16</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_conjugate_pairs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Check that passing non-conjugate pairs raises a ValueError.</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">+</span><span class="s4">1j</span><span class="s2">]])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>

        <span class="s5"># different arrays in the stack, so not conjugate</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">+</span><span class="s4">1j</span><span class="s2">]],</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">-</span><span class="s4">1j</span><span class="s2">]],</span>
        <span class="s2">])</span>
        <span class="s1">w</span><span class="s2">, </span><span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">cdf2rdf</span><span class="s2">, </span><span class="s1">w</span><span class="s2">, </span><span class="s1">v</span><span class="s2">)</span>
</pre>
</body>
</html>