<html>
<head>
<title>test_constrainedlayout.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_constrainedlayout.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">gc</span>
<span class="s0">import </span><span class="s1">platform</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">image_comparison</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">transforms </span><span class="s0">as </span><span class="s1">mtransforms</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">gridspec</span><span class="s2">, </span><span class="s1">ticker</span>


<span class="s0">def </span><span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">, </span><span class="s1">nodec</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">locator_params</span><span class="s2">(</span><span class="s1">nbins</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s1">nodec</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">'x-label'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">'y-label'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">'Title'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xticklabels</span><span class="s2">([])</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yticklabels</span><span class="s2">([])</span>


<span class="s0">def </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">):</span>
    <span class="s1">dx</span><span class="s2">, </span><span class="s1">dy </span><span class="s2">= </span><span class="s3">0.6</span><span class="s2">, </span><span class="s3">0.6</span>
    <span class="s1">y</span><span class="s2">, </span><span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mgrid</span><span class="s2">[</span><span class="s1">slice</span><span class="s2">(-</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s1">dy</span><span class="s2">, </span><span class="s1">dy</span><span class="s2">),</span>
                    <span class="s1">slice</span><span class="s2">(-</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3 </span><span class="s2">+ </span><span class="s1">dx</span><span class="s2">, </span><span class="s1">dx</span><span class="s2">)]</span>
    <span class="s1">z </span><span class="s2">= (</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">x </span><span class="s2">/ </span><span class="s3">2. </span><span class="s2">+ </span><span class="s1">x </span><span class="s2">** </span><span class="s3">5 </span><span class="s2">+ </span><span class="s1">y </span><span class="s2">** </span><span class="s3">3</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(-</span><span class="s1">x </span><span class="s2">** </span><span class="s3">2 </span><span class="s2">- </span><span class="s1">y </span><span class="s2">** </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">pcm </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">, :-</span><span class="s3">1</span><span class="s2">], </span><span class="s1">cmap</span><span class="s2">=</span><span class="s4">'RdBu_r'</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=-</span><span class="s3">1.</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s3">1.</span><span class="s2">,</span>
                        <span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">'x-label'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">'y-label'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">'Title'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">fontsize</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">pcm</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout1.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout1</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test constrained_layout for a single subplot&quot;&quot;&quot;</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout2.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout2</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test constrained_layout for 2x2 subplots&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout3.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout3</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test constrained_layout for colorbars with subplots&quot;&quot;&quot;</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">):</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">nn </span><span class="s2">== </span><span class="s3">3</span><span class="s2">:</span>
            <span class="s1">pad </span><span class="s2">= </span><span class="s3">0.08</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pad </span><span class="s2">= </span><span class="s3">0.02  </span><span class="s6"># default</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s1">pad</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout4.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout4</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test constrained_layout for a single colorbar with subplots&quot;&quot;&quot;</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout5.png'</span><span class="s2">], </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">0.002</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_constrained_layout5</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Test constrained_layout for a single colorbar with subplots, 
    colorbar bottom 
    &quot;&quot;&quot;</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">,</span>
                 <span class="s1">use_gridspec</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">,</span>
                 <span class="s1">location</span><span class="s2">=</span><span class="s4">'bottom'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout6.png'</span><span class="s2">], </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">0.002</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_constrained_layout6</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test constrained_layout for nested gridspecs&quot;&quot;&quot;</span>
    <span class="s6"># Remove this line when this test image is regenerated.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'pcolormesh.snap'</span><span class="s2">] = </span><span class="s0">False</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s1">gsl </span><span class="s2">= </span><span class="s1">gs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">gsr </span><span class="s2">= </span><span class="s1">gs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">axsl </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">gs </span><span class="s0">in </span><span class="s1">gsl</span><span class="s2">:</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">)</span>
        <span class="s1">axsl </span><span class="s2">+= [</span><span class="s1">ax</span><span class="s2">]</span>
        <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">'x-label</span><span class="s0">\n</span><span class="s4">MultiLine'</span><span class="s2">)</span>
    <span class="s1">axsr </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">gs </span><span class="s0">in </span><span class="s1">gsr</span><span class="s2">:</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">)</span>
        <span class="s1">axsr </span><span class="s2">+= [</span><span class="s1">ax</span><span class="s2">]</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axsr</span><span class="s2">,</span>
                 <span class="s1">pad</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.99</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s4">'bottom'</span><span class="s2">,</span>
                 <span class="s1">ticks</span><span class="s2">=</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">MaxNLocator</span><span class="s2">(</span><span class="s1">nbins</span><span class="s2">=</span><span class="s3">5</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_identical_subgridspec</span><span class="s2">():</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">GS </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

    <span class="s1">GSA </span><span class="s2">= </span><span class="s1">GS</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">GSB </span><span class="s2">= </span><span class="s1">GS</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>

    <span class="s1">axa </span><span class="s2">= []</span>
    <span class="s1">axb </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">):</span>
        <span class="s1">axa </span><span class="s2">+= [</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">GSA</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])]</span>
        <span class="s1">axb </span><span class="s2">+= [</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">GSB</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])]</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s6"># check first row above second</span>
    <span class="s0">assert </span><span class="s1">axa</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">y0 </span><span class="s2">&gt; </span><span class="s1">axb</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">y1</span>


<span class="s0">def </span><span class="s1">test_constrained_layout7</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test for proper warning if fig not set in GridSpec&quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span>
        <span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=(</span><span class="s4">'There are no gridspecs with layoutgrids. '</span>
                            <span class="s4">'Possibly did not call parent GridSpec with '</span>
                            <span class="s4">'the &quot;figure&quot; keyword'</span><span class="s2">)):</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
        <span class="s1">gs </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">gsl </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpecFromSubplotSpec</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">gs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
        <span class="s1">gsr </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpecFromSubplotSpec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">gs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
        <span class="s0">for </span><span class="s1">gs </span><span class="s0">in </span><span class="s1">gsl</span><span class="s2">:</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">)</span>
        <span class="s6"># need to trigger a draw to get warning</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout8.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout8</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test for gridspecs that are not completely full&quot;&quot;&quot;</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">5</span><span class="s2">), </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s1">axs </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]:</span>
        <span class="s0">if </span><span class="s1">j </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">ilist </span><span class="s2">= [</span><span class="s3">1</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ilist </span><span class="s2">= [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">ilist</span><span class="s2">:</span>
            <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s1">j</span><span class="s2">, </span><span class="s1">i</span><span class="s2">])</span>
            <span class="s1">axs </span><span class="s2">+= [</span><span class="s1">ax</span><span class="s2">]</span>
            <span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">i </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">j </span><span class="s2">&lt; </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s3">2</span><span class="s2">, :])</span>
    <span class="s1">axs </span><span class="s2">+= [</span><span class="s1">ax</span><span class="s2">]</span>
    <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout9.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout9</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test for handling suptitle and for sharex and sharey&quot;&quot;&quot;</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">,</span>
                            <span class="s1">sharex</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_aspect</span><span class="s2">(</span><span class="s3">2.</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.01</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">'Test Suptitle'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">28</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout10.png'</span><span class="s2">],</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s3">0.032 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() == </span><span class="s4">'arm64' </span><span class="s0">else </span><span class="s3">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_constrained_layout10</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test for handling legend outside axis&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">12</span><span class="s2">), </span><span class="s1">label</span><span class="s2">=</span><span class="s4">'This is a label'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">=</span><span class="s4">'center left'</span><span class="s2">, </span><span class="s1">bbox_to_anchor</span><span class="s2">=(</span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout11.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout11</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test for multiple nested gridspecs&quot;&quot;&quot;</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">13</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
    <span class="s1">gs0 </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s1">gsl </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpecFromSubplotSpec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">gsl0 </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpecFromSubplotSpec</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">gsl</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>
    <span class="s1">axs </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">gs </span><span class="s0">in </span><span class="s1">gsl0</span><span class="s2">:</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">)</span>
        <span class="s1">axs </span><span class="s2">+= [</span><span class="s1">ax</span><span class="s2">]</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">70.</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gsl</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout11rat.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout11rat</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test for multiple nested gridspecs with width_ratios&quot;&quot;&quot;</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">3</span><span class="s2">))</span>
    <span class="s1">gs0 </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">width_ratios</span><span class="s2">=[</span><span class="s3">6</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">gsl </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpecFromSubplotSpec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">gsl0 </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpecFromSubplotSpec</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">gsl</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">height_ratios</span><span class="s2">=[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>
    <span class="s1">axs </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">gs </span><span class="s0">in </span><span class="s1">gsl0</span><span class="s2">:</span>
        <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">)</span>
        <span class="s1">axs </span><span class="s2">+= [</span><span class="s1">ax</span><span class="s2">]</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">70.</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gsl</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">9</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout12.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout12</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test that very unbalanced labeling still works.&quot;&quot;&quot;</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">8</span><span class="s2">))</span>

    <span class="s1">gs0 </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">)</span>

    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">3</span><span class="s2">:, </span><span class="s3">1</span><span class="s2">])</span>

    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">18</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">18</span><span class="s2">)</span>

    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:</span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">nodec</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">2</span><span class="s2">:</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">nodec</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs0</span><span class="s2">[</span><span class="s3">4</span><span class="s2">:, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">nodec</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">'x-label'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout13.png'</span><span class="s2">], </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">2.e-2</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_constrained_layout13</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test that padding works.&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">20.</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.02</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">wpad</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">hpad</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">w_pad</span><span class="s2">=</span><span class="s3">24.</span><span class="s2">/</span><span class="s3">72.</span><span class="s2">, </span><span class="s1">h_pad</span><span class="s2">=</span><span class="s3">24.</span><span class="s2">/</span><span class="s3">72.</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout14.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout14</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test that padding works.&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">)</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">, </span><span class="s1">aspect</span><span class="s2">=</span><span class="s3">20.</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.02</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span>
            <span class="s1">w_pad</span><span class="s2">=</span><span class="s3">3.</span><span class="s2">/</span><span class="s3">72.</span><span class="s2">, </span><span class="s1">h_pad</span><span class="s2">=</span><span class="s3">3.</span><span class="s2">/</span><span class="s3">72.</span><span class="s2">,</span>
            <span class="s1">hspace</span><span class="s2">=</span><span class="s3">0.2</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s3">0.2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout15.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout15</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test that rcparams work.&quot;&quot;&quot;</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'figure.constrained_layout.use'</span><span class="s2">] = </span><span class="s0">True</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout16.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout16</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test ax.set_position.&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">12</span><span class="s2">)</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">, </span><span class="s3">0.4</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'constrained_layout17.png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_constrained_layout17</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test uneven gridspecs&quot;&quot;&quot;</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">gridspec</span><span class="s2">.</span><span class="s1">GridSpec</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">figure</span><span class="s2">=</span><span class="s1">fig</span><span class="s2">)</span>

    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">:])</span>
    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:, </span><span class="s3">0</span><span class="s2">:</span><span class="s3">2</span><span class="s2">])</span>
    <span class="s1">ax4 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:, -</span><span class="s3">1</span><span class="s2">])</span>

    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax1</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax2</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax3</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax4</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_constrained_layout18</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test twinx&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">twinx</span><span class="s2">()</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents </span><span class="s2">== </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_constrained_layout19</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Test twiny&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">twiny</span><span class="s2">()</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">example_plot</span><span class="s2">(</span><span class="s1">ax2</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s3">24</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents </span><span class="s2">== </span><span class="s1">ax2</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_constrained_layout20</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;Smoke test cl does not mess up added Axes&quot;&quot;&quot;</span>
    <span class="s1">gx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>
    <span class="s1">img </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hypot</span><span class="s2">(</span><span class="s1">gx</span><span class="s2">, </span><span class="s1">gx</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">])</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_axes</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">mesh </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">gx</span><span class="s2">, </span><span class="s1">gx</span><span class="s2">, </span><span class="s1">img</span><span class="s2">[:-</span><span class="s3">1</span><span class="s2">, :-</span><span class="s3">1</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">mesh</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_constrained_layout21</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;#11035: repeated calls to suptitle should not alter the layout&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">&quot;Suptitle0&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">extents0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">&quot;Suptitle1&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">extents1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">extents0</span><span class="s2">, </span><span class="s1">extents1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_constrained_layout22</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot;#11035: suptitle should not be include in CL if manually positioned&quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">extents0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">&quot;Suptitle&quot;</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">extents1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">extents0</span><span class="s2">, </span><span class="s1">extents1</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_constrained_layout23</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Comment in #11035: suptitle used to cause an exception when 
    reusing a figure w/ CL with ``clear=True``. 
    &quot;&quot;&quot;</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">):</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">, </span><span class="s1">clear</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s4">&quot;123&quot;</span><span class="s2">)</span>
        <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">sub </span><span class="s2">= </span><span class="s1">gs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">subgridspec</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">f&quot;Suptitle</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'test_colorbar_location.png'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s4">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_colorbar_location</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Test that colorbar handling is as expected for various complicated 
    cases... 
    &quot;&quot;&quot;</span>
    <span class="s6"># Remove this line when this test image is regenerated.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'pcolormesh.snap'</span><span class="s2">] = </span><span class="s0">False</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pcm </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">''</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[:, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.4</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">, :</span><span class="s3">2</span><span class="s2">], </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s4">'bottom'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">:], </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s4">'bottom'</span><span class="s2">, </span><span class="s1">pad</span><span class="s2">=</span><span class="s3">0.05</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">:], </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s4">'top'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s4">'left'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pcm</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s4">'right'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_hidden_axes</span><span class="s2">():</span>
    <span class="s6"># test that if we make an Axes not visible that constrained_layout</span>
    <span class="s6"># still works.  Note the axes still takes space in the layout</span>
    <span class="s6"># (as does a gridspec slot that is empty)</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">].</span><span class="s1">set_visible</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">extents1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">extents</span><span class="s2">)</span>

    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">extents1</span><span class="s2">, [</span><span class="s3">0.045552</span><span class="s2">, </span><span class="s3">0.543288</span><span class="s2">, </span><span class="s3">0.47819</span><span class="s2">, </span><span class="s3">0.982638</span><span class="s2">], </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-5</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_colorbar_align</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">location </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'right'</span><span class="s2">, </span><span class="s4">'left'</span><span class="s2">, </span><span class="s4">'top'</span><span class="s2">, </span><span class="s4">'bottom'</span><span class="s2">]:</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
        <span class="s1">cbs </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">nn</span><span class="s2">, </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">):</span>
            <span class="s1">ax</span><span class="s2">.</span><span class="s1">tick_params</span><span class="s2">(</span><span class="s1">direction</span><span class="s2">=</span><span class="s4">'in'</span><span class="s2">)</span>
            <span class="s1">pc </span><span class="s2">= </span><span class="s1">example_pcolor</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
            <span class="s1">cb </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">location</span><span class="s2">=</span><span class="s1">location</span><span class="s2">, </span><span class="s1">shrink</span><span class="s2">=</span><span class="s3">0.6</span><span class="s2">,</span>
                              <span class="s1">pad</span><span class="s2">=</span><span class="s3">0.04</span><span class="s2">)</span>
            <span class="s1">cbs </span><span class="s2">+= [</span><span class="s1">cb</span><span class="s2">]</span>
            <span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">tick_params</span><span class="s2">(</span><span class="s1">direction</span><span class="s2">=</span><span class="s4">'in'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">nn </span><span class="s2">!= </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">xaxis</span><span class="s2">.</span><span class="s1">set_ticks</span><span class="s2">([])</span>
                <span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_ticks</span><span class="s2">([])</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xticklabels</span><span class="s2">([])</span>
                <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yticklabels</span><span class="s2">([])</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">w_pad</span><span class="s2">=</span><span class="s3">4 </span><span class="s2">/ </span><span class="s3">72</span><span class="s2">, </span><span class="s1">h_pad</span><span class="s2">=</span><span class="s3">4 </span><span class="s2">/ </span><span class="s3">72</span><span class="s2">,</span>
                                    <span class="s1">hspace</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">wspace</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">)</span>

        <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">location </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'left'</span><span class="s2">, </span><span class="s4">'right'</span><span class="s2">]:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cbs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">x0</span><span class="s2">,</span>
                                       <span class="s1">cbs</span><span class="s2">[</span><span class="s3">2</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">x0</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cbs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">x0</span><span class="s2">,</span>
                                       <span class="s1">cbs</span><span class="s2">[</span><span class="s3">3</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">x0</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cbs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">y0</span><span class="s2">,</span>
                                       <span class="s1">cbs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">y0</span><span class="s2">)</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cbs</span><span class="s2">[</span><span class="s3">2</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">y0</span><span class="s2">,</span>
                                       <span class="s1">cbs</span><span class="s2">[</span><span class="s3">3</span><span class="s2">].</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">().</span><span class="s1">y0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'test_colorbars_no_overlapV.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s4">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_colorbars_no_overlapV</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_major_formatter</span><span class="s2">(</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">NullFormatter</span><span class="s2">())</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tick_params</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'both'</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s4">'in'</span><span class="s2">)</span>
        <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">orientation</span><span class="s2">=</span><span class="s4">&quot;vertical&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">&quot;foo&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'test_colorbars_no_overlapH.png'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s4">'mpl20'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_colorbars_no_overlapH</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">&quot;foo&quot;</span><span class="s2">)</span>
    <span class="s1">axs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">set_major_formatter</span><span class="s2">(</span><span class="s1">ticker</span><span class="s2">.</span><span class="s1">NullFormatter</span><span class="s2">())</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">tick_params</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s4">'both'</span><span class="s2">, </span><span class="s1">direction</span><span class="s2">=</span><span class="s4">'in'</span><span class="s2">)</span>
        <span class="s1">im </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">]])</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">im</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">orientation</span><span class="s2">=</span><span class="s4">&quot;horizontal&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_manually_set_position</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">set_position</span><span class="s2">([</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">pp </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, [[</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">], [</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">]])</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">set_position</span><span class="s2">([</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">])</span>
    <span class="s1">pc </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">pcolormesh</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">pp </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pp</span><span class="s2">, [[</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">], [</span><span class="s3">0.44</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">]])</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'test_bboxtight.png'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s4">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s4">'bbox_inches'</span><span class="s2">: </span><span class="s4">'tight'</span><span class="s2">})</span>
<span class="s0">def </span><span class="s1">test_bboxtight</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_aspect</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'test_bbox.png'</span><span class="s2">],</span>
                  <span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">style</span><span class="s2">=</span><span class="s4">'mpl20'</span><span class="s2">,</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s4">'bbox_inches'</span><span class="s2">:</span>
                                 <span class="s1">mtransforms</span><span class="s2">.</span><span class="s1">Bbox</span><span class="s2">([[</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]])})</span>
<span class="s0">def </span><span class="s1">test_bbox</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_aspect</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_align_labels</span><span class="s2">():</span>
    <span class="s5">&quot;&quot;&quot; 
    Tests for a bug in which constrained layout and align_ylabels on 
    three unevenly sized subplots, one of whose y tick labels include 
    negative numbers, drives the non-negative subplots' y labels off 
    the edge of the plot 
    &quot;&quot;&quot;</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax3</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">,</span>
                                        <span class="s1">figsize</span><span class="s2">=(</span><span class="s3">6.4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">),</span>
                                        <span class="s1">gridspec_kw</span><span class="s2">={</span><span class="s4">&quot;height_ratios&quot;</span><span class="s2">: (</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
                                                                       <span class="s3">0.7</span><span class="s2">)})</span>

    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">&quot;Label&quot;</span><span class="s2">)</span>

    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">&quot;Label&quot;</span><span class="s2">)</span>

    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">&quot;Label&quot;</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">align_ylabels</span><span class="s2">(</span><span class="s1">axs</span><span class="s2">=(</span><span class="s1">ax3</span><span class="s2">, </span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">after_align </span><span class="s2">= [</span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_window_extent</span><span class="s2">(),</span>
                   <span class="s1">ax2</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_window_extent</span><span class="s2">(),</span>
                   <span class="s1">ax3</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">label</span><span class="s2">.</span><span class="s1">get_window_extent</span><span class="s2">()]</span>
    <span class="s6"># ensure labels are approximately aligned</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">after_align</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">after_align</span><span class="s2">[</span><span class="s3">2</span><span class="s2">].</span><span class="s1">x0</span><span class="s2">],</span>
                               <span class="s1">after_align</span><span class="s2">[</span><span class="s3">1</span><span class="s2">].</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-05</span><span class="s2">)</span>
    <span class="s6"># ensure labels do not go off the edge</span>
    <span class="s0">assert </span><span class="s1">after_align</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">x0 </span><span class="s2">&gt;= </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_suplabels</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">pos0 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">())</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">supxlabel</span><span class="s2">(</span><span class="s4">'Boo'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">supylabel</span><span class="s2">(</span><span class="s4">'Booy'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">pos </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y0 </span><span class="s2">&gt; </span><span class="s1">pos0</span><span class="s2">.</span><span class="s1">y0 </span><span class="s2">+ </span><span class="s3">10.0</span>
    <span class="s0">assert </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">&gt; </span><span class="s1">pos0</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s3">10.0</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">&quot;constrained&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">pos0 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">())</span>
    <span class="s6"># check that specifying x (y) doesn't ruin the layout</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">supxlabel</span><span class="s2">(</span><span class="s4">'Boo'</span><span class="s2">, </span><span class="s1">x</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">supylabel</span><span class="s2">(</span><span class="s4">'Boo'</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">pos </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_tightbbox</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_renderer</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y0 </span><span class="s2">&gt; </span><span class="s1">pos0</span><span class="s2">.</span><span class="s1">y0 </span><span class="s2">+ </span><span class="s3">10.0</span>
    <span class="s0">assert </span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">&gt; </span><span class="s1">pos0</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s3">10.0</span>


<span class="s0">def </span><span class="s1">test_gridspec_addressing</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">gs </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_gridspec</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">sp </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s1">gs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">:, </span><span class="s3">1</span><span class="s2">:])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_discouraged_api</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PendingDeprecationWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;will be deprecated&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_constrained_layout</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PendingDeprecationWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;will be deprecated&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_constrained_layout</span><span class="s2">({</span><span class="s4">'w_pad'</span><span class="s2">: </span><span class="s3">0.02</span><span class="s2">, </span><span class="s4">'h_pad'</span><span class="s2">: </span><span class="s3">0.02</span><span class="s2">})</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_kwargs</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">={</span><span class="s4">'h_pad'</span><span class="s2">: </span><span class="s3">0.02</span><span class="s2">})</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_rect</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">'constrained'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">rect</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">ppos </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ppos</span><span class="s2">.</span><span class="s1">x1 </span><span class="s2">&lt; </span><span class="s3">0.5</span>
    <span class="s0">assert </span><span class="s1">ppos</span><span class="s2">.</span><span class="s1">y1 </span><span class="s2">&lt; </span><span class="s3">0.5</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">layout</span><span class="s2">=</span><span class="s4">'constrained'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">get_layout_engine</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">rect</span><span class="s2">=[</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">ppos </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ppos</span><span class="s2">.</span><span class="s1">x1 </span><span class="s2">&lt; </span><span class="s3">0.5</span>
    <span class="s0">assert </span><span class="s1">ppos</span><span class="s2">.</span><span class="s1">y1 </span><span class="s2">&lt; </span><span class="s3">0.5</span>
    <span class="s0">assert </span><span class="s1">ppos</span><span class="s2">.</span><span class="s1">x0 </span><span class="s2">&gt; </span><span class="s3">0.2</span>
    <span class="s0">assert </span><span class="s1">ppos</span><span class="s2">.</span><span class="s1">y0 </span><span class="s2">&gt; </span><span class="s3">0.2</span>


<span class="s0">def </span><span class="s1">test_compressed1</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">'compressed'</span><span class="s2">,</span>
                            <span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>

    <span class="s1">pos </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s3">0.2344</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
    <span class="s1">pos </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">, </span><span class="s3">0.7024</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>

    <span class="s6"># wider than tall</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">layout</span><span class="s2">=</span><span class="s4">'compressed'</span><span class="s2">,</span>
                            <span class="s1">sharex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">sharey</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axs</span><span class="s2">.</span><span class="s1">flat</span><span class="s2">:</span>
        <span class="s1">pc </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s3">20</span><span class="s2">, </span><span class="s3">20</span><span class="s2">))</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">pc</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">axs</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>

    <span class="s1">pos </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x0</span><span class="s2">, </span><span class="s3">0.06195</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y1</span><span class="s2">, </span><span class="s3">0.8537</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
    <span class="s1">pos </span><span class="s2">= </span><span class="s1">axs</span><span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">].</span><span class="s1">get_position</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">, </span><span class="s3">0.8618</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pos</span><span class="s2">.</span><span class="s1">y0</span><span class="s2">, </span><span class="s3">0.1934</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'arg, state'</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">),</span>
    <span class="s2">({}, </span><span class="s0">True</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'rect'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">}, </span><span class="s0">True</span><span class="s2">)</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_set_constrained_layout</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">state</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s1">arg</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">() </span><span class="s0">is </span><span class="s1">state</span>


<span class="s0">def </span><span class="s1">test_constrained_toggle</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">PendingDeprecationWarning</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_constrained_layout</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">()</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_constrained_layout</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">()</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">set_constrained_layout</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">get_constrained_layout</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_layout_leak</span><span class="s2">():</span>
    <span class="s6"># Make sure there aren't any cyclic references when using LayoutGrid</span>
    <span class="s6"># GH #25853</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">figsize</span><span class="s2">=(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s4">&quot;all&quot;</span><span class="s2">)</span>
    <span class="s0">del </span><span class="s1">fig</span>
    <span class="s1">gc</span><span class="s2">.</span><span class="s1">collect</span><span class="s2">()</span>
    <span class="s0">assert not </span><span class="s1">any</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">_layoutgrid</span><span class="s2">.</span><span class="s1">LayoutGrid</span><span class="s2">)</span>
                   <span class="s0">for </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">gc</span><span class="s2">.</span><span class="s1">get_objects</span><span class="s2">())</span>
</pre>
</body>
</html>