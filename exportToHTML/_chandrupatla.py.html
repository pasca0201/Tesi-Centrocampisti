<html>
<head>
<title>_chandrupatla.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
_chandrupatla.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">math</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_elementwise_iterative_method </span><span class="s0">as </span><span class="s1">eim</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_util </span><span class="s0">import </span><span class="s1">_RichResult</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_array_api </span><span class="s0">import </span><span class="s1">xp_clip</span><span class="s2">, </span><span class="s1">xp_minimum</span><span class="s2">, </span><span class="s1">xp_sign</span>

<span class="s3"># TODO:</span>
<span class="s3"># - (maybe?) don't use fancy indexing assignment</span>
<span class="s3"># - figure out how to replace the new `try`/`except`s</span>


<span class="s0">def </span><span class="s1">_chandrupatla</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, *, </span><span class="s1">args</span><span class="s2">=(), </span><span class="s1">xatol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                  <span class="s1">fatol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Find the root of an elementwise function using Chandrupatla's algorithm. 
 
    For each element of the output of `func`, `chandrupatla` seeks the scalar 
    root that makes the element 0. This function allows for `a`, `b`, and the 
    output of `func` to be of any broadcastable shapes. 
 
    Parameters 
    ---------- 
    func : callable 
        The function whose root is desired. The signature must be:: 
 
            func(x: ndarray, *args) -&gt; ndarray 
 
         where each element of ``x`` is a finite real and ``args`` is a tuple, 
         which may contain an arbitrary number of components of any type(s). 
         ``func`` must be an elementwise function: each element ``func(x)[i]`` 
         must equal ``func(x[i])`` for all indices ``i``. `_chandrupatla` 
         seeks an array ``x`` such that ``func(x)`` is an array of zeros. 
    a, b : array_like 
        The lower and upper bounds of the root of the function. Must be 
        broadcastable with one another. 
    args : tuple, optional 
        Additional positional arguments to be passed to `func`. 
    xatol, xrtol, fatol, frtol : float, optional 
        Absolute and relative tolerances on the root and function value. 
        See Notes for details. 
    maxiter : int, optional 
        The maximum number of iterations of the algorithm to perform. 
        The default is the maximum possible number of bisections within 
        the (normal) floating point numbers of the relevant dtype. 
    callback : callable, optional 
        An optional user-supplied function to be called before the first 
        iteration and after each iteration. 
        Called as ``callback(res)``, where ``res`` is a ``_RichResult`` 
        similar to that returned by `_chandrupatla` (but containing the current 
        iterate's values of all variables). If `callback` raises a 
        ``StopIteration``, the algorithm will terminate immediately and 
        `_chandrupatla` will return a result. 
 
    Returns 
    ------- 
    res : _RichResult 
        An instance of `scipy._lib._util._RichResult` with the following 
        attributes. The descriptions are written as though the values will be 
        scalars; however, if `func` returns an array, the outputs will be 
        arrays of the same shape. 
 
        x : float 
            The root of the function, if the algorithm terminated successfully. 
        nfev : int 
            The number of times the function was called to find the root. 
        nit : int 
            The number of iterations of Chandrupatla's algorithm performed. 
        status : int 
            An integer representing the exit status of the algorithm. 
            ``0`` : The algorithm converged to the specified tolerances. 
            ``-1`` : The algorithm encountered an invalid bracket. 
            ``-2`` : The maximum number of iterations was reached. 
            ``-3`` : A non-finite value was encountered. 
            ``-4`` : Iteration was terminated by `callback`. 
            ``1`` : The algorithm is proceeding normally (in `callback` only). 
        success : bool 
            ``True`` when the algorithm terminated successfully (status ``0``). 
        fun : float 
            The value of `func` evaluated at `x`. 
        xl, xr : float 
            The lower and upper ends of the bracket. 
        fl, fr : float 
            The function value at the lower and upper ends of the bracket. 
 
    Notes 
    ----- 
    Implemented based on Chandrupatla's original paper [1]_. 
 
    If ``xl`` and ``xr`` are the left and right ends of the bracket, 
    ``xmin = xl if abs(func(xl)) &lt;= abs(func(xr)) else xr``, 
    and ``fmin0 = min(func(a), func(b))``, then the algorithm is considered to 
    have converged when ``abs(xr - xl) &lt; xatol + abs(xmin) * xrtol`` or 
    ``fun(xmin) &lt;= fatol + abs(fmin0) * frtol``. This is equivalent to the 
    termination condition described in [1]_ with ``xrtol = 4e-10``, 
    ``xatol = 1e-5``, and ``fatol = frtol = 0``. The default values are 
    ``xatol = 4*tiny``, ``xrtol = 4*eps``, ``frtol = 0``, and ``fatol = tiny``, 
    where ``eps`` and ``tiny`` are the precision and smallest normal number 
    of the result ``dtype`` of function inputs and outputs. 
 
    References 
    ---------- 
 
    .. [1] Chandrupatla, Tirupathi R. 
        &quot;A new hybrid quadratic/bisection algorithm for finding the zero of a 
        nonlinear function without using derivatives&quot;. 
        Advances in Engineering Software, 28(3), 145-149. 
        https://doi.org/10.1016/s0965-9978(96)00051-8 
 
    See Also 
    -------- 
    brentq, brenth, ridder, bisect, newton 
 
    Examples 
    -------- 
    &gt;&gt;&gt; from scipy import optimize 
    &gt;&gt;&gt; def f(x, c): 
    ...     return x**3 - 2*x - c 
    &gt;&gt;&gt; c = 5 
    &gt;&gt;&gt; res = optimize._chandrupatla._chandrupatla(f, 0, 3, args=(c,)) 
    &gt;&gt;&gt; res.x 
    2.0945514818937463 
 
    &gt;&gt;&gt; c = [3, 4, 5] 
    &gt;&gt;&gt; res = optimize._chandrupatla._chandrupatla(f, 0, 3, args=(c,)) 
    &gt;&gt;&gt; res.x 
    array([1.8932892 , 2.        , 2.09455148]) 
 
    &quot;&quot;&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_iv</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">,</span>
                           <span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">)</span>
    <span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">callback </span><span class="s2">= </span><span class="s1">res</span>

    <span class="s3"># Initialization</span>
    <span class="s1">temp </span><span class="s2">= </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_initialize</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, (</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">args</span><span class="s2">)</span>
    <span class="s1">func</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">, </span><span class="s1">fs</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">xp </span><span class="s2">= </span><span class="s1">temp</span>
    <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 </span><span class="s2">= </span><span class="s1">xs</span>
    <span class="s1">f1</span><span class="s2">, </span><span class="s1">f2 </span><span class="s2">= </span><span class="s1">fs</span>
    <span class="s1">status </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EINPROGRESS</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)  </span><span class="s3"># in progress</span>
    <span class="s1">nit</span><span class="s2">, </span><span class="s1">nfev </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2  </span><span class="s3"># two function evaluations performed above</span>
    <span class="s1">finfo </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s1">xatol </span><span class="s2">= </span><span class="s4">4</span><span class="s2">*</span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">smallest_normal </span><span class="s0">if </span><span class="s1">xatol </span><span class="s0">is None else </span><span class="s1">xatol</span>
    <span class="s1">xrtol </span><span class="s2">= </span><span class="s4">4</span><span class="s2">*</span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">eps </span><span class="s0">if </span><span class="s1">xrtol </span><span class="s0">is None else </span><span class="s1">xrtol</span>
    <span class="s1">fatol </span><span class="s2">= </span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">smallest_normal </span><span class="s0">if </span><span class="s1">fatol </span><span class="s0">is None else </span><span class="s1">fatol</span>
    <span class="s1">frtol </span><span class="s2">= </span><span class="s1">frtol </span><span class="s2">* </span><span class="s1">xp_minimum</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">f1</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">f2</span><span class="s2">))</span>
    <span class="s1">maxiter </span><span class="s2">= (</span><span class="s1">math</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">max</span><span class="s2">) - </span><span class="s1">math</span><span class="s2">.</span><span class="s1">log2</span><span class="s2">(</span><span class="s1">finfo</span><span class="s2">.</span><span class="s1">smallest_normal</span><span class="s2">)</span>
               <span class="s0">if </span><span class="s1">maxiter </span><span class="s0">is None else </span><span class="s1">maxiter</span><span class="s2">)</span>
    <span class="s1">work </span><span class="s2">= </span><span class="s1">_RichResult</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">=</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">=</span><span class="s1">f1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">=</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">=</span><span class="s1">f2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">f3</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s4">0.5</span><span class="s2">,</span>
                       <span class="s1">xatol</span><span class="s2">=</span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s1">xrtol</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s1">frtol</span><span class="s2">,</span>
                       <span class="s1">nit</span><span class="s2">=</span><span class="s1">nit</span><span class="s2">, </span><span class="s1">nfev</span><span class="s2">=</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">status</span><span class="s2">=</span><span class="s1">status</span><span class="s2">)</span>
    <span class="s1">res_work_pairs </span><span class="s2">= [(</span><span class="s6">'status'</span><span class="s2">, </span><span class="s6">'status'</span><span class="s2">), (</span><span class="s6">'x'</span><span class="s2">, </span><span class="s6">'xmin'</span><span class="s2">), (</span><span class="s6">'fun'</span><span class="s2">, </span><span class="s6">'fmin'</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s6">'nit'</span><span class="s2">, </span><span class="s6">'nit'</span><span class="s2">), (</span><span class="s6">'nfev'</span><span class="s2">, </span><span class="s6">'nfev'</span><span class="s2">), (</span><span class="s6">'xl'</span><span class="s2">, </span><span class="s6">'x1'</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s6">'fl'</span><span class="s2">, </span><span class="s6">'f1'</span><span class="s2">), (</span><span class="s6">'xr'</span><span class="s2">, </span><span class="s6">'x2'</span><span class="s2">), (</span><span class="s6">'fr'</span><span class="s2">, </span><span class="s6">'f2'</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">pre_func_eval</span><span class="s2">(</span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># [1] Figure 1 (first box)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1 </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">t </span><span class="s2">* (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">def </span><span class="s1">post_func_eval</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># [1] Figure 1 (first diamond and boxes)</span>
        <span class="s3"># Note: y/n are reversed in figure; compare to BASIC in appendix</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">, </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3 </span><span class="s2">= (</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                            <span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">f</span><span class="s2">) == </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">)</span>
        <span class="s1">nj </span><span class="s2">= ~</span><span class="s1">j</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">nj</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">nj</span><span class="s2">] = </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">nj</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">nj</span><span class="s2">]</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">, </span><span class="s1">f</span>

    <span class="s0">def </span><span class="s1">check_termination</span><span class="s2">(</span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># [1] Figure 1 (second diamond)</span>
        <span class="s3"># Check for all terminal conditions and record statuses.</span>

        <span class="s3"># See [1] Section 4 (first two sentences)</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">) &lt; </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">xmin </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">fmin </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">, </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">)  </span><span class="s3"># termination condition met</span>

        <span class="s3"># If function value tolerance is met, report successful convergence,</span>
        <span class="s3"># regardless of other conditions. Note that `frtol` has been redefined</span>
        <span class="s3"># as `frtol = frtol * minimum(f1, f2)`, where `f1` and `f2` are the</span>
        <span class="s3"># function evaluated at the original ends of the bracket.</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">) &lt;= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">fatol </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">frtol</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERGED</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span>

        <span class="s3"># If the bracket is no longer valid, report failure (unless a function</span>
        <span class="s3"># tolerance is met, as detected above).</span>
        <span class="s1">i </span><span class="s2">= (</span><span class="s1">xp_sign</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">) == </span><span class="s1">xp_sign</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)) &amp; ~</span><span class="s1">stop</span>
        <span class="s1">NaN </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">work</span><span class="s2">.</span><span class="s1">xmin</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">xmin</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">NaN</span><span class="s2">, </span><span class="s1">NaN</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ESIGNERR</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span>

        <span class="s3"># If the abscissae are non-finite or either function value is NaN,</span>
        <span class="s3"># report failure.</span>
        <span class="s1">x_nonfinite </span><span class="s2">= ~(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">) &amp; </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">))</span>
        <span class="s1">f_nan </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">) &amp; </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">i </span><span class="s2">= (</span><span class="s1">x_nonfinite </span><span class="s2">| </span><span class="s1">f_nan</span><span class="s2">) &amp; ~</span><span class="s1">stop</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">xmin</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">fmin</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">NaN</span><span class="s2">, </span><span class="s1">NaN</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EVALUEERR</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span>

        <span class="s3"># This is the convergence criterion used in bisect. Chandrupatla's</span>
        <span class="s3"># criterion is equivalent to this except with a factor of 4 on `xrtol`.</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">dx </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">)</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">tol </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">xmin</span><span class="s2">) * </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xrtol </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xatol</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">dx </span><span class="s2">&lt; </span><span class="s1">work</span><span class="s2">.</span><span class="s1">tol</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERGED</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span>

        <span class="s0">return </span><span class="s1">stop</span>

    <span class="s0">def </span><span class="s1">post_termination_check</span><span class="s2">(</span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># [1] Figure 1 (third diamond and boxes / Equation 1)</span>
        <span class="s1">xi1 </span><span class="s2">= (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">) / (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">phi1 </span><span class="s2">= (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">) / (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">alpha </span><span class="s2">= (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">) / (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">)</span>
        <span class="s1">j </span><span class="s2">= ((</span><span class="s4">1 </span><span class="s2">- </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s4">1 </span><span class="s2">- </span><span class="s1">xi1</span><span class="s2">)) &lt; </span><span class="s1">phi1</span><span class="s2">) &amp; (</span><span class="s1">phi1 </span><span class="s2">&lt; </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">xi1</span><span class="s2">))</span>

        <span class="s1">f1j</span><span class="s2">, </span><span class="s1">f2j</span><span class="s2">, </span><span class="s1">f3j</span><span class="s2">, </span><span class="s1">alphaj </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">alpha</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">alpha</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = (</span><span class="s1">f1j </span><span class="s2">/ (</span><span class="s1">f1j </span><span class="s2">- </span><span class="s1">f2j</span><span class="s2">) * </span><span class="s1">f3j </span><span class="s2">/ (</span><span class="s1">f3j </span><span class="s2">- </span><span class="s1">f2j</span><span class="s2">)</span>
                <span class="s2">- </span><span class="s1">alphaj </span><span class="s2">* </span><span class="s1">f1j </span><span class="s2">/ (</span><span class="s1">f3j </span><span class="s2">- </span><span class="s1">f1j</span><span class="s2">) * </span><span class="s1">f2j </span><span class="s2">/ (</span><span class="s1">f2j </span><span class="s2">- </span><span class="s1">f3j</span><span class="s2">))</span>

        <span class="s3"># [1] Figure 1 (last box; see also BASIC in appendix with comment</span>
        <span class="s3"># &quot;Adjust T Away from the Interval Boundary&quot;)</span>
        <span class="s1">tl </span><span class="s2">= </span><span class="s4">0.5 </span><span class="s2">* </span><span class="s1">work</span><span class="s2">.</span><span class="s1">tol </span><span class="s2">/ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">dx</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">t </span><span class="s2">= </span><span class="s1">xp_clip</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">tl</span><span class="s2">, </span><span class="s4">1 </span><span class="s2">- </span><span class="s1">tl</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">customize_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">):</span>
        <span class="s1">xl</span><span class="s2">, </span><span class="s1">xr</span><span class="s2">, </span><span class="s1">fl</span><span class="s2">, </span><span class="s1">fr </span><span class="s2">= </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xl'</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xr'</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'fl'</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'fr'</span><span class="s2">]</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xl'</span><span class="s2">] &lt; </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xr'</span><span class="s2">]</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'xl'</span><span class="s2">] = </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xr</span><span class="s2">)</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'xr'</span><span class="s2">] = </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">xr</span><span class="s2">, </span><span class="s1">xl</span><span class="s2">)</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'fl'</span><span class="s2">] = </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">fl</span><span class="s2">, </span><span class="s1">fr</span><span class="s2">)</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'fr'</span><span class="s2">] = </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, </span><span class="s1">fr</span><span class="s2">, </span><span class="s1">fl</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">shape</span>

    <span class="s0">return </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_loop</span><span class="s2">(</span><span class="s1">work</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">,</span>
                     <span class="s1">pre_func_eval</span><span class="s2">, </span><span class="s1">post_func_eval</span><span class="s2">, </span><span class="s1">check_termination</span><span class="s2">,</span>
                     <span class="s1">post_termination_check</span><span class="s2">, </span><span class="s1">customize_result</span><span class="s2">, </span><span class="s1">res_work_pairs</span><span class="s2">,</span>
                     <span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_chandrupatla_iv</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">,</span>
                     <span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">):</span>
    <span class="s3"># Input validation for `_chandrupatla`</span>

    <span class="s0">if not </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">func</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">'`func` must be callable.'</span><span class="s2">)</span>

    <span class="s0">if not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">iterable</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">args</span><span class="s2">,)</span>

    <span class="s3"># tolerances are floats, not arrays; OK to use NumPy</span>
    <span class="s1">tols </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s1">xatol </span><span class="s0">if </span><span class="s1">xatol </span><span class="s0">is not None else </span><span class="s4">1</span><span class="s2">,</span>
                       <span class="s1">xrtol </span><span class="s0">if </span><span class="s1">xrtol </span><span class="s0">is not None else </span><span class="s4">1</span><span class="s2">,</span>
                       <span class="s1">fatol </span><span class="s0">if </span><span class="s1">fatol </span><span class="s0">is not None else </span><span class="s4">1</span><span class="s2">,</span>
                       <span class="s1">frtol </span><span class="s0">if </span><span class="s1">frtol </span><span class="s0">is not None else </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">tols</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">number</span><span class="s2">) </span><span class="s0">or </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">tols </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">)</span>
            <span class="s0">or </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">tols</span><span class="s2">)) </span><span class="s0">or </span><span class="s1">tols</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">!= (</span><span class="s4">4</span><span class="s2">,)):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">'Tolerances must be non-negative scalars.'</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">maxiter </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s1">maxiter_int </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">maxiter</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">maxiter </span><span class="s2">!= </span><span class="s1">maxiter_int </span><span class="s0">or </span><span class="s1">maxiter </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">'`maxiter` must be a non-negative integer.'</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">callback </span><span class="s0">is not None and not </span><span class="s1">callable</span><span class="s2">(</span><span class="s1">callback</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s6">'`callback` must be callable.'</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">callback</span>


<span class="s0">def </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, *, </span><span class="s1">args</span><span class="s2">=(), </span><span class="s1">xatol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                           <span class="s1">xrtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s4">100</span><span class="s2">,</span>
                           <span class="s1">callback</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s5">&quot;&quot;&quot;Find the minimizer of an elementwise function. 
 
    For each element of the output of `func`, `_chandrupatla_minimize` seeks 
    the scalar minimizer that minimizes the element. This function allows for 
    `x1`, `x2`, `x3`, and the elements of `args` to be arrays of any 
    broadcastable shapes. 
 
    Parameters 
    ---------- 
    func : callable 
        The function whose minimizer is desired. The signature must be:: 
 
            func(x: ndarray, *args) -&gt; ndarray 
 
         where each element of ``x`` is a finite real and ``args`` is a tuple, 
         which may contain an arbitrary number of arrays that are broadcastable 
         with `x`. ``func`` must be an elementwise function: each element 
         ``func(x)[i]`` must equal ``func(x[i])`` for all indices ``i``. 
         `_chandrupatla` seeks an array ``x`` such that ``func(x)`` is an array 
         of minima. 
    x1, x2, x3 : array_like 
        The abscissae of a standard scalar minimization bracket. A bracket is 
        valid if ``x1 &lt; x2 &lt; x3`` and ``func(x1) &gt; func(x2) &lt;= func(x3)``. 
        Must be broadcastable with one another and `args`. 
    args : tuple, optional 
        Additional positional arguments to be passed to `func`.  Must be arrays 
        broadcastable with `x1`, `x2`, and `x3`. If the callable to be 
        differentiated requires arguments that are not broadcastable with `x`, 
        wrap that callable with `func` such that `func` accepts only `x` and 
        broadcastable arrays. 
    xatol, xrtol, fatol, frtol : float, optional 
        Absolute and relative tolerances on the minimizer and function value. 
        See Notes for details. 
    maxiter : int, optional 
        The maximum number of iterations of the algorithm to perform. 
    callback : callable, optional 
        An optional user-supplied function to be called before the first 
        iteration and after each iteration. 
        Called as ``callback(res)``, where ``res`` is a ``_RichResult`` 
        similar to that returned by `_chandrupatla_minimize` (but containing 
        the current iterate's values of all variables). If `callback` raises a 
        ``StopIteration``, the algorithm will terminate immediately and 
        `_chandrupatla_minimize` will return a result. 
 
    Returns 
    ------- 
    res : _RichResult 
        An instance of `scipy._lib._util._RichResult` with the following 
        attributes. (The descriptions are written as though the values will be 
        scalars; however, if `func` returns an array, the outputs will be 
        arrays of the same shape.) 
 
        success : bool 
            ``True`` when the algorithm terminated successfully (status ``0``). 
        status : int 
            An integer representing the exit status of the algorithm. 
            ``0`` : The algorithm converged to the specified tolerances. 
            ``-1`` : The algorithm encountered an invalid bracket. 
            ``-2`` : The maximum number of iterations was reached. 
            ``-3`` : A non-finite value was encountered. 
            ``-4`` : Iteration was terminated by `callback`. 
            ``1`` : The algorithm is proceeding normally (in `callback` only). 
        x : float 
            The minimizer of the function, if the algorithm terminated 
            successfully. 
        fun : float 
            The value of `func` evaluated at `x`. 
        nfev : int 
            The number of points at which `func` was evaluated. 
        nit : int 
            The number of iterations of the algorithm that were performed. 
        xl, xm, xr : float 
            The final three-point bracket. 
        fl, fm, fr : float 
            The function value at the bracket points. 
 
    Notes 
    ----- 
    Implemented based on Chandrupatla's original paper [1]_. 
 
    If ``x1 &lt; x2 &lt; x3`` are the points of the bracket and ``f1 &gt; f2 &lt;= f3`` 
    are the values of ``func`` at those points, then the algorithm is 
    considered to have converged when ``x3 - x1 &lt;= abs(x2)*xrtol + xatol`` 
    or ``(f1 - 2*f2 + f3)/2 &lt;= abs(f2)*frtol + fatol``. Note that first of 
    these differs from the termination conditions described in [1]_. The 
    default values of `xrtol` is the square root of the precision of the 
    appropriate dtype, and ``xatol = fatol = frtol`` is the smallest normal 
    number of the appropriate dtype. 
 
    References 
    ---------- 
    .. [1] Chandrupatla, Tirupathi R. (1998). 
        &quot;An efficient quadratic fit-sectioning algorithm for minimization 
        without derivatives&quot;. 
        Computer Methods in Applied Mechanics and Engineering, 152 (1-2), 
        211-217. https://doi.org/10.1016/S0045-7825(97)00190-4 
 
    See Also 
    -------- 
    golden, brent, bounded 
 
    Examples 
    -------- 
    &gt;&gt;&gt; from scipy.optimize._chandrupatla import _chandrupatla_minimize 
    &gt;&gt;&gt; def f(x, args=1): 
    ...     return (x - args)**2 
    &gt;&gt;&gt; res = _chandrupatla_minimize(f, -5, 0, 5) 
    &gt;&gt;&gt; res.x 
    1.0 
    &gt;&gt;&gt; c = [1, 1.5, 2] 
    &gt;&gt;&gt; res = _chandrupatla_minimize(f, -5, 0, 5, args=(c,)) 
    &gt;&gt;&gt; res.x 
    array([1. , 1.5, 2. ]) 
    &quot;&quot;&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_iv</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">,</span>
                           <span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">)</span>
    <span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">callback </span><span class="s2">= </span><span class="s1">res</span>

    <span class="s3"># Initialization</span>
    <span class="s1">xs </span><span class="s2">= (</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">)</span>
    <span class="s1">temp </span><span class="s2">= </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_initialize</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">, </span><span class="s1">args</span><span class="s2">)</span>
    <span class="s1">func</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">, </span><span class="s1">fs</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">xp </span><span class="s2">= </span><span class="s1">temp  </span><span class="s3"># line split for PEP8</span>
    <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3 </span><span class="s2">= </span><span class="s1">xs</span>
    <span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f3 </span><span class="s2">= </span><span class="s1">fs</span>
    <span class="s1">phi </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">(</span><span class="s4">0.5 </span><span class="s2">+ </span><span class="s4">0.5</span><span class="s2">*</span><span class="s4">5</span><span class="s2">**</span><span class="s4">0.5</span><span class="s2">)  </span><span class="s3"># golden ratio</span>
    <span class="s1">status </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EINPROGRESS</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">int</span><span class="s2">)  </span><span class="s3"># in progress</span>
    <span class="s1">nit</span><span class="s2">, </span><span class="s1">nfev </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3  </span><span class="s3"># three function evaluations performed above</span>
    <span class="s1">fatol </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">tiny </span><span class="s0">if </span><span class="s1">fatol </span><span class="s0">is None else </span><span class="s1">fatol</span>
    <span class="s1">frtol </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">tiny </span><span class="s0">if </span><span class="s1">frtol </span><span class="s0">is None else </span><span class="s1">frtol</span>
    <span class="s1">xatol </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">tiny </span><span class="s0">if </span><span class="s1">xatol </span><span class="s0">is None else </span><span class="s1">xatol</span>
    <span class="s1">xrtol </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">) </span><span class="s0">if </span><span class="s1">xrtol </span><span class="s0">is None else </span><span class="s1">xrtol</span>

    <span class="s3"># Ensure that x1 &lt; x2 &lt; x3 initially.</span>
    <span class="s1">xs</span><span class="s2">, </span><span class="s1">fs </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">((</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">)), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vstack</span><span class="s2">((</span><span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f3</span><span class="s2">))</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">take_along_axis</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f3 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">take_along_axis</span><span class="s2">(</span><span class="s1">fs</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">q0 </span><span class="s2">= </span><span class="s1">x3</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()  </span><span class="s3"># &quot;At the start, q0 is set at x3...&quot; ([1] after (7))</span>

    <span class="s1">work </span><span class="s2">= </span><span class="s1">_RichResult</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">=</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">=</span><span class="s1">f1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">=</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">=</span><span class="s1">f2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">=</span><span class="s1">x3</span><span class="s2">, </span><span class="s1">f3</span><span class="s2">=</span><span class="s1">f3</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">=</span><span class="s1">phi</span><span class="s2">,</span>
                       <span class="s1">xatol</span><span class="s2">=</span><span class="s1">xatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s1">xrtol</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s1">fatol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s1">frtol</span><span class="s2">,</span>
                       <span class="s1">nit</span><span class="s2">=</span><span class="s1">nit</span><span class="s2">, </span><span class="s1">nfev</span><span class="s2">=</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">status</span><span class="s2">=</span><span class="s1">status</span><span class="s2">, </span><span class="s1">q0</span><span class="s2">=</span><span class="s1">q0</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">)</span>
    <span class="s1">res_work_pairs </span><span class="s2">= [(</span><span class="s6">'status'</span><span class="s2">, </span><span class="s6">'status'</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s6">'x'</span><span class="s2">, </span><span class="s6">'x2'</span><span class="s2">), (</span><span class="s6">'fun'</span><span class="s2">, </span><span class="s6">'f2'</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s6">'nit'</span><span class="s2">, </span><span class="s6">'nit'</span><span class="s2">), (</span><span class="s6">'nfev'</span><span class="s2">, </span><span class="s6">'nfev'</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s6">'xl'</span><span class="s2">, </span><span class="s6">'x1'</span><span class="s2">), (</span><span class="s6">'xm'</span><span class="s2">, </span><span class="s6">'x2'</span><span class="s2">), (</span><span class="s6">'xr'</span><span class="s2">, </span><span class="s6">'x3'</span><span class="s2">),</span>
                      <span class="s2">(</span><span class="s6">'fl'</span><span class="s2">, </span><span class="s6">'f1'</span><span class="s2">), (</span><span class="s6">'fm'</span><span class="s2">, </span><span class="s6">'f2'</span><span class="s2">), (</span><span class="s6">'fr'</span><span class="s2">, </span><span class="s6">'f3'</span><span class="s2">)]</span>

    <span class="s0">def </span><span class="s1">pre_func_eval</span><span class="s2">(</span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># `_check_termination` is called first -&gt; `x3 - x2 &gt; x2 - x1`</span>
        <span class="s3"># But let's calculate a few terms that we'll reuse</span>
        <span class="s1">x21 </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span>
        <span class="s1">x32 </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span>

        <span class="s3"># [1] Section 3. &quot;The quadratic minimum point Q1 is calculated using</span>
        <span class="s3"># the relations developed in the previous section.&quot; [1] Section 2 (5/6)</span>
        <span class="s1">A </span><span class="s2">= </span><span class="s1">x21 </span><span class="s2">* (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">B </span><span class="s2">= </span><span class="s1">x32 </span><span class="s2">* (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">)</span>
        <span class="s1">C </span><span class="s2">= </span><span class="s1">A </span><span class="s2">/ (</span><span class="s1">A </span><span class="s2">+ </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s3"># q1 = C * (work.x1 + work.x2) / 2 + (1 - C) * (work.x2 + work.x3) / 2</span>
        <span class="s1">q1 </span><span class="s2">= </span><span class="s4">0.5 </span><span class="s2">* (</span><span class="s1">C</span><span class="s2">*(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">) + </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">)  </span><span class="s3"># much faster</span>
        <span class="s3"># this is an array, so multiplying by 0.5 does not change dtype</span>

        <span class="s3"># &quot;If Q1 and Q0 are sufficiently close... Q1 is accepted if it is</span>
        <span class="s3"># sufficiently away from the inside point x2&quot;</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">q1 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">q0</span><span class="s2">) &lt; </span><span class="s4">0.5 </span><span class="s2">* </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">x21</span><span class="s2">)  </span><span class="s3"># [1] (7)</span>
        <span class="s1">xi </span><span class="s2">= </span><span class="s1">q1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s3"># Later, after (9), &quot;If the point Q1 is in a +/- xtol neighborhood of</span>
        <span class="s3"># x2, the new point is chosen in the larger interval at a distance</span>
        <span class="s3"># tol away from x2.&quot;</span>
        <span class="s3"># See also QBASIC code after &quot;Accept Ql adjust if close to X2&quot;.</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">q1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] - </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) &lt;= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xtol</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">xi</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">j</span><span class="s2">] + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">x32</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">j</span><span class="s2">]) * </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xtol</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s1">j</span><span class="s2">]</span>

        <span class="s3"># &quot;If condition (7) is not satisfied, golden sectioning of the larger</span>
        <span class="s3"># interval is carried out to introduce the new point.&quot;</span>
        <span class="s3"># (For simplicity, we go ahead and calculate it for all points, but we</span>
        <span class="s3"># change the elements for which the condition was satisfied.)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">+ (</span><span class="s4">2 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">phi</span><span class="s2">) * </span><span class="s1">x32</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">xi</span>

        <span class="s3"># &quot;We define Q0 as the value of Q1 at the previous iteration.&quot;</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">q0 </span><span class="s2">= </span><span class="s1">q1</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">def </span><span class="s1">post_func_eval</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># Standard logic for updating a three-point bracket based on a new</span>
        <span class="s3"># point. In QBASIC code, see &quot;IF SGN(X-X2) = SGN(X3-X2) THEN...&quot;.</span>
        <span class="s3"># There is an awful lot of data copying going on here; this would</span>
        <span class="s3"># probably benefit from code optimization or implementation in Pythran.</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sign</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">xi</span><span class="s2">, </span><span class="s1">x1i</span><span class="s2">, </span><span class="s1">x2i</span><span class="s2">, </span><span class="s1">x3i </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">],</span>
        <span class="s1">fi</span><span class="s2">, </span><span class="s1">f1i</span><span class="s2">, </span><span class="s1">f2i</span><span class="s2">, </span><span class="s1">f3i </span><span class="s2">= </span><span class="s1">f</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">fi </span><span class="s2">&gt; </span><span class="s1">f2i</span>
        <span class="s1">x3i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f3i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">xi</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">fi</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s1">j </span><span class="s2">= ~</span><span class="s1">j</span>
        <span class="s1">x1i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f1i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">x2i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f2i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">x2i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f2i</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">xi</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">fi</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>

        <span class="s1">ni </span><span class="s2">= ~</span><span class="s1">i</span>
        <span class="s1">xni</span><span class="s2">, </span><span class="s1">x1ni</span><span class="s2">, </span><span class="s1">x2ni</span><span class="s2">, </span><span class="s1">x3ni </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">],</span>
        <span class="s1">fni</span><span class="s2">, </span><span class="s1">f1ni</span><span class="s2">, </span><span class="s1">f2ni</span><span class="s2">, </span><span class="s1">f3ni </span><span class="s2">= </span><span class="s1">f</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">]</span>
        <span class="s1">j </span><span class="s2">= </span><span class="s1">fni </span><span class="s2">&gt; </span><span class="s1">f2ni</span>
        <span class="s1">x1ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f1ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">xni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">fni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s1">j </span><span class="s2">= ~</span><span class="s1">j</span>
        <span class="s1">x3ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f3ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">x2ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f2ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">x2ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">f2ni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">xni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">], </span><span class="s1">fni</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>

        <span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">x1i</span><span class="s2">, </span><span class="s1">x2i</span><span class="s2">, </span><span class="s1">x3i</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">f1i</span><span class="s2">, </span><span class="s1">f2i</span><span class="s2">, </span><span class="s1">f3i</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">] = </span><span class="s1">x1ni</span><span class="s2">, </span><span class="s1">x2ni</span><span class="s2">, </span><span class="s1">x3ni</span><span class="s2">,</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">ni</span><span class="s2">] = </span><span class="s1">f1ni</span><span class="s2">, </span><span class="s1">f2ni</span><span class="s2">, </span><span class="s1">f3ni</span>

    <span class="s0">def </span><span class="s1">check_termination</span><span class="s2">(</span><span class="s1">work</span><span class="s2">):</span>
        <span class="s3"># Check for all terminal conditions and record statuses.</span>
        <span class="s1">stop </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros_like</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">bool</span><span class="s2">)  </span><span class="s3"># termination condition met</span>

        <span class="s3"># Bracket is invalid; stop and don't return minimizer/minimum</span>
        <span class="s1">i </span><span class="s2">= ((</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2 </span><span class="s2">&gt; </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">) | (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2 </span><span class="s2">&gt; </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">))</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ESIGNERR</span>

        <span class="s3"># Non-finite values; stop and don't return minimizer/minimum</span>
        <span class="s1">finite </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">+</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">+</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">+</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">+</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">+</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">)</span>
        <span class="s1">i </span><span class="s2">= ~(</span><span class="s1">finite </span><span class="s2">| </span><span class="s1">stop</span><span class="s2">)</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EVALUEERR</span>

        <span class="s3"># [1] Section 3 &quot;Points 1 and 3 are interchanged if necessary to make</span>
        <span class="s3"># the (x2, x3) the larger interval.&quot;</span>
        <span class="s3"># Note: I had used np.choose; this is much faster. This would be a good</span>
        <span class="s3"># place to save e.g. `work.x3 - work.x2` for reuse, but I tried and</span>
        <span class="s3"># didn't notice a speed boost, so let's keep it simple.</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">) &lt; </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">)</span>
        <span class="s1">temp </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">x3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">temp</span>
        <span class="s1">temp </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">f1</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s1">temp</span>

        <span class="s3"># [1] Section 3 (bottom of page 212)</span>
        <span class="s3"># &quot;We set a tolerance value xtol...&quot;</span>
        <span class="s1">work</span><span class="s2">.</span><span class="s1">xtol </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">) * </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xrtol </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xatol  </span><span class="s3"># [1] (8)</span>
        <span class="s3"># &quot;The convergence based on interval is achieved when...&quot;</span>
        <span class="s3"># Note: Equality allowed in case of `xtol=0`</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">x3 </span><span class="s2">- </span><span class="s1">work</span><span class="s2">.</span><span class="s1">x2</span><span class="s2">) &lt;= </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">work</span><span class="s2">.</span><span class="s1">xtol  </span><span class="s3"># [1] (9)</span>

        <span class="s3"># &quot;We define ftol using...&quot;</span>
        <span class="s1">ftol </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2</span><span class="s2">) * </span><span class="s1">work</span><span class="s2">.</span><span class="s1">frtol </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">fatol  </span><span class="s3"># [1] (10)</span>
        <span class="s3"># &quot;The convergence based on function values is achieved when...&quot;</span>
        <span class="s3"># Note 1: modify in place to incorporate tolerance on function value.</span>
        <span class="s3"># Note 2: factor of 2 is not in the text; see QBASIC start of DO loop</span>
        <span class="s1">i </span><span class="s2">|= (</span><span class="s1">work</span><span class="s2">.</span><span class="s1">f1 </span><span class="s2">- </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f2 </span><span class="s2">+ </span><span class="s1">work</span><span class="s2">.</span><span class="s1">f3</span><span class="s2">) &lt;= </span><span class="s4">2</span><span class="s2">*</span><span class="s1">ftol  </span><span class="s3"># [1] (11)</span>
        <span class="s1">i </span><span class="s2">&amp;= ~</span><span class="s1">stop</span>
        <span class="s1">stop</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">work</span><span class="s2">.</span><span class="s1">status</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = </span><span class="s0">True</span><span class="s2">, </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERGED</span>

        <span class="s0">return </span><span class="s1">stop</span>

    <span class="s0">def </span><span class="s1">post_termination_check</span><span class="s2">(</span><span class="s1">work</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">customize_result</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">):</span>
        <span class="s1">xl</span><span class="s2">, </span><span class="s1">xr</span><span class="s2">, </span><span class="s1">fl</span><span class="s2">, </span><span class="s1">fr </span><span class="s2">= </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xl'</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xr'</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'fl'</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'fr'</span><span class="s2">]</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xl'</span><span class="s2">] &lt; </span><span class="s1">res</span><span class="s2">[</span><span class="s6">'xr'</span><span class="s2">]</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'xl'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">choose</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, (</span><span class="s1">xr</span><span class="s2">, </span><span class="s1">xl</span><span class="s2">))</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'xr'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">choose</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, (</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xr</span><span class="s2">))</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'fl'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">choose</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, (</span><span class="s1">fr</span><span class="s2">, </span><span class="s1">fl</span><span class="s2">))</span>
        <span class="s1">res</span><span class="s2">[</span><span class="s6">'fr'</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">choose</span><span class="s2">(</span><span class="s1">i</span><span class="s2">, (</span><span class="s1">fl</span><span class="s2">, </span><span class="s1">fr</span><span class="s2">))</span>
        <span class="s0">return </span><span class="s1">shape</span>

    <span class="s0">return </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_loop</span><span class="s2">(</span><span class="s1">work</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">,</span>
                     <span class="s1">pre_func_eval</span><span class="s2">, </span><span class="s1">post_func_eval</span><span class="s2">, </span><span class="s1">check_termination</span><span class="s2">,</span>
                     <span class="s1">post_termination_check</span><span class="s2">, </span><span class="s1">customize_result</span><span class="s2">, </span><span class="s1">res_work_pairs</span><span class="s2">,</span>
                     <span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>
</pre>
</body>
</html>