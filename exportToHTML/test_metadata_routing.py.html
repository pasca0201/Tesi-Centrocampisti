<html>
<head>
<title>test_metadata_routing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_metadata_routing.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Metadata Routing Utility Tests 
&quot;&quot;&quot;</span>

<span class="s2"># Author: Adrin Jalali &lt;adrin.jalali@gmail.com&gt;</span>
<span class="s2"># License: BSD 3 clause</span>

<span class="s3">import </span><span class="s1">re</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">from </span><span class="s1">sklearn </span><span class="s3">import </span><span class="s1">config_context</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">base </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">BaseEstimator</span><span class="s4">,</span>
    <span class="s1">clone</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">exceptions </span><span class="s3">import </span><span class="s1">UnsetMetadataPassedError</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">linear_model </span><span class="s3">import </span><span class="s1">LinearRegression</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">pipeline </span><span class="s3">import </span><span class="s1">Pipeline</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">tests</span><span class="s4">.</span><span class="s1">metadata_routing_common </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">ConsumingClassifier</span><span class="s4">,</span>
    <span class="s1">ConsumingRegressor</span><span class="s4">,</span>
    <span class="s1">ConsumingTransformer</span><span class="s4">,</span>
    <span class="s1">MetaRegressor</span><span class="s4">,</span>
    <span class="s1">MetaTransformer</span><span class="s4">,</span>
    <span class="s1">NonConsumingClassifier</span><span class="s4">,</span>
    <span class="s1">WeightedMetaClassifier</span><span class="s4">,</span>
    <span class="s1">WeightedMetaRegressor</span><span class="s4">,</span>
    <span class="s1">_Registry</span><span class="s4">,</span>
    <span class="s1">assert_request_equal</span><span class="s4">,</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">,</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils </span><span class="s3">import </span><span class="s1">metadata_routing</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">_metadata_requests </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">COMPOSITE_METHODS</span><span class="s4">,</span>
    <span class="s1">METHODS</span><span class="s4">,</span>
    <span class="s1">SIMPLE_METHODS</span><span class="s4">,</span>
    <span class="s1">MethodMetadataRequest</span><span class="s4">,</span>
    <span class="s1">MethodPair</span><span class="s4">,</span>
    <span class="s1">_MetadataRequester</span><span class="s4">,</span>
    <span class="s1">request_is_alias</span><span class="s4">,</span>
    <span class="s1">request_is_valid</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">metadata_routing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">MetadataRequest</span><span class="s4">,</span>
    <span class="s1">MetadataRouter</span><span class="s4">,</span>
    <span class="s1">MethodMapping</span><span class="s4">,</span>
    <span class="s1">_RoutingNotSupportedMixin</span><span class="s4">,</span>
    <span class="s1">get_routing_for_object</span><span class="s4">,</span>
    <span class="s1">process_routing</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">validation </span><span class="s3">import </span><span class="s1">check_is_fitted</span>

<span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">42</span><span class="s4">)</span>
<span class="s1">N</span><span class="s4">, </span><span class="s1">M </span><span class="s4">= </span><span class="s5">100</span><span class="s4">, </span><span class="s5">4</span>
<span class="s1">X </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s1">N</span><span class="s4">, </span><span class="s1">M</span><span class="s4">)</span>
<span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">N</span><span class="s4">)</span>
<span class="s1">my_groups </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">N</span><span class="s4">)</span>
<span class="s1">my_weights </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s1">N</span><span class="s4">)</span>
<span class="s1">my_other_weights </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s1">N</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">fixture</span><span class="s4">(</span><span class="s1">autouse</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">enable_slep006</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Enable SLEP006 for all tests.&quot;&quot;&quot;</span>
    <span class="s3">with </span><span class="s1">config_context</span><span class="s4">(</span><span class="s1">enable_metadata_routing</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
        <span class="s3">yield</span>


<span class="s3">class </span><span class="s1">SimplePipeline</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;A very simple pipeline, assuming the last step is always a predictor. 
 
    Parameters 
    ---------- 
    steps : iterable of objects 
        An iterable of transformers with the last step being a predictor. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">steps</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">steps </span><span class="s4">= </span><span class="s1">steps</span>

    <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, **</span><span class="s1">fit_params</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">steps_ </span><span class="s4">= []</span>
        <span class="s1">params </span><span class="s4">= </span><span class="s1">process_routing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">, **</span><span class="s1">fit_params</span><span class="s4">)</span>
        <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">X</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">step </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">steps</span><span class="s4">[:-</span><span class="s5">1</span><span class="s4">]):</span>
            <span class="s1">transformer </span><span class="s4">= </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">step</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span>
                <span class="s1">X_transformed</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, **</span><span class="s1">params</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">f&quot;step_</span><span class="s3">{</span><span class="s1">i</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">).</span><span class="s1">fit</span>
            <span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">transformer</span><span class="s4">)</span>
            <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">transformer</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span>
                <span class="s1">X_transformed</span><span class="s4">, **</span><span class="s1">params</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">f&quot;step_</span><span class="s3">{</span><span class="s1">i</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">).</span><span class="s1">transform</span>
            <span class="s4">)</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
            <span class="s1">clone</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">steps</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_transformed</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, **</span><span class="s1">params</span><span class="s4">.</span><span class="s1">predictor</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span>

    <span class="s3">def </span><span class="s1">predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, **</span><span class="s1">predict_params</span><span class="s4">):</span>
        <span class="s1">check_is_fitted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)</span>
        <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">X</span>
        <span class="s1">params </span><span class="s4">= </span><span class="s1">process_routing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;predict&quot;</span><span class="s4">, **</span><span class="s1">predict_params</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">step </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[:-</span><span class="s5">1</span><span class="s4">]):</span>
            <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">step</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, **</span><span class="s1">params</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">f&quot;step_</span><span class="s3">{</span><span class="s1">i</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">).</span><span class="s1">transform</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_transformed</span><span class="s4">, **</span><span class="s1">params</span><span class="s4">.</span><span class="s1">predictor</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">get_metadata_routing</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">router </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">step </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">steps</span><span class="s4">[:-</span><span class="s5">1</span><span class="s4">]):</span>
            <span class="s1">router</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span>
                <span class="s4">**{</span><span class="s6">f&quot;step_</span><span class="s3">{</span><span class="s1">i</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">: </span><span class="s1">step</span><span class="s4">},</span>
                <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">()</span>
                <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;transform&quot;</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;predict&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;transform&quot;</span><span class="s4">),</span>
            <span class="s4">)</span>
        <span class="s1">router</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span>
            <span class="s1">predictor</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">steps</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">],</span>
            <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">()</span>
            <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
            <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;predict&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;predict&quot;</span><span class="s4">),</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">router</span>


<span class="s3">def </span><span class="s1">test_assert_request_is_empty</span><span class="s4">():</span>
    <span class="s1">requests </span><span class="s4">= </span><span class="s1">MetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">requests</span><span class="s4">)</span>

    <span class="s1">requests</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
    <span class="s2"># this should still work, since None is the default value</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">requests</span><span class="s4">)</span>

    <span class="s1">requests</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;bar&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s6">&quot;value&quot;</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AssertionError</span><span class="s4">):</span>
        <span class="s2"># now requests is no more empty</span>
        <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">requests</span><span class="s4">)</span>

    <span class="s2"># but one can exclude a method</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">requests</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>

    <span class="s1">requests</span><span class="s4">.</span><span class="s1">score</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;carrot&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AssertionError</span><span class="s4">):</span>
        <span class="s2"># excluding `fit` is not enough</span>
        <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">requests</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>

    <span class="s2"># and excluding both fit and score would avoid an exception</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">requests</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=[</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s6">&quot;score&quot;</span><span class="s4">])</span>

    <span class="s2"># test if a router is empty</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span>
        <span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
        <span class="s4">.</span><span class="s1">add_self_request</span><span class="s4">(</span><span class="s1">WeightedMetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">))</span>
        <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span>
            <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">(),</span>
            <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">().</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">),</span>
        <span class="s4">)</span>
    <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;estimator&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s1">ConsumingClassifier</span><span class="s4">(</span><span class="s1">registry</span><span class="s4">=</span><span class="s1">_Registry</span><span class="s4">()),</span>
        <span class="s1">ConsumingRegressor</span><span class="s4">(</span><span class="s1">registry</span><span class="s4">=</span><span class="s1">_Registry</span><span class="s4">()),</span>
        <span class="s1">ConsumingTransformer</span><span class="s4">(</span><span class="s1">registry</span><span class="s4">=</span><span class="s1">_Registry</span><span class="s4">()),</span>
        <span class="s1">WeightedMetaClassifier</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingClassifier</span><span class="s4">(), </span><span class="s1">registry</span><span class="s4">=</span><span class="s1">_Registry</span><span class="s4">()),</span>
        <span class="s1">WeightedMetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">(), </span><span class="s1">registry</span><span class="s4">=</span><span class="s1">_Registry</span><span class="s4">()),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_estimator_puts_self_in_registry</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that an estimator puts itself in the registry upon fit.&quot;&quot;&quot;</span>
    <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">estimator </span><span class="s3">in </span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">registry</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;val, res&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;$UNUSED$&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;$WARN$&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;invalid-input&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;valid_arg&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_request_type_is_alias</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">res</span><span class="s4">):</span>
    <span class="s2"># Test request_is_alias</span>
    <span class="s3">assert </span><span class="s1">request_is_alias</span><span class="s4">(</span><span class="s1">val</span><span class="s4">) == </span><span class="s1">res</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;val, res&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s3">True</span><span class="s4">, </span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;$UNUSED$&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;$WARN$&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;invalid-input&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s6">&quot;alias_arg&quot;</span><span class="s4">, </span><span class="s3">False</span><span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_request_type_is_valid</span><span class="s4">(</span><span class="s1">val</span><span class="s4">, </span><span class="s1">res</span><span class="s4">):</span>
    <span class="s2"># Test request_is_valid</span>
    <span class="s3">assert </span><span class="s1">request_is_valid</span><span class="s4">(</span><span class="s1">val</span><span class="s4">) == </span><span class="s1">res</span>


<span class="s3">def </span><span class="s1">test_default_requests</span><span class="s4">():</span>
    <span class="s3">class </span><span class="s1">OddEstimator</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span>
            <span class="s2"># set a different default request</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">True</span>
        <span class="s4">}  </span><span class="s2"># type: ignore</span>

    <span class="s1">odd_request </span><span class="s4">= </span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">OddEstimator</span><span class="s4">())</span>
    <span class="s3">assert </span><span class="s1">odd_request</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>

    <span class="s2"># check other test estimators</span>
    <span class="s3">assert not </span><span class="s1">len</span><span class="s4">(</span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">NonConsumingClassifier</span><span class="s4">()).</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests</span><span class="s4">)</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">NonConsumingClassifier</span><span class="s4">().</span><span class="s1">get_metadata_routing</span><span class="s4">())</span>

    <span class="s1">trs_request </span><span class="s4">= </span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">ConsumingTransformer</span><span class="s4">())</span>
    <span class="s3">assert </span><span class="s1">trs_request</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span>
        <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s6">&quot;metadata&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">}</span>
    <span class="s3">assert </span><span class="s1">trs_request</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;metadata&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">trs_request</span><span class="s4">)</span>

    <span class="s1">est_request </span><span class="s4">= </span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">ConsumingClassifier</span><span class="s4">())</span>
    <span class="s3">assert </span><span class="s1">est_request</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span>
        <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s6">&quot;metadata&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">}</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">est_request</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_default_request_override</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that default requests are correctly overridden regardless of the ASCII order 
    of the class names, hence testing small and capital letter class name starts. 
    Non-regression test for https://github.com/scikit-learn/scikit-learn/issues/28430 
    &quot;&quot;&quot;</span>

    <span class="s3">class </span><span class="s1">Base</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s1">__metadata_request__split </span><span class="s4">= {</span><span class="s6">&quot;groups&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>

    <span class="s3">class </span><span class="s1">class_1</span><span class="s4">(</span><span class="s1">Base</span><span class="s4">):</span>
        <span class="s1">__metadata_request__split </span><span class="s4">= {</span><span class="s6">&quot;groups&quot;</span><span class="s4">: </span><span class="s6">&quot;sample_domain&quot;</span><span class="s4">}</span>

    <span class="s3">class </span><span class="s1">Class_1</span><span class="s4">(</span><span class="s1">Base</span><span class="s4">):</span>
        <span class="s1">__metadata_request__split </span><span class="s4">= {</span><span class="s6">&quot;groups&quot;</span><span class="s4">: </span><span class="s6">&quot;sample_domain&quot;</span><span class="s4">}</span>

    <span class="s1">assert_request_equal</span><span class="s4">(</span>
        <span class="s1">class_1</span><span class="s4">().</span><span class="s1">_get_metadata_request</span><span class="s4">(), {</span><span class="s6">&quot;split&quot;</span><span class="s4">: {</span><span class="s6">&quot;groups&quot;</span><span class="s4">: </span><span class="s6">&quot;sample_domain&quot;</span><span class="s4">}}</span>
    <span class="s4">)</span>
    <span class="s1">assert_request_equal</span><span class="s4">(</span>
        <span class="s1">Class_1</span><span class="s4">().</span><span class="s1">_get_metadata_request</span><span class="s4">(), {</span><span class="s6">&quot;split&quot;</span><span class="s4">: {</span><span class="s6">&quot;groups&quot;</span><span class="s4">: </span><span class="s6">&quot;sample_domain&quot;</span><span class="s4">}}</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_process_routing_invalid_method</span><span class="s4">():</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Can only route and process input&quot;</span><span class="s4">):</span>
        <span class="s1">process_routing</span><span class="s4">(</span><span class="s1">ConsumingClassifier</span><span class="s4">(), </span><span class="s6">&quot;invalid_method&quot;</span><span class="s4">, </span><span class="s1">groups</span><span class="s4">=</span><span class="s1">my_groups</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_process_routing_invalid_object</span><span class="s4">():</span>
    <span class="s3">class </span><span class="s1">InvalidObject</span><span class="s4">:</span>
        <span class="s3">pass</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;either implement the routing method&quot;</span><span class="s4">):</span>
        <span class="s1">process_routing</span><span class="s4">(</span><span class="s1">InvalidObject</span><span class="s4">(), </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">groups</span><span class="s4">=</span><span class="s1">my_groups</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;method&quot;</span><span class="s4">, </span><span class="s1">METHODS</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;default&quot;</span><span class="s4">, [</span><span class="s3">None</span><span class="s4">, </span><span class="s6">&quot;default&quot;</span><span class="s4">, []])</span>
<span class="s3">def </span><span class="s1">test_process_routing_empty_params_get_with_default</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s1">default</span><span class="s4">):</span>
    <span class="s1">empty_params </span><span class="s4">= {}</span>
    <span class="s1">routed_params </span><span class="s4">= </span><span class="s1">process_routing</span><span class="s4">(</span><span class="s1">ConsumingClassifier</span><span class="s4">(), </span><span class="s6">&quot;fit&quot;</span><span class="s4">, **</span><span class="s1">empty_params</span><span class="s4">)</span>

    <span class="s2"># Behaviour should be an empty dictionary returned for each method when retrieved.</span>
    <span class="s1">params_for_method </span><span class="s4">= </span><span class="s1">routed_params</span><span class="s4">[</span><span class="s1">method</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">params_for_method</span><span class="s4">, </span><span class="s1">dict</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">set</span><span class="s4">(</span><span class="s1">params_for_method</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()) == </span><span class="s1">set</span><span class="s4">(</span><span class="s1">METHODS</span><span class="s4">)</span>

    <span class="s2"># No default to `get` should be equivalent to the default</span>
    <span class="s1">default_params_for_method </span><span class="s4">= </span><span class="s1">routed_params</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s1">default</span><span class="s4">=</span><span class="s1">default</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">default_params_for_method </span><span class="s4">== </span><span class="s1">params_for_method</span>


<span class="s3">def </span><span class="s1">test_simple_metadata_routing</span><span class="s4">():</span>
    <span class="s2"># Tests that metadata is properly routed</span>

    <span class="s2"># The underlying estimator doesn't accept or request metadata</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">NonConsumingClassifier</span><span class="s4">())</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s2"># Meta-estimator consumes sample_weight, but doesn't forward it to the underlying</span>
    <span class="s2"># estimator</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">NonConsumingClassifier</span><span class="s4">())</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>

    <span class="s2"># If the estimator accepts the metadata but doesn't explicitly say it doesn't</span>
    <span class="s2"># need it, there's an error</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingClassifier</span><span class="s4">())</span>
    <span class="s1">err_message </span><span class="s4">= (</span>
        <span class="s6">&quot;[sample_weight] are passed but are not explicitly set as requested or&quot;</span>
        <span class="s6">&quot; not requested for ConsumingClassifier.fit&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span><span class="s1">err_message</span><span class="s4">)):</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>

    <span class="s2"># Explicitly saying the estimator doesn't need it, makes the error go away,</span>
    <span class="s2"># because in this case `WeightedMetaClassifier` consumes `sample_weight`. If</span>
    <span class="s2"># there was no consumer of sample_weight, passing it would result in an</span>
    <span class="s2"># error.</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span>
        <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingClassifier</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s2"># this doesn't raise since WeightedMetaClassifier itself is a consumer,</span>
    <span class="s2"># and passing metadata to the consumer directly is fine regardless of its</span>
    <span class="s2"># metadata_request values.</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">estimator_</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>

    <span class="s2"># Requesting a metadata will make the meta-estimator forward it correctly</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span>
        <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingClassifier</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">estimator_</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>

    <span class="s2"># And requesting it with an alias</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span>
        <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingClassifier</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span>
            <span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;alternative_weight&quot;</span>
        <span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">alternative_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">estimator_</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_nested_routing</span><span class="s4">():</span>
    <span class="s2"># check if metadata is routed in a nested routing situation.</span>
    <span class="s1">pipeline </span><span class="s4">= </span><span class="s1">SimplePipeline</span><span class="s4">(</span>
        <span class="s4">[</span>
            <span class="s1">MetaTransformer</span><span class="s4">(</span>
                <span class="s1">transformer</span><span class="s4">=</span><span class="s1">ConsumingTransformer</span><span class="s4">()</span>
                <span class="s4">.</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">set_transform_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
            <span class="s4">),</span>
            <span class="s1">WeightedMetaRegressor</span><span class="s4">(</span>
                <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">()</span>
                <span class="s4">.</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;inner_weights&quot;</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">set_predict_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
            <span class="s4">).</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;outer_weights&quot;</span><span class="s4">),</span>
        <span class="s4">]</span>
    <span class="s4">)</span>
    <span class="s1">w1</span><span class="s4">, </span><span class="s1">w2</span><span class="s4">, </span><span class="s1">w3 </span><span class="s4">= [</span><span class="s5">1</span><span class="s4">], [</span><span class="s5">2</span><span class="s4">], [</span><span class="s5">3</span><span class="s4">]</span>
    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s1">my_groups</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w1</span><span class="s4">, </span><span class="s1">outer_weights</span><span class="s4">=</span><span class="s1">w2</span><span class="s4">, </span><span class="s1">inner_weights</span><span class="s4">=</span><span class="s1">w3</span>
    <span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span>
        <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">transformer_</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s1">my_groups</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span>
    <span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span>
        <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">transformer_</span><span class="s4">, </span><span class="s6">&quot;transform&quot;</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w1</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">None</span>
    <span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span><span class="s1">pipeline</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[</span><span class="s5">1</span><span class="s4">], </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w2</span><span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span><span class="s1">pipeline</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">estimator_</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w3</span><span class="s4">)</span>

    <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w3</span><span class="s4">)</span>
    <span class="s1">check_recorded_metadata</span><span class="s4">(</span>
        <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">steps_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">transformer_</span><span class="s4">, </span><span class="s6">&quot;transform&quot;</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w3</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">None</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_nested_routing_conflict</span><span class="s4">():</span>
    <span class="s2"># check if an error is raised if there's a conflict between keys</span>
    <span class="s1">pipeline </span><span class="s4">= </span><span class="s1">SimplePipeline</span><span class="s4">(</span>
        <span class="s4">[</span>
            <span class="s1">MetaTransformer</span><span class="s4">(</span>
                <span class="s1">transformer</span><span class="s4">=</span><span class="s1">ConsumingTransformer</span><span class="s4">()</span>
                <span class="s4">.</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">set_transform_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s4">),</span>
            <span class="s1">WeightedMetaRegressor</span><span class="s4">(</span>
                <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s4">).</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;outer_weights&quot;</span><span class="s4">),</span>
        <span class="s4">]</span>
    <span class="s4">)</span>
    <span class="s1">w1</span><span class="s4">, </span><span class="s1">w2 </span><span class="s4">= [</span><span class="s5">1</span><span class="s4">], [</span><span class="s5">2</span><span class="s4">]</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span>
        <span class="s1">ValueError</span><span class="s4">,</span>
        <span class="s1">match</span><span class="s4">=(</span>
            <span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span>
                <span class="s6">&quot;In WeightedMetaRegressor, there is a conflict on sample_weight between&quot;</span>
                <span class="s6">&quot; what is requested for this estimator and what is requested by its&quot;</span>
                <span class="s6">&quot; children. You can resolve this conflict by using an alias for the&quot;</span>
                <span class="s6">&quot; child estimator(s) requested metadata.&quot;</span>
            <span class="s4">)</span>
        <span class="s4">),</span>
    <span class="s4">):</span>
        <span class="s1">pipeline</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s1">my_groups</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">w1</span><span class="s4">, </span><span class="s1">outer_weights</span><span class="s4">=</span><span class="s1">w2</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_invalid_metadata</span><span class="s4">():</span>
    <span class="s2"># check that passing wrong metadata raises an error</span>
    <span class="s1">trs </span><span class="s4">= </span><span class="s1">MetaTransformer</span><span class="s4">(</span>
        <span class="s1">transformer</span><span class="s4">=</span><span class="s1">ConsumingTransformer</span><span class="s4">().</span><span class="s1">set_transform_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span>
        <span class="s1">TypeError</span><span class="s4">,</span>
        <span class="s1">match</span><span class="s4">=(</span><span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span><span class="s6">&quot;transform got unexpected argument(s) {'other_param'}&quot;</span><span class="s4">)),</span>
    <span class="s4">):</span>
        <span class="s1">trs</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">other_param</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>

    <span class="s2"># passing a metadata which is not requested by any estimator should also raise</span>
    <span class="s1">trs </span><span class="s4">= </span><span class="s1">MetaTransformer</span><span class="s4">(</span>
        <span class="s1">transformer</span><span class="s4">=</span><span class="s1">ConsumingTransformer</span><span class="s4">().</span><span class="s1">set_transform_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span>
        <span class="s1">TypeError</span><span class="s4">,</span>
        <span class="s1">match</span><span class="s4">=(</span><span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span><span class="s6">&quot;transform got unexpected argument(s) {'sample_weight'}&quot;</span><span class="s4">)),</span>
    <span class="s4">):</span>
        <span class="s1">trs</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_get_metadata_routing</span><span class="s4">():</span>
    <span class="s3">class </span><span class="s1">TestDefaultsBadMethodName</span><span class="s4">(</span><span class="s1">_MetadataRequester</span><span class="s4">):</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s1">__metadata_request__score </span><span class="s4">= {</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s2"># this will raise an error since we don't understand &quot;other_method&quot; as a method</span>
        <span class="s1">__metadata_request__other_method </span><span class="s4">= {</span><span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>

    <span class="s3">class </span><span class="s1">TestDefaults</span><span class="s4">(</span><span class="s1">_MetadataRequester</span><span class="s4">):</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s1">__metadata_request__score </span><span class="s4">= {</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s1">__metadata_request__predict </span><span class="s4">= {</span><span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span>
        <span class="s1">AttributeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;'MetadataRequest' object has no attribute 'other_method'&quot;</span>
    <span class="s4">):</span>
        <span class="s1">TestDefaultsBadMethodName</span><span class="s4">().</span><span class="s1">get_metadata_routing</span><span class="s4">()</span>

    <span class="s1">expected </span><span class="s4">= {</span>
        <span class="s6">&quot;score&quot;</span><span class="s4">: {</span>
            <span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;fit&quot;</span><span class="s4">: {</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;predict&quot;</span><span class="s4">: {</span><span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">},</span>
    <span class="s4">}</span>
    <span class="s1">assert_request_equal</span><span class="s4">(</span><span class="s1">TestDefaults</span><span class="s4">().</span><span class="s1">get_metadata_routing</span><span class="s4">(), </span><span class="s1">expected</span><span class="s4">)</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">TestDefaults</span><span class="s4">().</span><span class="s1">set_score_request</span><span class="s4">(</span><span class="s1">my_param</span><span class="s4">=</span><span class="s6">&quot;other_param&quot;</span><span class="s4">)</span>
    <span class="s1">expected </span><span class="s4">= {</span>
        <span class="s6">&quot;score&quot;</span><span class="s4">: {</span>
            <span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s6">&quot;other_param&quot;</span><span class="s4">,</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;fit&quot;</span><span class="s4">: {</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;predict&quot;</span><span class="s4">: {</span><span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">},</span>
    <span class="s4">}</span>
    <span class="s1">assert_request_equal</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">(), </span><span class="s1">expected</span><span class="s4">)</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">TestDefaults</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">expected </span><span class="s4">= {</span>
        <span class="s6">&quot;score&quot;</span><span class="s4">: {</span>
            <span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;fit&quot;</span><span class="s4">: {</span>
            <span class="s6">&quot;my_other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
            <span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;predict&quot;</span><span class="s4">: {</span><span class="s6">&quot;my_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">},</span>
    <span class="s4">}</span>
    <span class="s1">assert_request_equal</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">(), </span><span class="s1">expected</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_setting_default_requests</span><span class="s4">():</span>
    <span class="s2"># Test _get_default_requests method</span>
    <span class="s1">test_cases </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">()</span>

    <span class="s3">class </span><span class="s1">ExplicitRequest</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># `fit` doesn't accept `props` explicitly, but we want to request it</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>

        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s1">test_cases</span><span class="s4">[</span><span class="s1">ExplicitRequest</span><span class="s4">] = {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>

    <span class="s3">class </span><span class="s1">ExplicitRequestOverwrite</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># `fit` explicitly accepts `props`, but we want to change the default</span>
        <span class="s2"># request value from None to True</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>

        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s1">test_cases</span><span class="s4">[</span><span class="s1">ExplicitRequestOverwrite</span><span class="s4">] = {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>

    <span class="s3">class </span><span class="s1">ImplicitRequest</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># `fit` requests `prop` and the default None should be used</span>
        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s1">test_cases</span><span class="s4">[</span><span class="s1">ImplicitRequest</span><span class="s4">] = {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>

    <span class="s3">class </span><span class="s1">ImplicitRequestRemoval</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># `fit` (in this class or a parent) requests `prop`, but we don't want</span>
        <span class="s2"># it requested at all.</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s1">metadata_routing</span><span class="s4">.</span><span class="s1">UNUSED</span><span class="s4">}</span>

        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">prop</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s1">test_cases</span><span class="s4">[</span><span class="s1">ImplicitRequestRemoval</span><span class="s4">] = {}</span>

    <span class="s3">for </span><span class="s1">Klass</span><span class="s4">, </span><span class="s1">requests </span><span class="s3">in </span><span class="s1">test_cases</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
        <span class="s3">assert </span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">Klass</span><span class="s4">()).</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== </span><span class="s1">requests</span>
        <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">Klass</span><span class="s4">().</span><span class="s1">get_metadata_routing</span><span class="s4">(), </span><span class="s1">exclude</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
        <span class="s1">Klass</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)  </span><span class="s2"># for coverage</span>


<span class="s3">def </span><span class="s1">test_removing_non_existing_param_raises</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that removing a metadata using UNUSED which doesn't exist raises.&quot;&quot;&quot;</span>

    <span class="s3">class </span><span class="s1">InvalidRequestRemoval</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># `fit` (in this class or a parent) requests `prop`, but we don't want</span>
        <span class="s2"># it requested at all.</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s1">metadata_routing</span><span class="s4">.</span><span class="s1">UNUSED</span><span class="s4">}</span>

        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Trying to remove parameter&quot;</span><span class="s4">):</span>
        <span class="s1">InvalidRequestRemoval</span><span class="s4">().</span><span class="s1">get_metadata_routing</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">test_method_metadata_request</span><span class="s4">():</span>
    <span class="s1">mmr </span><span class="s4">= </span><span class="s1">MethodMetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">, </span><span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;The alias you're setting for&quot;</span><span class="s4">):</span>
        <span class="s1">mmr</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s5">1.4</span><span class="s4">)</span>

    <span class="s1">mmr</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>
    <span class="s1">mmr</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">False</span><span class="s4">}</span>
    <span class="s1">mmr</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>
    <span class="s1">mmr</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">}</span>
    <span class="s1">mmr</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s6">&quot;bar&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s6">&quot;bar&quot;</span><span class="s4">}</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">False</span><span class="s4">) == {</span><span class="s6">&quot;foo&quot;</span><span class="s4">}</span>
    <span class="s3">assert </span><span class="s1">mmr</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">) == {</span><span class="s6">&quot;bar&quot;</span><span class="s4">}</span>


<span class="s3">def </span><span class="s1">test_get_routing_for_object</span><span class="s4">():</span>
    <span class="s3">class </span><span class="s1">Consumer</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>

    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s3">None</span><span class="s4">))</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">object</span><span class="s4">()))</span>

    <span class="s1">mr </span><span class="s4">= </span><span class="s1">MetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s1">mr</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s6">&quot;bar&quot;</span><span class="s4">)</span>
    <span class="s1">mr_factory </span><span class="s4">= </span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">mr</span><span class="s4">)</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">mr_factory</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mr_factory</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s6">&quot;bar&quot;</span><span class="s4">}</span>

    <span class="s1">mr </span><span class="s4">= </span><span class="s1">get_routing_for_object</span><span class="s4">(</span><span class="s1">Consumer</span><span class="s4">())</span>
    <span class="s1">assert_request_is_empty</span><span class="s4">(</span><span class="s1">mr</span><span class="s4">, </span><span class="s1">exclude</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mr</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;prop&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>


<span class="s3">def </span><span class="s1">test_metadata_request_consumes_method</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that MetadataRequest().consumes() method works as expected.&quot;&quot;&quot;</span>
    <span class="s1">request </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">request</span><span class="s4">.</span><span class="s1">consumes</span><span class="s4">(</span><span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">params</span><span class="s4">={</span><span class="s6">&quot;foo&quot;</span><span class="s4">}) == </span><span class="s1">set</span><span class="s4">()</span>

    <span class="s1">request </span><span class="s4">= </span><span class="s1">MetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s1">request</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">request</span><span class="s4">.</span><span class="s1">consumes</span><span class="s4">(</span><span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">params</span><span class="s4">={</span><span class="s6">&quot;foo&quot;</span><span class="s4">}) == {</span><span class="s6">&quot;foo&quot;</span><span class="s4">}</span>

    <span class="s1">request </span><span class="s4">= </span><span class="s1">MetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s1">request</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s6">&quot;bar&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">request</span><span class="s4">.</span><span class="s1">consumes</span><span class="s4">(</span><span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">params</span><span class="s4">={</span><span class="s6">&quot;bar&quot;</span><span class="s4">, </span><span class="s6">&quot;foo&quot;</span><span class="s4">}) == {</span><span class="s6">&quot;bar&quot;</span><span class="s4">}</span>


<span class="s3">def </span><span class="s1">test_metadata_router_consumes_method</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that MetadataRouter().consumes method works as expected.&quot;&quot;&quot;</span>
    <span class="s2"># having it here instead of parametrizing the test since `set_fit_request`</span>
    <span class="s2"># is not available while collecting the tests.</span>
    <span class="s1">cases </span><span class="s4">= [</span>
        <span class="s4">(</span>
            <span class="s1">WeightedMetaRegressor</span><span class="s4">(</span>
                <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
            <span class="s4">),</span>
            <span class="s4">{</span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">},</span>
            <span class="s4">{</span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">},</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">WeightedMetaRegressor</span><span class="s4">(</span>
                <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span>
                    <span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;my_weights&quot;</span>
                <span class="s4">)</span>
            <span class="s4">),</span>
            <span class="s4">{</span><span class="s6">&quot;my_weights&quot;</span><span class="s4">, </span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">},</span>
            <span class="s4">{</span><span class="s6">&quot;my_weights&quot;</span><span class="s4">},</span>
        <span class="s4">),</span>
    <span class="s4">]</span>

    <span class="s3">for </span><span class="s1">obj</span><span class="s4">, </span><span class="s1">input</span><span class="s4">, </span><span class="s1">output </span><span class="s3">in </span><span class="s1">cases</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">obj</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">consumes</span><span class="s4">(</span><span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">params</span><span class="s4">=</span><span class="s1">input</span><span class="s4">) == </span><span class="s1">output</span>


<span class="s3">def </span><span class="s1">test_metaestimator_warnings</span><span class="s4">():</span>
    <span class="s3">class </span><span class="s1">WeightedMetaRegressorWarn</span><span class="s4">(</span><span class="s1">WeightedMetaRegressor</span><span class="s4">):</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s1">metadata_routing</span><span class="s4">.</span><span class="s1">WARN</span><span class="s4">}</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span>
        <span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Support for .* has recently been added to this class&quot;</span>
    <span class="s4">):</span>
        <span class="s1">WeightedMetaRegressorWarn</span><span class="s4">(</span>
            <span class="s1">estimator</span><span class="s4">=</span><span class="s1">LinearRegression</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_estimator_warnings</span><span class="s4">():</span>
    <span class="s3">class </span><span class="s1">ConsumingRegressorWarn</span><span class="s4">(</span><span class="s1">ConsumingRegressor</span><span class="s4">):</span>
        <span class="s1">__metadata_request__fit </span><span class="s4">= {</span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">: </span><span class="s1">metadata_routing</span><span class="s4">.</span><span class="s1">WARN</span><span class="s4">}</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span>
        <span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Support for .* has recently been added to this class&quot;</span>
    <span class="s4">):</span>
        <span class="s1">MetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressorWarn</span><span class="s4">()).</span><span class="s1">fit</span><span class="s4">(</span>
            <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">my_weights</span>
        <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;obj, string&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">MethodMetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">, </span><span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">).</span><span class="s1">add_request</span><span class="s4">(</span>
                <span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s6">&quot;bar&quot;</span>
            <span class="s4">),</span>
            <span class="s6">&quot;{'foo': 'bar'}&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">MetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">),</span>
            <span class="s6">&quot;{}&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">).</span><span class="s1">add</span><span class="s4">(</span>
                <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">(),</span>
                <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">().</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;predict&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;predict&quot;</span><span class="s4">),</span>
            <span class="s4">),</span>
            <span class="s4">(</span>
                <span class="s6">&quot;{'estimator': {'mapping': [{'caller': 'predict', 'callee':&quot;</span>
                <span class="s6">&quot; 'predict'}], 'router': {'fit': {'sample_weight': None, 'metadata':&quot;</span>
                <span class="s6">&quot; None}, 'partial_fit': {'sample_weight': None, 'metadata': None},&quot;</span>
                <span class="s6">&quot; 'predict': {'sample_weight': None, 'metadata': None}, 'score':&quot;</span>
                <span class="s6">&quot; {'sample_weight': None, 'metadata': None}}}}&quot;</span>
            <span class="s4">),</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_string_representations</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s1">string</span><span class="s4">):</span>
    <span class="s3">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">) == </span><span class="s1">string</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;obj, method, inputs, err_cls, err_msg&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s1">MethodMapping</span><span class="s4">(),</span>
            <span class="s6">&quot;add&quot;</span><span class="s4">,</span>
            <span class="s4">{</span><span class="s6">&quot;caller&quot;</span><span class="s4">: </span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s6">&quot;callee&quot;</span><span class="s4">: </span><span class="s6">&quot;invalid&quot;</span><span class="s4">},</span>
            <span class="s1">ValueError</span><span class="s4">,</span>
            <span class="s6">&quot;Given callee&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">MethodMapping</span><span class="s4">(),</span>
            <span class="s6">&quot;add&quot;</span><span class="s4">,</span>
            <span class="s4">{</span><span class="s6">&quot;caller&quot;</span><span class="s4">: </span><span class="s6">&quot;invalid&quot;</span><span class="s4">, </span><span class="s6">&quot;callee&quot;</span><span class="s4">: </span><span class="s6">&quot;fit&quot;</span><span class="s4">},</span>
            <span class="s1">ValueError</span><span class="s4">,</span>
            <span class="s6">&quot;Given caller&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">),</span>
            <span class="s6">&quot;add_self_request&quot;</span><span class="s4">,</span>
            <span class="s4">{</span><span class="s6">&quot;obj&quot;</span><span class="s4">: </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)},</span>
            <span class="s1">ValueError</span><span class="s4">,</span>
            <span class="s6">&quot;Given `obj` is neither a `MetadataRequest` nor does it implement&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">ConsumingClassifier</span><span class="s4">(),</span>
            <span class="s6">&quot;set_fit_request&quot;</span><span class="s4">,</span>
            <span class="s4">{</span><span class="s6">&quot;invalid&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">},</span>
            <span class="s1">TypeError</span><span class="s4">,</span>
            <span class="s6">&quot;Unexpected args&quot;</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_validations</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s1">method</span><span class="s4">, </span><span class="s1">inputs</span><span class="s4">, </span><span class="s1">err_cls</span><span class="s4">, </span><span class="s1">err_msg</span><span class="s4">):</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">err_cls</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">getattr</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">, </span><span class="s1">method</span><span class="s4">)(**</span><span class="s1">inputs</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_methodmapping</span><span class="s4">():</span>
    <span class="s1">mm </span><span class="s4">= (</span>
        <span class="s1">MethodMapping</span><span class="s4">()</span>
        <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;transform&quot;</span><span class="s4">)</span>
        <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>
    <span class="s4">)</span>

    <span class="s1">mm_list </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">mm</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mm_list</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] == (</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s6">&quot;transform&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">mm_list</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == (</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s6">&quot;fit&quot;</span><span class="s4">)</span>

    <span class="s1">mm </span><span class="s4">= </span><span class="s1">MethodMapping</span><span class="s4">()</span>
    <span class="s3">for </span><span class="s1">method </span><span class="s3">in </span><span class="s1">METHODS</span><span class="s4">:</span>
        <span class="s1">mm</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s1">method</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s1">method</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">MethodPair</span><span class="s4">(</span><span class="s1">method</span><span class="s4">, </span><span class="s1">method</span><span class="s4">) </span><span class="s3">in </span><span class="s1">mm</span><span class="s4">.</span><span class="s1">_routes</span>
    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mm</span><span class="s4">.</span><span class="s1">_routes</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">METHODS</span><span class="s4">)</span>

    <span class="s1">mm </span><span class="s4">= </span><span class="s1">MethodMapping</span><span class="s4">().</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;score&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;score&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">repr</span><span class="s4">(</span><span class="s1">mm</span><span class="s4">) == </span><span class="s6">&quot;[{'caller': 'score', 'callee': 'score'}]&quot;</span>


<span class="s3">def </span><span class="s1">test_metadatarouter_add_self_request</span><span class="s4">():</span>
    <span class="s2"># adding a MetadataRequest as `self` adds a copy</span>
    <span class="s1">request </span><span class="s4">= </span><span class="s1">MetadataRequest</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;nested&quot;</span><span class="s4">)</span>
    <span class="s1">request</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">.</span><span class="s1">add_request</span><span class="s4">(</span><span class="s1">param</span><span class="s4">=</span><span class="s6">&quot;param&quot;</span><span class="s4">, </span><span class="s1">alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">router </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">).</span><span class="s1">add_self_request</span><span class="s4">(</span><span class="s1">request</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">request</span><span class="s4">)</span>
    <span class="s2"># should be a copy, not the same object</span>
    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request </span><span class="s3">is not </span><span class="s1">request</span>

    <span class="s2"># one can add an estimator as self</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;my_weights&quot;</span><span class="s4">)</span>
    <span class="s1">router </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">).</span><span class="s1">add_self_request</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">=</span><span class="s1">est</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">())</span>
    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request </span><span class="s3">is not </span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">()</span>

    <span class="s2"># adding a consumer+router as self should only add the consumer part</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">WeightedMetaRegressor</span><span class="s4">(</span>
        <span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;nested_weights&quot;</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s1">router </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">).</span><span class="s1">add_self_request</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">=</span><span class="s1">est</span><span class="s4">)</span>
    <span class="s2"># _get_metadata_request() returns the consumer part of the requests</span>
    <span class="s3">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request</span><span class="s4">) == </span><span class="s1">str</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">_get_metadata_request</span><span class="s4">())</span>
    <span class="s2"># get_metadata_routing() returns the complete request set, consumer and</span>
    <span class="s2"># router included.</span>
    <span class="s3">assert </span><span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request</span><span class="s4">) != </span><span class="s1">str</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">())</span>
    <span class="s2"># it should be a copy, not the same object</span>
    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_self_request </span><span class="s3">is not </span><span class="s1">est</span><span class="s4">.</span><span class="s1">_get_metadata_request</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">test_metadata_routing_add</span><span class="s4">():</span>
    <span class="s2"># adding one with a string `method_mapping`</span>
    <span class="s1">router </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">).</span><span class="s1">add</span><span class="s4">(</span>
        <span class="s1">est</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;weights&quot;</span><span class="s4">),</span>
        <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">().</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">)</span>
        <span class="s4">== </span><span class="s6">&quot;{'est': {'mapping': [{'caller': 'fit', 'callee': 'fit'}], 'router': {'fit':&quot;</span>
        <span class="s6">&quot; {'sample_weight': 'weights', 'metadata': None}, 'partial_fit':&quot;</span>
        <span class="s6">&quot; {'sample_weight': None, 'metadata': None}, 'predict': {'sample_weight':&quot;</span>
        <span class="s6">&quot; None, 'metadata': None}, 'score': {'sample_weight': None, 'metadata':&quot;</span>
        <span class="s6">&quot; None}}}}&quot;</span>
    <span class="s4">)</span>

    <span class="s2"># adding one with an instance of MethodMapping</span>
    <span class="s1">router </span><span class="s4">= </span><span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">).</span><span class="s1">add</span><span class="s4">(</span>
        <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">().</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;score&quot;</span><span class="s4">),</span>
        <span class="s1">est</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">().</span><span class="s1">set_score_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">)</span>
        <span class="s4">== </span><span class="s6">&quot;{'est': {'mapping': [{'caller': 'fit', 'callee': 'score'}], 'router':&quot;</span>
        <span class="s6">&quot; {'fit': {'sample_weight': None, 'metadata': None}, 'partial_fit':&quot;</span>
        <span class="s6">&quot; {'sample_weight': None, 'metadata': None}, 'predict': {'sample_weight':&quot;</span>
        <span class="s6">&quot; None, 'metadata': None}, 'score': {'sample_weight': True, 'metadata':&quot;</span>
        <span class="s6">&quot; None}}}}&quot;</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_metadata_routing_get_param_names</span><span class="s4">():</span>
    <span class="s1">router </span><span class="s4">= (</span>
        <span class="s1">MetadataRouter</span><span class="s4">(</span><span class="s1">owner</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
        <span class="s4">.</span><span class="s1">add_self_request</span><span class="s4">(</span>
            <span class="s1">WeightedMetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">()).</span><span class="s1">set_fit_request</span><span class="s4">(</span>
                <span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;self_weights&quot;</span>
            <span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s4">.</span><span class="s1">add</span><span class="s4">(</span>
            <span class="s1">trs</span><span class="s4">=</span><span class="s1">ConsumingTransformer</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span>
                <span class="s1">sample_weight</span><span class="s4">=</span><span class="s6">&quot;transform_weights&quot;</span>
            <span class="s4">),</span>
            <span class="s1">method_mapping</span><span class="s4">=</span><span class="s1">MethodMapping</span><span class="s4">().</span><span class="s1">add</span><span class="s4">(</span><span class="s1">caller</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">callee</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">),</span>
        <span class="s4">)</span>
    <span class="s4">)</span>

    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s1">str</span><span class="s4">(</span><span class="s1">router</span><span class="s4">)</span>
        <span class="s4">== </span><span class="s6">&quot;{'$self_request': {'fit': {'sample_weight': 'self_weights'}, 'score':&quot;</span>
        <span class="s6">&quot; {'sample_weight': None}}, 'trs': {'mapping': [{'caller': 'fit', 'callee':&quot;</span>
        <span class="s6">&quot; 'fit'}], 'router': {'fit': {'sample_weight': 'transform_weights',&quot;</span>
        <span class="s6">&quot; 'metadata': None}, 'transform': {'sample_weight': None, 'metadata': None},&quot;</span>
        <span class="s6">&quot; 'inverse_transform': {'sample_weight': None, 'metadata': None}}}}&quot;</span>
    <span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span>
        <span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">ignore_self_request</span><span class="s4">=</span><span class="s3">False</span>
    <span class="s4">) == {</span><span class="s6">&quot;transform_weights&quot;</span><span class="s4">, </span><span class="s6">&quot;metadata&quot;</span><span class="s4">, </span><span class="s6">&quot;self_weights&quot;</span><span class="s4">}</span>
    <span class="s2"># return_alias=False will return original names for &quot;self&quot;</span>
    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span>
        <span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">ignore_self_request</span><span class="s4">=</span><span class="s3">False</span>
    <span class="s4">) == {</span><span class="s6">&quot;sample_weight&quot;</span><span class="s4">, </span><span class="s6">&quot;metadata&quot;</span><span class="s4">, </span><span class="s6">&quot;transform_weights&quot;</span><span class="s4">}</span>
    <span class="s2"># ignoring self would remove &quot;sample_weight&quot;</span>
    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span>
        <span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">ignore_self_request</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">) == {</span><span class="s6">&quot;metadata&quot;</span><span class="s4">, </span><span class="s6">&quot;transform_weights&quot;</span><span class="s4">}</span>
    <span class="s2"># return_alias is ignored when ignore_self_request=True</span>
    <span class="s3">assert </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span>
        <span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">ignore_self_request</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">) == </span><span class="s1">router</span><span class="s4">.</span><span class="s1">_get_param_names</span><span class="s4">(</span>
        <span class="s1">method</span><span class="s4">=</span><span class="s6">&quot;fit&quot;</span><span class="s4">, </span><span class="s1">return_alias</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">ignore_self_request</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_method_generation</span><span class="s4">():</span>
    <span class="s2"># Test if all required request methods are generated.</span>

    <span class="s2"># TODO: these test classes can be moved to sklearn.utils._testing once we</span>
    <span class="s2"># have a better idea of what the commonly used classes are.</span>
    <span class="s3">class </span><span class="s1">SimpleEstimator</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># This class should have no set_{method}_request</span>
        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">fit_predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">partial_fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">decision_function</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">score</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">split</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">inverse_transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

    <span class="s3">for </span><span class="s1">method </span><span class="s3">in </span><span class="s1">METHODS</span><span class="s4">:</span>
        <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">SimpleEstimator</span><span class="s4">(), </span><span class="s6">f&quot;set_</span><span class="s3">{</span><span class="s1">method</span><span class="s3">}</span><span class="s6">_request&quot;</span><span class="s4">)</span>

    <span class="s3">class </span><span class="s1">SimpleEstimator</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># This class should have every set_{method}_request</span>
        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">fit_predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">partial_fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">decision_function</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">score</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">split</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">inverse_transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

    <span class="s2"># composite methods shouldn't have a corresponding set method.</span>
    <span class="s3">for </span><span class="s1">method </span><span class="s3">in </span><span class="s1">COMPOSITE_METHODS</span><span class="s4">:</span>
        <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">SimpleEstimator</span><span class="s4">(), </span><span class="s6">f&quot;set_</span><span class="s3">{</span><span class="s1">method</span><span class="s3">}</span><span class="s6">_request&quot;</span><span class="s4">)</span>

    <span class="s2"># simple methods should have a corresponding set method.</span>
    <span class="s3">for </span><span class="s1">method </span><span class="s3">in </span><span class="s1">SIMPLE_METHODS</span><span class="s4">:</span>
        <span class="s3">assert </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">SimpleEstimator</span><span class="s4">(), </span><span class="s6">f&quot;set_</span><span class="s3">{</span><span class="s1">method</span><span class="s3">}</span><span class="s6">_request&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_composite_methods</span><span class="s4">():</span>
    <span class="s2"># Test the behavior and the values of methods (composite methods) whose</span>
    <span class="s2"># request values are a union of requests by other methods (simple methods).</span>
    <span class="s2"># fit_transform and fit_predict are the only composite methods we have in</span>
    <span class="s2"># scikit-learn.</span>
    <span class="s3">class </span><span class="s1">SimpleEstimator</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s2"># This class should have every set_{method}_request</span>
        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">foo</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">bar</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">predict</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">foo</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">bar</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

        <span class="s3">def </span><span class="s1">transform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">other_param</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">pass  </span><span class="s2"># pragma: no cover</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">SimpleEstimator</span><span class="s4">()</span>
    <span class="s2"># Since no request is set for fit or predict or transform, the request for</span>
    <span class="s2"># fit_transform and fit_predict should also be empty.</span>
    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">fit_transform</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span>
        <span class="s6">&quot;bar&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s6">&quot;other_param&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">}</span>
    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">fit_predict</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span><span class="s6">&quot;bar&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">, </span><span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">None</span><span class="s4">}</span>

    <span class="s2"># setting the request on only one of them should raise an error</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">bar</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Conflicting metadata requests for&quot;</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">fit_predict</span>

    <span class="s2"># setting the request on the other one should fail if not the same as the</span>
    <span class="s2"># first method</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">set_predict_request</span><span class="s4">(</span><span class="s1">bar</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Conflicting metadata requests for&quot;</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">fit_predict</span>

    <span class="s2"># now the requests are consistent and getting the requests for fit_predict</span>
    <span class="s2"># shouldn't raise.</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">set_predict_request</span><span class="s4">(</span><span class="s1">foo</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">bar</span><span class="s4">=</span><span class="s6">&quot;test&quot;</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">fit_predict</span>

    <span class="s2"># setting the request for a none-overlapping parameter would merge them</span>
    <span class="s2"># together.</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">set_transform_request</span><span class="s4">(</span><span class="s1">other_param</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">get_metadata_routing</span><span class="s4">().</span><span class="s1">fit_transform</span><span class="s4">.</span><span class="s1">requests </span><span class="s4">== {</span>
        <span class="s6">&quot;bar&quot;</span><span class="s4">: </span><span class="s6">&quot;test&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;foo&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s6">&quot;other_param&quot;</span><span class="s4">: </span><span class="s3">True</span><span class="s4">,</span>
    <span class="s4">}</span>


<span class="s3">def </span><span class="s1">test_no_feature_flag_raises_error</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that when feature flag disabled, set_{method}_requests raises.&quot;&quot;&quot;</span>
    <span class="s3">with </span><span class="s1">config_context</span><span class="s4">(</span><span class="s1">enable_metadata_routing</span><span class="s4">=</span><span class="s3">False</span><span class="s4">):</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">RuntimeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;This method is only available&quot;</span><span class="s4">):</span>
            <span class="s1">ConsumingClassifier</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_none_metadata_passed</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that passing None as metadata when not requested doesn't raise&quot;&quot;&quot;</span>
    <span class="s1">MetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingRegressor</span><span class="s4">()).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_no_metadata_always_works</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that when no metadata is passed, having a meta-estimator which does 
    not yet support metadata routing works. 
 
    Non-regression test for https://github.com/scikit-learn/scikit-learn/issues/28246 
    &quot;&quot;&quot;</span>

    <span class="s3">class </span><span class="s1">Estimator</span><span class="s4">(</span><span class="s1">_RoutingNotSupportedMixin</span><span class="s4">, </span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s2"># This passes since no metadata is passed.</span>
    <span class="s1">MetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">Estimator</span><span class="s4">()).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s2"># This fails since metadata is passed but Estimator() does not support it.</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span>
        <span class="s1">NotImplementedError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Estimator has not implemented metadata routing yet.&quot;</span>
    <span class="s4">):</span>
        <span class="s1">MetaRegressor</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">Estimator</span><span class="s4">()).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s1">my_groups</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_unsetmetadatapassederror_correct</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that UnsetMetadataPassedError raises the correct error message when 
    set_{method}_request is not set in nested cases.&quot;&quot;&quot;</span>
    <span class="s1">weighted_meta </span><span class="s4">= </span><span class="s1">WeightedMetaClassifier</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">=</span><span class="s1">ConsumingClassifier</span><span class="s4">())</span>
    <span class="s1">pipe </span><span class="s4">= </span><span class="s1">SimplePipeline</span><span class="s4">([</span><span class="s1">weighted_meta</span><span class="s4">])</span>
    <span class="s1">msg </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span>
        <span class="s6">&quot;[metadata] are passed but are not explicitly set as requested or not requested&quot;</span>
        <span class="s6">&quot; for ConsumingClassifier.fit, which is used within WeightedMetaClassifier.fit.&quot;</span>
        <span class="s6">&quot; Call `ConsumingClassifier.set_fit_request({metadata}=True/False)` for each&quot;</span>
        <span class="s6">&quot; metadata you want to request/ignore.&quot;</span>
    <span class="s4">)</span>

    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">UnsetMetadataPassedError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg</span><span class="s4">):</span>
        <span class="s1">pipe</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s6">&quot;blah&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_unsetmetadatapassederror_correct_for_composite_methods</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that UnsetMetadataPassedError raises the correct error message when 
    composite metadata request methods are not set in nested cases.&quot;&quot;&quot;</span>
    <span class="s1">consuming_transformer </span><span class="s4">= </span><span class="s1">ConsumingTransformer</span><span class="s4">()</span>
    <span class="s1">pipe </span><span class="s4">= </span><span class="s1">Pipeline</span><span class="s4">([(</span><span class="s6">&quot;consuming_transformer&quot;</span><span class="s4">, </span><span class="s1">consuming_transformer</span><span class="s4">)])</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span>
        <span class="s6">&quot;[metadata] are passed but are not explicitly set as requested or not requested&quot;</span>
        <span class="s6">&quot; for ConsumingTransformer.fit_transform, which is used within&quot;</span>
        <span class="s6">&quot; Pipeline.fit_transform. Call&quot;</span>
        <span class="s6">&quot; `ConsumingTransformer.set_fit_request({metadata}=True/False)&quot;</span>
        <span class="s6">&quot;.set_transform_request({metadata}=True/False)`&quot;</span>
        <span class="s6">&quot; for each metadata you want to request/ignore.&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">UnsetMetadataPassedError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg</span><span class="s4">):</span>
        <span class="s1">pipe</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">metadata</span><span class="s4">=</span><span class="s6">&quot;blah&quot;</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_unbound_set_methods_work</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Tests that if the set_{method}_request is unbound, it still works. 
 
    Also test that passing positional arguments to the set_{method}_request fails 
    with the right TypeError message. 
 
    Non-regression test for https://github.com/scikit-learn/scikit-learn/issues/28632 
    &quot;&quot;&quot;</span>

    <span class="s3">class </span><span class="s1">A</span><span class="s4">(</span><span class="s1">BaseEstimator</span><span class="s4">):</span>
        <span class="s3">def </span><span class="s1">fit</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">self</span>

    <span class="s1">error_message </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span>
        <span class="s6">&quot;set_fit_request() takes 0 positional argument but 1 were given&quot;</span>
    <span class="s4">)</span>

    <span class="s2"># Test positional arguments error before making the descriptor method unbound.</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">error_message</span><span class="s4">):</span>
        <span class="s1">A</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s2"># This somehow makes the descriptor method unbound, which results in the `instance`</span>
    <span class="s2"># argument being None, and instead `self` being passed as a positional argument</span>
    <span class="s2"># to the descriptor method.</span>
    <span class="s1">A</span><span class="s4">.</span><span class="s1">set_fit_request </span><span class="s4">= </span><span class="s1">A</span><span class="s4">.</span><span class="s1">set_fit_request</span>

    <span class="s2"># This should pass as usual</span>
    <span class="s1">A</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s2"># Test positional arguments error after making the descriptor method unbound.</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">error_message</span><span class="s4">):</span>
        <span class="s1">A</span><span class="s4">().</span><span class="s1">set_fit_request</span><span class="s4">(</span><span class="s3">True</span><span class="s4">)</span>
</pre>
</body>
</html>