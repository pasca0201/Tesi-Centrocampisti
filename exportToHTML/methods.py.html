<html>
<head>
<title>methods.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #7a7e85;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
methods.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">operator</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_typing </span><span class="s0">import </span><span class="s1">Dtype</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">common </span><span class="s0">import </span><span class="s1">is_bool_dtype</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">dtypes </span><span class="s0">import </span><span class="s1">NumpyEADtype</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">missing </span><span class="s0">import </span><span class="s1">na_value_for_dtype</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">sorting </span><span class="s0">import </span><span class="s1">nargsort</span>


<span class="s0">class </span><span class="s1">BaseMethodsTests</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot;Various Series and DataFrame methods.&quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">test_hash_pandas_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># _hash_pandas_object should return a uint64 ndarray of the same length</span>
        <span class="s4"># as the data</span>
        <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">hashing </span><span class="s0">import </span><span class="s1">_default_hash_key</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">_hash_pandas_object</span><span class="s2">(</span>
            <span class="s1">encoding</span><span class="s2">=</span><span class="s5">&quot;utf-8&quot;</span><span class="s2">, </span><span class="s1">hash_key</span><span class="s2">=</span><span class="s1">_default_hash_key</span><span class="s2">, </span><span class="s1">categorize</span><span class="s2">=</span><span class="s0">False</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span>

    <span class="s0">def </span><span class="s1">test_value_counts_default_dropna</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># make sure we have consistent default dropna kwarg</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s5">&quot;value_counts&quot;</span><span class="s2">):</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">f&quot;value_counts is not implemented for </span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span><span class="s0">}</span><span class="s5">&quot;</span><span class="s2">)</span>
        <span class="s1">sig </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">signature</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">value_counts</span><span class="s2">)</span>
        <span class="s1">kwarg </span><span class="s2">= </span><span class="s1">sig</span><span class="s2">.</span><span class="s1">parameters</span><span class="s2">[</span><span class="s5">&quot;dropna&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">kwarg</span><span class="s2">.</span><span class="s1">default </span><span class="s0">is True</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;dropna&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_value_counts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">all_data</span><span class="s2">, </span><span class="s1">dropna</span><span class="s2">):</span>
        <span class="s1">all_data </span><span class="s2">= </span><span class="s1">all_data</span><span class="s2">[:</span><span class="s6">10</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">dropna</span><span class="s2">:</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">all_data</span><span class="s2">[~</span><span class="s1">all_data</span><span class="s2">.</span><span class="s1">isna</span><span class="s2">()]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">all_data</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">all_data</span><span class="s2">).</span><span class="s1">value_counts</span><span class="s2">(</span><span class="s1">dropna</span><span class="s2">=</span><span class="s1">dropna</span><span class="s2">).</span><span class="s1">sort_index</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">other</span><span class="s2">).</span><span class="s1">value_counts</span><span class="s2">(</span><span class="s1">dropna</span><span class="s2">=</span><span class="s1">dropna</span><span class="s2">).</span><span class="s1">sort_index</span><span class="s2">()</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_value_counts_with_normalize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># GH 33172</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">10</span><span class="s2">].</span><span class="s1">unique</span><span class="s2">()</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[~</span><span class="s1">data</span><span class="s2">.</span><span class="s1">isna</span><span class="s2">()])</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">value_counts</span><span class="s2">(</span><span class="s1">normalize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">).</span><span class="s1">sort_index</span><span class="s2">()</span>

        <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">):</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s6">1 </span><span class="s2">/ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;proportion&quot;</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s6">0.0</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;proportion&quot;</span><span class="s2">)</span>
            <span class="s1">expected</span><span class="s2">[</span><span class="s1">result </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s2">] = </span><span class="s6">1 </span><span class="s2">/ </span><span class="s1">len</span><span class="s2">(</span><span class="s1">values</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s5">&quot;storage&quot;</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s2">) == </span><span class="s5">&quot;pyarrow&quot; </span><span class="s0">or </span><span class="s1">isinstance</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">ArrowDtype</span>
        <span class="s2">):</span>
            <span class="s4"># TODO: avoid special-casing</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;double[pyarrow]&quot;</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s5">&quot;storage&quot;</span><span class="s2">, </span><span class="s5">&quot;&quot;</span><span class="s2">) == </span><span class="s5">&quot;pyarrow_numpy&quot;</span><span class="s2">:</span>
            <span class="s4"># TODO: avoid special-casing</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;float64&quot;</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">na_value_for_dtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">) </span><span class="s0">is </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA</span><span class="s2">:</span>
            <span class="s4"># TODO(GH#44692): avoid special-casing</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s5">&quot;Float64&quot;</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_count</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">data_missing</span><span class="s2">})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">&quot;columns&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_series_count</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing</span><span class="s2">):</span>
        <span class="s4"># GH#26835</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data_missing</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">count</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>

    <span class="s0">def </span><span class="s1">test_apply_simple_series</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">id</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;na_action&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s5">&quot;ignore&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_map</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing</span><span class="s2">, </span><span class="s1">na_action</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data_missing</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s1">na_action</span><span class="s2">=</span><span class="s1">na_action</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">data_missing</span><span class="s2">.</span><span class="s1">to_numpy</span><span class="s2">()</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_argsort</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_sorting</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data_for_sorting</span><span class="s2">).</span><span class="s1">argsort</span><span class="s2">()</span>
        <span class="s4"># argsort result gets passed to take, so should be np.intp</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_argsort_missing_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data_missing_for_sorting</span><span class="s2">.</span><span class="s1">argsort</span><span class="s2">()</span>
        <span class="s4"># argsort result gets passed to take, so should be np.intp</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_argsort_missing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;The behavior of Series.argsort in the presence of NA values&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data_missing_for_sorting</span><span class="s2">).</span><span class="s1">argsort</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_argmin_argmax</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_sorting</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">):</span>
        <span class="s4"># GH 24382</span>
        <span class="s1">is_bool </span><span class="s2">= </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">_is_boolean</span>

        <span class="s1">exp_argmax </span><span class="s2">= </span><span class="s6">1</span>
        <span class="s1">exp_argmax_repeated </span><span class="s2">= </span><span class="s6">3</span>
        <span class="s0">if </span><span class="s1">is_bool</span><span class="s2">:</span>
            <span class="s4"># See data_for_sorting docstring</span>
            <span class="s1">exp_argmax </span><span class="s2">= </span><span class="s6">0</span>
            <span class="s1">exp_argmax_repeated </span><span class="s2">= </span><span class="s6">1</span>

        <span class="s4"># data_for_sorting -&gt; [B, C, A] with A &lt; B &lt; C</span>
        <span class="s0">assert </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">() == </span><span class="s1">exp_argmax</span>
        <span class="s0">assert </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">() == </span><span class="s6">2</span>

        <span class="s4"># with repeated values -&gt; first occurrence</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">() == </span><span class="s1">exp_argmax_repeated</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">() == </span><span class="s6">0</span>

        <span class="s4"># with missing values</span>
        <span class="s4"># data_missing_for_sorting -&gt; [B, NA, A] with A &lt; B and NA missing.</span>
        <span class="s0">assert </span><span class="s1">data_missing_for_sorting</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">() == </span><span class="s6">0</span>
        <span class="s0">assert </span><span class="s1">data_missing_for_sorting</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">() == </span><span class="s6">2</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;method&quot;</span><span class="s2">, [</span><span class="s5">&quot;argmax&quot;</span><span class="s2">, </span><span class="s5">&quot;argmin&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_argmin_argmax_empty_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># GH 24382</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s5">&quot;attempt to get&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">], </span><span class="s1">method</span><span class="s2">)()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;method&quot;</span><span class="s2">, [</span><span class="s5">&quot;argmax&quot;</span><span class="s2">, </span><span class="s5">&quot;argmin&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_argmin_argmax_all_na</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">):</span>
        <span class="s4"># all missing with skipna=True is the same as empty</span>
        <span class="s1">err_msg </span><span class="s2">= </span><span class="s5">&quot;attempt to get&quot;</span>
        <span class="s1">data_na </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">na_value</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">getattr</span><span class="s2">(</span><span class="s1">data_na</span><span class="s2">, </span><span class="s1">method</span><span class="s2">)()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;op_name, skipna, expected&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s5">&quot;idxmax&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s6">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;idxmin&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s6">2</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;argmax&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s6">0</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;argmin&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s6">2</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;idxmax&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;idxmin&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;argmax&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s5">&quot;argmin&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_argreduce_series</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">, </span><span class="s1">op_name</span><span class="s2">, </span><span class="s1">skipna</span><span class="s2">, </span><span class="s1">expected</span>
    <span class="s2">):</span>
        <span class="s4"># data_missing_for_sorting -&gt; [B, NA, A] with A &lt; B and NA missing.</span>
        <span class="s1">warn </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;The behavior of Series.argmax/argmin&quot;</span>
        <span class="s0">if </span><span class="s1">op_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">&quot;arg&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">expected </span><span class="s2">== -</span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">warn </span><span class="s2">= </span><span class="s1">FutureWarning</span>
        <span class="s0">if </span><span class="s1">op_name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s5">&quot;idx&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">):</span>
            <span class="s1">warn </span><span class="s2">= </span><span class="s1">FutureWarning</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s5">f&quot;The behavior of Series.</span><span class="s0">{</span><span class="s1">op_name</span><span class="s0">}</span><span class="s5">&quot;</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data_missing_for_sorting</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warn</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">op_name</span><span class="s2">)(</span><span class="s1">skipna</span><span class="s2">=</span><span class="s1">skipna</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_argmax_argmin_no_skipna_notimplemented</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">):</span>
        <span class="s4"># GH#38733</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data_missing_for_sorting</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;&quot;</span><span class="s2">):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">argmin</span><span class="s2">(</span><span class="s1">skipna</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;&quot;</span><span class="s2">):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">(</span><span class="s1">skipna</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;na_position, expected&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s5">&quot;last&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">&quot;intp&quot;</span><span class="s2">))),</span>
            <span class="s2">(</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s5">&quot;intp&quot;</span><span class="s2">))),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_nargsort</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">, </span><span class="s1">na_position</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
        <span class="s4"># GH 25439</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">nargsort</span><span class="s2">(</span><span class="s1">data_missing_for_sorting</span><span class="s2">, </span><span class="s1">na_position</span><span class="s2">=</span><span class="s1">na_position</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;ascending&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sort_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_sorting</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">, </span><span class="s1">sort_by_key</span><span class="s2">):</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data_for_sorting</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s1">ascending</span><span class="s2">=</span><span class="s1">ascending</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">sort_by_key</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[[</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]]</span>
        <span class="s0">if not </span><span class="s1">ascending</span><span class="s2">:</span>
            <span class="s4"># GH 35922. Expect stable sort</span>
            <span class="s0">if </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">nunique</span><span class="s2">() == </span><span class="s6">2</span><span class="s2">:</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">]]</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[[</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">2</span><span class="s2">]]</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;ascending&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sort_values_missing</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing_for_sorting</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">, </span><span class="s1">sort_by_key</span>
    <span class="s2">):</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data_missing_for_sorting</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s1">ascending</span><span class="s2">=</span><span class="s1">ascending</span><span class="s2">, </span><span class="s1">key</span><span class="s2">=</span><span class="s1">sort_by_key</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ascending</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[[</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;ascending&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_sort_values_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_sorting</span><span class="s2">, </span><span class="s1">ascending</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s1">data_for_sorting</span><span class="s2">})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">([</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s5">&quot;A&quot;</span><span class="s2">: [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;keep&quot;</span><span class="s2">, [</span><span class="s5">&quot;first&quot;</span><span class="s2">, </span><span class="s5">&quot;last&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_duplicated</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">keep</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">duplicated</span><span class="s2">(</span><span class="s1">keep</span><span class="s2">=</span><span class="s1">keep</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">keep </span><span class="s2">== </span><span class="s5">&quot;first&quot;</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s0">elif </span><span class="s1">keep </span><span class="s2">== </span><span class="s5">&quot;last&quot;</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;box&quot;</span><span class="s2">, [</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;method&quot;</span><span class="s2">, [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(), </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_unique</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">box</span><span class="s2">, </span><span class="s1">method</span><span class="s2">):</span>
        <span class="s1">duplicated </span><span class="s2">= </span><span class="s1">box</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">], </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">method</span><span class="s2">(</span><span class="s1">duplicated</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">result</span><span class="s2">) == </span><span class="s6">1</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] == </span><span class="s1">duplicated</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_factorize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_grouping</span><span class="s2">):</span>
        <span class="s1">codes</span><span class="s2">, </span><span class="s1">uniques </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">factorize</span><span class="s2">(</span><span class="s1">data_for_grouping</span><span class="s2">, </span><span class="s1">use_na_sentinel</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">is_bool </span><span class="s2">= </span><span class="s1">data_for_grouping</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">_is_boolean</span>
        <span class="s0">if </span><span class="s1">is_bool</span><span class="s2">:</span>
            <span class="s4"># only 2 unique values</span>
            <span class="s1">expected_codes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
            <span class="s1">expected_uniques </span><span class="s2">= </span><span class="s1">data_for_grouping</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">4</span><span class="s2">])</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">expected_codes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
            <span class="s1">expected_uniques </span><span class="s2">= </span><span class="s1">data_for_grouping</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">4</span><span class="s2">, </span><span class="s6">7</span><span class="s2">])</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">expected_codes</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">uniques</span><span class="s2">, </span><span class="s1">expected_uniques</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_factorize_equivalence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_grouping</span><span class="s2">):</span>
        <span class="s1">codes_1</span><span class="s2">, </span><span class="s1">uniques_1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">factorize</span><span class="s2">(</span><span class="s1">data_for_grouping</span><span class="s2">, </span><span class="s1">use_na_sentinel</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">codes_2</span><span class="s2">, </span><span class="s1">uniques_2 </span><span class="s2">= </span><span class="s1">data_for_grouping</span><span class="s2">.</span><span class="s1">factorize</span><span class="s2">(</span><span class="s1">use_na_sentinel</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">codes_1</span><span class="s2">, </span><span class="s1">codes_2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">uniques_1</span><span class="s2">, </span><span class="s1">uniques_2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">uniques_1</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">uniques_1</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">uniques_1</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">data_for_grouping</span><span class="s2">.</span><span class="s1">dtype</span>

    <span class="s0">def </span><span class="s1">test_factorize_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">codes</span><span class="s2">, </span><span class="s1">uniques </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">factorize</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">])</span>
        <span class="s1">expected_codes </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>
        <span class="s1">expected_uniques </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">([], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">expected_codes</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">uniques</span><span class="s2">, </span><span class="s1">expected_uniques</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fillna_copy_frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">data_missing</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">arr</span><span class="s2">})</span>
        <span class="s1">df_orig </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s1">filled_val </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">fillna</span><span class="s2">(</span><span class="s1">filled_val</span><span class="s2">)</span>

        <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">] = </span><span class="s1">filled_val</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_orig</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fillna_copy_series</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">data_missing</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ser_orig </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s1">filled_val </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">fillna</span><span class="s2">(</span><span class="s1">filled_val</span><span class="s2">)</span>
        <span class="s1">result</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] = </span><span class="s1">filled_val</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">ser_orig</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_fillna_length_mismatch</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_missing</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s5">&quot;Length of 'value' does not match.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">data_missing</span><span class="s2">.</span><span class="s1">fillna</span><span class="s2">(</span><span class="s1">data_missing</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">1</span><span class="s2">]))</span>

    <span class="s4"># Subclasses can override if we expect e.g Sparse[bool], boolean, pyarrow[bool]</span>
    <span class="s1">_combine_le_expected_dtype</span><span class="s2">: </span><span class="s1">Dtype </span><span class="s2">= </span><span class="s1">NumpyEADtype</span><span class="s2">(</span><span class="s5">&quot;bool&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_combine_le</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_repeated</span><span class="s2">):</span>
        <span class="s4"># GH 20825</span>
        <span class="s4"># Test that combine works when doing a &lt;= (le) comparison</span>
        <span class="s1">orig_data1</span><span class="s2">, </span><span class="s1">orig_data2 </span><span class="s2">= </span><span class="s1">data_repeated</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">orig_data1</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">orig_data2</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">(</span><span class="s1">s2</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">: </span><span class="s1">x1 </span><span class="s2">&lt;= </span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">a </span><span class="s2">&lt;= </span><span class="s1">b </span><span class="s0">for </span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">orig_data1</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">orig_data2</span><span class="s2">))],</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_combine_le_expected_dtype</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">val </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">: </span><span class="s1">x1 </span><span class="s2">&lt;= </span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">a </span><span class="s2">&lt;= </span><span class="s1">val </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">orig_data1</span><span class="s2">)],</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_combine_le_expected_dtype</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_combine_add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_repeated</span><span class="s2">):</span>
        <span class="s4"># GH 20825</span>
        <span class="s1">orig_data1</span><span class="s2">, </span><span class="s1">orig_data2 </span><span class="s2">= </span><span class="s1">data_repeated</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">orig_data1</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">orig_data2</span><span class="s2">)</span>

        <span class="s4"># Check if the operation is supported pointwise for our scalars. If not,</span>
        <span class="s4">#  we will expect Series.combine to raise as well.</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">over</span><span class="s2">=</span><span class="s5">&quot;ignore&quot;</span><span class="s2">):</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
                    <span class="s1">orig_data1</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">(</span>
                        <span class="s2">[</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">b </span><span class="s0">for </span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">orig_data1</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s1">orig_data2</span><span class="s2">))]</span>
                    <span class="s2">)</span>
                <span class="s2">)</span>
        <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
            <span class="s4"># If the operation is not supported pointwise for our scalars,</span>
            <span class="s4">#  then Series.combine should also raise</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
                <span class="s1">s1</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">(</span><span class="s1">s2</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">: </span><span class="s1">x1 </span><span class="s2">+ </span><span class="s1">x2</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">(</span><span class="s1">s2</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">: </span><span class="s1">x1 </span><span class="s2">+ </span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">val </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">s1</span><span class="s2">.</span><span class="s1">combine</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">: </span><span class="s1">x1 </span><span class="s2">+ </span><span class="s1">x2</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">orig_data1</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">val </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">orig_data1</span><span class="s2">)])</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_combine_first</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/24147</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">3</span><span class="s2">])</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s6">2</span><span class="s2">:</span><span class="s6">5</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">a</span><span class="s2">.</span><span class="s1">combine_first</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">5</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;frame&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;periods, indices&quot;</span><span class="s2">,</span>
        <span class="s2">[(-</span><span class="s6">2</span><span class="s2">, [</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">]), (</span><span class="s6">0</span><span class="s2">, [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">4</span><span class="s2">]), (</span><span class="s6">2</span><span class="s2">, [-</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">])],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_container_shift</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/22386</span>
        <span class="s1">subset </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">5</span><span class="s2">]</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">allow_fill</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;A&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">frame</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;A&quot;</span><span class="s2">).</span><span class="s1">assign</span><span class="s2">(</span><span class="s1">B</span><span class="s2">=</span><span class="s6">1</span><span class="s2">).</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s6">1</span><span class="s2">] * </span><span class="s6">5</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;B&quot;</span><span class="s2">).</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)], </span><span class="s1">axis</span><span class="s2">=</span><span class="s6">1</span>
            <span class="s2">)</span>
            <span class="s1">compare </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)</span>
            <span class="s1">compare </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span>

        <span class="s1">compare</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_shift_0_periods</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># GH#33856 shifting with periods=0 should return a copy, not same obj</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] != </span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]  </span><span class="s4"># otherwise below is invalid</span>
        <span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] = </span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] != </span><span class="s1">result</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]  </span><span class="s4"># i.e. not the same object/view</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;periods&quot;</span><span class="s2">, [</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">2</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_diff</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">5</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">is_bool_dtype</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">):</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">xor</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">op </span><span class="s2">= </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">sub</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s4"># does this array implement ops?</span>
            <span class="s1">op</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">Exception</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s5">f&quot;</span><span class="s0">{</span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span><span class="s0">} </span><span class="s5">does not support diff&quot;</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">s</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">op</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">data</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">: [</span><span class="s6">1.0</span><span class="s2">] * </span><span class="s6">5</span><span class="s2">})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">diff</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">periods </span><span class="s2">== </span><span class="s6">1</span><span class="s2">:</span>
            <span class="s1">b </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">b </span><span class="s2">= [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;A&quot;</span><span class="s2">: </span><span class="s1">expected</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">: </span><span class="s1">b</span><span class="s2">})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;periods, indices&quot;</span><span class="s2">,</span>
        <span class="s2">[[-</span><span class="s6">4</span><span class="s2">, [-</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">]], [-</span><span class="s6">1</span><span class="s2">, [</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">]], [</span><span class="s6">0</span><span class="s2">, [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]], [</span><span class="s6">1</span><span class="s2">, [-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">]], [</span><span class="s6">4</span><span class="s2">, [-</span><span class="s6">1</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">]]],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_shift_non_empty_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">, </span><span class="s1">indices</span><span class="s2">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/23911</span>
        <span class="s1">subset </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">subset</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">subset</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s1">indices</span><span class="s2">, </span><span class="s1">allow_fill</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;periods&quot;</span><span class="s2">, [-</span><span class="s6">4</span><span class="s2">, -</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">4</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_shift_empty_array</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/23911</span>
        <span class="s1">empty </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">empty</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s1">periods</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">empty</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_shift_zero_copies</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># GH#31502</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result </span><span class="s0">is not </span><span class="s1">data</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">].</span><span class="s1">shift</span><span class="s2">(</span><span class="s6">2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result </span><span class="s0">is not </span><span class="s1">data</span>

    <span class="s0">def </span><span class="s1">test_shift_fill_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">4</span><span class="s2">]</span>
        <span class="s1">fill_value </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(</span><span class="s6">1</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">fill_value</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">shift</span><span class="s2">(-</span><span class="s6">2</span><span class="s2">, </span><span class="s1">fill_value</span><span class="s2">=</span><span class="s1">fill_value</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_hashable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># We are in general mutable, so not hashable</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;unhashable type&quot;</span><span class="s2">):</span>
            <span class="s1">hash</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_hash_pandas_object_works</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">as_frame</span><span class="s2">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/23066</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">()</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">hash_pandas_object</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">hash_pandas_object</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_searchsorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_sorting</span><span class="s2">, </span><span class="s1">as_series</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">_is_boolean</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_test_searchsorted_bool_dtypes</span><span class="s2">(</span><span class="s1">data_for_sorting</span><span class="s2">, </span><span class="s1">as_series</span><span class="s2">)</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">data_for_sorting</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">])  </span><span class="s4"># to get [a, b, c]</span>

        <span class="s0">if </span><span class="s1">as_series</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) == </span><span class="s6">0</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">side</span><span class="s2">=</span><span class="s5">&quot;right&quot;</span><span class="s2">) == </span><span class="s6">1</span>

        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">b</span><span class="s2">) == </span><span class="s6">1</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">side</span><span class="s2">=</span><span class="s5">&quot;right&quot;</span><span class="s2">) == </span><span class="s6">2</span>

        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) == </span><span class="s6">2</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">side</span><span class="s2">=</span><span class="s5">&quot;right&quot;</span><span class="s2">) == </span><span class="s6">3</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">2</span><span class="s2">]))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s4"># sorter</span>
        <span class="s1">sorter </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">sorter</span><span class="s2">=</span><span class="s1">sorter</span><span class="s2">) == </span><span class="s6">0</span>

    <span class="s0">def </span><span class="s1">_test_searchsorted_bool_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data_for_sorting</span><span class="s2">, </span><span class="s1">as_series</span><span class="s2">):</span>
        <span class="s4"># We call this from test_searchsorted in cases where we have a</span>
        <span class="s4">#  boolean-like dtype. The non-bool test assumes we have more than 2</span>
        <span class="s4">#  unique values.</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s1">data_for_sorting </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">a </span><span class="s2">= </span><span class="s1">data_for_sorting</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data_for_sorting</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">as_series</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">) == </span><span class="s6">0</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">side</span><span class="s2">=</span><span class="s5">&quot;right&quot;</span><span class="s2">) == </span><span class="s6">1</span>

        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">b</span><span class="s2">) == </span><span class="s6">1</span>
        <span class="s0">assert </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">side</span><span class="s2">=</span><span class="s5">&quot;right&quot;</span><span class="s2">) == </span><span class="s6">2</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">take</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">]))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">intp</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_numpy_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s4"># sorter</span>
        <span class="s1">sorter </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">0</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">data_for_sorting</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">sorter</span><span class="s2">=</span><span class="s1">sorter</span><span class="s2">) == </span><span class="s6">0</span>

    <span class="s0">def </span><span class="s1">test_where_series</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">, </span><span class="s1">as_frame</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">] != </span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s1">cls </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">]</span>

        <span class="s1">orig </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">orig</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">cond </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>

        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s1">ser </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;a&quot;</span><span class="s2">)</span>
            <span class="s1">cond </span><span class="s2">= </span><span class="s1">cond</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s6">1</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">cls</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">ser</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(~</span><span class="s1">cond</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s4"># array other</span>
        <span class="s1">ser </span><span class="s2">= </span><span class="s1">orig</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s1">ser </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">cond </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
        <span class="s1">other </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s1">other </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s1">other</span><span class="s2">})</span>
            <span class="s1">cond </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s5">&quot;a&quot;</span><span class="s2">: </span><span class="s1">cond</span><span class="s2">})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">cond</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">.</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">))</span>
        <span class="s0">if </span><span class="s1">as_frame</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s5">&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">ser</span><span class="s2">.</span><span class="s1">mask</span><span class="s2">(~</span><span class="s1">cond</span><span class="s2">, </span><span class="s1">other</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;repeats&quot;</span><span class="s2">, [</span><span class="s6">0</span><span class="s2">, </span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, [</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">, </span><span class="s6">3</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_repeat</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">repeats</span><span class="s2">, </span><span class="s1">as_series</span><span class="s2">, </span><span class="s1">use_numpy</span><span class="s2">):</span>
        <span class="s1">arr </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">as_series</span><span class="s2">:</span>
            <span class="s1">arr </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">repeats</span><span class="s2">) </span><span class="s0">if </span><span class="s1">use_numpy </span><span class="s0">else </span><span class="s1">arr</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">repeats</span><span class="s2">)</span>

        <span class="s1">repeats </span><span class="s2">= [</span><span class="s1">repeats</span><span class="s2">] * </span><span class="s6">3 </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">repeats</span><span class="s2">, </span><span class="s1">int</span><span class="s2">) </span><span class="s0">else </span><span class="s1">repeats</span>
        <span class="s1">expected </span><span class="s2">= [</span><span class="s1">x </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">, </span><span class="s1">repeats</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">as_series</span><span class="s2">:</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">arr</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">repeats</span><span class="s2">))</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">&quot;repeats, kwargs, error, msg&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s6">2</span><span class="s2">, {</span><span class="s5">&quot;axis&quot;</span><span class="s2">: </span><span class="s6">1</span><span class="s2">}, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s5">&quot;axis&quot;</span><span class="s2">),</span>
            <span class="s2">(-</span><span class="s6">1</span><span class="s2">, {}, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s5">&quot;negative&quot;</span><span class="s2">),</span>
            <span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">2</span><span class="s2">], {}, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s5">&quot;shape&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s6">2</span><span class="s2">, {</span><span class="s5">&quot;foo&quot;</span><span class="s2">: </span><span class="s5">&quot;bar&quot;</span><span class="s2">}, </span><span class="s1">TypeError</span><span class="s2">, </span><span class="s5">&quot;'foo'&quot;</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_repeat_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">repeats</span><span class="s2">, </span><span class="s1">kwargs</span><span class="s2">, </span><span class="s1">error</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">use_numpy</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">use_numpy</span><span class="s2">:</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">repeats</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">data</span><span class="s2">.</span><span class="s1">repeat</span><span class="s2">(</span><span class="s1">repeats</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_delete</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s6">0</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">([</span><span class="s6">1</span><span class="s2">, </span><span class="s6">3</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">_concat_same_type</span><span class="s2">([</span><span class="s1">data</span><span class="s2">[[</span><span class="s6">0</span><span class="s2">]], </span><span class="s1">data</span><span class="s2">[[</span><span class="s6">2</span><span class="s2">]], </span><span class="s1">data</span><span class="s2">[</span><span class="s6">4</span><span class="s2">:]])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># insert at the beginning</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:].</span><span class="s1">insert</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:].</span><span class="s1">insert</span><span class="s2">(-</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s6">1</span><span class="s2">:]), </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">data</span><span class="s2">)</span>

        <span class="s4"># insert at the middle</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[:-</span><span class="s6">1</span><span class="s2">].</span><span class="s1">insert</span><span class="s2">(</span><span class="s6">4</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[-</span><span class="s6">1</span><span class="s2">])</span>

        <span class="s1">taker </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>
        <span class="s1">taker</span><span class="s2">[</span><span class="s6">5</span><span class="s2">:] = </span><span class="s1">taker</span><span class="s2">[</span><span class="s6">4</span><span class="s2">:-</span><span class="s6">1</span><span class="s2">]</span>
        <span class="s1">taker</span><span class="s2">[</span><span class="s6">4</span><span class="s2">] = </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) - </span><span class="s6">1</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">data</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s1">taker</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_extension_array_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_insert_invalid</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">invalid_scalar</span><span class="s2">):</span>
        <span class="s1">item </span><span class="s2">= </span><span class="s1">invalid_scalar</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">item</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s6">4</span><span class="s2">, </span><span class="s1">item</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">)):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) - </span><span class="s6">1</span><span class="s2">, </span><span class="s1">item</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_insert_invalid_loc</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">ub </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">ub </span><span class="s2">+ </span><span class="s6">1</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">IndexError</span><span class="s2">):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(-</span><span class="s1">ub </span><span class="s2">- </span><span class="s6">1</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s4"># we expect TypeError here instead of IndexError to match np.insert</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s6">1.5</span><span class="s2">, </span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">&quot;box&quot;</span><span class="s2">, [</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_equals</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">na_value</span><span class="s2">, </span><span class="s1">as_series</span><span class="s2">, </span><span class="s1">box</span><span class="s2">):</span>
        <span class="s1">data2 </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">data_na </span><span class="s2">= </span><span class="s1">type</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">_from_sequence</span><span class="s2">([</span><span class="s1">na_value</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">data</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">data</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">data </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">box_expected</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">box</span><span class="s2">, </span><span class="s1">transpose</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">data2 </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">box_expected</span><span class="s2">(</span><span class="s1">data2</span><span class="s2">, </span><span class="s1">box</span><span class="s2">, </span><span class="s1">transpose</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">data_na </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">box_expected</span><span class="s2">(</span><span class="s1">data_na</span><span class="s2">, </span><span class="s1">box</span><span class="s2">, </span><span class="s1">transpose</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s4"># we are asserting with `is True/False` explicitly, to test that the</span>
        <span class="s4"># result is an actual Python bool, and not something &quot;truthy&quot;</span>

        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data</span><span class="s2">) </span><span class="s0">is True</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()) </span><span class="s0">is True</span>

        <span class="s4"># unequal other data</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data2</span><span class="s2">) </span><span class="s0">is False</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data_na</span><span class="s2">) </span><span class="s0">is False</span>

        <span class="s4"># different length</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">2</span><span class="s2">].</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">3</span><span class="s2">]) </span><span class="s0">is False</span>

        <span class="s4"># empty are equal</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">].</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[:</span><span class="s6">0</span><span class="s2">]) </span><span class="s0">is True</span>

        <span class="s4"># other types</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">equals</span><span class="s2">(</span><span class="s0">None</span><span class="s2">) </span><span class="s0">is False</span>
        <span class="s0">assert </span><span class="s1">data</span><span class="s2">[[</span><span class="s6">0</span><span class="s2">]].</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">data</span><span class="s2">[</span><span class="s6">0</span><span class="s2">]) </span><span class="s0">is False</span>

    <span class="s0">def </span><span class="s1">test_equals_same_data_different_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/34660</span>
        <span class="s0">assert </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">).</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">data</span><span class="s2">))</span>
</pre>
</body>
</html>