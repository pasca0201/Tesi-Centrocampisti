<html>
<head>
<title>test_backend_bases.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backend_bases.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">importlib</span>

<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">path</span><span class="s2">, </span><span class="s1">transforms</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_bases </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">FigureCanvasBase</span><span class="s2">, </span><span class="s1">KeyEvent</span><span class="s2">, </span><span class="s1">LocationEvent</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">, </span><span class="s1">MouseEvent</span><span class="s2">,</span>
    <span class="s1">NavigationToolbar2</span><span class="s2">, </span><span class="s1">RendererBase</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backend_tools </span><span class="s0">import </span><span class="s1">RubberbandBase</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">import </span><span class="s1">Figure</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">_markers </span><span class="s0">import </span><span class="s1">needs_pgf_xelatex</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>


<span class="s1">_EXPECTED_WARNING_TOOLMANAGER </span><span class="s2">= (</span>
    <span class="s3">r&quot;Treat the new Tool classes introduced in &quot;</span>
    <span class="s3">r&quot;v[0-9]*.[0-9]* as experimental for now; &quot;</span>
    <span class="s3">&quot;the API and rcParam may change in future versions.&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_uses_per_path</span><span class="s2">():</span>
    <span class="s1">id </span><span class="s2">= </span><span class="s1">transforms</span><span class="s2">.</span><span class="s1">Affine2D</span><span class="s2">()</span>
    <span class="s1">paths </span><span class="s2">= [</span><span class="s1">path</span><span class="s2">.</span><span class="s1">Path</span><span class="s2">.</span><span class="s1">unit_regular_polygon</span><span class="s2">(</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">7</span><span class="s2">)]</span>
    <span class="s1">tforms_matrices </span><span class="s2">= [</span><span class="s1">id</span><span class="s2">.</span><span class="s1">rotate</span><span class="s2">(</span><span class="s1">i</span><span class="s2">).</span><span class="s1">get_matrix</span><span class="s2">().</span><span class="s1">copy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)]</span>
    <span class="s1">offsets </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">facecolors </span><span class="s2">= [</span><span class="s3">'red'</span><span class="s2">, </span><span class="s3">'green'</span><span class="s2">]</span>
    <span class="s1">edgecolors </span><span class="s2">= [</span><span class="s3">'red'</span><span class="s2">, </span><span class="s3">'green'</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">master_transform</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">all_transforms</span><span class="s2">,</span>
              <span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">):</span>
        <span class="s1">rb </span><span class="s2">= </span><span class="s1">RendererBase</span><span class="s2">()</span>
        <span class="s1">raw_paths </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">rb</span><span class="s2">.</span><span class="s1">_iter_collection_raw_paths</span><span class="s2">(</span>
            <span class="s1">master_transform</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">all_transforms</span><span class="s2">))</span>
        <span class="s1">gc </span><span class="s2">= </span><span class="s1">rb</span><span class="s2">.</span><span class="s1">new_gc</span><span class="s2">()</span>
        <span class="s1">ids </span><span class="s2">= [</span><span class="s1">path_id </span><span class="s0">for </span><span class="s1">xo</span><span class="s2">, </span><span class="s1">yo</span><span class="s2">, </span><span class="s1">path_id</span><span class="s2">, </span><span class="s1">gc0</span><span class="s2">, </span><span class="s1">rgbFace </span><span class="s0">in</span>
               <span class="s1">rb</span><span class="s2">.</span><span class="s1">_iter_collection</span><span class="s2">(</span>
                   <span class="s1">gc</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">raw_paths</span><span class="s2">)), </span><span class="s1">offsets</span><span class="s2">,</span>
                   <span class="s1">transforms</span><span class="s2">.</span><span class="s1">AffineDeltaTransform</span><span class="s2">(</span><span class="s1">master_transform</span><span class="s2">),</span>
                   <span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">, [], [], [</span><span class="s0">False</span><span class="s2">],</span>
                   <span class="s2">[], </span><span class="s3">'screen'</span><span class="s2">)]</span>
        <span class="s1">uses </span><span class="s2">= </span><span class="s1">rb</span><span class="s2">.</span><span class="s1">_iter_collection_uses_per_path</span><span class="s2">(</span>
            <span class="s1">paths</span><span class="s2">, </span><span class="s1">all_transforms</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">raw_paths</span><span class="s2">:</span>
            <span class="s1">seen </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bincount</span><span class="s2">(</span><span class="s1">ids</span><span class="s2">, </span><span class="s1">minlength</span><span class="s2">=</span><span class="s1">len</span><span class="s2">(</span><span class="s1">raw_paths</span><span class="s2">))</span>
            <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">seen</span><span class="s2">).</span><span class="s1">issubset</span><span class="s2">([</span><span class="s1">uses </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">uses</span><span class="s2">])</span>

    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">1</span><span class="s2">], </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, [], </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">1</span><span class="s2">], </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, [], </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]):</span>
        <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s1">n</span><span class="s2">, :],</span>
              <span class="s1">facecolors</span><span class="s2">, </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, [], </span><span class="s1">edgecolors</span><span class="s2">)</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">, [])</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, [], [])</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">paths</span><span class="s2">, </span><span class="s1">tforms_matrices</span><span class="s2">, </span><span class="s1">offsets</span><span class="s2">, </span><span class="s1">facecolors</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">1</span><span class="s2">], </span><span class="s1">edgecolors</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_canvas_ctor</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">FigureCanvasBase</span><span class="s2">().</span><span class="s1">figure</span><span class="s2">, </span><span class="s1">Figure</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_default_filename</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">().</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">get_default_filename</span><span class="s2">() == </span><span class="s3">'image.png'</span>


<span class="s0">def </span><span class="s1">test_canvas_change</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s5"># Replaces fig.canvas</span>
    <span class="s1">canvas </span><span class="s2">= </span><span class="s1">FigureCanvasBase</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s5"># Should still work.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">fignum_exists</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">number</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pdf'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_non_gui_warning</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s3">&quot;DISPLAY&quot;</span><span class="s2">, </span><span class="s3">&quot;:999&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">) </span><span class="s0">as </span><span class="s1">rec</span><span class="s2">:</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">show</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">) == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s3">'FigureCanvasPdf is non-interactive, and thus cannot be shown'</span>
                <span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">) </span><span class="s0">as </span><span class="s1">rec</span><span class="s2">:</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">().</span><span class="s1">show</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">) == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s3">'FigureCanvasPdf is non-interactive, and thus cannot be shown'</span>
                <span class="s0">in </span><span class="s1">str</span><span class="s2">(</span><span class="s1">rec</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_grab_clear</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">grab_mouse</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mouse_grabber </span><span class="s2">== </span><span class="s1">ax</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mouse_grabber </span><span class="s0">is None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;x, y&quot;</span><span class="s2">, [(</span><span class="s4">42</span><span class="s2">, </span><span class="s4">24</span><span class="s2">), (</span><span class="s0">None</span><span class="s2">, </span><span class="s4">42</span><span class="s2">), (</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">), (</span><span class="s4">200</span><span class="s2">, </span><span class="s4">100.01</span><span class="s2">), (</span><span class="s4">205.75</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_location_event_position</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">):</span>
    <span class="s5"># LocationEvent should cast its x and y arguments to int unless it is None.</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">canvas </span><span class="s2">= </span><span class="s1">FigureCanvasBase</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>
    <span class="s1">event </span><span class="s2">= </span><span class="s1">LocationEvent</span><span class="s2">(</span><span class="s3">&quot;test_event&quot;</span><span class="s2">, </span><span class="s1">canvas</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">x </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">event</span><span class="s2">.</span><span class="s1">x </span><span class="s0">is None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">event</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s1">int</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">y </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">event</span><span class="s2">.</span><span class="s1">y </span><span class="s0">is None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">event</span><span class="s2">.</span><span class="s1">y </span><span class="s2">== </span><span class="s1">int</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">event</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">int</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">x </span><span class="s0">is not None and </span><span class="s1">y </span><span class="s0">is not None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_coord</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
                <span class="s2">== </span><span class="s3">f&quot;(x, y) = (</span><span class="s0">{</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_xdata</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span><span class="s0">}</span><span class="s3">, </span><span class="s0">{</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_ydata</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span><span class="s0">}</span><span class="s3">)&quot;</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">fmt_xdata </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">fmt_ydata </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;foo&quot;</span>
        <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_coord</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) == </span><span class="s3">&quot;(x, y) = (foo, foo)&quot;</span>


<span class="s0">def </span><span class="s1">test_location_event_position_twin</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), </span><span class="s1">ylim</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">20</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_coord</span><span class="s2">(</span><span class="s4">5.</span><span class="s2">, </span><span class="s4">5.</span><span class="s2">) == </span><span class="s3">&quot;(x, y) = (5.00, 5.00)&quot;</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">twinx</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">ylim</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">40</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_coord</span><span class="s2">(</span><span class="s4">5.</span><span class="s2">, </span><span class="s4">5.</span><span class="s2">) == </span><span class="s3">&quot;(x, y) = (5.00, 5.00) | (5.00, 10.0)&quot;</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">twiny</span><span class="s2">().</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xlim</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">format_coord</span><span class="s2">(</span><span class="s4">5.</span><span class="s2">, </span><span class="s4">5.</span><span class="s2">)</span>
            <span class="s2">== </span><span class="s3">&quot;(x, y) = (5.00, 5.00) | (5.00, 10.0) | (2.50, 5.00)&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pick</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s1">ha</span><span class="s2">=</span><span class="s3">&quot;center&quot;</span><span class="s2">, </span><span class="s1">va</span><span class="s2">=</span><span class="s3">&quot;center&quot;</span><span class="s2">, </span><span class="s1">picker</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>

    <span class="s1">picks </span><span class="s2">= []</span>
    <span class="s0">def </span><span class="s1">handle_pick</span><span class="s2">(</span><span class="s1">event</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">event</span><span class="s2">.</span><span class="s1">mouseevent</span><span class="s2">.</span><span class="s1">key </span><span class="s2">== </span><span class="s3">&quot;a&quot;</span>
        <span class="s1">picks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">event</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">mpl_connect</span><span class="s2">(</span><span class="s3">&quot;pick_event&quot;</span><span class="s2">, </span><span class="s1">handle_pick</span><span class="s2">)</span>

    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">,</span>
               <span class="s2">*</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">transFigure</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">((</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">)),</span>
               <span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">picks</span><span class="s2">) == </span><span class="s4">1</span>


<span class="s0">def </span><span class="s1">test_interactive_zoom</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">xscale</span><span class="s2">=</span><span class="s3">&quot;logit&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() </span><span class="s0">is None</span>

    <span class="s1">tb </span><span class="s2">= </span><span class="s1">NavigationToolbar2</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">zoom</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() == </span><span class="s3">'ZOOM'</span>

    <span class="s1">xlim0 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">()</span>
    <span class="s1">ylim0 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">()</span>

    <span class="s5"># Zoom from x=1e-6, y=0.1 to x=1-1e-5, 0.8 (data coordinates, &quot;d&quot;).</span>
    <span class="s1">d0 </span><span class="s2">= (</span><span class="s4">1e-6</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">)</span>
    <span class="s1">d1 </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">-</span><span class="s4">1e-5</span><span class="s2">, </span><span class="s4">0.8</span><span class="s2">)</span>
    <span class="s5"># Convert to screen coordinates (&quot;s&quot;).  Events are defined only with pixel</span>
    <span class="s5"># precision, so round the pixel values, and below, check against the</span>
    <span class="s5"># corresponding xdata/ydata, which are close but not equal to d0/d1.</span>
    <span class="s1">s0 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">d0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s5"># Zoom in.</span>
    <span class="s1">start_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">start_event</span><span class="s2">)</span>
    <span class="s1">stop_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">stop_event</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == (</span><span class="s1">start_event</span><span class="s2">.</span><span class="s1">xdata</span><span class="s2">, </span><span class="s1">stop_event</span><span class="s2">.</span><span class="s1">xdata</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == (</span><span class="s1">start_event</span><span class="s2">.</span><span class="s1">ydata</span><span class="s2">, </span><span class="s1">stop_event</span><span class="s2">.</span><span class="s1">ydata</span><span class="s2">)</span>

    <span class="s5"># Zoom out.</span>
    <span class="s1">start_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">RIGHT</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">start_event</span><span class="s2">)</span>
    <span class="s1">stop_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">RIGHT</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">.</span><span class="s1">name</span><span class="s2">, </span><span class="s1">stop_event</span><span class="s2">)</span>
    <span class="s5"># Absolute tolerance much less than original xmin (1e-7).</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">xlim0</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ylim0</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>

    <span class="s1">tb</span><span class="s2">.</span><span class="s1">zoom</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() </span><span class="s0">is None</span>

    <span class="s0">assert not </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_autoscalex_on</span><span class="s2">() </span><span class="s0">and not </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_autoscaley_on</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_widgetlock_zoompan</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">widgetlock</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">)</span>
    <span class="s1">tb </span><span class="s2">= </span><span class="s1">NavigationToolbar2</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">zoom</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">pan</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() </span><span class="s0">is None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;plot_func&quot;</span><span class="s2">, [</span><span class="s3">&quot;imshow&quot;</span><span class="s2">, </span><span class="s3">&quot;contourf&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;orientation&quot;</span><span class="s2">, [</span><span class="s3">&quot;vertical&quot;</span><span class="s2">, </span><span class="s3">&quot;horizontal&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;tool,button,expected&quot;</span><span class="s2">,</span>
                         <span class="s2">[(</span><span class="s3">&quot;zoom&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">, (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)),  </span><span class="s5"># zoom in</span>
                          <span class="s2">(</span><span class="s3">&quot;zoom&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">RIGHT</span><span class="s2">, (-</span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)),  </span><span class="s5"># zoom out</span>
                          <span class="s2">(</span><span class="s3">&quot;pan&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">, (-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">8</span><span class="s2">)),</span>
                          <span class="s2">(</span><span class="s3">&quot;pan&quot;</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">RIGHT</span><span class="s2">, (</span><span class="s4">1.47</span><span class="s2">, </span><span class="s4">7.78</span><span class="s2">))])  </span><span class="s5"># zoom</span>
<span class="s0">def </span><span class="s1">test_interactive_colorbar</span><span class="s2">(</span><span class="s1">plot_func</span><span class="s2">, </span><span class="s1">orientation</span><span class="s2">, </span><span class="s1">tool</span><span class="s2">, </span><span class="s1">button</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s1">vmin0</span><span class="s2">, </span><span class="s1">vmax0 </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span>
    <span class="s1">coll </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">plot_func</span><span class="s2">)(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">vmin</span><span class="s2">=</span><span class="s1">vmin0</span><span class="s2">, </span><span class="s1">vmax</span><span class="s2">=</span><span class="s1">vmax0</span><span class="s2">)</span>

    <span class="s1">cb </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">colorbar</span><span class="s2">(</span><span class="s1">coll</span><span class="s2">, </span><span class="s1">ax</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">, </span><span class="s1">orientation</span><span class="s2">=</span><span class="s1">orientation</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">plot_func </span><span class="s2">== </span><span class="s3">&quot;contourf&quot;</span><span class="s2">:</span>
        <span class="s5"># Just determine we can't navigate and exit out of the test</span>
        <span class="s0">assert not </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate</span><span class="s2">()</span>
        <span class="s0">return</span>

    <span class="s0">assert </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate</span><span class="s2">()</span>

    <span class="s5"># Mouse from 4 to 6 (data coordinates, &quot;d&quot;).</span>
    <span class="s1">vmin</span><span class="s2">, </span><span class="s1">vmax </span><span class="s2">= </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span>
    <span class="s5"># The y coordinate doesn't matter, it just needs to be between 0 and 1</span>
    <span class="s5"># However, we will set d0/d1 to the same y coordinate to test that small</span>
    <span class="s5"># pixel changes in that coordinate doesn't cancel the zoom like a normal</span>
    <span class="s5"># axes would.</span>
    <span class="s1">d0 </span><span class="s2">= (</span><span class="s1">vmin</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
    <span class="s1">d1 </span><span class="s2">= (</span><span class="s1">vmax</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
    <span class="s5"># Swap them if the orientation is vertical</span>
    <span class="s0">if </span><span class="s1">orientation </span><span class="s2">== </span><span class="s3">&quot;vertical&quot;</span><span class="s2">:</span>
        <span class="s1">d0 </span><span class="s2">= </span><span class="s1">d0</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">d1 </span><span class="s2">= </span><span class="s1">d1</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s5"># Convert to screen coordinates (&quot;s&quot;).  Events are defined only with pixel</span>
    <span class="s5"># precision, so round the pixel values, and below, check against the</span>
    <span class="s5"># corresponding xdata/ydata, which are close but not equal to d0/d1.</span>
    <span class="s1">s0 </span><span class="s2">= </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">d0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">d1</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s5"># Set up the mouse movements</span>
    <span class="s1">start_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>
    <span class="s1">stop_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>

    <span class="s1">tb </span><span class="s2">= </span><span class="s1">NavigationToolbar2</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">tool </span><span class="s2">== </span><span class="s3">&quot;zoom&quot;</span><span class="s2">:</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">zoom</span><span class="s2">()</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">press_zoom</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">drag_zoom</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">release_zoom</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">pan</span><span class="s2">()</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">press_pan</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">drag_pan</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">release_pan</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>

    <span class="s5"># Should be close, but won't be exact due to screen integer resolution</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">cb</span><span class="s2">.</span><span class="s1">vmin</span><span class="s2">, </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">vmax</span><span class="s2">) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_toolbar_zoompan</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">_EXPECTED_WARNING_TOOLMANAGER</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'toolbar'</span><span class="s2">] = </span><span class="s3">'toolmanager'</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gca</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() </span><span class="s0">is None</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">trigger_tool</span><span class="s2">(</span><span class="s3">'zoom'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() == </span><span class="s3">&quot;ZOOM&quot;</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">trigger_tool</span><span class="s2">(</span><span class="s3">'pan'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate_mode</span><span class="s2">() == </span><span class="s3">&quot;PAN&quot;</span>


<span class="s0">def </span><span class="s1">test_toolbar_home_restores_autoscale</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">11</span><span class="s2">), </span><span class="s1">range</span><span class="s2">(</span><span class="s4">11</span><span class="s2">))</span>

    <span class="s1">tb </span><span class="s2">= </span><span class="s1">NavigationToolbar2</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">zoom</span><span class="s2">()</span>

    <span class="s5"># Switch to log.</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;l&quot;</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)  </span><span class="s5"># Autolimits excluding 0.</span>
    <span class="s5"># Switch back to linear.</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;l&quot;</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)  </span><span class="s5"># Autolimits.</span>

    <span class="s5"># Zoom in from (x, y) = (2, 2) to (5, 5).</span>
    <span class="s1">start</span><span class="s2">, </span><span class="s1">stop </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">([(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)])</span>
    <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">start</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">stop</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s5"># Go back to home.</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;h&quot;</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
    <span class="s5"># Switch to log.</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s1">KeyEvent</span><span class="s2">(</span><span class="s3">&quot;key_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, </span><span class="s3">&quot;l&quot;</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">100</span><span class="s2">).</span><span class="s1">_process</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)  </span><span class="s5"># Autolimits excluding 0.</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;backend&quot;</span><span class="s2">, [</span><span class="s3">'svg'</span><span class="s2">, </span><span class="s3">'ps'</span><span class="s2">, </span><span class="s3">'pdf'</span><span class="s2">,</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">needs_pgf_xelatex</span><span class="s2">)]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_draw</span><span class="s2">(</span><span class="s1">backend</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">import </span><span class="s1">Figure</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_agg </span><span class="s0">import </span><span class="s1">FigureCanvas</span>
    <span class="s1">test_backend </span><span class="s2">= </span><span class="s1">importlib</span><span class="s2">.</span><span class="s1">import_module</span><span class="s2">(</span><span class="s3">f'matplotlib.backends.backend_</span><span class="s0">{</span><span class="s1">backend</span><span class="s0">}</span><span class="s3">'</span><span class="s2">)</span>
    <span class="s1">TestCanvas </span><span class="s2">= </span><span class="s1">test_backend</span><span class="s2">.</span><span class="s1">FigureCanvas</span>
    <span class="s1">fig_test </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">TestCanvas</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">)</span>
    <span class="s1">axes_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s5"># defaults to FigureCanvasBase</span>
    <span class="s1">fig_agg </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">(</span><span class="s1">constrained_layout</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s5"># put a backends.backend_agg.FigureCanvas on it</span>
    <span class="s1">FigureCanvas</span><span class="s2">(</span><span class="s1">fig_agg</span><span class="s2">)</span>
    <span class="s1">axes_agg </span><span class="s2">= </span><span class="s1">fig_agg</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">init_pos </span><span class="s2">= [</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">() </span><span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axes_test</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()]</span>

    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">fig_agg</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>

    <span class="s1">layed_out_pos_test </span><span class="s2">= [</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">() </span><span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axes_test</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()]</span>
    <span class="s1">layed_out_pos_agg </span><span class="s2">= [</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_position</span><span class="s2">() </span><span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axes_agg</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">()]</span>

    <span class="s0">for </span><span class="s1">init</span><span class="s2">, </span><span class="s1">placed </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">init_pos</span><span class="s2">, </span><span class="s1">layed_out_pos_test</span><span class="s2">):</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">init</span><span class="s2">, </span><span class="s1">placed</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">0.005</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">test </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">layed_out_pos_agg</span><span class="s2">, </span><span class="s1">layed_out_pos_test</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">test</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">0.005</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;key,mouseend,expectedxlim,expectedylim&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">2.7</span><span class="s2">, </span><span class="s4">11.7</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">), (</span><span class="s4">2.7</span><span class="s2">, </span><span class="s4">11.7</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)),  </span><span class="s5"># No move</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">), (-</span><span class="s4">3.47</span><span class="s2">, </span><span class="s4">5.53</span><span class="s2">), (</span><span class="s4">2.25</span><span class="s2">, </span><span class="s4">11.25</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">2.25</span><span class="s2">, </span><span class="s4">11.25</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">, </span><span class="s4">0.85</span><span class="s2">), (-</span><span class="s4">3.47</span><span class="s2">, </span><span class="s4">5.53</span><span class="s2">), (-</span><span class="s4">3.14</span><span class="s2">, </span><span class="s4">5.86</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s0">None</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.85</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (-</span><span class="s4">3.14</span><span class="s2">, </span><span class="s4">5.86</span><span class="s2">)),</span>
     <span class="s2">(</span><span class="s3">&quot;shift&quot;</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)),  </span><span class="s5"># snap to x</span>
     <span class="s2">(</span><span class="s3">&quot;shift&quot;</span><span class="s2">, (</span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">), (</span><span class="s4">2.7</span><span class="s2">, </span><span class="s4">11.7</span><span class="s2">)),  </span><span class="s5"># snap to y</span>
     <span class="s2">(</span><span class="s3">&quot;shift&quot;</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">)),  </span><span class="s5"># snap to diagonal</span>
     <span class="s2">(</span><span class="s3">&quot;shift&quot;</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">, </span><span class="s4">0.25</span><span class="s2">), (-</span><span class="s4">3.47</span><span class="s2">, </span><span class="s4">5.53</span><span class="s2">), (</span><span class="s4">3.47</span><span class="s2">, </span><span class="s4">12.47</span><span class="s2">)),  </span><span class="s5"># snap to diagonal</span>
     <span class="s2">(</span><span class="s3">&quot;shift&quot;</span><span class="s2">, (</span><span class="s4">0.8</span><span class="s2">, </span><span class="s4">0.9</span><span class="s2">), (-</span><span class="s4">3.58</span><span class="s2">, </span><span class="s4">5.41</span><span class="s2">), (-</span><span class="s4">3.58</span><span class="s2">, </span><span class="s4">5.41</span><span class="s2">)),  </span><span class="s5"># snap to diagonal</span>
     <span class="s2">(</span><span class="s3">&quot;shift&quot;</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.85</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (-</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">5.51</span><span class="s2">)),  </span><span class="s5"># snap to diagonal</span>
     <span class="s2">(</span><span class="s3">&quot;x&quot;</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)),  </span><span class="s5"># only x</span>
     <span class="s2">(</span><span class="s3">&quot;y&quot;</span><span class="s2">, (</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">9</span><span class="s2">), (</span><span class="s4">2.7</span><span class="s2">, </span><span class="s4">11.7</span><span class="s2">)),  </span><span class="s5"># only y</span>
     <span class="s2">(</span><span class="s3">&quot;control&quot;</span><span class="s2">, (</span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">), (</span><span class="s4">3.49</span><span class="s2">, </span><span class="s4">12.49</span><span class="s2">)),  </span><span class="s5"># diagonal</span>
     <span class="s2">(</span><span class="s3">&quot;control&quot;</span><span class="s2">, (</span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">), (</span><span class="s4">2.72</span><span class="s2">, </span><span class="s4">11.72</span><span class="s2">), (</span><span class="s4">2.72</span><span class="s2">, </span><span class="s4">11.72</span><span class="s2">)),  </span><span class="s5"># diagonal</span>
     <span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_interactive_pan</span><span class="s2">(</span><span class="s1">key</span><span class="s2">, </span><span class="s1">mouseend</span><span class="s2">, </span><span class="s1">expectedxlim</span><span class="s2">, </span><span class="s1">expectedylim</span><span class="s2">):</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_navigate</span><span class="s2">()</span>
    <span class="s5"># Set equal aspect ratio to easier see diagonal snap</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_aspect</span><span class="s2">(</span><span class="s3">'equal'</span><span class="s2">)</span>

    <span class="s5"># Mouse move starts from 0.5, 0.5</span>
    <span class="s1">mousestart </span><span class="s2">= (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">)</span>
    <span class="s5"># Convert to screen coordinates (&quot;s&quot;).  Events are defined only with pixel</span>
    <span class="s5"># precision, so round the pixel values, and below, check against the</span>
    <span class="s5"># corresponding xdata/ydata, which are close but not equal to d0/d1.</span>
    <span class="s1">sstart </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">mousestart</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">send </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">mouseend</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s5"># Set up the mouse movements</span>
    <span class="s1">start_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">sstart</span><span class="s2">, </span><span class="s1">button</span><span class="s2">=</span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">,</span>
        <span class="s1">key</span><span class="s2">=</span><span class="s1">key</span><span class="s2">)</span>
    <span class="s1">stop_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span>
        <span class="s3">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">send</span><span class="s2">, </span><span class="s1">button</span><span class="s2">=</span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">,</span>
        <span class="s1">key</span><span class="s2">=</span><span class="s1">key</span><span class="s2">)</span>

    <span class="s1">tb </span><span class="s2">= </span><span class="s1">NavigationToolbar2</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">pan</span><span class="s2">()</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">press_pan</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">)</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">drag_pan</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
    <span class="s1">tb</span><span class="s2">.</span><span class="s1">release_pan</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
    <span class="s5"># Should be close, but won't be exact due to screen integer resolution</span>
    <span class="s0">assert </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">()) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">expectedxlim</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.02</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">()) == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">expectedylim</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.02</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_toolmanager_remove</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">_EXPECTED_WARNING_TOOLMANAGER</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'toolbar'</span><span class="s2">] = </span><span class="s3">'toolmanager'</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s1">initial_len </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">tools</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">'forward' </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">tools</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">remove_tool</span><span class="s2">(</span><span class="s3">'forward'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">tools</span><span class="s2">) == </span><span class="s1">initial_len </span><span class="s2">- </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s3">'forward' </span><span class="s0">not in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">tools</span>


<span class="s0">def </span><span class="s1">test_toolmanager_get_tool</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">_EXPECTED_WARNING_TOOLMANAGER</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'toolbar'</span><span class="s2">] = </span><span class="s3">'toolmanager'</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s1">rubberband </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">get_tool</span><span class="s2">(</span><span class="s3">'rubberband'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">rubberband</span><span class="s2">, </span><span class="s1">RubberbandBase</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">get_tool</span><span class="s2">(</span><span class="s1">rubberband</span><span class="s2">) </span><span class="s0">is </span><span class="s1">rubberband</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;ToolManager does not control tool 'foo'&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">get_tool</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">) </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">get_tool</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s1">warn</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;ToolManager does not control tool 'foo'&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">trigger_tool</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">) </span><span class="s0">is None</span>


<span class="s0">def </span><span class="s1">test_toolmanager_update_keymap</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">_EXPECTED_WARNING_TOOLMANAGER</span><span class="s2">):</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'toolbar'</span><span class="s2">] = </span><span class="s3">'toolmanager'</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">gcf</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s3">'v' </span><span class="s0">in </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">get_tool_keymap</span><span class="s2">(</span><span class="s3">'forward'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">,</span>
                      <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Key c changed from back to forward&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">update_keymap</span><span class="s2">(</span><span class="s3">'forward'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">get_tool_keymap</span><span class="s2">(</span><span class="s3">'forward'</span><span class="s2">) == [</span><span class="s3">'c'</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;'foo' not in Tools&quot;</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">manager</span><span class="s2">.</span><span class="s1">toolmanager</span><span class="s2">.</span><span class="s1">update_keymap</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;tool&quot;</span><span class="s2">, [</span><span class="s3">&quot;zoom&quot;</span><span class="s2">, </span><span class="s3">&quot;pan&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;button&quot;</span><span class="s2">, [</span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">LEFT</span><span class="s2">, </span><span class="s1">MouseButton</span><span class="s2">.</span><span class="s1">RIGHT</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;patch_vis&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;forward_nav&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s3">&quot;auto&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;t_s&quot;</span><span class="s2">, [</span><span class="s3">&quot;twin&quot;</span><span class="s2">, </span><span class="s3">&quot;share&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_interactive_pan_zoom_events</span><span class="s2">(</span><span class="s1">tool</span><span class="s2">, </span><span class="s1">button</span><span class="s2">, </span><span class="s1">patch_vis</span><span class="s2">, </span><span class="s1">forward_nav</span><span class="s2">, </span><span class="s1">t_s</span><span class="s2">):</span>
    <span class="s5"># Bottom axes: ax_b    Top axes: ax_t</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax_b </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_t </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">221</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s4">99</span><span class="s2">)</span>
    <span class="s1">ax_t</span><span class="s2">.</span><span class="s1">set_forward_navigation_events</span><span class="s2">(</span><span class="s1">forward_nav</span><span class="s2">)</span>
    <span class="s1">ax_t</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set_visible</span><span class="s2">(</span><span class="s1">patch_vis</span><span class="s2">)</span>

    <span class="s5"># ----------------------------</span>
    <span class="s0">if </span><span class="s1">t_s </span><span class="s2">== </span><span class="s3">&quot;share&quot;</span><span class="s2">:</span>
        <span class="s1">ax_t_twin </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">222</span><span class="s2">)</span>
        <span class="s1">ax_t_twin</span><span class="s2">.</span><span class="s1">sharex</span><span class="s2">(</span><span class="s1">ax_t</span><span class="s2">)</span>
        <span class="s1">ax_t_twin</span><span class="s2">.</span><span class="s1">sharey</span><span class="s2">(</span><span class="s1">ax_t</span><span class="s2">)</span>

        <span class="s1">ax_b_twin </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s4">223</span><span class="s2">)</span>
        <span class="s1">ax_b_twin</span><span class="s2">.</span><span class="s1">sharex</span><span class="s2">(</span><span class="s1">ax_b</span><span class="s2">)</span>
        <span class="s1">ax_b_twin</span><span class="s2">.</span><span class="s1">sharey</span><span class="s2">(</span><span class="s1">ax_b</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">t_s </span><span class="s2">== </span><span class="s3">&quot;twin&quot;</span><span class="s2">:</span>
        <span class="s1">ax_t_twin </span><span class="s2">= </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">twinx</span><span class="s2">()</span>
        <span class="s1">ax_b_twin </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">twinx</span><span class="s2">()</span>

    <span class="s5"># just some styling to simplify manual checks</span>
    <span class="s1">ax_t</span><span class="s2">.</span><span class="s1">set_label</span><span class="s2">(</span><span class="s3">&quot;ax_t&quot;</span><span class="s2">)</span>
    <span class="s1">ax_t</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">))</span>

    <span class="s1">ax_t_twin</span><span class="s2">.</span><span class="s1">set_label</span><span class="s2">(</span><span class="s3">&quot;ax_t_twin&quot;</span><span class="s2">)</span>
    <span class="s1">ax_t_twin</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">&quot;r&quot;</span><span class="s2">)</span>

    <span class="s1">ax_b</span><span class="s2">.</span><span class="s1">set_label</span><span class="s2">(</span><span class="s3">&quot;ax_b&quot;</span><span class="s2">)</span>
    <span class="s1">ax_b</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">((</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">))</span>

    <span class="s1">ax_b_twin</span><span class="s2">.</span><span class="s1">set_label</span><span class="s2">(</span><span class="s3">&quot;ax_b_twin&quot;</span><span class="s2">)</span>
    <span class="s1">ax_b_twin</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set_facecolor</span><span class="s2">(</span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>

    <span class="s5"># ----------------------------</span>

    <span class="s5"># Set initial axis limits</span>
    <span class="s1">init_xlim</span><span class="s2">, </span><span class="s1">init_ylim </span><span class="s2">= (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">), (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s2">[</span><span class="s1">ax_t</span><span class="s2">, </span><span class="s1">ax_b</span><span class="s2">]:</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(*</span><span class="s1">init_xlim</span><span class="s2">)</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(*</span><span class="s1">init_ylim</span><span class="s2">)</span>

    <span class="s5"># Mouse from 2 to 1 (in data-coordinates of ax_t).</span>
    <span class="s1">xstart_t</span><span class="s2">, </span><span class="s1">xstop_t</span><span class="s2">, </span><span class="s1">ystart_t</span><span class="s2">, </span><span class="s1">ystop_t </span><span class="s2">= </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span>
    <span class="s5"># Convert to screen coordinates (&quot;s&quot;).  Events are defined only with pixel</span>
    <span class="s5"># precision, so round the pixel values, and below, check against the</span>
    <span class="s5"># corresponding xdata/ydata, which are close but not equal to s0/s1.</span>
    <span class="s1">s0 </span><span class="s2">= </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xstart_t</span><span class="s2">, </span><span class="s1">ystart_t</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">((</span><span class="s1">xstop_t</span><span class="s2">, </span><span class="s1">ystop_t</span><span class="s2">)).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

    <span class="s5"># Calculate the mouse-distance in data-coordinates of the bottom-axes</span>
    <span class="s1">xstart_b</span><span class="s2">, </span><span class="s1">ystart_b </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">s0</span><span class="s2">)</span>
    <span class="s1">xstop_b</span><span class="s2">, </span><span class="s1">ystop_b </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">transData</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">().</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">s1</span><span class="s2">)</span>

    <span class="s5"># Set up the mouse movements</span>
    <span class="s1">start_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_press_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>
    <span class="s1">stop_event </span><span class="s2">= </span><span class="s1">MouseEvent</span><span class="s2">(</span><span class="s3">&quot;button_release_event&quot;</span><span class="s2">, </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>

    <span class="s1">tb </span><span class="s2">= </span><span class="s1">NavigationToolbar2</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">tool </span><span class="s2">== </span><span class="s3">&quot;zoom&quot;</span><span class="s2">:</span>
        <span class="s5"># Evaluate expected limits before executing the zoom-event</span>
        <span class="s1">direction </span><span class="s2">= (</span><span class="s3">&quot;in&quot; </span><span class="s0">if </span><span class="s1">button </span><span class="s2">== </span><span class="s4">1 </span><span class="s0">else </span><span class="s3">&quot;out&quot;</span><span class="s2">)</span>

        <span class="s1">xlim_t</span><span class="s2">, </span><span class="s1">ylim_t </span><span class="s2">= </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">_prepare_view_from_bbox</span><span class="s2">([*</span><span class="s1">s0</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">], </span><span class="s1">direction</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_forward_navigation_events</span><span class="s2">() </span><span class="s0">is True</span><span class="s2">:</span>
            <span class="s1">xlim_b</span><span class="s2">, </span><span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">_prepare_view_from_bbox</span><span class="s2">([*</span><span class="s1">s0</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">], </span><span class="s1">direction</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_forward_navigation_events</span><span class="s2">() </span><span class="s0">is False</span><span class="s2">:</span>
            <span class="s1">xlim_b </span><span class="s2">= </span><span class="s1">init_xlim</span>
            <span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">init_ylim</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">get_visible</span><span class="s2">():</span>
                <span class="s1">xlim_b</span><span class="s2">, </span><span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">_prepare_view_from_bbox</span><span class="s2">([*</span><span class="s1">s0</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">], </span><span class="s1">direction</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">xlim_b </span><span class="s2">= </span><span class="s1">init_xlim</span>
                <span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">init_ylim</span>

        <span class="s1">tb</span><span class="s2">.</span><span class="s1">zoom</span><span class="s2">()</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">press_zoom</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">drag_zoom</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">release_zoom</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">xlim_t</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ylim_t</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">xlim_b</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ylim_b</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>

        <span class="s5"># Check if twin-axes are properly triggered</span>
        <span class="s0">assert </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ax_t_twin</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ax_b_twin</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># Evaluate expected limits</span>
        <span class="s5"># (call start_pan to make sure ax._pan_start is set)</span>
        <span class="s1">ax_t</span><span class="s2">.</span><span class="s1">start_pan</span><span class="s2">(*</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>
        <span class="s1">xlim_t</span><span class="s2">, </span><span class="s1">ylim_t </span><span class="s2">= </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">_get_pan_points</span><span class="s2">(</span><span class="s1">button</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">).</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">ax_t</span><span class="s2">.</span><span class="s1">end_pan</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_forward_navigation_events</span><span class="s2">() </span><span class="s0">is True</span><span class="s2">:</span>
            <span class="s1">ax_b</span><span class="s2">.</span><span class="s1">start_pan</span><span class="s2">(*</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>
            <span class="s1">xlim_b</span><span class="s2">, </span><span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">_get_pan_points</span><span class="s2">(</span><span class="s1">button</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">).</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
            <span class="s1">ax_b</span><span class="s2">.</span><span class="s1">end_pan</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_forward_navigation_events</span><span class="s2">() </span><span class="s0">is False</span><span class="s2">:</span>
            <span class="s1">xlim_b </span><span class="s2">= </span><span class="s1">init_xlim</span>
            <span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">init_ylim</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">get_visible</span><span class="s2">():</span>
                <span class="s1">ax_b</span><span class="s2">.</span><span class="s1">start_pan</span><span class="s2">(*</span><span class="s1">s0</span><span class="s2">, </span><span class="s1">button</span><span class="s2">)</span>
                <span class="s1">xlim_b</span><span class="s2">, </span><span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">_get_pan_points</span><span class="s2">(</span><span class="s1">button</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, *</span><span class="s1">s1</span><span class="s2">).</span><span class="s1">T</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
                <span class="s1">ax_b</span><span class="s2">.</span><span class="s1">end_pan</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">xlim_b </span><span class="s2">= </span><span class="s1">init_xlim</span>
                <span class="s1">ylim_b </span><span class="s2">= </span><span class="s1">init_ylim</span>

        <span class="s1">tb</span><span class="s2">.</span><span class="s1">pan</span><span class="s2">()</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">press_pan</span><span class="s2">(</span><span class="s1">start_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">drag_pan</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>
        <span class="s1">tb</span><span class="s2">.</span><span class="s1">release_pan</span><span class="s2">(</span><span class="s1">stop_event</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">xlim_t</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ylim_t</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">xlim_b</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">get_ylim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ylim_b</span><span class="s2">, </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>

        <span class="s5"># Check if twin-axes are properly triggered</span>
        <span class="s0">assert </span><span class="s1">ax_t</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ax_t_twin</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ax_b</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">ax_b_twin</span><span class="s2">.</span><span class="s1">get_xlim</span><span class="s2">(), </span><span class="s1">abs</span><span class="s2">=</span><span class="s4">0.15</span><span class="s2">)</span>
</pre>
</body>
</html>