<html>
<head>
<title>test_stata.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #a5c261;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_stata.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">bz2</span>
<span class="s0">import </span><span class="s1">datetime </span><span class="s0">as </span><span class="s1">dt</span>
<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">import </span><span class="s1">gzip</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">struct</span>
<span class="s0">import </span><span class="s1">tarfile</span>
<span class="s0">import </span><span class="s1">zipfile</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">CategoricalDtype</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">frame </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">parsers </span><span class="s0">import </span><span class="s1">read_csv</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">stata </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">CategoricalConversionWarning</span><span class="s2">,</span>
    <span class="s1">InvalidColumnName</span><span class="s2">,</span>
    <span class="s1">PossiblePrecisionLoss</span><span class="s2">,</span>
    <span class="s1">StataMissingValue</span><span class="s2">,</span>
    <span class="s1">StataReader</span><span class="s2">,</span>
    <span class="s1">StataWriter</span><span class="s2">,</span>
    <span class="s1">StataWriterUTF8</span><span class="s2">,</span>
    <span class="s1">ValueLabelTypeMismatch</span><span class="s2">,</span>
    <span class="s1">read_stata</span><span class="s2">,</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mixed_frame</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">27.0</span><span class="s2">, </span><span class="s4">81.0</span><span class="s2">],</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s3">&quot;Atlanta&quot;</span><span class="s2">, </span><span class="s3">&quot;Birmingham&quot;</span><span class="s2">, </span><span class="s3">&quot;Cincinnati&quot;</span><span class="s2">, </span><span class="s3">&quot;Detroit&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">parsed_114</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s1">dta14_114 </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata5_114.dta&quot;</span><span class="s2">)</span>
    <span class="s1">parsed_114 </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">dta14_114</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">parsed_114</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
    <span class="s0">return </span><span class="s1">parsed_114</span>


<span class="s0">class </span><span class="s1">TestStata</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
        <span class="s5"># Legacy default reader configuration</span>
        <span class="s0">return </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_empty_dta</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">empty_ds </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;unit&quot;</span><span class="s2">])</span>
        <span class="s5"># GH 7369, make sure can read a 0-obs dta file</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">empty_ds</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">empty_ds2 </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">empty_ds</span><span class="s2">, </span><span class="s1">empty_ds2</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_empty_dta_with_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s5"># GH 46240</span>
        <span class="s5"># Fixing above bug revealed that types are not correctly preserved when</span>
        <span class="s5"># writing empty DataFrames</span>
        <span class="s1">empty_df_typed </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;i8&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">),</span>
                <span class="s3">&quot;i16&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">),</span>
                <span class="s3">&quot;i32&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
                <span class="s3">&quot;i64&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),</span>
                <span class="s3">&quot;u8&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">),</span>
                <span class="s3">&quot;u16&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">),</span>
                <span class="s3">&quot;u32&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">),</span>
                <span class="s3">&quot;u64&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint64</span><span class="s2">),</span>
                <span class="s3">&quot;f32&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">),</span>
                <span class="s3">&quot;f64&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">empty_df_typed</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s5"># No uint# support. Downcast since values in range for int#</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u8&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u8&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u16&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u16&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u32&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u32&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s5"># No int64 supported at all. Downcast since values in range for int32</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u64&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;u64&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;i64&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;i64&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s5"># GH 7369, make sure can read a 0-obs dta file</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">empty_df_typed</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">empty_reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">empty_reread</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">empty_reread</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_index_col_none</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;b1&quot;</span><span class="s2">, </span><span class="s3">&quot;b2&quot;</span><span class="s2">, </span><span class="s3">&quot;b3&quot;</span><span class="s2">, </span><span class="s3">&quot;b4&quot;</span><span class="s2">, </span><span class="s3">&quot;b5&quot;</span><span class="s2">]})</span>
        <span class="s5"># GH 7369, make sure can read a 0-obs dta file</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">read_df </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">read_df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">RangeIndex</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">read_df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata1_114&quot;</span><span class="s2">, </span><span class="s3">&quot;stata1_117&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_dta1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s5"># Pandas uses np.nan as missing value.</span>
        <span class="s5"># Thus, all columns will be of type float, regardless of their name.</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;float_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;double_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;byte_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;int_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;long_miss&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s5"># this is an oddity as really the nan should be float64, but</span>
        <span class="s5"># the casting doesn't fail so need to match stata here</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_miss&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_miss&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_read_dta2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">(</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">19</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">20</span><span class="s2">),</span>
                    <span class="s4">1479596223000</span><span class="s2">,</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2010</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2010</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2010</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1974</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2010</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2010</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                <span class="s2">),</span>
                <span class="s2">(</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1959</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">20</span><span class="s2">),</span>
                    <span class="s2">-</span><span class="s4">1479590</span><span class="s2">,</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1953</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1948</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">10</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1955</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1955</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">1955</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                    <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                <span class="s2">),</span>
                <span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;datetime_c&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;datetime_big_c&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;date&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;weekly_date&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;monthly_date&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;quarterly_date&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;half_yearly_date&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;yearly_date&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;yearly_date&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;yearly_date&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;O&quot;</span><span class="s2">)</span>

        <span class="s1">path1 </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata2_114.dta&quot;</span><span class="s2">)</span>
        <span class="s1">path2 </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata2_115.dta&quot;</span><span class="s2">)</span>
        <span class="s1">path3 </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata2_117.dta&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">parsed_114 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">parsed_115 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path2</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">parsed_117 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path3</span><span class="s2">)</span>
            <span class="s5"># FIXME: don't leave commented-out</span>
            <span class="s5"># 113 is buggy due to limits of date format support in Stata</span>
            <span class="s5"># parsed_113 = self.read_dta(</span>
            <span class="s5"># datapath(&quot;io&quot;, &quot;data&quot;, &quot;stata&quot;, &quot;stata2_113.dta&quot;)</span>
            <span class="s5"># )</span>

        <span class="s5"># FIXME: don't leave commented-out</span>
        <span class="s5"># buggy test because of the NaT comparison on certain platforms</span>
        <span class="s5"># Format 113 test fails since it does not support tc and tC formats</span>
        <span class="s5"># tm.assert_frame_equal(parsed_113, expected)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed_114</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed_115</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed_117</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata3_113&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3_114&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3_117&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_dta3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s5"># match stata here</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3.csv&quot;</span><span class="s2">))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;year&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;year&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;quarter&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;quarter&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata4_113&quot;</span><span class="s2">, </span><span class="s3">&quot;stata4_114&quot;</span><span class="s2">, </span><span class="s3">&quot;stata4_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata4_117&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_dta4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;nine&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s3">&quot;seven&quot;</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s3">&quot;four&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;five&quot;</span><span class="s2">, </span><span class="s3">&quot;six&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;five&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;six&quot;</span><span class="s2">, </span><span class="s3">&quot;five&quot;</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;six&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;seven&quot;</span><span class="s2">, </span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;seven&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;eight&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;nine&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;nine&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;ten&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;fully_labeled&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;fully_labeled2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;incompletely_labeled&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;labeled_with_missings&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;float_labelled&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s5"># these are all categoricals</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">:</span>
            <span class="s1">orig </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>

            <span class="s1">categories </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;fully_labeled&quot;</span><span class="s2">][</span><span class="s1">orig</span><span class="s2">.</span><span class="s1">notna</span><span class="s2">()])</span>
            <span class="s0">if </span><span class="s1">col </span><span class="s2">== </span><span class="s3">&quot;incompletely_labeled&quot;</span><span class="s2">:</span>
                <span class="s1">categories </span><span class="s2">= </span><span class="s1">orig</span>

            <span class="s1">cat </span><span class="s2">= </span><span class="s1">orig</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">).</span><span class="s1">_values</span>
            <span class="s1">cat </span><span class="s2">= </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">set_categories</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

            <span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">cat</span>

        <span class="s5"># stata doesn't save .category metadata</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s5"># File containing strls</span>
    <span class="s0">def </span><span class="s1">test_read_dta12</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">parsed_117 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata12_117.dta&quot;</span><span class="s2">))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;abc&quot;</span><span class="s2">, </span><span class="s3">&quot;abcdefghi&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s3">&quot;cba&quot;</span><span class="s2">, </span><span class="s3">&quot;qwertywertyqwerty&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">93</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;strl&quot;</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed_117</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_dtype</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_read_dta18</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">parsed_118 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata14_118.dta&quot;</span><span class="s2">))</span>
        <span class="s1">parsed_118</span><span class="s2">[</span><span class="s3">&quot;Bytes&quot;</span><span class="s2">] = </span><span class="s1">parsed_118</span><span class="s2">[</span><span class="s3">&quot;Bytes&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;O&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;Cat&quot;</span><span class="s2">, </span><span class="s3">&quot;Bogota&quot;</span><span class="s2">, </span><span class="s3">&quot;Bogotá&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s3">&quot;option b Ünicode&quot;</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;Dog&quot;</span><span class="s2">, </span><span class="s3">&quot;Boston&quot;</span><span class="s2">, </span><span class="s3">&quot;Uzunköprü&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;Plane&quot;</span><span class="s2">, </span><span class="s3">&quot;Rome&quot;</span><span class="s2">, </span><span class="s3">&quot;Tromsø&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">, </span><span class="s3">&quot;option a&quot;</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;Potato&quot;</span><span class="s2">, </span><span class="s3">&quot;Tokyo&quot;</span><span class="s2">, </span><span class="s3">&quot;Elâzığ&quot;</span><span class="s2">, -</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],  </span><span class="s5"># noqa: RUF001</span>
                <span class="s2">[</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.3332999</span><span class="s2">, </span><span class="s3">&quot;option a&quot;</span><span class="s2">, </span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">3.0</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;Things&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Cities&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Unicode_Cities_Strl&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Ints&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Floats&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Bytes&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Longs&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;Floats&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;Floats&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">parsed_118</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_almost_equal</span><span class="s2">(</span><span class="s1">parsed_118</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata14_118.dta&quot;</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">rdr</span><span class="s2">:</span>
            <span class="s1">vl </span><span class="s2">= </span><span class="s1">rdr</span><span class="s2">.</span><span class="s1">variable_labels</span><span class="s2">()</span>
            <span class="s1">vl_expected </span><span class="s2">= {</span>
                <span class="s3">&quot;Unicode_Cities_Strl&quot;</span><span class="s2">: </span><span class="s3">&quot;Here are some strls with Ünicode chars&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Longs&quot;</span><span class="s2">: </span><span class="s3">&quot;long data&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Things&quot;</span><span class="s2">: </span><span class="s3">&quot;Here are some things&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Bytes&quot;</span><span class="s2">: </span><span class="s3">&quot;byte data&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Ints&quot;</span><span class="s2">: </span><span class="s3">&quot;int data&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Cities&quot;</span><span class="s2">: </span><span class="s3">&quot;Here are some cities&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;Floats&quot;</span><span class="s2">: </span><span class="s3">&quot;float data&quot;</span><span class="s2">,</span>
            <span class="s2">}</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_dict_equal</span><span class="s2">(</span><span class="s1">vl</span><span class="s2">, </span><span class="s1">vl_expected</span><span class="s2">)</span>

            <span class="s0">assert </span><span class="s1">rdr</span><span class="s2">.</span><span class="s1">data_label </span><span class="s2">== </span><span class="s3">&quot;This is a  Ünicode data label&quot;</span>

    <span class="s0">def </span><span class="s1">test_read_write_dta5</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;float_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;double_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;byte_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;int_miss&quot;</span><span class="s2">, </span><span class="s3">&quot;long_miss&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_write_dta6</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3.csv&quot;</span><span class="s2">))</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;year&quot;</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;year&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;quarter&quot;</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;quarter&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
                <span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
                <span class="s1">original</span><span class="s2">,</span>
                <span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_write_dta10</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">=[[</span><span class="s3">&quot;string&quot;</span><span class="s2">, </span><span class="s3">&quot;object&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;2003-12-25&quot;</span><span class="s2">)]],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;string&quot;</span><span class="s2">, </span><span class="s3">&quot;object&quot;</span><span class="s2">, </span><span class="s3">&quot;integer&quot;</span><span class="s2">, </span><span class="s3">&quot;floating&quot;</span><span class="s2">, </span><span class="s3">&quot;datetime&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;object&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;object&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;integer&quot;</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;integer&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s3">&quot;datetime&quot;</span><span class="s2">: </span><span class="s3">&quot;tc&quot;</span><span class="s2">}, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s5"># original.index is np.int32, read index is np.int64</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
                <span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
                <span class="s1">original</span><span class="s2">,</span>
                <span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_stata_doc_examples</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;AB&quot;</span><span class="s2">)</span>
            <span class="s2">)</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_write_preserves_original</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># 9795</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abcd&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">:</span><span class="s3">&quot;c&quot;</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">df_copy </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df_copy</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_encoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># GH 4626, proper encoding handling</span>
        <span class="s1">raw </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata1_encoding.dta&quot;</span><span class="s2">))</span>
        <span class="s1">encoded </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata1_encoding.dta&quot;</span><span class="s2">))</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">encoded</span><span class="s2">.</span><span class="s1">kreis1849</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">raw</span><span class="s2">.</span><span class="s1">kreis1849</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">str</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">encoded</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">reread_encoded </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">encoded</span><span class="s2">, </span><span class="s1">reread_encoded</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_read_write_dta11</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;good&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;b</span><span class="s0">\u00E4</span><span class="s3">d&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;8number&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;astringwithmorethan32characters______&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">formatted </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;good&quot;</span><span class="s2">, </span><span class="s3">&quot;b_d&quot;</span><span class="s2">, </span><span class="s3">&quot;_8number&quot;</span><span class="s2">, </span><span class="s3">&quot;astringwithmorethan32characters_&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">formatted</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">formatted </span><span class="s2">= </span><span class="s1">formatted</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">InvalidColumnName</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>

            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">formatted</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_write_dta12</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;astringwithmorethan32characters_1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;astringwithmorethan32characters_2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;+&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;-&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;short&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;delete&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">formatted </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;astringwithmorethan32characters_&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;_0astringwithmorethan32character&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;_&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;_1_&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;_short&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;_delete&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">formatted</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">formatted </span><span class="s2">= </span><span class="s1">formatted</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">InvalidColumnName</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
                <span class="s5"># should get a warning for that format.</span>

            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">formatted</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_read_write_dta13</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s4">9</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s4">17</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">s3 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s4">33</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;int16&quot;</span><span class="s2">: </span><span class="s1">s1</span><span class="s2">, </span><span class="s3">&quot;int32&quot;</span><span class="s2">: </span><span class="s1">s2</span><span class="s2">, </span><span class="s3">&quot;int64&quot;</span><span class="s2">: </span><span class="s1">s3</span><span class="s2">})</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

        <span class="s1">formatted </span><span class="s2">= </span><span class="s1">original</span>
        <span class="s1">formatted</span><span class="s2">[</span><span class="s3">&quot;int64&quot;</span><span class="s2">] = </span><span class="s1">formatted</span><span class="s2">[</span><span class="s3">&quot;int64&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">formatted</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata5_113&quot;</span><span class="s2">, </span><span class="s3">&quot;stata5_114&quot;</span><span class="s2">, </span><span class="s3">&quot;stata5_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata5_117&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_write_reread_dta14</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">parsed_114</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s1">parsed</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed_114</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">parsed_114</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s3">&quot;date_td&quot;</span><span class="s2">: </span><span class="s3">&quot;td&quot;</span><span class="s2">}, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">parsed_114</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata6_113&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_114&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_write_reread_dta15</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6.csv&quot;</span><span class="s2">))</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;byte_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;byte_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;int_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;int_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;long_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;long_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;double_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;double_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s2">,)</span>
        <span class="s2">)</span>

        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_timestamp_and_label</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,)], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;variable&quot;</span><span class="s2">])</span>
        <span class="s1">time_stamp </span><span class="s2">= </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">29</span><span class="s2">, </span><span class="s4">14</span><span class="s2">, </span><span class="s4">21</span><span class="s2">)</span>
        <span class="s1">data_label </span><span class="s2">= </span><span class="s3">&quot;This is a data file.&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">, </span><span class="s1">time_stamp</span><span class="s2">=</span><span class="s1">time_stamp</span><span class="s2">, </span><span class="s1">data_label</span><span class="s2">=</span><span class="s1">data_label</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span>
            <span class="s2">)</span>

            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">time_stamp </span><span class="s2">== </span><span class="s3">&quot;29 Feb 2000 14:21&quot;</span>
                <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">data_label </span><span class="s2">== </span><span class="s1">data_label</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_timestamp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([(</span><span class="s4">1</span><span class="s2">,)], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;variable&quot;</span><span class="s2">])</span>
        <span class="s1">time_stamp </span><span class="s2">= </span><span class="s3">&quot;01 Jan 2000, 00:00:00&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;time_stamp should be datetime type&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">time_stamp</span><span class="s2">=</span><span class="s1">time_stamp</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s0">assert not </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">isfile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_numeric_column_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">25.0</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)))</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s5"># should get a warning for that format.</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">InvalidColumnName</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">columns </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">convert_col_name </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">int</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">convert_col_name</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">written_and_read_again</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_nan_to_missing_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4.0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4.0</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">s1</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">s2</span><span class="s2">[</span><span class="s4">1</span><span class="s2">::</span><span class="s4">2</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;s1&quot;</span><span class="s2">: </span><span class="s1">s1</span><span class="s2">, </span><span class="s3">&quot;s2&quot;</span><span class="s2">: </span><span class="s1">s2</span><span class="s2">})</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_no_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">]</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10.0</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index_not_written&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name</span><span class="s2">):</span>
                <span class="s1">written_and_read_again</span><span class="s2">[</span><span class="s3">&quot;index_not_written&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_string_no_dates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;A longer string&quot;</span><span class="s2">])</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;s1&quot;</span><span class="s2">: </span><span class="s1">s1</span><span class="s2">, </span><span class="s3">&quot;s2&quot;</span><span class="s2">: </span><span class="s1">s2</span><span class="s2">})</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_large_value_conversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">s0 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">99</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">127</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">15 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">s3 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">63 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;s0&quot;</span><span class="s2">: </span><span class="s1">s0</span><span class="s2">, </span><span class="s3">&quot;s1&quot;</span><span class="s2">: </span><span class="s1">s1</span><span class="s2">, </span><span class="s3">&quot;s2&quot;</span><span class="s2">: </span><span class="s1">s2</span><span class="s2">, </span><span class="s3">&quot;s3&quot;</span><span class="s2">: </span><span class="s1">s3</span><span class="s2">})</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">PossiblePrecisionLoss</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">modified </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">modified</span><span class="s2">[</span><span class="s3">&quot;s1&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">modified</span><span class="s2">[</span><span class="s3">&quot;s1&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">modified</span><span class="s2">[</span><span class="s3">&quot;s2&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">modified</span><span class="s2">[</span><span class="s3">&quot;s2&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">modified</span><span class="s2">[</span><span class="s3">&quot;s3&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">modified</span><span class="s2">[</span><span class="s3">&quot;s3&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">modified</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">modified</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dates_invalid_column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">19</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)])</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">InvalidColumnName</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s4">0</span><span class="s2">: </span><span class="s3">&quot;tc&quot;</span><span class="s2">})</span>

            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">modified </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">modified</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;_0&quot;</span><span class="s2">]</span>
        <span class="s1">modified</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">modified</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_105</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># Data obtained from:</span>
        <span class="s5"># http://go.worldbank.org/ZXY29PVJ21</span>
        <span class="s1">dpath </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;S4_EDUC1.dta&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">dpath</span><span class="s2">)</span>
        <span class="s1">df0 </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">]]</span>
        <span class="s1">df0 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">df0</span><span class="s2">)</span>
        <span class="s1">df0</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;clustnum&quot;</span><span class="s2">, </span><span class="s3">&quot;pri_schl&quot;</span><span class="s2">, </span><span class="s3">&quot;psch_num&quot;</span><span class="s2">, </span><span class="s3">&quot;psch_dis&quot;</span><span class="s2">]</span>
        <span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;clustnum&quot;</span><span class="s2">] = </span><span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;clustnum&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;pri_schl&quot;</span><span class="s2">] = </span><span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;pri_schl&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;psch_num&quot;</span><span class="s2">] = </span><span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;psch_num&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;psch_dis&quot;</span><span class="s2">] = </span><span class="s1">df0</span><span class="s2">[</span><span class="s3">&quot;psch_dis&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">head</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s1">df0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_value_labels_old_format</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># GH 19417</span>
        <span class="s5">#</span>
        <span class="s5"># Test that value_labels() returns an empty dict if the file format</span>
        <span class="s5"># predates supporting value labels.</span>
        <span class="s1">dpath </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;S4_EDUC1.dta&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">dpath</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">value_labels</span><span class="s2">() == {}</span>

    <span class="s0">def </span><span class="s1">test_date_export_formats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;tc&quot;</span><span class="s2">, </span><span class="s3">&quot;td&quot;</span><span class="s2">, </span><span class="s3">&quot;tw&quot;</span><span class="s2">, </span><span class="s3">&quot;tm&quot;</span><span class="s2">, </span><span class="s3">&quot;tq&quot;</span><span class="s2">, </span><span class="s3">&quot;th&quot;</span><span class="s2">, </span><span class="s3">&quot;ty&quot;</span><span class="s2">]</span>
        <span class="s1">conversions </span><span class="s2">= {</span><span class="s1">c</span><span class="s2">: </span><span class="s1">c </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">}</span>
        <span class="s1">data </span><span class="s2">= [</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">data</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">expected_values </span><span class="s2">= [</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">13</span><span class="s2">, </span><span class="s4">20</span><span class="s2">),  </span><span class="s5"># Time</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">20</span><span class="s2">),  </span><span class="s5"># Day</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">19</span><span class="s2">),  </span><span class="s5"># Week</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),  </span><span class="s5"># Month</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),  </span><span class="s5"># Quarter year</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),  </span><span class="s5"># Half year</span>
            <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2006</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
        <span class="s2">]  </span><span class="s5"># Year</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">expected_values</span><span class="s2">],</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s1">conversions</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_write_missing_strings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s3">&quot;1&quot;</span><span class="s2">], [</span><span class="s0">None</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;foo&quot;</span><span class="s2">])</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s3">&quot;1&quot;</span><span class="s2">], [</span><span class="s3">&quot;&quot;</span><span class="s2">]],</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;foo&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;byteorder&quot;</span><span class="s2">, [</span><span class="s3">&quot;&gt;&quot;</span><span class="s2">, </span><span class="s3">&quot;&lt;&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_bool_uint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">byteorder</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">s0 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
        <span class="s1">s1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">s2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">255</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
        <span class="s1">s3 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">15 </span><span class="s2">- </span><span class="s4">100</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">)</span>
        <span class="s1">s4 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">16 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint16</span><span class="s2">)</span>
        <span class="s1">s5 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">31 </span><span class="s2">- </span><span class="s4">100</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>
        <span class="s1">s6 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">32 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint32</span><span class="s2">)</span>

        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;s0&quot;</span><span class="s2">: </span><span class="s1">s0</span><span class="s2">, </span><span class="s3">&quot;s1&quot;</span><span class="s2">: </span><span class="s1">s1</span><span class="s2">, </span><span class="s3">&quot;s2&quot;</span><span class="s2">: </span><span class="s1">s2</span><span class="s2">, </span><span class="s3">&quot;s3&quot;</span><span class="s2">: </span><span class="s1">s3</span><span class="s2">, </span><span class="s3">&quot;s4&quot;</span><span class="s2">: </span><span class="s1">s4</span><span class="s2">, </span><span class="s3">&quot;s5&quot;</span><span class="s2">: </span><span class="s1">s5</span><span class="s2">, </span><span class="s3">&quot;s6&quot;</span><span class="s2">: </span><span class="s1">s6</span><span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">expected_types </span><span class="s2">= (</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">,</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">for </span><span class="s1">c</span><span class="s2">, </span><span class="s1">t </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">expected_types</span><span class="s2">):</span>
            <span class="s1">expected</span><span class="s2">[</span><span class="s1">c</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">c</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">byteorder</span><span class="s2">=</span><span class="s1">byteorder</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_variable_labels</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata7_115.dta&quot;</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">rdr</span><span class="s2">:</span>
            <span class="s1">sr_115 </span><span class="s2">= </span><span class="s1">rdr</span><span class="s2">.</span><span class="s1">variable_labels</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata7_117.dta&quot;</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">rdr</span><span class="s2">:</span>
            <span class="s1">sr_117 </span><span class="s2">= </span><span class="s1">rdr</span><span class="s2">.</span><span class="s1">variable_labels</span><span class="s2">()</span>
        <span class="s1">keys </span><span class="s2">= (</span><span class="s3">&quot;var1&quot;</span><span class="s2">, </span><span class="s3">&quot;var2&quot;</span><span class="s2">, </span><span class="s3">&quot;var3&quot;</span><span class="s2">)</span>
        <span class="s1">labels </span><span class="s2">= (</span><span class="s3">&quot;label1&quot;</span><span class="s2">, </span><span class="s3">&quot;label2&quot;</span><span class="s2">, </span><span class="s3">&quot;label3&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">sr_115</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sr_117</span>
            <span class="s0">assert </span><span class="s1">v </span><span class="s2">== </span><span class="s1">sr_117</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">k </span><span class="s0">in </span><span class="s1">keys</span>
            <span class="s0">assert </span><span class="s1">v </span><span class="s0">in </span><span class="s1">labels</span>

    <span class="s0">def </span><span class="s1">test_minimal_size_col</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">str_lens </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">244</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">str_len </span><span class="s0">in </span><span class="s1">str_lens</span><span class="s2">:</span>
            <span class="s1">s</span><span class="s2">[</span><span class="s3">&quot;s&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">str_len</span><span class="s2">)] = </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s3">&quot;a&quot; </span><span class="s2">* </span><span class="s1">str_len</span><span class="s2">, </span><span class="s3">&quot;b&quot; </span><span class="s2">* </span><span class="s1">str_len</span><span class="s2">, </span><span class="s3">&quot;c&quot; </span><span class="s2">* </span><span class="s1">str_len</span><span class="s2">]</span>
            <span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sr</span><span class="s2">:</span>
                <span class="s1">sr</span><span class="s2">.</span><span class="s1">_ensure_open</span><span class="s2">()  </span><span class="s5"># The `_*list` variables are initialized here</span>
                <span class="s0">for </span><span class="s1">variable</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">typ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">sr</span><span class="s2">.</span><span class="s1">_varlist</span><span class="s2">, </span><span class="s1">sr</span><span class="s2">.</span><span class="s1">_fmtlist</span><span class="s2">, </span><span class="s1">sr</span><span class="s2">.</span><span class="s1">_typlist</span><span class="s2">):</span>
                    <span class="s0">assert </span><span class="s1">int</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]) == </span><span class="s1">int</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">])</span>
                    <span class="s0">assert </span><span class="s1">int</span><span class="s2">(</span><span class="s1">variable</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]) == </span><span class="s1">typ</span>

    <span class="s0">def </span><span class="s1">test_excessively_long_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">str_lens </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">244</span><span class="s2">, </span><span class="s4">500</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">= {}</span>
        <span class="s0">for </span><span class="s1">str_len </span><span class="s0">in </span><span class="s1">str_lens</span><span class="s2">:</span>
            <span class="s1">s</span><span class="s2">[</span><span class="s3">&quot;s&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">str_len</span><span class="s2">)] = </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s3">&quot;a&quot; </span><span class="s2">* </span><span class="s1">str_len</span><span class="s2">, </span><span class="s3">&quot;b&quot; </span><span class="s2">* </span><span class="s1">str_len</span><span class="s2">, </span><span class="s3">&quot;c&quot; </span><span class="s2">* </span><span class="s1">str_len</span><span class="s2">]</span>
            <span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">r&quot;Fixed width strings in Stata \.dta files are limited to 244 &quot;</span>
            <span class="s3">r&quot;\(or fewer\)\ncharacters\.  Column 's500' does not satisfy &quot;</span>
            <span class="s3">r&quot;this restriction\. Use the\n'version=117' parameter to write &quot;</span>
            <span class="s3">r&quot;the newer \(Stata 13 and later\) format\.&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_missing_value_generator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">types </span><span class="s2">= (</span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;h&quot;</span><span class="s2">, </span><span class="s3">&quot;l&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">0.0</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;float_&quot;</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">rdr</span><span class="s2">:</span>
                <span class="s1">valid_range </span><span class="s2">= </span><span class="s1">rdr</span><span class="s2">.</span><span class="s1">VALID_RANGE</span>
        <span class="s1">expected_values </span><span class="s2">= [</span><span class="s3">&quot;.&quot; </span><span class="s2">+ </span><span class="s1">chr</span><span class="s2">(</span><span class="s4">97 </span><span class="s2">+ </span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">26</span><span class="s2">)]</span>
        <span class="s1">expected_values</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;.&quot;</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">types</span><span class="s2">:</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">valid_range</span><span class="s2">[</span><span class="s1">t</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">27</span><span class="s2">):</span>
                <span class="s1">val </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span><span class="s1">offset </span><span class="s2">+ </span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">i</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">val</span><span class="s2">.</span><span class="s1">string </span><span class="s2">== </span><span class="s1">expected_values</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>

        <span class="s5"># Test extremes for floats</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;&lt;f&quot;</span><span class="s2">, </span><span class="s6">b&quot;</span><span class="s0">\x00\x00\x00\x7f</span><span class="s6">&quot;</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">val</span><span class="s2">.</span><span class="s1">string </span><span class="s2">== </span><span class="s3">&quot;.&quot;</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span><span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;&lt;f&quot;</span><span class="s2">, </span><span class="s6">b&quot;</span><span class="s0">\x00\xd0\x00\x7f</span><span class="s6">&quot;</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">val</span><span class="s2">.</span><span class="s1">string </span><span class="s2">== </span><span class="s3">&quot;.z&quot;</span>

        <span class="s5"># Test extremes for floats</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span>
            <span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;&lt;d&quot;</span><span class="s2">, </span><span class="s6">b&quot;</span><span class="s0">\x00\x00\x00\x00\x00\x00\xe0\x7f</span><span class="s6">&quot;</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">val</span><span class="s2">.</span><span class="s1">string </span><span class="s2">== </span><span class="s3">&quot;.&quot;</span>
        <span class="s1">val </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span>
            <span class="s1">struct</span><span class="s2">.</span><span class="s1">unpack</span><span class="s2">(</span><span class="s3">&quot;&lt;d&quot;</span><span class="s2">, </span><span class="s6">b&quot;</span><span class="s0">\x00\x00\x00\x00\x00\x1a\xe0\x7f</span><span class="s6">&quot;</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">val</span><span class="s2">.</span><span class="s1">string </span><span class="s2">== </span><span class="s3">&quot;.z&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata8_113&quot;</span><span class="s2">, </span><span class="s3">&quot;stata8_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata8_117&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_missing_value_conversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;int8_&quot;</span><span class="s2">, </span><span class="s3">&quot;int16_&quot;</span><span class="s2">, </span><span class="s3">&quot;int32_&quot;</span><span class="s2">, </span><span class="s3">&quot;float32_&quot;</span><span class="s2">, </span><span class="s3">&quot;float64_&quot;</span><span class="s2">]</span>
        <span class="s1">smv </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span><span class="s4">101</span><span class="s2">)</span>
        <span class="s1">keys </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">smv</span><span class="s2">.</span><span class="s1">MISSING_VALUES</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s1">data </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">27</span><span class="s2">):</span>
            <span class="s1">row </span><span class="s2">= [</span><span class="s1">StataMissingValue</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">[</span><span class="s1">i </span><span class="s2">+ (</span><span class="s1">j </span><span class="s2">* </span><span class="s4">27</span><span class="s2">)]) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)]</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>

        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">), </span><span class="s1">convert_missing</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_big_dates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">yr </span><span class="s2">= [</span><span class="s4">1960</span><span class="s2">, </span><span class="s4">2000</span><span class="s2">, </span><span class="s4">9999</span><span class="s2">, </span><span class="s4">100</span><span class="s2">, </span><span class="s4">2262</span><span class="s2">, </span><span class="s4">1677</span><span class="s2">]</span>
        <span class="s1">mo </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">9</span><span class="s2">]</span>
        <span class="s1">dd </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">22</span><span class="s2">, </span><span class="s4">23</span><span class="s2">]</span>
        <span class="s1">hr </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">23</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">mm </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">ss </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">59</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">year</span><span class="s2">, </span><span class="s1">month</span><span class="s2">, </span><span class="s1">day</span><span class="s2">, </span><span class="s1">hour</span><span class="s2">, </span><span class="s1">minute</span><span class="s2">, </span><span class="s1">second </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">yr</span><span class="s2">, </span><span class="s1">mo</span><span class="s2">, </span><span class="s1">dd</span><span class="s2">, </span><span class="s1">hr</span><span class="s2">, </span><span class="s1">mm</span><span class="s2">, </span><span class="s1">ss</span><span class="s2">):</span>
            <span class="s1">row </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">7</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">j </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">row</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s1">year</span><span class="s2">, </span><span class="s1">month</span><span class="s2">, </span><span class="s1">day</span><span class="s2">, </span><span class="s1">hour</span><span class="s2">, </span><span class="s1">minute</span><span class="s2">, </span><span class="s1">second</span><span class="s2">))</span>
                <span class="s0">elif </span><span class="s1">j </span><span class="s2">== </span><span class="s4">6</span><span class="s2">:</span>
                    <span class="s1">row</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s1">year</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">row</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">(</span><span class="s1">year</span><span class="s2">, </span><span class="s1">month</span><span class="s2">, </span><span class="s1">day</span><span class="s2">))</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">] * </span><span class="s4">7</span><span class="s2">)</span>
        <span class="s1">columns </span><span class="s2">= [</span>
            <span class="s3">&quot;date_tc&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;date_td&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;date_tw&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;date_tm&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;date_tq&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;date_th&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;date_ty&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>

        <span class="s5"># Fixes for weekly, quarterly,half,year</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">2</span><span class="s2">][</span><span class="s4">2</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">9999</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">24</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">2</span><span class="s2">][</span><span class="s4">3</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">9999</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">2</span><span class="s2">][</span><span class="s4">4</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">9999</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">2</span><span class="s2">][</span><span class="s4">5</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">9999</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">4</span><span class="s2">][</span><span class="s4">2</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2262</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">16</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">4</span><span class="s2">][</span><span class="s4">3</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">4</span><span class="s2">][</span><span class="s4">4</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2262</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">4</span><span class="s2">][</span><span class="s4">5</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">4</span><span class="s2">][</span><span class="s4">6</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2262</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">5</span><span class="s2">][</span><span class="s4">2</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">5</span><span class="s2">][</span><span class="s4">3</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">5</span><span class="s2">][</span><span class="s4">4</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1677</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s4">5</span><span class="s2">][</span><span class="s4">5</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s4">5</span><span class="s2">][</span><span class="s4">6</span><span class="s2">] = </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1678</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">parsed_115 </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata9_115.dta&quot;</span><span class="s2">))</span>
        <span class="s1">parsed_117 </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata9_117.dta&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">parsed_115</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">parsed_117</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">date_conversion </span><span class="s2">= {</span><span class="s1">c</span><span class="s2">: </span><span class="s1">c</span><span class="s2">[-</span><span class="s4">2</span><span class="s2">:] </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">columns</span><span class="s2">}</span>
        <span class="s5"># {c : c[-2:] for c in columns}</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s1">date_conversion</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
            <span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
            <span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)),</span>
            <span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dtype_conversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6.csv&quot;</span><span class="s2">))</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;byte_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;byte_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;int_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;int_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;long_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;long_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;double_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;double_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s2">,)</span>
        <span class="s2">)</span>

        <span class="s1">no_conversion </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117.dta&quot;</span><span class="s2">), </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">no_conversion</span><span class="s2">)</span>

        <span class="s1">conversion </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117.dta&quot;</span><span class="s2">),</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">preserve_dtypes</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s5"># read_csv types are the same</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6.csv&quot;</span><span class="s2">))</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s2">,)</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">conversion</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_drop_column</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_csv</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6.csv&quot;</span><span class="s2">))</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;byte_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;byte_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;int_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;int_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;long_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;long_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;float_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;double_&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;double_&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;date_td&quot;</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span>
            <span class="s1">datetime</span><span class="s2">.</span><span class="s1">strptime</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s2">,)</span>
        <span class="s2">)</span>

        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;byte_&quot;</span><span class="s2">, </span><span class="s3">&quot;int_&quot;</span><span class="s2">, </span><span class="s3">&quot;long_&quot;</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">columns</span><span class="s2">]</span>
        <span class="s1">dropped </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117.dta&quot;</span><span class="s2">),</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">dropped</span><span class="s2">)</span>

        <span class="s5"># See PR 10757</span>
        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;int_&quot;</span><span class="s2">, </span><span class="s3">&quot;long_&quot;</span><span class="s2">, </span><span class="s3">&quot;byte_&quot;</span><span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">columns</span><span class="s2">]</span>
        <span class="s1">reordered </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117.dta&quot;</span><span class="s2">),</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">reordered</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;columns contains duplicate entries&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;byte_&quot;</span><span class="s2">, </span><span class="s3">&quot;byte_&quot;</span><span class="s2">]</span>
            <span class="s1">read_stata</span><span class="s2">(</span>
                <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117.dta&quot;</span><span class="s2">),</span>
                <span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
            <span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;The following columns were not found in the Stata data set: not_found&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;byte_&quot;</span><span class="s2">, </span><span class="s3">&quot;int_&quot;</span><span class="s2">, </span><span class="s3">&quot;long_&quot;</span><span class="s2">, </span><span class="s3">&quot;not_found&quot;</span><span class="s2">]</span>
            <span class="s1">read_stata</span><span class="s2">(</span>
                <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata6_117.dta&quot;</span><span class="s2">),</span>
                <span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
        <span class="s3">&quot;ignore:</span><span class="s0">\\</span><span class="s3">nStata value:pandas.io.stata.ValueLabelTypeMismatch&quot;</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_categorical_writing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;nine&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s3">&quot;seven&quot;</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;five&quot;</span><span class="s2">, </span><span class="s3">&quot;six&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;five&quot;</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;six&quot;</span><span class="s2">, </span><span class="s3">&quot;five&quot;</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;six&quot;</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;seven&quot;</span><span class="s2">, </span><span class="s3">&quot;four&quot;</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;seven&quot;</span><span class="s2">, </span><span class="s4">7</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s3">&quot;three&quot;</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;nine&quot;</span><span class="s2">, </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;nine&quot;</span><span class="s2">, </span><span class="s4">9</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">&quot;ten&quot;</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;fully_labeled&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;fully_labeled2&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;incompletely_labeled&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;labeled_with_missings&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;float_labelled&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;unlabeled&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>

        <span class="s5"># these are all categoricals</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">original</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">original</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">set_names</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;incompletely_labeled&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;incompletely_labeled&quot;</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;unlabeled&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;unlabeled&quot;</span><span class="s2">].</span><span class="s1">apply</span><span class="s2">(</span><span class="s1">str</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">:</span>
            <span class="s1">orig </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>

            <span class="s1">cat </span><span class="s2">= </span><span class="s1">orig</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">).</span><span class="s1">_values</span>
            <span class="s1">cat </span><span class="s2">= </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">as_ordered</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">col </span><span class="s2">== </span><span class="s3">&quot;unlabeled&quot;</span><span class="s2">:</span>
                <span class="s1">cat </span><span class="s2">= </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">set_categories</span><span class="s2">(</span><span class="s1">orig</span><span class="s2">, </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

            <span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

            <span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">cat</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_categorical_warnings_and_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Warning for non-string labels</span>
        <span class="s5"># Error for labels too long</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s3">&quot;a&quot; </span><span class="s2">* </span><span class="s4">10000</span><span class="s2">], [</span><span class="s3">&quot;b&quot; </span><span class="s2">* </span><span class="s4">10000</span><span class="s2">], [</span><span class="s3">&quot;c&quot; </span><span class="s2">* </span><span class="s4">10000</span><span class="s2">], [</span><span class="s3">&quot;d&quot; </span><span class="s2">* </span><span class="s4">10000</span><span class="s2">]],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;Too_long&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">original </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">original</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">original</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= (</span>
                <span class="s3">&quot;Stata value labels for a single variable must have &quot;</span>
                <span class="s3">r&quot;a combined length less than 32,000 characters\.&quot;</span>
            <span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s3">&quot;a&quot;</span><span class="s2">], [</span><span class="s3">&quot;b&quot;</span><span class="s2">], [</span><span class="s3">&quot;c&quot;</span><span class="s2">], [</span><span class="s3">&quot;d&quot;</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;Too_long&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">original</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">original</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">ValueLabelTypeMismatch</span><span class="s2">):</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s5"># should get a warning for mixed content</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_categorical_with_stata_missing_values</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">values </span><span class="s2">= [[</span><span class="s3">&quot;a&quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">120</span><span class="s2">)]</span>
        <span class="s1">values</span><span class="s2">.</span><span class="s1">append</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;many_labels&quot;</span><span class="s2">])</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span>
            <span class="s2">[</span><span class="s1">original</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">) </span><span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">original</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">:</span>
            <span class="s1">cat </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">_values</span>
            <span class="s1">new_cats </span><span class="s2">= </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">remove_unused_categories</span><span class="s2">().</span><span class="s1">categories</span>
            <span class="s1">cat </span><span class="s2">= </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">set_categories</span><span class="s2">(</span><span class="s1">new_cats</span><span class="s2">, </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">cat</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata10_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata10_117&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_categorical_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># Directly construct using expected codes</span>
        <span class="s5"># Format is is_cat, col_name, labels (in order), underlying data</span>
        <span class="s1">expected </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;ordered&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;reverse&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)[::-</span><span class="s4">1</span><span class="s2">]),</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;noorder&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])),</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;floating&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;float_missing&quot;</span><span class="s2">, [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">])),</span>
            <span class="s2">(</span><span class="s0">False</span><span class="s2">, </span><span class="s3">&quot;nolabel&quot;</span><span class="s2">, [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)),</span>
            <span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s3">&quot;int32_mixed&quot;</span><span class="s2">, [</span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)),</span>
        <span class="s2">]</span>
        <span class="s1">cols </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">is_cat</span><span class="s2">, </span><span class="s1">col</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">, </span><span class="s1">codes </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">is_cat</span><span class="s2">:</span>
                <span class="s1">cols</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                    <span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">.</span><span class="s1">from_codes</span><span class="s2">(</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">, </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">cols</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">col</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_dict</span><span class="s2">(</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">))</span>

        <span class="s5"># Read with and with out categoricals, ensure order is identical</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">)</span>

        <span class="s5"># Check identity of codes</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">expected</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">CategoricalDtype</span><span class="s2">):</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">codes</span><span class="s2">)</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span>
                    <span class="s1">expected</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span>
                <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata11_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata11_117&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_categorical_sorting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">))</span>

        <span class="s5"># Sort based on codes, not strings</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">sort_values</span><span class="s2">(</span><span class="s3">&quot;srh&quot;</span><span class="s2">, </span><span class="s1">na_position</span><span class="s2">=</span><span class="s3">&quot;first&quot;</span><span class="s2">)</span>

        <span class="s5"># Don't sort index</span>
        <span class="s1">parsed</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">RangeIndex</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">))</span>
        <span class="s1">codes </span><span class="s2">= [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">categories </span><span class="s2">= [</span><span class="s3">&quot;Poor&quot;</span><span class="s2">, </span><span class="s3">&quot;Fair&quot;</span><span class="s2">, </span><span class="s3">&quot;Good&quot;</span><span class="s2">, </span><span class="s3">&quot;Very good&quot;</span><span class="s2">, </span><span class="s3">&quot;Excellent&quot;</span><span class="s2">]</span>
        <span class="s1">cat </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">.</span><span class="s1">from_codes</span><span class="s2">(</span>
            <span class="s1">codes</span><span class="s2">=</span><span class="s1">codes</span><span class="s2">, </span><span class="s1">categories</span><span class="s2">=</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">cat</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;srh&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">parsed</span><span class="s2">[</span><span class="s3">&quot;srh&quot;</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;file&quot;</span><span class="s2">, [</span><span class="s3">&quot;stata10_115&quot;</span><span class="s2">, </span><span class="s3">&quot;stata10_117&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_categorical_ordering</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">file</span><span class="s2">)</span>

        <span class="s1">parsed_unordered </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">file</span><span class="s2">, </span><span class="s1">order_categoricals</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">parsed</span><span class="s2">:</span>
            <span class="s0">if not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">CategoricalDtype</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s0">assert </span><span class="s1">parsed</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">ordered</span>
            <span class="s0">assert not </span><span class="s1">parsed_unordered</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">ordered</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore::UserWarning&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;file&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s3">&quot;stata1_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata2_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata3_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata4_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata5_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata6_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata7_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata8_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata9_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata10_117&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata11_117&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;chunksize&quot;</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;convert_categoricals&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;convert_dates&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_chunks_117</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">, </span><span class="s1">convert_categoricals</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">, </span><span class="s1">datapath</span>
    <span class="s2">):</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>

        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">fname</span><span class="s2">,</span>
            <span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s1">convert_categoricals</span><span class="s2">,</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s1">convert_dates</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">fname</span><span class="s2">,</span>
            <span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s1">convert_categoricals</span><span class="s2">,</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s1">convert_dates</span><span class="s2">,</span>
        <span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">):</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">chunk </span><span class="s2">= </span><span class="s1">itr</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">chunksize</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                    <span class="s0">break</span>
                <span class="s1">from_frame </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">pos </span><span class="s2">: </span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">chunksize</span><span class="s2">, :].</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">from_frame </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_convert_categorical</span><span class="s2">(</span><span class="s1">from_frame</span><span class="s2">)</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
                    <span class="s1">from_frame</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">check_dtype</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span>
                <span class="s2">)</span>
                <span class="s1">pos </span><span class="s2">+= </span><span class="s1">chunksize</span>

    <span class="s2">@</span><span class="s1">staticmethod</span>
    <span class="s0">def </span><span class="s1">_convert_categorical</span><span class="s2">(</span><span class="s1">from_frame</span><span class="s2">: </span><span class="s1">DataFrame</span><span class="s2">) </span><span class="s1">-&gt; DataFrame</span><span class="s2">:</span>
        <span class="s7">&quot;&quot;&quot; 
        Emulate the categorical casting behavior we expect from roundtripping. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">from_frame</span><span class="s2">:</span>
            <span class="s1">ser </span><span class="s2">= </span><span class="s1">from_frame</span><span class="s2">[</span><span class="s1">col</span><span class="s2">]</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ser</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">CategoricalDtype</span><span class="s2">):</span>
                <span class="s1">cat </span><span class="s2">= </span><span class="s1">ser</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">.</span><span class="s1">remove_unused_categories</span><span class="s2">()</span>
                <span class="s0">if </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">object</span><span class="s2">:</span>
                    <span class="s1">categories </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">.</span><span class="s1">_with_infer</span><span class="s2">(</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">.</span><span class="s1">_values</span><span class="s2">)</span>
                    <span class="s1">cat </span><span class="s2">= </span><span class="s1">cat</span><span class="s2">.</span><span class="s1">set_categories</span><span class="s2">(</span><span class="s1">categories</span><span class="s2">)</span>
                <span class="s1">from_frame</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">cat</span>
        <span class="s0">return </span><span class="s1">from_frame</span>

    <span class="s0">def </span><span class="s1">test_iterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3_117.dta&quot;</span><span class="s2">)</span>

        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">chunk </span><span class="s2">= </span><span class="s1">itr</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, :], </span><span class="s1">chunk</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">chunk </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">itr</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, :], </span><span class="s1">chunk</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">chunk </span><span class="s2">= </span><span class="s1">itr</span><span class="s2">.</span><span class="s1">get_chunk</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, :], </span><span class="s1">chunk</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">chunk </span><span class="s2">= </span><span class="s1">itr</span><span class="s2">.</span><span class="s1">get_chunk</span><span class="s2">()</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">5</span><span class="s2">, :], </span><span class="s1">chunk</span><span class="s2">)</span>

        <span class="s5"># GH12153</span>
        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">4</span><span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">from_chunks </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">itr</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">parsed</span><span class="s2">, </span><span class="s1">from_chunks</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span><span class="s3">&quot;ignore::UserWarning&quot;</span><span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;file&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s3">&quot;stata2_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata3_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata4_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata5_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata6_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata7_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata8_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata9_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata10_115&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;stata11_115&quot;</span><span class="s2">,</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;chunksize&quot;</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;convert_categoricals&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;convert_dates&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_read_chunks_115</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">file</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">, </span><span class="s1">convert_categoricals</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">, </span><span class="s1">datapath</span>
    <span class="s2">):</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">file</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>

        <span class="s5"># Read the whole file</span>
        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">fname</span><span class="s2">,</span>
            <span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s1">convert_categoricals</span><span class="s2">,</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s1">convert_dates</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s5"># Compare to what we get when reading by chunk</span>
        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span>
            <span class="s1">fname</span><span class="s2">,</span>
            <span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s1">convert_dates</span><span class="s2">=</span><span class="s1">convert_dates</span><span class="s2">,</span>
            <span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s1">convert_categoricals</span><span class="s2">,</span>
        <span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">):</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">chunk </span><span class="s2">= </span><span class="s1">itr</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">chunksize</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">StopIteration</span><span class="s2">:</span>
                    <span class="s0">break</span>
                <span class="s1">from_frame </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">pos </span><span class="s2">: </span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">chunksize</span><span class="s2">, :].</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">from_frame </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_convert_categorical</span><span class="s2">(</span><span class="s1">from_frame</span><span class="s2">)</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
                    <span class="s1">from_frame</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">check_dtype</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">check_datetimelike_compat</span><span class="s2">=</span><span class="s0">True</span>
                <span class="s2">)</span>
                <span class="s1">pos </span><span class="s2">+= </span><span class="s1">chunksize</span>

    <span class="s0">def </span><span class="s1">test_read_chunks_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">fname </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata3_117.dta&quot;</span><span class="s2">)</span>
        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;quarter&quot;</span><span class="s2">, </span><span class="s3">&quot;cpi&quot;</span><span class="s2">, </span><span class="s3">&quot;m1&quot;</span><span class="s2">]</span>
        <span class="s1">chunksize </span><span class="s2">= </span><span class="s4">2</span>

        <span class="s1">parsed </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">itr</span><span class="s2">:</span>
            <span class="s1">pos </span><span class="s2">= </span><span class="s4">0</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">):</span>
                <span class="s1">chunk </span><span class="s2">= </span><span class="s1">itr</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">chunksize</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">chunk </span><span class="s0">is None</span><span class="s2">:</span>
                    <span class="s0">break</span>
                <span class="s1">from_frame </span><span class="s2">= </span><span class="s1">parsed</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">pos </span><span class="s2">: </span><span class="s1">pos </span><span class="s2">+ </span><span class="s1">chunksize</span><span class="s2">, :]</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">from_frame</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">check_dtype</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s1">pos </span><span class="s2">+= </span><span class="s1">chunksize</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_write_variable_labels</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">mixed_frame</span><span class="s2">):</span>
        <span class="s5"># GH 13631, add support for writing variable labels</span>
        <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">variable_labels </span><span class="s2">= {</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;City Rank&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;City Exponent&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;City&quot;</span><span class="s2">}</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sr</span><span class="s2">:</span>
                <span class="s1">read_labels </span><span class="s2">= </span><span class="s1">sr</span><span class="s2">.</span><span class="s1">variable_labels</span><span class="s2">()</span>
            <span class="s1">expected_labels </span><span class="s2">= {</span>
                <span class="s3">&quot;index&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;City Rank&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;City Exponent&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;City&quot;</span><span class="s2">,</span>
            <span class="s2">}</span>
            <span class="s0">assert </span><span class="s1">read_labels </span><span class="s2">== </span><span class="s1">expected_labels</span>

        <span class="s1">variable_labels</span><span class="s2">[</span><span class="s3">&quot;index&quot;</span><span class="s2">] = </span><span class="s3">&quot;The Index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">sr</span><span class="s2">:</span>
                <span class="s1">read_labels </span><span class="s2">= </span><span class="s1">sr</span><span class="s2">.</span><span class="s1">variable_labels</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">read_labels </span><span class="s2">== </span><span class="s1">variable_labels</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_variable_labels</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">mixed_frame</span><span class="s2">):</span>
        <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">variable_labels </span><span class="s2">= {</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;very long&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;City Exponent&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;City&quot;</span><span class="s2">}</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Variable labels must be 80 characters or fewer&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span>
                    <span class="s1">path</span><span class="s2">, </span><span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span>
                <span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_variable_label_encoding</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">mixed_frame</span><span class="s2">):</span>
        <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">variable_labels </span><span class="s2">= {</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;very long&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;City Exponent&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;City&quot;</span><span class="s2">}</span>
        <span class="s1">variable_labels</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] = </span><span class="s3">&quot;invalid character Œ&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
                <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Variable labels must contain only characters&quot;</span>
            <span class="s2">):</span>
                <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span>
                    <span class="s1">path</span><span class="s2">, </span><span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span>
                <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_write_variable_label_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">mixed_frame</span><span class="s2">):</span>
        <span class="s1">values </span><span class="s2">= [</span><span class="s3">&quot;</span><span class="s0">\u03A1</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u0391</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u039D</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u0394</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u0391</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;</span><span class="s0">\u03A3</span><span class="s3">&quot;</span><span class="s2">]</span>

        <span class="s1">variable_labels_utf8 </span><span class="s2">= {</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;City Rank&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;City Exponent&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">values</span><span class="s2">),</span>
        <span class="s2">}</span>

        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">&quot;Variable labels must contain only characters that can be &quot;</span>
            <span class="s3">&quot;encoded in Latin-1&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels_utf8</span><span class="s2">)</span>

        <span class="s1">variable_labels_long </span><span class="s2">= {</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;City Rank&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;City Exponent&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s3">&quot;A very, very, very long variable label &quot;</span>
            <span class="s3">&quot;that is too long for Stata which means &quot;</span>
            <span class="s3">&quot;that it has more than 80 characters&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Variable labels must be 80 characters or fewer&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">mixed_frame</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels_long</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_default_date_conversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 12259</span>
        <span class="s1">dates </span><span class="s2">= [</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1999</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12000</span><span class="s2">),</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2012</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21000</span><span class="s2">),</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1776</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4000</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;nums&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
                <span class="s3">&quot;strs&quot;</span><span class="s2">: [</span><span class="s3">&quot;apple&quot;</span><span class="s2">, </span><span class="s3">&quot;banana&quot;</span><span class="s2">, </span><span class="s3">&quot;cherry&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s1">dates</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">original</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>

            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s3">&quot;tc&quot;</span><span class="s2">})</span>
            <span class="s1">direct </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">direct</span><span class="s2">)</span>

            <span class="s1">dates_idx </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">().</span><span class="s1">index</span><span class="s2">(</span><span class="s3">&quot;dates&quot;</span><span class="s2">)</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s1">dates_idx</span><span class="s2">: </span><span class="s3">&quot;tc&quot;</span><span class="s2">})</span>
            <span class="s1">direct </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">direct</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unsupported_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1 </span><span class="s2">+ </span><span class="s4">2j</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">4j</span><span class="s2">]})</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Data type complex128 not supported&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unsupported_datetype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dates </span><span class="s2">= [</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1999</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12000</span><span class="s2">),</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2012</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21000</span><span class="s2">),</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1776</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4000</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;nums&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
                <span class="s3">&quot;strs&quot;</span><span class="s2">: [</span><span class="s3">&quot;apple&quot;</span><span class="s2">, </span><span class="s3">&quot;banana&quot;</span><span class="s2">, </span><span class="s3">&quot;cherry&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s1">dates</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Format %tC not implemented&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s3">&quot;tC&quot;</span><span class="s2">})</span>

        <span class="s1">dates </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1-1-1990&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;Asia/Hong_Kong&quot;</span><span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;nums&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
                <span class="s3">&quot;strs&quot;</span><span class="s2">: [</span><span class="s3">&quot;apple&quot;</span><span class="s2">, </span><span class="s3">&quot;banana&quot;</span><span class="s2">, </span><span class="s3">&quot;cherry&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s1">dates</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Data type datetime64&quot;</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_repeated_column_labels</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># GH 13923, 25772</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
Value labels for column ethnicsn are not unique. These cannot be converted to 
pandas categoricals. 
 
Either read the file with `convert_categoricals` set to False or use the 
low level interface in `StataReader` to separately read the values and the 
value_labels. 
 
The repeated labels are:</span><span class="s0">\n</span><span class="s3">-+</span><span class="s0">\n</span><span class="s3">wolof 
&quot;&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">read_stata</span><span class="s2">(</span>
                <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata15.dta&quot;</span><span class="s2">),</span>
                <span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_stata_111</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># 111 is an old version but still used by current versions of</span>
        <span class="s5"># SAS when exporting to Stata format. We do not know of any</span>
        <span class="s5"># on-line documentation for this version.</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata7_111.dta&quot;</span><span class="s2">))</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;y&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">],</span>
                <span class="s3">&quot;x&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                <span class="s3">&quot;w&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                <span class="s3">&quot;z&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;e&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;g&quot;</span><span class="s2">, </span><span class="s3">&quot;h&quot;</span><span class="s2">, </span><span class="s3">&quot;i&quot;</span><span class="s2">, </span><span class="s3">&quot;j&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">original</span><span class="s2">[[</span><span class="s3">&quot;y&quot;</span><span class="s2">, </span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s2">, </span><span class="s3">&quot;z&quot;</span><span class="s2">]]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">original</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_out_of_range_double</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 14618</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;ColumnOk&quot;</span><span class="s2">: [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">, </span><span class="s4">4.49423283715579e307</span><span class="s2">],</span>
                <span class="s3">&quot;ColumnTooBig&quot;</span><span class="s2">: [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">double</span><span class="s2">).</span><span class="s1">max</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">r&quot;Column ColumnTooBig has a maximum value \(.+\) outside the range &quot;</span>
            <span class="s3">r&quot;supported by Stata \(.+\)&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_out_of_range_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;ColumnOk&quot;</span><span class="s2">: [</span>
                    <span class="s4">0.0</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">max </span><span class="s2">/ </span><span class="s4">10.0</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s3">&quot;ColumnTooBig&quot;</span><span class="s2">: [</span>
                    <span class="s4">0.0</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">).</span><span class="s1">max</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">original</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">[</span><span class="s1">col</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s1">col</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;ColumnTooBig&quot;</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;ColumnTooBig&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;infval&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">infval</span><span class="s2">):</span>
        <span class="s5"># GH 45350</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;WithoutInf&quot;</span><span class="s2">: [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">], </span><span class="s3">&quot;WithInf&quot;</span><span class="s2">: [</span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">infval</span><span class="s2">]})</span>
        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">&quot;Column WithInf contains infinity or -infinity&quot;</span>
            <span class="s3">&quot;which is outside the range supported by Stata.&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_path_pathlib</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s4">1.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">120</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">f&quot;i-</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">30</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">reader </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">x</span><span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">round_trip_pathlib</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_pickle_path_localpath</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s4">1.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">120</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">f&quot;i-</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">30</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">reader </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">x</span><span class="s2">).</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">round_trip_localpath</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">, </span><span class="s1">reader</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;write_index&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_value_labels_iterator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">):</span>
        <span class="s5"># GH 16923</span>
        <span class="s1">d </span><span class="s2">= {</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">]}</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">=</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s1">write_index</span><span class="s2">)</span>

            <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">iterator</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">dta_iter</span><span class="s2">:</span>
                <span class="s1">value_labels </span><span class="s2">= </span><span class="s1">dta_iter</span><span class="s2">.</span><span class="s1">value_labels</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">value_labels </span><span class="s2">== {</span><span class="s3">&quot;A&quot;</span><span class="s2">: {</span><span class="s4">0</span><span class="s2">: </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">: </span><span class="s3">&quot;E&quot;</span><span class="s2">}}</span>

    <span class="s0">def </span><span class="s1">test_set_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 17328</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s4">1.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">120</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">f&quot;i-</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">30</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;column&quot;</span><span class="s2">, [</span><span class="s3">&quot;ms&quot;</span><span class="s2">, </span><span class="s3">&quot;day&quot;</span><span class="s2">, </span><span class="s3">&quot;week&quot;</span><span class="s2">, </span><span class="s3">&quot;month&quot;</span><span class="s2">, </span><span class="s3">&quot;qtr&quot;</span><span class="s2">, </span><span class="s3">&quot;half&quot;</span><span class="s2">, </span><span class="s3">&quot;yr&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_date_parsing_ignores_format_details</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">column</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># GH 17797</span>
        <span class="s5">#</span>
        <span class="s5"># Test that display formats are ignored when determining if a numeric</span>
        <span class="s5"># column is a date value.</span>
        <span class="s5">#</span>
        <span class="s5"># All date types are stored as numbers and format associated with the</span>
        <span class="s5"># column denotes both the type of the date and the display format.</span>
        <span class="s5">#</span>
        <span class="s5"># STATA supports 9 date types which each have distinct units. We test 7</span>
        <span class="s5"># of the 9 types, ignoring %tC and %tb. %tC is a variant of %tc that</span>
        <span class="s5"># accounts for leap seconds and %tb relies on STATAs business calendar.</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata13_dates.dta&quot;</span><span class="s2">))</span>
        <span class="s1">unformatted </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">column</span><span class="s2">]</span>
        <span class="s1">formatted </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s1">column </span><span class="s2">+ </span><span class="s3">&quot;_fmt&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">unformatted </span><span class="s2">== </span><span class="s1">formatted</span>

    <span class="s0">def </span><span class="s1">test_writer_117</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">=[</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;string&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;object&quot;</span><span class="s2">,</span>
                    <span class="s4">1</span><span class="s2">,</span>
                    <span class="s4">1</span><span class="s2">,</span>
                    <span class="s4">1</span><span class="s2">,</span>
                    <span class="s4">1.1</span><span class="s2">,</span>
                    <span class="s4">1.1</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;2003-12-25&quot;</span><span class="s2">),</span>
                    <span class="s3">&quot;a&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;a&quot; </span><span class="s2">* </span><span class="s4">2045</span><span class="s2">,</span>
                    <span class="s3">&quot;a&quot; </span><span class="s2">* </span><span class="s4">5000</span><span class="s2">,</span>
                    <span class="s3">&quot;a&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s2">[</span>
                    <span class="s3">&quot;string-1&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;object-1&quot;</span><span class="s2">,</span>
                    <span class="s4">1</span><span class="s2">,</span>
                    <span class="s4">1</span><span class="s2">,</span>
                    <span class="s4">1</span><span class="s2">,</span>
                    <span class="s4">1.1</span><span class="s2">,</span>
                    <span class="s4">1.1</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s3">&quot;2003-12-26&quot;</span><span class="s2">),</span>
                    <span class="s3">&quot;b&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;b&quot; </span><span class="s2">* </span><span class="s4">2045</span><span class="s2">,</span>
                    <span class="s3">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span>
                <span class="s3">&quot;string&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;object&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;int8&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;int16&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;int32&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;float32&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;float64&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;datetime&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;s1&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;s2045&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;srtl&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;forced_strl&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;object&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;object&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;int8&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;int8&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;int16&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;int16&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int16</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;int32&quot;</span><span class="s2">] = </span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;int32&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;float32&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">original</span><span class="s2">[</span><span class="s3">&quot;float32&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">copy </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">,</span>
                <span class="s1">convert_dates</span><span class="s2">={</span><span class="s3">&quot;datetime&quot;</span><span class="s2">: </span><span class="s3">&quot;tc&quot;</span><span class="s2">},</span>
                <span class="s1">convert_strl</span><span class="s2">=[</span><span class="s3">&quot;forced_strl&quot;</span><span class="s2">],</span>
                <span class="s1">version</span><span class="s2">=</span><span class="s4">117</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s5"># original.index is np.int32, read index is np.int64</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
                <span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
                <span class="s1">original</span><span class="s2">,</span>
                <span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">original</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_convert_strl_name_swap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s3">&quot;a&quot; </span><span class="s2">* </span><span class="s4">3000</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;apple&quot;</span><span class="s2">], [</span><span class="s3">&quot;b&quot; </span><span class="s2">* </span><span class="s4">1000</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;banana&quot;</span><span class="s2">]],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;long1&quot; </span><span class="s2">* </span><span class="s4">10</span><span class="s2">, </span><span class="s3">&quot;long&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">original</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">InvalidColumnName</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_strl</span><span class="s2">=[</span><span class="s3">&quot;long&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">version</span><span class="s2">=</span><span class="s4">117</span><span class="s2">)</span>
                <span class="s1">reread </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
                <span class="s1">reread </span><span class="s2">= </span><span class="s1">reread</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
                <span class="s1">reread</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">original</span><span class="s2">.</span><span class="s1">columns</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">original</span><span class="s2">, </span><span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_invalid_date_conversion</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 12259</span>
        <span class="s1">dates </span><span class="s2">= [</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1999</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">12000</span><span class="s2">),</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2012</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">21000</span><span class="s2">),</span>
            <span class="s1">dt</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">1776</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4000</span><span class="s2">),</span>
        <span class="s2">]</span>
        <span class="s1">original </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;nums&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">],</span>
                <span class="s3">&quot;strs&quot;</span><span class="s2">: [</span><span class="s3">&quot;apple&quot;</span><span class="s2">, </span><span class="s3">&quot;banana&quot;</span><span class="s2">, </span><span class="s3">&quot;cherry&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s1">dates</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;convert_dates key must be a column or an integer&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">original</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_dates</span><span class="s2">={</span><span class="s3">&quot;wrong_name&quot;</span><span class="s2">: </span><span class="s3">&quot;tc&quot;</span><span class="s2">})</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_nonfile_writing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s5"># GH 21041</span>
        <span class="s1">bio </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s4">1.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">120</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">f&quot;i-</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">30</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">bio</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
            <span class="s1">bio</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">dta</span><span class="s2">:</span>
                <span class="s1">dta</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s1">bio</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
            <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_gzip_writing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># writing version 117 requires seek and cannot be used with gzip</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s4">1.1 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">120</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">30</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">f&quot;i-</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">30</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">GzipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;wb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">gz</span><span class="s2">:</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">gz</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">114</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">GzipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">gz</span><span class="s2">:</span>
                <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">gz</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unicode_dta_118</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s1">unicode_df </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata16_118.dta&quot;</span><span class="s2">))</span>

        <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;utf8&quot;</span><span class="s2">, </span><span class="s3">&quot;latin1&quot;</span><span class="s2">, </span><span class="s3">&quot;ascii&quot;</span><span class="s2">, </span><span class="s3">&quot;utf8_strl&quot;</span><span class="s2">, </span><span class="s3">&quot;ascii_strl&quot;</span><span class="s2">]</span>
        <span class="s1">values </span><span class="s2">= [</span>
            <span class="s2">[</span><span class="s3">&quot;ραηδας&quot;</span><span class="s2">, </span><span class="s3">&quot;PÄNDÄS&quot;</span><span class="s2">, </span><span class="s3">&quot;p&quot;</span><span class="s2">, </span><span class="s3">&quot;ραηδας&quot;</span><span class="s2">, </span><span class="s3">&quot;p&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;ƤĀńĐąŜ&quot;</span><span class="s2">, </span><span class="s3">&quot;Ö&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;ƤĀńĐąŜ&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;ᴘᴀᴎᴅᴀS&quot;</span><span class="s2">, </span><span class="s3">&quot;Ü&quot;</span><span class="s2">, </span><span class="s3">&quot;n&quot;</span><span class="s2">, </span><span class="s3">&quot;ᴘᴀᴎᴅᴀS&quot;</span><span class="s2">, </span><span class="s3">&quot;n&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;      &quot;</span><span class="s2">, </span><span class="s3">&quot;      &quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">, </span><span class="s3">&quot;      &quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot; &quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot; &quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;s&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot; &quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s3">&quot; &quot;</span><span class="s2">],</span>
        <span class="s2">]</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">unicode_df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mixed_string_strl</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 23633</span>
        <span class="s1">output </span><span class="s2">= [{</span><span class="s3">&quot;mixed&quot;</span><span class="s2">: </span><span class="s3">&quot;string&quot; </span><span class="s2">* </span><span class="s4">500</span><span class="s2">, </span><span class="s3">&quot;number&quot;</span><span class="s2">: </span><span class="s4">0</span><span class="s2">}, {</span><span class="s3">&quot;mixed&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;number&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}]</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">output</span><span class="s2">.</span><span class="s1">number </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">number</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int32&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">output</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">117</span><span class="s2">)</span>
            <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">fillna</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

            <span class="s5"># Check strl supports all None (null)</span>
            <span class="s1">output</span><span class="s2">[</span><span class="s3">&quot;mixed&quot;</span><span class="s2">] = </span><span class="s0">None</span>
            <span class="s1">output</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">convert_strl</span><span class="s2">=[</span><span class="s3">&quot;mixed&quot;</span><span class="s2">], </span><span class="s1">version</span><span class="s2">=</span><span class="s4">117</span>
            <span class="s2">)</span>
            <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">expected </span><span class="s2">= </span><span class="s1">output</span><span class="s2">.</span><span class="s1">fillna</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_all_none_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">output </span><span class="s2">= [{</span><span class="s3">&quot;none&quot;</span><span class="s2">: </span><span class="s3">&quot;none&quot;</span><span class="s2">, </span><span class="s3">&quot;number&quot;</span><span class="s2">: </span><span class="s4">0</span><span class="s2">}, {</span><span class="s3">&quot;none&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;number&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}]</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">output</span><span class="s2">)</span>
        <span class="s1">output</span><span class="s2">[</span><span class="s3">&quot;none&quot;</span><span class="s2">] = </span><span class="s0">None</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Column `none` cannot be exported&quot;</span><span class="s2">):</span>
                <span class="s1">output</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_file_not_written</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">content </span><span class="s2">= </span><span class="s3">&quot;Here is one __�__ Another one __·__ Another one __½__&quot;</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">content</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;invalid&quot;</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">msg1 </span><span class="s2">= (</span>
                <span class="s3">r&quot;'latin-1' codec can't encode character '\\ufffd' &quot;</span>
                <span class="s3">r&quot;in position 14: ordinal not in range\(256\)&quot;</span>
            <span class="s2">)</span>
            <span class="s1">msg2 </span><span class="s2">= (</span>
                <span class="s3">&quot;'ascii' codec can't decode byte 0xef in position 14: &quot;</span>
                <span class="s3">r&quot;ordinal not in range\(128\)&quot;</span>
            <span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UnicodeEncodeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">msg1</span><span class="s0">}</span><span class="s3">|</span><span class="s0">{</span><span class="s1">msg2</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_strl_latin1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 23573, correct GSO data to reflect correct size</span>
        <span class="s1">output </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s3">&quot;pandas&quot;</span><span class="s2">] * </span><span class="s4">2</span><span class="s2">, [</span><span class="s3">&quot;þâÑÐÅ§&quot;</span><span class="s2">] * </span><span class="s4">2</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;var_str&quot;</span><span class="s2">, </span><span class="s3">&quot;var_strl&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">output</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">117</span><span class="s2">, </span><span class="s1">convert_strl</span><span class="s2">=[</span><span class="s3">&quot;var_strl&quot;</span><span class="s2">])</span>
            <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reread</span><span class="s2">:</span>
                <span class="s1">content </span><span class="s2">= </span><span class="s1">reread</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>
                <span class="s1">expected </span><span class="s2">= </span><span class="s3">&quot;þâÑÐÅ§&quot;</span>
                <span class="s0">assert </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;latin-1&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">content</span>
                <span class="s0">assert </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">in </span><span class="s1">content</span>
                <span class="s1">gsos </span><span class="s2">= </span><span class="s1">content</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b&quot;strls&quot;</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">][</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">2</span><span class="s2">]</span>
                <span class="s0">for </span><span class="s1">gso </span><span class="s0">in </span><span class="s1">gsos</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b&quot;GSO&quot;</span><span class="s2">)[</span><span class="s4">1</span><span class="s2">:]:</span>
                    <span class="s1">val </span><span class="s2">= </span><span class="s1">gso</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s6">b&quot;</span><span class="s0">\x00</span><span class="s6">&quot;</span><span class="s2">)[-</span><span class="s4">2</span><span class="s2">]</span>
                    <span class="s1">size </span><span class="s2">= </span><span class="s1">gso</span><span class="s2">[</span><span class="s1">gso</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s6">b&quot;</span><span class="s0">\x82</span><span class="s6">&quot;</span><span class="s2">) + </span><span class="s4">1</span><span class="s2">]</span>
                    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">val</span><span class="s2">) == </span><span class="s1">size </span><span class="s2">- </span><span class="s4">1</span>

    <span class="s0">def </span><span class="s1">test_encoding_latin1_118</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># GH 25960</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
One or more strings in the dta file could not be decoded using utf-8, and 
so the fallback encoding of latin-1 is being used.  This can happen when a file 
has been incorrectly encoded by Stata or some other software. You should verify 
the string values returned are correct.&quot;&quot;&quot;</span>
        <span class="s5"># Move path outside of read_stata, or else assert_produces_warning</span>
        <span class="s5"># will block pytests skip mechanism from triggering (failing the test)</span>
        <span class="s5"># if the path is not present</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata1_encoding_118.dta&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">UnicodeWarning</span><span class="s2">, </span><span class="s1">filter_level</span><span class="s2">=</span><span class="s3">&quot;once&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">w</span><span class="s2">:</span>
            <span class="s1">encoded </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s5"># with filter_level=&quot;always&quot;, produces 151 warnings which can be slow</span>
            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">w</span><span class="s2">) == </span><span class="s4">1</span>
            <span class="s0">assert </span><span class="s1">w</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">message</span><span class="s2">.</span><span class="s1">args</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">msg</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s3">&quot;Düsseldorf&quot;</span><span class="s2">]] * </span><span class="s4">151</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;kreis1849&quot;</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">encoded</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">slow</span>
    <span class="s0">def </span><span class="s1">test_stata_119</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
        <span class="s5"># Gzipped since contains 32,999 variables and uncompressed is 20MiB</span>
        <span class="s5"># Just validate that the reader reports correct number of variables</span>
        <span class="s5"># to avoid high peak memory</span>
        <span class="s0">with </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span>
            <span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata1_119.dta.gz&quot;</span><span class="s2">), </span><span class="s3">&quot;rb&quot;</span>
        <span class="s2">) </span><span class="s0">as </span><span class="s1">gz</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">gz</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
                <span class="s1">reader</span><span class="s2">.</span><span class="s1">_ensure_open</span><span class="s2">()</span>
                <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">_nvar </span><span class="s2">== </span><span class="s4">32999</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_utf8_writer</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
        <span class="s1">cat </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;β&quot;</span><span class="s2">, </span><span class="s3">&quot;ĉ&quot;</span><span class="s2">], </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;ᴬ&quot;</span><span class="s2">, </span><span class="s3">&quot;ᴀ relatively long ŝtring&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;ᴮ&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s3">&quot;ᴰ&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s2">],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;Å&quot;</span><span class="s2">, </span><span class="s3">&quot;β&quot;</span><span class="s2">, </span><span class="s3">&quot;ĉ&quot;</span><span class="s2">, </span><span class="s3">&quot;strls&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;ᴐᴬᵀ&quot;</span><span class="s2">] = </span><span class="s1">cat</span>
        <span class="s1">variable_labels </span><span class="s2">= {</span>
            <span class="s3">&quot;Å&quot;</span><span class="s2">: </span><span class="s3">&quot;apple&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;β&quot;</span><span class="s2">: </span><span class="s3">&quot;ᵈᵉᵊ&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ĉ&quot;</span><span class="s2">: </span><span class="s3">&quot;ᴎტჄႲႳႴႶႺ&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;strls&quot;</span><span class="s2">: </span><span class="s3">&quot;Long Strings&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ᴐᴬᵀ&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s1">data_label </span><span class="s2">= </span><span class="s3">&quot;ᴅaᵀa-label&quot;</span>
        <span class="s1">value_labels </span><span class="s2">= {</span><span class="s3">&quot;β&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;label&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;æøå&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">: </span><span class="s3">&quot;ŋot valid latin-1&quot;</span><span class="s2">}}</span>
        <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;β&quot;</span><span class="s2">] = </span><span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;β&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">writer </span><span class="s2">= </span><span class="s1">StataWriterUTF8</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">,</span>
                <span class="s1">data</span><span class="s2">,</span>
                <span class="s1">data_label</span><span class="s2">=</span><span class="s1">data_label</span><span class="s2">,</span>
                <span class="s1">convert_strl</span><span class="s2">=[</span><span class="s3">&quot;strls&quot;</span><span class="s2">],</span>
                <span class="s1">variable_labels</span><span class="s2">=</span><span class="s1">variable_labels</span><span class="s2">,</span>
                <span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                <span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">,</span>
                <span class="s1">value_labels</span><span class="s2">=</span><span class="s1">value_labels</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">write_file</span><span class="s2">()</span>
            <span class="s1">reread_encoded </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s5"># Missing is intentionally converted to empty strl</span>
            <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;strls&quot;</span><span class="s2">] = </span><span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;strls&quot;</span><span class="s2">].</span><span class="s1">fillna</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
            <span class="s5"># Variable with value labels is reread as categorical</span>
            <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;β&quot;</span><span class="s2">] = (</span>
                <span class="s1">data</span><span class="s2">[</span><span class="s3">&quot;β&quot;</span><span class="s2">].</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">value_labels</span><span class="s2">[</span><span class="s3">&quot;β&quot;</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">).</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">as_ordered</span><span class="s2">()</span>
            <span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">reread_encoded</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">data_label </span><span class="s2">== </span><span class="s1">data_label</span>
                <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">variable_labels</span><span class="s2">() == </span><span class="s1">variable_labels</span>

            <span class="s1">data</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
            <span class="s1">reread_to_stata </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">reread_to_stata</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_writer_118_exceptions</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">33000</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int8</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;version must be either 118 or 119.&quot;</span><span class="s2">):</span>
                <span class="s1">StataWriterUTF8</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">117</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;You must use version 119&quot;</span><span class="s2">):</span>
                <span class="s1">StataWriterUTF8</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">118</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;dtype_backend&quot;</span><span class="s2">,</span>
        <span class="s2">[</span><span class="s3">&quot;numpy_nullable&quot;</span><span class="s2">, </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">))],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_read_write_ea_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                <span class="s3">&quot;d&quot;</span><span class="s2">: [</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">],</span>
                <span class="s3">&quot;e&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">),</span>
            <span class="s2">},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">convert_dtypes</span><span class="s2">(</span><span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s3">&quot;test_stata.dta&quot;</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">118</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
            <span class="s1">written_and_read_again </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">read_dta</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s3">&quot;d&quot;</span><span class="s2">: [</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">],</span>
                <span class="s3">&quot;e&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2020-12-31&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;D&quot;</span><span class="s2">),</span>
            <span class="s2">},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">),</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">written_and_read_again</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">105</span><span class="s2">, </span><span class="s4">108</span><span class="s2">, </span><span class="s4">111</span><span class="s2">, </span><span class="s4">113</span><span class="s2">, </span><span class="s4">114</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_backward_compat</span><span class="s2">(</span><span class="s1">version</span><span class="s2">, </span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s1">data_base </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">)</span>
    <span class="s1">ref </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">data_base</span><span class="s2">, </span><span class="s3">&quot;stata-compat-118.dta&quot;</span><span class="s2">)</span>
    <span class="s1">old </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">data_base</span><span class="s2">, </span><span class="s3">f&quot;stata-compat-</span><span class="s0">{</span><span class="s1">version</span><span class="s0">}</span><span class="s3">.dta&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">)</span>
    <span class="s1">old_dta </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">old</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">old_dta</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_dtype</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_direct_read</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">file_path </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata-compat-118.dta&quot;</span><span class="s2">)</span>

    <span class="s5"># Test that opening a file path doesn't buffer the file.</span>
    <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
        <span class="s5"># Must not have been buffered to memory</span>
        <span class="s0">assert not </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">empty</span>
        <span class="s0">assert not </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">.</span><span class="s1">_path_or_buf</span><span class="s2">, </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">)</span>

    <span class="s5"># Test that we use a given fp exactly, if possible.</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s0">assert not </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">empty</span>
            <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">_path_or_buf </span><span class="s0">is </span><span class="s1">fp</span>

    <span class="s5"># Test that we use a given BytesIO exactly, if possible.</span>
    <span class="s0">with </span><span class="s1">open</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fp</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()) </span><span class="s0">as </span><span class="s1">bio</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">bio</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
                <span class="s0">assert not </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">empty</span>
                <span class="s0">assert </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">_path_or_buf </span><span class="s0">is </span><span class="s1">bio</span>


<span class="s0">def </span><span class="s1">test_statareader_warns_when_used_without_context</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s1">file_path </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata-compat-118.dta&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span>
        <span class="s1">ResourceWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;without using a context manager&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">sr </span><span class="s2">= </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">file_path</span><span class="s2">)</span>
        <span class="s1">sr</span><span class="s2">.</span><span class="s1">read</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span>
        <span class="s1">FutureWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;is not part of the public API&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">sr</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;use_dict&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;infer&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_compression</span><span class="s2">(</span><span class="s1">compression</span><span class="s2">, </span><span class="s1">version</span><span class="s2">, </span><span class="s1">use_dict</span><span class="s2">, </span><span class="s1">infer</span><span class="s2">, </span><span class="s1">compression_to_extension</span><span class="s2">):</span>
    <span class="s1">file_name </span><span class="s2">= </span><span class="s3">&quot;dta_inferred_compression.dta&quot;</span>
    <span class="s0">if </span><span class="s1">compression</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">use_dict</span><span class="s2">:</span>
            <span class="s1">file_ext </span><span class="s2">= </span><span class="s1">compression</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">file_ext </span><span class="s2">= </span><span class="s1">compression_to_extension</span><span class="s2">[</span><span class="s1">compression</span><span class="s2">]</span>
        <span class="s1">file_name </span><span class="s2">+= </span><span class="s3">f&quot;.</span><span class="s0">{</span><span class="s1">file_ext</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s1">compression_arg </span><span class="s2">= </span><span class="s1">compression</span>
    <span class="s0">if </span><span class="s1">infer</span><span class="s2">:</span>
        <span class="s1">compression_arg </span><span class="s2">= </span><span class="s3">&quot;infer&quot;</span>
    <span class="s0">if </span><span class="s1">use_dict</span><span class="s2">:</span>
        <span class="s1">compression_arg </span><span class="s2">= {</span><span class="s3">&quot;method&quot;</span><span class="s2">: </span><span class="s1">compression</span><span class="s2">}</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;AB&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s1">file_name</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression_arg</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">compression </span><span class="s2">== </span><span class="s3">&quot;gzip&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">gzip</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">comp</span><span class="s2">:</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">compression </span><span class="s2">== </span><span class="s3">&quot;zip&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;r&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">comp</span><span class="s2">:</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]))</span>
        <span class="s0">elif </span><span class="s1">compression </span><span class="s2">== </span><span class="s3">&quot;tar&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">tarfile</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">tar</span><span class="s2">:</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">tar</span><span class="s2">.</span><span class="s1">extractfile</span><span class="s2">(</span><span class="s1">tar</span><span class="s2">.</span><span class="s1">getnames</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">]).</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">compression </span><span class="s2">== </span><span class="s3">&quot;bz2&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">bz2</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">comp</span><span class="s2">:</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">compression </span><span class="s2">== </span><span class="s3">&quot;zstd&quot;</span><span class="s2">:</span>
            <span class="s1">zstd </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;zstandard&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">zstd</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">comp</span><span class="s2">:</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">compression </span><span class="s2">== </span><span class="s3">&quot;xz&quot;</span><span class="s2">:</span>
            <span class="s1">lzma </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;lzma&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">lzma</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">comp</span><span class="s2">:</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">comp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s0">elif </span><span class="s1">compression </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">fp </span><span class="s2">= </span><span class="s1">path</span>
        <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s3">&quot;zip&quot;</span><span class="s2">, </span><span class="s3">&quot;infer&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;file_ext&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;dta&quot;</span><span class="s2">, </span><span class="s3">&quot;zip&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_compression_dict</span><span class="s2">(</span><span class="s1">method</span><span class="s2">, </span><span class="s1">file_ext</span><span class="s2">):</span>
    <span class="s1">file_name </span><span class="s2">= </span><span class="s3">f&quot;test.</span><span class="s0">{</span><span class="s1">file_ext</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s1">archive_name </span><span class="s2">= </span><span class="s3">&quot;test.dta&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;AB&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s1">file_name</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">compression </span><span class="s2">= {</span><span class="s3">&quot;method&quot;</span><span class="s2">: </span><span class="s1">method</span><span class="s2">, </span><span class="s3">&quot;archive_name&quot;</span><span class="s2">: </span><span class="s1">archive_name</span><span class="s2">}</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;zip&quot; </span><span class="s0">or </span><span class="s1">file_ext </span><span class="s2">== </span><span class="s3">&quot;zip&quot;</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">zipfile</span><span class="s2">.</span><span class="s1">ZipFile</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s3">&quot;r&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">zp</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">) == </span><span class="s4">1</span>
                <span class="s0">assert </span><span class="s1">zp</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">filename </span><span class="s2">== </span><span class="s1">archive_name</span>
                <span class="s1">fp </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">.</span><span class="s1">read</span><span class="s2">(</span><span class="s1">zp</span><span class="s2">.</span><span class="s1">filelist</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]))</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fp </span><span class="s2">= </span><span class="s1">path</span>
        <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_chunked_categorical</span><span class="s2">(</span><span class="s1">version</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;cats&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;category&quot;</span><span class="s2">)})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">order_categoricals</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">):</span>
                <span class="s1">block </span><span class="s2">= </span><span class="s1">block</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s3">&quot;cats&quot; </span><span class="s0">in </span><span class="s1">block</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span>
                    <span class="s1">block</span><span class="s2">.</span><span class="s1">cats</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">cats</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">i </span><span class="s2">: </span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)]</span>
                <span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_chunked_categorical_partial</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s1">dta_file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata-dta-partially-labeled.dta&quot;</span><span class="s2">)</span>
    <span class="s1">values </span><span class="s2">= [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">dta_file</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">2</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">CategoricalConversionWarning</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">):</span>
                <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">cats</span><span class="s2">) == </span><span class="s1">values</span><span class="s2">[</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">i </span><span class="s2">: </span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)]</span>
                <span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s4">2</span><span class="s2">:</span>
                    <span class="s1">idx </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">idx </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">3.0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;float64&quot;</span><span class="s2">)</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">block</span><span class="s2">.</span><span class="s1">cats</span><span class="s2">.</span><span class="s1">cat</span><span class="s2">.</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">idx</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">CategoricalConversionWarning</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">dta_file</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s1">large_chunk </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">__next__</span><span class="s2">()</span>
    <span class="s1">direct </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">dta_file</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">direct</span><span class="s2">, </span><span class="s1">large_chunk</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;chunksize&quot;</span><span class="s2">, (-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;apple&quot;</span><span class="s2">))</span>
<span class="s0">def </span><span class="s1">test_iterator_errors</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">):</span>
    <span class="s1">dta_file </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;stata&quot;</span><span class="s2">, </span><span class="s3">&quot;stata-dta-partially-labeled.dta&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;chunksize must be a positive&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">dta_file</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s1">chunksize</span><span class="s2">):</span>
            <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_iterator_value_labels</span><span class="s2">():</span>
    <span class="s5"># GH 31544</span>
    <span class="s1">values </span><span class="s2">= [</span><span class="s3">&quot;c_label&quot;</span><span class="s2">, </span><span class="s3">&quot;b_label&quot;</span><span class="s2">] + [</span><span class="s3">&quot;a_label&quot;</span><span class="s2">] * </span><span class="s4">500</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">f&quot;col</span><span class="s0">{</span><span class="s1">k</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">(</span><span class="s1">values</span><span class="s2">, </span><span class="s1">ordered</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)})</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">&quot;a_label&quot;</span><span class="s2">, </span><span class="s3">&quot;b_label&quot;</span><span class="s2">, </span><span class="s3">&quot;c_label&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;object&quot;</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">100</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">):</span>
                <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">):</span>
                    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">categories</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">, </span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s1">j </span><span class="s2">* </span><span class="s4">100 </span><span class="s2">: (</span><span class="s1">j </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) * </span><span class="s4">100</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_precision_loss</span><span class="s2">():</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s1">sum</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">60</span><span class="s2">)), </span><span class="s1">sum</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">52</span><span class="s2">))]],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;big&quot;</span><span class="s2">, </span><span class="s3">&quot;little&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span>
            <span class="s1">PossiblePrecisionLoss</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Column converted from int64 to float64&quot;</span>
        <span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s1">expected_dt </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;big&quot;</span><span class="s2">, </span><span class="s3">&quot;little&quot;</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">expected_dt</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">reread</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;little&quot;</span><span class="s2">] == </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;little&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">reread</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;big&quot;</span><span class="s2">] == </span><span class="s1">float</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;big&quot;</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_compression_roundtrip</span><span class="s2">(</span><span class="s1">compression</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0.123456</span><span class="s2">, </span><span class="s4">0.234567</span><span class="s2">, </span><span class="s4">0.567567</span><span class="s2">], [</span><span class="s4">12.32112</span><span class="s2">, </span><span class="s4">123123.2</span><span class="s2">, </span><span class="s4">321321.2</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression</span><span class="s2">)</span>
        <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">compression</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>

        <span class="s5"># explicitly ensure file was compressed.</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">decompress_file</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">) </span><span class="s0">as </span><span class="s1">fh</span><span class="s2">:</span>
            <span class="s1">contents </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(</span><span class="s1">fh</span><span class="s2">.</span><span class="s1">read</span><span class="s2">())</span>
        <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">contents</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;to_infer&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;read_infer&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_stata_compression</span><span class="s2">(</span>
    <span class="s1">compression_only</span><span class="s2">, </span><span class="s1">read_infer</span><span class="s2">, </span><span class="s1">to_infer</span><span class="s2">, </span><span class="s1">compression_to_extension</span>
<span class="s2">):</span>
    <span class="s1">compression </span><span class="s2">= </span><span class="s1">compression_only</span>

    <span class="s1">ext </span><span class="s2">= </span><span class="s1">compression_to_extension</span><span class="s2">[</span><span class="s1">compression</span><span class="s2">]</span>
    <span class="s1">filename </span><span class="s2">= </span><span class="s3">f&quot;test.</span><span class="s0">{</span><span class="s1">ext</span><span class="s0">}</span><span class="s3">&quot;</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">0.123456</span><span class="s2">, </span><span class="s4">0.234567</span><span class="s2">, </span><span class="s4">0.567567</span><span class="s2">], [</span><span class="s4">12.32112</span><span class="s2">, </span><span class="s4">123123.2</span><span class="s2">, </span><span class="s4">321321.2</span><span class="s2">]],</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;X&quot;</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>

    <span class="s1">to_compression </span><span class="s2">= </span><span class="s3">&quot;infer&quot; </span><span class="s0">if </span><span class="s1">to_infer </span><span class="s0">else </span><span class="s1">compression</span>
    <span class="s1">read_compression </span><span class="s2">= </span><span class="s3">&quot;infer&quot; </span><span class="s0">if </span><span class="s1">read_infer </span><span class="s0">else </span><span class="s1">compression</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">(</span><span class="s1">filename</span><span class="s2">) </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">to_compression</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">compression</span><span class="s2">=</span><span class="s1">read_compression</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_non_categorical_value_labels</span><span class="s2">():</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;fully_labelled&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s3">&quot;partially_labelled&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">9.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s3">&quot;Y&quot;</span><span class="s2">: [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
            <span class="s3">&quot;Z&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s3">&quot;j&quot;</span><span class="s2">, </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s3">&quot;l&quot;</span><span class="s2">, </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s3">&quot;j&quot;</span><span class="s2">]),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">value_labels </span><span class="s2">= {</span>
            <span class="s3">&quot;fully_labelled&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;two&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">: </span><span class="s3">&quot;three&quot;</span><span class="s2">},</span>
            <span class="s3">&quot;partially_labelled&quot;</span><span class="s2">: {</span><span class="s4">1.0</span><span class="s2">: </span><span class="s3">&quot;one&quot;</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">: </span><span class="s3">&quot;two&quot;</span><span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= {**</span><span class="s1">value_labels</span><span class="s2">, </span><span class="s3">&quot;Z&quot;</span><span class="s2">: {</span><span class="s4">0</span><span class="s2">: </span><span class="s3">&quot;j&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;l&quot;</span><span class="s2">}}</span>

        <span class="s1">writer </span><span class="s2">= </span><span class="s1">StataWriter</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">value_labels</span><span class="s2">=</span><span class="s1">value_labels</span><span class="s2">)</span>
        <span class="s1">writer</span><span class="s2">.</span><span class="s1">write_file</span><span class="s2">()</span>

        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s1">reader_value_labels </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">value_labels</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">reader_value_labels </span><span class="s2">== </span><span class="s1">expected</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Can't create value labels for notY, it wasn't found in the dataset.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">value_labels </span><span class="s2">= {</span><span class="s3">&quot;notY&quot;</span><span class="s2">: {</span><span class="s4">7</span><span class="s2">: </span><span class="s3">&quot;label1&quot;</span><span class="s2">, </span><span class="s4">8</span><span class="s2">: </span><span class="s3">&quot;label2&quot;</span><span class="s2">}}</span>
            <span class="s1">StataWriter</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">value_labels</span><span class="s2">=</span><span class="s1">value_labels</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= (</span>
            <span class="s3">&quot;Can't create value labels for Z, value labels &quot;</span>
            <span class="s3">&quot;can only be applied to numeric columns.&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">value_labels </span><span class="s2">= {</span><span class="s3">&quot;Z&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;k&quot;</span><span class="s2">, </span><span class="s4">3</span><span class="s2">: </span><span class="s3">&quot;j&quot;</span><span class="s2">, </span><span class="s4">4</span><span class="s2">: </span><span class="s3">&quot;i&quot;</span><span class="s2">}}</span>
            <span class="s1">StataWriter</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">value_labels</span><span class="s2">=</span><span class="s1">value_labels</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_non_categorical_value_label_name_conversion</span><span class="s2">():</span>
    <span class="s5"># Check conversion of invalid variable names</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;invalid~!&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],  </span><span class="s5"># Only alphanumeric and _</span>
            <span class="s3">&quot;6_invalid&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],  </span><span class="s5"># Must start with letter or _</span>
            <span class="s3">&quot;invalid_name_longer_than_32_characters&quot;</span><span class="s2">: [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],  </span><span class="s5"># Too long</span>
            <span class="s3">&quot;aggregate&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">9</span><span class="s2">],  </span><span class="s5"># Reserved words</span>
            <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">): [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],  </span><span class="s5"># Hashable non-string</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s1">value_labels </span><span class="s2">= {</span>
        <span class="s3">&quot;invalid~!&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;label1&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;label2&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;6_invalid&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;label1&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;label2&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;invalid_name_longer_than_32_characters&quot;</span><span class="s2">: {</span><span class="s4">8</span><span class="s2">: </span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s4">9</span><span class="s2">: </span><span class="s3">&quot;nine&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;aggregate&quot;</span><span class="s2">: {</span><span class="s4">5</span><span class="s2">: </span><span class="s3">&quot;five&quot;</span><span class="s2">},</span>
        <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">): {</span><span class="s4">3</span><span class="s2">: </span><span class="s3">&quot;three&quot;</span><span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s1">expected </span><span class="s2">= {</span>
        <span class="s3">&quot;invalid__&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;label1&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;label2&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;_6_invalid&quot;</span><span class="s2">: {</span><span class="s4">1</span><span class="s2">: </span><span class="s3">&quot;label1&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">: </span><span class="s3">&quot;label2&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;invalid_name_longer_than_32_char&quot;</span><span class="s2">: {</span><span class="s4">8</span><span class="s2">: </span><span class="s3">&quot;eight&quot;</span><span class="s2">, </span><span class="s4">9</span><span class="s2">: </span><span class="s3">&quot;nine&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;_aggregate&quot;</span><span class="s2">: {</span><span class="s4">5</span><span class="s2">: </span><span class="s3">&quot;five&quot;</span><span class="s2">},</span>
        <span class="s3">&quot;_1__2_&quot;</span><span class="s2">: {</span><span class="s4">3</span><span class="s2">: </span><span class="s3">&quot;three&quot;</span><span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">InvalidColumnName</span><span class="s2">):</span>
            <span class="s1">data</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">value_labels</span><span class="s2">=</span><span class="s1">value_labels</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s1">reader_value_labels </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">value_labels</span><span class="s2">()</span>
            <span class="s0">assert </span><span class="s1">reader_value_labels </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s0">def </span><span class="s1">test_non_categorical_value_label_convert_categoricals_error</span><span class="s2">():</span>
    <span class="s5"># Mapping more than one value to the same label is valid for Stata</span>
    <span class="s5"># labels, but can't be read with convert_categoricals=True</span>
    <span class="s1">value_labels </span><span class="s2">= {</span>
        <span class="s3">&quot;repeated_labels&quot;</span><span class="s2">: {</span><span class="s4">10</span><span class="s2">: </span><span class="s3">&quot;Ten&quot;</span><span class="s2">, </span><span class="s4">20</span><span class="s2">: </span><span class="s3">&quot;More than ten&quot;</span><span class="s2">, </span><span class="s4">40</span><span class="s2">: </span><span class="s3">&quot;More than ten&quot;</span><span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;repeated_labels&quot;</span><span class="s2">: [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span><span class="s2">, </span><span class="s4">40</span><span class="s2">, </span><span class="s4">40</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">data</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">value_labels</span><span class="s2">=</span><span class="s1">value_labels</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">StataReader</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s1">reader</span><span class="s2">:</span>
            <span class="s1">reader_value_labels </span><span class="s2">= </span><span class="s1">reader</span><span class="s2">.</span><span class="s1">value_labels</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">reader_value_labels </span><span class="s2">== </span><span class="s1">value_labels</span>

        <span class="s1">col </span><span class="s2">= </span><span class="s3">&quot;repeated_labels&quot;</span>
        <span class="s1">repeats </span><span class="s2">= </span><span class="s3">&quot;-&quot; </span><span class="s2">* </span><span class="s4">80 </span><span class="s2">+ </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot; </span><span class="s2">+ </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">&quot;More than ten&quot;</span><span class="s2">])</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;</span>
<span class="s3">Value labels for column </span><span class="s0">{</span><span class="s1">col</span><span class="s0">} </span><span class="s3">are not unique. These cannot be converted to</span>
<span class="s3">pandas categoricals.</span>

<span class="s3">Either read the file with `convert_categoricals` set to False or use the</span>
<span class="s3">low level interface in `StataReader` to separately read the values and the</span>
<span class="s3">value_labels.</span>

<span class="s3">The repeated labels are:</span>
<span class="s0">{</span><span class="s1">repeats</span><span class="s0">}</span>
<span class="s3">&quot;&quot;&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_categoricals</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;version&quot;</span><span class="s2">, [</span><span class="s4">114</span><span class="s2">, </span><span class="s4">117</span><span class="s2">, </span><span class="s4">118</span><span class="s2">, </span><span class="s4">119</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">BooleanDtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">Int8Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">Int16Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">Int32Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">Int64Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">UInt8Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">UInt16Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">UInt32Dtype</span><span class="s2">,</span>
        <span class="s1">pd</span><span class="s2">.</span><span class="s1">UInt64Dtype</span><span class="s2">,</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nullable_support</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">version</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]),</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">name</span><span class="s2">),</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">dtype_name </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">numpy_dtype</span><span class="s2">.</span><span class="s1">name</span>
    <span class="s5"># Only use supported names: no uint, bool or int64</span>
    <span class="s1">dtype_name </span><span class="s2">= </span><span class="s1">dtype_name</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s3">&quot;u&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">dtype_name </span><span class="s2">== </span><span class="s3">&quot;int64&quot;</span><span class="s2">:</span>
        <span class="s1">dtype_name </span><span class="s2">= </span><span class="s3">&quot;int32&quot;</span>
    <span class="s0">elif </span><span class="s1">dtype_name </span><span class="s2">== </span><span class="s3">&quot;bool&quot;</span><span class="s2">:</span>
        <span class="s1">dtype_name </span><span class="s2">= </span><span class="s3">&quot;int8&quot;</span>
    <span class="s1">value </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">.</span><span class="s1">BASE_MISSING_VALUES</span><span class="s2">[</span><span class="s1">dtype_name</span><span class="s2">]</span>
    <span class="s1">smv </span><span class="s2">= </span><span class="s1">StataMissingValue</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
    <span class="s1">expected_b </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s1">smv</span><span class="s2">, </span><span class="s1">smv</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>
    <span class="s1">expected_c </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;c&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s1">version</span><span class="s2">)</span>
        <span class="s1">reread </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">convert_missing</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">reread</span><span class="s2">.</span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">expected_b</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">reread</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">expected_c</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_empty_frame</span><span class="s2">():</span>
    <span class="s5"># GH 46240</span>
    <span class="s5"># create an empty DataFrame with int64 and float64 dtypes</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">={</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">), </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">]}).</span><span class="s1">head</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">path</span><span class="s2">:</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">write_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">version</span><span class="s2">=</span><span class="s4">117</span><span class="s2">)</span>
        <span class="s5"># Read entire dataframe</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s3">&quot;b&quot; </span><span class="s0">in </span><span class="s1">df2</span>
        <span class="s5"># Dtypes don't match since no support for int32</span>
        <span class="s1">dtypes </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;int32&quot;</span><span class="s2">), </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">&quot;float64&quot;</span><span class="s2">)})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">df2</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">dtypes</span><span class="s2">)</span>
        <span class="s5"># read one column of empty .dta file</span>
        <span class="s1">df3 </span><span class="s2">= </span><span class="s1">read_stata</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s3">&quot;b&quot; </span><span class="s0">not in </span><span class="s1">df3</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">df3</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">, </span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[[</span><span class="s3">&quot;a&quot;</span><span class="s2">]])</span>
</pre>
</body>
</html>