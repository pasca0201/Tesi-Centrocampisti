<html>
<head>
<title>test_grouping.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_grouping.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
test where we are determining what we are grouping, or getting groups 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">datetime </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">date</span><span class="s3">,</span>
    <span class="s1">timedelta</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">pandas </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">CategoricalIndex</span><span class="s3">,</span>
    <span class="s1">DataFrame</span><span class="s3">,</span>
    <span class="s1">Grouper</span><span class="s3">,</span>
    <span class="s1">Index</span><span class="s3">,</span>
    <span class="s1">MultiIndex</span><span class="s3">,</span>
    <span class="s1">Series</span><span class="s3">,</span>
    <span class="s1">Timestamp</span><span class="s3">,</span>
    <span class="s1">date_range</span><span class="s3">,</span>
    <span class="s1">period_range</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">import </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">as </span><span class="s1">tm</span>
<span class="s2">from </span><span class="s1">pandas</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">.</span><span class="s1">grouper </span><span class="s2">import </span><span class="s1">Grouping</span>

<span class="s4"># selection</span>
<span class="s4"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestSelection</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_select_bad_cols</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;</span><span class="s2">\&quot;</span><span class="s6">Columns not found: 'C'</span><span class="s2">\&quot;</span><span class="s6">&quot;</span><span class="s3">):</span>
            <span class="s1">g</span><span class="s3">[[</span><span class="s6">&quot;C&quot;</span><span class="s3">]]</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;^[^A]+$&quot;</span><span class="s3">):</span>
            <span class="s4"># A should not be referenced as a bad column...</span>
            <span class="s4"># will have to rethink regex if you change message!</span>
            <span class="s1">g</span><span class="s3">[[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">]]</span>

    <span class="s2">def </span><span class="s1">test_groupby_duplicated_column_errormsg</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH7511</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">], </span><span class="s1">data</span><span class="s3">=[</span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">), </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">6</span><span class="s3">), </span><span class="s1">range</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]</span>
        <span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Grouper for 'A' not 1-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">])</span>

        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;B&quot;</span><span class="s3">)</span>
        <span class="s1">c </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">count</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">c</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">nlevels </span><span class="s3">== </span><span class="s5">1</span>
        <span class="s2">assert </span><span class="s1">c</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">size </span><span class="s3">== </span><span class="s5">3</span>

    <span class="s2">def </span><span class="s1">test_column_select_via_attr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">).</span><span class="s1">C</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[</span><span class="s6">&quot;C&quot;</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;mean&quot;</span><span class="s3">] = </span><span class="s5">1.5</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[[</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s6">&quot;D&quot;</span><span class="s3">, </span><span class="s6">&quot;mean&quot;</span><span class="s3">]].</span><span class="s1">agg</span><span class="s3">(</span><span class="s6">&quot;mean&quot;</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_getitem_list_of_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">],</span>
                <span class="s6">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;three&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;three&quot;</span><span class="s3">],</span>
                <span class="s6">&quot;C&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
                <span class="s6">&quot;D&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
                <span class="s6">&quot;E&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[[</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s6">&quot;D&quot;</span><span class="s3">]].</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">result2 </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">2</span><span class="s3">:</span><span class="s5">4</span><span class="s3">]].</span><span class="s1">mean</span><span class="s3">()</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[:, [</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s6">&quot;D&quot;</span><span class="s3">]].</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_getitem_numeric_column_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH #13731</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s5">0</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;abcd&quot;</span><span class="s3">) * </span><span class="s5">2</span><span class="s3">,</span>
                <span class="s5">2</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
                <span class="s5">4</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
                <span class="s5">6</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)[</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">3</span><span class="s3">]].</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">result2 </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)[[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]].</span><span class="s1">mean</span><span class="s3">()</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[:, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]].</span><span class="s1">groupby</span><span class="s3">(</span><span class="s5">0</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result2</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># per GH 23566 enforced deprecation raises a ValueError</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Cannot subset columns with a tuple&quot;</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_getitem_single_tuple_of_columns_raises</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s4"># per GH 23566 enforced deprecation raises a ValueError</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Cannot subset columns with a tuple&quot;</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s6">&quot;D&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_getitem_single_column</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;A&quot;</span><span class="s3">: [</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">],</span>
                <span class="s6">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;three&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;three&quot;</span><span class="s3">],</span>
                <span class="s6">&quot;C&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
                <span class="s6">&quot;D&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
                <span class="s6">&quot;E&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">8</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[</span><span class="s6">&quot;C&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>

        <span class="s1">as_frame </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[:, [</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">]].</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">as_series </span><span class="s3">= </span><span class="s1">as_frame</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[:, </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">as_series</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s6">&quot;func&quot;</span><span class="s3">, [</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(), </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">agg</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">y</span><span class="s3">: </span><span class="s1">y</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">())]</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_getitem_from_grouper</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">):</span>
        <span class="s4"># GH 50383</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;b&quot;</span><span class="s3">: </span><span class="s5">3</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">: </span><span class="s5">4</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">: </span><span class="s5">5</span><span class="s3">})</span>
        <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">])[[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">]]</span>

        <span class="s1">idx </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">([(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)], </span><span class="s1">names</span><span class="s3">=[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">])</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;c&quot;</span><span class="s3">: [</span><span class="s5">8</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]}, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">func</span><span class="s3">(</span><span class="s1">gb</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_indices_grouped_by_tuple_with_lambda</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 36158</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;Tuples&quot;</span><span class="s3">: (</span>
                    <span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
                    <span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;Tuples&quot;</span><span class="s3">)</span>
        <span class="s1">gb_lambda </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s1">x</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">indices</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gb_lambda</span><span class="s3">.</span><span class="s1">indices</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s4"># grouping</span>
<span class="s4"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestGrouping</span><span class="s3">:</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s6">&quot;index&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s1">Index</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;abcde&quot;</span><span class="s3">)),</span>
            <span class="s1">Index</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">)),</span>
            <span class="s1">Index</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)),</span>
            <span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;2020-01-01&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">5</span><span class="s3">),</span>
            <span class="s1">period_range</span><span class="s3">(</span><span class="s6">&quot;2020-01-01&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">5</span><span class="s3">),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_grouper_index_types</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">index</span><span class="s3">):</span>
        <span class="s4"># related GH5375</span>
        <span class="s4"># groupby misbehaving when using a Floatlike index</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">10</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;AB&quot;</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">)</span>

        <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;abcde&quot;</span><span class="s3">), </span><span class="s1">group_keys</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">df</span><span class="s3">.</span><span class="s1">index </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">[::-</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;abcde&quot;</span><span class="s3">), </span><span class="s1">group_keys</span><span class="s3">=</span><span class="s2">False</span><span class="s3">).</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_multilevel_freq</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 7885</span>
        <span class="s4"># with level and freq specified in a Grouper</span>
        <span class="s1">d0 </span><span class="s3">= </span><span class="s1">date</span><span class="s3">.</span><span class="s1">today</span><span class="s3">() - </span><span class="s1">timedelta</span><span class="s3">(</span><span class="s1">days</span><span class="s3">=</span><span class="s5">14</span><span class="s3">)</span>
        <span class="s1">dates </span><span class="s3">= </span><span class="s1">date_range</span><span class="s3">(</span><span class="s1">d0</span><span class="s3">, </span><span class="s1">date</span><span class="s3">.</span><span class="s1">today</span><span class="s3">())</span>
        <span class="s1">date_index </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_product</span><span class="s3">([</span><span class="s1">dates</span><span class="s3">, </span><span class="s1">dates</span><span class="s3">], </span><span class="s1">names</span><span class="s3">=[</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">100</span><span class="s3">, </span><span class="s5">225</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s1">date_index</span><span class="s3">)</span>

        <span class="s4"># Check string level</span>
        <span class="s1">expected </span><span class="s3">= (</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">()</span>
            <span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;W&quot;</span><span class="s3">), </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;W&quot;</span><span class="s3">)])</span>
            <span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s3">)</span>
        <span class="s4"># reset index changes columns dtype to object</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= </span><span class="s1">Index</span><span class="s3">([</span><span class="s5">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;int64&quot;</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;W&quot;</span><span class="s3">), </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;W&quot;</span><span class="s3">)]</span>
        <span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Check integer level</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;W&quot;</span><span class="s3">), </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;W&quot;</span><span class="s3">)]</span>
        <span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_creation_bug</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 8795</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;B&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]})</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>

        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;A&quot;</span><span class="s3">))</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Grouper axis keyword is deprecated and will be removed&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">gpr </span><span class="s3">= </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">gpr</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;DataFrameGroupBy.apply operated on the grouping columns&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">DeprecationWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">apply</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">())</span>
        <span class="s1">expected</span><span class="s3">[</span><span class="s6">&quot;A&quot;</span><span class="s3">] = [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">4</span><span class="s3">]</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[:, [</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]]</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_creation_bug2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH14334</span>
        <span class="s4"># Grouper(key=...) may be passed in a list</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s6">&quot;B&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s6">&quot;C&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">]}</span>
        <span class="s3">)</span>
        <span class="s4"># Group by single column</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;A&quot;</span><span class="s3">)])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Group by two columns</span>
        <span class="s4"># using a combination of strings and Grouper objects</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]).</span><span class="s1">sum</span><span class="s3">()</span>

        <span class="s4"># Group with two Grouper objects</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;A&quot;</span><span class="s3">), </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;B&quot;</span><span class="s3">)])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Group with a string and a Grouper object</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;B&quot;</span><span class="s3">)])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Group with a Grouper object and a string</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;A&quot;</span><span class="s3">), </span><span class="s6">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_creation_bug3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">unit</span><span class="s3">):</span>
        <span class="s4"># GH8866</span>
        <span class="s1">dti </span><span class="s3">= </span><span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">unit</span><span class="s3">=</span><span class="s1">unit</span><span class="s3">)</span>
        <span class="s1">mi </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_product</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;ab&quot;</span><span class="s3">), </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">), </span><span class="s1">dti</span><span class="s3">],</span>
            <span class="s1">names</span><span class="s3">=[</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;three&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s1">ser </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span>
            <span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;int64&quot;</span><span class="s3">),</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">mi</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">ser</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;three&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">)).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">exp_dti </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DatetimeIndex</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-01-31&quot;</span><span class="s3">)], </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s6">&quot;three&quot;</span>
        <span class="s3">).</span><span class="s1">as_unit</span><span class="s3">(</span><span class="s1">unit</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s5">28</span><span class="s3">],</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">exp_dti</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># just specifying a level breaks</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">ser</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;one&quot;</span><span class="s3">)).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">ser</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;one&quot;</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;func&quot;</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_grouper_returning_tuples</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">):</span>
        <span class="s4"># GH 22257 , both with dict and with callable</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;X&quot;</span><span class="s3">: [</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">], </span><span class="s6">&quot;Y&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]})</span>
        <span class="s1">mapping </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">zip</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">), [(</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s5">5</span><span class="s3">), (</span><span class="s6">&quot;D&quot;</span><span class="s3">, </span><span class="s5">6</span><span class="s3">)] * </span><span class="s5">2</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">func</span><span class="s3">:</span>
            <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">by</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">idx</span><span class="s3">: </span><span class="s1">mapping</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">], </span><span class="s1">sort</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">by</span><span class="s3">=</span><span class="s1">mapping</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

        <span class="s1">name</span><span class="s3">, </span><span class="s1">expected </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">gb</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">name </span><span class="s3">== (</span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_column_and_index</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 14327</span>

        <span class="s4"># Grouping a multi-index frame by a column and an index level should</span>
        <span class="s4"># be equivalent to resetting the index and grouping by two columns</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">(</span>
            <span class="s3">[(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)]</span>
        <span class="s3">)</span>
        <span class="s1">idx</span><span class="s3">.</span><span class="s1">names </span><span class="s3">= [</span><span class="s6">&quot;outer&quot;</span><span class="s3">, </span><span class="s6">&quot;inner&quot;</span><span class="s3">]</span>
        <span class="s1">df_multi </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;A&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">6</span><span class="s3">), </span><span class="s6">&quot;B&quot;</span><span class="s3">: [</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">]},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df_multi</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;inner&quot;</span><span class="s3">)]).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= (</span>
            <span class="s1">df_multi</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">().</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;inner&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Test the reverse grouping order</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df_multi</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;inner&quot;</span><span class="s3">), </span><span class="s6">&quot;B&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= (</span>
            <span class="s1">df_multi</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">().</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;inner&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Grouping a single-index frame by a column and the index should</span>
        <span class="s4"># be equivalent to resetting the index and grouping by two columns</span>
        <span class="s1">df_single </span><span class="s3">= </span><span class="s1">df_multi</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">(</span><span class="s6">&quot;outer&quot;</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df_single</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;inner&quot;</span><span class="s3">)]).</span><span class="s1">mean</span><span class="s3">(</span>
            <span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= (</span>
            <span class="s1">df_single</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">().</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;inner&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Test the reverse grouping order</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df_single</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;inner&quot;</span><span class="s3">), </span><span class="s6">&quot;B&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(</span>
            <span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= (</span>
            <span class="s1">df_single</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">().</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;inner&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_levels_and_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH9344, GH9049</span>
        <span class="s1">idx_names </span><span class="s3">= [</span><span class="s6">&quot;x&quot;</span><span class="s3">, </span><span class="s6">&quot;y&quot;</span><span class="s3">]</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">([(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), (</span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">)], </span><span class="s1">names</span><span class="s3">=</span><span class="s1">idx_names</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">12</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s1">idx</span><span class="s3">)</span>

        <span class="s1">by_levels </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s1">idx_names</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s4"># reset_index changes columns dtype to object</span>
        <span class="s1">by_columns </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">().</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">idx_names</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>

        <span class="s4"># without casting, by_columns.columns is object-dtype</span>
        <span class="s1">by_columns</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= </span><span class="s1">by_columns</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">by_levels</span><span class="s3">, </span><span class="s1">by_columns</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_categorical_index_and_columns</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">observed</span><span class="s3">):</span>
        <span class="s4"># GH18432, adapted for GH25871</span>
        <span class="s1">columns </span><span class="s3">= [</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]</span>
        <span class="s1">categories </span><span class="s3">= [</span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">]</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">int</span>
        <span class="s3">)</span>
        <span class="s1">cat_columns </span><span class="s3">= </span><span class="s1">CategoricalIndex</span><span class="s3">(</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">categories</span><span class="s3">=</span><span class="s1">categories</span><span class="s3">, </span><span class="s1">ordered</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">=</span><span class="s1">data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">cat_columns</span><span class="s3">)</span>
        <span class="s1">depr_msg </span><span class="s3">= </span><span class="s6">&quot;DataFrame.groupby with axis=1 is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">depr_msg</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">observed</span><span class="s3">=</span><span class="s1">observed</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected_data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]], </span><span class="s1">int</span><span class="s3">)</span>
        <span class="s1">expected_columns </span><span class="s3">= </span><span class="s1">CategoricalIndex</span><span class="s3">(</span>
            <span class="s1">categories</span><span class="s3">, </span><span class="s1">categories</span><span class="s3">=</span><span class="s1">categories</span><span class="s3">, </span><span class="s1">ordered</span><span class="s3">=</span><span class="s2">True</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">=</span><span class="s1">expected_data</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">expected_columns</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># test transposed version</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">cat_columns</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;The 'axis' keyword in DataFrame.groupby is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">observed</span><span class="s3">=</span><span class="s1">observed</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">data</span><span class="s3">=</span><span class="s1">expected_data</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">expected_columns</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_getting_correct_binner</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 10063</span>
        <span class="s4"># using a non-time-based grouper and a time-based grouper</span>
        <span class="s4"># and specifying levels</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;A&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_product</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;ab&quot;</span><span class="s3">), </span><span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">80</span><span class="s3">)], </span><span class="s1">names</span><span class="s3">=[</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">]</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span>
            <span class="s3">[</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;one&quot;</span><span class="s3">), </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">)]</span>
        <span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;A&quot;</span><span class="s3">: [</span><span class="s5">31</span><span class="s3">, </span><span class="s5">28</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">31</span><span class="s3">, </span><span class="s5">28</span><span class="s3">, </span><span class="s5">21</span><span class="s3">]},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_product</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;ab&quot;</span><span class="s3">), </span><span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;20130101&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)],</span>
                <span class="s1">names</span><span class="s3">=[</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">],</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouper_iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;DataFrameGroupBy.grouper is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">grouper </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">grouper</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">grouper</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= [</span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected</span>

    <span class="s2">def </span><span class="s1">test_empty_groups</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s4"># see gh-1048</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;No group keys passed!&quot;</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([])</span>

    <span class="s2">def </span><span class="s1">test_groupby_grouper</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;DataFrameGroupBy.grouper is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">grouper </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">grouper</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">grouper</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">numeric_only</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_dict_mapping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH #679</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">({</span><span class="s6">&quot;T1&quot;</span><span class="s3">: </span><span class="s5">5</span><span class="s3">})</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">({</span><span class="s6">&quot;T1&quot;</span><span class="s3">: </span><span class="s6">&quot;T2&quot;</span><span class="s3">}).</span><span class="s1">agg</span><span class="s3">(</span><span class="s6">&quot;sum&quot;</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;T2&quot;</span><span class="s3">]).</span><span class="s1">agg</span><span class="s3">(</span><span class="s6">&quot;sum&quot;</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">3.0</span><span class="s3">, </span><span class="s5">4.0</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;abcd&quot;</span><span class="s3">))</span>
        <span class="s1">mapping </span><span class="s3">= {</span><span class="s6">&quot;a&quot;</span><span class="s3">: </span><span class="s5">0</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">: </span><span class="s5">0</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">}</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">mapping</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">result2 </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">mapping</span><span class="s3">).</span><span class="s1">agg</span><span class="s3">(</span><span class="s6">&quot;mean&quot;</span><span class="s3">)</span>
        <span class="s1">exp_key </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">exp_key</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">expected2 </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">exp_key</span><span class="s3">).</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">result2</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s6">&quot;index&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s5">2021</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">28 </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)],</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_groupby_series_named_with_tuple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">frame_or_series</span><span class="s3">, </span><span class="s1">index</span><span class="s3">):</span>
        <span class="s4"># GH 42731</span>
        <span class="s1">obj </span><span class="s3">= </span><span class="s1">frame_or_series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">groups </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">))</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">obj</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">groups</span><span class="s3">).</span><span class="s1">last</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">frame_or_series</span><span class="s3">([</span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= (</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_grouper_f_sanity_checked</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">dates </span><span class="s3">= </span><span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;01-Jan-2013&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">12</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;MS&quot;</span><span class="s3">)</span>
        <span class="s1">ts </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">12</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s1">dates</span><span class="s3">)</span>

        <span class="s4"># GH51979</span>
        <span class="s4"># simple check that the passed function doesn't operates on the whole index</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;'Timestamp' object is not subscriptable&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">ts</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">key</span><span class="s3">: </span><span class="s1">key</span><span class="s3">[</span><span class="s5">0</span><span class="s3">:</span><span class="s5">6</span><span class="s3">])</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">ts</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">ts</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">ts</span><span class="s3">.</span><span class="s1">index</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">freq </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_datetime_key</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 51158</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;id&quot;</span><span class="s3">: [</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">] * </span><span class="s5">3</span><span class="s3">,</span>
                <span class="s6">&quot;b&quot;</span><span class="s3">: </span><span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;2000-01-01&quot;</span><span class="s3">, </span><span class="s6">&quot;2000-01-03&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;9h&quot;</span><span class="s3">),</span>
            <span class="s3">}</span>
        <span class="s3">)</span>
        <span class="s1">grouper </span><span class="s3">= </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;D&quot;</span><span class="s3">)</span>
        <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">grouper</span><span class="s3">, </span><span class="s6">&quot;id&quot;</span><span class="s3">])</span>

        <span class="s4"># test number of groups</span>
        <span class="s1">expected </span><span class="s3">= {</span>
            <span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2000-01-01&quot;</span><span class="s3">), </span><span class="s6">&quot;a&quot;</span><span class="s3">): [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">],</span>
            <span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2000-01-01&quot;</span><span class="s3">), </span><span class="s6">&quot;b&quot;</span><span class="s3">): [</span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2000-01-02&quot;</span><span class="s3">), </span><span class="s6">&quot;a&quot;</span><span class="s3">): [</span><span class="s5">4</span><span class="s3">],</span>
            <span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2000-01-02&quot;</span><span class="s3">), </span><span class="s6">&quot;b&quot;</span><span class="s3">): [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">],</span>
        <span class="s3">}</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">gb</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># test number of group keys</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">gb</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()) == </span><span class="s5">4</span>

    <span class="s2">def </span><span class="s1">test_grouping_error_on_multidim_input</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Grouper for '&lt;class 'pandas.core.frame.DataFrame'&gt;' not 1-dimensional&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">Grouping</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span><span class="s3">, </span><span class="s1">df</span><span class="s3">[[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">]])</span>

    <span class="s2">def </span><span class="s1">test_multiindex_passthru</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 7997</span>
        <span class="s4"># regression from 0.14.1</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">8</span><span class="s3">, </span><span class="s5">9</span><span class="s3">]])</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">([(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])</span>

        <span class="s1">depr_msg </span><span class="s3">= </span><span class="s6">&quot;DataFrame.groupby with axis=1 is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">depr_msg</span><span class="s3">):</span>
            <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">level</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">first</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">df</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_multiindex_negative_level</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">):</span>
        <span class="s4"># GH 13901</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=-</span><span class="s5">1</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;second&quot;</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=-</span><span class="s5">2</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;first&quot;</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=[-</span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">]).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">sort_index</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=[-</span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;first&quot;</span><span class="s3">]).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span>
            <span class="s1">level</span><span class="s3">=[</span><span class="s6">&quot;second&quot;</span><span class="s3">, </span><span class="s6">&quot;first&quot;</span><span class="s3">]</span>
        <span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_multifunc_select_col_integer_cols</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">columns </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">columns</span><span class="s3">))</span>

        <span class="s4"># it works!</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Passing a dictionary to SeriesGroupBy.agg is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">as_index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)[</span><span class="s5">2</span><span class="s3">].</span><span class="s1">agg</span><span class="s3">({</span><span class="s6">&quot;Q&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">})</span>

    <span class="s2">def </span><span class="s1">test_multiindex_columns_empty_level</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">lst </span><span class="s3">= [[</span><span class="s6">&quot;count&quot;</span><span class="s3">, </span><span class="s6">&quot;values&quot;</span><span class="s3">], [</span><span class="s6">&quot;to filter&quot;</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">]]</span>
        <span class="s1">midx </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_tuples</span><span class="s3">(</span><span class="s1">lst</span><span class="s3">)</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">midx</span><span class="s3">)</span>

        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;to filter&quot;</span><span class="s3">).</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s1">grouped</span><span class="s3">[</span><span class="s6">&quot;A&quot;</span><span class="s3">] == [</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;to filter&quot;</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">)]).</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s1">grouped</span><span class="s3">[</span><span class="s6">&quot;A&quot;</span><span class="s3">] == [</span><span class="s5">0</span><span class="s3">]</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">midx</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;to filter&quot;</span><span class="s3">).</span><span class="s1">groups</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;to filter&quot;</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">)]).</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">midx</span><span class="s3">)</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;to filter&quot;</span><span class="s3">).</span><span class="s1">groups</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;to filter&quot;</span><span class="s3">, </span><span class="s6">&quot;&quot;</span><span class="s3">)]).</span><span class="s1">groups</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_multiindex_tuple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 17979</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
            <span class="s1">columns</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_arrays</span><span class="s3">([[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]),</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)]).</span><span class="s1">groups</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">((</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)).</span><span class="s1">groups</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

        <span class="s1">df2 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">values</span><span class="s3">,</span>
            <span class="s1">columns</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_arrays</span><span class="s3">(</span>
                <span class="s3">[[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">], [</span><span class="s6">&quot;d&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">, </span><span class="s6">&quot;e&quot;</span><span class="s3">, </span><span class="s6">&quot;e&quot;</span><span class="s3">]]</span>
            <span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df2</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">)]).</span><span class="s1">groups</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">((</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)).</span><span class="s1">groups</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

        <span class="s1">df3 </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">values</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=[(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;e&quot;</span><span class="s3">), </span><span class="s6">&quot;c&quot;</span><span class="s3">])</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">df3</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;d&quot;</span><span class="s3">)]).</span><span class="s1">groups</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">((</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)).</span><span class="s1">groups</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">result</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_multiindex_partial_indexing_equivalence</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 17977</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
            <span class="s1">columns</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_arrays</span><span class="s3">([[</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;c&quot;</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]),</span>
        <span class="s3">)</span>

        <span class="s1">expected_mean </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[[(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]].</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">result_mean </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[</span><span class="s6">&quot;b&quot;</span><span class="s3">].</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected_mean</span><span class="s3">, </span><span class="s1">result_mean</span><span class="s3">)</span>

        <span class="s1">expected_sum </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[[(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]].</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">result_sum </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[</span><span class="s6">&quot;b&quot;</span><span class="s3">].</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected_sum</span><span class="s3">, </span><span class="s1">result_sum</span><span class="s3">)</span>

        <span class="s1">expected_count </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[[(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]].</span><span class="s1">count</span><span class="s3">()</span>
        <span class="s1">result_count </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[</span><span class="s6">&quot;b&quot;</span><span class="s3">].</span><span class="s1">count</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected_count</span><span class="s3">, </span><span class="s1">result_count</span><span class="s3">)</span>

        <span class="s1">expected_min </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[[(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]].</span><span class="s1">min</span><span class="s3">()</span>
        <span class="s1">result_min </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[</span><span class="s6">&quot;b&quot;</span><span class="s3">].</span><span class="s1">min</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected_min</span><span class="s3">, </span><span class="s1">result_min</span><span class="s3">)</span>

        <span class="s1">expected_max </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[[(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]].</span><span class="s1">max</span><span class="s3">()</span>
        <span class="s1">result_max </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[</span><span class="s6">&quot;b&quot;</span><span class="s3">].</span><span class="s1">max</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">expected_max</span><span class="s3">, </span><span class="s1">result_max</span><span class="s3">)</span>

        <span class="s1">expected_groups </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[[(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), (</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]].</span><span class="s1">groups</span>
        <span class="s1">result_groups </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)])[</span><span class="s6">&quot;b&quot;</span><span class="s3">].</span><span class="s1">groups</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">expected_groups</span><span class="s3">, </span><span class="s1">result_groups</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;sort&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_groupby_level</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">, </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s4"># GH 17537</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span>
        <span class="s1">deleveled </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">reset_index</span><span class="s3">()</span>

        <span class="s1">result0 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">result1 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>

        <span class="s1">expected0 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">deleveled</span><span class="s3">[</span><span class="s6">&quot;first&quot;</span><span class="s3">].</span><span class="s1">values</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected1 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">deleveled</span><span class="s3">[</span><span class="s6">&quot;second&quot;</span><span class="s3">].</span><span class="s1">values</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>

        <span class="s1">expected0</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s6">&quot;first&quot;</span>
        <span class="s1">expected1</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s6">&quot;second&quot;</span>

        <span class="s2">assert </span><span class="s1">result0</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s6">&quot;first&quot;</span>
        <span class="s2">assert </span><span class="s1">result1</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s6">&quot;second&quot;</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result0</span><span class="s3">, </span><span class="s1">expected0</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">expected1</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">result0</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">result1</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">names</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]</span>

        <span class="s4"># groupby level name</span>
        <span class="s1">result0 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;first&quot;</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">result1 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;second&quot;</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result0</span><span class="s3">, </span><span class="s1">expected0</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">expected1</span><span class="s3">)</span>

        <span class="s4"># axis=1</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;DataFrame.groupby with axis=1 is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">result0 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
            <span class="s1">result1 </span><span class="s3">= </span><span class="s1">frame</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result0</span><span class="s3">, </span><span class="s1">expected0</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">expected1</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s4"># raise exception for non-MultiIndex</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;level &gt; 0 or level &lt; -1 only valid with MultiIndex&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_level_index_names</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">):</span>
        <span class="s4"># GH4014 this used to raise ValueError since 'exp'&gt;1 (in py2)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;exp&quot;</span><span class="s3">: [</span><span class="s6">&quot;A&quot;</span><span class="s3">] * </span><span class="s5">3 </span><span class="s3">+ [</span><span class="s6">&quot;B&quot;</span><span class="s3">] * </span><span class="s5">3</span><span class="s3">, </span><span class="s6">&quot;var1&quot;</span><span class="s3">: </span><span class="s1">range</span><span class="s3">(</span><span class="s5">6</span><span class="s3">)}).</span><span class="s1">set_index</span><span class="s3">(</span>
            <span class="s6">&quot;exp&quot;</span>
        <span class="s3">)</span>
        <span class="s2">if </span><span class="s1">axis </span><span class="s2">in </span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s6">&quot;columns&quot;</span><span class="s3">):</span>
            <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">T</span>
            <span class="s1">depr_msg </span><span class="s3">= </span><span class="s6">&quot;DataFrame.groupby with axis=1 is deprecated&quot;</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">depr_msg </span><span class="s3">= </span><span class="s6">&quot;The 'axis' keyword in DataFrame.groupby is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">depr_msg</span><span class="s3">):</span>
            <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;exp&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;level name foo is not the name of the </span><span class="s2">{</span><span class="s1">df</span><span class="s3">.</span><span class="s1">_get_axis_name</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">)</span><span class="s2">}</span><span class="s6">&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">depr_msg</span><span class="s3">):</span>
                <span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;sort&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_groupby_level_with_nas</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">):</span>
        <span class="s4"># GH 17537</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">(</span>
            <span class="s1">levels</span><span class="s3">=[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
            <span class="s1">codes</span><span class="s3">=[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
        <span class="s3">)</span>

        <span class="s4"># factorizing doesn't confuse things</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">8.0</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">6.0</span><span class="s3">, </span><span class="s5">22.0</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">index </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">(</span>
            <span class="s1">levels</span><span class="s3">=[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
            <span class="s1">codes</span><span class="s3">=[[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
        <span class="s3">)</span>

        <span class="s4"># factorizing doesn't confuse things</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">8.0</span><span class="s3">), </span><span class="s1">index</span><span class="s3">=</span><span class="s1">index</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">([</span><span class="s5">6.0</span><span class="s3">, </span><span class="s5">18.0</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">):</span>
        <span class="s4"># PR8618 and issue 8015</span>
        <span class="s1">frame </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;You have to supply one of 'by' and 'level'&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">()</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;You have to supply one of 'by' and 'level'&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">frame</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">by</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">level</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s6">&quot;sort,labels&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s2">True</span><span class="s3">, [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
            <span class="s3">[</span><span class="s2">False</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_level_preserve_order</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">, </span><span class="s1">labels</span><span class="s3">, </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">):</span>
        <span class="s4"># GH 17537</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">sort</span><span class="s3">=</span><span class="s1">sort</span><span class="s3">)</span>
        <span class="s1">exp_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">labels</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">codes</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">exp_labels</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_grouping_labels</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">):</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span>
            <span class="s1">multiindex_dataframe_random_data</span><span class="s3">.</span><span class="s1">index</span><span class="s3">.</span><span class="s1">get_level_values</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">exp_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">codes</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">exp_labels</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_list_grouper_with_nat</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 14715</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;date&quot;</span><span class="s3">: </span><span class="s1">date_range</span><span class="s3">(</span><span class="s6">&quot;1/1/2011&quot;</span><span class="s3">, </span><span class="s1">periods</span><span class="s3">=</span><span class="s5">365</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;D&quot;</span><span class="s3">)})</span>
        <span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">NaT</span>
        <span class="s1">grouper </span><span class="s3">= </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;date&quot;</span><span class="s3">, </span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;YS&quot;</span><span class="s3">)</span>

        <span class="s4"># Grouper in a list grouping</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">grouper</span><span class="s3">])</span>
        <span class="s1">expected </span><span class="s3">= {</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2011-01-01&quot;</span><span class="s3">): </span><span class="s1">Index</span><span class="s3">(</span><span class="s1">list</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s5">364</span><span class="s3">)))}</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># Test case without a list</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">grouper</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= {</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2011-01-01&quot;</span><span class="s3">): </span><span class="s5">365</span><span class="s3">}</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_dict_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
        <span class="s6">&quot;func,expected&quot;</span><span class="s3">,</span>
        <span class="s3">[</span>
            <span class="s3">(</span>
                <span class="s6">&quot;transform&quot;</span><span class="s3">,</span>
                <span class="s1">Series</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s6">&quot;agg&quot;</span><span class="s3">,</span>
                <span class="s1">Series</span><span class="s3">(</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">Index</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
                <span class="s3">),</span>
            <span class="s3">),</span>
            <span class="s3">(</span>
                <span class="s6">&quot;apply&quot;</span><span class="s3">,</span>
                <span class="s1">Series</span><span class="s3">(</span>
                    <span class="s1">name</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">index</span><span class="s3">=</span><span class="s1">Index</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
                <span class="s3">),</span>
            <span class="s3">),</span>
        <span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_evaluate_with_empty_groups</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
        <span class="s4"># 26208</span>
        <span class="s4"># test transform'ing empty groups</span>
        <span class="s4"># (not testing other agg fns, because they return</span>
        <span class="s4"># different index objects.</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s5">1</span><span class="s3">: [], </span><span class="s5">2</span><span class="s3">: []})</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s1">group_keys</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">g</span><span class="s3">[</span><span class="s5">2</span><span class="s3">], </span><span class="s1">func</span><span class="s3">)(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/27190</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">([], </span><span class="s1">name</span><span class="s3">=</span><span class="s6">&quot;name&quot;</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;float64&quot;</span><span class="s3">)</span>
        <span class="s1">gr </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([])</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">gr</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">set_axis</span><span class="s3">(</span><span class="s1">Index</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s4"># check group properties</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">gr</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">groupings</span><span class="s3">) == </span><span class="s5">1</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_numpy_array_equal</span><span class="s3">(</span>
            <span class="s1">gr</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">group_info</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">))</span>
        <span class="s3">)</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_numpy_array_equal</span><span class="s3">(</span>
            <span class="s1">gr</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">group_info</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">))</span>
        <span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">gr</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">group_info</span><span class="s3">[</span><span class="s5">2</span><span class="s3">] == </span><span class="s5">0</span>

        <span class="s4"># check name</span>
        <span class="s1">gb </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;SeriesGroupBy.grouper is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">grouper </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">grouper</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">grouper</span><span class="s3">.</span><span class="s1">names</span>
        <span class="s1">expected </span><span class="s3">= [</span><span class="s6">&quot;name&quot;</span><span class="s3">]</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected</span>

    <span class="s2">def </span><span class="s1">test_groupby_level_index_value_all_na</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># issue 20519</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s6">&quot;x&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">10</span><span class="s3">], [</span><span class="s2">None</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s5">20</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">]</span>
        <span class="s3">).</span><span class="s1">set_index</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">]).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">data</span><span class="s3">=[],</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">MultiIndex</span><span class="s3">(</span>
                <span class="s1">levels</span><span class="s3">=[</span><span class="s1">Index</span><span class="s3">([</span><span class="s6">&quot;x&quot;</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;object&quot;</span><span class="s3">), </span><span class="s1">Index</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;float64&quot;</span><span class="s3">)],</span>
                <span class="s1">codes</span><span class="s3">=[[], []],</span>
                <span class="s1">names</span><span class="s3">=[</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">],</span>
            <span class="s3">),</span>
            <span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;C&quot;</span><span class="s3">],</span>
            <span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;int64&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_multiindex_level_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/31670</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s5">123</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">], [</span><span class="s5">123</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;id&quot;</span><span class="s3">, </span><span class="s6">&quot;category&quot;</span><span class="s3">, </span><span class="s6">&quot;value&quot;</span><span class="s3">]</span>
        <span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">set_index</span><span class="s3">([</span><span class="s6">&quot;id&quot;</span><span class="s3">, </span><span class="s6">&quot;category&quot;</span><span class="s3">])</span>
        <span class="s1">empty </span><span class="s3">= </span><span class="s1">df</span><span class="s3">[</span><span class="s1">df</span><span class="s3">.</span><span class="s1">value </span><span class="s3">&lt; </span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">empty</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;id&quot;</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s1">dtype</span><span class="s3">=</span><span class="s6">&quot;float64&quot;</span><span class="s3">,</span>
            <span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;value&quot;</span><span class="s3">],</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">Index</span><span class="s3">([], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">, </span><span class="s1">name</span><span class="s3">=</span><span class="s6">&quot;id&quot;</span><span class="s3">),</span>
        <span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s4"># get_group</span>
<span class="s4"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestGetGroup</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_get_group</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 5267</span>
        <span class="s4"># be datelike friendly</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;DATE&quot;</span><span class="s3">: </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">to_datetime</span><span class="s3">(</span>
                    <span class="s3">[</span>
                        <span class="s6">&quot;10-Oct-2013&quot;</span><span class="s3">,</span>
                        <span class="s6">&quot;10-Oct-2013&quot;</span><span class="s3">,</span>
                        <span class="s6">&quot;10-Oct-2013&quot;</span><span class="s3">,</span>
                        <span class="s6">&quot;11-Oct-2013&quot;</span><span class="s3">,</span>
                        <span class="s6">&quot;11-Oct-2013&quot;</span><span class="s3">,</span>
                        <span class="s6">&quot;11-Oct-2013&quot;</span><span class="s3">,</span>
                    <span class="s3">]</span>
                <span class="s3">),</span>
                <span class="s6">&quot;label&quot;</span><span class="s3">: [</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">],</span>
                <span class="s6">&quot;VAL&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">6</span><span class="s3">],</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;DATE&quot;</span><span class="s3">)</span>
        <span class="s1">key </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">g</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">))</span>
        <span class="s1">result1 </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s1">result2 </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s1">key</span><span class="s3">).</span><span class="s1">to_pydatetime</span><span class="s3">())</span>
        <span class="s1">result3 </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">result2</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">result3</span><span class="s3">)</span>

        <span class="s1">g </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;DATE&quot;</span><span class="s3">, </span><span class="s6">&quot;label&quot;</span><span class="s3">])</span>

        <span class="s1">key </span><span class="s3">= </span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">g</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">))</span>
        <span class="s1">result1 </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s1">result2 </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s1">key</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]).</span><span class="s1">to_pydatetime</span><span class="s3">(), </span><span class="s1">key</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]))</span>
        <span class="s1">result3 </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">str</span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s1">key</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])), </span><span class="s1">key</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">result2</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result1</span><span class="s3">, </span><span class="s1">result3</span><span class="s3">)</span>

        <span class="s4"># must pass a same-length tuple with multiple keys</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;must supply a tuple to get_group with multiple grouping keys&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s6">&quot;foo&quot;</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s6">&quot;foo&quot;</span><span class="s3">)</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;must supply a same-length tuple to get_group with multiple grouping keys&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;baz&quot;</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_get_group_empty_bins</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">observed</span><span class="s3">):</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">6</span><span class="s3">])</span>
        <span class="s1">bins </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">]</span>
        <span class="s1">g </span><span class="s3">= </span><span class="s1">d</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">cut</span><span class="s3">(</span><span class="s1">d</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">bins</span><span class="s3">), </span><span class="s1">observed</span><span class="s3">=</span><span class="s1">observed</span><span class="s3">)</span>

        <span class="s4"># TODO: should prob allow a str of Interval work as well</span>
        <span class="s4"># IOW '(0, 5]'</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Interval</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">))</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">msg </span><span class="s3">= </span><span class="s6">r&quot;Interval\(10, 15, closed='right'\)&quot;</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">KeyError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">g</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">Interval</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">15</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_get_group_grouped_by_tuple</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 8121</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[(</span><span class="s5">1</span><span class="s3">,), (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), (</span><span class="s5">1</span><span class="s3">,), (</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)]], </span><span class="s1">index</span><span class="s3">=[</span><span class="s6">&quot;ids&quot;</span><span class="s3">]).</span><span class="s1">T</span>
        <span class="s1">gr </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;ids&quot;</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;ids&quot;</span><span class="s3">: [(</span><span class="s5">1</span><span class="s3">,), (</span><span class="s5">1</span><span class="s3">,)]}, </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gr</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s5">1</span><span class="s3">,))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

        <span class="s1">dt </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">to_datetime</span><span class="s3">([</span><span class="s6">&quot;2010-01-01&quot;</span><span class="s3">, </span><span class="s6">&quot;2010-01-02&quot;</span><span class="s3">, </span><span class="s6">&quot;2010-01-01&quot;</span><span class="s3">, </span><span class="s6">&quot;2010-01-02&quot;</span><span class="s3">])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;ids&quot;</span><span class="s3">: [(</span><span class="s1">x</span><span class="s3">,) </span><span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s1">dt</span><span class="s3">]})</span>
        <span class="s1">gr </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;ids&quot;</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gr</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s6">&quot;2010-01-01&quot;</span><span class="s3">,))</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;ids&quot;</span><span class="s3">: [(</span><span class="s1">dt</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],), (</span><span class="s1">dt</span><span class="s3">[</span><span class="s5">0</span><span class="s3">],)]}, </span><span class="s1">index</span><span class="s3">=[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_get_group_grouped_by_tuple_with_lambda</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 36158</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;Tuples&quot;</span><span class="s3">: (</span>
                    <span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
                    <span class="s2">for </span><span class="s1">x </span><span class="s2">in </span><span class="s3">[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
                    <span class="s2">for </span><span class="s1">y </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">integers</span><span class="s3">(</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s3">}</span>
        <span class="s3">)</span>

        <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;Tuples&quot;</span><span class="s3">)</span>
        <span class="s1">gb_lambda </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[</span><span class="s1">x</span><span class="s3">, </span><span class="s5">0</span><span class="s3">])</span>

        <span class="s1">expected </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">gb</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())))</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gb_lambda</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">(</span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">gb_lambda</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">())))</span>

        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_empty</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">index </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DatetimeIndex</span><span class="s3">(())</span>
        <span class="s1">data </span><span class="s3">= ()</span>
        <span class="s1">series </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">index</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">)</span>
        <span class="s1">grouper </span><span class="s3">= </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;D&quot;</span><span class="s3">)</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">series</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">grouper</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">next</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">), </span><span class="s2">None</span><span class="s3">) </span><span class="s2">is None</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_single_column</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: </span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;abssbab&quot;</span><span class="s3">)})</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">).</span><span class="s1">get_group</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">), </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]])</span>
        <span class="s4"># GH 13530</span>
        <span class="s1">exp </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span><span class="s1">index</span><span class="s3">=</span><span class="s1">Index</span><span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;s&quot;</span><span class="s3">], </span><span class="s1">name</span><span class="s3">=</span><span class="s6">&quot;a&quot;</span><span class="s3">), </span><span class="s1">columns</span><span class="s3">=[])</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">).</span><span class="s1">count</span><span class="s3">(), </span><span class="s1">exp</span><span class="s3">)</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(), </span><span class="s1">exp</span><span class="s3">)</span>

        <span class="s1">exp </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]]</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">).</span><span class="s1">nth</span><span class="s3">(</span><span class="s5">1</span><span class="s3">), </span><span class="s1">exp</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_gb_key_len_equal_axis_len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH16843</span>
        <span class="s4"># test ensures that index and column keys are recognized correctly</span>
        <span class="s4"># when number of keys equals axis length of groupby</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">[[</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;baz&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]],</span>
            <span class="s1">columns</span><span class="s3">=[</span><span class="s6">&quot;first&quot;</span><span class="s3">, </span><span class="s6">&quot;second&quot;</span><span class="s3">, </span><span class="s6">&quot;third&quot;</span><span class="s3">, </span><span class="s6">&quot;one&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">set_index</span><span class="s3">([</span><span class="s6">&quot;first&quot;</span><span class="s3">, </span><span class="s6">&quot;second&quot;</span><span class="s3">])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;first&quot;</span><span class="s3">, </span><span class="s6">&quot;second&quot;</span><span class="s3">, </span><span class="s6">&quot;third&quot;</span><span class="s3">]).</span><span class="s1">size</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[(</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;bar&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">)] == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[(</span><span class="s6">&quot;foo&quot;</span><span class="s3">, </span><span class="s6">&quot;baz&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">)] == </span><span class="s5">1</span>


<span class="s4"># groups &amp; iteration</span>
<span class="s4"># --------------------------------</span>


<span class="s2">class </span><span class="s1">TestIteration</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">test_groups</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">])</span>
        <span class="s1">groups </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s1">groups </span><span class="s2">is </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups  </span><span class="s4"># caching works</span>

        <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">assert </span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">v</span><span class="s3">][</span><span class="s6">&quot;A&quot;</span><span class="s3">] == </span><span class="s1">k</span><span class="s3">).</span><span class="s1">all</span><span class="s3">()</span>

        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">])</span>
        <span class="s1">groups </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s1">groups </span><span class="s2">is </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups  </span><span class="s4"># caching works</span>

        <span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
            <span class="s2">assert </span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">v</span><span class="s3">][</span><span class="s6">&quot;A&quot;</span><span class="s3">] == </span><span class="s1">k</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>
            <span class="s2">assert </span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">v</span><span class="s3">][</span><span class="s6">&quot;B&quot;</span><span class="s3">] == </span><span class="s1">k</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]).</span><span class="s1">all</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">test_grouping_is_iterable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">tsframe</span><span class="s3">):</span>
        <span class="s4"># this code path isn't used anywhere else</span>
        <span class="s4"># not sure it's useful</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">tsframe</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">weekday</span><span class="s3">(), </span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">.</span><span class="s1">year</span><span class="s3">])</span>

        <span class="s4"># test it works</span>
        <span class="s2">for </span><span class="s1">g </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">groupings</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]:</span>
            <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_multi_iter</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">Series</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">6</span><span class="s3">))</span>
        <span class="s1">k1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">])</span>
        <span class="s1">k2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">])</span>

        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">k1</span><span class="s3">, </span><span class="s1">k2</span><span class="s3">])</span>

        <span class="s1">iterated </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">)</span>
        <span class="s1">expected </span><span class="s3">= [</span>
            <span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]),</span>
            <span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[[</span><span class="s5">1</span><span class="s3">]]),</span>
            <span class="s3">(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[[</span><span class="s5">4</span><span class="s3">]]),</span>
            <span class="s3">(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]]),</span>
        <span class="s3">]</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, ((</span><span class="s1">one</span><span class="s3">, </span><span class="s1">two</span><span class="s3">), </span><span class="s1">three</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">iterated</span><span class="s3">):</span>
            <span class="s1">e1</span><span class="s3">, </span><span class="s1">e2</span><span class="s3">, </span><span class="s1">e3 </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s2">assert </span><span class="s1">e1 </span><span class="s3">== </span><span class="s1">one</span>
            <span class="s2">assert </span><span class="s1">e2 </span><span class="s3">== </span><span class="s1">two</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_series_equal</span><span class="s3">(</span><span class="s1">three</span><span class="s3">, </span><span class="s1">e3</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_multi_iter_frame</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">three_group</span><span class="s3">):</span>
        <span class="s1">k1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s1">k2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span>
                <span class="s6">&quot;v1&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">6</span><span class="s3">),</span>
                <span class="s6">&quot;v2&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s5">2</span><span class="s3">).</span><span class="s1">standard_normal</span><span class="s3">(</span><span class="s5">6</span><span class="s3">),</span>
                <span class="s6">&quot;k1&quot;</span><span class="s3">: </span><span class="s1">k1</span><span class="s3">,</span>
                <span class="s6">&quot;k2&quot;</span><span class="s3">: </span><span class="s1">k2</span><span class="s3">,</span>
            <span class="s3">},</span>
            <span class="s1">index</span><span class="s3">=[</span><span class="s6">&quot;one&quot;</span><span class="s3">, </span><span class="s6">&quot;two&quot;</span><span class="s3">, </span><span class="s6">&quot;three&quot;</span><span class="s3">, </span><span class="s6">&quot;four&quot;</span><span class="s3">, </span><span class="s6">&quot;five&quot;</span><span class="s3">, </span><span class="s6">&quot;six&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>

        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;k1&quot;</span><span class="s3">, </span><span class="s6">&quot;k2&quot;</span><span class="s3">])</span>

        <span class="s4"># things get sorted!</span>
        <span class="s1">iterated </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">)</span>
        <span class="s1">idx </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">index</span>
        <span class="s1">expected </span><span class="s3">= [</span>
            <span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">[[</span><span class="s5">4</span><span class="s3">]]]),</span>
            <span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">[[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]]]),</span>
            <span class="s3">(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]]),</span>
            <span class="s3">(</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">loc</span><span class="s3">[</span><span class="s1">idx</span><span class="s3">[[</span><span class="s5">1</span><span class="s3">]]]),</span>
        <span class="s3">]</span>
        <span class="s2">for </span><span class="s1">i</span><span class="s3">, ((</span><span class="s1">one</span><span class="s3">, </span><span class="s1">two</span><span class="s3">), </span><span class="s1">three</span><span class="s3">) </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">iterated</span><span class="s3">):</span>
            <span class="s1">e1</span><span class="s3">, </span><span class="s1">e2</span><span class="s3">, </span><span class="s1">e3 </span><span class="s3">= </span><span class="s1">expected</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s2">assert </span><span class="s1">e1 </span><span class="s3">== </span><span class="s1">one</span>
            <span class="s2">assert </span><span class="s1">e2 </span><span class="s3">== </span><span class="s1">two</span>
            <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">three</span><span class="s3">, </span><span class="s1">e3</span><span class="s3">)</span>

        <span class="s4"># don't iterate through groups with no data</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;k1&quot;</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;b&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">])</span>
        <span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;k2&quot;</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">, </span><span class="s6">&quot;2&quot;</span><span class="s3">])</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;k1&quot;</span><span class="s3">, </span><span class="s6">&quot;k2&quot;</span><span class="s3">])</span>
        <span class="s4"># calling `dict` on a DataFrameGroupBy leads to a TypeError,</span>
        <span class="s4"># we need to use a dictionary comprehension here</span>
        <span class="s4"># pylint: disable-next=unnecessary-comprehension</span>
        <span class="s1">groups </span><span class="s3">= {</span><span class="s1">key</span><span class="s3">: </span><span class="s1">gp </span><span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">gp </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">}  </span><span class="s4"># noqa: C416</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">groups</span><span class="s3">) == </span><span class="s5">2</span>

        <span class="s4"># axis = 1</span>
        <span class="s1">three_levels </span><span class="s3">= </span><span class="s1">three_group</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;C&quot;</span><span class="s3">]).</span><span class="s1">mean</span><span class="s3">()</span>
        <span class="s1">depr_msg </span><span class="s3">= </span><span class="s6">&quot;DataFrame.groupby with axis=1 is deprecated&quot;</span>
        <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">depr_msg</span><span class="s3">):</span>
            <span class="s1">grouped </span><span class="s3">= </span><span class="s1">three_levels</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">level</span><span class="s3">=(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">key</span><span class="s3">, </span><span class="s1">group </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">:</span>
            <span class="s2">pass</span>

    <span class="s2">def </span><span class="s1">test_dictify</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">df</span><span class="s3">):</span>
        <span class="s1">dict</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)))</span>
        <span class="s1">dict</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">])))</span>
        <span class="s1">dict</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;C&quot;</span><span class="s3">].</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;A&quot;</span><span class="s3">])))</span>
        <span class="s1">dict</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;C&quot;</span><span class="s3">].</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;A&quot;</span><span class="s3">], </span><span class="s1">df</span><span class="s3">[</span><span class="s6">&quot;B&quot;</span><span class="s3">]])))</span>
        <span class="s1">dict</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)[</span><span class="s6">&quot;C&quot;</span><span class="s3">]))</span>
        <span class="s1">dict</span><span class="s3">(</span><span class="s1">iter</span><span class="s3">(</span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">])[</span><span class="s6">&quot;C&quot;</span><span class="s3">]))</span>

    <span class="s2">def </span><span class="s1">test_groupby_with_small_elem</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 8542</span>
        <span class="s4"># length=2</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;event&quot;</span><span class="s3">: [</span><span class="s6">&quot;start&quot;</span><span class="s3">, </span><span class="s6">&quot;start&quot;</span><span class="s3">], </span><span class="s6">&quot;change&quot;</span><span class="s3">: [</span><span class="s5">1234</span><span class="s3">, </span><span class="s5">5678</span><span class="s3">]},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DatetimeIndex</span><span class="s3">([</span><span class="s6">&quot;2014-09-10&quot;</span><span class="s3">, </span><span class="s6">&quot;2013-10-10&quot;</span><span class="s3">]),</span>
        <span class="s3">)</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">), </span><span class="s6">&quot;event&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">ngroups </span><span class="s3">== </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-09-30&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-10-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-09-30&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">], :])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-10-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">1</span><span class="s3">], :])</span>

        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;event&quot;</span><span class="s3">: [</span><span class="s6">&quot;start&quot;</span><span class="s3">, </span><span class="s6">&quot;start&quot;</span><span class="s3">, </span><span class="s6">&quot;start&quot;</span><span class="s3">], </span><span class="s6">&quot;change&quot;</span><span class="s3">: [</span><span class="s5">1234</span><span class="s3">, </span><span class="s5">5678</span><span class="s3">, </span><span class="s5">9123</span><span class="s3">]},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DatetimeIndex</span><span class="s3">([</span><span class="s6">&quot;2014-09-10&quot;</span><span class="s3">, </span><span class="s6">&quot;2013-10-10&quot;</span><span class="s3">, </span><span class="s6">&quot;2014-09-15&quot;</span><span class="s3">]),</span>
        <span class="s3">)</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">), </span><span class="s6">&quot;event&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">) == </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">ngroups </span><span class="s3">== </span><span class="s5">2</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-09-30&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-10-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-09-30&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], :])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-10-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">1</span><span class="s3">], :])</span>

        <span class="s4"># length=3</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">(</span>
            <span class="s3">{</span><span class="s6">&quot;event&quot;</span><span class="s3">: [</span><span class="s6">&quot;start&quot;</span><span class="s3">, </span><span class="s6">&quot;start&quot;</span><span class="s3">, </span><span class="s6">&quot;start&quot;</span><span class="s3">], </span><span class="s6">&quot;change&quot;</span><span class="s3">: [</span><span class="s5">1234</span><span class="s3">, </span><span class="s5">5678</span><span class="s3">, </span><span class="s5">9123</span><span class="s3">]},</span>
            <span class="s1">index</span><span class="s3">=</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">DatetimeIndex</span><span class="s3">([</span><span class="s6">&quot;2014-09-10&quot;</span><span class="s3">, </span><span class="s6">&quot;2013-10-10&quot;</span><span class="s3">, </span><span class="s6">&quot;2014-08-05&quot;</span><span class="s3">]),</span>
        <span class="s3">)</span>
        <span class="s1">grouped </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">freq</span><span class="s3">=</span><span class="s6">&quot;ME&quot;</span><span class="s3">), </span><span class="s6">&quot;event&quot;</span><span class="s3">])</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span><span class="s3">) == </span><span class="s5">3</span>
        <span class="s2">assert </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">ngroups </span><span class="s3">== </span><span class="s5">3</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-09-30&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-10-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-08-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">) </span><span class="s2">in </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">groups</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-09-30&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">0</span><span class="s3">], :])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2013-10-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">1</span><span class="s3">], :])</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grouped</span><span class="s3">.</span><span class="s1">get_group</span><span class="s3">((</span><span class="s1">Timestamp</span><span class="s3">(</span><span class="s6">&quot;2014-08-31&quot;</span><span class="s3">), </span><span class="s6">&quot;start&quot;</span><span class="s3">))</span>
        <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">df</span><span class="s3">.</span><span class="s1">iloc</span><span class="s3">[[</span><span class="s5">2</span><span class="s3">], :])</span>

    <span class="s2">def </span><span class="s1">test_grouping_string_repr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s4"># GH 13394</span>
        <span class="s1">mi </span><span class="s3">= </span><span class="s1">MultiIndex</span><span class="s3">.</span><span class="s1">from_arrays</span><span class="s3">([</span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;AAB&quot;</span><span class="s3">), </span><span class="s1">list</span><span class="s3">(</span><span class="s6">&quot;aba&quot;</span><span class="s3">)])</span>
        <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]], </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">mi</span><span class="s3">)</span>
        <span class="s1">gr </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">df</span><span class="s3">[(</span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;a&quot;</span><span class="s3">)])</span>

        <span class="s1">result </span><span class="s3">= </span><span class="s1">gr</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">groupings</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">__repr__</span><span class="s3">()</span>
        <span class="s1">expected </span><span class="s3">= </span><span class="s6">&quot;Grouping(('A', 'a'))&quot;</span>
        <span class="s2">assert </span><span class="s1">result </span><span class="s3">== </span><span class="s1">expected</span>


<span class="s2">def </span><span class="s1">test_grouping_by_key_is_in_axis</span><span class="s3">():</span>
    <span class="s4"># GH#50413 - Groupers specified by key are in-axis</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;c&quot;</span><span class="s3">: [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]}).</span><span class="s1">set_index</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">)</span>
    <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">([</span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">level</span><span class="s3">=</span><span class="s6">&quot;a&quot;</span><span class="s3">), </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;b&quot;</span><span class="s3">)], </span><span class="s1">as_index</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">groupings</span><span class="s3">[</span><span class="s5">0</span><span class="s3">].</span><span class="s1">in_axis</span>
    <span class="s2">assert </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">groupings</span><span class="s3">[</span><span class="s5">1</span><span class="s3">].</span><span class="s1">in_axis</span>

    <span class="s4"># Currently only in-axis groupings are including in the result when as_index=False;</span>
    <span class="s4"># This is likely to change in the future.</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;A grouping .* was excluded from the result&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">()</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;c&quot;</span><span class="s3">: [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]})</span>
    <span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_frame_equal</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_grouper_groups</span><span class="s3">():</span>
    <span class="s4"># GH#51182 check Grouper.groups does not raise AttributeError</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], </span><span class="s6">&quot;b&quot;</span><span class="s3">: </span><span class="s5">1</span><span class="s3">})</span>
    <span class="s1">grper </span><span class="s3">= </span><span class="s1">Grouper</span><span class="s3">(</span><span class="s1">key</span><span class="s3">=</span><span class="s6">&quot;a&quot;</span><span class="s3">)</span>
    <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s1">grper</span><span class="s3">)</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Use GroupBy.groups instead&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grper</span><span class="s3">.</span><span class="s1">groups</span>
    <span class="s2">assert </span><span class="s1">res </span><span class="s2">is </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">groups</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Use GroupBy.grouper instead&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grper</span><span class="s3">.</span><span class="s1">grouper</span>
    <span class="s2">assert </span><span class="s1">res </span><span class="s2">is </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">_grouper</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Grouper.obj is deprecated and will be removed&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">grper</span><span class="s3">.</span><span class="s1">obj</span>
    <span class="s2">assert </span><span class="s1">res </span><span class="s2">is </span><span class="s1">gb</span><span class="s3">.</span><span class="s1">obj</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Use Resampler.ax instead&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">grper</span><span class="s3">.</span><span class="s1">ax</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Grouper.indexer is deprecated&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">grper</span><span class="s3">.</span><span class="s1">indexer</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;attr&quot;</span><span class="s3">, [</span><span class="s6">&quot;group_index&quot;</span><span class="s3">, </span><span class="s6">&quot;result_index&quot;</span><span class="s3">, </span><span class="s6">&quot;group_arraylike&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_depr_grouping_attrs</span><span class="s3">(</span><span class="s1">attr</span><span class="s3">):</span>
    <span class="s4"># GH#56148</span>
    <span class="s1">df </span><span class="s3">= </span><span class="s1">DataFrame</span><span class="s3">({</span><span class="s6">&quot;a&quot;</span><span class="s3">: [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s6">&quot;b&quot;</span><span class="s3">: [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">4</span><span class="s3">, </span><span class="s5">5</span><span class="s3">]})</span>
    <span class="s1">gb </span><span class="s3">= </span><span class="s1">df</span><span class="s3">.</span><span class="s1">groupby</span><span class="s3">(</span><span class="s6">&quot;a&quot;</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;</span><span class="s2">{</span><span class="s1">attr</span><span class="s2">} </span><span class="s6">is deprecated&quot;</span>
    <span class="s2">with </span><span class="s1">tm</span><span class="s3">.</span><span class="s1">assert_produces_warning</span><span class="s3">(</span><span class="s1">FutureWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">getattr</span><span class="s3">(</span><span class="s1">gb</span><span class="s3">.</span><span class="s1">_grouper</span><span class="s3">.</span><span class="s1">groupings</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">attr</span><span class="s3">)</span>
</pre>
</body>
</html>