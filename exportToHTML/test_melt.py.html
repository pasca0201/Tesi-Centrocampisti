<html>
<head>
<title>test_melt.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_melt.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
    <span class="s1">lreshape</span><span class="s2">,</span>
    <span class="s1">melt</span><span class="s2">,</span>
    <span class="s1">wide_to_long</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">df</span><span class="s2">():</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s3">10</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s4">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">res</span><span class="s2">[</span><span class="s4">&quot;id1&quot;</span><span class="s2">] = (</span><span class="s1">res</span><span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">] &gt; </span><span class="s3">0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
    <span class="s1">res</span><span class="s2">[</span><span class="s4">&quot;id2&quot;</span><span class="s2">] = (</span><span class="s1">res</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">] &gt; </span><span class="s3">0</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">res</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">df1</span><span class="s2">():</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s3">1.067683</span><span class="s2">, -</span><span class="s3">1.110463</span><span class="s2">, </span><span class="s3">0.20867</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s3">1.321405</span><span class="s2">, </span><span class="s3">0.368915</span><span class="s2">, -</span><span class="s3">1.055342</span><span class="s2">],</span>
            <span class="s2">[-</span><span class="s3">0.807333</span><span class="s2">, </span><span class="s3">0.08298</span><span class="s2">, -</span><span class="s3">0.873361</span><span class="s2">],</span>
        <span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">res</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABC&quot;</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abc&quot;</span><span class="s2">)]</span>
    <span class="s1">res</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">names </span><span class="s2">= [</span><span class="s4">&quot;CAP&quot;</span><span class="s2">, </span><span class="s4">&quot;low&quot;</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">res</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">var_name</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s4">&quot;var&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">value_name</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s4">&quot;val&quot;</span>


<span class="s0">class </span><span class="s1">TestMelt</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_top_level_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_method_signatures</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">df1</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">):</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(), </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">))</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]),</span>
            <span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]),</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">),</span>
            <span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">),</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">col_level</span><span class="s2">=</span><span class="s3">0</span><span class="s2">), </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">, </span><span class="s1">col_level</span><span class="s2">=</span><span class="s3">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_default_col_names</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

        <span class="s1">result1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">result1</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

        <span class="s1">result2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">result2</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_value_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">result3 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">result3</span><span class="s2">) == </span><span class="s3">10</span>

        <span class="s1">result4 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">])</span>
        <span class="s1">expected4 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;id1&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id1&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;id2&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id2&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">] * </span><span class="s3">10 </span><span class="s2">+ [</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s3">10</span><span class="s2">,</span>
                <span class="s4">&quot;value&quot;</span><span class="s2">: (</span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result4</span><span class="s2">, </span><span class="s1">expected4</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;type_&quot;</span><span class="s2">, (</span><span class="s1">tuple</span><span class="s2">, </span><span class="s1">list</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_value_vars_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">type_</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s5"># GH 15348</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;id1&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id1&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;id2&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id2&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">] * </span><span class="s3">10 </span><span class="s2">+ [</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s3">10</span><span class="s2">,</span>
                <span class="s4">&quot;value&quot;</span><span class="s2">: (</span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=</span><span class="s1">type_</span><span class="s2">((</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">)))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_vars_work_with_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df1</span><span class="s2">):</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s2">(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">): </span><span class="s1">df1</span><span class="s2">[(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">)],</span>
                <span class="s4">&quot;CAP&quot;</span><span class="s2">: [</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">),</span>
                <span class="s4">&quot;low&quot;</span><span class="s2">: [</span><span class="s4">&quot;b&quot;</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">df1</span><span class="s2">),</span>
                <span class="s4">&quot;value&quot;</span><span class="s2">: </span><span class="s1">df1</span><span class="s2">[(</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)],</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">), </span><span class="s4">&quot;CAP&quot;</span><span class="s2">, </span><span class="s4">&quot;low&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">)], </span><span class="s1">value_vars</span><span class="s2">=[(</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">&quot;id_vars, value_vars, col_level, expected&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span>
                <span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">],</span>
                <span class="s3">0</span><span class="s2">,</span>
                <span class="s1">DataFrame</span><span class="s2">(</span>
                    <span class="s2">{</span>
                        <span class="s4">&quot;A&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1.067683</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: -</span><span class="s3">1.321405</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: -</span><span class="s3">0.807333</span><span class="s2">},</span>
                        <span class="s4">&quot;CAP&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;B&quot;</span><span class="s2">},</span>
                        <span class="s4">&quot;value&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: -</span><span class="s3">1.110463</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">0.368915</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.08298</span><span class="s2">},</span>
                    <span class="s2">}</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
            <span class="s2">(</span>
                <span class="s2">[</span><span class="s4">&quot;a&quot;</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">&quot;b&quot;</span><span class="s2">],</span>
                <span class="s3">1</span><span class="s2">,</span>
                <span class="s1">DataFrame</span><span class="s2">(</span>
                    <span class="s2">{</span>
                        <span class="s4">&quot;a&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1.067683</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: -</span><span class="s3">1.321405</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: -</span><span class="s3">0.807333</span><span class="s2">},</span>
                        <span class="s4">&quot;low&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">},</span>
                        <span class="s4">&quot;value&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: -</span><span class="s3">1.110463</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">0.368915</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.08298</span><span class="s2">},</span>
                    <span class="s2">}</span>
                <span class="s2">),</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_single_vars_work_with_multiindex</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">id_vars</span><span class="s2">, </span><span class="s1">value_vars</span><span class="s2">, </span><span class="s1">col_level</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">df1</span>
    <span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">, </span><span class="s1">value_vars</span><span class="s2">, </span><span class="s1">col_level</span><span class="s2">=</span><span class="s1">col_level</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">&quot;id_vars, value_vars&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">[(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">), [(</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)]],</span>
            <span class="s2">[[(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">)], (</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)],</span>
            <span class="s2">[(</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">), (</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)],</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_tuple_vars_fail_with_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">id_vars</span><span class="s2">, </span><span class="s1">value_vars</span><span class="s2">, </span><span class="s1">df1</span><span class="s2">):</span>
        <span class="s5"># melt should fail with an informative error message if</span>
        <span class="s5"># the columns have a MultiIndex and a tuple is passed</span>
        <span class="s5"># for id_vars or value_vars.</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">r&quot;(id|value)_vars must be a list of tuples when columns are a MultiIndex&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df1</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=</span><span class="s1">id_vars</span><span class="s2">, </span><span class="s1">value_vars</span><span class="s2">=</span><span class="s1">value_vars</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_custom_var_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">):</span>
        <span class="s1">result5 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result5</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

        <span class="s1">result6 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result6</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

        <span class="s1">result7 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result7</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

        <span class="s1">result8 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result8</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

        <span class="s1">result9 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span>
        <span class="s2">)</span>
        <span class="s1">expected9 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;id1&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id1&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;id2&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id2&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s1">var_name</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">] * </span><span class="s3">10 </span><span class="s2">+ [</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s3">10</span><span class="s2">,</span>
                <span class="s4">&quot;value&quot;</span><span class="s2">: (</span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result9</span><span class="s2">, </span><span class="s1">expected9</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_custom_value_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">):</span>
        <span class="s1">result10 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result10</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result11 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">], </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result11</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result12 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result12</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result13 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result13</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result14 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span>
        <span class="s2">)</span>
        <span class="s1">expected14 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;id1&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id1&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;id2&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id2&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">] * </span><span class="s3">10 </span><span class="s2">+ [</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s3">10</span><span class="s2">,</span>
                <span class="s1">value_name</span><span class="s2">: (</span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result14</span><span class="s2">, </span><span class="s1">expected14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_custom_var_and_value_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">):</span>
        <span class="s1">result15 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result15</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result16 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result16</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result17 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result17</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result18 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">],</span>
            <span class="s1">value_vars</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">,</span>
            <span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">,</span>
            <span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result18</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s4">&quot;var&quot;</span><span class="s2">, </span><span class="s4">&quot;val&quot;</span><span class="s2">]</span>

        <span class="s1">result19 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">],</span>
            <span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">],</span>
            <span class="s1">var_name</span><span class="s2">=</span><span class="s1">var_name</span><span class="s2">,</span>
            <span class="s1">value_name</span><span class="s2">=</span><span class="s1">value_name</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected19 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;id1&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id1&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s4">&quot;id2&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id2&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s1">var_name</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">] * </span><span class="s3">10 </span><span class="s2">+ [</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s3">10</span><span class="s2">,</span>
                <span class="s1">value_name</span><span class="s2">: (</span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;A&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;B&quot;</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">()),</span>
            <span class="s2">},</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;id1&quot;</span><span class="s2">, </span><span class="s4">&quot;id2&quot;</span><span class="s2">, </span><span class="s1">var_name</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result19</span><span class="s2">, </span><span class="s1">expected19</span><span class="s2">)</span>

        <span class="s1">df20 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">df20</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s4">&quot;foo&quot;</span>
        <span class="s1">result20 </span><span class="s2">= </span><span class="s1">df20</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">result20</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;col_level&quot;</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">, </span><span class="s4">&quot;CAP&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_col_level</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">col_level</span><span class="s2">, </span><span class="s1">df1</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">col_level</span><span class="s2">=</span><span class="s1">col_level</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;CAP&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df1</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df1</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s4">&quot;CAP&quot;</span><span class="s2">, </span><span class="s4">&quot;low&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s4">&quot;col&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">date_range</span><span class="s2">(</span><span class="s4">&quot;2010&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;US/Pacific&quot;</span><span class="s2">)),</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;category&quot;</span><span class="s2">),</span>
            <span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_pandas_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">col</span><span class="s2">):</span>
        <span class="s5"># GH 15785</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;klass&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">), </span><span class="s4">&quot;col&quot;</span><span class="s2">: </span><span class="s1">col</span><span class="s2">, </span><span class="s4">&quot;attr1&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s4">&quot;attr2&quot;</span><span class="s2">: </span><span class="s1">col</span><span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected_value </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">]), </span><span class="s1">col</span><span class="s2">], </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">, </span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;klass&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=</span><span class="s4">&quot;attribute&quot;</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s4">&quot;value&quot;</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">0</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">)) * </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s3">1</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">col</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                <span class="s3">2</span><span class="s2">: [</span><span class="s4">&quot;attr1&quot;</span><span class="s2">] * </span><span class="s3">5 </span><span class="s2">+ [</span><span class="s4">&quot;attr2&quot;</span><span class="s2">] * </span><span class="s3">5</span><span class="s2">,</span>
                <span class="s3">3</span><span class="s2">: </span><span class="s1">expected_value</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s4">&quot;klass&quot;</span><span class="s2">, </span><span class="s4">&quot;col&quot;</span><span class="s2">, </span><span class="s4">&quot;attribute&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_preserve_category</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 15853</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s4">&quot;B&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;Y&quot;</span><span class="s2">])})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, [</span><span class="s4">&quot;B&quot;</span><span class="s2">], [</span><span class="s4">&quot;A&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;B&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Categorical</span><span class="s2">([</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;Y&quot;</span><span class="s2">]), </span><span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">], </span><span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]}</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_missing_columns_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH-23575</span>
        <span class="s5"># This test is to ensure that pandas raises an error if melting is</span>
        <span class="s5"># attempted with column names absent from the dataframe</span>

        <span class="s5"># Generate data</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s3">5</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s5"># Try to melt with missing `value_vars` column name</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;The following id_vars or value_vars are not present in the DataFrame:&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], [</span><span class="s4">&quot;C&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">])</span>

        <span class="s5"># Try to melt with missing `id_vars` column name</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">], [</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">])</span>

        <span class="s5"># Multiple missing</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">KeyError</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;not_here&quot;</span><span class="s2">, </span><span class="s4">&quot;or_there&quot;</span><span class="s2">], [</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">])</span>

        <span class="s5"># Multiindex melt fails if column is missing from multilevel melt</span>
        <span class="s1">multi </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">multi</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abcd&quot;</span><span class="s2">)]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">multi</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">([(</span><span class="s4">&quot;E&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">)], [(</span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">)])</span>
        <span class="s5"># Multiindex fails if column is missing from single level melt</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">KeyError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">multi</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">([</span><span class="s4">&quot;A&quot;</span><span class="s2">], [</span><span class="s4">&quot;F&quot;</span><span class="s2">], </span><span class="s1">col_level</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_mixed_int_str_id_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 29718</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">0</span><span class="s2">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">], </span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;bar&quot;</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">], </span><span class="s4">&quot;d&quot;</span><span class="s2">: [</span><span class="s3">2</span><span class="s2">]})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">0</span><span class="s2">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;bar&quot;</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;bd&quot;</span><span class="s2">), </span><span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_mixed_int_str_value_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 29718</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">0</span><span class="s2">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">], </span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">&quot;bar&quot;</span><span class="s2">]})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">], </span><span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">]})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ignore_index</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 17440</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;foo&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">], </span><span class="s4">&quot;bar&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;first&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">], </span><span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ignore_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 17440</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s2">), (</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;third&quot;</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;baz&quot;</span><span class="s2">, </span><span class="s4">&quot;foobar&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;foo&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s4">&quot;bar&quot;</span><span class="s2">: [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">expected_index </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_tuples</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s2">), (</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;third&quot;</span><span class="s2">)] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;baz&quot;</span><span class="s2">, </span><span class="s4">&quot;foobar&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">] * </span><span class="s3">2 </span><span class="s2">+ [</span><span class="s4">&quot;bar&quot;</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">expected_index</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ignore_index_name_and_type</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 17440</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;baz&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;x&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s4">&quot;y&quot;</span><span class="s2">: [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">melt</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">expected_index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">] * </span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">&quot;baz&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">], </span><span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">expected_index</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_with_duplicate_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH#41951</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;b&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;variable&quot;</span><span class="s2">, </span><span class="s4">&quot;value&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">&quot;Int8&quot;</span><span class="s2">, </span><span class="s4">&quot;Int64&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_melt_ea_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5"># GH#41570</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;a&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;Int8&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;b&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;variable&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;value&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_ea_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 54297</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;c&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;B&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">5</span><span class="s2">},</span>
                <span class="s4">&quot;C&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">6</span><span class="s2">},</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">&quot;string[python]&quot;</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;A&quot;</span><span class="s2">], </span><span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;B&quot;</span><span class="s2">])</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;abc&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;variable&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">([</span><span class="s4">&quot;B&quot;</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string[python]&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;value&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">5</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_preserves_datetime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">=[</span>
                <span class="s2">{</span>
                    <span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;A0&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;start_date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023/03/01&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                    <span class="s4">&quot;end_date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023/03/10&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                <span class="s2">},</span>
                <span class="s2">{</span>
                    <span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;A1&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;start_date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023/03/01&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                    <span class="s4">&quot;end_date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023/03/11&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                <span class="s2">},</span>
            <span class="s2">],</span>
            <span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;aaaa&quot;</span><span class="s2">, </span><span class="s4">&quot;bbbb&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;type&quot;</span><span class="s2">],</span>
            <span class="s1">value_vars</span><span class="s2">=[</span><span class="s4">&quot;start_date&quot;</span><span class="s2">, </span><span class="s4">&quot;end_date&quot;</span><span class="s2">],</span>
            <span class="s1">var_name</span><span class="s2">=</span><span class="s4">&quot;start/end&quot;</span><span class="s2">,</span>
            <span class="s1">value_name</span><span class="s2">=</span><span class="s4">&quot;date&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;type&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;A0&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;A1&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;A0&quot;</span><span class="s2">, </span><span class="s3">3</span><span class="s2">: </span><span class="s4">&quot;A1&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;start/end&quot;</span><span class="s2">: {</span>
                    <span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;start_date&quot;</span><span class="s2">,</span>
                    <span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;start_date&quot;</span><span class="s2">,</span>
                    <span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;end_date&quot;</span><span class="s2">,</span>
                    <span class="s3">3</span><span class="s2">: </span><span class="s4">&quot;end_date&quot;</span><span class="s2">,</span>
                <span class="s2">},</span>
                <span class="s4">&quot;date&quot;</span><span class="s2">: {</span>
                    <span class="s3">0</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023-03-01 00:00:00+0900&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                    <span class="s3">1</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023-03-01 00:00:00+0900&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                    <span class="s3">2</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023-03-10 00:00:00+0900&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                    <span class="s3">3</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">&quot;2023-03-11 00:00:00+0900&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s4">&quot;Asia/Tokyo&quot;</span><span class="s2">),</span>
                <span class="s2">},</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_allows_non_scalar_id_vars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">={</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]},</span>
            <span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;11&quot;</span><span class="s2">, </span><span class="s4">&quot;22&quot;</span><span class="s2">, </span><span class="s4">&quot;33&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=</span><span class="s4">&quot;a&quot;</span><span class="s2">,</span>
            <span class="s1">var_name</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
            <span class="s1">value_name</span><span class="s2">=</span><span class="s3">1</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s3">0</span><span class="s2">: [</span><span class="s4">&quot;b&quot;</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_allows_non_string_var_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">={</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]},</span>
            <span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;11&quot;</span><span class="s2">, </span><span class="s4">&quot;22&quot;</span><span class="s2">, </span><span class="s4">&quot;33&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span>
            <span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">],</span>
            <span class="s1">var_name</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
            <span class="s1">value_name</span><span class="s2">=</span><span class="s3">1</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s3">0</span><span class="s2">: [</span><span class="s4">&quot;b&quot;</span><span class="s2">] * </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_melt_non_scalar_var_name_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">data</span><span class="s2">={</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">]},</span>
            <span class="s1">index</span><span class="s2">=[</span><span class="s4">&quot;11&quot;</span><span class="s2">, </span><span class="s4">&quot;22&quot;</span><span class="s2">, </span><span class="s4">&quot;33&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">r&quot;.* must be a scalar.&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">], </span><span class="s1">var_name</span><span class="s2">=[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">TestLreshape</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_pairs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= {</span>
            <span class="s4">&quot;birthdt&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;30dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;birthwt&quot;</span><span class="s2">: [</span><span class="s3">1766</span><span class="s2">, </span><span class="s3">3301</span><span class="s2">, </span><span class="s3">1454</span><span class="s2">, </span><span class="s3">3139</span><span class="s2">, </span><span class="s3">4133</span><span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">101</span><span class="s2">, </span><span class="s3">102</span><span class="s2">, </span><span class="s3">103</span><span class="s2">, </span><span class="s3">104</span><span class="s2">, </span><span class="s3">105</span><span class="s2">],</span>
            <span class="s4">&quot;sex&quot;</span><span class="s2">: [</span><span class="s4">&quot;Male&quot;</span><span class="s2">, </span><span class="s4">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">&quot;Female&quot;</span><span class="s2">, </span><span class="s4">&quot;Female&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;visitdt1&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;22dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;04jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;29dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20jan2009&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;visitdt2&quot;</span><span class="s2">: [</span><span class="s4">&quot;21jan2009&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">&quot;22jan2009&quot;</span><span class="s2">, </span><span class="s4">&quot;31dec2008&quot;</span><span class="s2">, </span><span class="s4">&quot;03feb2009&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;visitdt3&quot;</span><span class="s2">: [</span><span class="s4">&quot;05feb2009&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">&quot;02jan2009&quot;</span><span class="s2">, </span><span class="s4">&quot;15feb2009&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;wt1&quot;</span><span class="s2">: [</span><span class="s3">1823</span><span class="s2">, </span><span class="s3">3338</span><span class="s2">, </span><span class="s3">1549</span><span class="s2">, </span><span class="s3">3298</span><span class="s2">, </span><span class="s3">4306</span><span class="s2">],</span>
            <span class="s4">&quot;wt2&quot;</span><span class="s2">: [</span><span class="s3">2011.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1892.0</span><span class="s2">, </span><span class="s3">3338.0</span><span class="s2">, </span><span class="s3">4575.0</span><span class="s2">],</span>
            <span class="s4">&quot;wt3&quot;</span><span class="s2">: [</span><span class="s3">2293.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">3377.0</span><span class="s2">, </span><span class="s3">4805.0</span><span class="s2">],</span>
        <span class="s2">}</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s1">spec </span><span class="s2">= {</span>
            <span class="s4">&quot;visitdt&quot;</span><span class="s2">: [</span><span class="s4">f&quot;visitdt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s4">d</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)],</span>
            <span class="s4">&quot;wt&quot;</span><span class="s2">: [</span><span class="s4">f&quot;wt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s4">d</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)],</span>
        <span class="s2">}</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">lreshape</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">spec</span><span class="s2">)</span>

        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;birthdt&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;30dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;30dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;birthwt&quot;</span><span class="s2">: [</span>
                <span class="s3">1766</span><span class="s2">,</span>
                <span class="s3">3301</span><span class="s2">,</span>
                <span class="s3">1454</span><span class="s2">,</span>
                <span class="s3">3139</span><span class="s2">,</span>
                <span class="s3">4133</span><span class="s2">,</span>
                <span class="s3">1766</span><span class="s2">,</span>
                <span class="s3">1454</span><span class="s2">,</span>
                <span class="s3">3139</span><span class="s2">,</span>
                <span class="s3">4133</span><span class="s2">,</span>
                <span class="s3">1766</span><span class="s2">,</span>
                <span class="s3">3139</span><span class="s2">,</span>
                <span class="s3">4133</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">101</span><span class="s2">, </span><span class="s3">102</span><span class="s2">, </span><span class="s3">103</span><span class="s2">, </span><span class="s3">104</span><span class="s2">, </span><span class="s3">105</span><span class="s2">, </span><span class="s3">101</span><span class="s2">, </span><span class="s3">103</span><span class="s2">, </span><span class="s3">104</span><span class="s2">, </span><span class="s3">105</span><span class="s2">, </span><span class="s3">101</span><span class="s2">, </span><span class="s3">104</span><span class="s2">, </span><span class="s3">105</span><span class="s2">],</span>
            <span class="s4">&quot;sex&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;Male&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Male&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Male&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;visitdt&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;22dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;04jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;29dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;22jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;31dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;03feb2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;05feb2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;02jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;15feb2009&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;wt&quot;</span><span class="s2">: [</span>
                <span class="s3">1823.0</span><span class="s2">,</span>
                <span class="s3">3338.0</span><span class="s2">,</span>
                <span class="s3">1549.0</span><span class="s2">,</span>
                <span class="s3">3298.0</span><span class="s2">,</span>
                <span class="s3">4306.0</span><span class="s2">,</span>
                <span class="s3">2011.0</span><span class="s2">,</span>
                <span class="s3">1892.0</span><span class="s2">,</span>
                <span class="s3">3338.0</span><span class="s2">,</span>
                <span class="s3">4575.0</span><span class="s2">,</span>
                <span class="s3">2293.0</span><span class="s2">,</span>
                <span class="s3">3377.0</span><span class="s2">,</span>
                <span class="s3">4805.0</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">}</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">lreshape</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">spec</span><span class="s2">, </span><span class="s1">dropna</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;birthdt&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;30dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;30dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;08jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;30dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;birthwt&quot;</span><span class="s2">: [</span>
                <span class="s3">1766</span><span class="s2">,</span>
                <span class="s3">3301</span><span class="s2">,</span>
                <span class="s3">1454</span><span class="s2">,</span>
                <span class="s3">3139</span><span class="s2">,</span>
                <span class="s3">4133</span><span class="s2">,</span>
                <span class="s3">1766</span><span class="s2">,</span>
                <span class="s3">3301</span><span class="s2">,</span>
                <span class="s3">1454</span><span class="s2">,</span>
                <span class="s3">3139</span><span class="s2">,</span>
                <span class="s3">4133</span><span class="s2">,</span>
                <span class="s3">1766</span><span class="s2">,</span>
                <span class="s3">3301</span><span class="s2">,</span>
                <span class="s3">1454</span><span class="s2">,</span>
                <span class="s3">3139</span><span class="s2">,</span>
                <span class="s3">4133</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span>
                <span class="s3">101</span><span class="s2">,</span>
                <span class="s3">102</span><span class="s2">,</span>
                <span class="s3">103</span><span class="s2">,</span>
                <span class="s3">104</span><span class="s2">,</span>
                <span class="s3">105</span><span class="s2">,</span>
                <span class="s3">101</span><span class="s2">,</span>
                <span class="s3">102</span><span class="s2">,</span>
                <span class="s3">103</span><span class="s2">,</span>
                <span class="s3">104</span><span class="s2">,</span>
                <span class="s3">105</span><span class="s2">,</span>
                <span class="s3">101</span><span class="s2">,</span>
                <span class="s3">102</span><span class="s2">,</span>
                <span class="s3">103</span><span class="s2">,</span>
                <span class="s3">104</span><span class="s2">,</span>
                <span class="s3">105</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;sex&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;Male&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Male&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Male&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;Female&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;visitdt&quot;</span><span class="s2">: [</span>
                <span class="s4">&quot;11jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;22dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;04jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;29dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;20jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;21jan2009&quot;</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s4">&quot;22jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;31dec2008&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;03feb2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;05feb2009&quot;</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s4">&quot;02jan2009&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;15feb2009&quot;</span><span class="s2">,</span>
            <span class="s2">],</span>
            <span class="s4">&quot;wt&quot;</span><span class="s2">: [</span>
                <span class="s3">1823.0</span><span class="s2">,</span>
                <span class="s3">3338.0</span><span class="s2">,</span>
                <span class="s3">1549.0</span><span class="s2">,</span>
                <span class="s3">3298.0</span><span class="s2">,</span>
                <span class="s3">4306.0</span><span class="s2">,</span>
                <span class="s3">2011.0</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s3">1892.0</span><span class="s2">,</span>
                <span class="s3">3338.0</span><span class="s2">,</span>
                <span class="s3">4575.0</span><span class="s2">,</span>
                <span class="s3">2293.0</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                <span class="s3">3377.0</span><span class="s2">,</span>
                <span class="s3">4805.0</span><span class="s2">,</span>
            <span class="s2">],</span>
        <span class="s2">}</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">spec </span><span class="s2">= {</span>
            <span class="s4">&quot;visitdt&quot;</span><span class="s2">: [</span><span class="s4">f&quot;visitdt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s4">d</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)],</span>
            <span class="s4">&quot;wt&quot;</span><span class="s2">: [</span><span class="s4">f&quot;wt</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s4">d</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)],</span>
        <span class="s2">}</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;All column lists must be same length&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">lreshape</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">spec</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestWideToLong</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A1970&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;c&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;A1980&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;f&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;B1970&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.7</span><span class="s2">},</span>
                <span class="s4">&quot;B1980&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.1</span><span class="s2">},</span>
                <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">), </span><span class="s1">x</span><span class="s2">)),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">x</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">(),</span>
            <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;f&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;B&quot;</span><span class="s2">: [</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">, </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[[</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_stubs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH9204 wide_to_long call should not modify 'stubs' list</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s2">]])</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= [</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;inc1&quot;</span><span class="s2">, </span><span class="s4">&quot;inc2&quot;</span><span class="s2">, </span><span class="s4">&quot;edu1&quot;</span><span class="s2">, </span><span class="s4">&quot;edu2&quot;</span><span class="s2">]</span>
        <span class="s1">stubs </span><span class="s2">= [</span><span class="s4">&quot;inc&quot;</span><span class="s2">, </span><span class="s4">&quot;edu&quot;</span><span class="s2">]</span>

        <span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">stubs</span><span class="s2">, </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;age&quot;</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">stubs </span><span class="s2">== [</span><span class="s4">&quot;inc&quot;</span><span class="s2">, </span><span class="s4">&quot;edu&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_separating_character</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH14779</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A.1970&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;c&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;A.1980&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;f&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;B.1970&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.7</span><span class="s2">},</span>
                <span class="s4">&quot;B.1980&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.1</span><span class="s2">},</span>
                <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">), </span><span class="s1">x</span><span class="s2">)),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">x</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">(),</span>
            <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;f&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;B&quot;</span><span class="s2">: [</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">, </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[[</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;.&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_escapable_characters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A(quarterly)1970&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;c&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;A(quarterly)1980&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s4">&quot;f&quot;</span><span class="s2">},</span>
                <span class="s4">&quot;B(quarterly)1970&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.7</span><span class="s2">},</span>
                <span class="s4">&quot;B(quarterly)1980&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.1</span><span class="s2">},</span>
                <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s3">3</span><span class="s2">), </span><span class="s1">x</span><span class="s2">)),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() + </span><span class="s1">x</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">(),</span>
            <span class="s4">&quot;A(quarterly)&quot;</span><span class="s2">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">, </span><span class="s4">&quot;f&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;B(quarterly)&quot;</span><span class="s2">: [</span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">, </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">1.3</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1970</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">, </span><span class="s3">1980</span><span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[</span>
            <span class="s2">[</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;A(quarterly)&quot;</span><span class="s2">, </span><span class="s4">&quot;B(quarterly)&quot;</span><span class="s2">]</span>
        <span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A(quarterly)&quot;</span><span class="s2">, </span><span class="s4">&quot;B(quarterly)&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unbalanced</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># test that we can have a varying amount of time variables</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A2010&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;A2011&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
                <span class="s4">&quot;B2010&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;X&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;X&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
            <span class="s4">&quot;B&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s3">2010</span><span class="s2">, </span><span class="s3">2010</span><span class="s2">, </span><span class="s3">2011</span><span class="s2">, </span><span class="s3">2011</span><span class="s2">],</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[[</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_character_overlap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test we handle overlapping characters in both id_vars and value_vars</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A11&quot;</span><span class="s2">: [</span><span class="s4">&quot;a11&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a33&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;A12&quot;</span><span class="s2">: [</span><span class="s4">&quot;a21&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;B11&quot;</span><span class="s2">: [</span><span class="s4">&quot;b11&quot;</span><span class="s2">, </span><span class="s4">&quot;b12&quot;</span><span class="s2">, </span><span class="s4">&quot;b13&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;B12&quot;</span><span class="s2">: [</span><span class="s4">&quot;b21&quot;</span><span class="s2">, </span><span class="s4">&quot;b22&quot;</span><span class="s2">, </span><span class="s4">&quot;b23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;BB11&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                <span class="s4">&quot;BB12&quot;</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                <span class="s4">&quot;BBBX&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
                <span class="s4">&quot;BBBZ&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;BBBX&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">, </span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
                <span class="s4">&quot;BBBZ&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">, </span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;a11&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a33&quot;</span><span class="s2">, </span><span class="s4">&quot;a21&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">&quot;b11&quot;</span><span class="s2">, </span><span class="s4">&quot;b12&quot;</span><span class="s2">, </span><span class="s4">&quot;b13&quot;</span><span class="s2">, </span><span class="s4">&quot;b21&quot;</span><span class="s2">, </span><span class="s4">&quot;b22&quot;</span><span class="s2">, </span><span class="s4">&quot;b23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;BB&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s3">11</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">12</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[[</span><span class="s4">&quot;BBBX&quot;</span><span class="s2">, </span><span class="s4">&quot;BBBZ&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;BB&quot;</span><span class="s2">]]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;BB&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_separator</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># if an invalid separator is supplied a empty data frame is returned</span>
        <span class="s1">sep </span><span class="s2">= </span><span class="s4">&quot;nope!&quot;</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A2010&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;A2011&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
                <span class="s4">&quot;B2010&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;X&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;A2010&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;A2011&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;B2010&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;A&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;B&quot;</span><span class="s2">: [],</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">({</span><span class="s4">&quot;year&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">})</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[</span>
            <span class="s2">[</span><span class="s4">&quot;X&quot;</span><span class="s2">, </span><span class="s4">&quot;A2010&quot;</span><span class="s2">, </span><span class="s4">&quot;A2011&quot;</span><span class="s2">, </span><span class="s4">&quot;B2010&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">]</span>
        <span class="s2">]</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">set_levels</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">level</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s1">sep</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_num_string_disambiguation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test that we can disambiguate number value_vars from</span>
        <span class="s5"># string value_vars</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A11&quot;</span><span class="s2">: [</span><span class="s4">&quot;a11&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a33&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;A12&quot;</span><span class="s2">: [</span><span class="s4">&quot;a21&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;B11&quot;</span><span class="s2">: [</span><span class="s4">&quot;b11&quot;</span><span class="s2">, </span><span class="s4">&quot;b12&quot;</span><span class="s2">, </span><span class="s4">&quot;b13&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;B12&quot;</span><span class="s2">: [</span><span class="s4">&quot;b21&quot;</span><span class="s2">, </span><span class="s4">&quot;b22&quot;</span><span class="s2">, </span><span class="s4">&quot;b23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;BB11&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                <span class="s4">&quot;BB12&quot;</span><span class="s2">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                <span class="s4">&quot;Arating&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
                <span class="s4">&quot;Arating_old&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;Arating&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">, </span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
                <span class="s4">&quot;Arating_old&quot;</span><span class="s2">: [</span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">, </span><span class="s3">91</span><span class="s2">, </span><span class="s3">92</span><span class="s2">, </span><span class="s3">93</span><span class="s2">],</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;a11&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a33&quot;</span><span class="s2">, </span><span class="s4">&quot;a21&quot;</span><span class="s2">, </span><span class="s4">&quot;a22&quot;</span><span class="s2">, </span><span class="s4">&quot;a23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">&quot;b11&quot;</span><span class="s2">, </span><span class="s4">&quot;b12&quot;</span><span class="s2">, </span><span class="s4">&quot;b13&quot;</span><span class="s2">, </span><span class="s4">&quot;b21&quot;</span><span class="s2">, </span><span class="s4">&quot;b22&quot;</span><span class="s2">, </span><span class="s4">&quot;b23&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;BB&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">],</span>
                <span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                <span class="s4">&quot;year&quot;</span><span class="s2">: [</span><span class="s3">11</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">12</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])[</span>
            <span class="s2">[</span><span class="s4">&quot;Arating&quot;</span><span class="s2">, </span><span class="s4">&quot;Arating_old&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;BB&quot;</span><span class="s2">]</span>
        <span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">, </span><span class="s4">&quot;BB&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_invalid_suffixtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># If all stubs names end with a string, but a numeric suffix is</span>
        <span class="s5"># assumed,  an empty data frame is returned</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;Aone&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;Atwo&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
                <span class="s4">&quot;Bone&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;X&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s4">&quot;id&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span>
        <span class="s1">exp_data </span><span class="s2">= {</span>
            <span class="s4">&quot;X&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;Aone&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;Atwo&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;Bone&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;id&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;year&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;A&quot;</span><span class="s2">: [],</span>
            <span class="s4">&quot;B&quot;</span><span class="s2">: [],</span>
        <span class="s2">}</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">exp_data</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">({</span><span class="s4">&quot;year&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;year&quot;</span><span class="s2">])</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">set_levels</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">level</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;year&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">sort_index</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_multiple_id_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Taken from http://www.ats.ucla.edu/stat/stata/modules/reshapel.htm</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;famid&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                <span class="s4">&quot;birth&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                <span class="s4">&quot;ht1&quot;</span><span class="s2">: [</span><span class="s3">2.8</span><span class="s2">, </span><span class="s3">2.9</span><span class="s2">, </span><span class="s3">2.2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1.8</span><span class="s2">, </span><span class="s3">1.9</span><span class="s2">, </span><span class="s3">2.2</span><span class="s2">, </span><span class="s3">2.3</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">],</span>
                <span class="s4">&quot;ht2&quot;</span><span class="s2">: [</span><span class="s3">3.4</span><span class="s2">, </span><span class="s3">3.8</span><span class="s2">, </span><span class="s3">2.9</span><span class="s2">, </span><span class="s3">3.2</span><span class="s2">, </span><span class="s3">2.8</span><span class="s2">, </span><span class="s3">2.4</span><span class="s2">, </span><span class="s3">3.3</span><span class="s2">, </span><span class="s3">3.4</span><span class="s2">, </span><span class="s3">2.9</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;ht&quot;</span><span class="s2">: [</span>
                    <span class="s3">2.8</span><span class="s2">,</span>
                    <span class="s3">3.4</span><span class="s2">,</span>
                    <span class="s3">2.9</span><span class="s2">,</span>
                    <span class="s3">3.8</span><span class="s2">,</span>
                    <span class="s3">2.2</span><span class="s2">,</span>
                    <span class="s3">2.9</span><span class="s2">,</span>
                    <span class="s3">2.0</span><span class="s2">,</span>
                    <span class="s3">3.2</span><span class="s2">,</span>
                    <span class="s3">1.8</span><span class="s2">,</span>
                    <span class="s3">2.8</span><span class="s2">,</span>
                    <span class="s3">1.9</span><span class="s2">,</span>
                    <span class="s3">2.4</span><span class="s2">,</span>
                    <span class="s3">2.2</span><span class="s2">,</span>
                    <span class="s3">3.3</span><span class="s2">,</span>
                    <span class="s3">2.3</span><span class="s2">,</span>
                    <span class="s3">3.4</span><span class="s2">,</span>
                    <span class="s3">2.1</span><span class="s2">,</span>
                    <span class="s3">2.9</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s4">&quot;famid&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                <span class="s4">&quot;birth&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">],</span>
                <span class="s4">&quot;age&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;famid&quot;</span><span class="s2">, </span><span class="s4">&quot;birth&quot;</span><span class="s2">, </span><span class="s4">&quot;age&quot;</span><span class="s2">])[[</span><span class="s4">&quot;ht&quot;</span><span class="s2">]]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s4">&quot;ht&quot;</span><span class="s2">, </span><span class="s1">i</span><span class="s2">=[</span><span class="s4">&quot;famid&quot;</span><span class="s2">, </span><span class="s4">&quot;birth&quot;</span><span class="s2">], </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;age&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_unique_idvars</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH16382</span>
        <span class="s5"># Raise an error message if non unique id vars (i) are passed</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;A_A1&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], </span><span class="s4">&quot;B_B1&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">], </span><span class="s4">&quot;x&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">]}</span>
        <span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;the id variables need to uniquely identify each row&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A_A&quot;</span><span class="s2">, </span><span class="s4">&quot;B_B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;colname&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cast_j_int</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;actor_1&quot;</span><span class="s2">: [</span><span class="s4">&quot;CCH Pounder&quot;</span><span class="s2">, </span><span class="s4">&quot;Johnny Depp&quot;</span><span class="s2">, </span><span class="s4">&quot;Christoph Waltz&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;actor_2&quot;</span><span class="s2">: [</span><span class="s4">&quot;Joel David Moore&quot;</span><span class="s2">, </span><span class="s4">&quot;Orlando Bloom&quot;</span><span class="s2">, </span><span class="s4">&quot;Rory Kinnear&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;actor_fb_likes_1&quot;</span><span class="s2">: [</span><span class="s3">1000.0</span><span class="s2">, </span><span class="s3">40000.0</span><span class="s2">, </span><span class="s3">11000.0</span><span class="s2">],</span>
                <span class="s4">&quot;actor_fb_likes_2&quot;</span><span class="s2">: [</span><span class="s3">936.0</span><span class="s2">, </span><span class="s3">5000.0</span><span class="s2">, </span><span class="s3">393.0</span><span class="s2">],</span>
                <span class="s4">&quot;title&quot;</span><span class="s2">: [</span><span class="s4">&quot;Avatar&quot;</span><span class="s2">, </span><span class="s4">&quot;Pirates of the Caribbean&quot;</span><span class="s2">, </span><span class="s4">&quot;Spectre&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;actor&quot;</span><span class="s2">: [</span>
                    <span class="s4">&quot;CCH Pounder&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Johnny Depp&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Christoph Waltz&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Joel David Moore&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Orlando Bloom&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Rory Kinnear&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
                <span class="s4">&quot;actor_fb_likes&quot;</span><span class="s2">: [</span><span class="s3">1000.0</span><span class="s2">, </span><span class="s3">40000.0</span><span class="s2">, </span><span class="s3">11000.0</span><span class="s2">, </span><span class="s3">936.0</span><span class="s2">, </span><span class="s3">5000.0</span><span class="s2">, </span><span class="s3">393.0</span><span class="s2">],</span>
                <span class="s4">&quot;num&quot;</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">],</span>
                <span class="s4">&quot;title&quot;</span><span class="s2">: [</span>
                    <span class="s4">&quot;Avatar&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Pirates of the Caribbean&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Spectre&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Avatar&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Pirates of the Caribbean&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Spectre&quot;</span><span class="s2">,</span>
                <span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s4">&quot;num&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;actor&quot;</span><span class="s2">, </span><span class="s4">&quot;actor_fb_likes&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;title&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;num&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;_&quot;</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_identical_stubnames</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A2010&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;A2011&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
                <span class="s4">&quot;B2010&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;stubname can't be identical to a column name&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;colname&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nonnumeric_suffix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;treatment_placebo&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;treatment_test&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
                <span class="s4">&quot;result_placebo&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;colname&quot;</span><span class="s2">: [</span><span class="s4">&quot;placebo&quot;</span><span class="s2">, </span><span class="s4">&quot;placebo&quot;</span><span class="s2">, </span><span class="s4">&quot;test&quot;</span><span class="s2">, </span><span class="s4">&quot;test&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;result&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s4">&quot;treatment&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;colname&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;result&quot;</span><span class="s2">, </span><span class="s4">&quot;treatment&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;colname&quot;</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">=</span><span class="s4">&quot;[a-z]+&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;_&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mixed_type_suffix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;result_1&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">9</span><span class="s2">],</span>
                <span class="s4">&quot;result_foo&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;treatment_1&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;treatment_foo&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;colname&quot;</span><span class="s2">: [</span><span class="s4">&quot;1&quot;</span><span class="s2">, </span><span class="s4">&quot;1&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;foo&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;result&quot;</span><span class="s2">: [</span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">9.0</span><span class="s2">, </span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;treatment&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">).</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;colname&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;result&quot;</span><span class="s2">, </span><span class="s4">&quot;treatment&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;colname&quot;</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">=</span><span class="s4">&quot;.+&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;_&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_float_suffix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;treatment_1.1&quot;</span><span class="s2">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">],</span>
                <span class="s4">&quot;treatment_2.1&quot;</span><span class="s2">: [</span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
                <span class="s4">&quot;result_1.2&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">],</span>
                <span class="s4">&quot;result_1&quot;</span><span class="s2">: [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">9</span><span class="s2">],</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s4">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">, </span><span class="s4">&quot;X1&quot;</span><span class="s2">, </span><span class="s4">&quot;X2&quot;</span><span class="s2">],</span>
                <span class="s4">&quot;colname&quot;</span><span class="s2">: [</span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">1.2</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">, </span><span class="s3">2.1</span><span class="s2">],</span>
                <span class="s4">&quot;result&quot;</span><span class="s2">: [</span><span class="s3">5.0</span><span class="s2">, </span><span class="s3">6.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">9.0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">],</span>
                <span class="s4">&quot;treatment&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s2">, </span><span class="s3">4.0</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">([</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;colname&quot;</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">, [</span><span class="s4">&quot;result&quot;</span><span class="s2">, </span><span class="s4">&quot;treatment&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;colname&quot;</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">=</span><span class="s4">&quot;[0-9.]+&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;_&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_col_substring_of_stubname</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH22468</span>
        <span class="s5"># Don't raise ValueError when a column name is a substring</span>
        <span class="s5"># of a stubname that's been passed as a string</span>
        <span class="s1">wide_data </span><span class="s2">= {</span>
            <span class="s4">&quot;node_id&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">: </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">: </span><span class="s3">4</span><span class="s2">},</span>
            <span class="s4">&quot;A&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">0.80</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">3</span><span class="s2">: </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">: </span><span class="s3">0.81</span><span class="s2">},</span>
            <span class="s4">&quot;PA0&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">0.74</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">0.56</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.56</span><span class="s2">, </span><span class="s3">3</span><span class="s2">: </span><span class="s3">0.98</span><span class="s2">, </span><span class="s3">4</span><span class="s2">: </span><span class="s3">0.6</span><span class="s2">},</span>
            <span class="s4">&quot;PA1&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">0.77</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">0.64</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.52</span><span class="s2">, </span><span class="s3">3</span><span class="s2">: </span><span class="s3">0.98</span><span class="s2">, </span><span class="s3">4</span><span class="s2">: </span><span class="s3">0.67</span><span class="s2">},</span>
            <span class="s4">&quot;PA3&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">0.34</span><span class="s2">, </span><span class="s3">1</span><span class="s2">: </span><span class="s3">0.70</span><span class="s2">, </span><span class="s3">2</span><span class="s2">: </span><span class="s3">0.52</span><span class="s2">, </span><span class="s3">3</span><span class="s2">: </span><span class="s3">0.98</span><span class="s2">, </span><span class="s3">4</span><span class="s2">: </span><span class="s3">0.67</span><span class="s2">},</span>
        <span class="s2">}</span>
        <span class="s1">wide_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_dict</span><span class="s2">(</span><span class="s1">wide_data</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">wide_df</span><span class="s2">, </span><span class="s1">stubnames</span><span class="s2">=[</span><span class="s4">&quot;PA&quot;</span><span class="s2">], </span><span class="s1">i</span><span class="s2">=[</span><span class="s4">&quot;node_id&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">], </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span><span class="s1">wide_df</span><span class="s2">, </span><span class="s1">stubnames</span><span class="s2">=</span><span class="s4">&quot;PA&quot;</span><span class="s2">, </span><span class="s1">i</span><span class="s2">=[</span><span class="s4">&quot;node_id&quot;</span><span class="s2">, </span><span class="s4">&quot;A&quot;</span><span class="s2">], </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;time&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_raise_of_column_name_value</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH34731, enforced in 2.0</span>
        <span class="s5"># raise a ValueError if the resultant value column name matches</span>
        <span class="s5"># a name in the dataframe already (default name is &quot;value&quot;)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;col&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s4">&quot;ABC&quot;</span><span class="s2">), </span><span class="s4">&quot;value&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)})</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s4">&quot;value_name (value) cannot match&quot;</span><span class="s2">)</span>
        <span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">melt</span><span class="s2">(</span><span class="s1">id_vars</span><span class="s2">=</span><span class="s4">&quot;value&quot;</span><span class="s2">, </span><span class="s1">value_name</span><span class="s2">=</span><span class="s4">&quot;value&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s4">&quot;O&quot;</span><span class="s2">, </span><span class="s4">&quot;string&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_missing_stubname</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5"># GH46044</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s4">&quot;id&quot;</span><span class="s2">: [</span><span class="s4">&quot;1&quot;</span><span class="s2">, </span><span class="s4">&quot;2&quot;</span><span class="s2">], </span><span class="s4">&quot;a-1&quot;</span><span class="s2">: [</span><span class="s3">100</span><span class="s2">, </span><span class="s3">200</span><span class="s2">], </span><span class="s4">&quot;a-2&quot;</span><span class="s2">: [</span><span class="s3">300</span><span class="s2">, </span><span class="s3">400</span><span class="s2">]})</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s4">&quot;id&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">,</span>
            <span class="s1">stubnames</span><span class="s2">=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">],</span>
            <span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;id&quot;</span><span class="s2">,</span>
            <span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;num&quot;</span><span class="s2">,</span>
            <span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;-&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">(</span>
            <span class="s2">[(</span><span class="s4">&quot;1&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s4">&quot;2&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), (</span><span class="s4">&quot;1&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">), (</span><span class="s4">&quot;2&quot;</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)],</span>
            <span class="s1">name</span><span class="s2">=(</span><span class="s4">&quot;id&quot;</span><span class="s2">, </span><span class="s4">&quot;num&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">100</span><span class="s2">, </span><span class="s3">200</span><span class="s2">, </span><span class="s3">300</span><span class="s2">, </span><span class="s3">400</span><span class="s2">], </span><span class="s4">&quot;b&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">] * </span><span class="s3">4</span><span class="s2">},</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">new_level </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">levels</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">set_levels</span><span class="s2">(</span><span class="s1">new_level</span><span class="s2">, </span><span class="s1">level</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_wide_to_long_pyarrow_string_columns</span><span class="s2">():</span>
    <span class="s5"># GH 57066</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s4">&quot;pyarrow&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s4">&quot;ID&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1</span><span class="s2">},</span>
            <span class="s4">&quot;R_test1&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1</span><span class="s2">},</span>
            <span class="s4">&quot;R_test2&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1</span><span class="s2">},</span>
            <span class="s4">&quot;R_test3&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">2</span><span class="s2">},</span>
            <span class="s4">&quot;D&quot;</span><span class="s2">: {</span><span class="s3">0</span><span class="s2">: </span><span class="s3">1</span><span class="s2">},</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">columns </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s4">&quot;string[pyarrow_numpy]&quot;</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">wide_to_long</span><span class="s2">(</span>
        <span class="s1">df</span><span class="s2">, </span><span class="s1">stubnames</span><span class="s2">=</span><span class="s4">&quot;R&quot;</span><span class="s2">, </span><span class="s1">i</span><span class="s2">=</span><span class="s4">&quot;ID&quot;</span><span class="s2">, </span><span class="s1">j</span><span class="s2">=</span><span class="s4">&quot;UNPIVOTED&quot;</span><span class="s2">, </span><span class="s1">sep</span><span class="s2">=</span><span class="s4">&quot;_&quot;</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">=</span><span class="s4">&quot;.*&quot;</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">]],</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;D&quot;</span><span class="s2">, </span><span class="s4">&quot;R&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">],</span>
                <span class="s1">Index</span><span class="s2">([</span><span class="s4">&quot;test1&quot;</span><span class="s2">, </span><span class="s4">&quot;test2&quot;</span><span class="s2">, </span><span class="s4">&quot;test3&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s4">&quot;string[pyarrow_numpy]&quot;</span><span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s1">names</span><span class="s2">=[</span><span class="s4">&quot;ID&quot;</span><span class="s2">, </span><span class="s4">&quot;UNPIVOTED&quot;</span><span class="s2">],</span>
        <span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>