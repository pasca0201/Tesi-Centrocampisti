<html>
<head>
<title>test_cbook.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_cbook.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">pickle</span>

<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span>
<span class="s0">from </span><span class="s1">unittest</span><span class="s2">.</span><span class="s1">mock </span><span class="s0">import </span><span class="s1">patch</span><span class="s2">, </span><span class="s1">Mock</span>

<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">datetime</span><span class="s2">, </span><span class="s1">date</span><span class="s2">, </span><span class="s1">timedelta</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s2">(</span><span class="s1">assert_array_equal</span><span class="s2">, </span><span class="s1">assert_approx_equal</span><span class="s2">,</span>
                           <span class="s1">assert_array_almost_equal</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">_api</span><span class="s2">, </span><span class="s1">cbook</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">colors </span><span class="s0">as </span><span class="s1">mcolors</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">cbook </span><span class="s0">import </span><span class="s1">delete_masked_points</span><span class="s2">, </span><span class="s1">strip_math</span>
<span class="s0">from </span><span class="s1">types </span><span class="s0">import </span><span class="s1">ModuleType</span>


<span class="s0">class </span><span class="s1">Test_delete_masked_points</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_bad_first_arg</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">delete_masked_points</span><span class="s2">(</span><span class="s3">'a string'</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_string_seq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a1 </span><span class="s2">= [</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'d'</span><span class="s2">, </span><span class="s3">'e'</span><span class="s2">, </span><span class="s3">'f'</span><span class="s2">]</span>
        <span class="s1">a2 </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]</span>
        <span class="s1">result1</span><span class="s2">, </span><span class="s1">result2 </span><span class="s2">= </span><span class="s1">delete_masked_points</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">, </span><span class="s1">a2</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a1</span><span class="s2">)[</span><span class="s1">ind</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">result2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">a2</span><span class="s2">)[</span><span class="s1">ind</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_datetime</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">dates </span><span class="s2">= [</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2008</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2008</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">),</span>
                 <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2008</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2008</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">),</span>
                 <span class="s1">datetime</span><span class="s2">(</span><span class="s4">2008</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2008</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)]</span>
        <span class="s1">a_masked </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                               <span class="s1">mask</span><span class="s2">=[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">delete_masked_points</span><span class="s2">(</span><span class="s1">dates</span><span class="s2">, </span><span class="s1">a_masked</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">dates</span><span class="s2">)[</span><span class="s1">ind</span><span class="s2">])</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">a_masked</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">].</span><span class="s1">compressed</span><span class="s2">())</span>

    <span class="s0">def </span><span class="s1">test_rgba</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">a_masked </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ma</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                               <span class="s1">mask</span><span class="s2">=[</span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
        <span class="s1">a_rgba </span><span class="s2">= </span><span class="s1">mcolors</span><span class="s2">.</span><span class="s1">to_rgba_array</span><span class="s2">([</span><span class="s3">'r'</span><span class="s2">, </span><span class="s3">'g'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'m'</span><span class="s2">, </span><span class="s3">'y'</span><span class="s2">])</span>
        <span class="s1">actual </span><span class="s2">= </span><span class="s1">delete_masked_points</span><span class="s2">(</span><span class="s1">a_masked</span><span class="s2">, </span><span class="s1">a_rgba</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">a_masked</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">].</span><span class="s1">compressed</span><span class="s2">())</span>
        <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">a_rgba</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">])</span>


<span class="s0">class </span><span class="s1">Test_boxplot_stats</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">937</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">nrows </span><span class="s2">= </span><span class="s4">37</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ncols </span><span class="s2">= </span><span class="s4">4</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">lognormal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">nrows</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ncols</span><span class="s2">),</span>
                                        <span class="s1">mean</span><span class="s2">=</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">sigma</span><span class="s2">=</span><span class="s4">1.75</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">known_keys </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">([</span>
            <span class="s3">'mean'</span><span class="s2">, </span><span class="s3">'med'</span><span class="s2">, </span><span class="s3">'q1'</span><span class="s2">, </span><span class="s3">'q3'</span><span class="s2">, </span><span class="s3">'iqr'</span><span class="s2">,</span>
            <span class="s3">'cilo'</span><span class="s2">, </span><span class="s3">'cihi'</span><span class="s2">, </span><span class="s3">'whislo'</span><span class="s2">, </span><span class="s3">'whishi'</span><span class="s2">,</span>
            <span class="s3">'fliers'</span><span class="s2">, </span><span class="s3">'label'</span>
        <span class="s2">])</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">std_results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">known_nonbootstrapped_res </span><span class="s2">= {</span>
            <span class="s3">'cihi'</span><span class="s2">: </span><span class="s4">6.8161283264444847</span><span class="s2">,</span>
            <span class="s3">'cilo'</span><span class="s2">: -</span><span class="s4">0.1489815330368689</span><span class="s2">,</span>
            <span class="s3">'iqr'</span><span class="s2">: </span><span class="s4">13.492709959447094</span><span class="s2">,</span>
            <span class="s3">'mean'</span><span class="s2">: </span><span class="s4">13.00447442387868</span><span class="s2">,</span>
            <span class="s3">'med'</span><span class="s2">: </span><span class="s4">3.3335733967038079</span><span class="s2">,</span>
            <span class="s3">'fliers'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span>
                <span class="s4">92.55467075</span><span class="s2">,  </span><span class="s4">87.03819018</span><span class="s2">,  </span><span class="s4">42.23204914</span><span class="s2">,  </span><span class="s4">39.29390996</span>
            <span class="s2">]),</span>
            <span class="s3">'q1'</span><span class="s2">: </span><span class="s4">1.3597529879465153</span><span class="s2">,</span>
            <span class="s3">'q3'</span><span class="s2">: </span><span class="s4">14.85246294739361</span><span class="s2">,</span>
            <span class="s3">'whishi'</span><span class="s2">: </span><span class="s4">27.899688243699629</span><span class="s2">,</span>
            <span class="s3">'whislo'</span><span class="s2">: </span><span class="s4">0.042143774965502923</span>
        <span class="s2">}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">known_bootstrapped_ci </span><span class="s2">= {</span>
            <span class="s3">'cihi'</span><span class="s2">: </span><span class="s4">8.939577523357828</span><span class="s2">,</span>
            <span class="s3">'cilo'</span><span class="s2">: </span><span class="s4">1.8692703958676578</span><span class="s2">,</span>
        <span class="s2">}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">known_whis3_res </span><span class="s2">= {</span>
            <span class="s3">'whishi'</span><span class="s2">: </span><span class="s4">42.232049135969874</span><span class="s2">,</span>
            <span class="s3">'whislo'</span><span class="s2">: </span><span class="s4">0.042143774965502923</span><span class="s2">,</span>
            <span class="s3">'fliers'</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">92.55467075</span><span class="s2">, </span><span class="s4">87.03819018</span><span class="s2">]),</span>
        <span class="s2">}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">known_res_percentiles </span><span class="s2">= {</span>
            <span class="s3">'whislo'</span><span class="s2">:   </span><span class="s4">0.1933685896907924</span><span class="s2">,</span>
            <span class="s3">'whishi'</span><span class="s2">:  </span><span class="s4">42.232049135969874</span>
        <span class="s2">}</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">known_res_range </span><span class="s2">= {</span>
            <span class="s3">'whislo'</span><span class="s2">: </span><span class="s4">0.042143774965502923</span><span class="s2">,</span>
            <span class="s3">'whishi'</span><span class="s2">: </span><span class="s4">92.554670752188699</span>

        <span class="s2">}</span>

    <span class="s0">def </span><span class="s1">test_form_main_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">std_results</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_form_each_dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">std_results</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_form_dict_keys</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">std_results</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) &lt;= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">known_keys</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_results_baseline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">std_results</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">known_nonbootstrapped_res</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_results_bootstrapped</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">bootstrap</span><span class="s2">=</span><span class="s4">10000</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">known_bootstrapped_ci</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">assert_approx_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_results_whiskers_float</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">whis</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">known_whis3_res</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_results_whiskers_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">whis</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">100</span><span class="s2">])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">known_res_range</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_results_whiskers_percentiles</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">whis</span><span class="s2">=[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">95</span><span class="s2">])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">results</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">known_res_percentiles</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">value</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_results_withlabels</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">labels </span><span class="s2">= [</span><span class="s3">'Test1'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s3">'Aardvark'</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">lab</span><span class="s2">, </span><span class="s1">res </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">labels</span><span class="s2">, </span><span class="s1">results</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s3">'label'</span><span class="s2">] == </span><span class="s1">lab</span>

        <span class="s1">results </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">res </span><span class="s0">in </span><span class="s1">results</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s3">'label' </span><span class="s0">not in </span><span class="s1">res</span>

    <span class="s0">def </span><span class="s1">test_label_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">labels </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">labels</span><span class="s2">=</span><span class="s1">labels</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bad_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">34</span><span class="s2">, </span><span class="s4">34</span><span class="s2">, </span><span class="s4">34</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_boxplot_stats_autorange_false</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">=</span><span class="s4">140</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">hstack</span><span class="s2">([-</span><span class="s4">25</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s4">25</span><span class="s2">])</span>
        <span class="s1">bstats_false </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">autorange</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">bstats_true </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">boxplot_stats</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">autorange</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">bstats_false</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s3">'whislo'</span><span class="s2">] == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">bstats_false</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s3">'whishi'</span><span class="s2">] == </span><span class="s4">0</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">bstats_false</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s3">'fliers'</span><span class="s2">], [-</span><span class="s4">25</span><span class="s2">, </span><span class="s4">25</span><span class="s2">])</span>

        <span class="s0">assert </span><span class="s1">bstats_true</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s3">'whislo'</span><span class="s2">] == -</span><span class="s4">25</span>
        <span class="s0">assert </span><span class="s1">bstats_true</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s3">'whishi'</span><span class="s2">] == </span><span class="s4">25</span>
        <span class="s1">assert_array_almost_equal</span><span class="s2">(</span><span class="s1">bstats_true</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s3">'fliers'</span><span class="s2">], [])</span>


<span class="s0">class </span><span class="s1">Test_callback_registry</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">signal </span><span class="s2">= </span><span class="s3">'test'</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">pickle</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">_connect_picklable</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">disconnect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cid</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">disconnect</span><span class="s2">(</span><span class="s1">cid</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">count</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">count1 </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">_func_cid_map</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, []))</span>
        <span class="s1">count2 </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">count1 </span><span class="s2">== </span><span class="s1">count2</span>
        <span class="s0">return </span><span class="s1">count1</span>

    <span class="s0">def </span><span class="s1">is_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">_func_cid_map </span><span class="s2">== {}</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">callbacks </span><span class="s2">== {}</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">_pickled_cids </span><span class="s2">== </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">is_not_empty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">break_cycles</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">_func_cid_map </span><span class="s2">!= {}</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">callbacks </span><span class="s2">!= {}</span>

    <span class="s0">def </span><span class="s1">test_cid_restore</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">cb </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">()</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">cb2 </span><span class="s2">= </span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">cb</span><span class="s2">))</span>
        <span class="s1">cid </span><span class="s2">= </span><span class="s1">cb2</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">'c'</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">cid </span><span class="s2">== </span><span class="s4">1</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'pickle'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_callback_complete</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">):</span>
        <span class="s5"># ensure we start with an empty registry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

        <span class="s5"># create a class for testing</span>
        <span class="s1">mini_me </span><span class="s2">= </span><span class="s1">Test_callback_registry</span><span class="s2">()</span>

        <span class="s5"># test that we can add a callback</span>
        <span class="s1">cid1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">cid1</span><span class="s2">) </span><span class="s0">is </span><span class="s1">int</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_not_empty</span><span class="s2">()</span>

        <span class="s5"># test that we don't add a second callback</span>
        <span class="s1">cid2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">cid1 </span><span class="s2">== </span><span class="s1">cid2</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_not_empty</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">_func_cid_map</span><span class="s2">) == </span><span class="s4">1</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">.</span><span class="s1">callbacks</span><span class="s2">) == </span><span class="s4">1</span>

        <span class="s0">del </span><span class="s1">mini_me</span>

        <span class="s5"># check we now have no callbacks registered</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'pickle'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_callback_disconnect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">):</span>
        <span class="s5"># ensure we start with an empty registry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

        <span class="s5"># create a class for testing</span>
        <span class="s1">mini_me </span><span class="s2">= </span><span class="s1">Test_callback_registry</span><span class="s2">()</span>

        <span class="s5"># test that we can add a callback</span>
        <span class="s1">cid1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">cid1</span><span class="s2">) </span><span class="s0">is </span><span class="s1">int</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_not_empty</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">disconnect</span><span class="s2">(</span><span class="s1">cid1</span><span class="s2">)</span>

        <span class="s5"># check we now have no callbacks registered</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'pickle'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_callback_wrong_disconnect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">):</span>
        <span class="s5"># ensure we start with an empty registry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

        <span class="s5"># create a class for testing</span>
        <span class="s1">mini_me </span><span class="s2">= </span><span class="s1">Test_callback_registry</span><span class="s2">()</span>

        <span class="s5"># test that we can add a callback</span>
        <span class="s1">cid1 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">type</span><span class="s2">(</span><span class="s1">cid1</span><span class="s2">) </span><span class="s0">is </span><span class="s1">int</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_not_empty</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">disconnect</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">)</span>

        <span class="s5"># check we still have callbacks registered</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_not_empty</span><span class="s2">()</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'pickle'</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_registration_on_non_empty_registry</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">):</span>
        <span class="s5"># ensure we start with an empty registry</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

        <span class="s5"># setup the registry with a callback</span>
        <span class="s1">mini_me </span><span class="s2">= </span><span class="s1">Test_callback_registry</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>

        <span class="s5"># Add another callback</span>
        <span class="s1">mini_me2 </span><span class="s2">= </span><span class="s1">Test_callback_registry</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me2</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>

        <span class="s5"># Remove and add the second callback</span>
        <span class="s1">mini_me2 </span><span class="s2">= </span><span class="s1">Test_callback_registry</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">signal</span><span class="s2">, </span><span class="s1">mini_me2</span><span class="s2">.</span><span class="s1">dummy</span><span class="s2">, </span><span class="s1">pickle</span><span class="s2">)</span>

        <span class="s5"># We still have 2 references</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_not_empty</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">self</span><span class="s2">.</span><span class="s1">count</span><span class="s2">() == </span><span class="s4">2</span>

        <span class="s5"># Removing the last 2 references</span>
        <span class="s1">mini_me </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">mini_me2 </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">is_empty</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">dummy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">test_pickling</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">pickle</span><span class="s2">.</span><span class="s1">dumps</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">())),</span>
                       <span class="s3">&quot;callbacks&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_callbackregistry_default_exception_handler</span><span class="s2">(</span><span class="s1">capsys</span><span class="s2">, </span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">cb </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">()</span>
    <span class="s1">cb</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>

    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span>
        <span class="s1">cbook</span><span class="s2">, </span><span class="s3">&quot;_get_running_interactive_framework&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s3">&quot;argument mismatch&quot;</span><span class="s2">)</span>
    <span class="s1">outerr </span><span class="s2">= </span><span class="s1">capsys</span><span class="s2">.</span><span class="s1">readouterr</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">outerr</span><span class="s2">.</span><span class="s1">out </span><span class="s2">== </span><span class="s1">outerr</span><span class="s2">.</span><span class="s1">err </span><span class="s2">== </span><span class="s3">&quot;&quot;</span>

    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span>
        <span class="s1">cbook</span><span class="s2">, </span><span class="s3">&quot;_get_running_interactive_framework&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">&quot;not-none&quot;</span><span class="s2">)</span>
    <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s3">&quot;argument mismatch&quot;</span><span class="s2">)  </span><span class="s5"># No error in that case.</span>
    <span class="s1">outerr </span><span class="s2">= </span><span class="s1">capsys</span><span class="s2">.</span><span class="s1">readouterr</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">outerr</span><span class="s2">.</span><span class="s1">out </span><span class="s2">== </span><span class="s3">&quot;&quot;</span>
    <span class="s0">assert </span><span class="s3">&quot;takes 0 positional arguments but 1 was given&quot; </span><span class="s0">in </span><span class="s1">outerr</span><span class="s2">.</span><span class="s1">err</span>


<span class="s0">def </span><span class="s1">raising_cb_reg</span><span class="s2">(</span><span class="s1">func</span><span class="s2">):</span>
    <span class="s0">class </span><span class="s1">TestException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">raise_runtime_error</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">RuntimeError</span>

    <span class="s0">def </span><span class="s1">raise_value_error</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">ValueError</span>

    <span class="s0">def </span><span class="s1">transformer</span><span class="s2">(</span><span class="s1">excp</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">excp</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">):</span>
            <span class="s0">raise </span><span class="s1">TestException</span>
        <span class="s0">raise </span><span class="s1">excp</span>

    <span class="s5"># old default</span>
    <span class="s1">cb_old </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">(</span><span class="s1">exception_handler</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">cb_old</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s1">raise_runtime_error</span><span class="s2">)</span>

    <span class="s5"># filter</span>
    <span class="s1">cb_filt </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">(</span><span class="s1">exception_handler</span><span class="s2">=</span><span class="s1">transformer</span><span class="s2">)</span>
    <span class="s1">cb_filt</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s1">raise_runtime_error</span><span class="s2">)</span>

    <span class="s5"># filter</span>
    <span class="s1">cb_filt_pass </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">(</span><span class="s1">exception_handler</span><span class="s2">=</span><span class="s1">transformer</span><span class="s2">)</span>
    <span class="s1">cb_filt_pass</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">, </span><span class="s1">raise_value_error</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'cb, excp'</span><span class="s2">,</span>
                                   <span class="s2">[[</span><span class="s1">cb_old</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s1">cb_filt</span><span class="s2">, </span><span class="s1">TestException</span><span class="s2">],</span>
                                    <span class="s2">[</span><span class="s1">cb_filt_pass</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">]])(</span><span class="s1">func</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">raising_cb_reg</span>
<span class="s0">def </span><span class="s1">test_callbackregistry_custom_exception_handler</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">cb</span><span class="s2">, </span><span class="s1">excp</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setattr</span><span class="s2">(</span>
        <span class="s1">cbook</span><span class="s2">, </span><span class="s3">&quot;_get_running_interactive_framework&quot;</span><span class="s2">, </span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">excp</span><span class="s2">):</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">'foo'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_callbackregistry_signals</span><span class="s2">():</span>
    <span class="s1">cr </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">(</span><span class="s1">signals</span><span class="s2">=[</span><span class="s3">&quot;foo&quot;</span><span class="s2">])</span>
    <span class="s1">results </span><span class="s2">= []</span>
    <span class="s0">def </span><span class="s1">cb</span><span class="s2">(</span><span class="s1">x</span><span class="s2">): </span><span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">cr</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s1">cb</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">cr</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;bar&quot;</span><span class="s2">, </span><span class="s1">cb</span><span class="s2">)</span>
    <span class="s1">cr</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">cr</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">results </span><span class="s2">== [</span><span class="s4">1</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_callbackregistry_blocking</span><span class="s2">():</span>
    <span class="s5"># Needs an exception handler for interactive testing environments</span>
    <span class="s5"># that would only print this out instead of raising the exception</span>
    <span class="s0">def </span><span class="s1">raise_handler</span><span class="s2">(</span><span class="s1">excp</span><span class="s2">):</span>
        <span class="s0">raise </span><span class="s1">excp</span>
    <span class="s1">cb </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">CallbackRegistry</span><span class="s2">(</span><span class="s1">exception_handler</span><span class="s2">=</span><span class="s1">raise_handler</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_func1</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;1 should be blocked&quot;</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_func2</span><span class="s2">():</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;2 should be blocked&quot;</span><span class="s2">)</span>
    <span class="s1">cb</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;test1&quot;</span><span class="s2">, </span><span class="s1">test_func1</span><span class="s2">)</span>
    <span class="s1">cb</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;test2&quot;</span><span class="s2">, </span><span class="s1">test_func2</span><span class="s2">)</span>

    <span class="s5"># block all of the callbacks to make sure they aren't processed</span>
    <span class="s0">with </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">blocked</span><span class="s2">():</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;test1&quot;</span><span class="s2">)</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;test2&quot;</span><span class="s2">)</span>

    <span class="s5"># block individual callbacks to make sure the other is still processed</span>
    <span class="s0">with </span><span class="s1">cb</span><span class="s2">.</span><span class="s1">blocked</span><span class="s2">(</span><span class="s1">signal</span><span class="s2">=</span><span class="s3">&quot;test1&quot;</span><span class="s2">):</span>
        <span class="s5"># Blocked</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;test1&quot;</span><span class="s2">)</span>
        <span class="s5"># Should raise</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;2 should be blocked&quot;</span><span class="s2">):</span>
            <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;test2&quot;</span><span class="s2">)</span>

    <span class="s5"># Make sure the original callback functions are there after blocking</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;1 should be blocked&quot;</span><span class="s2">):</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;test1&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;2 should be blocked&quot;</span><span class="s2">):</span>
        <span class="s1">cb</span><span class="s2">.</span><span class="s1">process</span><span class="s2">(</span><span class="s3">&quot;test2&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'line, result'</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s3">'a : no_comment'</span><span class="s2">, </span><span class="s3">'a : no_comment'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : &quot;quoted str&quot;'</span><span class="s2">, </span><span class="s3">'a : &quot;quoted str&quot;'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : &quot;quoted str&quot; # comment'</span><span class="s2">, </span><span class="s3">'a : &quot;quoted str&quot;'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : &quot;#000000&quot;'</span><span class="s2">, </span><span class="s3">'a : &quot;#000000&quot;'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : &quot;#000000&quot; # comment'</span><span class="s2">, </span><span class="s3">'a : &quot;#000000&quot;'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : [&quot;#000000&quot;, &quot;#FFFFFF&quot;]'</span><span class="s2">, </span><span class="s3">'a : [&quot;#000000&quot;, &quot;#FFFFFF&quot;]'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : [&quot;#000000&quot;, &quot;#FFFFFF&quot;] # comment'</span><span class="s2">, </span><span class="s3">'a : [&quot;#000000&quot;, &quot;#FFFFFF&quot;]'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'a : val  # a comment &quot;with quotes&quot;'</span><span class="s2">, </span><span class="s3">'a : val'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'# only comment &quot;with quotes&quot; xx'</span><span class="s2">, </span><span class="s3">''</span><span class="s2">),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_strip_comment</span><span class="s2">(</span><span class="s1">line</span><span class="s2">, </span><span class="s1">result</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Strip everything from the first unquoted #.&quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_strip_comment</span><span class="s2">(</span><span class="s1">line</span><span class="s2">) == </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_strip_comment_invalid</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Missing closing quote&quot;</span><span class="s2">):</span>
        <span class="s1">cbook</span><span class="s2">.</span><span class="s1">_strip_comment</span><span class="s2">(</span><span class="s3">'grid.color: &quot;aa'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sanitize_sequence</span><span class="s2">():</span>
    <span class="s1">d </span><span class="s2">= {</span><span class="s3">'a'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}</span>
    <span class="s1">k </span><span class="s2">= [</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">]</span>
    <span class="s1">v </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
    <span class="s1">i </span><span class="s2">= [(</span><span class="s3">'a'</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s3">'b'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s3">'c'</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">k </span><span class="s2">== </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">sanitize_sequence</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()))</span>
    <span class="s0">assert </span><span class="s1">v </span><span class="s2">== </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">sanitize_sequence</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()))</span>
    <span class="s0">assert </span><span class="s1">i </span><span class="s2">== </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">sanitize_sequence</span><span class="s2">(</span><span class="s1">d</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()))</span>
    <span class="s0">assert </span><span class="s1">i </span><span class="s2">== </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">sanitize_sequence</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">k </span><span class="s2">== </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">sanitize_sequence</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>


<span class="s1">fail_mapping</span><span class="s2">: </span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">dict</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">], ...] = (</span>
    <span class="s2">({</span><span class="s3">'a'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s3">'alias_mapping'</span><span class="s2">: {</span><span class="s3">'a'</span><span class="s2">: [</span><span class="s3">'b'</span><span class="s2">]}}),</span>
    <span class="s2">({</span><span class="s3">'a'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s3">'alias_mapping'</span><span class="s2">: {</span><span class="s3">'a'</span><span class="s2">: [</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">]}}),</span>
<span class="s2">)</span>

<span class="s1">pass_mapping</span><span class="s2">: </span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">], ...] = (</span>
    <span class="s2">(</span><span class="s0">None</span><span class="s2">, {}, {}),</span>
    <span class="s2">({</span><span class="s3">'a'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s3">'a'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {}),</span>
    <span class="s2">({</span><span class="s3">'b'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s3">'a'</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}, {</span><span class="s3">'alias_mapping'</span><span class="s2">: {</span><span class="s3">'a'</span><span class="s2">: [</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">]}}),</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'inp, kwargs_to_norm'</span><span class="s2">, </span><span class="s1">fail_mapping</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_normalize_kwargs_fail</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">kwargs_to_norm</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">), </span><span class="s1">\</span>
         <span class="s1">_api</span><span class="s2">.</span><span class="s1">suppress_matplotlib_deprecation_warning</span><span class="s2">():</span>
        <span class="s1">cbook</span><span class="s2">.</span><span class="s1">normalize_kwargs</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, **</span><span class="s1">kwargs_to_norm</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'inp, expected, kwargs_to_norm'</span><span class="s2">,</span>
                         <span class="s1">pass_mapping</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_normalize_kwargs_pass</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">kwargs_to_norm</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">_api</span><span class="s2">.</span><span class="s1">suppress_matplotlib_deprecation_warning</span><span class="s2">():</span>
        <span class="s5"># No other warning should be emitted.</span>
        <span class="s0">assert </span><span class="s1">expected </span><span class="s2">== </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">normalize_kwargs</span><span class="s2">(</span><span class="s1">inp</span><span class="s2">, **</span><span class="s1">kwargs_to_norm</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_warn_external_frame_embedded_python</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">patch</span><span class="s2">.</span><span class="s1">object</span><span class="s2">(</span><span class="s1">cbook</span><span class="s2">, </span><span class="s3">&quot;sys&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">mock_sys</span><span class="s2">:</span>
        <span class="s1">mock_sys</span><span class="s2">.</span><span class="s1">_getframe </span><span class="s2">= </span><span class="s1">Mock</span><span class="s2">(</span><span class="s1">return_value</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">r&quot;\Adummy\Z&quot;</span><span class="s2">):</span>
            <span class="s1">_api</span><span class="s2">.</span><span class="s1">warn_external</span><span class="s2">(</span><span class="s3">&quot;dummy&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_to_prestep</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">y1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)[::-</span><span class="s4">1</span><span class="s2">]</span>

    <span class="s1">xs</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">, </span><span class="s1">y2s </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_prestep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s1">x_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">y1_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">y2_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_target</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y1_target</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y2_target</span><span class="s2">, </span><span class="s1">y2s</span><span class="s2">)</span>

    <span class="s1">xs</span><span class="s2">, </span><span class="s1">y1s </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_prestep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_target</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y1_target</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_to_prestep_empty</span><span class="s2">():</span>
    <span class="s1">steps </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_prestep</span><span class="s2">([], [])</span>
    <span class="s0">assert </span><span class="s1">steps</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_to_poststep</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">y1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)[::-</span><span class="s4">1</span><span class="s2">]</span>

    <span class="s1">xs</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">, </span><span class="s1">y2s </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_poststep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s1">x_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">y1_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">y2_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_target</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y1_target</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y2_target</span><span class="s2">, </span><span class="s1">y2s</span><span class="s2">)</span>

    <span class="s1">xs</span><span class="s2">, </span><span class="s1">y1s </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_poststep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_target</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y1_target</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_to_poststep_empty</span><span class="s2">():</span>
    <span class="s1">steps </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_poststep</span><span class="s2">([], [])</span>
    <span class="s0">assert </span><span class="s1">steps</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_to_midstep</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">y1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
    <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)[::-</span><span class="s4">1</span><span class="s2">]</span>

    <span class="s1">xs</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">, </span><span class="s1">y2s </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_midstep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

    <span class="s1">x_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">y1_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">y2_target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>

    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_target</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y1_target</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y2_target</span><span class="s2">, </span><span class="s1">y2s</span><span class="s2">)</span>

    <span class="s1">xs</span><span class="s2">, </span><span class="s1">y1s </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_midstep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x_target</span><span class="s2">, </span><span class="s1">xs</span><span class="s2">)</span>
    <span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">y1_target</span><span class="s2">, </span><span class="s1">y1s</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_to_midstep_empty</span><span class="s2">():</span>
    <span class="s1">steps </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_midstep</span><span class="s2">([], [])</span>
    <span class="s0">assert </span><span class="s1">steps</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;args&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">), </span><span class="s3">'a'</span><span class="s2">),</span>
     <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">), </span><span class="s3">'a'</span><span class="s2">),</span>
     <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">))])</span>
<span class="s0">def </span><span class="s1">test_step_fails</span><span class="s2">(</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">cbook</span><span class="s2">.</span><span class="s1">pts_to_prestep</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_grouper</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">Dummy</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">d</span><span class="s2">, </span><span class="s1">e </span><span class="s2">= </span><span class="s1">objs </span><span class="s2">= [</span><span class="s1">Dummy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)]</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">()</span>
    <span class="s1">g</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(*</span><span class="s1">objs</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">g</span><span class="s2">)[</span><span class="s4">0</span><span class="s2">]) == </span><span class="s1">set</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">set</span><span class="s2">(</span><span class="s1">g</span><span class="s2">.</span><span class="s1">get_siblings</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)) == </span><span class="s1">set</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">other </span><span class="s0">in </span><span class="s1">objs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]:</span>
        <span class="s0">assert </span><span class="s1">g</span><span class="s2">.</span><span class="s1">joined</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>

    <span class="s1">g</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">other </span><span class="s0">in </span><span class="s1">objs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]:</span>
        <span class="s0">assert not </span><span class="s1">g</span><span class="s2">.</span><span class="s1">joined</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">other</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">A</span><span class="s2">, </span><span class="s1">B </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">objs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:], </span><span class="s1">objs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]):</span>
        <span class="s0">assert </span><span class="s1">g</span><span class="s2">.</span><span class="s1">joined</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_grouper_private</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">Dummy</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s1">objs </span><span class="s2">= [</span><span class="s1">Dummy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)]</span>
    <span class="s1">g </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">Grouper</span><span class="s2">()</span>
    <span class="s1">g</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(*</span><span class="s1">objs</span><span class="s2">)</span>
    <span class="s5"># reach in and touch the internals !</span>
    <span class="s1">mapping </span><span class="s2">= </span><span class="s1">g</span><span class="s2">.</span><span class="s1">_mapping</span>

    <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">objs</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">o </span><span class="s0">in </span><span class="s1">mapping</span>

    <span class="s1">base_set </span><span class="s2">= </span><span class="s1">mapping</span><span class="s2">[</span><span class="s1">objs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]]</span>
    <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">objs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]:</span>
        <span class="s0">assert </span><span class="s1">mapping</span><span class="s2">[</span><span class="s1">o</span><span class="s2">] </span><span class="s0">is </span><span class="s1">base_set</span>


<span class="s0">def </span><span class="s1">test_flatiter</span><span class="s2">():</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">it </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">flat</span>
    <span class="s0">assert </span><span class="s4">0 </span><span class="s2">== </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">1 </span><span class="s2">== </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s1">ret </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_safe_first_finite</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ret </span><span class="s2">== </span><span class="s4">0</span>

    <span class="s0">assert </span><span class="s4">0 </span><span class="s2">== </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s4">1 </span><span class="s2">== </span><span class="s1">next</span><span class="s2">(</span><span class="s1">it</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__safe_first_finite_all_nan</span><span class="s2">():</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
    <span class="s1">ret </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_safe_first_finite</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test__safe_first_finite_all_inf</span><span class="s2">():</span>
    <span class="s1">arr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">full</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
    <span class="s1">ret </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_safe_first_finite</span><span class="s2">(</span><span class="s1">arr</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isinf</span><span class="s2">(</span><span class="s1">ret</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reshape2d</span><span class="s2">():</span>

    <span class="s0">class </span><span class="s1">Dummy</span><span class="s2">:</span>
        <span class="s0">pass</span>

    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">([], </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= [</span><span class="s1">Dummy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)]</span>

    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

    <span class="s1">x </span><span class="s2">= [[</span><span class="s1">Dummy</span><span class="s2">() </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">)]</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>

    <span class="s5"># this is strange behaviour, but...</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == (</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

    <span class="s5"># Test a list of lists which are all of length 1</span>
    <span class="s1">x </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">]]</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">1</span><span class="s2">,)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">1</span><span class="s2">,)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">2</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">1</span><span class="s2">,)</span>

    <span class="s5"># Test a list of zero-dimensional arrays</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)]</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">3</span><span class="s2">,)</span>

    <span class="s5"># Now test with a list of lists with different lengths, which means the</span>
    <span class="s5"># array will internally be converted to a 1D object array of lists</span>
    <span class="s1">x </span><span class="s2">= [[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">]]</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">list</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">3</span><span class="s2">,)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">,)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">) </span><span class="s0">and </span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">2</span><span class="s2">].</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">1</span><span class="s2">,)</span>

    <span class="s5"># We now need to make sure that this works correctly for Numpy subclasses</span>
    <span class="s5"># where iterating over items can return subclasses too, which may be</span>
    <span class="s5"># iterable even if they are scalars. To emulate this, we make a Numpy</span>
    <span class="s5"># array subclass that returns Numpy 'scalars' when iterating or accessing</span>
    <span class="s5"># values, and these are technically iterable if checking for example</span>
    <span class="s5"># isinstance(x, collections.abc.Iterable).</span>

    <span class="s0">class </span><span class="s1">ArraySubclass</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">):</span>

        <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s1">super</span><span class="s2">().</span><span class="s1">__iter__</span><span class="s2">():</span>
                <span class="s0">yield </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">item</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">super</span><span class="s2">().</span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">item</span><span class="s2">))</span>

    <span class="s1">v </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">ArraySubclass</span><span class="s2">((</span><span class="s4">10</span><span class="s2">,), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">, </span><span class="s1">buffer</span><span class="s2">=</span><span class="s1">v</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>

    <span class="s5"># We check here that the array wasn't split up into many individual</span>
    <span class="s5"># ArraySubclass, which is what used to happen due to a bug in _reshape_2D</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">ArraySubclass</span><span class="s2">)</span>

    <span class="s5"># check list of strings:</span>
    <span class="s1">x </span><span class="s2">= [</span><span class="s3">'a'</span><span class="s2">, </span><span class="s3">'b'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'c'</span><span class="s2">, </span><span class="s3">'dd'</span><span class="s2">, </span><span class="s3">'e'</span><span class="s2">, </span><span class="s3">'f'</span><span class="s2">, </span><span class="s3">'ff'</span><span class="s2">, </span><span class="s3">'f'</span><span class="s2">]</span>
    <span class="s1">xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ndarray</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reshape2d_pandas</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">):</span>
    <span class="s5"># separate to allow the rest of the tests to run if no pandas...</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">30</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">Xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s5"># Need to check each row because _reshape_2D returns a list of arrays:</span>
    <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">xnew </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">Xnew</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xnew</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_reshape2d_xarray</span><span class="s2">(</span><span class="s1">xr</span><span class="s2">):</span>
    <span class="s5"># separate to allow the rest of the tests to run if no xarray...</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">30</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">xr</span><span class="s2">.</span><span class="s1">DataArray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dims</span><span class="s2">=[</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">])</span>
    <span class="s1">Xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_reshape_2D</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">)</span>
    <span class="s5"># Need to check each row because _reshape_2D returns a list of arrays:</span>
    <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">xnew </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">Xnew</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xnew</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_index_of_pandas</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">):</span>
    <span class="s5"># separate to allow the rest of the tests to run if no pandas...</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">30</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">])</span>
    <span class="s1">Idx</span><span class="s2">, </span><span class="s1">Xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">index_of</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Xnew</span><span class="s2">)</span>
    <span class="s1">IdxRef </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Idx</span><span class="s2">, </span><span class="s1">IdxRef</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_index_of_xarray</span><span class="s2">(</span><span class="s1">xr</span><span class="s2">):</span>
    <span class="s5"># separate to allow the rest of the tests to run if no xarray...</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">30</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">xr</span><span class="s2">.</span><span class="s1">DataArray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">dims</span><span class="s2">=[</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">])</span>
    <span class="s1">Idx</span><span class="s2">, </span><span class="s1">Xnew </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">index_of</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Xnew</span><span class="s2">)</span>
    <span class="s1">IdxRef </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_array_equal</span><span class="s2">(</span><span class="s1">Idx</span><span class="s2">, </span><span class="s1">IdxRef</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_contiguous_regions</span><span class="s2">():</span>
    <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span>
    <span class="s5"># Starts and ends with True</span>
    <span class="s1">mask </span><span class="s2">= [</span><span class="s0">True</span><span class="s2">]*</span><span class="s1">a </span><span class="s2">+ [</span><span class="s0">False</span><span class="s2">]*</span><span class="s1">b </span><span class="s2">+ [</span><span class="s0">True</span><span class="s2">]*</span><span class="s1">c</span>
    <span class="s1">expected </span><span class="s2">= [(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">a</span><span class="s2">), (</span><span class="s1">a</span><span class="s2">+</span><span class="s1">b</span><span class="s2">, </span><span class="s1">a</span><span class="s2">+</span><span class="s1">b</span><span class="s2">+</span><span class="s1">c</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">contiguous_regions</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">) == </span><span class="s1">expected</span>
    <span class="s1">d</span><span class="s2">, </span><span class="s1">e </span><span class="s2">= </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span>
    <span class="s5"># Starts with True ends with False</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">mask </span><span class="s2">+ [</span><span class="s0">False</span><span class="s2">]*</span><span class="s1">e</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">contiguous_regions</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">) == </span><span class="s1">expected</span>
    <span class="s5"># Starts with False ends with True</span>
    <span class="s1">mask </span><span class="s2">= [</span><span class="s0">False</span><span class="s2">]*</span><span class="s1">d </span><span class="s2">+ </span><span class="s1">mask</span><span class="s2">[:-</span><span class="s1">e</span><span class="s2">]</span>
    <span class="s1">expected </span><span class="s2">= [(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">d</span><span class="s2">+</span><span class="s1">a</span><span class="s2">), (</span><span class="s1">d</span><span class="s2">+</span><span class="s1">a</span><span class="s2">+</span><span class="s1">b</span><span class="s2">, </span><span class="s1">d</span><span class="s2">+</span><span class="s1">a</span><span class="s2">+</span><span class="s1">b</span><span class="s2">+</span><span class="s1">c</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">contiguous_regions</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">) == </span><span class="s1">expected</span>
    <span class="s5"># Starts and ends with False</span>
    <span class="s1">mask </span><span class="s2">= </span><span class="s1">mask </span><span class="s2">+ [</span><span class="s0">False</span><span class="s2">]*</span><span class="s1">e</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">contiguous_regions</span><span class="s2">(</span><span class="s1">mask</span><span class="s2">) == </span><span class="s1">expected</span>
    <span class="s5"># No True in mask</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">contiguous_regions</span><span class="s2">([</span><span class="s0">False</span><span class="s2">]*</span><span class="s4">5</span><span class="s2">) == []</span>
    <span class="s5"># Empty mask</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">contiguous_regions</span><span class="s2">([]) == []</span>


<span class="s0">def </span><span class="s1">test_safe_first_element_pandas_series</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">):</span>
    <span class="s5"># deliberately create a pandas series with index not starting from 0</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Series</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">15</span><span class="s2">))</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_safe_first_finite</span><span class="s2">(</span><span class="s1">s</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">actual </span><span class="s2">== </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">test_warn_external</span><span class="s2">(</span><span class="s1">recwarn</span><span class="s2">):</span>
    <span class="s1">_api</span><span class="s2">.</span><span class="s1">warn_external</span><span class="s2">(</span><span class="s3">&quot;oops&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">recwarn</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">recwarn</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">filename </span><span class="s2">== </span><span class="s1">__file__</span>


<span class="s0">def </span><span class="s1">test_array_patch_perimeters</span><span class="s2">():</span>
    <span class="s5"># This compares the old implementation as a reference for the</span>
    <span class="s5"># vectorized one.</span>
    <span class="s0">def </span><span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rstride</span><span class="s2">, </span><span class="s1">cstride</span><span class="s2">):</span>
        <span class="s1">rows</span><span class="s2">, </span><span class="s1">cols </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span>
        <span class="s1">row_inds </span><span class="s2">= [*</span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">rows</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">rstride</span><span class="s2">), </span><span class="s1">rows</span><span class="s2">-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">col_inds </span><span class="s2">= [*</span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">cstride</span><span class="s2">), </span><span class="s1">cols</span><span class="s2">-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">polys </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">rs</span><span class="s2">, </span><span class="s1">rs_next </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">row_inds</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">row_inds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]):</span>
            <span class="s0">for </span><span class="s1">cs</span><span class="s2">, </span><span class="s1">cs_next </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">col_inds</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">col_inds</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]):</span>
                <span class="s5"># +1 ensures we share edges between polygons</span>
                <span class="s1">ps </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_array_perimeter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">rs</span><span class="s2">:</span><span class="s1">rs_next</span><span class="s2">+</span><span class="s4">1</span><span class="s2">, </span><span class="s1">cs</span><span class="s2">:</span><span class="s1">cs_next</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]).</span><span class="s1">T</span>
                <span class="s1">polys</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ps</span><span class="s2">)</span>
        <span class="s1">polys </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">polys</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array_equal</span><span class="s2">(</span><span class="s1">polys</span><span class="s2">,</span>
                              <span class="s1">cbook</span><span class="s2">.</span><span class="s1">_array_patch_perimeters</span><span class="s2">(</span>
                                  <span class="s1">x</span><span class="s2">, </span><span class="s1">rstride</span><span class="s2">=</span><span class="s1">rstride</span><span class="s2">, </span><span class="s1">cstride</span><span class="s2">=</span><span class="s1">cstride</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">divisors</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) </span><span class="s0">if </span><span class="s1">n </span><span class="s2">% </span><span class="s1">i </span><span class="s2">== </span><span class="s4">0</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols </span><span class="s0">in </span><span class="s2">[(</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">7</span><span class="s2">, </span><span class="s4">14</span><span class="s2">), (</span><span class="s4">13</span><span class="s2">, </span><span class="s4">9</span><span class="s2">)]:</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">rows </span><span class="s2">* </span><span class="s1">cols</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">rows</span><span class="s2">, </span><span class="s1">cols</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">rstride</span><span class="s2">, </span><span class="s1">cstride </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">divisors</span><span class="s2">(</span><span class="s1">rows </span><span class="s2">- </span><span class="s4">1</span><span class="s2">),</span>
                                                  <span class="s1">divisors</span><span class="s2">(</span><span class="s1">cols </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)):</span>
            <span class="s1">check</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">rstride</span><span class="s2">=</span><span class="s1">rstride</span><span class="s2">, </span><span class="s1">cstride</span><span class="s2">=</span><span class="s1">cstride</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_setattr_cm</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">A</span><span class="s2">:</span>
        <span class="s1">cls_level </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>
        <span class="s1">override </span><span class="s2">= </span><span class="s1">object</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">aardvark </span><span class="s2">= </span><span class="s3">'aardvark'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">override </span><span class="s2">= </span><span class="s3">'override'</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_p </span><span class="s2">= </span><span class="s3">'p'</span>

        <span class="s0">def </span><span class="s1">meth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s2">...</span>

        <span class="s2">@</span><span class="s1">classmethod</span>
        <span class="s0">def </span><span class="s1">classy</span><span class="s2">(</span><span class="s1">cls</span><span class="s2">):</span>
            <span class="s2">...</span>

        <span class="s2">@</span><span class="s1">staticmethod</span>
        <span class="s0">def </span><span class="s1">static</span><span class="s2">():</span>
            <span class="s2">...</span>

        <span class="s2">@</span><span class="s1">property</span>
        <span class="s0">def </span><span class="s1">prop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_p</span>

        <span class="s2">@</span><span class="s1">prop</span><span class="s2">.</span><span class="s1">setter</span>
        <span class="s0">def </span><span class="s1">prop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">val</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_p </span><span class="s2">= </span><span class="s1">val</span>

    <span class="s0">class </span><span class="s1">B</span><span class="s2">(</span><span class="s1">A</span><span class="s2">):</span>
        <span class="s2">...</span>

    <span class="s1">other </span><span class="s2">= </span><span class="s1">A</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">verify_pre_post_state</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s5"># When you access a Python method the function is bound</span>
        <span class="s5"># to the object at access time so you get a new instance</span>
        <span class="s5"># of MethodType every time.</span>
        <span class="s5">#</span>
        <span class="s5"># https://docs.python.org/3/howto/descriptor.html#functions-and-methods</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">meth </span><span class="s0">is not </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">meth</span>
        <span class="s5"># normal attribute should give you back the same instance every time</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">aardvark </span><span class="s0">is </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">aardvark</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">aardvark </span><span class="s2">== </span><span class="s3">'aardvark'</span>
        <span class="s5"># and our property happens to give the same instance every time</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">prop </span><span class="s0">is </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">prop</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">cls_level </span><span class="s0">is </span><span class="s1">A</span><span class="s2">.</span><span class="s1">cls_level</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">override </span><span class="s2">== </span><span class="s3">'override'</span>
        <span class="s0">assert not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s3">'extra'</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">prop </span><span class="s2">== </span><span class="s3">'p'</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">monkey </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">meth</span>
        <span class="s0">assert </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">cls_level </span><span class="s0">is </span><span class="s1">A</span><span class="s2">.</span><span class="s1">cls_level</span>
        <span class="s0">assert </span><span class="s3">'cls_level' </span><span class="s0">not in </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__dict__</span>
        <span class="s0">assert </span><span class="s3">'classy' </span><span class="s0">not in </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__dict__</span>
        <span class="s0">assert </span><span class="s3">'static' </span><span class="s0">not in </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__dict__</span>

    <span class="s1">a </span><span class="s2">= </span><span class="s1">B</span><span class="s2">()</span>

    <span class="s1">a</span><span class="s2">.</span><span class="s1">monkey </span><span class="s2">= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">meth</span>
    <span class="s1">verify_pre_post_state</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_setattr_cm</span><span class="s2">(</span>
            <span class="s1">a</span><span class="s2">, </span><span class="s1">prop</span><span class="s2">=</span><span class="s3">'squirrel'</span><span class="s2">,</span>
            <span class="s1">aardvark</span><span class="s2">=</span><span class="s3">'moose'</span><span class="s2">, </span><span class="s1">meth</span><span class="s2">=</span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s1">override</span><span class="s2">=</span><span class="s3">'boo'</span><span class="s2">, </span><span class="s1">extra</span><span class="s2">=</span><span class="s3">'extra'</span><span class="s2">,</span>
            <span class="s1">monkey</span><span class="s2">=</span><span class="s0">lambda</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s1">cls_level</span><span class="s2">=</span><span class="s3">'bob'</span><span class="s2">,</span>
            <span class="s1">classy</span><span class="s2">=</span><span class="s3">'classy'</span><span class="s2">, </span><span class="s1">static</span><span class="s2">=</span><span class="s3">'static'</span><span class="s2">):</span>
        <span class="s5"># because we have set a lambda, it is normal attribute access</span>
        <span class="s5"># and the same every time</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">meth </span><span class="s0">is </span><span class="s1">a</span><span class="s2">.</span><span class="s1">meth</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">aardvark </span><span class="s0">is </span><span class="s1">a</span><span class="s2">.</span><span class="s1">aardvark</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">aardvark </span><span class="s2">== </span><span class="s3">'moose'</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">override </span><span class="s2">== </span><span class="s3">'boo'</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">extra </span><span class="s2">== </span><span class="s3">'extra'</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">prop </span><span class="s2">== </span><span class="s3">'squirrel'</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">monkey </span><span class="s2">!= </span><span class="s1">other</span><span class="s2">.</span><span class="s1">meth</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">cls_level </span><span class="s2">== </span><span class="s3">'bob'</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">classy </span><span class="s2">== </span><span class="s3">'classy'</span>
        <span class="s0">assert </span><span class="s1">a</span><span class="s2">.</span><span class="s1">static </span><span class="s2">== </span><span class="s3">'static'</span>

    <span class="s1">verify_pre_post_state</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_format_approx</span><span class="s2">():</span>
    <span class="s1">f </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_format_approx</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">) == </span><span class="s3">'0'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">) == </span><span class="s3">'0'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">) == </span><span class="s3">'0'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(-</span><span class="s4">0.0123</span><span class="s2">, </span><span class="s4">1</span><span class="s2">) == </span><span class="s3">'-0'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s4">5</span><span class="s2">) == </span><span class="s3">'0'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s4">0.0012345600001</span><span class="s2">, </span><span class="s4">5</span><span class="s2">) == </span><span class="s3">'0.00123'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(-</span><span class="s4">0.0012345600001</span><span class="s2">, </span><span class="s4">5</span><span class="s2">) == </span><span class="s3">'-0.00123'</span>
    <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s4">0.0012345600001</span><span class="s2">, </span><span class="s4">8</span><span class="s2">) == </span><span class="s1">f</span><span class="s2">(</span><span class="s4">0.0012345600001</span><span class="s2">, </span><span class="s4">10</span><span class="s2">) == </span><span class="s3">'0.00123456'</span>


<span class="s0">def </span><span class="s1">test_safe_first_element_with_none</span><span class="s2">():</span>
    <span class="s1">datetime_lst </span><span class="s2">= [</span><span class="s1">date</span><span class="s2">.</span><span class="s1">today</span><span class="s2">() + </span><span class="s1">timedelta</span><span class="s2">(</span><span class="s1">days</span><span class="s2">=</span><span class="s1">i</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)]</span>
    <span class="s1">datetime_lst</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_safe_first_finite</span><span class="s2">(</span><span class="s1">datetime_lst</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">actual </span><span class="s0">is not None and </span><span class="s1">actual </span><span class="s2">== </span><span class="s1">datetime_lst</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_strip_math</span><span class="s2">():</span>
    <span class="s0">assert </span><span class="s1">strip_math</span><span class="s2">(</span><span class="s3">r'1 \times 2'</span><span class="s2">) == </span><span class="s3">r'1 \times 2'</span>
    <span class="s0">assert </span><span class="s1">strip_math</span><span class="s2">(</span><span class="s3">r'$1 \times 2$'</span><span class="s2">) == </span><span class="s3">'1 x 2'</span>
    <span class="s0">assert </span><span class="s1">strip_math</span><span class="s2">(</span><span class="s3">r'$\rm{hi}$'</span><span class="s2">) == </span><span class="s3">'hi'</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'fmt, value, result'</span><span class="s2">, [</span>
    <span class="s2">(</span><span class="s3">'%.2f m'</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">'0.20 m'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'{:.2f} m'</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">'0.20 m'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'{} m'</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">'0.2 m'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'const'</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">'const'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'%d or {}'</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">'0 or {}'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'{{{:,.0f}}}'</span><span class="s2">, </span><span class="s4">2e5</span><span class="s2">, </span><span class="s3">'{200,000}'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'{:.2%}'</span><span class="s2">, </span><span class="s4">2</span><span class="s2">/</span><span class="s4">3</span><span class="s2">, </span><span class="s3">'66.67%'</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s3">'$%g'</span><span class="s2">, </span><span class="s4">2.54</span><span class="s2">, </span><span class="s3">'$2.54'</span><span class="s2">),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_auto_format_str</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">value</span><span class="s2">, </span><span class="s1">result</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Apply *value* to the format string *fmt*.&quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_auto_format_str</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">value</span><span class="s2">) == </span><span class="s1">result</span>
    <span class="s0">assert </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_auto_format_str</span><span class="s2">(</span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)) == </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_unpack_to_numpy_from_torch</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot; 
    Test that torch tensors are converted to NumPy arrays. 
 
    We don't want to create a dependency on torch in the test suite, so we mock it. 
    &quot;&quot;&quot;</span>
    <span class="s0">class </span><span class="s1">Tensor</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>

        <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s1">torch </span><span class="s2">= </span><span class="s1">ModuleType</span><span class="s2">(</span><span class="s3">'torch'</span><span class="s2">)</span>
    <span class="s1">torch</span><span class="s2">.</span><span class="s1">Tensor </span><span class="s2">= </span><span class="s1">Tensor</span>
    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s3">'torch'</span><span class="s2">] = </span><span class="s1">torch</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">torch_tensor </span><span class="s2">= </span><span class="s1">torch</span><span class="s2">.</span><span class="s1">Tensor</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_unpack_to_numpy</span><span class="s2">(</span><span class="s1">torch_tensor</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s0">is </span><span class="s1">torch_tensor</span><span class="s2">.</span><span class="s1">__array__</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_unpack_to_numpy_from_jax</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot; 
    Test that jax arrays are converted to NumPy arrays. 
 
    We don't want to create a dependency on jax in the test suite, so we mock it. 
    &quot;&quot;&quot;</span>
    <span class="s0">class </span><span class="s1">Array</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">data </span><span class="s2">= </span><span class="s1">data</span>

        <span class="s0">def </span><span class="s1">__array__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">data</span>

    <span class="s1">jax </span><span class="s2">= </span><span class="s1">ModuleType</span><span class="s2">(</span><span class="s3">'jax'</span><span class="s2">)</span>
    <span class="s1">jax</span><span class="s2">.</span><span class="s1">Array </span><span class="s2">= </span><span class="s1">Array</span>

    <span class="s1">sys</span><span class="s2">.</span><span class="s1">modules</span><span class="s2">[</span><span class="s3">'jax'</span><span class="s2">] = </span><span class="s1">jax</span>

    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
    <span class="s1">jax_array </span><span class="s2">= </span><span class="s1">jax</span><span class="s2">.</span><span class="s1">Array</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">cbook</span><span class="s2">.</span><span class="s1">_unpack_to_numpy</span><span class="s2">(</span><span class="s1">jax_array</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s0">is </span><span class="s1">jax_array</span><span class="s2">.</span><span class="s1">__array__</span><span class="s2">()</span>
</pre>
</body>
</html>