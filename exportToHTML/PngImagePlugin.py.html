<html>
<head>
<title>PngImagePlugin.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #a5c261;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PngImagePlugin.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># The Python Imaging Library.</span>
<span class="s0"># $Id$</span>
<span class="s0">#</span>
<span class="s0"># PNG support code</span>
<span class="s0">#</span>
<span class="s0"># See &quot;PNG (Portable Network Graphics) Specification, version 1.0;</span>
<span class="s0"># W3C Recommendation&quot;, 1996-10-01, Thomas Boutell (ed.).</span>
<span class="s0">#</span>
<span class="s0"># history:</span>
<span class="s0"># 1996-05-06 fl   Created (couldn't resist it)</span>
<span class="s0"># 1996-12-14 fl   Upgraded, added read and verify support (0.2)</span>
<span class="s0"># 1996-12-15 fl   Separate PNG stream parser</span>
<span class="s0"># 1996-12-29 fl   Added write support, added getchunks</span>
<span class="s0"># 1996-12-30 fl   Eliminated circular references in decoder (0.3)</span>
<span class="s0"># 1998-07-12 fl   Read/write 16-bit images as mode I (0.4)</span>
<span class="s0"># 2001-02-08 fl   Added transparency support (from Zircon) (0.5)</span>
<span class="s0"># 2001-04-16 fl   Don't close data source in &quot;open&quot; method (0.6)</span>
<span class="s0"># 2004-02-24 fl   Don't even pretend to support interlaced files (0.7)</span>
<span class="s0"># 2004-08-31 fl   Do basic sanity check on chunk identifiers (0.8)</span>
<span class="s0"># 2004-09-20 fl   Added PngInfo chunk container</span>
<span class="s0"># 2004-12-18 fl   Added DPI read support (based on code by Niki Spahiev)</span>
<span class="s0"># 2008-08-13 fl   Added tRNS support for RGB images</span>
<span class="s0"># 2009-03-06 fl   Support for preserving ICC profiles (by Florian Hoech)</span>
<span class="s0"># 2009-03-08 fl   Added zTXT support (from Lowell Alleman)</span>
<span class="s0"># 2009-03-29 fl   Read interlaced PNG files (from Conrado Porto Lopes Gouvua)</span>
<span class="s0">#</span>
<span class="s0"># Copyright (c) 1997-2009 by Secret Labs AB</span>
<span class="s0"># Copyright (c) 1996 by Fredrik Lundh</span>
<span class="s0">#</span>
<span class="s0"># See the README file for information on usage and redistribution.</span>
<span class="s0">#</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">annotations</span>

<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">struct</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">import </span><span class="s1">zlib</span>
<span class="s2">from </span><span class="s1">enum </span><span class="s2">import </span><span class="s1">IntEnum</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">IO</span><span class="s3">, </span><span class="s1">TYPE_CHECKING</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">, </span><span class="s1">NoReturn</span>

<span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">Image</span><span class="s3">, </span><span class="s1">ImageChops</span><span class="s3">, </span><span class="s1">ImageFile</span><span class="s3">, </span><span class="s1">ImagePalette</span><span class="s3">, </span><span class="s1">ImageSequence</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">i16be </span><span class="s2">as </span><span class="s1">i16</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">i32be </span><span class="s2">as </span><span class="s1">i32</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">o8</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">o16be </span><span class="s2">as </span><span class="s1">o16</span>
<span class="s2">from </span><span class="s3">.</span><span class="s1">_binary </span><span class="s2">import </span><span class="s1">o32be </span><span class="s2">as </span><span class="s1">o32</span>

<span class="s2">if </span><span class="s1">TYPE_CHECKING</span><span class="s3">:</span>
    <span class="s2">from </span><span class="s3">. </span><span class="s2">import </span><span class="s1">_imaging</span>

<span class="s1">logger </span><span class="s3">= </span><span class="s1">logging</span><span class="s3">.</span><span class="s1">getLogger</span><span class="s3">(</span><span class="s1">__name__</span><span class="s3">)</span>

<span class="s1">is_cid </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">rb&quot;\w\w\w\w&quot;</span><span class="s3">).</span><span class="s1">match</span>


<span class="s1">_MAGIC </span><span class="s3">= </span><span class="s4">b&quot;</span><span class="s2">\211</span><span class="s4">PNG</span><span class="s2">\r\n\032\n</span><span class="s4">&quot;</span>


<span class="s1">_MODES </span><span class="s3">= {</span>
    <span class="s0"># supported bits/color combinations, and corresponding modes/rawmodes</span>
    <span class="s0"># Grayscale</span>
    <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): (</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;1&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): (</span><span class="s6">&quot;L&quot;</span><span class="s3">, </span><span class="s6">&quot;L;2&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): (</span><span class="s6">&quot;L&quot;</span><span class="s3">, </span><span class="s6">&quot;L;4&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): (</span><span class="s6">&quot;L&quot;</span><span class="s3">, </span><span class="s6">&quot;L&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s5">0</span><span class="s3">): (</span><span class="s6">&quot;I;16&quot;</span><span class="s3">, </span><span class="s6">&quot;I;16B&quot;</span><span class="s3">),</span>
    <span class="s0"># Truecolour</span>
    <span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">2</span><span class="s3">): (</span><span class="s6">&quot;RGB&quot;</span><span class="s3">, </span><span class="s6">&quot;RGB&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s5">2</span><span class="s3">): (</span><span class="s6">&quot;RGB&quot;</span><span class="s3">, </span><span class="s6">&quot;RGB;16B&quot;</span><span class="s3">),</span>
    <span class="s0"># Indexed-colour</span>
    <span class="s3">(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">): (</span><span class="s6">&quot;P&quot;</span><span class="s3">, </span><span class="s6">&quot;P;1&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">): (</span><span class="s6">&quot;P&quot;</span><span class="s3">, </span><span class="s6">&quot;P;2&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">4</span><span class="s3">, </span><span class="s5">3</span><span class="s3">): (</span><span class="s6">&quot;P&quot;</span><span class="s3">, </span><span class="s6">&quot;P;4&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">3</span><span class="s3">): (</span><span class="s6">&quot;P&quot;</span><span class="s3">, </span><span class="s6">&quot;P&quot;</span><span class="s3">),</span>
    <span class="s0"># Grayscale with alpha</span>
    <span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">4</span><span class="s3">): (</span><span class="s6">&quot;LA&quot;</span><span class="s3">, </span><span class="s6">&quot;LA&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s5">4</span><span class="s3">): (</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s6">&quot;LA;16B&quot;</span><span class="s3">),  </span><span class="s0"># LA;16B-&gt;LA not yet available</span>
    <span class="s0"># Truecolour with alpha</span>
    <span class="s3">(</span><span class="s5">8</span><span class="s3">, </span><span class="s5">6</span><span class="s3">): (</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s6">&quot;RGBA&quot;</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">16</span><span class="s3">, </span><span class="s5">6</span><span class="s3">): (</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s6">&quot;RGBA;16B&quot;</span><span class="s3">),</span>
<span class="s3">}</span>


<span class="s1">_simple_palette </span><span class="s3">= </span><span class="s1">re</span><span class="s3">.</span><span class="s1">compile</span><span class="s3">(</span><span class="s4">b&quot;^</span><span class="s2">\xff</span><span class="s4">*</span><span class="s2">\x00\xff</span><span class="s4">*$&quot;</span><span class="s3">)</span>

<span class="s1">MAX_TEXT_CHUNK </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">SAFEBLOCK</span>
<span class="s6">&quot;&quot;&quot; 
Maximum decompressed size for a iTXt or zTXt chunk. 
Eliminates decompression bombs where compressed chunks can expand 1000x. 
See :ref:`Text in PNG File Format&lt;png-text&gt;`. 
&quot;&quot;&quot;</span>
<span class="s1">MAX_TEXT_MEMORY </span><span class="s3">= </span><span class="s5">64 </span><span class="s3">* </span><span class="s1">MAX_TEXT_CHUNK</span>
<span class="s6">&quot;&quot;&quot; 
Set the maximum total text chunk size. 
See :ref:`Text in PNG File Format&lt;png-text&gt;`. 
&quot;&quot;&quot;</span>


<span class="s0"># APNG frame disposal modes</span>
<span class="s2">class </span><span class="s1">Disposal</span><span class="s3">(</span><span class="s1">IntEnum</span><span class="s3">):</span>
    <span class="s1">OP_NONE </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s6">&quot;&quot;&quot; 
    No disposal is done on this frame before rendering the next frame. 
    See :ref:`Saving APNG sequences&lt;apng-saving&gt;`. 
    &quot;&quot;&quot;</span>
    <span class="s1">OP_BACKGROUND </span><span class="s3">= </span><span class="s5">1</span>
    <span class="s6">&quot;&quot;&quot; 
    This frame’s modified region is cleared to fully transparent black before rendering 
    the next frame. 
    See :ref:`Saving APNG sequences&lt;apng-saving&gt;`. 
    &quot;&quot;&quot;</span>
    <span class="s1">OP_PREVIOUS </span><span class="s3">= </span><span class="s5">2</span>
    <span class="s6">&quot;&quot;&quot; 
    This frame’s modified region is reverted to the previous frame’s contents before 
    rendering the next frame. 
    See :ref:`Saving APNG sequences&lt;apng-saving&gt;`. 
    &quot;&quot;&quot;</span>


<span class="s0"># APNG frame blend modes</span>
<span class="s2">class </span><span class="s1">Blend</span><span class="s3">(</span><span class="s1">IntEnum</span><span class="s3">):</span>
    <span class="s1">OP_SOURCE </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s6">&quot;&quot;&quot; 
    All color components of this frame, including alpha, overwrite the previous output 
    image contents. 
    See :ref:`Saving APNG sequences&lt;apng-saving&gt;`. 
    &quot;&quot;&quot;</span>
    <span class="s1">OP_OVER </span><span class="s3">= </span><span class="s5">1</span>
    <span class="s6">&quot;&quot;&quot; 
    This frame should be alpha composited with the previous output image contents. 
    See :ref:`Saving APNG sequences&lt;apng-saving&gt;`. 
    &quot;&quot;&quot;</span>


<span class="s2">def </span><span class="s1">_safe_zlib_decompress</span><span class="s3">(</span><span class="s1">s</span><span class="s3">):</span>
    <span class="s1">dobj </span><span class="s3">= </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">decompressobj</span><span class="s3">()</span>
    <span class="s1">plaintext </span><span class="s3">= </span><span class="s1">dobj</span><span class="s3">.</span><span class="s1">decompress</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s1">MAX_TEXT_CHUNK</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">dobj</span><span class="s3">.</span><span class="s1">unconsumed_tail</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Decompressed Data Too Large&quot;</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">plaintext</span>


<span class="s2">def </span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s5">0</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">crc32</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">) &amp; </span><span class="s5">0xFFFFFFFF</span>


<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Support classes.  Suitable for PNG and related formats like MNG etc.</span>


<span class="s2">class </span><span class="s1">ChunkStream</span><span class="s3">:</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">: </span><span class="s1">IO</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">]) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">: </span><span class="s1">IO</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">] | </span><span class="s2">None </span><span class="s3">= </span><span class="s1">fp</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">queue</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]] | </span><span class="s2">None </span><span class="s3">= []</span>

    <span class="s2">def </span><span class="s1">read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; tuple</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">int</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]:</span>
        <span class="s7">&quot;&quot;&quot;Fetch a new chunk. Returns header information.&quot;&quot;&quot;</span>
        <span class="s1">cid </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s2">is not None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">queue</span><span class="s3">:</span>
            <span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">queue</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">pos</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">s </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">8</span><span class="s3">)</span>
            <span class="s1">cid </span><span class="s3">= </span><span class="s1">s</span><span class="s3">[</span><span class="s5">4</span><span class="s3">:]</span>
            <span class="s1">pos </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">tell</span><span class="s3">()</span>
            <span class="s1">length </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">is_cid</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;broken PNG file (chunk </span><span class="s2">{</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)</span><span class="s2">}</span><span class="s6">)&quot;</span>
                <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span>

    <span class="s2">def </span><span class="s1">__enter__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; ChunkStream</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">__exit__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">: </span><span class="s1">object</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">queue </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">push</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">queue </span><span class="s2">is not None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">queue</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">call</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">):</span>
        <span class="s7">&quot;&quot;&quot;Call the appropriate chunk handler&quot;&quot;&quot;</span>

        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">&quot;STREAM %r %s %s&quot;</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s6">f&quot;chunk_</span><span class="s2">{</span><span class="s1">cid</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">'ascii'</span><span class="s3">)</span><span class="s2">}</span><span class="s6">&quot;</span><span class="s3">)(</span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">crc</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Read and verify checksum&quot;&quot;&quot;</span>

        <span class="s0"># Skip CRC checks for ancillary chunks if allowed to load truncated</span>
        <span class="s0"># images</span>
        <span class="s0"># 5th byte of first char is 1 [specs, section 5.4]</span>
        <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES </span><span class="s2">and </span><span class="s3">(</span><span class="s1">cid</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] &gt;&gt; </span><span class="s5">5 </span><span class="s3">&amp; </span><span class="s5">1</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">crc_skip</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
            <span class="s2">return</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s2">is not None</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">crc1 </span><span class="s3">= </span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">))</span>
            <span class="s1">crc2 </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">))</span>
            <span class="s2">if </span><span class="s1">crc1 </span><span class="s3">!= </span><span class="s1">crc2</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;broken PNG file (bad header checksum in </span><span class="s2">{</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)</span><span class="s2">}</span><span class="s6">)&quot;</span>
                <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">error </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;broken PNG file (incomplete checksum in </span><span class="s2">{</span><span class="s1">repr</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)</span><span class="s2">}</span><span class="s6">)&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) </span><span class="s2">from </span><span class="s1">e</span>

    <span class="s2">def </span><span class="s1">crc_skip</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Read checksum&quot;&quot;&quot;</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s2">is not None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">verify</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">endchunk</span><span class="s3">: </span><span class="s1">bytes </span><span class="s3">= </span><span class="s4">b&quot;IEND&quot;</span><span class="s3">) </span><span class="s1">-&gt; list</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">]:</span>
        <span class="s0"># Simple approach; just calculate checksum for all remaining</span>
        <span class="s0"># blocks.  Must be called directly after open.</span>

        <span class="s1">cids </span><span class="s3">= []</span>

        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">error </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;truncated PNG file&quot;</span>
                <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) </span><span class="s2">from </span><span class="s1">e</span>

            <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s1">endchunk</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">crc</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">))</span>
            <span class="s1">cids</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)</span>

        <span class="s2">return </span><span class="s1">cids</span>


<span class="s2">class </span><span class="s1">iTXt</span><span class="s3">(</span><span class="s1">str</span><span class="s3">):</span>
    <span class="s7">&quot;&quot;&quot; 
    Subclass of string to allow iTXt chunks to look like strings while 
    keeping their extra information 
 
    &quot;&quot;&quot;</span>

    <span class="s1">lang</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes </span><span class="s3">| </span><span class="s2">None</span>
    <span class="s1">tkey</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes </span><span class="s3">| </span><span class="s2">None</span>

    <span class="s3">@</span><span class="s1">staticmethod</span>
    <span class="s2">def </span><span class="s1">__new__</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">text</span><span class="s3">, </span><span class="s1">lang</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">tkey</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s7">&quot;&quot;&quot; 
        :param cls: the class to use when creating the instance 
        :param text: value for this key 
        :param lang: language code 
        :param tkey: UTF-8 version of the key name 
        &quot;&quot;&quot;</span>

        <span class="s1">self </span><span class="s3">= </span><span class="s1">str</span><span class="s3">.</span><span class="s1">__new__</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">, </span><span class="s1">text</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">lang </span><span class="s3">= </span><span class="s1">lang</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tkey </span><span class="s3">= </span><span class="s1">tkey</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s2">class </span><span class="s1">PngInfo</span><span class="s3">:</span>
    <span class="s7">&quot;&quot;&quot; 
    PNG chunk container (for use with save(pnginfo=)) 
 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">chunks</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]] = []</span>

    <span class="s2">def </span><span class="s1">add</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">after_idat</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Appends an arbitrary chunk. Use with caution. 
 
        :param cid: a byte string, 4 bytes long. 
        :param data: a byte string of the encoded data 
        :param after_idat: for use with private chunks. Whether the chunk 
                           should be written after IDAT 
 
        &quot;&quot;&quot;</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">chunks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">after_idat</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">add_itxt</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">key</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span><span class="s3">,</span>
        <span class="s1">value</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span><span class="s3">,</span>
        <span class="s1">lang</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes </span><span class="s3">= </span><span class="s6">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">tkey</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes </span><span class="s3">= </span><span class="s6">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">zip</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Appends an iTXt chunk. 
 
        :param key: latin-1 encodable text key name 
        :param value: value for this key 
        :param lang: language code 
        :param tkey: UTF-8 version of the key name 
        :param zip: compression flag 
 
        &quot;&quot;&quot;</span>

        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s1">key</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">value </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">lang</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">lang </span><span class="s3">= </span><span class="s1">lang</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">tkey</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">tkey </span><span class="s3">= </span><span class="s1">tkey</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">zip</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span>
                <span class="s4">b&quot;iTXt&quot;</span><span class="s3">,</span>
                <span class="s1">key </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0\x01\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">lang </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">tkey </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">compress</span><span class="s3">(</span><span class="s1">value</span><span class="s3">),</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s4">b&quot;iTXt&quot;</span><span class="s3">, </span><span class="s1">key </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0\0\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">lang </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">tkey </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">value</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">add_text</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">key</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">value</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes </span><span class="s3">| </span><span class="s1">iTXt</span><span class="s3">, </span><span class="s1">zip</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Appends a text chunk. 
 
        :param key: latin-1 encodable text key name 
        :param value: value for this key, text or an 
           :py:class:`PIL.PngImagePlugin.iTXt` instance 
        :param zip: compression flag 
 
        &quot;&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">iTXt</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">add_itxt</span><span class="s3">(</span>
                <span class="s1">key</span><span class="s3">,</span>
                <span class="s1">value</span><span class="s3">,</span>
                <span class="s1">value</span><span class="s3">.</span><span class="s1">lang </span><span class="s2">if </span><span class="s1">value</span><span class="s3">.</span><span class="s1">lang </span><span class="s2">is not None else </span><span class="s4">b&quot;&quot;</span><span class="s3">,</span>
                <span class="s1">value</span><span class="s3">.</span><span class="s1">tkey </span><span class="s2">if </span><span class="s1">value</span><span class="s3">.</span><span class="s1">tkey </span><span class="s2">is not None else </span><span class="s4">b&quot;&quot;</span><span class="s3">,</span>
                <span class="s1">zip</span><span class="s3">=</span><span class="s1">zip</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s0"># The tEXt chunk stores latin-1 text</span>
        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">UnicodeError</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">add_itxt</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">value</span><span class="s3">, </span><span class="s1">zip</span><span class="s3">=</span><span class="s1">zip</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">key</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
            <span class="s1">key </span><span class="s3">= </span><span class="s1">key</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">zip</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s4">b&quot;zTXt&quot;</span><span class="s3">, </span><span class="s1">key </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">compress</span><span class="s3">(</span><span class="s1">value</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s4">b&quot;tEXt&quot;</span><span class="s3">, </span><span class="s1">key </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">value</span><span class="s3">)</span>


<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># PNG image stream (IHDR/IEND)</span>


<span class="s2">class </span><span class="s1">PngStream</span><span class="s3">(</span><span class="s1">ChunkStream</span><span class="s3">):</span>
    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">)</span>

        <span class="s0"># local copies of Image attributes</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_text </span><span class="s3">= {}</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_size </span><span class="s3">= (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_mode </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_tile </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_palette </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_custom_mimetype </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rewind_state </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">text_memory </span><span class="s3">= </span><span class="s5">0</span>

    <span class="s2">def </span><span class="s1">check_text_memory</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">chunklen</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">text_memory </span><span class="s3">+= </span><span class="s1">chunklen</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_memory </span><span class="s3">&gt; </span><span class="s1">MAX_TEXT_MEMORY</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= (</span>
                <span class="s6">&quot;Too much memory used in text chunks: &quot;</span>
                <span class="s6">f&quot;</span><span class="s2">{</span><span class="s1">self</span><span class="s3">.</span><span class="s1">text_memory</span><span class="s2">}</span><span class="s6">&gt;MAX_TEXT_MEMORY&quot;</span>
            <span class="s3">)</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">save_rewind</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rewind_state </span><span class="s3">= {</span>
            <span class="s6">&quot;info&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(),</span>
            <span class="s6">&quot;tile&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_tile</span><span class="s3">,</span>
            <span class="s6">&quot;seq_num&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num</span><span class="s3">,</span>
        <span class="s3">}</span>

    <span class="s2">def </span><span class="s1">rewind</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rewind_state</span><span class="s3">[</span><span class="s6">&quot;info&quot;</span><span class="s3">].</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_tile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rewind_state</span><span class="s3">[</span><span class="s6">&quot;tile&quot;</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rewind_state</span><span class="s3">[</span><span class="s6">&quot;seq_num&quot;</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">chunk_iCCP</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># ICC profile</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s0"># according to PNG spec, the iCCP chunk contains:</span>
        <span class="s0"># Profile name  1-79 bytes (character string)</span>
        <span class="s0"># Null separator        1 byte (null character)</span>
        <span class="s0"># Compression method    1 byte (0)</span>
        <span class="s0"># Compressed profile    n bytes (zlib with deflate compression)</span>
        <span class="s1">i </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">&quot;iCCP profile name %r&quot;</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[:</span><span class="s1">i</span><span class="s3">])</span>
        <span class="s1">comp_method </span><span class="s3">= </span><span class="s1">s</span><span class="s3">[</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">]</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">&quot;Compression method %s&quot;</span><span class="s3">, </span><span class="s1">comp_method</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">comp_method </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;Unknown compression method </span><span class="s2">{</span><span class="s1">comp_method</span><span class="s2">} </span><span class="s6">in iCCP chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">icc_profile </span><span class="s3">= </span><span class="s1">_safe_zlib_decompress</span><span class="s3">(</span><span class="s1">s</span><span class="s3">[</span><span class="s1">i </span><span class="s3">+ </span><span class="s5">2 </span><span class="s3">:])</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s1">icc_profile </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise</span>
        <span class="s2">except </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">:</span>
            <span class="s1">icc_profile </span><span class="s3">= </span><span class="s2">None  </span><span class="s0"># FIXME</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;icc_profile&quot;</span><span class="s3">] = </span><span class="s1">icc_profile</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_IHDR</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># image header</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">13</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">s</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Truncated IHDR chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_size </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_mode</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_rawmode </span><span class="s3">= </span><span class="s1">_MODES</span><span class="s3">[(</span><span class="s1">s</span><span class="s3">[</span><span class="s5">8</span><span class="s3">], </span><span class="s1">s</span><span class="s3">[</span><span class="s5">9</span><span class="s3">])]</span>
        <span class="s2">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s2">pass</span>
        <span class="s2">if </span><span class="s1">s</span><span class="s3">[</span><span class="s5">12</span><span class="s3">]:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;interlace&quot;</span><span class="s3">] = </span><span class="s5">1</span>
        <span class="s2">if </span><span class="s1">s</span><span class="s3">[</span><span class="s5">11</span><span class="s3">]:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;unknown filter category&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_IDAT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; NoReturn</span><span class="s3">:</span>
        <span class="s0"># image data</span>
        <span class="s2">if </span><span class="s6">&quot;bbox&quot; </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">:</span>
            <span class="s1">tile </span><span class="s3">= [(</span><span class="s6">&quot;zip&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;bbox&quot;</span><span class="s3">], </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_rawmode</span><span class="s3">)]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s2">is not None</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;default_image&quot;</span><span class="s3">] = </span><span class="s2">True</span>
            <span class="s1">tile </span><span class="s3">= [(</span><span class="s6">&quot;zip&quot;</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_size</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_rawmode</span><span class="s3">)]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_tile </span><span class="s3">= </span><span class="s1">tile</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_idat </span><span class="s3">= </span><span class="s1">length</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;image data found&quot;</span>
        <span class="s2">raise </span><span class="s1">EOFError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">chunk_IEND</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; NoReturn</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;end of PNG image&quot;</span>
        <span class="s2">raise </span><span class="s1">EOFError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">chunk_PLTE</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># palette</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_mode </span><span class="s3">== </span><span class="s6">&quot;P&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_palette </span><span class="s3">= </span><span class="s6">&quot;RGB&quot;</span><span class="s3">, </span><span class="s1">s</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_tRNS</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># transparency</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_mode </span><span class="s3">== </span><span class="s6">&quot;P&quot;</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">_simple_palette</span><span class="s3">.</span><span class="s1">match</span><span class="s3">(</span><span class="s1">s</span><span class="s3">):</span>
                <span class="s0"># tRNS contains only one full-transparent entry,</span>
                <span class="s0"># other entries are full opaque</span>
                <span class="s1">i </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">i </span><span class="s3">&gt;= </span><span class="s5">0</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;transparency&quot;</span><span class="s3">] = </span><span class="s1">i</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s0"># otherwise, we have a byte string with one alpha value</span>
                <span class="s0"># for each palette entry</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;transparency&quot;</span><span class="s3">] = </span><span class="s1">s</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_mode </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;L&quot;</span><span class="s3">, </span><span class="s6">&quot;I;16&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;transparency&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_mode </span><span class="s3">== </span><span class="s6">&quot;RGB&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;transparency&quot;</span><span class="s3">] = </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">s</span><span class="s3">), </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">2</span><span class="s3">), </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_gAMA</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># gamma setting</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;gamma&quot;</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) / </span><span class="s5">100000.0</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_cHRM</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># chromaticity, 8 unsigned ints, actual value is scaled by 100,000</span>
        <span class="s0"># WP x,y, Red x,y, Green x,y Blue x,y</span>

        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s1">raw_vals </span><span class="s3">= </span><span class="s1">struct</span><span class="s3">.</span><span class="s1">unpack</span><span class="s3">(</span><span class="s6">&quot;&gt;%dI&quot; </span><span class="s3">% (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) // </span><span class="s5">4</span><span class="s3">), </span><span class="s1">s</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;chromaticity&quot;</span><span class="s3">] = </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">elt </span><span class="s3">/ </span><span class="s5">100000.0 </span><span class="s2">for </span><span class="s1">elt </span><span class="s2">in </span><span class="s1">raw_vals</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_sRGB</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># srgb rendering intent, 1 byte</span>
        <span class="s0"># 0 perceptual</span>
        <span class="s0"># 1 relative colorimetric</span>
        <span class="s0"># 2 saturation</span>
        <span class="s0"># 3 absolute colorimetric</span>

        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">s</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Truncated sRGB chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;srgb&quot;</span><span class="s3">] = </span><span class="s1">s</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_pHYs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># pixels per unit</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">9</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">s</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Truncated pHYs chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">px</span><span class="s3">, </span><span class="s1">py </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">unit </span><span class="s3">= </span><span class="s1">s</span><span class="s3">[</span><span class="s5">8</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">unit </span><span class="s3">== </span><span class="s5">1</span><span class="s3">:  </span><span class="s0"># meter</span>
            <span class="s1">dpi </span><span class="s3">= </span><span class="s1">px </span><span class="s3">* </span><span class="s5">0.0254</span><span class="s3">, </span><span class="s1">py </span><span class="s3">* </span><span class="s5">0.0254</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;dpi&quot;</span><span class="s3">] = </span><span class="s1">dpi</span>
        <span class="s2">elif </span><span class="s1">unit </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;aspect&quot;</span><span class="s3">] = </span><span class="s1">px</span><span class="s3">, </span><span class="s1">py</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_tEXt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># text</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s0"># fallback for broken tEXt tags</span>
            <span class="s1">k </span><span class="s3">= </span><span class="s1">s</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s4">b&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">k</span><span class="s3">:</span>
            <span class="s1">k </span><span class="s3">= </span><span class="s1">k</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
            <span class="s1">v_str </span><span class="s3">= </span><span class="s1">v</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;replace&quot;</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v </span><span class="s2">if </span><span class="s1">k </span><span class="s3">== </span><span class="s6">&quot;exif&quot; </span><span class="s2">else </span><span class="s1">v_str</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_text</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v_str</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_text_memory</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">v_str</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_zTXt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># compressed text</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">s</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s1">k </span><span class="s3">= </span><span class="s1">s</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s4">b&quot;&quot;</span>
        <span class="s2">if </span><span class="s1">v</span><span class="s3">:</span>
            <span class="s1">comp_method </span><span class="s3">= </span><span class="s1">v</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">comp_method </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s2">if </span><span class="s1">comp_method </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;Unknown compression method </span><span class="s2">{</span><span class="s1">comp_method</span><span class="s2">} </span><span class="s6">in zTXt chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">_safe_zlib_decompress</span><span class="s3">(</span><span class="s1">v</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:])</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s1">v </span><span class="s3">= </span><span class="s4">b&quot;&quot;</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">raise</span>
        <span class="s2">except </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">:</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s4">b&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">k</span><span class="s3">:</span>
            <span class="s1">k </span><span class="s3">= </span><span class="s1">k</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;replace&quot;</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_text</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">v</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_text_memory</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">v</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_iTXt</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s0"># international text</span>
        <span class="s1">r </span><span class="s3">= </span><span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">k</span><span class="s3">, </span><span class="s1">r </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">s</span>
        <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">r</span><span class="s3">) &lt; </span><span class="s5">2</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">s</span>
        <span class="s1">cf</span><span class="s3">, </span><span class="s1">cm</span><span class="s3">, </span><span class="s1">r </span><span class="s3">= </span><span class="s1">r</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">r</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">r</span><span class="s3">[</span><span class="s5">2</span><span class="s3">:]</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">lang</span><span class="s3">, </span><span class="s1">tk</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">r</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">s</span>
        <span class="s2">if </span><span class="s1">cf </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">cm </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">v </span><span class="s3">= </span><span class="s1">_safe_zlib_decompress</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">ValueError</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                        <span class="s2">return </span><span class="s1">s</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">raise</span>
                <span class="s2">except </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">error</span><span class="s3">:</span>
                    <span class="s2">return </span><span class="s1">s</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">s</span>
        <span class="s2">if </span><span class="s1">k </span><span class="s3">== </span><span class="s4">b&quot;XML:com.adobe.xmp&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;xmp&quot;</span><span class="s3">] = </span><span class="s1">v</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">k </span><span class="s3">= </span><span class="s1">k</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;latin-1&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
            <span class="s1">lang </span><span class="s3">= </span><span class="s1">lang</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
            <span class="s1">tk </span><span class="s3">= </span><span class="s1">tk</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
            <span class="s1">v </span><span class="s3">= </span><span class="s1">v</span><span class="s3">.</span><span class="s1">decode</span><span class="s3">(</span><span class="s6">&quot;utf-8&quot;</span><span class="s3">, </span><span class="s6">&quot;strict&quot;</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">UnicodeError</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">s</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_text</span><span class="s3">[</span><span class="s1">k</span><span class="s3">] = </span><span class="s1">iTXt</span><span class="s3">(</span><span class="s1">v</span><span class="s3">, </span><span class="s1">lang</span><span class="s3">, </span><span class="s1">tk</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">check_text_memory</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">v</span><span class="s3">))</span>

        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_eXIf</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;exif&quot;</span><span class="s3">] = </span><span class="s4">b&quot;Exif</span><span class="s2">\x00\x00</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">s</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s0"># APNG chunks</span>
    <span class="s2">def </span><span class="s1">chunk_acTL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">8</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">s</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG contains truncated acTL chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s6">&quot;Invalid APNG, will use default PNG image if possible&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">s</span>
        <span class="s1">n_frames </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">n_frames </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">or </span><span class="s1">n_frames </span><span class="s3">&gt; </span><span class="s5">0x80000000</span><span class="s3">:</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s6">&quot;Invalid APNG, will use default PNG image if possible&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">s</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s3">= </span><span class="s1">n_frames</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;loop&quot;</span><span class="s3">] = </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_custom_mimetype </span><span class="s3">= </span><span class="s6">&quot;image/apng&quot;</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_fcTL</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">26</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s2">return </span><span class="s1">s</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG contains truncated fcTL chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">seq </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s2">is None and </span><span class="s1">seq </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">) </span><span class="s2">or </span><span class="s3">(</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s2">is not None and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s3">!= </span><span class="s1">seq </span><span class="s3">- </span><span class="s5">1</span>
        <span class="s3">):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG contains frame sequence errors&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s3">= </span><span class="s1">seq</span>
        <span class="s1">width</span><span class="s3">, </span><span class="s1">height </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">4</span><span class="s3">), </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">8</span><span class="s3">)</span>
        <span class="s1">px</span><span class="s3">, </span><span class="s1">py </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">12</span><span class="s3">), </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">16</span><span class="s3">)</span>
        <span class="s1">im_w</span><span class="s3">, </span><span class="s1">im_h </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im_size</span>
        <span class="s2">if </span><span class="s1">px </span><span class="s3">+ </span><span class="s1">width </span><span class="s3">&gt; </span><span class="s1">im_w </span><span class="s2">or </span><span class="s1">py </span><span class="s3">+ </span><span class="s1">height </span><span class="s3">&gt; </span><span class="s1">im_h</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG contains invalid frames&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;bbox&quot;</span><span class="s3">] = (</span><span class="s1">px</span><span class="s3">, </span><span class="s1">py</span><span class="s3">, </span><span class="s1">px </span><span class="s3">+ </span><span class="s1">width</span><span class="s3">, </span><span class="s1">py </span><span class="s3">+ </span><span class="s1">height</span><span class="s3">)</span>
        <span class="s1">delay_num</span><span class="s3">, </span><span class="s1">delay_den </span><span class="s3">= </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">20</span><span class="s3">), </span><span class="s1">i16</span><span class="s3">(</span><span class="s1">s</span><span class="s3">, </span><span class="s5">22</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">delay_den </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">delay_den </span><span class="s3">= </span><span class="s5">100</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;duration&quot;</span><span class="s3">] = </span><span class="s1">float</span><span class="s3">(</span><span class="s1">delay_num</span><span class="s3">) / </span><span class="s1">float</span><span class="s3">(</span><span class="s1">delay_den</span><span class="s3">) * </span><span class="s5">1000</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;disposal&quot;</span><span class="s3">] = </span><span class="s1">s</span><span class="s3">[</span><span class="s5">24</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">im_info</span><span class="s3">[</span><span class="s6">&quot;blend&quot;</span><span class="s3">] = </span><span class="s1">s</span><span class="s3">[</span><span class="s5">25</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">s</span>

    <span class="s2">def </span><span class="s1">chunk_fdAT</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">length</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">length </span><span class="s3">&lt; </span><span class="s5">4</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">s</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG contains truncated fDAT chunk&quot;</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>
        <span class="s1">seq </span><span class="s3">= </span><span class="s1">i32</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s3">!= </span><span class="s1">seq </span><span class="s3">- </span><span class="s5">1</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG contains frame sequence errors&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_seq_num </span><span class="s3">= </span><span class="s1">seq</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">chunk_IDAT</span><span class="s3">(</span><span class="s1">pos </span><span class="s3">+ </span><span class="s5">4</span><span class="s3">, </span><span class="s1">length </span><span class="s3">- </span><span class="s5">4</span><span class="s3">)</span>


<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># PNG reader</span>


<span class="s2">def </span><span class="s1">_accept</span><span class="s3">(</span><span class="s1">prefix</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s2">return </span><span class="s1">prefix</span><span class="s3">[:</span><span class="s5">8</span><span class="s3">] == </span><span class="s1">_MAGIC</span>


<span class="s0">##</span>
<span class="s0"># Image plugin for PNG images.</span>


<span class="s2">class </span><span class="s1">PngImageFile</span><span class="s3">(</span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">ImageFile</span><span class="s3">):</span>
    <span class="s1">format </span><span class="s3">= </span><span class="s6">&quot;PNG&quot;</span>
    <span class="s1">format_description </span><span class="s3">= </span><span class="s6">&quot;Portable network graphics&quot;</span>

    <span class="s2">def </span><span class="s1">_open</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">_accept</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">8</span><span class="s3">)):</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;not a PNG file&quot;</span>
            <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_fp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">__frame </span><span class="s3">= </span><span class="s5">0</span>

        <span class="s0">#</span>
        <span class="s0"># Parse headers up to the first IDAT or fDAT chunk</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">private_chunks</span><span class="s3">: </span><span class="s1">list</span><span class="s3">[</span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">] | </span><span class="s1">tuple</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]] = []</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">: </span><span class="s1">PngStream </span><span class="s3">| </span><span class="s2">None </span><span class="s3">= </span><span class="s1">PngStream</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">)</span>

        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s0">#</span>
            <span class="s0"># get next chunk</span>

            <span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">EOFError</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">&quot;%r %s %s (unknown)&quot;</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">cid</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">islower</span><span class="s3">():</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">private_chunks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">s</span><span class="s3">))</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">crc</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)</span>

        <span class="s0">#</span>
        <span class="s0"># Copy relevant attributes from the PngStream.  An alternative</span>
        <span class="s0"># would be to let the PngStream class modify these attributes</span>
        <span class="s0"># directly, but that introduces circular references which are</span>
        <span class="s0"># difficult to break if things go wrong in the decoder...</span>
        <span class="s0"># (believe me, I've tried ;-)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_mode </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_mode</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_size </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_size</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">info </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_info</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_text </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">tile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_tile</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">custom_mimetype </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_custom_mimetype</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">n_frames </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s2">or </span><span class="s5">1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">default_image </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;default_image&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_palette</span><span class="s3">:</span>
            <span class="s1">rawmode</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_palette</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">palette </span><span class="s3">= </span><span class="s1">ImagePalette</span><span class="s3">.</span><span class="s1">raw</span><span class="s3">(</span><span class="s1">rawmode</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;fdAT&quot;</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat </span><span class="s3">= </span><span class="s1">length </span><span class="s3">- </span><span class="s5">4</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat </span><span class="s3">= </span><span class="s1">length  </span><span class="s0"># used by load_prepare()</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_n_frames </span><span class="s2">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_close_exclusive_fp_after_loading </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">save_rewind</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">__rewind_idat </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">__rewind </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fp</span><span class="s3">.</span><span class="s1">tell</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">default_image</span><span class="s3">:</span>
                <span class="s0"># IDAT chunk contains default image and not first animation frame</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">n_frames </span><span class="s3">+= </span><span class="s5">1</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">is_animated </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">n_frames </span><span class="s3">&gt; </span><span class="s5">1</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s2">def </span><span class="s1">text</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># experimental</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_text </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s0"># iTxt, tEXt and zTXt chunks may appear at the end of the file</span>
            <span class="s0"># So load the file to ensure that they are read</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">is_animated</span><span class="s3">:</span>
                <span class="s1">frame </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__frame</span>
                <span class="s0"># for APNG, seek to the final frame before loading</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">n_frames </span><span class="s3">- </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">is_animated</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_text</span>

    <span class="s2">def </span><span class="s1">verify</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;Verify PNG file&quot;&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s2">is None</span><span class="s3">:</span>
            <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;verify must be called directly after open&quot;</span>
            <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s0"># back up to beginning of IDAT block</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">tile</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s5">2</span><span class="s3">] - </span><span class="s5">8</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png </span><span class="s2">is not None</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">verify</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_exclusive_fp</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">seek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_seek_check</span><span class="s3">(</span><span class="s1">frame</span><span class="s3">):</span>
            <span class="s2">return</span>
        <span class="s2">if </span><span class="s1">frame </span><span class="s3">&lt; </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__frame</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_seek</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">last_frame </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__frame</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__frame </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">, </span><span class="s1">frame </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">):</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_seek</span><span class="s3">(</span><span class="s1">f</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">EOFError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">last_frame</span><span class="s3">)</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;no more images in APNG file&quot;</span>
                <span class="s2">raise </span><span class="s1">EOFError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) </span><span class="s2">from </span><span class="s1">e</span>

    <span class="s2">def </span><span class="s1">_seek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">frame</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">rewind</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s2">False</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png </span><span class="s2">is not None</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">: </span><span class="s1">_imaging</span><span class="s3">.</span><span class="s1">ImagingCore </span><span class="s3">| </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">frame </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">rewind</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_fp</span><span class="s3">.</span><span class="s1">seek</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__rewind</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">rewind</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__rewind_idat</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">im </span><span class="s3">= </span><span class="s2">None</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pyaccess</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">pyaccess </span><span class="s3">= </span><span class="s2">None</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">info </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_info</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">tile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_tile</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fp</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">default_image </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;default_image&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_op </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">blend_op </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;bbox&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">__frame </span><span class="s3">= </span><span class="s5">0</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">frame </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__frame </span><span class="s3">+ </span><span class="s5">1</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;cannot seek to frame </span><span class="s2">{</span><span class="s1">frame</span><span class="s2">}</span><span class="s6">&quot;</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

            <span class="s0"># ensure previous frame was loaded</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>

            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_fp</span>

            <span class="s0"># advance to the next frame</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat</span><span class="s3">:</span>
                <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat </span><span class="s3">= </span><span class="s5">0</span>
            <span class="s1">frame_start </span><span class="s3">= </span><span class="s2">False</span>
            <span class="s2">while True</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)  </span><span class="s0"># CRC</span>

                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
                <span class="s2">except </span><span class="s3">(</span><span class="s1">struct</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">SyntaxError</span><span class="s3">):</span>
                    <span class="s2">break</span>

                <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;IEND&quot;</span><span class="s3">:</span>
                    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;No more images in APNG file&quot;</span>
                    <span class="s2">raise </span><span class="s1">EOFError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;fcTL&quot;</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">frame_start</span><span class="s3">:</span>
                        <span class="s0"># there must be at least one fdAT chunk between fcTL chunks</span>
                        <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;APNG missing frame data&quot;</span>
                        <span class="s2">raise </span><span class="s1">SyntaxError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
                    <span class="s1">frame_start </span><span class="s3">= </span><span class="s2">True</span>

                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">UnicodeDecodeError</span><span class="s3">:</span>
                    <span class="s2">break</span>
                <span class="s2">except </span><span class="s1">EOFError</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;fdAT&quot;</span><span class="s3">:</span>
                        <span class="s1">length </span><span class="s3">-= </span><span class="s5">4</span>
                        <span class="s2">if </span><span class="s1">frame_start</span><span class="s3">:</span>
                            <span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat </span><span class="s3">= </span><span class="s1">length</span>
                            <span class="s2">break</span>
                    <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">&quot;%r %s %s (unknown)&quot;</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                    <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">__frame </span><span class="s3">= </span><span class="s1">frame</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">tile </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_tile</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_op </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">blend_op </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;bbox&quot;</span><span class="s3">)</span>

            <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">tile</span><span class="s3">:</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;image not found in APNG frame&quot;</span>
                <span class="s2">raise </span><span class="s1">EOFError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>

        <span class="s0"># setup frame disposal (actual disposal done when needed in the next _seek())</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im </span><span class="s2">is None and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_op </span><span class="s3">== </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_PREVIOUS</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_op </span><span class="s3">= </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_BACKGROUND</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_op </span><span class="s3">== </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_PREVIOUS</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_crop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent</span><span class="s3">)</span>
        <span class="s2">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_op </span><span class="s3">== </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_BACKGROUND</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose </span><span class="s3">= </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">fill</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">dispose </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_crop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">tell</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__frame</span>

    <span class="s2">def </span><span class="s1">load_prepare</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;internal: prepare to read PNG file&quot;&quot;&quot;</span>

        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;interlace&quot;</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">decoderconfig </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">decoderconfig </span><span class="s3">+ (</span><span class="s5">1</span><span class="s3">,)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat  </span><span class="s0"># used by load_read()</span>
        <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">load_prepare</span><span class="s3">(</span><span class="s1">self</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">load_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">read_bytes</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;internal: read more image data&quot;&quot;&quot;</span>

        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png </span><span class="s2">is not None</span>
        <span class="s2">while </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s0"># end of chunk, skip forward to next one</span>

            <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)  </span><span class="s0"># CRC</span>

            <span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

            <span class="s2">if </span><span class="s1">cid </span><span class="s2">not in </span><span class="s3">[</span><span class="s4">b&quot;IDAT&quot;</span><span class="s3">, </span><span class="s4">b&quot;DDAT&quot;</span><span class="s3">, </span><span class="s4">b&quot;fdAT&quot;</span><span class="s3">]:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s4">b&quot;&quot;</span>

            <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;fdAT&quot;</span><span class="s3">:</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">EOFError</span><span class="s3">:</span>
                    <span class="s2">pass</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">= </span><span class="s1">length </span><span class="s3">- </span><span class="s5">4  </span><span class="s0"># sequence_num has already been read</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">= </span><span class="s1">length  </span><span class="s0"># empty chunks are allowed</span>

        <span class="s0"># read more data from this chunk</span>
        <span class="s2">if </span><span class="s1">read_bytes </span><span class="s3">&lt;= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">read_bytes </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__idat</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">read_bytes </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">read_bytes</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__idat</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">- </span><span class="s1">read_bytes</span>

        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">read_bytes</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">load_end</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s7">&quot;&quot;&quot;internal: finished reading image data&quot;&quot;&quot;</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png </span><span class="s2">is not None</span>
        <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__idat </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">__idat</span><span class="s3">)</span>
        <span class="s2">while True</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s5">4</span><span class="s3">)  </span><span class="s0"># CRC</span>

            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
            <span class="s2">except </span><span class="s3">(</span><span class="s1">struct</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">SyntaxError</span><span class="s3">):</span>
                <span class="s2">break</span>

            <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;IEND&quot;</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s2">elif </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;fcTL&quot; </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">is_animated</span><span class="s3">:</span>
                <span class="s0"># start of the next frame, stop reading</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">__prepare_idat </span><span class="s3">= </span><span class="s5">0</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">push</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">break</span>

            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">call</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">UnicodeDecodeError</span><span class="s3">:</span>
                <span class="s2">break</span>
            <span class="s2">except </span><span class="s1">EOFError</span><span class="s3">:</span>
                <span class="s2">if </span><span class="s1">cid </span><span class="s3">== </span><span class="s4">b&quot;fdAT&quot;</span><span class="s3">:</span>
                    <span class="s1">length </span><span class="s3">-= </span><span class="s5">4</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">OSError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s2">if </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">LOAD_TRUNCATED_IMAGES</span><span class="s3">:</span>
                        <span class="s2">break</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s2">raise </span><span class="s1">e</span>
            <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s6">&quot;%r %s %s (unknown)&quot;</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s1">s </span><span class="s3">= </span><span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_safe_read</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">length</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">cid</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">islower</span><span class="s3">():</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">private_chunks</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">s</span><span class="s3">, </span><span class="s2">True</span><span class="s3">))</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_text </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">im_text</span>
        <span class="s2">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">is_animated</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">png</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">png </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im </span><span class="s2">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">blend_op </span><span class="s3">== </span><span class="s1">Blend</span><span class="s3">.</span><span class="s1">OP_OVER</span><span class="s3">:</span>
                <span class="s1">updated </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_crop</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s6">&quot;RGB&quot; </span><span class="s2">and </span><span class="s6">&quot;transparency&quot; </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">:</span>
                    <span class="s1">mask </span><span class="s3">= </span><span class="s1">updated</span><span class="s3">.</span><span class="s1">convert_transparent</span><span class="s3">(</span>
                        <span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">[</span><span class="s6">&quot;transparency&quot;</span><span class="s3">]</span>
                    <span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">mask </span><span class="s3">= </span><span class="s1">updated</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">(</span><span class="s1">updated</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">dispose_extent</span><span class="s3">, </span><span class="s1">mask</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">im </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_prev_im</span>
                <span class="s2">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">pyaccess</span><span class="s3">:</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">pyaccess </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">def </span><span class="s1">_getexif</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Any</span><span class="s3">] | </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s6">&quot;exif&quot; </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s6">&quot;exif&quot; </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info </span><span class="s2">and </span><span class="s6">&quot;Raw profile type exif&quot; </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">:</span>
            <span class="s2">return None</span>
        <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">getexif</span><span class="s3">().</span><span class="s1">_get_merged_dict</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">getexif</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Image</span><span class="s3">.</span><span class="s1">Exif</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s6">&quot;exif&quot; </span><span class="s2">not in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">info</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">load</span><span class="s3">()</span>

        <span class="s2">return </span><span class="s1">super</span><span class="s3">().</span><span class="s1">getexif</span><span class="s3">()</span>


<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># PNG writer</span>

<span class="s1">_OUTMODES </span><span class="s3">= {</span>
    <span class="s0"># supported PIL modes, and corresponding rawmode, bit depth and color type</span>
    <span class="s6">&quot;1&quot;</span><span class="s3">: (</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x01</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;L;1&quot;</span><span class="s3">: (</span><span class="s6">&quot;L;1&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x01</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;L;2&quot;</span><span class="s3">: (</span><span class="s6">&quot;L;2&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x02</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;L;4&quot;</span><span class="s3">: (</span><span class="s6">&quot;L;4&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x04</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;L&quot;</span><span class="s3">: (</span><span class="s6">&quot;L&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x08</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;LA&quot;</span><span class="s3">: (</span><span class="s6">&quot;LA&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x08</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x04</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;I&quot;</span><span class="s3">: (</span><span class="s6">&quot;I;16B&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x10</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;I;16&quot;</span><span class="s3">: (</span><span class="s6">&quot;I;16B&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x10</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;I;16B&quot;</span><span class="s3">: (</span><span class="s6">&quot;I;16B&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x10</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x00</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;P;1&quot;</span><span class="s3">: (</span><span class="s6">&quot;P;1&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x01</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x03</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;P;2&quot;</span><span class="s3">: (</span><span class="s6">&quot;P;2&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x02</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x03</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;P;4&quot;</span><span class="s3">: (</span><span class="s6">&quot;P;4&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x04</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x03</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;P&quot;</span><span class="s3">: (</span><span class="s6">&quot;P&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x08</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x03</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;RGB&quot;</span><span class="s3">: (</span><span class="s6">&quot;RGB&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x08</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x02</span><span class="s4">&quot;</span><span class="s3">),</span>
    <span class="s6">&quot;RGBA&quot;</span><span class="s3">: (</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x08</span><span class="s4">&quot;</span><span class="s3">, </span><span class="s4">b&quot;</span><span class="s2">\x06</span><span class="s4">&quot;</span><span class="s3">),</span>
<span class="s3">}</span>


<span class="s2">def </span><span class="s1">putchunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, *</span><span class="s1">data</span><span class="s3">):</span>
    <span class="s7">&quot;&quot;&quot;Write a PNG chunk (including CRC field)&quot;&quot;&quot;</span>

    <span class="s1">data </span><span class="s3">= </span><span class="s4">b&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>

    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">o32</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)) + </span><span class="s1">cid</span><span class="s3">)</span>
    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">crc </span><span class="s3">= </span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">))</span>
    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">o32</span><span class="s3">(</span><span class="s1">crc</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">_idat</span><span class="s3">:</span>
    <span class="s0"># wrap output from the encoder in IDAT chunks</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s3">= </span><span class="s1">fp</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">chunk </span><span class="s3">= </span><span class="s1">chunk</span>

    <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">chunk</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;IDAT&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">_fdat</span><span class="s3">:</span>
    <span class="s0"># wrap encoder output in fdAT chunks</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">, </span><span class="s1">seq_num</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">fp </span><span class="s3">= </span><span class="s1">fp</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">chunk </span><span class="s3">= </span><span class="s1">chunk</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">seq_num </span><span class="s3">= </span><span class="s1">seq_num</span>

    <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">chunk</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;fdAT&quot;</span><span class="s3">, </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">seq_num</span><span class="s3">), </span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">seq_num </span><span class="s3">+= </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">_write_multiple_frames</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">rawmode</span><span class="s3">, </span><span class="s1">default_image</span><span class="s3">, </span><span class="s1">append_images</span><span class="s3">):</span>
    <span class="s1">duration </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;duration&quot;</span><span class="s3">)</span>
    <span class="s1">loop </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;loop&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;loop&quot;</span><span class="s3">, </span><span class="s5">0</span><span class="s3">))</span>
    <span class="s1">disposal </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">, </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_NONE</span><span class="s3">))</span>
    <span class="s1">blend </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">, </span><span class="s1">Blend</span><span class="s3">.</span><span class="s1">OP_SOURCE</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">default_image</span><span class="s3">:</span>
        <span class="s1">chain </span><span class="s3">= </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">chain</span><span class="s3">(</span><span class="s1">append_images</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">chain </span><span class="s3">= </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">chain</span><span class="s3">([</span><span class="s1">im</span><span class="s3">], </span><span class="s1">append_images</span><span class="s3">)</span>

    <span class="s1">im_frames </span><span class="s3">= []</span>
    <span class="s1">frame_count </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s2">for </span><span class="s1">im_seq </span><span class="s2">in </span><span class="s1">chain</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">im_frame </span><span class="s2">in </span><span class="s1">ImageSequence</span><span class="s3">.</span><span class="s1">Iterator</span><span class="s3">(</span><span class="s1">im_seq</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s1">mode</span><span class="s3">:</span>
                <span class="s1">im_frame </span><span class="s3">= </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">im_frame </span><span class="s3">= </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">)</span>
            <span class="s1">encoderinfo </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">duration</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
                <span class="s1">encoderinfo</span><span class="s3">[</span><span class="s6">&quot;duration&quot;</span><span class="s3">] = </span><span class="s1">duration</span><span class="s3">[</span><span class="s1">frame_count</span><span class="s3">]</span>
            <span class="s2">elif </span><span class="s1">duration </span><span class="s2">is None and </span><span class="s6">&quot;duration&quot; </span><span class="s2">in </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">info</span><span class="s3">:</span>
                <span class="s1">encoderinfo</span><span class="s3">[</span><span class="s6">&quot;duration&quot;</span><span class="s3">] = </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">info</span><span class="s3">[</span><span class="s6">&quot;duration&quot;</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">disposal</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
                <span class="s1">encoderinfo</span><span class="s3">[</span><span class="s6">&quot;disposal&quot;</span><span class="s3">] = </span><span class="s1">disposal</span><span class="s3">[</span><span class="s1">frame_count</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">blend</span><span class="s3">, (</span><span class="s1">list</span><span class="s3">, </span><span class="s1">tuple</span><span class="s3">)):</span>
                <span class="s1">encoderinfo</span><span class="s3">[</span><span class="s6">&quot;blend&quot;</span><span class="s3">] = </span><span class="s1">blend</span><span class="s3">[</span><span class="s1">frame_count</span><span class="s3">]</span>
            <span class="s1">frame_count </span><span class="s3">+= </span><span class="s5">1</span>

            <span class="s2">if </span><span class="s1">im_frames</span><span class="s3">:</span>
                <span class="s1">previous </span><span class="s3">= </span><span class="s1">im_frames</span><span class="s3">[-</span><span class="s5">1</span><span class="s3">]</span>
                <span class="s1">prev_disposal </span><span class="s3">= </span><span class="s1">previous</span><span class="s3">[</span><span class="s6">&quot;encoderinfo&quot;</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">)</span>
                <span class="s1">prev_blend </span><span class="s3">= </span><span class="s1">previous</span><span class="s3">[</span><span class="s6">&quot;encoderinfo&quot;</span><span class="s3">].</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s1">prev_disposal </span><span class="s3">== </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_PREVIOUS </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">im_frames</span><span class="s3">) &lt; </span><span class="s5">2</span><span class="s3">:</span>
                    <span class="s1">prev_disposal </span><span class="s3">= </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_BACKGROUND</span>

                <span class="s2">if </span><span class="s1">prev_disposal </span><span class="s3">== </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_BACKGROUND</span><span class="s3">:</span>
                    <span class="s1">base_im </span><span class="s3">= </span><span class="s1">previous</span><span class="s3">[</span><span class="s6">&quot;im&quot;</span><span class="s3">].</span><span class="s1">copy</span><span class="s3">()</span>
                    <span class="s1">dispose </span><span class="s3">= </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">core</span><span class="s3">.</span><span class="s1">fill</span><span class="s3">(</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">))</span>
                    <span class="s1">bbox </span><span class="s3">= </span><span class="s1">previous</span><span class="s3">[</span><span class="s6">&quot;bbox&quot;</span><span class="s3">]</span>
                    <span class="s2">if </span><span class="s1">bbox</span><span class="s3">:</span>
                        <span class="s1">dispose </span><span class="s3">= </span><span class="s1">dispose</span><span class="s3">.</span><span class="s1">crop</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">)</span>
                    <span class="s2">else</span><span class="s3">:</span>
                        <span class="s1">bbox </span><span class="s3">= (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span>
                    <span class="s1">base_im</span><span class="s3">.</span><span class="s1">paste</span><span class="s3">(</span><span class="s1">dispose</span><span class="s3">, </span><span class="s1">bbox</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">prev_disposal </span><span class="s3">== </span><span class="s1">Disposal</span><span class="s3">.</span><span class="s1">OP_PREVIOUS</span><span class="s3">:</span>
                    <span class="s1">base_im </span><span class="s3">= </span><span class="s1">im_frames</span><span class="s3">[-</span><span class="s5">2</span><span class="s3">][</span><span class="s6">&quot;im&quot;</span><span class="s3">]</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">base_im </span><span class="s3">= </span><span class="s1">previous</span><span class="s3">[</span><span class="s6">&quot;im&quot;</span><span class="s3">]</span>
                <span class="s1">delta </span><span class="s3">= </span><span class="s1">ImageChops</span><span class="s3">.</span><span class="s1">subtract_modulo</span><span class="s3">(</span>
                    <span class="s1">im_frame</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">), </span><span class="s1">base_im</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">)</span>
                <span class="s3">)</span>
                <span class="s1">bbox </span><span class="s3">= </span><span class="s1">delta</span><span class="s3">.</span><span class="s1">getbbox</span><span class="s3">(</span><span class="s1">alpha_only</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
                <span class="s2">if </span><span class="s3">(</span>
                    <span class="s2">not </span><span class="s1">bbox</span>
                    <span class="s2">and </span><span class="s1">prev_disposal </span><span class="s3">== </span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">)</span>
                    <span class="s2">and </span><span class="s1">prev_blend </span><span class="s3">== </span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">)</span>
                    <span class="s2">and </span><span class="s6">&quot;duration&quot; </span><span class="s2">in </span><span class="s1">encoderinfo</span>
                <span class="s3">):</span>
                    <span class="s1">previous</span><span class="s3">[</span><span class="s6">&quot;encoderinfo&quot;</span><span class="s3">][</span><span class="s6">&quot;duration&quot;</span><span class="s3">] += </span><span class="s1">encoderinfo</span><span class="s3">[</span><span class="s6">&quot;duration&quot;</span><span class="s3">]</span>
                    <span class="s2">continue</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bbox </span><span class="s3">= </span><span class="s2">None</span>
            <span class="s1">im_frames</span><span class="s3">.</span><span class="s1">append</span><span class="s3">({</span><span class="s6">&quot;im&quot;</span><span class="s3">: </span><span class="s1">im_frame</span><span class="s3">, </span><span class="s6">&quot;bbox&quot;</span><span class="s3">: </span><span class="s1">bbox</span><span class="s3">, </span><span class="s6">&quot;encoderinfo&quot;</span><span class="s3">: </span><span class="s1">encoderinfo</span><span class="s3">})</span>

    <span class="s2">if </span><span class="s1">len</span><span class="s3">(</span><span class="s1">im_frames</span><span class="s3">) == </span><span class="s5">1 </span><span class="s2">and not </span><span class="s1">default_image</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">im_frames</span><span class="s3">[</span><span class="s5">0</span><span class="s3">][</span><span class="s6">&quot;im&quot;</span><span class="s3">]</span>

    <span class="s0"># animation control</span>
    <span class="s1">chunk</span><span class="s3">(</span>
        <span class="s1">fp</span><span class="s3">,</span>
        <span class="s4">b&quot;acTL&quot;</span><span class="s3">,</span>
        <span class="s1">o32</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">im_frames</span><span class="s3">)),  </span><span class="s0"># 0: num_frames</span>
        <span class="s1">o32</span><span class="s3">(</span><span class="s1">loop</span><span class="s3">),  </span><span class="s0"># 4: num_plays</span>
    <span class="s3">)</span>

    <span class="s0"># default image IDAT (if it exists)</span>
    <span class="s2">if </span><span class="s1">default_image</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">!= </span><span class="s1">mode</span><span class="s3">:</span>
            <span class="s1">im </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">convert</span><span class="s3">(</span><span class="s1">mode</span><span class="s3">)</span>
        <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">_idat</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">), [(</span><span class="s6">&quot;zip&quot;</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">rawmode</span><span class="s3">)])</span>

    <span class="s1">seq_num </span><span class="s3">= </span><span class="s5">0</span>
    <span class="s2">for </span><span class="s1">frame</span><span class="s3">, </span><span class="s1">frame_data </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">im_frames</span><span class="s3">):</span>
        <span class="s1">im_frame </span><span class="s3">= </span><span class="s1">frame_data</span><span class="s3">[</span><span class="s6">&quot;im&quot;</span><span class="s3">]</span>
        <span class="s2">if not </span><span class="s1">frame_data</span><span class="s3">[</span><span class="s6">&quot;bbox&quot;</span><span class="s3">]:</span>
            <span class="s1">bbox </span><span class="s3">= (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">size</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">bbox </span><span class="s3">= </span><span class="s1">frame_data</span><span class="s3">[</span><span class="s6">&quot;bbox&quot;</span><span class="s3">]</span>
            <span class="s1">im_frame </span><span class="s3">= </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">crop</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">)</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">size</span>
        <span class="s1">encoderinfo </span><span class="s3">= </span><span class="s1">frame_data</span><span class="s3">[</span><span class="s6">&quot;encoderinfo&quot;</span><span class="s3">]</span>
        <span class="s1">frame_duration </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">round</span><span class="s3">(</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;duration&quot;</span><span class="s3">, </span><span class="s5">0</span><span class="s3">)))</span>
        <span class="s1">frame_disposal </span><span class="s3">= </span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;disposal&quot;</span><span class="s3">, </span><span class="s1">disposal</span><span class="s3">)</span>
        <span class="s1">frame_blend </span><span class="s3">= </span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;blend&quot;</span><span class="s3">, </span><span class="s1">blend</span><span class="s3">)</span>
        <span class="s0"># frame control</span>
        <span class="s1">chunk</span><span class="s3">(</span>
            <span class="s1">fp</span><span class="s3">,</span>
            <span class="s4">b&quot;fcTL&quot;</span><span class="s3">,</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">seq_num</span><span class="s3">),  </span><span class="s0"># sequence_number</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]),  </span><span class="s0"># width</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]),  </span><span class="s0"># height</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]),  </span><span class="s0"># x_offset</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">bbox</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]),  </span><span class="s0"># y_offset</span>
            <span class="s1">o16</span><span class="s3">(</span><span class="s1">frame_duration</span><span class="s3">),  </span><span class="s0"># delay_numerator</span>
            <span class="s1">o16</span><span class="s3">(</span><span class="s5">1000</span><span class="s3">),  </span><span class="s0"># delay_denominator</span>
            <span class="s1">o8</span><span class="s3">(</span><span class="s1">frame_disposal</span><span class="s3">),  </span><span class="s0"># dispose_op</span>
            <span class="s1">o8</span><span class="s3">(</span><span class="s1">frame_blend</span><span class="s3">),  </span><span class="s0"># blend_op</span>
        <span class="s3">)</span>
        <span class="s1">seq_num </span><span class="s3">+= </span><span class="s5">1</span>
        <span class="s0"># frame data</span>
        <span class="s2">if </span><span class="s1">frame </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">and not </span><span class="s1">default_image</span><span class="s3">:</span>
            <span class="s0"># first frame must be in IDAT chunks for backwards compatibility</span>
            <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_save</span><span class="s3">(</span>
                <span class="s1">im_frame</span><span class="s3">,</span>
                <span class="s1">_idat</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">),</span>
                <span class="s3">[(</span><span class="s6">&quot;zip&quot;</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">rawmode</span><span class="s3">)],</span>
            <span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">fdat_chunks </span><span class="s3">= </span><span class="s1">_fdat</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">, </span><span class="s1">seq_num</span><span class="s3">)</span>
            <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_save</span><span class="s3">(</span>
                <span class="s1">im_frame</span><span class="s3">,</span>
                <span class="s1">fdat_chunks</span><span class="s3">,</span>
                <span class="s3">[(</span><span class="s6">&quot;zip&quot;</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">rawmode</span><span class="s3">)],</span>
            <span class="s3">)</span>
            <span class="s1">seq_num </span><span class="s3">= </span><span class="s1">fdat_chunks</span><span class="s3">.</span><span class="s1">seq_num</span>


<span class="s2">def </span><span class="s1">_save_all</span><span class="s3">(</span><span class="s1">im</span><span class="s3">: </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Image</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">: </span><span class="s1">IO</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">], </span><span class="s1">filename</span><span class="s3">: </span><span class="s1">str </span><span class="s3">| </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">save_all</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">=</span><span class="s1">putchunk</span><span class="s3">, </span><span class="s1">save_all</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
    <span class="s0"># save an image to disk (called by the save method)</span>

    <span class="s2">if </span><span class="s1">save_all</span><span class="s3">:</span>
        <span class="s1">default_image </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span>
            <span class="s6">&quot;default_image&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;default_image&quot;</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s1">modes </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">sizes </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s1">append_images </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;append_images&quot;</span><span class="s3">, [])</span>
        <span class="s2">for </span><span class="s1">im_seq </span><span class="s2">in </span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">chain</span><span class="s3">([</span><span class="s1">im</span><span class="s3">], </span><span class="s1">append_images</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">im_frame </span><span class="s2">in </span><span class="s1">ImageSequence</span><span class="s3">.</span><span class="s1">Iterator</span><span class="s3">(</span><span class="s1">im_seq</span><span class="s3">):</span>
                <span class="s1">modes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">mode</span><span class="s3">)</span>
                <span class="s1">sizes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">im_frame</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">mode </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s6">&quot;RGB&quot;</span><span class="s3">, </span><span class="s6">&quot;P&quot;</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">mode </span><span class="s2">in </span><span class="s1">modes</span><span class="s3">:</span>
                <span class="s2">break</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">mode </span><span class="s3">= </span><span class="s1">modes</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">max</span><span class="s3">(</span><span class="s1">frame_size</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">for </span><span class="s1">frame_size </span><span class="s2">in </span><span class="s1">sizes</span><span class="s3">) </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s5">2</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">size </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span>
        <span class="s1">mode </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode</span>

    <span class="s1">outmode </span><span class="s3">= </span><span class="s1">mode</span>
    <span class="s2">if </span><span class="s1">mode </span><span class="s3">== </span><span class="s6">&quot;P&quot;</span><span class="s3">:</span>
        <span class="s0">#</span>
        <span class="s0"># attempt to minimize storage requirements for palette images</span>
        <span class="s2">if </span><span class="s6">&quot;bits&quot; </span><span class="s2">in </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">:</span>
            <span class="s0"># number of bits specified by user</span>
            <span class="s1">colors </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s5">1 </span><span class="s3">&lt;&lt; </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">[</span><span class="s6">&quot;bits&quot;</span><span class="s3">], </span><span class="s5">256</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s0"># check palette contents</span>
            <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">palette</span><span class="s3">:</span>
                <span class="s1">colors </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s1">min</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">im</span><span class="s3">.</span><span class="s1">palette</span><span class="s3">.</span><span class="s1">getdata</span><span class="s3">()[</span><span class="s5">1</span><span class="s3">]) // </span><span class="s5">3</span><span class="s3">, </span><span class="s5">256</span><span class="s3">), </span><span class="s5">1</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">colors </span><span class="s3">= </span><span class="s5">256</span>

        <span class="s2">if </span><span class="s1">colors </span><span class="s3">&lt;= </span><span class="s5">16</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s1">colors </span><span class="s3">&lt;= </span><span class="s5">2</span><span class="s3">:</span>
                <span class="s1">bits </span><span class="s3">= </span><span class="s5">1</span>
            <span class="s2">elif </span><span class="s1">colors </span><span class="s3">&lt;= </span><span class="s5">4</span><span class="s3">:</span>
                <span class="s1">bits </span><span class="s3">= </span><span class="s5">2</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">bits </span><span class="s3">= </span><span class="s5">4</span>
            <span class="s1">outmode </span><span class="s3">+= </span><span class="s6">f&quot;;</span><span class="s2">{</span><span class="s1">bits</span><span class="s2">}</span><span class="s6">&quot;</span>

    <span class="s0"># encoder options</span>
    <span class="s1">im</span><span class="s3">.</span><span class="s1">encoderconfig </span><span class="s3">= (</span>
        <span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;optimize&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">),</span>
        <span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;compress_level&quot;</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">),</span>
        <span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;compress_type&quot;</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">),</span>
        <span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;dictionary&quot;</span><span class="s3">, </span><span class="s4">b&quot;&quot;</span><span class="s3">),</span>
    <span class="s3">)</span>

    <span class="s0"># get the corresponding PNG mode</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">rawmode</span><span class="s3">, </span><span class="s1">bit_depth</span><span class="s3">, </span><span class="s1">color_type </span><span class="s3">= </span><span class="s1">_OUTMODES</span><span class="s3">[</span><span class="s1">outmode</span><span class="s3">]</span>
    <span class="s2">except </span><span class="s1">KeyError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s6">f&quot;cannot write mode </span><span class="s2">{</span><span class="s1">mode</span><span class="s2">} </span><span class="s6">as PNG&quot;</span>
        <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">) </span><span class="s2">from </span><span class="s1">e</span>

    <span class="s0">#</span>
    <span class="s0"># write minimal PNG file</span>

    <span class="s1">fp</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">_MAGIC</span><span class="s3">)</span>

    <span class="s1">chunk</span><span class="s3">(</span>
        <span class="s1">fp</span><span class="s3">,</span>
        <span class="s4">b&quot;IHDR&quot;</span><span class="s3">,</span>
        <span class="s1">o32</span><span class="s3">(</span><span class="s1">size</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]),  </span><span class="s0"># 0: size</span>
        <span class="s1">o32</span><span class="s3">(</span><span class="s1">size</span><span class="s3">[</span><span class="s5">1</span><span class="s3">]),</span>
        <span class="s1">bit_depth</span><span class="s3">,</span>
        <span class="s1">color_type</span><span class="s3">,</span>
        <span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">,  </span><span class="s0"># 10: compression</span>
        <span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">,  </span><span class="s0"># 11: filter category</span>
        <span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span><span class="s3">,  </span><span class="s0"># 12: interlace flag</span>
    <span class="s3">)</span>

    <span class="s1">chunks </span><span class="s3">= [</span><span class="s4">b&quot;cHRM&quot;</span><span class="s3">, </span><span class="s4">b&quot;gAMA&quot;</span><span class="s3">, </span><span class="s4">b&quot;sBIT&quot;</span><span class="s3">, </span><span class="s4">b&quot;sRGB&quot;</span><span class="s3">, </span><span class="s4">b&quot;tIME&quot;</span><span class="s3">]</span>

    <span class="s1">icc </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;icc_profile&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;icc_profile&quot;</span><span class="s3">))</span>
    <span class="s2">if </span><span class="s1">icc</span><span class="s3">:</span>
        <span class="s0"># ICC profile</span>
        <span class="s0"># according to PNG spec, the iCCP chunk contains:</span>
        <span class="s0"># Profile name  1-79 bytes (character string)</span>
        <span class="s0"># Null separator        1 byte (null character)</span>
        <span class="s0"># Compression method    1 byte (0)</span>
        <span class="s0"># Compressed profile    n bytes (zlib with deflate compression)</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s4">b&quot;ICC Profile&quot;</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">name </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0\0</span><span class="s4">&quot; </span><span class="s3">+ </span><span class="s1">zlib</span><span class="s3">.</span><span class="s1">compress</span><span class="s3">(</span><span class="s1">icc</span><span class="s3">)</span>
        <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;iCCP&quot;</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

        <span class="s0"># You must either have sRGB or iCCP.</span>
        <span class="s0"># Disallow sRGB chunks when an iCCP-chunk has been emitted.</span>
        <span class="s1">chunks</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s4">b&quot;sRGB&quot;</span><span class="s3">)</span>

    <span class="s1">info </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;pnginfo&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">info</span><span class="s3">:</span>
        <span class="s1">chunks_multiple_allowed </span><span class="s3">= [</span><span class="s4">b&quot;sPLT&quot;</span><span class="s3">, </span><span class="s4">b&quot;iTXt&quot;</span><span class="s3">, </span><span class="s4">b&quot;tEXt&quot;</span><span class="s3">, </span><span class="s4">b&quot;zTXt&quot;</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">info_chunk </span><span class="s2">in </span><span class="s1">info</span><span class="s3">.</span><span class="s1">chunks</span><span class="s3">:</span>
            <span class="s1">cid</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">info_chunk</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">cid </span><span class="s2">in </span><span class="s1">chunks</span><span class="s3">:</span>
                <span class="s1">chunks</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)</span>
                <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">cid </span><span class="s2">in </span><span class="s1">chunks_multiple_allowed</span><span class="s3">:</span>
                <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">cid</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">islower</span><span class="s3">():</span>
                <span class="s0"># Private chunk</span>
                <span class="s1">after_idat </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">info_chunk</span><span class="s3">) == </span><span class="s5">3 </span><span class="s2">and </span><span class="s1">info_chunk</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]</span>
                <span class="s2">if not </span><span class="s1">after_idat</span><span class="s3">:</span>
                    <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s6">&quot;P&quot;</span><span class="s3">:</span>
        <span class="s1">palette_byte_number </span><span class="s3">= </span><span class="s1">colors </span><span class="s3">* </span><span class="s5">3</span>
        <span class="s1">palette_bytes </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">getpalette</span><span class="s3">(</span><span class="s6">&quot;RGB&quot;</span><span class="s3">)[:</span><span class="s1">palette_byte_number</span><span class="s3">]</span>
        <span class="s2">while </span><span class="s1">len</span><span class="s3">(</span><span class="s1">palette_bytes</span><span class="s3">) &lt; </span><span class="s1">palette_byte_number</span><span class="s3">:</span>
            <span class="s1">palette_bytes </span><span class="s3">+= </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span>
        <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;PLTE&quot;</span><span class="s3">, </span><span class="s1">palette_bytes</span><span class="s3">)</span>

    <span class="s1">transparency </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;transparency&quot;</span><span class="s3">, </span><span class="s1">im</span><span class="s3">.</span><span class="s1">info</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;transparency&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">transparency </span><span class="s2">or </span><span class="s1">transparency </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s6">&quot;P&quot;</span><span class="s3">:</span>
            <span class="s0"># limit to actual palette size</span>
            <span class="s1">alpha_bytes </span><span class="s3">= </span><span class="s1">colors</span>
            <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">transparency</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;tRNS&quot;</span><span class="s3">, </span><span class="s1">transparency</span><span class="s3">[:</span><span class="s1">alpha_bytes</span><span class="s3">])</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">transparency </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">min</span><span class="s3">(</span><span class="s5">255</span><span class="s3">, </span><span class="s1">transparency</span><span class="s3">))</span>
                <span class="s1">alpha </span><span class="s3">= </span><span class="s4">b&quot;</span><span class="s2">\xFF</span><span class="s4">&quot; </span><span class="s3">* </span><span class="s1">transparency </span><span class="s3">+ </span><span class="s4">b&quot;</span><span class="s2">\0</span><span class="s4">&quot;</span>
                <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;tRNS&quot;</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">[:</span><span class="s1">alpha_bytes</span><span class="s3">])</span>
        <span class="s2">elif </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;1&quot;</span><span class="s3">, </span><span class="s6">&quot;L&quot;</span><span class="s3">, </span><span class="s6">&quot;I&quot;</span><span class="s3">, </span><span class="s6">&quot;I;16&quot;</span><span class="s3">):</span>
            <span class="s1">transparency </span><span class="s3">= </span><span class="s1">max</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">min</span><span class="s3">(</span><span class="s5">65535</span><span class="s3">, </span><span class="s1">transparency</span><span class="s3">))</span>
            <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;tRNS&quot;</span><span class="s3">, </span><span class="s1">o16</span><span class="s3">(</span><span class="s1">transparency</span><span class="s3">))</span>
        <span class="s2">elif </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s6">&quot;RGB&quot;</span><span class="s3">:</span>
            <span class="s1">red</span><span class="s3">, </span><span class="s1">green</span><span class="s3">, </span><span class="s1">blue </span><span class="s3">= </span><span class="s1">transparency</span>
            <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;tRNS&quot;</span><span class="s3">, </span><span class="s1">o16</span><span class="s3">(</span><span class="s1">red</span><span class="s3">) + </span><span class="s1">o16</span><span class="s3">(</span><span class="s1">green</span><span class="s3">) + </span><span class="s1">o16</span><span class="s3">(</span><span class="s1">blue</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s2">if </span><span class="s6">&quot;transparency&quot; </span><span class="s2">in </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">:</span>
                <span class="s0"># don't bother with transparency if it's an RGBA</span>
                <span class="s0"># and it's in the info dict. It's probably just stale.</span>
                <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;cannot use transparency for this mode&quot;</span>
                <span class="s2">raise </span><span class="s1">OSError</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">im</span><span class="s3">.</span><span class="s1">mode </span><span class="s3">== </span><span class="s6">&quot;P&quot; </span><span class="s2">and </span><span class="s1">im</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">getpalettemode</span><span class="s3">() == </span><span class="s6">&quot;RGBA&quot;</span><span class="s3">:</span>
            <span class="s1">alpha </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">im</span><span class="s3">.</span><span class="s1">getpalette</span><span class="s3">(</span><span class="s6">&quot;RGBA&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
            <span class="s1">alpha_bytes </span><span class="s3">= </span><span class="s1">colors</span>
            <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;tRNS&quot;</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">[:</span><span class="s1">alpha_bytes</span><span class="s3">])</span>

    <span class="s1">dpi </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;dpi&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">dpi</span><span class="s3">:</span>
        <span class="s1">chunk</span><span class="s3">(</span>
            <span class="s1">fp</span><span class="s3">,</span>
            <span class="s4">b&quot;pHYs&quot;</span><span class="s3">,</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">dpi</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] / </span><span class="s5">0.0254 </span><span class="s3">+ </span><span class="s5">0.5</span><span class="s3">)),</span>
            <span class="s1">o32</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">dpi</span><span class="s3">[</span><span class="s5">1</span><span class="s3">] / </span><span class="s5">0.0254 </span><span class="s3">+ </span><span class="s5">0.5</span><span class="s3">)),</span>
            <span class="s4">b&quot;</span><span class="s2">\x01</span><span class="s4">&quot;</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s2">if </span><span class="s1">info</span><span class="s3">:</span>
        <span class="s1">chunks </span><span class="s3">= [</span><span class="s4">b&quot;bKGD&quot;</span><span class="s3">, </span><span class="s4">b&quot;hIST&quot;</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">info_chunk </span><span class="s2">in </span><span class="s1">info</span><span class="s3">.</span><span class="s1">chunks</span><span class="s3">:</span>
            <span class="s1">cid</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">info_chunk</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">cid </span><span class="s2">in </span><span class="s1">chunks</span><span class="s3">:</span>
                <span class="s1">chunks</span><span class="s3">.</span><span class="s1">remove</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)</span>
                <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

    <span class="s1">exif </span><span class="s3">= </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s6">&quot;exif&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">exif</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">exif</span><span class="s3">, </span><span class="s1">Image</span><span class="s3">.</span><span class="s1">Exif</span><span class="s3">):</span>
            <span class="s1">exif </span><span class="s3">= </span><span class="s1">exif</span><span class="s3">.</span><span class="s1">tobytes</span><span class="s3">(</span><span class="s5">8</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">exif</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">b&quot;Exif</span><span class="s2">\x00\x00</span><span class="s4">&quot;</span><span class="s3">):</span>
            <span class="s1">exif </span><span class="s3">= </span><span class="s1">exif</span><span class="s3">[</span><span class="s5">6</span><span class="s3">:]</span>
        <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;eXIf&quot;</span><span class="s3">, </span><span class="s1">exif</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">save_all</span><span class="s3">:</span>
        <span class="s1">im </span><span class="s3">= </span><span class="s1">_write_multiple_frames</span><span class="s3">(</span>
            <span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">, </span><span class="s1">mode</span><span class="s3">, </span><span class="s1">rawmode</span><span class="s3">, </span><span class="s1">default_image</span><span class="s3">, </span><span class="s1">append_images</span>
        <span class="s3">)</span>
    <span class="s2">if </span><span class="s1">im</span><span class="s3">:</span>
        <span class="s1">ImageFile</span><span class="s3">.</span><span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">_idat</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">), [(</span><span class="s6">&quot;zip&quot;</span><span class="s3">, (</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">) + </span><span class="s1">im</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">rawmode</span><span class="s3">)])</span>

    <span class="s2">if </span><span class="s1">info</span><span class="s3">:</span>
        <span class="s2">for </span><span class="s1">info_chunk </span><span class="s2">in </span><span class="s1">info</span><span class="s3">.</span><span class="s1">chunks</span><span class="s3">:</span>
            <span class="s1">cid</span><span class="s3">, </span><span class="s1">data </span><span class="s3">= </span><span class="s1">info_chunk</span><span class="s3">[:</span><span class="s5">2</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">cid</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:</span><span class="s5">2</span><span class="s3">].</span><span class="s1">islower</span><span class="s3">():</span>
                <span class="s0"># Private chunk</span>
                <span class="s1">after_idat </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">info_chunk</span><span class="s3">) == </span><span class="s5">3 </span><span class="s2">and </span><span class="s1">info_chunk</span><span class="s3">[</span><span class="s5">2</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">after_idat</span><span class="s3">:</span>
                    <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>

    <span class="s1">chunk</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s4">b&quot;IEND&quot;</span><span class="s3">, </span><span class="s4">b&quot;&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s6">&quot;flush&quot;</span><span class="s3">):</span>
        <span class="s1">fp</span><span class="s3">.</span><span class="s1">flush</span><span class="s3">()</span>


<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># PNG chunk converter</span>


<span class="s2">def </span><span class="s1">getchunks</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, **</span><span class="s1">params</span><span class="s3">):</span>
    <span class="s7">&quot;&quot;&quot;Return a list of PNG chunks representing this image.&quot;&quot;&quot;</span>

    <span class="s2">class </span><span class="s1">collector</span><span class="s3">:</span>
        <span class="s1">data </span><span class="s3">= []</span>

        <span class="s2">def </span><span class="s1">write</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s2">def </span><span class="s1">append</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">chunk</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">chunk</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">append</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">, </span><span class="s1">cid</span><span class="s3">, *</span><span class="s1">data</span><span class="s3">):</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s4">b&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">crc </span><span class="s3">= </span><span class="s1">o32</span><span class="s3">(</span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">_crc32</span><span class="s3">(</span><span class="s1">cid</span><span class="s3">)))</span>
        <span class="s1">fp</span><span class="s3">.</span><span class="s1">append</span><span class="s3">((</span><span class="s1">cid</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">crc</span><span class="s3">))</span>

    <span class="s1">fp </span><span class="s3">= </span><span class="s1">collector</span><span class="s3">()</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo </span><span class="s3">= </span><span class="s1">params</span>
        <span class="s1">_save</span><span class="s3">(</span><span class="s1">im</span><span class="s3">, </span><span class="s1">fp</span><span class="s3">, </span><span class="s2">None</span><span class="s3">, </span><span class="s1">append</span><span class="s3">)</span>
    <span class="s2">finally</span><span class="s3">:</span>
        <span class="s2">del </span><span class="s1">im</span><span class="s3">.</span><span class="s1">encoderinfo</span>

    <span class="s2">return </span><span class="s1">fp</span><span class="s3">.</span><span class="s1">data</span>


<span class="s0"># --------------------------------------------------------------------</span>
<span class="s0"># Registry</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_open</span><span class="s3">(</span><span class="s1">PngImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">PngImageFile</span><span class="s3">, </span><span class="s1">_accept</span><span class="s3">)</span>
<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_save</span><span class="s3">(</span><span class="s1">PngImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">_save</span><span class="s3">)</span>
<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_save_all</span><span class="s3">(</span><span class="s1">PngImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s1">_save_all</span><span class="s3">)</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_extensions</span><span class="s3">(</span><span class="s1">PngImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, [</span><span class="s6">&quot;.png&quot;</span><span class="s3">, </span><span class="s6">&quot;.apng&quot;</span><span class="s3">])</span>

<span class="s1">Image</span><span class="s3">.</span><span class="s1">register_mime</span><span class="s3">(</span><span class="s1">PngImageFile</span><span class="s3">.</span><span class="s1">format</span><span class="s3">, </span><span class="s6">&quot;image/png&quot;</span><span class="s3">)</span>
</pre>
</body>
</html>