<html>
<head>
<title>test_distance.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_distance.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># Author: Damian Eads</span>
<span class="s0"># Date: April 17, 2008</span>
<span class="s0">#</span>
<span class="s0"># Copyright (C) 2008 Damian Eads</span>
<span class="s0">#</span>
<span class="s0"># Redistribution and use in source and binary forms, with or without</span>
<span class="s0"># modification, are permitted provided that the following conditions</span>
<span class="s0"># are met:</span>
<span class="s0">#</span>
<span class="s0"># 1. Redistributions of source code must retain the above copyright</span>
<span class="s0">#    notice, this list of conditions and the following disclaimer.</span>
<span class="s0">#</span>
<span class="s0"># 2. Redistributions in binary form must reproduce the above</span>
<span class="s0">#    copyright notice, this list of conditions and the following</span>
<span class="s0">#    disclaimer in the documentation and/or other materials provided</span>
<span class="s0">#    with the distribution.</span>
<span class="s0">#</span>
<span class="s0"># 3. The name of the author may not be used to endorse or promote</span>
<span class="s0">#    products derived from this software without specific prior</span>
<span class="s0">#    written permission.</span>
<span class="s0">#</span>
<span class="s0"># THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS</span>
<span class="s0"># OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="s0"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="s0"># ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="s0"># DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="s0"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE</span>
<span class="s0"># GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="s0"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,</span>
<span class="s0"># WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="s0"># NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="s0"># SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span>

<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">wraps</span><span class="s3">, </span><span class="s1">partial</span>
<span class="s2">import </span><span class="s1">weakref</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">linalg </span><span class="s2">import </span><span class="s1">norm</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">verbose</span><span class="s3">, </span><span class="s1">assert_</span><span class="s3">,</span>
                           <span class="s1">assert_array_equal</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">,</span>
                           <span class="s1">assert_almost_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span><span class="s3">,</span>
                           <span class="s1">break_cycles</span><span class="s3">, </span><span class="s1">IS_PYPY</span><span class="s3">)</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">spatial</span><span class="s3">.</span><span class="s1">distance</span>

<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">spatial</span><span class="s3">.</span><span class="s1">distance </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">squareform</span><span class="s3">, </span><span class="s1">pdist</span><span class="s3">, </span><span class="s1">cdist</span><span class="s3">, </span><span class="s1">num_obs_y</span><span class="s3">, </span><span class="s1">num_obs_dm</span><span class="s3">, </span><span class="s1">is_valid_dm</span><span class="s3">, </span><span class="s1">is_valid_y</span><span class="s3">,</span>
    <span class="s1">_validate_vector</span><span class="s3">, </span><span class="s1">_METRICS_NAMES</span><span class="s3">)</span>

<span class="s0"># these were missing: chebyshev cityblock</span>
<span class="s0"># jensenshannon  and seuclidean are referenced by string name.</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">spatial</span><span class="s3">.</span><span class="s1">distance </span><span class="s2">import </span><span class="s3">(</span><span class="s1">braycurtis</span><span class="s3">, </span><span class="s1">canberra</span><span class="s3">, </span><span class="s1">chebyshev</span><span class="s3">, </span><span class="s1">cityblock</span><span class="s3">,</span>
                                    <span class="s1">correlation</span><span class="s3">, </span><span class="s1">cosine</span><span class="s3">, </span><span class="s1">dice</span><span class="s3">, </span><span class="s1">euclidean</span><span class="s3">,</span>
                                    <span class="s1">hamming</span><span class="s3">, </span><span class="s1">jaccard</span><span class="s3">, </span><span class="s1">jensenshannon</span><span class="s3">,</span>
                                    <span class="s1">kulczynski1</span><span class="s3">, </span><span class="s1">mahalanobis</span><span class="s3">,</span>
                                    <span class="s1">minkowski</span><span class="s3">, </span><span class="s1">rogerstanimoto</span><span class="s3">,</span>
                                    <span class="s1">russellrao</span><span class="s3">, </span><span class="s1">seuclidean</span><span class="s3">, </span><span class="s1">sokalmichener</span><span class="s3">,  </span><span class="s0"># noqa: F401</span>
                                    <span class="s1">sokalsneath</span><span class="s3">, </span><span class="s1">sqeuclidean</span><span class="s3">, </span><span class="s1">yule</span><span class="s3">)</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_util </span><span class="s2">import </span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np_ulong</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">fixture</span><span class="s3">(</span><span class="s1">params</span><span class="s3">=</span><span class="s1">_METRICS_NAMES</span><span class="s3">, </span><span class="s1">scope</span><span class="s3">=</span><span class="s4">&quot;session&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">metric</span><span class="s3">(</span><span class="s1">request</span><span class="s3">):</span>
    <span class="s5">&quot;&quot;&quot; 
    Fixture for all metrics in scipy.spatial.distance 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">request</span><span class="s3">.</span><span class="s1">param</span>


<span class="s1">_filenames </span><span class="s3">= [</span>
              <span class="s4">&quot;cdist-X1.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;cdist-X2.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-boolean-inp.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-chebyshev-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-chebyshev-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-cityblock-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-cityblock-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-correlation-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-correlation-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-cosine-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-cosine-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-double-inp.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-euclidean-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-euclidean-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-hamming-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-jaccard-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-jensenshannon-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-jensenshannon-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-minkowski-3.2-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-minkowski-3.2-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-minkowski-5.8-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-seuclidean-ml-iris.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-seuclidean-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;pdist-spearman-ml.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;random-bool-data.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;random-double-data.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;random-int-data.txt&quot;</span><span class="s3">,</span>
              <span class="s4">&quot;random-uint-data.txt&quot;</span><span class="s3">,</span>
              <span class="s3">]</span>

<span class="s1">_tdist </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">662</span><span class="s3">, </span><span class="s6">877</span><span class="s3">, </span><span class="s6">255</span><span class="s3">, </span><span class="s6">412</span><span class="s3">, </span><span class="s6">996</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s6">662</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">295</span><span class="s3">, </span><span class="s6">468</span><span class="s3">, </span><span class="s6">268</span><span class="s3">, </span><span class="s6">400</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s6">877</span><span class="s3">, </span><span class="s6">295</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">754</span><span class="s3">, </span><span class="s6">564</span><span class="s3">, </span><span class="s6">138</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s6">255</span><span class="s3">, </span><span class="s6">468</span><span class="s3">, </span><span class="s6">754</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">219</span><span class="s3">, </span><span class="s6">869</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s6">412</span><span class="s3">, </span><span class="s6">268</span><span class="s3">, </span><span class="s6">564</span><span class="s3">, </span><span class="s6">219</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">669</span><span class="s3">],</span>
                      <span class="s3">[</span><span class="s6">996</span><span class="s3">, </span><span class="s6">400</span><span class="s3">, </span><span class="s6">138</span><span class="s3">, </span><span class="s6">869</span><span class="s3">, </span><span class="s6">669</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s4">'double'</span><span class="s3">)</span>

<span class="s1">_ytdist </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">_tdist</span><span class="s3">)</span>

<span class="s0"># A hashmap of expected output arrays for the tests. These arrays</span>
<span class="s0"># come from a list of text files, which are read prior to testing.</span>
<span class="s0"># Each test loads inputs and outputs from this dictionary.</span>
<span class="s1">eo </span><span class="s3">= {}</span>


<span class="s2">def </span><span class="s1">load_testing_files</span><span class="s3">():</span>
    <span class="s2">for </span><span class="s1">fn </span><span class="s2">in </span><span class="s1">_filenames</span><span class="s3">:</span>
        <span class="s1">name </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">.</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;.txt&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">).</span><span class="s1">replace</span><span class="s3">(</span><span class="s4">&quot;-ml&quot;</span><span class="s3">, </span><span class="s4">&quot;&quot;</span><span class="s3">)</span>
        <span class="s1">fqfn </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">dirname</span><span class="s3">(</span><span class="s1">__file__</span><span class="s3">), </span><span class="s4">'data'</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">)</span>
        <span class="s1">fp </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">fqfn</span><span class="s3">)</span>
        <span class="s1">eo</span><span class="s3">[</span><span class="s1">name</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">loadtxt</span><span class="s3">(</span><span class="s1">fp</span><span class="s3">)</span>
        <span class="s1">fp</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
    <span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bool_</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
    <span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-bool-data'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bool_</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-bool-data'</span><span class="s3">])</span>
    <span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-float32-data'</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-double-data'</span><span class="s3">])</span>
    <span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-int-data'</span><span class="s3">] = </span><span class="s1">np_long</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-int-data'</span><span class="s3">])</span>
    <span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-uint-data'</span><span class="s3">] = </span><span class="s1">np_ulong</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-uint-data'</span><span class="s3">])</span>


<span class="s1">load_testing_files</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_is_32bit</span><span class="s3">():</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">intp</span><span class="s3">(</span><span class="s6">0</span><span class="s3">).</span><span class="s1">itemsize </span><span class="s3">&lt; </span><span class="s6">8</span>


<span class="s2">def </span><span class="s1">_chk_asarrays</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s1">arrays </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asanyarray</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">axis </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s0"># np &lt; 1.10 ravel removes subclass from arrays</span>
        <span class="s1">arrays </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) </span><span class="s2">if </span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">!= </span><span class="s6">1 </span><span class="s2">else </span><span class="s1">a</span>
                  <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>
        <span class="s1">axis </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s1">arrays </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_1d</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">axis </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
        <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">== </span><span class="s1">arrays</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">ndim </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">):</span>
            <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;array ndim must be the same for neg axis&quot;</span><span class="s3">)</span>
        <span class="s1">axis </span><span class="s3">= </span><span class="s1">range</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">ndim</span><span class="s3">)[</span><span class="s1">axis</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">arrays </span><span class="s3">+ (</span><span class="s1">axis</span><span class="s3">,)</span>


<span class="s2">def </span><span class="s1">_chk_weights</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s2">None</span><span class="s3">,</span>
                 <span class="s1">force_weights</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">simplify_weights</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                 <span class="s1">pos_only</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">neg_check</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                 <span class="s1">nan_screen</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">mask_screen</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                 <span class="s1">ddof</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s1">chked </span><span class="s3">= </span><span class="s1">_chk_asarrays</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">)</span>
    <span class="s1">arrays</span><span class="s3">, </span><span class="s1">axis </span><span class="s3">= </span><span class="s1">chked</span><span class="s3">[:-</span><span class="s6">1</span><span class="s3">], </span><span class="s1">chked</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>

    <span class="s1">simplify_weights </span><span class="s3">= </span><span class="s1">simplify_weights </span><span class="s2">and not </span><span class="s1">force_weights</span>
    <span class="s2">if not </span><span class="s1">force_weights </span><span class="s2">and </span><span class="s1">mask_screen</span><span class="s3">:</span>
        <span class="s1">force_weights </span><span class="s3">= </span><span class="s1">any</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">getmask</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) </span><span class="s2">is not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">nomask </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">nan_screen</span><span class="s3">:</span>
        <span class="s1">has_nans </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">any</span><span class="s3">(</span><span class="s1">has_nans</span><span class="s3">):</span>
            <span class="s1">mask_screen </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">force_weights </span><span class="s3">= </span><span class="s2">True</span>
            <span class="s1">arrays </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">masked_invalid</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) </span><span class="s2">if </span><span class="s1">has_nan </span><span class="s2">else </span><span class="s1">a</span>
                           <span class="s2">for </span><span class="s1">a</span><span class="s3">, </span><span class="s1">has_nan </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">has_nans</span><span class="s3">))</span>

    <span class="s2">if </span><span class="s1">weights </span><span class="s2">is not None</span><span class="s3">:</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asanyarray</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">force_weights</span><span class="s3">:</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">])</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">arrays </span><span class="s3">+ (</span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">ddof</span><span class="s3">:</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s1">_freq_weights</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">mask_screen</span><span class="s3">:</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s1">_weight_masked</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>

    <span class="s2">if not </span><span class="s1">all</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">],) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">):</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;weights shape must match arrays along axis&quot;</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">neg_check </span><span class="s2">and </span><span class="s3">(</span><span class="s1">weights </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">).</span><span class="s1">any</span><span class="s3">():</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;weights cannot be negative&quot;</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">pos_only</span><span class="s3">:</span>
        <span class="s1">pos_weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nonzero</span><span class="s3">(</span><span class="s1">weights </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">pos_weights</span><span class="s3">.</span><span class="s1">size </span><span class="s3">&lt; </span><span class="s1">weights</span><span class="s3">.</span><span class="s1">size</span><span class="s3">:</span>
            <span class="s1">arrays </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">take</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">pos_weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">)</span>
            <span class="s1">weights </span><span class="s3">= </span><span class="s1">weights</span><span class="s3">[</span><span class="s1">pos_weights</span><span class="s3">]</span>
    <span class="s2">if </span><span class="s1">simplify_weights </span><span class="s2">and </span><span class="s3">(</span><span class="s1">weights </span><span class="s3">== </span><span class="s6">1</span><span class="s3">).</span><span class="s1">all</span><span class="s3">():</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">return </span><span class="s1">arrays </span><span class="s3">+ (</span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_freq_weights</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">weights </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">weights</span>
    <span class="s1">int_weights </span><span class="s3">= </span><span class="s1">weights</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s3">(</span><span class="s1">weights </span><span class="s3">!= </span><span class="s1">int_weights</span><span class="s3">).</span><span class="s1">any</span><span class="s3">():</span>
        <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;frequency (integer count-type) weights required %s&quot; </span><span class="s3">% </span><span class="s1">weights</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">int_weights</span>


<span class="s2">def </span><span class="s1">_weight_masked</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">axis </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s1">axis </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s1">weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asanyarray</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">:</span>
        <span class="s1">axis_mask </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">getmask</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">axis_mask </span><span class="s2">is </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">nomask</span><span class="s3">:</span>
            <span class="s2">continue</span>
        <span class="s2">if </span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">&gt; </span><span class="s6">1</span><span class="s3">:</span>
            <span class="s1">not_axes </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">i </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">) </span><span class="s2">if </span><span class="s1">i </span><span class="s3">!= </span><span class="s1">axis</span><span class="s3">)</span>
            <span class="s1">axis_mask </span><span class="s3">= </span><span class="s1">axis_mask</span><span class="s3">.</span><span class="s1">any</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s1">not_axes</span><span class="s3">)</span>
        <span class="s1">weights </span><span class="s3">*= </span><span class="s6">1 </span><span class="s3">- </span><span class="s1">axis_mask</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">weights</span>


<span class="s2">def </span><span class="s1">_rand_split</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">, </span><span class="s1">split_per</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s0"># Coerce `arrays` to float64 if integer, to avoid nan-to-integer issues</span>
    <span class="s1">arrays </span><span class="s3">= [</span><span class="s1">arr</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">) </span><span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">arr</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
              <span class="s2">else </span><span class="s1">arr </span><span class="s2">for </span><span class="s1">arr </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>

    <span class="s0"># inverse operation for stats.collapse_weights</span>
    <span class="s1">weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)  </span><span class="s0"># modified inplace; need a copy</span>
    <span class="s1">seeded_rand </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s1">seed</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">mytake</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">ix</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">):</span>
        <span class="s1">record </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asanyarray</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">take</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">ix</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">))</span>
        <span class="s2">return </span><span class="s1">record</span><span class="s3">.</span><span class="s1">reshape</span><span class="s3">([</span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s2">if </span><span class="s1">i </span><span class="s3">!= </span><span class="s1">axis </span><span class="s2">else </span><span class="s6">1</span>
                               <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">)])</span>

    <span class="s1">n_obs </span><span class="s3">= </span><span class="s1">arrays</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">] == </span><span class="s1">n_obs </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">), </span><span class="s1">\</span>
           <span class="s4">&quot;data must be aligned on sample axis&quot;</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">int</span><span class="s3">(</span><span class="s1">split_per</span><span class="s3">) * </span><span class="s1">n_obs</span><span class="s3">):</span>
        <span class="s1">split_ix </span><span class="s3">= </span><span class="s1">seeded_rand</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s1">n_obs </span><span class="s3">+ </span><span class="s1">i</span><span class="s3">)</span>
        <span class="s1">prev_w </span><span class="s3">= </span><span class="s1">weights</span><span class="s3">[</span><span class="s1">split_ix</span><span class="s3">]</span>
        <span class="s1">q </span><span class="s3">= </span><span class="s1">seeded_rand</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">()</span>
        <span class="s1">weights</span><span class="s3">[</span><span class="s1">split_ix</span><span class="s3">] = </span><span class="s1">q </span><span class="s3">* </span><span class="s1">prev_w</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">, (</span><span class="s6">1. </span><span class="s3">- </span><span class="s1">q</span><span class="s3">) * </span><span class="s1">prev_w</span><span class="s3">)</span>
        <span class="s1">arrays </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">mytake</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">split_ix</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">),</span>
                            <span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>
    <span class="s2">return </span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span>


<span class="s2">def </span><span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">compare_assert</span><span class="s3">=</span><span class="s1">partial</span><span class="s3">(</span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">),</span>
                  <span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">, </span><span class="s1">w</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
    <span class="s1">check_a </span><span class="s3">= </span><span class="s1">key</span><span class="s3">(</span><span class="s1">a</span><span class="s3">)</span>
    <span class="s1">check_b </span><span class="s3">= </span><span class="s1">key</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">check_a </span><span class="s3">!= </span><span class="s1">check_b</span><span class="s3">).</span><span class="s1">any</span><span class="s3">():  </span><span class="s0"># try strict equality for string types</span>
            <span class="s1">compare_assert</span><span class="s3">(</span><span class="s1">check_a</span><span class="s3">, </span><span class="s1">check_b</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">AttributeError</span><span class="s3">:  </span><span class="s0"># masked array</span>
        <span class="s1">compare_assert</span><span class="s3">(</span><span class="s1">check_a</span><span class="s3">, </span><span class="s1">check_b</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">):  </span><span class="s0"># nested data structure</span>
        <span class="s2">for </span><span class="s1">a_i</span><span class="s3">, </span><span class="s1">b_i </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">check_a</span><span class="s3">, </span><span class="s1">check_b</span><span class="s3">):</span>
            <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">a_i</span><span class="s3">, </span><span class="s1">b_i</span><span class="s3">, </span><span class="s1">compare_assert</span><span class="s3">=</span><span class="s1">compare_assert</span><span class="s3">)</span>

<span class="s0"># diff from test_stats:</span>
<span class="s0">#  n_args=2, weight_arg='w', default_axis=None</span>
<span class="s0">#  ma_safe = False, nan_safe = False</span>
<span class="s2">def </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">, </span><span class="s1">n_args</span><span class="s3">=</span><span class="s6">2</span><span class="s3">, </span><span class="s1">default_axis</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">, </span><span class="s1">weight_arg</span><span class="s3">=</span><span class="s4">'w'</span><span class="s3">,</span>
                    <span class="s1">squeeze</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">silent</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                    <span class="s1">ones_test</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">const_test</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">dup_test</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                    <span class="s1">split_test</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">dud_test</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">ma_safe</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">ma_very_safe</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                    <span class="s1">nan_safe</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">split_per</span><span class="s3">=</span><span class="s6">1.0</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
                    <span class="s1">compare_assert</span><span class="s3">=</span><span class="s1">partial</span><span class="s3">(</span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-5</span><span class="s3">)):</span>
    <span class="s5">&quot;&quot;&quot;runs fn on its arguments 2 or 3 ways, checks that the results are the same, 
       then returns the same thing it would have returned before&quot;&quot;&quot;</span>
    <span class="s3">@</span><span class="s1">wraps</span><span class="s3">(</span><span class="s1">fn</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">wrapped</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s1">arrays </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[:</span><span class="s1">n_args</span><span class="s3">]</span>
        <span class="s1">rest </span><span class="s3">= </span><span class="s1">args</span><span class="s3">[</span><span class="s1">n_args</span><span class="s3">:]</span>
        <span class="s1">weights </span><span class="s3">= </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">weight_arg</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s1">axis </span><span class="s3">= </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'axis'</span><span class="s3">, </span><span class="s1">default_axis</span><span class="s3">)</span>

        <span class="s1">chked </span><span class="s3">= </span><span class="s1">_chk_weights</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">=</span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">,</span>
                             <span class="s1">force_weights</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">mask_screen</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis </span><span class="s3">= </span><span class="s1">chked</span><span class="s3">[:-</span><span class="s6">2</span><span class="s3">], </span><span class="s1">chked</span><span class="s3">[-</span><span class="s6">2</span><span class="s3">], </span><span class="s1">chked</span><span class="s3">[-</span><span class="s6">1</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">squeeze</span><span class="s3">:</span>
            <span class="s1">arrays </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_1d</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">squeeze</span><span class="s3">()) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>

        <span class="s2">try</span><span class="s3">:</span>
            <span class="s0"># WEIGHTS CHECK 1: EQUAL WEIGHTED OBSERVATIONS</span>
            <span class="s1">args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">) + </span><span class="s1">rest</span>
            <span class="s2">if </span><span class="s1">ones_test</span><span class="s3">:</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s1">weights</span>
                <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">const_test</span><span class="s3">:</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s1">weights </span><span class="s3">* </span><span class="s6">101.0</span>
                <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s1">weights </span><span class="s3">* </span><span class="s6">0.101</span>
                <span class="s2">try</span><span class="s3">:</span>
                    <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                    <span class="s2">raise </span><span class="s1">type</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)((</span><span class="s1">e</span><span class="s3">, </span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">)) </span><span class="s2">from </span><span class="s1">e</span>

            <span class="s0"># WEIGHTS CHECK 2: ADDL 0-WEIGHTED OBS</span>
            <span class="s2">if </span><span class="s1">dud_test</span><span class="s3">:</span>
                <span class="s0"># add randomly resampled rows, weighted at 0</span>
                <span class="s1">dud_arrays</span><span class="s3">, </span><span class="s1">dud_weights </span><span class="s3">= </span><span class="s1">_rand_split</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">,</span>
                                                      <span class="s1">split_per</span><span class="s3">=</span><span class="s1">split_per</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">seed</span><span class="s3">)</span>
                <span class="s1">dud_weights</span><span class="s3">[:</span><span class="s1">weights</span><span class="s3">.</span><span class="s1">size</span><span class="s3">] = </span><span class="s1">weights </span><span class="s0"># not exactly 1 because of masked arrays  # noqa: E501</span>
                <span class="s1">dud_weights</span><span class="s3">[</span><span class="s1">weights</span><span class="s3">.</span><span class="s1">size</span><span class="s3">:] = </span><span class="s6">0</span>
                <span class="s1">dud_args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">dud_arrays</span><span class="s3">) + </span><span class="s1">rest</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s1">dud_weights</span>
                <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">dud_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s0"># increase the value of those 0-weighted rows</span>
                <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">dud_arrays</span><span class="s3">:</span>
                    <span class="s1">indexer </span><span class="s3">= [</span><span class="s1">slice</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)] * </span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim</span>
                    <span class="s1">indexer</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">] = </span><span class="s1">slice</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
                    <span class="s1">indexer </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">indexer</span><span class="s3">)</span>
                    <span class="s1">a</span><span class="s3">[</span><span class="s1">indexer</span><span class="s3">] = </span><span class="s1">a</span><span class="s3">[</span><span class="s1">indexer</span><span class="s3">] * </span><span class="s6">101</span>
                <span class="s1">dud_args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">dud_arrays</span><span class="s3">) + </span><span class="s1">rest</span>
                <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">dud_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s0"># set those 0-weighted rows to NaNs</span>
                <span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">dud_arrays</span><span class="s3">:</span>
                    <span class="s1">indexer </span><span class="s3">= [</span><span class="s1">slice</span><span class="s3">(</span><span class="s2">None</span><span class="s3">)] * </span><span class="s1">a</span><span class="s3">.</span><span class="s1">ndim</span>
                    <span class="s1">indexer</span><span class="s3">[</span><span class="s1">axis</span><span class="s3">] = </span><span class="s1">slice</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">.</span><span class="s1">size</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
                    <span class="s1">indexer </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">indexer</span><span class="s3">)</span>
                    <span class="s1">a</span><span class="s3">[</span><span class="s1">indexer</span><span class="s3">] = </span><span class="s1">a</span><span class="s3">[</span><span class="s1">indexer</span><span class="s3">] * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
                <span class="s2">if </span><span class="s1">kwargs</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;nan_policy&quot;</span><span class="s3">, </span><span class="s2">None</span><span class="s3">) == </span><span class="s4">&quot;omit&quot; </span><span class="s2">and </span><span class="s1">nan_safe</span><span class="s3">:</span>
                    <span class="s1">dud_args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">dud_arrays</span><span class="s3">) + </span><span class="s1">rest</span>
                    <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">dud_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s0"># mask out those nan values</span>
                <span class="s2">if </span><span class="s1">ma_safe</span><span class="s3">:</span>
                    <span class="s1">dud_arrays </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ma</span><span class="s3">.</span><span class="s1">masked_invalid</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">dud_arrays</span><span class="s3">]</span>
                    <span class="s1">dud_args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">dud_arrays</span><span class="s3">) + </span><span class="s1">rest</span>
                    <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">dud_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                    <span class="s2">if </span><span class="s1">ma_very_safe</span><span class="s3">:</span>
                        <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s2">None</span>
                        <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">dud_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s2">del </span><span class="s1">dud_arrays</span><span class="s3">, </span><span class="s1">dud_args</span><span class="s3">, </span><span class="s1">dud_weights</span>

            <span class="s0"># WEIGHTS CHECK 3: DUPLICATE DATA (DUMB SPLITTING)</span>
            <span class="s2">if </span><span class="s1">dup_test</span><span class="s3">:</span>
                <span class="s1">dup_arrays </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s1">axis</span><span class="s3">) </span><span class="s2">for </span><span class="s1">a </span><span class="s2">in </span><span class="s1">arrays</span><span class="s3">]</span>
                <span class="s1">dup_weights </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">weights</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">) / </span><span class="s6">2.0</span>
                <span class="s1">dup_args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">dup_arrays</span><span class="s3">) + </span><span class="s1">rest</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s1">dup_weights</span>
                <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">dup_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
                <span class="s2">del </span><span class="s1">dup_args</span><span class="s3">, </span><span class="s1">dup_arrays</span><span class="s3">, </span><span class="s1">dup_weights</span>

            <span class="s0"># WEIGHT CHECK 3: RANDOM SPLITTING</span>
            <span class="s2">if </span><span class="s1">split_test </span><span class="s2">and </span><span class="s1">split_per </span><span class="s3">&gt; </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s1">split </span><span class="s3">= </span><span class="s1">_rand_split</span><span class="s3">(</span><span class="s1">arrays</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">,</span>
                                    <span class="s1">split_per</span><span class="s3">=</span><span class="s1">split_per</span><span class="s3">, </span><span class="s1">seed</span><span class="s3">=</span><span class="s1">seed</span><span class="s3">)</span>
                <span class="s1">split_arrays</span><span class="s3">, </span><span class="s1">split_weights </span><span class="s3">= </span><span class="s1">split</span>
                <span class="s1">split_args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">(</span><span class="s1">split_arrays</span><span class="s3">) + </span><span class="s1">rest</span>
                <span class="s1">kwargs</span><span class="s3">[</span><span class="s1">weight_arg</span><span class="s3">] = </span><span class="s1">split_weights</span>
                <span class="s1">_rough_check</span><span class="s3">(</span><span class="s1">result</span><span class="s3">, </span><span class="s1">fn</span><span class="s3">(*</span><span class="s1">split_args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">), </span><span class="s1">key</span><span class="s3">=</span><span class="s1">key</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">NotImplementedError </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s0"># when some combination of arguments makes weighting impossible,</span>
            <span class="s0">#  this is the desired response</span>
            <span class="s2">if not </span><span class="s1">silent</span><span class="s3">:</span>
                <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span><span class="s4">f&quot;</span><span class="s2">{</span><span class="s1">fn</span><span class="s3">.</span><span class="s1">__name__</span><span class="s2">} </span><span class="s4">NotImplemented weights: </span><span class="s2">{</span><span class="s1">e</span><span class="s2">}</span><span class="s4">&quot;</span><span class="s3">,</span>
                              <span class="s1">stacklevel</span><span class="s3">=</span><span class="s6">3</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">result</span>
    <span class="s2">return </span><span class="s1">wrapped</span>


<span class="s1">wcdist </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">cdist</span><span class="s3">, </span><span class="s1">default_axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">squeeze</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
<span class="s1">wcdist_no_const </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">cdist</span><span class="s3">, </span><span class="s1">default_axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">,</span>
                                  <span class="s1">squeeze</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">const_test</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
<span class="s1">wpdist </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">pdist</span><span class="s3">, </span><span class="s1">default_axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">squeeze</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">n_args</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
<span class="s1">wpdist_no_const </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">pdist</span><span class="s3">, </span><span class="s1">default_axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">squeeze</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
                                  <span class="s1">const_test</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">n_args</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
<span class="s1">wrogerstanimoto </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">rogerstanimoto</span><span class="s3">)</span>
<span class="s1">wmatching </span><span class="s3">= </span><span class="s1">whamming </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">hamming</span><span class="s3">, </span><span class="s1">dud_test</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
<span class="s1">wyule </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">yule</span><span class="s3">)</span>
<span class="s1">wdice </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">dice</span><span class="s3">)</span>
<span class="s1">wcityblock </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">cityblock</span><span class="s3">)</span>
<span class="s1">wchebyshev </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">chebyshev</span><span class="s3">)</span>
<span class="s1">wcosine </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">cosine</span><span class="s3">)</span>
<span class="s1">wcorrelation </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">correlation</span><span class="s3">)</span>
<span class="s1">wkulczynski1 </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">kulczynski1</span><span class="s3">)</span>
<span class="s1">wjaccard </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">jaccard</span><span class="s3">)</span>
<span class="s1">weuclidean </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">euclidean</span><span class="s3">, </span><span class="s1">const_test</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
<span class="s1">wsqeuclidean </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">sqeuclidean</span><span class="s3">, </span><span class="s1">const_test</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
<span class="s1">wbraycurtis </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">braycurtis</span><span class="s3">)</span>
<span class="s1">wcanberra </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">canberra</span><span class="s3">, </span><span class="s1">const_test</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
<span class="s1">wsokalsneath </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">sokalsneath</span><span class="s3">)</span>
<span class="s1">wsokalmichener </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">sokalmichener</span><span class="s3">)</span>
<span class="s1">wrussellrao </span><span class="s3">= </span><span class="s1">_weight_checked</span><span class="s3">(</span><span class="s1">russellrao</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestCdist</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rnd_eo_names </span><span class="s3">= [</span><span class="s4">'random-float32-data'</span><span class="s3">, </span><span class="s4">'random-int-data'</span><span class="s3">,</span>
                             <span class="s4">'random-uint-data'</span><span class="s3">, </span><span class="s4">'random-double-data'</span><span class="s3">,</span>
                             <span class="s4">'random-bool-data'</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts </span><span class="s3">= {</span><span class="s4">'bool'</span><span class="s3">: [</span><span class="s1">np_ulong</span><span class="s3">, </span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">],</span>
                              <span class="s4">'uint'</span><span class="s3">: [</span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">],</span>
                              <span class="s4">'int'</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">],</span>
                              <span class="s4">'float32'</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">]}</span>

    <span class="s2">def </span><span class="s1">test_cdist_extra_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Tests that args and kwargs are correctly handled</span>

        <span class="s1">X1 </span><span class="s3">= [[</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">, </span><span class="s6">3.</span><span class="s3">], [</span><span class="s6">1.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">3.4</span><span class="s3">], [</span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">]]</span>
        <span class="s1">X2 </span><span class="s3">= [[</span><span class="s6">7.</span><span class="s3">, </span><span class="s6">5.</span><span class="s3">, </span><span class="s6">8.</span><span class="s3">], [</span><span class="s6">7.5</span><span class="s3">, </span><span class="s6">5.8</span><span class="s3">, </span><span class="s6">8.4</span><span class="s3">], [</span><span class="s6">5.5</span><span class="s3">, </span><span class="s6">5.8</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">]]</span>
        <span class="s1">kwargs </span><span class="s3">= {</span><span class="s4">&quot;N0tV4l1D_p4raM&quot;</span><span class="s3">: </span><span class="s6">3.14</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)}</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s6">3.14</span><span class="s3">] * </span><span class="s6">200</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), *</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_extra_args_custom</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests that args and kwargs are correctly handled</span>
        <span class="s0"># also for custom metric</span>
        <span class="s2">def </span><span class="s1">_my_metric</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">2</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">arg </span><span class="s3">+ </span><span class="s1">kwarg </span><span class="s3">+ </span><span class="s1">kwarg2</span>

        <span class="s1">X1 </span><span class="s3">= [[</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">, </span><span class="s6">3.</span><span class="s3">], [</span><span class="s6">1.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">3.4</span><span class="s3">], [</span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">]]</span>
        <span class="s1">X2 </span><span class="s3">= [[</span><span class="s6">7.</span><span class="s3">, </span><span class="s6">5.</span><span class="s3">, </span><span class="s6">8.</span><span class="s3">], [</span><span class="s6">7.5</span><span class="s3">, </span><span class="s6">5.8</span><span class="s3">, </span><span class="s6">8.4</span><span class="s3">], [</span><span class="s6">5.5</span><span class="s3">, </span><span class="s6">5.8</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">]]</span>
        <span class="s1">kwargs </span><span class="s3">= {</span><span class="s4">&quot;N0tV4l1D_p4raM&quot;</span><span class="s3">: </span><span class="s6">3.14</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)}</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s6">3.14</span><span class="s3">] * </span><span class="s6">200</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">3.3</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">, </span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">3.3</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">, </span><span class="s6">2.2</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">3.3</span><span class="s3">)</span>

        <span class="s0"># this should work</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">_my_metric</span><span class="s3">,</span>
                              <span class="s1">arg</span><span class="s3">=</span><span class="s6">1.1</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">3.3</span><span class="s3">), </span><span class="s6">5.4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_euclidean_random_unicode</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X1 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X1'</span><span class="s3">]</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X2'</span><span class="s3">]</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">wcdist_no_const</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s4">'euclidean'</span><span class="s3">)</span>
        <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">wcdist_no_const</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s4">'test_euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;p&quot;</span><span class="s3">, [</span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.25</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">1.23</span><span class="s3">,</span>
                                   <span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.8</span><span class="s3">, </span><span class="s6">4.6</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_cdist_minkowski_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-13</span>
        <span class="s1">X1 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X1'</span><span class="s3">]</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X2'</span><span class="s3">]</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">wcdist_no_const</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">wcdist_no_const</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s4">'test_minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_cosine_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-14</span>
        <span class="s1">X1 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X1'</span><span class="s3">]</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X2'</span><span class="s3">]</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">wcdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s4">'cosine'</span><span class="s3">)</span>

        <span class="s0"># Naive implementation</span>
        <span class="s2">def </span><span class="s1">norms</span><span class="s3">(</span><span class="s1">X</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>

        <span class="s1">Y2 </span><span class="s3">= </span><span class="s6">1 </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">((</span><span class="s1">X1 </span><span class="s3">/ </span><span class="s1">norms</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">)), (</span><span class="s1">X2 </span><span class="s3">/ </span><span class="s1">norms</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">)).</span><span class="s1">T</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_mahalanobis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># 1-dimensional observations</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">]])</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">2</span><span class="s3">], [</span><span class="s6">5</span><span class="s3">]])</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'mahalanobis'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, [[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">4.5</span><span class="s3">)], [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)]])</span>

        <span class="s0"># 2-dimensional observations</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]])</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">]])</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'mahalanobis'</span><span class="s3">)</span>
        <span class="s1">rt2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, [[</span><span class="s1">rt2</span><span class="s3">, </span><span class="s1">rt2</span><span class="s3">, </span><span class="s1">rt2</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">rt2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">]])</span>

        <span class="s0"># Too few observations</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]], [[</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]], </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'mahalanobis'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_custom_notdouble</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">class </span><span class="s1">myclass</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s2">def </span><span class="s1">_my_metric</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">myclass</span><span class="s3">) </span><span class="s2">or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">myclass</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Type has been changed&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s6">1.123</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s1">myclass</span><span class="s3">()]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">)</span>
        <span class="s1">cdist_y </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">data</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">_my_metric</span><span class="s3">)</span>
        <span class="s1">right_y </span><span class="s3">= </span><span class="s6">1.123</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">cdist_y</span><span class="s3">, </span><span class="s1">right_y</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-07</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0"># helper function for test_cdist_calling_conventions</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">y1 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s1">y2 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s1">y3 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">e_cls </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__class__</span>
            <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_calling_conventions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Ensures that specifying the metric with a str or scipy function</span>
        <span class="s0"># gives the same behaviour (i.e. same result or same exception).</span>
        <span class="s0"># NOTE: The correctness should be checked within each metric tests.</span>
        <span class="s2">for </span><span class="s1">eo_name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rnd_eo_names</span><span class="s3">:</span>
            <span class="s0"># subsampling input data to speed-up tests</span>
            <span class="s0"># NOTE: num samples needs to be &gt; than dimensions for mahalanobis</span>
            <span class="s1">X1 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s1">eo_name</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::-</span><span class="s6">2</span><span class="s3">]</span>
            <span class="s1">X2 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s1">eo_name</span><span class="s3">][</span><span class="s6">1</span><span class="s3">::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;testing: &quot;</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s4">&quot; with: &quot;</span><span class="s3">, </span><span class="s1">eo_name</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">metric </span><span class="s2">in </span><span class="s3">{</span><span class="s4">'dice'</span><span class="s3">, </span><span class="s4">'yule'</span><span class="s3">,</span>
                          <span class="s4">'rogerstanimoto'</span><span class="s3">,</span>
                          <span class="s4">'russellrao'</span><span class="s3">, </span><span class="s4">'sokalmichener'</span><span class="s3">,</span>
                          <span class="s4">'sokalsneath'</span><span class="s3">,</span>
                          <span class="s4">'kulczynski1'</span><span class="s3">} </span><span class="s2">and </span><span class="s4">'bool' </span><span class="s2">not in </span><span class="s1">eo_name</span><span class="s3">:</span>
                <span class="s0"># python version permits non-bools e.g. for fuzzy logic</span>
                <span class="s2">continue</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">)</span>

            <span class="s0"># Testing built-in metrics with extra args</span>
            <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;seuclidean&quot;</span><span class="s3">:</span>
                <span class="s1">X12 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
                <span class="s1">V </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">X12</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">ddof</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">V</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;mahalanobis&quot;</span><span class="s3">:</span>
                <span class="s1">X12 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">]).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
                <span class="s1">V </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">X12</span><span class="s3">.</span><span class="s1">T</span><span class="s3">))</span>
                <span class="s1">VI </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">inv</span><span class="s3">(</span><span class="s1">V</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">VI</span><span class="s3">=</span><span class="s1">VI</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_dtype_equivalence</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Tests that the result is not affected by type up-casting</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">tests </span><span class="s3">= [(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-bool-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'bool'</span><span class="s3">]),</span>
                 <span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-uint-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'uint'</span><span class="s3">]),</span>
                 <span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-int-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'int'</span><span class="s3">]),</span>
                 <span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-float32-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'float32'</span><span class="s3">])]</span>
        <span class="s2">for </span><span class="s1">test </span><span class="s2">in </span><span class="s1">tests</span><span class="s3">:</span>
            <span class="s1">X1 </span><span class="s3">= </span><span class="s1">test</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::-</span><span class="s6">2</span><span class="s3">]</span>
            <span class="s1">X2 </span><span class="s3">= </span><span class="s1">test</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][</span><span class="s6">1</span><span class="s3">::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">y1 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">e_cls </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__class__</span>
                <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">new_type </span><span class="s2">in </span><span class="s1">test</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">X1new </span><span class="s3">= </span><span class="s1">new_type</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">)</span>
                    <span class="s1">X2new </span><span class="s3">= </span><span class="s1">new_type</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">)</span>
                    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                        <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1new</span><span class="s3">, </span><span class="s1">X2new</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">new_type </span><span class="s2">in </span><span class="s1">test</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">y2 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">new_type</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">), </span><span class="s1">new_type</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">), </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
                    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_out</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Test that out parameter works properly</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X1 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X1'</span><span class="s3">]</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X2'</span><span class="s3">]</span>
        <span class="s1">out_r</span><span class="s3">, </span><span class="s1">out_c </span><span class="s3">= </span><span class="s1">X1</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]</span>

        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">'minkowski'</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s4">'p'</span><span class="s3">] = </span><span class="s6">1.23</span>
        <span class="s1">out1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">out_r</span><span class="s3">, </span><span class="s1">out_c</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out1</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># test that output is numerically equivalent</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

        <span class="s0"># test that Y_test1 and out1 are the same object</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">Y2 </span><span class="s2">is </span><span class="s1">out1</span><span class="s3">)</span>

        <span class="s0"># test for incorrect shape</span>
        <span class="s1">out2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">out_r</span><span class="s3">-</span><span class="s6">1</span><span class="s3">, </span><span class="s1">out_c</span><span class="s3">+</span><span class="s6">1</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out2</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># test for C-contiguous order</span>
        <span class="s1">out3 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span>
            <span class="s3">(</span><span class="s6">2 </span><span class="s3">* </span><span class="s1">out_r</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">out_c</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)[::</span><span class="s6">2</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
        <span class="s1">out4 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">out_r</span><span class="s3">, </span><span class="s1">out_c</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">order</span><span class="s3">=</span><span class="s4">'F'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out3</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out4</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># test for incorrect dtype</span>
        <span class="s1">out5 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s1">out_r</span><span class="s3">, </span><span class="s1">out_c</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out5</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_striding</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># test that striding is handled correct with calls to</span>
        <span class="s0"># _copy_array_if_base_present</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X1 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X1'</span><span class="s3">][::</span><span class="s6">2</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
        <span class="s1">X2 </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'cdist-X2'</span><span class="s3">][::</span><span class="s6">2</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
        <span class="s1">X1_copy </span><span class="s3">= </span><span class="s1">X1</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
        <span class="s1">X2_copy </span><span class="s3">= </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

        <span class="s0"># confirm equivalence</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X1_copy</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">, </span><span class="s1">X2_copy</span><span class="s3">)</span>
        <span class="s0"># confirm contiguity</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">X1</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">c_contiguous</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">X2</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">c_contiguous</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">X1_copy</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">c_contiguous</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">X2_copy</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">c_contiguous</span><span class="s3">)</span>

        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">'minkowski'</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s4">'p'</span><span class="s3">] = </span><span class="s6">1.23</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1_copy</span><span class="s3">, </span><span class="s1">X2_copy</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s0"># test that output is numerically equivalent</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cdist_refcount</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)</span>
        <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s6">10</span><span class="s3">)</span>

        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">'minkowski'</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s4">'p'</span><span class="s3">] = </span><span class="s6">1.23</span>

        <span class="s1">out </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># Check reference counts aren't messed up. If we only hold weak</span>
        <span class="s0"># references, the arrays should be deallocated.</span>
        <span class="s1">weak_refs </span><span class="s3">= [</span><span class="s1">weakref</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">(</span><span class="s1">v</span><span class="s3">) </span><span class="s2">for </span><span class="s1">v </span><span class="s2">in </span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">out</span><span class="s3">)]</span>
        <span class="s2">del </span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">out</span>

        <span class="s2">if </span><span class="s1">IS_PYPY</span><span class="s3">:</span>
            <span class="s1">break_cycles</span><span class="s3">()</span>
        <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">weak_ref</span><span class="s3">() </span><span class="s2">is None for </span><span class="s1">weak_ref </span><span class="s2">in </span><span class="s1">weak_refs</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestPdist</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">rnd_eo_names </span><span class="s3">= [</span><span class="s4">'random-float32-data'</span><span class="s3">, </span><span class="s4">'random-int-data'</span><span class="s3">,</span>
                             <span class="s4">'random-uint-data'</span><span class="s3">, </span><span class="s4">'random-double-data'</span><span class="s3">,</span>
                             <span class="s4">'random-bool-data'</span><span class="s3">]</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts </span><span class="s3">= {</span><span class="s4">'bool'</span><span class="s3">: [</span><span class="s1">np_ulong</span><span class="s3">, </span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">],</span>
                              <span class="s4">'uint'</span><span class="s3">: [</span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">],</span>
                              <span class="s4">'int'</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">],</span>
                              <span class="s4">'float32'</span><span class="s3">: [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">]}</span>

    <span class="s2">def </span><span class="s1">test_pdist_extra_args</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Tests that args and kwargs are correctly handled</span>
        <span class="s1">X1 </span><span class="s3">= [[</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">], [</span><span class="s6">1.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">], [</span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">]]</span>
        <span class="s1">kwargs </span><span class="s3">= {</span><span class="s4">&quot;N0tV4l1D_p4raM&quot;</span><span class="s3">: </span><span class="s6">3.14</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)}</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s6">3.14</span><span class="s3">] * </span><span class="s6">200</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), *</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_extra_args_custom</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests that args and kwargs are correctly handled</span>
        <span class="s0"># also for custom metric</span>
        <span class="s2">def </span><span class="s1">_my_metric</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">arg</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">2</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">arg </span><span class="s3">+ </span><span class="s1">kwarg </span><span class="s3">+ </span><span class="s1">kwarg2</span>

        <span class="s1">X1 </span><span class="s3">= [[</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">], [</span><span class="s6">1.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">], [</span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">]]</span>
        <span class="s1">kwargs </span><span class="s3">= {</span><span class="s4">&quot;N0tV4l1D_p4raM&quot;</span><span class="s3">: </span><span class="s6">3.14</span><span class="s3">, </span><span class="s4">&quot;w&quot;</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)}</span>
        <span class="s1">args </span><span class="s3">= [</span><span class="s6">3.14</span><span class="s3">] * </span><span class="s6">200</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">3.3</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">, </span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">3.3</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">, </span><span class="s6">2.2</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">_my_metric</span><span class="s3">, </span><span class="s6">1.1</span><span class="s3">, </span><span class="s1">kwarg</span><span class="s3">=</span><span class="s6">2.2</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">3.3</span><span class="s3">)</span>

        <span class="s0"># these should work</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">_my_metric</span><span class="s3">,</span>
                              <span class="s1">arg</span><span class="s3">=</span><span class="s6">1.1</span><span class="s3">, </span><span class="s1">kwarg2</span><span class="s3">=</span><span class="s6">3.3</span><span class="s3">), </span><span class="s6">5.4</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_euclidean_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_euclidean_random_u</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_euclidean_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_euclidean_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_euclidean_iris_double</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_euclidean_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_euclidean_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test pdist(X, 'test_euclidean') [the non-C implementation] on the</span>
        <span class="s0"># Iris data set.</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-euclidean-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_euclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_seuclidean_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-seuclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'seuclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_seuclidean_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-seuclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'seuclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

        <span class="s0"># Check no error is raise when V has float32 dtype (#11171).</span>
        <span class="s1">V </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">ddof</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'seuclidean'</span><span class="s3">, </span><span class="s1">V</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_seuclidean_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test pdist(X, 'test_sqeuclidean') [the non-C implementation]</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-seuclidean'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_seuclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_seuclidean_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-seuclidean-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'seuclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_seuclidean_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests pdist(X, 'seuclidean') on the Iris data set (float32).</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-seuclidean-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'seuclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_seuclidean_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test pdist(X, 'test_seuclidean') [the non-C implementation] on the</span>
        <span class="s0"># Iris data set.</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-seuclidean-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_seuclidean'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cosine_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cosine'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cosine'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cosine_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cosine'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cosine'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cosine_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test pdist(X, 'test_cosine') [the non-C implementation]</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cosine'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_cosine'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_cosine_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-05</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cosine-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cosine'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_cosine_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-05</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cosine-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cosine'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_cosine_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-05</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cosine-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_cosine'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cosine_bounds</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test adapted from @joernhees's example at gh-5208: case where</span>
        <span class="s0"># cosine distance used to be negative. XXX: very sensitive to the</span>
        <span class="s0"># specific norm computation.</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">1337</span><span class="s3">).</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">91</span><span class="s3">))</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">])</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cosine'</span><span class="s3">)[</span><span class="s6">0</span><span class="s3">] &gt;= </span><span class="s6">0</span><span class="s3">,</span>
                <span class="s1">msg</span><span class="s3">=</span><span class="s4">'cosine distance should be non-negative'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cityblock_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cityblock'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cityblock'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cityblock_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cityblock'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cityblock'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_cityblock_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cityblock'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_cityblock'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_cityblock_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-14</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cityblock-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cityblock'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_cityblock_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cityblock-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'cityblock'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_cityblock_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test pdist(X, 'test_cityblock') [the non-C implementation] on the</span>
        <span class="s0"># Iris data set.</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-14</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-cityblock-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_cityblock'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_correlation_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-correlation'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'correlation'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_correlation_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-correlation'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'correlation'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_correlation_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-correlation'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_correlation'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_correlation_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-correlation-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'correlation'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_correlation_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-correlation-iris'</span><span class="s3">])</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'correlation'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_correlation_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">maxsize </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">**</span><span class="s6">32</span><span class="s3">:</span>
            <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">&quot;see gh-16456&quot;</span><span class="s3">)</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-correlation-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_correlation'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;p&quot;</span><span class="s3">, [</span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">0.25</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_random_p</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-13</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s1">p</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_minkowski_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-3.2'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">3.2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_minkowski_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-3.2'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">3.2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_minkowski_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-3.2'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">3.2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_3_2_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-3.2-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">3.2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_3_2_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-3.2-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">3.2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_3_2_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-3.2-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">3.2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_5_8_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-5.8-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">5.8</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_5_8_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-5.8-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">5.8</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_minkowski_5_8_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-minkowski-5.8-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">5.8</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_mahalanobis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># 1-dimensional observations</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">, </span><span class="s6">5.0</span><span class="s3">]).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'mahalanobis'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, [</span><span class="s6">0.0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">4.5</span><span class="s3">),</span>
                               <span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">0.5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">4.5</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2.0</span><span class="s3">)])</span>

        <span class="s0"># 2-dimensional observations</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [-</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">0</span><span class="s3">, -</span><span class="s6">2</span><span class="s3">]])</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'mahalanobis'</span><span class="s3">)</span>
        <span class="s1">rt2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, [</span><span class="s1">rt2</span><span class="s3">, </span><span class="s1">rt2</span><span class="s3">, </span><span class="s1">rt2</span><span class="s3">, </span><span class="s1">rt2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">rt2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">* </span><span class="s1">rt2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">])</span>

        <span class="s0"># Too few observations</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">wpdist</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]], </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'mahalanobis'</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_hamming_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-hamming'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'hamming'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_hamming_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-hamming'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'hamming'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_hamming_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-hamming'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_hamming'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_dhamming_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-hamming'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'hamming'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_dhamming_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-hamming'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'hamming'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_dhamming_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-hamming'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_hamming'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jaccard_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jaccard'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jaccard_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jaccard'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jaccard_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jaccard'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_djaccard_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jaccard'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_djaccard_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jaccard'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_djaccard_allzeros</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)), </span><span class="s4">'jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s6">10</span><span class="s3">), </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_djaccard_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-boolean-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jaccard'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">wpdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jensenshannon_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-11</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jensenshannon'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jensenshannon'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jensenshannon_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jensenshannon'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jensenshannon'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jensenshannon_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-11</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jensenshannon'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_jensenshannon'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jensenshannon_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">_is_32bit</span><span class="s3">():</span>
            <span class="s0"># Test failing on 32-bit Linux on Azure otherwise, see gh-12810</span>
            <span class="s1">eps </span><span class="s3">= </span><span class="s6">2.5e-10</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-12</span>

        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jensenshannon-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jensenshannon'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jensenshannon_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-06</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jensenshannon-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'jensenshannon'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jensenshannon_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">5e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-jensenshannon-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_jensenshannon'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_djaccard_allzeros_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">5</span><span class="s3">, </span><span class="s6">3</span><span class="s3">)), </span><span class="s4">'test_jaccard'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s6">10</span><span class="s3">), </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_chebyshev_random</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-chebyshev'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'chebyshev'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_chebyshev_random_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-7</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-chebyshev'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'chebyshev'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_chebyshev_random_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-double-inp'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-chebyshev'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_chebyshev'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_chebyshev_iris</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-14</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-chebyshev-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'chebyshev'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_chebyshev_iris_float32</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-5</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">])</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-chebyshev-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'chebyshev'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_chebyshev_iris_nonC</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-14</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'pdist-chebyshev-iris'</span><span class="s3">]</span>
        <span class="s1">Y_test2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">'test_chebyshev'</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test2</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_matching_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test matching(*,*) with mtica example #1 (nums).</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wmatching</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                      <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wmatching</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                       <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">0.6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">0.6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_matching_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test matching(*,*) with mtica example #2.</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wmatching</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wmatching</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                      <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jaccard_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wjaccard</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wjaccard</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                      <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">0.6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">0.6</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_jaccard_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wjaccard</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                     <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wjaccard</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                      <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_yule_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wyule</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                  <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wyule</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                   <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_yule_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wyule</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                  <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wyule</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                   <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_dice_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wdice</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                  <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wdice</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                   <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">7</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">7</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_dice_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wdice</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                  <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wdice</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                   <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_sokalsneath_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">sokalsneath</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">sokalsneath</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                         <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_sokalsneath_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wsokalsneath</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                         <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wsokalsneath</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                          <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">4 </span><span class="s3">/ </span><span class="s6">5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">4 </span><span class="s3">/ </span><span class="s6">5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_rogerstanimoto_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wrogerstanimoto</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wrogerstanimoto</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                             <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">4</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_rogerstanimoto_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wrogerstanimoto</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                            <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wrogerstanimoto</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                             <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">4 </span><span class="s3">/ </span><span class="s6">5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">4 </span><span class="s3">/ </span><span class="s6">5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_russellrao_mtica1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wrussellrao</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]),</span>
                        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wrussellrao</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                         <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">3 </span><span class="s3">/ </span><span class="s6">5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_russellrao_mtica2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">m </span><span class="s3">= </span><span class="s1">wrussellrao</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]),</span>
                        <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]))</span>
        <span class="s1">m2 </span><span class="s3">= </span><span class="s1">wrussellrao</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">),</span>
                         <span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">))</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">m</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">m2</span><span class="s3">, </span><span class="s6">2 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s6">1e-10</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
    <span class="s2">def </span><span class="s1">test_pdist_canberra_match</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'iris'</span><span class="s3">]</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">D</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">D</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">y1 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">D</span><span class="s3">, </span><span class="s4">&quot;canberra&quot;</span><span class="s3">)</span>
        <span class="s1">y2 </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">D</span><span class="s3">, </span><span class="s4">&quot;test_canberra&quot;</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_canberra_ticket_711</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test pdist(X, 'canberra') to see if Canberra gives the right result</span>
        <span class="s0"># as reported on gh-1238.</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-8</span>
        <span class="s1">pdist_y </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(([</span><span class="s6">3.3</span><span class="s3">], [</span><span class="s6">3.4</span><span class="s3">]), </span><span class="s4">&quot;canberra&quot;</span><span class="s3">)</span>
        <span class="s1">right_y </span><span class="s3">= </span><span class="s6">0.01492537</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">pdist_y</span><span class="s3">, </span><span class="s1">right_y</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_custom_notdouble</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># tests that when using a custom metric the data type is not altered</span>
        <span class="s2">class </span><span class="s1">myclass</span><span class="s3">:</span>
            <span class="s2">pass</span>

        <span class="s2">def </span><span class="s1">_my_metric</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
            <span class="s2">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">myclass</span><span class="s3">) </span><span class="s2">or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">myclass</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Type has been changed&quot;</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s6">1.123</span>
        <span class="s1">data </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s1">myclass</span><span class="s3">()], [</span><span class="s1">myclass</span><span class="s3">()]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">object</span><span class="s3">)</span>
        <span class="s1">pdist_y </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">_my_metric</span><span class="s3">)</span>
        <span class="s1">right_y </span><span class="s3">= </span><span class="s6">1.123</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">pdist_y</span><span class="s3">, </span><span class="s1">right_y</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s6">1e-07</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
        <span class="s0"># helper function for test_pdist_calling_conventions</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">y1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s1">y2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s1">y3 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
            <span class="s1">e_cls </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__class__</span>
            <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), **</span><span class="s1">kwargs</span><span class="s3">)</span>
            <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y3</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_calling_conventions</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Ensures that specifying the metric with a str or scipy function</span>
        <span class="s0"># gives the same behaviour (i.e. same result or same exception).</span>
        <span class="s0"># NOTE: The correctness should be checked within each metric tests.</span>
        <span class="s0"># NOTE: Extra args should be checked with a dedicated test</span>
        <span class="s2">for </span><span class="s1">eo_name </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">rnd_eo_names</span><span class="s3">:</span>
            <span class="s0"># subsampling input data to speed-up tests</span>
            <span class="s0"># NOTE: num samples needs to be &gt; than dimensions for mahalanobis</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s1">eo_name</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">&quot;testing: &quot;</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s4">&quot; with: &quot;</span><span class="s3">, </span><span class="s1">eo_name</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">metric </span><span class="s2">in </span><span class="s3">{</span><span class="s4">'dice'</span><span class="s3">, </span><span class="s4">'yule'</span><span class="s3">, </span><span class="s4">'matching'</span><span class="s3">,</span>
                          <span class="s4">'rogerstanimoto'</span><span class="s3">, </span><span class="s4">'russellrao'</span><span class="s3">, </span><span class="s4">'sokalmichener'</span><span class="s3">,</span>
                          <span class="s4">'sokalsneath'</span><span class="s3">,</span>
                          <span class="s4">'kulczynski1'</span><span class="s3">} </span><span class="s2">and </span><span class="s4">'bool' </span><span class="s2">not in </span><span class="s1">eo_name</span><span class="s3">:</span>
                <span class="s0"># python version permits non-bools e.g. for fuzzy logic</span>
                <span class="s2">continue</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">)</span>

            <span class="s0"># Testing built-in metrics with extra args</span>
            <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;seuclidean&quot;</span><span class="s3">:</span>
                <span class="s1">V </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">var</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">, </span><span class="s1">ddof</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">V</span><span class="s3">=</span><span class="s1">V</span><span class="s3">)</span>
            <span class="s2">elif </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;mahalanobis&quot;</span><span class="s3">:</span>
                <span class="s1">V </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cov</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">T</span><span class="s3">))</span>
                <span class="s1">VI </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">inv</span><span class="s3">(</span><span class="s1">V</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_check_calling_conventions</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">VI</span><span class="s3">=</span><span class="s1">VI</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_dtype_equivalence</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Tests that the result is not affected by type up-casting</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-07</span>
        <span class="s1">tests </span><span class="s3">= [(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-bool-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'bool'</span><span class="s3">]),</span>
                 <span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-uint-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'uint'</span><span class="s3">]),</span>
                 <span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-int-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'int'</span><span class="s3">]),</span>
                 <span class="s3">(</span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-float32-data'</span><span class="s3">], </span><span class="s1">self</span><span class="s3">.</span><span class="s1">valid_upcasts</span><span class="s3">[</span><span class="s4">'float32'</span><span class="s3">])]</span>
        <span class="s2">for </span><span class="s1">test </span><span class="s2">in </span><span class="s1">tests</span><span class="s3">:</span>
            <span class="s1">X1 </span><span class="s3">= </span><span class="s1">test</span><span class="s3">[</span><span class="s6">0</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
            <span class="s2">try</span><span class="s3">:</span>
                <span class="s1">y1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
            <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
                <span class="s1">e_cls </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">__class__</span>
                <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">.</span><span class="s1">__name__</span><span class="s3">)</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s1">e</span><span class="s3">)</span>
                <span class="s2">for </span><span class="s1">new_type </span><span class="s2">in </span><span class="s1">test</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">X2 </span><span class="s3">= </span><span class="s1">new_type</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">)</span>
                    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">e_cls</span><span class="s3">):</span>
                        <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">for </span><span class="s1">new_type </span><span class="s2">in </span><span class="s1">test</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]:</span>
                    <span class="s1">y2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">new_type</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">), </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
                    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_pdist_out</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># Test that out parameter works properly</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-float32-data'</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
        <span class="s1">out_size </span><span class="s3">= </span><span class="s1">int</span><span class="s3">((</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] * (</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] - </span><span class="s6">1</span><span class="s3">)) / </span><span class="s6">2</span><span class="s3">)</span>

        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">'minkowski'</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s4">'p'</span><span class="s3">] = </span><span class="s6">1.23</span>
        <span class="s1">out1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s1">out_size</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">Y_right </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">Y_test1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out1</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># test that output is numerically equivalent</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y_test1</span><span class="s3">, </span><span class="s1">Y_right</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">)</span>

        <span class="s0"># test that Y_test1 and out1 are the same object</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">Y_test1 </span><span class="s2">is </span><span class="s1">out1</span><span class="s3">)</span>

        <span class="s0"># test for incorrect shape</span>
        <span class="s1">out2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s1">out_size </span><span class="s3">+ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out2</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># test for (C-)contiguous output</span>
        <span class="s1">out3 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s6">2 </span><span class="s3">* </span><span class="s1">out_size</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)[::</span><span class="s6">2</span><span class="s3">]</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out3</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s0"># test for incorrect dtype</span>
        <span class="s1">out5 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s1">out_size</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">out</span><span class="s3">=</span><span class="s1">out5</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_striding</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">):</span>
        <span class="s0"># test that striding is handled correct with calls to</span>
        <span class="s0"># _copy_array_if_base_present</span>
        <span class="s1">eps </span><span class="s3">= </span><span class="s6">1e-15</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-float32-data'</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
        <span class="s1">X_copy </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>

        <span class="s0"># confirm contiguity</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s2">not </span><span class="s1">X</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">c_contiguous</span><span class="s3">)</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">X_copy</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">.</span><span class="s1">c_contiguous</span><span class="s3">)</span>

        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">()</span>
        <span class="s2">if </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">'minkowski'</span><span class="s3">:</span>
            <span class="s1">kwargs</span><span class="s3">[</span><span class="s4">'p'</span><span class="s3">] = </span><span class="s6">1.23</span>
        <span class="s1">Y1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">X_copy</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s0"># test that output is numerically equivalent</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Y1</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">verbose</span><span class="s3">=</span><span class="s1">verbose </span><span class="s3">&gt; </span><span class="s6">2</span><span class="s3">)</span>

<span class="s2">class </span><span class="s1">TestSomeDistanceFunctions</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">setup_method</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># 1D arrays</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">5.0</span><span class="s3">])</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">cases </span><span class="s3">= [(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)]</span>

    <span class="s2">def </span><span class="s1">test_minkowski</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">dist1 </span><span class="s3">= </span><span class="s1">minkowski</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">)</span>
            <span class="s1">dist1p5 </span><span class="s3">= </span><span class="s1">minkowski</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">1.5</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist1p5</span><span class="s3">, (</span><span class="s6">1.0 </span><span class="s3">+ </span><span class="s6">2.0</span><span class="s3">**</span><span class="s6">1.5</span><span class="s3">)**(</span><span class="s6">2. </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">))</span>
            <span class="s1">dist2 </span><span class="s3">= </span><span class="s1">minkowski</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">2</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist2</span><span class="s3">, </span><span class="s6">5.0 </span><span class="s3">** </span><span class="s6">0.5</span><span class="s3">)</span>
            <span class="s1">dist0p25 </span><span class="s3">= </span><span class="s1">minkowski</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">0.25</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist0p25</span><span class="s3">, (</span><span class="s6">1.0 </span><span class="s3">+ </span><span class="s6">2.0 </span><span class="s3">** </span><span class="s6">0.25</span><span class="s3">) ** </span><span class="s6">4</span><span class="s3">)</span>

        <span class="s0"># Check that casting input to minimum scalar type doesn't affect result</span>
        <span class="s0"># (issue #10262). This could be extended to more test inputs with</span>
        <span class="s0"># np.min_scalar_type(np.max(input_matrix)).</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">352</span><span class="s3">, </span><span class="s6">916</span><span class="s3">])</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">350</span><span class="s3">, </span><span class="s6">660</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">minkowski</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">),</span>
                     <span class="s1">minkowski</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s4">'uint16'</span><span class="s3">), </span><span class="s1">b</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s4">'uint16'</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_euclidean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">weuclidean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">5</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_sqeuclidean</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, </span><span class="s6">5.0</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_cosine</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">wcosine</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, </span><span class="s6">1.0 </span><span class="s3">- </span><span class="s6">18.0 </span><span class="s3">/ (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">14</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">27</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_cosine_output_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-19541</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">wcorrelation</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">centered</span><span class="s3">=</span><span class="s2">False</span><span class="s3">), </span><span class="s1">float</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">wcosine</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]), </span><span class="s1">float</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_correlation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">xm </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">])</span>
        <span class="s1">ym </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s6">4.0 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, -</span><span class="s6">4.0 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s6">5.0 </span><span class="s3">- </span><span class="s6">7.0 </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">])</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">wcorrelation</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, </span><span class="s6">1.0 </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">xm</span><span class="s3">, </span><span class="s1">ym</span><span class="s3">) / (</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">xm</span><span class="s3">) * </span><span class="s1">norm</span><span class="s3">(</span><span class="s1">ym</span><span class="s3">)))</span>

    <span class="s2">def </span><span class="s1">test_correlation_positive</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Regression test for gh-12320 (negative return value due to rounding</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">,</span>
                      <span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">,</span>
                      <span class="s6">0.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, -</span><span class="s6">2.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">,</span>
                      <span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">0.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">,</span>
                      <span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, -</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">1.</span><span class="s3">])</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">correlation</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s6">0 </span><span class="s3">&lt;= </span><span class="s1">dist </span><span class="s3">&lt;= </span><span class="s6">10 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">eps</span>

    <span class="s2">def </span><span class="s1">test_mahalanobis</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">3.0</span><span class="s3">])</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">5.0</span><span class="s3">])</span>
        <span class="s1">vi </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">], [</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">], [</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]])</span>
        <span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cases</span><span class="s3">:</span>
            <span class="s1">dist </span><span class="s3">= </span><span class="s1">mahalanobis</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">vi</span><span class="s3">)</span>
            <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">6.0</span><span class="s3">))</span>


<span class="s2">class </span><span class="s1">TestSquareForm</span><span class="s3">:</span>
    <span class="s1">checked_dtypes </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int8</span><span class="s3">, </span><span class="s1">bool</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_squareform_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">checked_dtypes</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_squareform_matrix</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_squareform_vector</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">checked_dtypes</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_squareform_vector</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_squareform_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">rA </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">rA </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">0</span><span class="s3">,))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)</span>

        <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">4.2</span><span class="s3">], [</span><span class="s6">4.2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">rA </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">1</span><span class="s3">,))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">rA</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">4.2</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">check_squareform_vector</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">0</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">, [[</span><span class="s6">0</span><span class="s3">]])</span>

        <span class="s1">v </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">8.3</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">rv </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">v</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">rv</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">0</span><span class="s3">, </span><span class="s6">8.3</span><span class="s3">], [</span><span class="s6">8.3</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_squareform_multi_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">5</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_squareform_multi_matrix</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_squareform_multi_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">), </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">A </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
        <span class="s1">Yr </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">A</span><span class="s3">)</span>
        <span class="s1">s </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">shape</span>
        <span class="s1">k </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt;= </span><span class="s6">3</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">A</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">Yr</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">s</span><span class="s3">), </span><span class="s6">2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">Yr</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">), </span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">s</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">s</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[</span><span class="s6">0</span><span class="s3">]):</span>
            <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">i </span><span class="s3">+ </span><span class="s6">1</span><span class="s3">, </span><span class="s1">s</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]):</span>
                <span class="s2">if </span><span class="s1">i </span><span class="s3">!= </span><span class="s1">j</span><span class="s3">:</span>
                    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">A</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">], </span><span class="s1">Y</span><span class="s3">[</span><span class="s1">k</span><span class="s3">])</span>
                    <span class="s1">k </span><span class="s3">+= </span><span class="s6">1</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">A</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">], </span><span class="s6">0</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestNumObsY</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_multi_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">10</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)</span>
            <span class="s1">Y </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">num_obs_y</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_y(y) on a condensed distance matrix over 1</span>
        <span class="s0"># observations. Expecting exception.</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">check_y</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_y(y) on a condensed distance matrix over 2</span>
        <span class="s0"># observations.</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_y</span><span class="s3">(</span><span class="s6">2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_y</span><span class="s3">(</span><span class="s6">3</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_y</span><span class="s3">(</span><span class="s6">4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_5_10</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">16</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">minit</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_y_2_100</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_y(y) on 100 improper condensed distance matrices.</span>
        <span class="s0"># Expecting exception.</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">16</span><span class="s3">):</span>
            <span class="s1">a</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">n </span><span class="s3">* (</span><span class="s1">n </span><span class="s3">- </span><span class="s6">1</span><span class="s3">) / </span><span class="s6">2</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">105</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s2">not in </span><span class="s1">a</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">bad_y</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">minit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_y</span><span class="s3">(</span><span class="s1">n</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">bad_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">num_obs_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">check_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">num_obs_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_y</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)) == </span><span class="s1">n</span>

    <span class="s2">def </span><span class="s1">make_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">((</span><span class="s1">n </span><span class="s3">* (</span><span class="s1">n </span><span class="s3">- </span><span class="s6">1</span><span class="s3">)) // </span><span class="s6">2</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestNumObsDM</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_num_obs_dm_multi_matrix</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, </span><span class="s6">10</span><span class="s3">):</span>
            <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s6">4</span><span class="s3">)</span>
            <span class="s1">Y </span><span class="s3">= </span><span class="s1">wpdist_no_const</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">A </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
            <span class="s2">if </span><span class="s1">verbose </span><span class="s3">&gt;= </span><span class="s6">3</span><span class="s3">:</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s1">A</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">num_obs_dm</span><span class="s3">(</span><span class="s1">A</span><span class="s3">), </span><span class="s1">n</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_num_obs_dm_0</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_dm(D) on a 0x0 distance matrix. Expecting exception.</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_D</span><span class="s3">(</span><span class="s6">0</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_dm_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Tests num_obs_dm(D) on a 1x1 distance matrix.</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_D</span><span class="s3">(</span><span class="s6">1</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_dm_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_D</span><span class="s3">(</span><span class="s6">2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_dm_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_D</span><span class="s3">(</span><span class="s6">2</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_num_obs_dm_4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">check_D</span><span class="s3">(</span><span class="s6">4</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">check_D</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">num_obs_dm</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">make_D</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)) == </span><span class="s1">n</span>

    <span class="s2">def </span><span class="s1">make_D</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">is_valid_dm_throw</span><span class="s3">(</span><span class="s1">D</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestIsValidDM</span><span class="s3">:</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_improper_shape_1D_E</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">5</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">is_valid_dm_throw</span><span class="s3">(</span><span class="s1">D</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_improper_shape_1D_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">5</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_improper_shape_3D_E</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">is_valid_dm_throw</span><span class="s3">(</span><span class="s1">D</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_improper_shape_3D_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_nonzero_diagonal_E</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">):</span>
            <span class="s1">D</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">i</span><span class="s3">] = </span><span class="s6">2.0</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">is_valid_dm_throw</span><span class="s3">(</span><span class="s1">D</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_nonzero_diagonal_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s6">5</span><span class="s3">):</span>
            <span class="s1">D</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">i</span><span class="s3">] = </span><span class="s6">2.0</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_asymmetric_E</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">D</span><span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">] = </span><span class="s1">D</span><span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">1</span><span class="s3">] + </span><span class="s6">1</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">is_valid_dm_throw</span><span class="s3">(</span><span class="s1">D</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_asymmetric_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">D</span><span class="s3">[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">3</span><span class="s3">] = </span><span class="s1">D</span><span class="s3">[</span><span class="s6">3</span><span class="s3">, </span><span class="s6">1</span><span class="s3">] + </span><span class="s6">1</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_correct_1_by_1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_correct_2_by_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_correct_3_by_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_correct_4_by_4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">6</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_dm_correct_5_by_5</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
        <span class="s1">D </span><span class="s3">= </span><span class="s1">squareform</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_dm</span><span class="s3">(</span><span class="s1">D</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">is_valid_y_throw</span><span class="s3">(</span><span class="s1">y</span><span class="s3">):</span>
    <span class="s2">return </span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestIsValidY</span><span class="s3">:</span>
    <span class="s0"># If test case name ends on &quot;_E&quot; then an exception is expected for the</span>
    <span class="s0"># given input, if it ends in &quot;_F&quot; then False is expected for the is_valid_y</span>
    <span class="s0"># check.  Otherwise the input is expected to be valid.</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_improper_shape_2D_E</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">is_valid_y_throw</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_improper_shape_2D_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">,), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_improper_shape_3D_E</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">is_valid_y_throw</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_improper_shape_3D_F</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">3</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s2">False</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_correct_2_by_2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">correct_n_by_n</span><span class="s3">(</span><span class="s6">2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_correct_3_by_3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">correct_n_by_n</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_correct_4_by_4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">correct_n_by_n</span><span class="s3">(</span><span class="s6">4</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_correct_5_by_5</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">correct_n_by_n</span><span class="s3">(</span><span class="s6">5</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">), </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_is_valid_y_2_100</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">set</span><span class="s3">()</span>
        <span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">16</span><span class="s3">):</span>
            <span class="s1">a</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">n </span><span class="s3">* (</span><span class="s1">n </span><span class="s3">- </span><span class="s6">1</span><span class="s3">) / </span><span class="s6">2</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">5</span><span class="s3">, </span><span class="s6">105</span><span class="s3">):</span>
            <span class="s2">if </span><span class="s1">i </span><span class="s2">not in </span><span class="s1">a</span><span class="s3">:</span>
                <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">bad_y</span><span class="s3">(</span><span class="s1">i</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">bad_y</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">is_valid_y</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">throw</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">correct_n_by_n</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">n</span><span class="s3">):</span>
        <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">((</span><span class="s1">n </span><span class="s3">* (</span><span class="s1">n </span><span class="s3">- </span><span class="s6">1</span><span class="s3">)) // </span><span class="s6">2</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">y</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s4">&quot;p&quot;</span><span class="s3">, [-</span><span class="s6">10.0</span><span class="s3">, -</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_bad_p</span><span class="s3">(</span><span class="s1">p</span><span class="s3">):</span>
    <span class="s0"># Raise ValueError if p &lt;=0.</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">minkowski</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], </span><span class="s1">p</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">minkowski</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">], </span><span class="s1">p</span><span class="s3">, [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_sokalsneath_all_false</span><span class="s3">():</span>
    <span class="s0"># Regression test for ticket #876</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">sokalsneath</span><span class="s3">([</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">], [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_canberra</span><span class="s3">():</span>
    <span class="s0"># Regression test for ticket #1430.</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">wcanberra</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]), </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">wcanberra</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]), </span><span class="s6">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_braycurtis</span><span class="s3">():</span>
    <span class="s0"># Regression test for ticket #1430.</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">wbraycurtis</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">], [</span><span class="s6">2</span><span class="s3">, </span><span class="s6">4</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]), </span><span class="s6">1. </span><span class="s3">/ </span><span class="s6">3</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">15</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">wbraycurtis</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]), </span><span class="s6">0.5</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">15</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_euclideans</span><span class="s3">():</span>
    <span class="s0"># Regression test for ticket #1328.</span>
    <span class="s1">x1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">])</span>
    <span class="s1">x2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>

    <span class="s0"># Basic test of the calculation.</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">), </span><span class="s6">3.0</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">14</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">weuclidean</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">3</span><span class="s3">), </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">14</span><span class="s3">)</span>

    <span class="s0"># Check flattening for (1, N) or (N, 1) inputs</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Input vector should be 1-D&quot;</span><span class="s3">):</span>
        <span class="s1">weuclidean</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">, :], </span><span class="s1">x2</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">, :]), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s6">3</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Input vector should be 1-D&quot;</span><span class="s3">):</span>
        <span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">, :], </span><span class="s1">x2</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">, :])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Input vector should be 1-D&quot;</span><span class="s3">):</span>
        <span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">x1</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">], </span><span class="s1">x2</span><span class="s3">[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">])</span>

    <span class="s0"># Distance metrics only defined for vectors (= 1-D)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">4</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">2</span><span class="s3">, </span><span class="s6">2</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">weuclidean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s0"># Another check, with random data.</span>
    <span class="s1">rs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s6">1234567890</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rs</span><span class="s3">.</span><span class="s1">rand</span><span class="s3">(</span><span class="s6">10</span><span class="s3">)</span>
    <span class="s1">d1 </span><span class="s3">= </span><span class="s1">weuclidean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">d2 </span><span class="s3">= </span><span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">**</span><span class="s6">2</span><span class="s3">, </span><span class="s1">d2</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s6">14</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_hamming_unequal_length</span><span class="s3">():</span>
    <span class="s0"># Regression test for gh-4290.</span>
    <span class="s1">x </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]</span>
    <span class="s0"># Used to give an AttributeError from ndarray.mean called on bool</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">whamming</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_hamming_unequal_length_with_w</span><span class="s3">():</span>
    <span class="s1">u </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]</span>
    <span class="s1">v </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">]</span>
    <span class="s1">w </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">]</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s4">&quot;'w' should have the same length as 'u' and 'v'.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">whamming</span><span class="s3">(</span><span class="s1">u</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">w</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_hamming_string_array</span><span class="s3">():</span>
    <span class="s0"># https://github.com/scikit-learn/scikit-learn/issues/4014</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">,</span>
                  <span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">,</span>
                  <span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">],</span>
                  <span class="s1">dtype</span><span class="s3">=</span><span class="s4">'|S4'</span><span class="s3">)</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">,</span>
                  <span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">,</span>
                  <span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'spam'</span><span class="s3">, </span><span class="s4">'eggs'</span><span class="s3">],</span>
                  <span class="s1">dtype</span><span class="s3">=</span><span class="s4">'|S4'</span><span class="s3">)</span>
    <span class="s1">desired </span><span class="s3">= </span><span class="s6">0.45</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">whamming</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">), </span><span class="s1">desired</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_minkowski_w</span><span class="s3">():</span>
    <span class="s0"># Regression test for gh-8142.</span>
    <span class="s1">arr_in </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">83.33333333</span><span class="s3">, </span><span class="s6">100.</span><span class="s3">, </span><span class="s6">83.33333333</span><span class="s3">, </span><span class="s6">100.</span><span class="s3">, </span><span class="s6">36.</span><span class="s3">,</span>
                        <span class="s6">60.</span><span class="s3">, </span><span class="s6">90.</span><span class="s3">, </span><span class="s6">150.</span><span class="s3">, </span><span class="s6">24.</span><span class="s3">, </span><span class="s6">48.</span><span class="s3">],</span>
                       <span class="s3">[</span><span class="s6">83.33333333</span><span class="s3">, </span><span class="s6">100.</span><span class="s3">, </span><span class="s6">83.33333333</span><span class="s3">, </span><span class="s6">100.</span><span class="s3">, </span><span class="s6">36.</span><span class="s3">,</span>
                        <span class="s6">60.</span><span class="s3">, </span><span class="s6">90.</span><span class="s3">, </span><span class="s6">150.</span><span class="s3">, </span><span class="s6">24.</span><span class="s3">, </span><span class="s6">48.</span><span class="s3">]])</span>
    <span class="s1">p0 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">arr_in</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">w</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">c0 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">arr_in</span><span class="s3">, </span><span class="s1">arr_in</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">w</span><span class="s3">=</span><span class="s2">None</span><span class="s3">)</span>
    <span class="s1">p1 </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">arr_in</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">c1 </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">arr_in</span><span class="s3">, </span><span class="s1">arr_in</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'minkowski'</span><span class="s3">, </span><span class="s1">p</span><span class="s3">=</span><span class="s6">1</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">p0</span><span class="s3">, </span><span class="s1">p1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">c0</span><span class="s3">, </span><span class="s1">c1</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s6">1e-15</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_sqeuclidean_dtypes</span><span class="s3">():</span>
    <span class="s0"># Assert that sqeuclidean returns the right types of values.</span>
    <span class="s0"># Integer types should be converted to floating for stability.</span>
    <span class="s0"># Floating point types should be the same as the input.</span>
    <span class="s1">x </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s6">4</span><span class="s3">, </span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">]:</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">))</span>
        <span class="s1">assert_</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">))</span>

    <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint16</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uint64</span><span class="s3">]:</span>
        <span class="s1">umax </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">iinfo</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">).</span><span class="s1">max</span>
        <span class="s1">d1 </span><span class="s3">= </span><span class="s1">wsqeuclidean</span><span class="s3">([</span><span class="s6">0</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">umax</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">))</span>
        <span class="s1">d2 </span><span class="s3">= </span><span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s1">umax</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">), [</span><span class="s6">0</span><span class="s3">])</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">d2</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">(</span><span class="s1">umax</span><span class="s3">)**</span><span class="s6">2</span><span class="s3">)</span>

    <span class="s1">dtypes </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'float16'</span><span class="s3">, </span><span class="s4">'float128'</span><span class="s3">]:</span>
        <span class="s0"># These aren't present in older numpy versions; float128 may also not</span>
        <span class="s0"># be present on all platforms.</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">np</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
            <span class="s1">dtypes</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">np</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">))</span>

    <span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">dtypes</span><span class="s3">:</span>
        <span class="s1">d </span><span class="s3">= </span><span class="s1">wsqeuclidean</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">))</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_sokalmichener</span><span class="s3">():</span>
    <span class="s0"># Test that sokalmichener has the same result for bool and int inputs.</span>
    <span class="s1">p </span><span class="s3">= [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]</span>
    <span class="s1">q </span><span class="s3">= [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]</span>
    <span class="s1">x </span><span class="s3">= [</span><span class="s1">int</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) </span><span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">p</span><span class="s3">]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s1">int</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) </span><span class="s2">for </span><span class="s1">b </span><span class="s2">in </span><span class="s1">q</span><span class="s3">]</span>
    <span class="s1">dist1 </span><span class="s3">= </span><span class="s1">sokalmichener</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s1">q</span><span class="s3">)</span>
    <span class="s1">dist2 </span><span class="s3">= </span><span class="s1">sokalmichener</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s0"># These should be exactly the same.</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">dist1</span><span class="s3">, </span><span class="s1">dist2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_sokalmichener_with_weight</span><span class="s3">():</span>
    <span class="s0"># from: | 1 |   | 0 |</span>
    <span class="s0"># to:   | 1 |   | 1 |</span>
    <span class="s0"># weight|   | 1 |   | 0.2</span>
    <span class="s1">ntf </span><span class="s3">= </span><span class="s6">0 </span><span class="s3">* </span><span class="s6">1 </span><span class="s3">+ </span><span class="s6">0 </span><span class="s3">* </span><span class="s6">0.2</span>
    <span class="s1">nft </span><span class="s3">= </span><span class="s6">0 </span><span class="s3">* </span><span class="s6">1 </span><span class="s3">+ </span><span class="s6">1 </span><span class="s3">* </span><span class="s6">0.2</span>
    <span class="s1">ntt </span><span class="s3">= </span><span class="s6">1 </span><span class="s3">* </span><span class="s6">1 </span><span class="s3">+ </span><span class="s6">0 </span><span class="s3">* </span><span class="s6">0.2</span>
    <span class="s1">nff </span><span class="s3">= </span><span class="s6">0 </span><span class="s3">* </span><span class="s6">1 </span><span class="s3">+ </span><span class="s6">0 </span><span class="s3">* </span><span class="s6">0.2</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s6">2 </span><span class="s3">* (</span><span class="s1">nft </span><span class="s3">+ </span><span class="s1">ntf</span><span class="s3">) / (</span><span class="s1">ntt </span><span class="s3">+ </span><span class="s1">nff </span><span class="s3">+ </span><span class="s6">2 </span><span class="s3">* (</span><span class="s1">nft </span><span class="s3">+ </span><span class="s1">ntf</span><span class="s3">))</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s6">0.2857143</span><span class="s3">)</span>
    <span class="s1">actual </span><span class="s3">= </span><span class="s1">sokalmichener</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">], [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">], </span><span class="s1">w</span><span class="s3">=[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0.2</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">expected</span><span class="s3">, </span><span class="s1">actual</span><span class="s3">)</span>

    <span class="s1">a1 </span><span class="s3">= [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">,</span>
          <span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]</span>
    <span class="s1">a2 </span><span class="s3">= [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">,</span>
          <span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">, </span><span class="s2">True</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">w </span><span class="s2">in </span><span class="s3">[</span><span class="s6">0.05</span><span class="s3">, </span><span class="s6">0.1</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">20.0</span><span class="s3">]:</span>
        <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">sokalmichener</span><span class="s3">(</span><span class="s1">a2</span><span class="s3">, </span><span class="s1">a1</span><span class="s3">, [</span><span class="s1">w</span><span class="s3">]), </span><span class="s6">0.6666666666666666</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_modifies_input</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">):</span>
    <span class="s0"># test whether cdist or pdist modifies input arrays</span>
    <span class="s1">X1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">, </span><span class="s6">3.</span><span class="s3">],</span>
                     <span class="s3">[</span><span class="s6">1.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">3.4</span><span class="s3">],</span>
                     <span class="s3">[</span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">],</span>
                     <span class="s3">[</span><span class="s6">22.2</span><span class="s3">, </span><span class="s6">23.3</span><span class="s3">, </span><span class="s6">44.4</span><span class="s3">]])</span>
    <span class="s1">X1_copy </span><span class="s3">= </span><span class="s1">X1</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">)</span>
    <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X1_copy</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_Xdist_deprecated_args</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">):</span>
    <span class="s0"># testing both cdist and pdist deprecated warnings</span>
    <span class="s1">X1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s6">1.</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">, </span><span class="s6">3.</span><span class="s3">],</span>
                     <span class="s3">[</span><span class="s6">1.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">3.4</span><span class="s3">],</span>
                     <span class="s3">[</span><span class="s6">2.2</span><span class="s3">, </span><span class="s6">2.3</span><span class="s3">, </span><span class="s6">4.4</span><span class="s3">],</span>
                     <span class="s3">[</span><span class="s6">22.2</span><span class="s3">, </span><span class="s6">23.3</span><span class="s3">, </span><span class="s6">44.4</span><span class="s3">]])</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
        <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s6">2.</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">arg </span><span class="s2">in </span><span class="s3">[</span><span class="s4">&quot;p&quot;</span><span class="s3">, </span><span class="s4">&quot;V&quot;</span><span class="s3">, </span><span class="s4">&quot;VI&quot;</span><span class="s3">]:</span>
        <span class="s1">kwargs </span><span class="s3">= {</span><span class="s1">arg</span><span class="s3">: </span><span class="s4">&quot;foo&quot;</span><span class="s3">}</span>

        <span class="s2">if </span><span class="s3">((</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">&quot;V&quot; </span><span class="s2">and </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;seuclidean&quot;</span><span class="s3">)</span>
                <span class="s2">or </span><span class="s3">(</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">&quot;VI&quot; </span><span class="s2">and </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;mahalanobis&quot;</span><span class="s3">)</span>
                <span class="s2">or </span><span class="s3">(</span><span class="s1">arg </span><span class="s3">== </span><span class="s4">&quot;p&quot; </span><span class="s2">and </span><span class="s1">metric </span><span class="s3">== </span><span class="s4">&quot;minkowski&quot;</span><span class="s3">)):</span>
            <span class="s2">continue</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_Xdist_non_negative_weights</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">eo</span><span class="s3">[</span><span class="s4">'random-float32-data'</span><span class="s3">][::</span><span class="s6">5</span><span class="s3">, ::</span><span class="s6">2</span><span class="s3">]</span>
    <span class="s1">w </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s6">1</span><span class="s3">])</span>
    <span class="s1">w</span><span class="s3">[::</span><span class="s6">5</span><span class="s3">] = -</span><span class="s1">w</span><span class="s3">[::</span><span class="s6">5</span><span class="s3">]</span>

    <span class="s2">if </span><span class="s1">metric </span><span class="s2">in </span><span class="s3">[</span><span class="s4">'seuclidean'</span><span class="s3">, </span><span class="s4">'mahalanobis'</span><span class="s3">, </span><span class="s4">'jensenshannon'</span><span class="s3">]:</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">&quot;not applicable&quot;</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">m </span><span class="s2">in </span><span class="s3">[</span><span class="s1">metric</span><span class="s3">, </span><span class="s1">eval</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">), </span><span class="s4">&quot;test_&quot; </span><span class="s3">+ </span><span class="s1">metric</span><span class="s3">]:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">pdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">w</span><span class="s3">=</span><span class="s1">w</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
            <span class="s1">cdist</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">w</span><span class="s3">=</span><span class="s1">w</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test__validate_vector</span><span class="s3">():</span>
    <span class="s1">x </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">]</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">_validate_vector</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s1">y </span><span class="s3">= </span><span class="s1">_validate_vector</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>

    <span class="s1">x </span><span class="s3">= [</span><span class="s6">1</span><span class="s3">]</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">_validate_vector</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">ndim</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">x</span><span class="s3">)</span>

    <span class="s1">x </span><span class="s3">= </span><span class="s6">1</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Input vector should be 1-D&quot;</span><span class="s3">):</span>
        <span class="s1">_validate_vector</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">5</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s6">1</span><span class="s3">, -</span><span class="s6">1</span><span class="s3">, </span><span class="s6">1</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Input vector should be 1-D&quot;</span><span class="s3">):</span>
        <span class="s1">_validate_vector</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

    <span class="s1">x </span><span class="s3">= [[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">], [</span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">]]</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s4">&quot;Input vector should be 1-D&quot;</span><span class="s3">):</span>
        <span class="s1">_validate_vector</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">test_yule_all_same</span><span class="s3">():</span>
    <span class="s0"># Test yule avoids a divide by zero when exactly equal</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s6">2</span><span class="s3">, </span><span class="s6">6</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)</span>
    <span class="s1">d </span><span class="s3">= </span><span class="s1">wyule</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">x</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">d </span><span class="s3">== </span><span class="s6">0.0</span>

    <span class="s1">d </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s4">'yule'</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, [</span><span class="s6">0.0</span><span class="s3">])</span>

    <span class="s1">d </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">], </span><span class="s1">x</span><span class="s3">[:</span><span class="s6">1</span><span class="s3">], </span><span class="s4">'yule'</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">d</span><span class="s3">, [[</span><span class="s6">0.0</span><span class="s3">]])</span>


<span class="s2">def </span><span class="s1">test_jensenshannon</span><span class="s3">():</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">], [</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">], </span><span class="s6">2.0</span><span class="s3">),</span>
                        <span class="s6">1.0</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">], [</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">0.5</span><span class="s3">]),</span>
                        <span class="s6">0.46450140402245893</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">], [</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">]), </span><span class="s6">0.0</span><span class="s3">)</span>

    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]], [[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">),</span>
                        <span class="s3">[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]], [[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                        <span class="s3">[</span><span class="s6">0.0649045</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]], [[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">,</span>
                                      <span class="s1">keepdims</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), [[</span><span class="s6">0.0</span><span class="s3">, </span><span class="s6">0.0</span><span class="s3">]])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">([[</span><span class="s6">1.0</span><span class="s3">, </span><span class="s6">2.0</span><span class="s3">]], [[</span><span class="s6">0.5</span><span class="s3">, </span><span class="s6">1.5</span><span class="s3">]], </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">,</span>
                                      <span class="s1">keepdims</span><span class="s3">=</span><span class="s2">True</span><span class="s3">), [[</span><span class="s6">0.0649045</span><span class="s3">]])</span>

    <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">1</span><span class="s3">, </span><span class="s6">2</span><span class="s3">, </span><span class="s6">3</span><span class="s3">, </span><span class="s6">4</span><span class="s3">],</span>
                  <span class="s3">[</span><span class="s6">5</span><span class="s3">, </span><span class="s6">6</span><span class="s3">, </span><span class="s6">7</span><span class="s3">, </span><span class="s6">8</span><span class="s3">],</span>
                  <span class="s3">[</span><span class="s6">9</span><span class="s3">, </span><span class="s6">10</span><span class="s3">, </span><span class="s6">11</span><span class="s3">, </span><span class="s6">12</span><span class="s3">]])</span>
    <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s6">13</span><span class="s3">, </span><span class="s6">14</span><span class="s3">, </span><span class="s6">15</span><span class="s3">, </span><span class="s6">16</span><span class="s3">],</span>
                  <span class="s3">[</span><span class="s6">17</span><span class="s3">, </span><span class="s6">18</span><span class="s3">, </span><span class="s6">19</span><span class="s3">, </span><span class="s6">20</span><span class="s3">],</span>
                  <span class="s3">[</span><span class="s6">21</span><span class="s3">, </span><span class="s6">22</span><span class="s3">, </span><span class="s6">23</span><span class="s3">, </span><span class="s6">24</span><span class="s3">]])</span>

    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">0</span><span class="s3">),</span>
                        <span class="s3">[</span><span class="s6">0.1954288</span><span class="s3">, </span><span class="s6">0.1447697</span><span class="s3">, </span><span class="s6">0.1138377</span><span class="s3">, </span><span class="s6">0.0927636</span><span class="s3">])</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">jensenshannon</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s6">1</span><span class="s3">),</span>
                        <span class="s3">[</span><span class="s6">0.1402339</span><span class="s3">, </span><span class="s6">0.0399106</span><span class="s3">, </span><span class="s6">0.0201815</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_gh_17703</span><span class="s3">():</span>
    <span class="s1">arr_1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">1</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">arr_2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s6">2</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">])</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">dice</span><span class="s3">(</span><span class="s1">arr_1</span><span class="s3">, </span><span class="s1">arr_2</span><span class="s3">)</span>
    <span class="s1">actual </span><span class="s3">= </span><span class="s1">pdist</span><span class="s3">([</span><span class="s1">arr_1</span><span class="s3">, </span><span class="s1">arr_2</span><span class="s3">], </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'dice'</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>
    <span class="s1">actual </span><span class="s3">= </span><span class="s1">cdist</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span><span class="s1">arr_1</span><span class="s3">),</span>
                   <span class="s1">np</span><span class="s3">.</span><span class="s1">atleast_2d</span><span class="s3">(</span><span class="s1">arr_2</span><span class="s3">), </span><span class="s1">metric</span><span class="s3">=</span><span class="s4">'dice'</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">actual</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_immutable_input</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">):</span>
    <span class="s2">if </span><span class="s1">metric </span><span class="s2">in </span><span class="s3">(</span><span class="s4">&quot;jensenshannon&quot;</span><span class="s3">, </span><span class="s4">&quot;mahalanobis&quot;</span><span class="s3">, </span><span class="s4">&quot;seuclidean&quot;</span><span class="s3">):</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s4">&quot;not applicable&quot;</span><span class="s3">)</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s6">10</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">x</span><span class="s3">.</span><span class="s1">setflags</span><span class="s3">(</span><span class="s1">write</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">getattr</span><span class="s3">(</span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">spatial</span><span class="s3">.</span><span class="s1">distance</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">)(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">w</span><span class="s3">=</span><span class="s1">x</span><span class="s3">)</span>
</pre>
</body>
</html>