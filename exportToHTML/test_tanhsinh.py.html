<html>
<head>
<title>test_tanhsinh.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_tanhsinh.py</font>
</center></td></tr></table>
<pre><span class="s0"># mypy: disable-error-code=&quot;attr-defined&quot;</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_equal</span>

<span class="s2">import </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_elementwise_iterative_method </span><span class="s2">as </span><span class="s1">eim</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">special</span><span class="s3">, </span><span class="s1">stats</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">integrate </span><span class="s2">import </span><span class="s1">quad_vec</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">integrate</span><span class="s3">.</span><span class="s1">_tanhsinh </span><span class="s2">import </span><span class="s1">_tanhsinh</span><span class="s3">, </span><span class="s1">_pair_cache</span><span class="s3">, </span><span class="s1">_nsum</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_discrete_distns </span><span class="s2">import </span><span class="s1">_gen_harmonic_gt1</span>

<span class="s2">class </span><span class="s1">TestTanhSinh</span><span class="s3">:</span>

    <span class="s0"># Test problems from [1] Section 6</span>
    <span class="s2">def </span><span class="s1">f1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">t </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">t</span><span class="s3">)</span>

    <span class="s1">f1</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s4">0.25</span>
    <span class="s1">f1</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">t </span><span class="s3">** </span><span class="s4">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>

    <span class="s1">f2</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">- </span><span class="s4">2 </span><span class="s3">+ </span><span class="s4">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)) / </span><span class="s4">12</span>
    <span class="s1">f2</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>

    <span class="s1">f3</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">) - </span><span class="s4">1</span><span class="s3">) / </span><span class="s4">2</span>
    <span class="s1">f3</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span>

    <span class="s2">def </span><span class="s1">f4</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">2 </span><span class="s3">+ </span><span class="s1">t </span><span class="s3">** </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arctan</span><span class="s3">(</span><span class="s1">a</span><span class="s3">) / ((</span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">t </span><span class="s3">** </span><span class="s4">2</span><span class="s3">) * </span><span class="s1">a</span><span class="s3">)</span>

    <span class="s1">f4</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s4">5 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">** </span><span class="s4">2 </span><span class="s3">/ </span><span class="s4">96</span>
    <span class="s1">f4</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f5</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>

    <span class="s1">f5</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= -</span><span class="s4">4 </span><span class="s3">/ </span><span class="s4">9</span>
    <span class="s1">f5</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f6</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">t </span><span class="s3">** </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">f6</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">4</span>
    <span class="s1">f6</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f7</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) / </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">t </span><span class="s3">** </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">f7</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s4">2 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">) * </span><span class="s1">special</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">(</span><span class="s4">3 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">) / </span><span class="s1">special</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">(</span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">4</span><span class="s3">)</span>
    <span class="s1">f7</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f8</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) ** </span><span class="s4">2</span>

    <span class="s1">f8</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s4">2</span>
    <span class="s1">f8</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s4">1</span>

    <span class="s2">def </span><span class="s1">f9</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">t</span><span class="s3">))</span>

    <span class="s1">f9</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s4">2</span><span class="s3">) / </span><span class="s4">2</span>
    <span class="s1">f9</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span>

    <span class="s2">def </span><span class="s1">f10</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tan</span><span class="s3">(</span><span class="s1">t</span><span class="s3">))</span>

    <span class="s1">f10</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">2</span><span class="s3">) / </span><span class="s4">2</span>
    <span class="s1">f10</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span>

    <span class="s2">def </span><span class="s1">f11</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ (</span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">t </span><span class="s3">** </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">f11</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span>
    <span class="s1">f11</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

    <span class="s2">def </span><span class="s1">f12</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">t</span><span class="s3">) / </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>

    <span class="s1">f12</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
    <span class="s1">f12</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

    <span class="s2">def </span><span class="s1">f13</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">t </span><span class="s3">** </span><span class="s4">2 </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">f13</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">f13</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

    <span class="s2">def </span><span class="s1">f14</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">t</span><span class="s3">) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">t</span><span class="s3">)</span>

    <span class="s1">f14</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s4">0.5</span>
    <span class="s1">f14</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

    <span class="s2">def </span><span class="s1">f15</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">t</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s1">t</span><span class="s3">) / </span><span class="s1">t</span>

    <span class="s1">f15</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">/ </span><span class="s4">2</span>
    <span class="s1">f15</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>

    <span class="s2">def </span><span class="s1">error</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">res</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">err </span><span class="s3">= </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">res </span><span class="s3">- </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">log</span><span class="s3">:</span>
            <span class="s2">return </span><span class="s1">err</span>

        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">divide</span><span class="s3">=</span><span class="s5">'ignore'</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log10</span><span class="s3">(</span><span class="s1">err</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'`f` must be callable.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s4">42</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be True or False.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be real numbers.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">1</span><span class="s3">+</span><span class="s4">1j</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">'ekki'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">pytest</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be non-negative and finite.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...may not be positive infinity.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be integers.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">object</span><span class="s3">())</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxfun</span><span class="s3">=</span><span class="s4">1</span><span class="s3">+</span><span class="s4">1j</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">minlevel</span><span class="s3">=</span><span class="s5">&quot;migratory coconut&quot;</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be non-negative.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxfun</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">minlevel</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be True or False.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">preserve_shape</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be callable.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">callback</span><span class="s3">=</span><span class="s5">'elderberry'</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;limits, ref&quot;</span><span class="s3">, [</span>
        <span class="s3">[(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">), </span><span class="s4">0.5</span><span class="s3">],  </span><span class="s0"># b infinite</span>
        <span class="s3">[(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">0</span><span class="s3">), </span><span class="s4">0.5</span><span class="s3">],  </span><span class="s0"># a infinite</span>
        <span class="s3">[(-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">), </span><span class="s4">1</span><span class="s3">],  </span><span class="s0"># a and b infinite</span>
        <span class="s3">[(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">), -</span><span class="s4">1</span><span class="s3">],  </span><span class="s0"># flipped limits</span>
        <span class="s3">[(</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">), </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">) -  </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">.</span><span class="s1">cdf</span><span class="s3">(</span><span class="s4">1</span><span class="s3">)],  </span><span class="s0"># flipped limits</span>
    <span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_integral_transforms</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">limits</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">):</span>
        <span class="s0"># Check that the integral transforms are behaving for both normal and</span>
        <span class="s0"># log integration</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">()</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, *</span><span class="s1">limits</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s1">logres </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, *</span><span class="s1">limits</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s0"># Transformation should not make the result complex unnecessarily</span>
        <span class="s2">assert </span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">) </span><span class="s2">if </span><span class="s1">ref </span><span class="s3">&gt; </span><span class="s4">0</span>
                <span class="s2">else </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complexfloating</span><span class="s3">))</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">error</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-16</span><span class="s3">)</span>

    <span class="s0"># 15 skipped intentionally; it's very difficult numerically</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'f_number'</span><span class="s3">, </span><span class="s1">range</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">15</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">f_number</span><span class="s3">):</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s5">f&quot;f</span><span class="s2">{</span><span class="s1">f_number</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s1">rtol </span><span class="s3">= </span><span class="s4">2e-8</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s1">f_number </span><span class="s2">not in </span><span class="s3">{</span><span class="s4">14</span><span class="s3">}:  </span><span class="s0"># mildly underestimates error here</span>
            <span class="s1">true_error </span><span class="s3">= </span><span class="s1">abs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">)/</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">true_error </span><span class="s3">&lt; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span>

        <span class="s2">if </span><span class="s1">f_number </span><span class="s2">in </span><span class="s3">{</span><span class="s4">7</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">12</span><span class="s3">}:  </span><span class="s0"># succeeds, but doesn't know it</span>
            <span class="s2">return</span>

        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">0</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'ref'</span><span class="s3">, (</span><span class="s4">0.5</span><span class="s3">, [</span><span class="s4">0.4</span><span class="s3">, </span><span class="s4">0.6</span><span class="s3">]))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'case'</span><span class="s3">, </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">_distr_params</span><span class="s3">.</span><span class="s1">distcont</span><span class="s3">)</span>
    <span class="s2">def </span><span class="s1">test_accuracy</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">case</span><span class="s3">):</span>
        <span class="s1">distname</span><span class="s3">, </span><span class="s1">params </span><span class="s3">= </span><span class="s1">case</span>
        <span class="s2">if </span><span class="s1">distname </span><span class="s2">in </span><span class="s3">{</span><span class="s5">'dgamma'</span><span class="s3">, </span><span class="s5">'dweibull'</span><span class="s3">, </span><span class="s5">'laplace'</span><span class="s3">, </span><span class="s5">'kstwo'</span><span class="s3">}:</span>
            <span class="s0"># should split up interval at first-derivative discontinuity</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">'tanh-sinh is not great for non-smooth integrands'</span><span class="s3">)</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">distname </span><span class="s2">in </span><span class="s3">{</span><span class="s5">'studentized_range'</span><span class="s3">, </span><span class="s5">'levy_stable'</span><span class="s3">}</span>
                <span class="s2">and not </span><span class="s1">int</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getenv</span><span class="s3">(</span><span class="s5">'SCIPY_XSLOW'</span><span class="s3">, </span><span class="s4">0</span><span class="s3">))):</span>
            <span class="s1">pytest</span><span class="s3">.</span><span class="s1">skip</span><span class="s3">(</span><span class="s5">'This case passes, but it is too slow.'</span><span class="s3">)</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">stats</span><span class="s3">, </span><span class="s1">distname</span><span class="s3">)(*</span><span class="s1">params</span><span class="s3">)</span>
        <span class="s1">x </span><span class="s3">= </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">interval</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, *</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'shape'</span><span class="s3">, [</span><span class="s1">tuple</span><span class="s3">(), (</span><span class="s4">12</span><span class="s3">,), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_vectorization</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">):</span>
        <span class="s0"># Test for correct functionality, output shapes, and dtypes for various</span>
        <span class="s0"># input shapes.</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">82456839535679456794</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">prod</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">ncall </span><span class="s3">+= </span><span class="s4">1</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">+= </span><span class="s4">1 </span><span class="s2">if </span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">size </span><span class="s3">== </span><span class="s1">n </span><span class="s2">or </span><span class="s1">x</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">&lt;=</span><span class="s4">1</span><span class="s3">) </span><span class="s2">else </span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">**</span><span class="s1">p</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">ncall </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">= </span><span class="s4">0</span>

        <span class="s3">@</span><span class="s1">np</span><span class="s3">.</span><span class="s1">vectorize</span>
        <span class="s2">def </span><span class="s1">_tanhsinh_single</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">**</span><span class="s1">p</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">p</span><span class="s3">,))</span>
        <span class="s1">refs </span><span class="s3">= </span><span class="s1">_tanhsinh_single</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">p</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">()</span>

        <span class="s1">attrs </span><span class="s3">= [</span><span class="s5">'integral'</span><span class="s3">, </span><span class="s5">'error'</span><span class="s3">, </span><span class="s5">'success'</span><span class="s3">, </span><span class="s5">'status'</span><span class="s3">, </span><span class="s5">'nfev'</span><span class="s3">, </span><span class="s5">'maxlevel'</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s1">ref_attr </span><span class="s3">= [</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">) </span><span class="s2">for </span><span class="s1">ref </span><span class="s2">in </span><span class="s1">refs</span><span class="s3">]</span>
            <span class="s1">res_attr </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res_attr</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">ref_attr</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res_attr</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bool_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">maxlevel</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">), </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">)</span>
        <span class="s0"># maxlevel = 2 -&gt; 3 function calls (2 initialization, 1 work)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">maxlevel</span><span class="s3">) &gt;= </span><span class="s4">2</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">maxlevel</span><span class="s3">), </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ncall</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_flags</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test cases that should produce different status flags; show that all</span>
        <span class="s0"># can be produced simultaneously.</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">xs</span><span class="s3">, </span><span class="s1">js</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">nit </span><span class="s3">+= </span><span class="s4">1</span>
            <span class="s1">funcs </span><span class="s3">= [</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">**</span><span class="s4">2</span><span class="s3">),  </span><span class="s0"># converges</span>
                     <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">),  </span><span class="s0"># reaches maxiter due to order=2</span>
                     <span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">full_like</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)[()]]  </span><span class="s0"># stops due to NaN</span>
            <span class="s1">res </span><span class="s3">= [</span><span class="s1">funcs</span><span class="s3">[</span><span class="s1">j</span><span class="s3">](</span><span class="s1">x</span><span class="s3">) </span><span class="s2">for </span><span class="s1">x</span><span class="s3">, </span><span class="s1">j </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">xs</span><span class="s3">, </span><span class="s1">js</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">())]</span>
            <span class="s2">return </span><span class="s1">res</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">nit </span><span class="s3">= </span><span class="s4">0</span>

        <span class="s1">args </span><span class="s3">= (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">3</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int64</span><span class="s3">),)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]*</span><span class="s4">3</span><span class="s3">, [-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]*</span><span class="s4">3</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">ref_flags </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, </span><span class="s1">ref_flags</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_flags_preserve_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Same test as above but using `preserve_shape` option to simplify.</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]**</span><span class="s4">2</span><span class="s3">),  </span><span class="s0"># converges</span>
                    <span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s4">1</span><span class="s3">]),  </span><span class="s0"># reaches maxiter due to order=2</span>
                    <span class="s1">np</span><span class="s3">.</span><span class="s1">full_like</span><span class="s3">(</span><span class="s1">x</span><span class="s3">[</span><span class="s4">2</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)[()]]  </span><span class="s0"># stops due to NaN</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]*</span><span class="s4">3</span><span class="s3">, [-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]*</span><span class="s4">3</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">preserve_shape</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">ref_flags </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">0</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, </span><span class="s1">ref_flags</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_preserve_shape</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test `preserve_shape` option</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([[</span><span class="s1">x</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s4">10 </span><span class="s3">* </span><span class="s1">x</span><span class="s3">)],</span>
                               <span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s4">30 </span><span class="s3">* </span><span class="s1">x</span><span class="s3">), </span><span class="s1">x </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sin</span><span class="s3">(</span><span class="s4">100 </span><span class="s3">* </span><span class="s1">x</span><span class="s3">)]])</span>

        <span class="s1">ref </span><span class="s3">= </span><span class="s1">quad_vec</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">preserve_shape</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_convergence</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># demonstrate that number of accurate digits doubles each iteration</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span>
        <span class="s1">last_logerr </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">4</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">minlevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">i</span><span class="s3">)</span>
            <span class="s1">logerr </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s3">(</span><span class="s1">logerr </span><span class="s3">&lt; </span><span class="s1">last_logerr </span><span class="s3">* </span><span class="s4">2 </span><span class="s2">or </span><span class="s1">logerr </span><span class="s3">&lt; -</span><span class="s4">15.5</span><span class="s3">)</span>
            <span class="s1">last_logerr </span><span class="s3">= </span><span class="s1">logerr</span>

    <span class="s2">def </span><span class="s1">test_options_and_result_attributes</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># demonstrate that options are behaving as advertised and status</span>
        <span class="s0"># messages are as intended</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">+= </span><span class="s4">1</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">+= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">size</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">.</span><span class="s1">ref</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">.</span><span class="s1">b</span>
        <span class="s1">default_rtol </span><span class="s3">= </span><span class="s4">1e-12</span>
        <span class="s1">default_atol </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">* </span><span class="s1">default_rtol  </span><span class="s0"># effective default absolute tol</span>

        <span class="s0"># Test default options</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">) &lt; </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error </span><span class="s3">&lt; </span><span class="s1">default_atol</span>
        <span class="s2">assert </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span>
        <span class="s1">ref</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls  </span><span class="s0"># reference number of function calls</span>
        <span class="s2">assert </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">0</span>

        <span class="s0"># Test `maxlevel` equal to required max level</span>
        <span class="s0"># We should get all the same results</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s1">maxlevel </span><span class="s3">= </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">maxlevel</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">maxlevel</span><span class="s3">)</span>
        <span class="s1">res</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls</span>
        <span class="s2">assert </span><span class="s1">res </span><span class="s3">== </span><span class="s1">ref</span>

        <span class="s0"># Now reduce the maximum level. We won't meet tolerances.</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s1">maxlevel </span><span class="s3">-= </span><span class="s4">1</span>
        <span class="s2">assert </span><span class="s1">maxlevel </span><span class="s3">&gt;= </span><span class="s4">2  </span><span class="s0"># can't compare errors otherwise</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">maxlevel</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">) &lt; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error </span><span class="s3">&gt; </span><span class="s1">default_atol</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">&lt; </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>
        <span class="s2">assert </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">- </span><span class="s4">1</span>
        <span class="s2">assert not </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s1">eim</span><span class="s3">.</span><span class="s1">_ECONVERR</span>

        <span class="s0"># `maxfun` is currently not enforced</span>

        <span class="s0"># # Test `maxfun` equal to required number of function evaluations</span>
        <span class="s0"># # We should get all the same results</span>
        <span class="s0"># f.feval, f.calls = 0, 0</span>
        <span class="s0"># maxfun = ref.nfev</span>
        <span class="s0"># res = _tanhsinh(f, 0, f.b, maxfun = maxfun)</span>
        <span class="s0"># assert res == ref</span>
        <span class="s0">#</span>
        <span class="s0"># # Now reduce `maxfun`. We won't meet tolerances.</span>
        <span class="s0"># f.feval, f.calls = 0, 0</span>
        <span class="s0"># maxfun -= 1</span>
        <span class="s0"># res = _tanhsinh(f, 0, f.b, maxfun=maxfun)</span>
        <span class="s0"># assert self.error(res.integral, f.ref) &lt; res.error &gt; default_atol</span>
        <span class="s0"># assert res.nfev == f.feval &lt; ref.nfev</span>
        <span class="s0"># assert f.calls == ref.calls - 1</span>
        <span class="s0"># assert not res.success</span>
        <span class="s0"># assert res.status == 2</span>

        <span class="s0"># Take this result to be the new reference</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">res</span>
        <span class="s1">ref</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls</span>

        <span class="s0"># Test `atol`</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s0"># With this tolerance, we should get the exact same result as ref</span>
        <span class="s1">atol </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>
        <span class="s2">assert </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">calls</span>
        <span class="s0"># Except the result is considered to be successful</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">0</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s0"># With a tighter tolerance, we should get a more accurate result</span>
        <span class="s1">atol </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">) &lt; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error </span><span class="s3">&lt; </span><span class="s1">atol</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">&gt; </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>
        <span class="s2">assert </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">&gt; </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">calls</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">0</span>

        <span class="s0"># Test `rtol`</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s0"># With this tolerance, we should get the exact same result as ref</span>
        <span class="s1">rtol </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">/</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>
        <span class="s2">assert </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">calls</span>
        <span class="s0"># Except the result is considered to be successful</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">0</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span>
        <span class="s0"># With a tighter tolerance, we should get a more accurate result</span>
        <span class="s1">rtol </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nextafter</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">/</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">self</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">)/</span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">&lt; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">/</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">&lt; </span><span class="s1">rtol</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">&gt; </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>
        <span class="s2">assert </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">&gt; </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">calls</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">0</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'rtol'</span><span class="s3">, [</span><span class="s4">1e-4</span><span class="s3">, </span><span class="s4">1e-14</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_log</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">):</span>
        <span class="s0"># Test equivalence of log-integration and regular integration</span>
        <span class="s1">dist </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">()</span>

        <span class="s1">test_tols </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-18</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>

        <span class="s0"># Positive integrand (real log-integrand)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">rtol</span><span class="s3">))</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, **</span><span class="s1">test_tols</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, **</span><span class="s1">test_tols</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>

        <span class="s0"># Real integrand (complex log-integrand)</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">-</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)*</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">logf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) + </span><span class="s4">0j</span><span class="s3">) + </span><span class="s1">dist</span><span class="s3">.</span><span class="s1">logpdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) + </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">* </span><span class="s4">1j</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">logf</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s0"># In gh-19173, we saw `invalid` warnings on one CI platform.</span>
        <span class="s0"># Silencing `all` because I can't reproduce locally and don't want</span>
        <span class="s0"># to risk the need to run CI again.</span>
        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s5">'ignore'</span><span class="s3">):</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, **</span><span class="s1">test_tols</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">), </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, **</span><span class="s1">test_tols</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">nfev</span>

    <span class="s2">def </span><span class="s1">test_complex</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test integration of complex integrand</span>
        <span class="s0"># Finite limits</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s4">1j </span><span class="s3">* </span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">/</span><span class="s4">4</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)/</span><span class="s4">2 </span><span class="s3">+ (</span><span class="s4">1</span><span class="s3">-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s4">2</span><span class="s3">)/</span><span class="s4">2</span><span class="s3">)*</span><span class="s4">1j</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">)</span>

        <span class="s0"># Infinite limits</span>
        <span class="s1">dist1 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">dist2 </span><span class="s3">= </span><span class="s1">stats</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">scale</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">dist1</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) + </span><span class="s4">1j</span><span class="s3">*</span><span class="s1">dist2</span><span class="s3">.</span><span class="s1">pdf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, -(</span><span class="s4">1</span><span class="s3">+</span><span class="s4">1j</span><span class="s3">))</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;maxlevel&quot;</span><span class="s3">, </span><span class="s1">range</span><span class="s3">(</span><span class="s4">4</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_minlevel</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">):</span>
        <span class="s0"># Verify that minlevel does not change the values at which the</span>
        <span class="s0"># integrand is evaluated or the integral/error estimates, only the</span>
        <span class="s0"># number of function calls</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">+= </span><span class="s4">1</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">+= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">size</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">((</span><span class="s1">f</span><span class="s3">.</span><span class="s1">x</span><span class="s3">, </span><span class="s1">x</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()))</span>
            <span class="s2">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([])</span>

        <span class="s1">ref </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">minlevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">maxlevel</span><span class="s3">)</span>
        <span class="s1">ref_x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">minlevel </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">0</span><span class="s3">, </span><span class="s1">maxlevel </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">x </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([])</span>
            <span class="s1">options </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">minlevel</span><span class="s3">=</span><span class="s1">minlevel</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">maxlevel</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, **</span><span class="s1">options</span><span class="s3">)</span>
            <span class="s0"># Should be very close; all that has changed is the order of values</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">4e-16</span><span class="s3">)</span>
            <span class="s0"># Difference in absolute errors &lt;&lt; magnitude of integral</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">4e-16 </span><span class="s3">* </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">== </span><span class="s1">len</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">f</span><span class="s3">.</span><span class="s1">calls </span><span class="s3">== </span><span class="s1">maxlevel </span><span class="s3">- </span><span class="s1">minlevel </span><span class="s3">+ </span><span class="s4">1 </span><span class="s3">+ </span><span class="s4">1  </span><span class="s0"># 1 validation call</span>
            <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s1">ref</span><span class="s3">.</span><span class="s1">status</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">ref_x</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">f</span><span class="s3">.</span><span class="s1">x</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_improper_integrals</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test handling of infinite limits of integration (mixed with finite limits)</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">x</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">isinf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">**</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= [-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s4">20</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s4">20</span><span class="s3">]</span>
        <span class="s1">b </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sqrt</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, [</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">/</span><span class="s4">2</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">/</span><span class="s4">2</span><span class="s3">, -</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">])</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;limits&quot;</span><span class="s3">, ((</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">), ([-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])))</span>
    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;dtype&quot;</span><span class="s3">, (</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">limits</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s0"># Test that dtypes are preserved</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">limits</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)[()]</span>

        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">x</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">rtol </span><span class="s3">= </span><span class="s4">1e-12 </span><span class="s2">if </span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64 </span><span class="s2">else </span><span class="s4">1e-5</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)-</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">a</span><span class="s3">), </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_maxiter_callback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test behavior of `maxiter` parameter and `callback` interface</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s1">minlevel</span><span class="s3">, </span><span class="s1">maxlevel </span><span class="s3">= </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span>
        <span class="s1">maxiter </span><span class="s3">= </span><span class="s1">maxlevel </span><span class="s3">- </span><span class="s1">minlevel </span><span class="s3">+ </span><span class="s4">1</span>
        <span class="s1">kwargs </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span><span class="s1">minlevel</span><span class="s3">=</span><span class="s1">minlevel</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">maxlevel</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">maxlevel </span><span class="s3">== </span><span class="s1">maxlevel</span>

        <span class="s2">def </span><span class="s1">callback</span><span class="s3">(</span><span class="s1">res</span><span class="s3">):</span>
            <span class="s1">callback</span><span class="s3">.</span><span class="s1">iter </span><span class="s3">+= </span><span class="s4">1</span>
            <span class="s1">callback</span><span class="s3">.</span><span class="s1">res </span><span class="s3">= </span><span class="s1">res</span>
            <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s5">'integral'</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== </span><span class="s4">1</span>
            <span class="s2">if </span><span class="s1">callback</span><span class="s3">.</span><span class="s1">iter </span><span class="s3">== </span><span class="s1">maxiter</span><span class="s3">:</span>
                <span class="s2">raise </span><span class="s1">StopIteration</span>
        <span class="s1">callback</span><span class="s3">.</span><span class="s1">iter </span><span class="s3">= -</span><span class="s4">1  </span><span class="s0"># callback called once before first iteration</span>
        <span class="s1">callback</span><span class="s3">.</span><span class="s1">res </span><span class="s3">= </span><span class="s2">None</span>

        <span class="s2">del </span><span class="s1">kwargs</span><span class="s3">[</span><span class="s5">'maxlevel'</span><span class="s3">]</span>
        <span class="s1">res2 </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">, </span><span class="s1">callback</span><span class="s3">=</span><span class="s1">callback</span><span class="s3">)</span>
        <span class="s0"># terminating with callback is identical to terminating due to maxiter</span>
        <span class="s0"># (except for `status`)</span>
        <span class="s2">for </span><span class="s1">key </span><span class="s2">in </span><span class="s1">res</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">():</span>
            <span class="s2">if </span><span class="s1">key </span><span class="s3">== </span><span class="s5">'status'</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">callback</span><span class="s3">.</span><span class="s1">res</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] == </span><span class="s4">1</span>
                <span class="s2">assert </span><span class="s1">res</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] == -</span><span class="s4">2</span>
                <span class="s2">assert </span><span class="s1">res2</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] == -</span><span class="s4">4</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s2">assert </span><span class="s1">res2</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] == </span><span class="s1">callback</span><span class="s3">.</span><span class="s1">res</span><span class="s3">[</span><span class="s1">key</span><span class="s3">] == </span><span class="s1">res</span><span class="s3">[</span><span class="s1">key</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">test_jumpstart</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># The intermediate results at each level i should be the same as the</span>
        <span class="s0"># final results when jumpstarting at level i; i.e. minlevel=maxlevel=i</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(-</span><span class="s1">x</span><span class="s3">*</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">callback</span><span class="s3">(</span><span class="s1">res</span><span class="s3">):</span>
            <span class="s1">callback</span><span class="s3">.</span><span class="s1">integrals</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">)</span>
            <span class="s1">callback</span><span class="s3">.</span><span class="s1">errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">)</span>
        <span class="s1">callback</span><span class="s3">.</span><span class="s1">integrals </span><span class="s3">= []</span>
        <span class="s1">callback</span><span class="s3">.</span><span class="s1">errors </span><span class="s3">= []</span>

        <span class="s1">maxlevel </span><span class="s3">= </span><span class="s4">4</span>
        <span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">minlevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">maxlevel</span><span class="s3">, </span><span class="s1">callback</span><span class="s3">=</span><span class="s1">callback</span><span class="s3">)</span>

        <span class="s1">integrals </span><span class="s3">= []</span>
        <span class="s1">errors </span><span class="s3">= []</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">maxlevel </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">minlevel</span><span class="s3">=</span><span class="s1">i</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s1">i</span><span class="s3">)</span>
            <span class="s1">integrals</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">)</span>
            <span class="s1">errors</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">)</span>

        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">callback</span><span class="s3">.</span><span class="s1">integrals</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:], </span><span class="s1">integrals</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">callback</span><span class="s3">.</span><span class="s1">errors</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:], </span><span class="s1">errors</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-16</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_special_cases</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># Test edge cases and other special cases</span>

        <span class="s0"># Test that integers are not passed to `f`</span>
        <span class="s0"># (otherwise this would overflow)</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floating</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">x </span><span class="s3">** </span><span class="s4">99</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s4">1</span><span class="s3">/</span><span class="s4">100</span><span class="s3">)</span>

        <span class="s0"># Test levels 0 and 1; error is NaN</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">&gt; </span><span class="s4">0</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">maxlevel</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral </span><span class="s3">&gt; </span><span class="s4">0</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>

        <span class="s0"># Tes equal left and right integration limits</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">maxlevel </span><span class="s3">== -</span><span class="s4">1</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>

        <span class="s0"># Test scalar `args` (not in tuple)</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">c</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">x</span><span class="s3">**</span><span class="s1">c</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s4">99</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s4">1</span><span class="s3">/</span><span class="s4">100</span><span class="s3">)</span>

        <span class="s0"># Test NaNs</span>
        <span class="s1">a </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]</span>
        <span class="s1">b </span><span class="s3">= [</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">c </span><span class="s3">= [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">c</span><span class="s3">,))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">[:</span><span class="s4">3</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, [-</span><span class="s4">3</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">[:</span><span class="s4">3</span><span class="s3">], </span><span class="s4">1</span><span class="s3">)</span>

        <span class="s0"># Test complex integral followed by real integral</span>
        <span class="s0"># Previously, h0 was of the result dtype. If the `dtype` were complex,</span>
        <span class="s0"># this could lead to complex cached abscissae/weights. If these get</span>
        <span class="s0"># cast to real dtype for a subsequent real integral, we would get a</span>
        <span class="s0"># ComplexWarning. Check that this is avoided.</span>
        <span class="s1">_pair_cache</span><span class="s3">.</span><span class="s1">xjc </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">_pair_cache</span><span class="s3">.</span><span class="s1">wj </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">_pair_cache</span><span class="s3">.</span><span class="s1">indices </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">]</span>
        <span class="s1">_pair_cache</span><span class="s3">.</span><span class="s1">h0 </span><span class="s3">= </span><span class="s2">None</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">*</span><span class="s4">1j</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">*</span><span class="s4">1j</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">integral</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">)</span>

        <span class="s0"># Test zero-size</span>
        <span class="s1">shape </span><span class="s3">= (</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_tanhsinh</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s1">x</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">))</span>
        <span class="s1">attrs </span><span class="s3">= [</span><span class="s5">'integral'</span><span class="s3">, </span><span class="s5">'error'</span><span class="s3">, </span><span class="s5">'success'</span><span class="s3">, </span><span class="s5">'status'</span><span class="s3">, </span><span class="s5">'nfev'</span><span class="s3">, </span><span class="s5">'maxlevel'</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">[</span><span class="s1">attr</span><span class="s3">].</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">TestNSum</span><span class="s3">:</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">5895448232066142650</span><span class="s3">)</span>
    <span class="s1">p </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">f1</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">):</span>
        <span class="s0"># Integers are never passed to `f1`; if they were, we'd get</span>
        <span class="s0"># integer to negative integer power error</span>
        <span class="s2">return </span><span class="s1">k</span><span class="s3">**(-</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">f1</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi</span><span class="s3">**</span><span class="s4">2</span><span class="s3">/</span><span class="s4">6</span>
    <span class="s1">f1</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s4">1</span>
    <span class="s1">f1</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
    <span class="s1">f1</span><span class="s3">.</span><span class="s1">args </span><span class="s3">= </span><span class="s1">tuple</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">f2</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">k</span><span class="s3">**</span><span class="s1">p</span>

    <span class="s1">f2</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">special</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">f2</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s4">1</span>
    <span class="s1">f2</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
    <span class="s1">f2</span><span class="s3">.</span><span class="s1">args </span><span class="s3">= (</span><span class="s1">p</span><span class="s3">,)</span>

    <span class="s2">def </span><span class="s1">f3</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">k</span><span class="s3">**</span><span class="s1">p</span>

    <span class="s1">f3</span><span class="s3">.</span><span class="s1">a </span><span class="s3">= </span><span class="s4">1</span>
    <span class="s1">f3</span><span class="s3">.</span><span class="s1">b </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">15</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">f3</span><span class="s3">.</span><span class="s1">ref </span><span class="s3">= </span><span class="s1">_gen_harmonic_gt1</span><span class="s3">(</span><span class="s1">f3</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">p</span><span class="s3">)</span>
    <span class="s1">f3</span><span class="s3">.</span><span class="s1">args </span><span class="s3">= (</span><span class="s1">p</span><span class="s3">,)</span>

    <span class="s2">def </span><span class="s1">test_input_validation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'`f` must be callable.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s4">42</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be True or False.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be real numbers.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">1</span><span class="s3">+</span><span class="s4">1j</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">step</span><span class="s3">=</span><span class="s1">object</span><span class="s3">())</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s5">'ekki'</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">pytest</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">all</span><span class="s3">=</span><span class="s5">'ignore'</span><span class="s3">):</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">1</span><span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">((</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== -</span><span class="s4">1</span><span class="s3">) &amp; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
                          <span class="s3">&amp; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">) &amp; ~</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success </span><span class="s3">&amp; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s4">1</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">])</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">((</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== -</span><span class="s4">1</span><span class="s3">) &amp; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
                          <span class="s3">&amp; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">) &amp; ~</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success </span><span class="s3">&amp; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s4">1</span><span class="s3">)</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">step</span><span class="s3">=[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
            <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">((</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== -</span><span class="s4">1</span><span class="s3">) &amp; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
                          <span class="s3">&amp; </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">) &amp; ~</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success </span><span class="s3">&amp; </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">== </span><span class="s4">1</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be non-negative and finite.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...may not be positive infinity.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">message </span><span class="s3">= </span><span class="s5">'...must be a non-negative integer.'</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s4">3.5</span><span class="s3">)</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">message</span><span class="s3">):</span>
            <span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=-</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'f_number'</span><span class="s3">, </span><span class="s1">range</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">))</span>
    <span class="s2">def </span><span class="s1">test_basic</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">f_number</span><span class="s3">):</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s5">f&quot;f</span><span class="s2">{</span><span class="s1">f_number</span><span class="s2">}</span><span class="s5">&quot;</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s1">f</span><span class="s3">.</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">divide</span><span class="s3">=</span><span class="s5">'ignore'</span><span class="s3">):</span>
            <span class="s1">logres </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s2">lambda </span><span class="s3">*</span><span class="s1">args</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">f</span><span class="s3">(*</span><span class="s1">args</span><span class="s3">)),</span>
                           <span class="s1">f</span><span class="s3">.</span><span class="s1">a</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">b</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s1">f</span><span class="s3">.</span><span class="s1">args</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">error</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'maxterms'</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">100</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_integral</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">):</span>
        <span class="s0"># test precise behavior of integral approximation</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span>

        <span class="s2">def </span><span class="s1">logf</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">-</span><span class="s4">2</span><span class="s3">*</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">F</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s3">-</span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">x</span>

        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">])[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s4">20</span><span class="s3">, </span><span class="s4">100</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])[:, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">newaxis</span><span class="s3">]</span>
        <span class="s1">step </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s4">0.5</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">]).</span><span class="s1">reshape</span><span class="s3">((-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
        <span class="s1">nsteps </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">floor</span><span class="s3">((</span><span class="s1">b </span><span class="s3">- </span><span class="s1">a</span><span class="s3">)/</span><span class="s1">step</span><span class="s3">)</span>
        <span class="s1">b_original </span><span class="s3">= </span><span class="s1">b</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">a </span><span class="s3">+ </span><span class="s1">nsteps</span><span class="s3">*</span><span class="s1">step</span>

        <span class="s1">k </span><span class="s3">= </span><span class="s1">a </span><span class="s3">+ </span><span class="s1">maxterms</span><span class="s3">*</span><span class="s1">step</span>
        <span class="s0"># partial sum</span>
        <span class="s1">direct </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">a </span><span class="s3">+ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">maxterms</span><span class="s3">)*</span><span class="s1">step</span><span class="s3">).</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">keepdims</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">integral </span><span class="s3">= (</span><span class="s1">F</span><span class="s3">(</span><span class="s1">b</span><span class="s3">) - </span><span class="s1">F</span><span class="s3">(</span><span class="s1">k</span><span class="s3">))/</span><span class="s1">step  </span><span class="s0"># integral approximation of remainder</span>
        <span class="s1">low </span><span class="s3">= </span><span class="s1">direct </span><span class="s3">+ </span><span class="s1">integral </span><span class="s3">+ </span><span class="s1">f</span><span class="s3">(</span><span class="s1">b</span><span class="s3">)  </span><span class="s0"># theoretical lower bound</span>
        <span class="s1">high </span><span class="s3">= </span><span class="s1">direct </span><span class="s3">+ </span><span class="s1">integral </span><span class="s3">+ </span><span class="s1">f</span><span class="s3">(</span><span class="s1">k</span><span class="s3">)  </span><span class="s0"># theoretical upper bound</span>
        <span class="s1">ref_sum </span><span class="s3">= (</span><span class="s1">low </span><span class="s3">+ </span><span class="s1">high</span><span class="s3">)/</span><span class="s4">2  </span><span class="s0"># _nsum uses average of the two</span>
        <span class="s1">ref_err </span><span class="s3">= (</span><span class="s1">high </span><span class="s3">- </span><span class="s1">low</span><span class="s3">)/</span><span class="s4">2  </span><span class="s0"># error (assuming perfect quadrature)</span>

        <span class="s0"># correct reference values where number of terms &lt; maxterms</span>
        <span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">step </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_arrays</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">step</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndindex</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">):</span>
            <span class="s1">ai</span><span class="s3">, </span><span class="s1">bi</span><span class="s3">, </span><span class="s1">stepi </span><span class="s3">= </span><span class="s1">a</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">b</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">step</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">bi </span><span class="s3">- </span><span class="s1">ai</span><span class="s3">)/</span><span class="s1">stepi </span><span class="s3">+ </span><span class="s4">1 </span><span class="s3">&lt;= </span><span class="s1">maxterms</span><span class="s3">:</span>
                <span class="s1">direct </span><span class="s3">= </span><span class="s1">f</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">ai</span><span class="s3">, </span><span class="s1">bi</span><span class="s3">+</span><span class="s1">stepi</span><span class="s3">, </span><span class="s1">stepi</span><span class="s3">)).</span><span class="s1">sum</span><span class="s3">()</span>
                <span class="s1">ref_sum</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">direct</span>
                <span class="s1">ref_err</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">direct </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">direct</span><span class="s3">).</span><span class="s1">eps</span>

        <span class="s1">rtol </span><span class="s3">= </span><span class="s4">1e-12</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b_original</span><span class="s3">, </span><span class="s1">step</span><span class="s3">=</span><span class="s1">step</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s1">maxterms</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">, </span><span class="s1">ref_sum</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">10</span><span class="s3">*</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">, </span><span class="s1">ref_err</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">100</span><span class="s3">*</span><span class="s1">rtol</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

        <span class="s1">i </span><span class="s3">= ((</span><span class="s1">b_original </span><span class="s3">- </span><span class="s1">a</span><span class="s3">)/</span><span class="s1">step </span><span class="s3">+ </span><span class="s4">1 </span><span class="s3">&lt;= </span><span class="s1">maxterms</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">ref_sum</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">ref_err</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>

        <span class="s1">logres </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">logf</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b_original</span><span class="s3">, </span><span class="s1">step</span><span class="s3">=</span><span class="s1">step</span><span class="s3">, </span><span class="s1">log</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                       <span class="s1">rtol</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">log</span><span class="s3">(</span><span class="s1">rtol</span><span class="s3">), </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s1">maxterms</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">error</span><span class="s3">), </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">logres</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'shape'</span><span class="s3">, [</span><span class="s1">tuple</span><span class="s3">(), (</span><span class="s4">12</span><span class="s3">,), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">), (</span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)])</span>
    <span class="s2">def </span><span class="s1">test_vectorization</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">):</span>
        <span class="s0"># Test for correct functionality, output shapes, and dtypes for various</span>
        <span class="s0"># input shapes.</span>
        <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">default_rng</span><span class="s3">(</span><span class="s4">82456839535679456794</span><span class="s3">)</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">integers</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s0"># when the sum can be computed directly or `maxterms` is large enough</span>
        <span class="s0"># to meet `atol`, there are slight differences (for good reason)</span>
        <span class="s0"># between vectorized call and looping.</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">random</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">) + </span><span class="s4">1</span>
        <span class="s1">n </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">prod</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">+= </span><span class="s4">1 </span><span class="s2">if </span><span class="s3">(</span><span class="s1">x</span><span class="s3">.</span><span class="s1">size </span><span class="s3">== </span><span class="s1">n </span><span class="s2">or </span><span class="s1">x</span><span class="s3">.</span><span class="s1">ndim </span><span class="s3">&lt;= </span><span class="s4">1</span><span class="s3">) </span><span class="s2">else </span><span class="s1">x</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">]</span>
            <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">x </span><span class="s3">** </span><span class="s1">p</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">feval </span><span class="s3">= </span><span class="s4">0</span>

        <span class="s3">@</span><span class="s1">np</span><span class="s3">.</span><span class="s1">vectorize</span>
        <span class="s2">def </span><span class="s1">_nsum_single</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">: </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">x</span><span class="s3">**</span><span class="s1">p</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s1">maxterms</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s4">1000</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">p</span><span class="s3">,))</span>
        <span class="s1">refs </span><span class="s3">= </span><span class="s1">_nsum_single</span><span class="s3">(</span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s4">1000</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">()</span>

        <span class="s1">attrs </span><span class="s3">= [</span><span class="s5">'sum'</span><span class="s3">, </span><span class="s5">'error'</span><span class="s3">, </span><span class="s5">'success'</span><span class="s3">, </span><span class="s5">'status'</span><span class="s3">, </span><span class="s5">'nfev'</span><span class="s3">]</span>
        <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">attrs</span><span class="s3">:</span>
            <span class="s1">ref_attr </span><span class="s3">= [</span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">ref</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">) </span><span class="s2">for </span><span class="s1">ref </span><span class="s2">in </span><span class="s1">refs</span><span class="s3">]</span>
            <span class="s1">res_attr </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">attr</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res_attr</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">ref_attr</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-15</span><span class="s3">)</span>
            <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res_attr</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">shape</span><span class="s3">)</span>

        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bool_</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">issubdtype</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">integer</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">), </span><span class="s1">f</span><span class="s3">.</span><span class="s1">feval</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_status</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span>

        <span class="s1">p </span><span class="s3">= [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0.9</span><span class="s3">, </span><span class="s4">1.1</span><span class="s3">]</span>
        <span class="s1">a </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">b </span><span class="s3">= [</span><span class="s4">10</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">special</span><span class="s3">.</span><span class="s1">zeta</span><span class="s3">(</span><span class="s1">p</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>

        <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">divide</span><span class="s3">=</span><span class="s5">'ignore'</span><span class="s3">):  </span><span class="s0"># intentionally dividing by zero</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">p</span><span class="s3">,))</span>

        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, [-</span><span class="s4">3</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">[</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">], </span><span class="s1">ref</span><span class="s3">[</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">test_nfev</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s1">f</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">+= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">size</span><span class="s3">(</span><span class="s1">x</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">x</span><span class="s3">**</span><span class="s4">2</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">)</span>

        <span class="s1">f</span><span class="s3">.</span><span class="s1">nfev </span><span class="s3">= </span><span class="s4">0</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-6</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">, </span><span class="s1">f</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">test_inclusive</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># There was an edge case off-by one bug when `_direct` was called with</span>
        <span class="s0"># `inclusive=True`. Check that this is resolved.</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">k</span><span class="s3">: </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">k </span><span class="s3">** </span><span class="s4">2</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s4">500</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">0.1</span><span class="s3">)</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">k</span><span class="s3">: </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">k </span><span class="s3">** </span><span class="s4">2</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum </span><span class="s3">&gt; (</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">sum </span><span class="s3">- </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum </span><span class="s3">&lt; (</span><span class="s1">ref</span><span class="s3">.</span><span class="s1">sum </span><span class="s3">+ </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">))</span>

    <span class="s2">def </span><span class="s1">test_special_case</span><span class="s3">(</span><span class="s1">self</span><span class="s3">):</span>
        <span class="s0"># test equal lower/upper limit</span>
        <span class="s1">f </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">b </span><span class="s3">= </span><span class="s4">2</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">, </span><span class="s1">f</span><span class="s3">(</span><span class="s1">a</span><span class="s3">))</span>

        <span class="s0"># Test scalar `args` (not in tuple)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">)  </span><span class="s0"># f1.ref is correct w/ args=2</span>

        <span class="s0"># Test 0 size input</span>
        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))  </span><span class="s0"># arbitrary broadcastable shapes</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">((</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))  </span><span class="s0"># could use Hypothesis</span>
        <span class="s1">p </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">empty</span><span class="s3">(</span><span class="s4">4</span><span class="s3">)  </span><span class="s0"># but it's overkill</span>
        <span class="s1">shape </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">broadcast_shapes</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">b</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, </span><span class="s1">p</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">p</span><span class="s3">,))</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">shape</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">shape</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== </span><span class="s1">shape</span>

        <span class="s0"># Test maxterms=0</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">with </span><span class="s1">np</span><span class="s3">.</span><span class="s1">errstate</span><span class="s3">(</span><span class="s1">divide</span><span class="s3">=</span><span class="s5">'ignore'</span><span class="s3">):</span>
                <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">x</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== -</span><span class="s4">2</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s1">maxterms</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">isnan</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">status </span><span class="s3">== -</span><span class="s4">3</span>

        <span class="s0"># Test NaNs</span>
        <span class="s0"># should skip both direct and integral methods if there are NaNs</span>
        <span class="s1">a </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]</span>
        <span class="s1">b </span><span class="s3">= [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">]</span>
        <span class="s1">p </span><span class="s3">= [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s4">2</span><span class="s3">]</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">f2</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">args</span><span class="s3">=(</span><span class="s1">p</span><span class="s3">,))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">f1</span><span class="s3">.</span><span class="s1">ref</span><span class="s3">])</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">[:</span><span class="s4">3</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">nan</span><span class="s3">)</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">status</span><span class="s3">, [-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">])</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">success</span><span class="s3">, [</span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">False</span><span class="s3">, </span><span class="s2">True</span><span class="s3">])</span>
        <span class="s0"># Ideally res.nfev[2] would be 1, but `tanhsinh` has some function evals</span>
        <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">nfev</span><span class="s3">[:</span><span class="s4">2</span><span class="s3">], </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">'dtype'</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">])</span>
    <span class="s2">def </span><span class="s1">test_dtype</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">):</span>
        <span class="s2">def </span><span class="s1">f</span><span class="s3">(</span><span class="s1">k</span><span class="s3">):</span>
            <span class="s2">assert </span><span class="s1">k</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
            <span class="s2">return </span><span class="s4">1 </span><span class="s3">/ </span><span class="s1">k </span><span class="s3">** </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)[()]</span>

        <span class="s1">a </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">b </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">([</span><span class="s4">10</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">res </span><span class="s3">= </span><span class="s1">_nsum</span><span class="s3">(</span><span class="s1">f</span><span class="s3">, </span><span class="s1">a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>
        <span class="s2">assert </span><span class="s1">res</span><span class="s3">.</span><span class="s1">error</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">dtype</span>

        <span class="s1">rtol </span><span class="s3">= </span><span class="s4">1e-12 </span><span class="s2">if </span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64 </span><span class="s2">else </span><span class="s4">1e-6</span>
        <span class="s1">ref </span><span class="s3">= </span><span class="s1">_gen_harmonic_gt1</span><span class="s3">(</span><span class="s1">b</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">res</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">, </span><span class="s1">ref</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">)</span>
</pre>
</body>
</html>