<html>
<head>
<title>test_query_eval.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_query_eval.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">operator</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">errors </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">NumExprClobberingError</span><span class="s2">,</span>
    <span class="s1">UndefinedVariableError</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">MultiIndex</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">computation</span><span class="s2">.</span><span class="s1">check </span><span class="s0">import </span><span class="s1">NUMEXPR_INSTALLED</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span><span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">], </span><span class="s1">ids</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span><span class="s2">(</span>
    <span class="s1">params</span><span class="s2">=[</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">))],</span>
    <span class="s1">ids</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span>


<span class="s0">def </span><span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">parser </span><span class="s2">!= </span><span class="s3">&quot;pandas&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">f&quot;cannot evaluate with parser=</span><span class="s0">{</span><span class="s1">parser</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestCompat</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">df</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">expected1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">A </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">expected2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">df</span><span class="s2">.</span><span class="s1">A </span><span class="s2">+ </span><span class="s4">1</span>

    <span class="s0">def </span><span class="s1">test_query_default</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">):</span>
        <span class="s5"># GH 12749</span>
        <span class="s5"># this should always work, whether NUMEXPR_INSTALLED or not</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;A&gt;0&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A+1&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">, </span><span class="s1">check_names</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_None</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;A&gt;0&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A+1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">, </span><span class="s1">check_names</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_python</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;A&gt;0&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;python&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A+1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;python&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">, </span><span class="s1">check_names</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_numexpr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">NUMEXPR_INSTALLED</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;A&gt;0&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected1</span><span class="s2">)</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A+1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected2</span><span class="s2">, </span><span class="s1">check_names</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= (</span>
                <span class="s3">r&quot;'numexpr' is not installed or an unsupported version. &quot;</span>
                <span class="s3">r&quot;Cannot use engine='numexpr' for query/eval if 'numexpr' is &quot;</span>
                <span class="s3">r&quot;not installed&quot;</span>
            <span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;A&gt;0&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A+1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameEval</span><span class="s2">:</span>
    <span class="s5"># smaller hits python, larger hits numexpr</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n&quot;</span><span class="s2">, [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4000</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;op_str,op,rop&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">(</span><span class="s3">&quot;+&quot;</span><span class="s2">, </span><span class="s3">&quot;__add__&quot;</span><span class="s2">, </span><span class="s3">&quot;__radd__&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;__sub__&quot;</span><span class="s2">, </span><span class="s3">&quot;__rsub__&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;*&quot;</span><span class="s2">, </span><span class="s3">&quot;__mul__&quot;</span><span class="s2">, </span><span class="s3">&quot;__rmul__&quot;</span><span class="s2">),</span>
            <span class="s2">(</span><span class="s3">&quot;/&quot;</span><span class="s2">, </span><span class="s3">&quot;__truediv__&quot;</span><span class="s2">, </span><span class="s3">&quot;__rtruediv__&quot;</span><span class="s2">),</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_ops</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op_str</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rop</span><span class="s2">, </span><span class="s1">n</span><span class="s2">):</span>
        <span class="s5"># tst ops and reversed ops in evaluation</span>
        <span class="s5"># GH7198</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abcd&quot;</span><span class="s2">))</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">2</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">()</span>

        <span class="s1">base </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(  </span><span class="s5"># noqa: F841</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">m</span><span class="s2">.</span><span class="s1">values</span><span class="s2">, </span><span class="s1">n</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abcd&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s3">f&quot;base </span><span class="s0">{</span><span class="s1">op_str</span><span class="s0">} </span><span class="s3">df&quot;</span><span class="s2">)</span>

        <span class="s5"># ops as strings</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">eval</span><span class="s2">(</span><span class="s3">f&quot;m </span><span class="s0">{</span><span class="s1">op_str</span><span class="s0">} </span><span class="s3">df&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s5"># these are commutative</span>
        <span class="s0">if </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;+&quot;</span><span class="s2">, </span><span class="s3">&quot;*&quot;</span><span class="s2">]:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">op</span><span class="s2">)(</span><span class="s1">m</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s5"># these are not</span>
        <span class="s0">elif </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;/&quot;</span><span class="s2">]:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">rop</span><span class="s2">)(</span><span class="s1">m</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_dataframe_sub_numexpr_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH7192: Note we need a large number of rows to ensure this</span>
        <span class="s5">#  goes through the numexpr path</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s4">25000</span><span class="s2">)})</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">5</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s4">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">25</span><span class="s2">])</span>
        <span class="s1">result </span><span class="s2">= (</span><span class="s4">1 </span><span class="s2">- </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">df</span><span class="s2">)).</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">:</span><span class="s4">25</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_non_str</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 11485</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]})</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;expr must be a string to be evaluated&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">B </span><span class="s2">== </span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s4">111</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_empty_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 13139</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;expr cannot be an empty string&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_eval_resolvers_as_list</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 14095</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ab&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">dict1 </span><span class="s2">= {</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}</span>
        <span class="s1">dict2 </span><span class="s2">= {</span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;a + b&quot;</span><span class="s2">, </span><span class="s1">resolvers</span><span class="s2">=[</span><span class="s1">dict1</span><span class="s2">, </span><span class="s1">dict2</span><span class="s2">]) == </span><span class="s1">dict1</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">dict2</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;a + b&quot;</span><span class="s2">, </span><span class="s1">resolvers</span><span class="s2">=[</span><span class="s1">dict1</span><span class="s2">, </span><span class="s1">dict2</span><span class="s2">]) == </span><span class="s1">dict1</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">dict2</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">test_eval_resolvers_combined</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH 34966</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ab&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">dict1 </span><span class="s2">= {</span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">}</span>

        <span class="s5"># Both input and default index/column resolvers should be usable</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;a + b * c&quot;</span><span class="s2">, </span><span class="s1">resolvers</span><span class="s2">=[</span><span class="s1">dict1</span><span class="s2">])</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;b&quot;</span><span class="s2">] * </span><span class="s1">dict1</span><span class="s2">[</span><span class="s3">&quot;c&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_eval_object_dtype_binop</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH#24883</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a1&quot;</span><span class="s2">: [</span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;N&quot;</span><span class="s2">]})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;c = ((a1 == 'Y') &amp; True)&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a1&quot;</span><span class="s2">: [</span><span class="s3">&quot;Y&quot;</span><span class="s2">, </span><span class="s3">&quot;N&quot;</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">]})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryWithMultiIndex</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_query_with_named_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">, </span><span class="s3">&quot;green&quot;</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">&quot;eggs&quot;</span><span class="s2">, </span><span class="s3">&quot;ham&quot;</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;color&quot;</span><span class="s2">, </span><span class="s3">&quot;food&quot;</span><span class="s2">])</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s3">&quot;color&quot;</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;color&quot;</span>
        <span class="s2">)</span>

        <span class="s5"># equality</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'color == &quot;red&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; == color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">== </span><span class="s3">&quot;red&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># inequality</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'color != &quot;red&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; != color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">!= </span><span class="s3">&quot;red&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># list equality (really just set membership)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'color == [&quot;red&quot;]'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] == color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'color != [&quot;red&quot;]'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] != color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># in/not in ops</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] in color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; in color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] not in color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; not in color'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_with_unnamed_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">, </span><span class="s3">&quot;green&quot;</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">&quot;eggs&quot;</span><span class="s2">, </span><span class="s3">&quot;ham&quot;</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">])</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s4">0</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_0 == &quot;red&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; == ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">== </span><span class="s3">&quot;red&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># inequality</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_0 != &quot;red&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; != ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">!= </span><span class="s3">&quot;red&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># list equality (really just set membership)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_0 == [&quot;red&quot;]'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] == ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_0 != [&quot;red&quot;]'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] != ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># in/not in ops</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] in ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; in ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;red&quot;] not in ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;red&quot; not in ilevel_0'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># ## LEVEL 1</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s4">1</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_1 == &quot;eggs&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;eggs&quot; == ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">== </span><span class="s3">&quot;eggs&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># inequality</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_1 != &quot;eggs&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;eggs&quot; != ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">!= </span><span class="s3">&quot;eggs&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># list equality (really just set membership)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_1 == [&quot;eggs&quot;]'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;eggs&quot;] == ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;eggs&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_1 != [&quot;eggs&quot;]'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;eggs&quot;] != ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;eggs&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s5"># in/not in ops</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;eggs&quot;] in ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;eggs&quot; in ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;eggs&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;eggs&quot;] not in ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;eggs&quot; not in ilevel_1'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">ind</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;eggs&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_with_partially_named_multiindex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">choice</span><span class="s2">([</span><span class="s3">&quot;red&quot;</span><span class="s2">, </span><span class="s3">&quot;green&quot;</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">index </span><span class="s2">= </span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">([</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">])</span>
        <span class="s1">index</span><span class="s2">.</span><span class="s1">names </span><span class="s2">= [</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;rating&quot;</span><span class="s2">]</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;rating == 1&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s3">&quot;rating&quot;</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;rating&quot;</span>
        <span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">== </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;rating != 1&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s3">&quot;rating&quot;</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;rating&quot;</span>
        <span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">!= </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_0 == &quot;red&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s4">0</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">== </span><span class="s3">&quot;red&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'ilevel_0 != &quot;red&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s4">0</span><span class="s2">).</span><span class="s1">values</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">index</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind </span><span class="s2">!= </span><span class="s3">&quot;red&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_multiindex_get_index_resolvers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_arrays</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">) </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">=[</span><span class="s3">&quot;spam&quot;</span><span class="s2">, </span><span class="s3">&quot;eggs&quot;</span><span class="s2">]</span>
            <span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">resolvers </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">_get_index_resolvers</span><span class="s2">()</span>

        <span class="s0">def </span><span class="s1">to_series</span><span class="s2">(</span><span class="s1">mi</span><span class="s2">, </span><span class="s1">level</span><span class="s2">):</span>
            <span class="s1">level_values </span><span class="s2">= </span><span class="s1">mi</span><span class="s2">.</span><span class="s1">get_level_values</span><span class="s2">(</span><span class="s1">level</span><span class="s2">)</span>
            <span class="s1">s </span><span class="s2">= </span><span class="s1">level_values</span><span class="s2">.</span><span class="s1">to_series</span><span class="s2">()</span>
            <span class="s1">s</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">mi</span>
            <span class="s0">return </span><span class="s1">s</span>

        <span class="s1">col_series </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">to_series</span><span class="s2">()</span>
        <span class="s1">expected </span><span class="s2">= {</span>
            <span class="s3">&quot;index&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">,</span>
            <span class="s3">&quot;columns&quot;</span><span class="s2">: </span><span class="s1">col_series</span><span class="s2">,</span>
            <span class="s3">&quot;spam&quot;</span><span class="s2">: </span><span class="s1">to_series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s3">&quot;spam&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;eggs&quot;</span><span class="s2">: </span><span class="s1">to_series</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">, </span><span class="s3">&quot;eggs&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;clevel_0&quot;</span><span class="s2">: </span><span class="s1">col_series</span><span class="s2">,</span>
        <span class="s2">}</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">resolvers</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Index</span><span class="s2">):</span>
                <span class="s0">assert </span><span class="s1">v</span><span class="s2">.</span><span class="s1">is_</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">[</span><span class="s1">k</span><span class="s2">])</span>
            <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">):</span>
                <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">[</span><span class="s1">k</span><span class="s2">])</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">AssertionError</span><span class="s2">(</span><span class="s3">&quot;object must be a Series or Index&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestDataFrameQueryNumExprPandas</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;numexpr&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;pandas&quot;</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_attribute_access</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates2&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2013&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
            <span class="s3">&quot;@df.dates1 &lt; 20130101 &lt; @df.dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates1 </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_query_no_attribute_access</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates2&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2013&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;dates1 &lt; 20130101 &lt; dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates1 </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_NaT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates2&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2013&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;dates1 &lt; 20130101 &lt; dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates1 </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">return_value </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;dates1&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &lt; 20130101 &lt; dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s5"># Cast to object to avoid implicit cast when setting entry to pd.NaT below</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))).</span><span class="s1">astype</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">0</span><span class="s2">: </span><span class="s1">object</span><span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">return_value </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;dates1&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &lt; 20130101 &lt; dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT_duplicates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">d </span><span class="s2">= {}</span>
        <span class="s1">d</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">d</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">d</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">return_value </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;dates1&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;dates1 &lt; 20130101 &lt; dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">to_series</span><span class="s2">() &lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_non_date</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;dates&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">), </span><span class="s3">&quot;nondate&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)}</span>
        <span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;dates == nondate&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">result</span><span class="s2">) == </span><span class="s4">0</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;dates != nondate&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;Invalid comparison between dtype=datetime64\[ns\] and ndarray&quot;</span>
        <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;&lt;&quot;</span><span class="s2">, </span><span class="s3">&quot;&gt;&quot;</span><span class="s2">, </span><span class="s3">&quot;&lt;=&quot;</span><span class="s2">, </span><span class="s3">&quot;&gt;=&quot;</span><span class="s2">]:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">f&quot;dates </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s3">nondate&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_syntax_error</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;i&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s3">&quot;+&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">13</span><span class="s2">), </span><span class="s3">&quot;r&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">14</span><span class="s2">)})</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;invalid syntax&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;i - +&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_scope</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">20</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ab&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2  </span><span class="s5"># noqa: F841</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &gt; b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&gt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;@a &gt; b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">a </span><span class="s2">&gt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s5"># no local variable c</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">UndefinedVariableError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;local variable 'c' is not defined&quot;</span>
        <span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;@a &gt; b &gt; @c&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s5"># no column named 'c'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UndefinedVariableError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;name 'c' is not defined&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;@a &gt; b &gt; c&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_doesnt_pickup_local</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">m </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s5"># we don't pick up the local 'sin'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UndefinedVariableError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;name 'sin' is not defined&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;sin &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_builtin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">m </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;sin&quot;</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Variables in expression.+&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NumExprClobberingError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;sin &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]</span>
        <span class="s2">)</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &lt; b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">), </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a + b &gt; b * c&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">),</span>
            <span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b </span><span class="s2">&gt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b </span><span class="s2">* </span><span class="s1">df</span><span class="s2">.</span><span class="s1">c</span><span class="s2">],</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_index_with_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;blob&quot;</span><span class="s2">),</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;(blob &lt; 5) &amp; (a &lt; b)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s4">5</span><span class="s2">) &amp; (</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;blob &lt; b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_index_without_name</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)),</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">),</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
        <span class="s2">)</span>

        <span class="s5"># &quot;index&quot; should refer to the index</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &lt; b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

        <span class="s5"># test against a scalar</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &lt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nested_scope</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">df2 </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">)]</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;(@df &gt; 0) &amp; (@df2 &gt; 0)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;df[df &gt; 0 and df2 &gt; 0]&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span>
            <span class="s3">&quot;df[df &gt; 0 and df2 &gt; 0 and df[df &gt; 0] &gt; 0]&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">df2 </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">df</span><span class="s2">[</span><span class="s1">df </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">] &gt; </span><span class="s4">0</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;df[(df&gt;0) &amp; (df2&gt;0)]&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;(@df&gt;0) &amp; (@df2&gt;0)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nested_raises_on_local_self_reference</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>

        <span class="s5"># can't reference ourself b/c we're a local so @ is necessary</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UndefinedVariableError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;name 'df' is not defined&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;df &gt; 0&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_local_syntax</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">100</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)),</span>
            <span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abcdefghij&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &lt; @b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &lt; b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_chained_cmp_and_in</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">cols </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">100</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">))), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">cols</span>
        <span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
            <span class="s3">&quot;a &lt; b &lt; c and a not in b not in c&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">ind </span><span class="s2">= (</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">) &amp; (</span><span class="s1">df</span><span class="s2">.</span><span class="s1">b </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">c</span><span class="s2">) &amp; ~</span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">) &amp; ~</span><span class="s1">df</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_local_variable_with_in</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">15</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;a&quot;</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">15</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">b</span><span class="s2">})</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">b </span><span class="s2">- </span><span class="s4">1</span><span class="s2">).</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;b - 1 in a&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">10</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">15</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[(</span><span class="s1">b </span><span class="s2">- </span><span class="s4">1</span><span class="s2">).</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;@b - 1 in a&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_at_inside_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s4">1  </span><span class="s5"># noqa: F841</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;@c&quot;</span><span class="s2">, </span><span class="s3">&quot;@c&quot;</span><span class="s2">]})</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'a == &quot;@c&quot;'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s3">&quot;@c&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_undefined_local</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">engine</span><span class="s2">, </span><span class="s1">parser </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">parser</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ab&quot;</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">UndefinedVariableError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;local variable 'c' is not defined&quot;</span>
        <span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a == @c&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_index_resolvers_come_after_columns_with_the_same_name</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span>
    <span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">1  </span><span class="s5"># noqa: F841</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">20</span><span class="s2">:</span><span class="s4">101</span><span class="s2">:</span><span class="s4">20</span><span class="s2">]</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;index&quot;</span><span class="s2">: </span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;index&quot;</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;index&quot;</span><span class="s2">] &gt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;index&quot;</span><span class="s2">: </span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)}</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;ilevel_0 &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&gt; </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">)})</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;a&quot;</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&gt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&gt; </span><span class="s4">5</span><span class="s2">]]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;op, f&quot;</span><span class="s2">, [[</span><span class="s3">&quot;==&quot;</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">eq</span><span class="s2">], [</span><span class="s3">&quot;!=&quot;</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ne</span><span class="s2">]])</span>
    <span class="s0">def </span><span class="s1">test_inf</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">f</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>
        <span class="s1">q </span><span class="s2">= </span><span class="s3">f&quot;a </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s3">inf&quot;</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">f</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_tz_aware_index_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">tz_aware_fixture</span><span class="s2">):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/29463</span>
        <span class="s1">tz </span><span class="s2">= </span><span class="s1">tz_aware_fixture</span>
        <span class="s1">df_index </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span>
            <span class="s1">start</span><span class="s2">=</span><span class="s3">&quot;2019-01-01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;1d&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s1">tz</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;time&quot;</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">df_index</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">index</span><span class="s2">=</span><span class="s1">df_index</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;2018-01-03 00:00:00+00&quot; &lt; time'</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">df_index</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">reset_index</span><span class="s2">().</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;2018-01-03 00:00:00+00&quot; &lt; time'</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_method_calls_in_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s5"># https://github.com/pandas-dev/pandas/issues/22435</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int&quot;</span><span class="s2">) == </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a.astype('int') == 0&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &lt; </span><span class="s4">0.5</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">,</span>
                    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">n</span><span class="s2">),</span>
                <span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">n</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">].</span><span class="s1">notnull</span><span class="s2">()]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a.notnull()&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_no</span><span class="s2">(</span><span class="s3">&quot;numexpr&quot;</span><span class="s2">)</span>
<span class="s0">class </span><span class="s1">TestDataFrameQueryNumExprPython</span><span class="s2">(</span><span class="s1">TestDataFrameQueryNumExprPandas</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;numexpr&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;python&quot;</span>

    <span class="s0">def </span><span class="s1">test_date_query_no_attribute_access</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates2&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2013&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
            <span class="s3">&quot;(dates1 &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates1 </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_query_with_NaT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates2&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2013&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
            <span class="s3">&quot;(dates1 &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates1 </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">return_value </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;dates1&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
            <span class="s3">&quot;(index &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s5"># Cast to object to avoid implicit cast when setting entry to pd.NaT below</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))).</span><span class="s1">astype</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s4">0</span><span class="s2">: </span><span class="s1">object</span><span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">return_value </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;dates1&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
            <span class="s3">&quot;(index &lt; 20130101) &amp; (20130101 &lt; dates3)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&lt; </span><span class="s3">&quot;20130101&quot;</span><span class="s2">) &amp; (</span><span class="s3">&quot;20130101&quot; </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">dates3</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_date_index_query_with_NaT_duplicates</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2012&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;dates3&quot;</span><span class="s2">] = </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;1/1/2014&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">&quot;dates1&quot;</span><span class="s2">] = </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span>
        <span class="s1">return_value </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;dates1&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">return_value </span><span class="s0">is None</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;'BoolOp' nodes are not implemented&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;index &lt; 20130101 &lt; dates3&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nested_scope</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s5"># smoke test</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s4">1  </span><span class="s5"># noqa: F841</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;x + 1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s4">2</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>
        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)))</span>

        <span class="s5"># don't have the pandas parser</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;The '@' prefix is only supported by the pandas parser&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;(@df&gt;0) &amp; (@df2&gt;0)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">UndefinedVariableError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;name 'df' is not defined&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;(df&gt;0) &amp; (df2&gt;0)&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">df2 </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">)]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;df[(df &gt; 0) &amp; (df2 &gt; 0)]&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s1">df </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">df2 </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">df</span><span class="s2">[</span><span class="s1">df </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">] &gt; </span><span class="s4">0</span><span class="s2">)]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span>
            <span class="s3">&quot;df[(df &gt; 0) &amp; (df2 &gt; 0) &amp; (df[df &gt; 0] &gt; 0)]&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_numexpr_with_min_and_max_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;min&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;max&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]})</span>
        <span class="s1">regex_to_match </span><span class="s2">= (</span>
            <span class="s3">r&quot;Variables in expression \&quot;\(min\) == \(1\)\&quot; &quot;</span>
            <span class="s3">r&quot;overlap with builtins: \('min'\)&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NumExprClobberingError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">regex_to_match</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;min == 1&quot;</span><span class="s2">)</span>

        <span class="s1">regex_to_match </span><span class="s2">= (</span>
            <span class="s3">r&quot;Variables in expression \&quot;\(max\) == \(1\)\&quot; &quot;</span>
            <span class="s3">r&quot;overlap with builtins: \('max'\)&quot;</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NumExprClobberingError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">regex_to_match</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;max == 1&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryPythonPandas</span><span class="s2">(</span><span class="s1">TestDataFrameQueryNumExprPandas</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;python&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;pandas&quot;</span>

    <span class="s0">def </span><span class="s1">test_query_builtin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">m </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;sin&quot;</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&gt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;sin &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryPythonPython</span><span class="s2">(</span><span class="s1">TestDataFrameQueryNumExprPython</span><span class="s2">):</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">engine</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;python&quot;</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">parser</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s3">&quot;python&quot;</span>

    <span class="s0">def </span><span class="s1">test_query_builtin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">m </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s1">m</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;sin&quot;</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index </span><span class="s2">&gt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;sin &gt; 5&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryStrings</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_str_query_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;strings&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aabbccddee&quot;</span><span class="s2">))</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings </span><span class="s2">== </span><span class="s3">&quot;a&quot;</span><span class="s2">]</span>

        <span class="s0">if </span><span class="s1">parser </span><span class="s2">!= </span><span class="s3">&quot;pandas&quot;</span><span class="s2">:</span>
            <span class="s1">col </span><span class="s2">= </span><span class="s3">&quot;strings&quot;</span>
            <span class="s1">lst </span><span class="s2">= </span><span class="s3">'&quot;a&quot;'</span>

            <span class="s1">lhs </span><span class="s2">= [</span><span class="s1">col</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s1">lst</span><span class="s2">] * </span><span class="s4">2</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">lhs</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>

            <span class="s1">eq</span><span class="s2">, </span><span class="s1">ne </span><span class="s2">= </span><span class="s3">&quot;==&quot;</span><span class="s2">, </span><span class="s3">&quot;!=&quot;</span>
            <span class="s1">ops </span><span class="s2">= </span><span class="s4">2 </span><span class="s2">* ([</span><span class="s1">eq</span><span class="s2">] + [</span><span class="s1">ne</span><span class="s2">])</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;'(Not)?In' nodes are not implemented&quot;</span>

            <span class="s0">for </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">ops</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
                <span class="s1">ex </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">lhs</span><span class="s0">} {</span><span class="s1">op</span><span class="s0">} {</span><span class="s1">rhs</span><span class="s0">}</span><span class="s3">&quot;</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                    <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span>
                        <span class="s1">ex</span><span class="s2">,</span>
                        <span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">,</span>
                        <span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">,</span>
                        <span class="s1">local_dict</span><span class="s2">={</span><span class="s3">&quot;strings&quot;</span><span class="s2">: </span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">},</span>
                    <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;a&quot; == strings'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'strings == &quot;a&quot;'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">])])</span>

            <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings </span><span class="s2">!= </span><span class="s3">&quot;a&quot;</span><span class="s2">]</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'strings != &quot;a&quot;'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'&quot;a&quot; != strings'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">])])</span>

    <span class="s0">def </span><span class="s1">test_str_list_query_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
        <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;strings&quot;</span><span class="s2">] = </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aabbccddee&quot;</span><span class="s2">))</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])]</span>

        <span class="s0">if </span><span class="s1">parser </span><span class="s2">!= </span><span class="s3">&quot;pandas&quot;</span><span class="s2">:</span>
            <span class="s1">col </span><span class="s2">= </span><span class="s3">&quot;strings&quot;</span>
            <span class="s1">lst </span><span class="s2">= </span><span class="s3">'[&quot;a&quot;, &quot;b&quot;]'</span>

            <span class="s1">lhs </span><span class="s2">= [</span><span class="s1">col</span><span class="s2">] * </span><span class="s4">2 </span><span class="s2">+ [</span><span class="s1">lst</span><span class="s2">] * </span><span class="s4">2</span>
            <span class="s1">rhs </span><span class="s2">= </span><span class="s1">lhs</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">]</span>

            <span class="s1">eq</span><span class="s2">, </span><span class="s1">ne </span><span class="s2">= </span><span class="s3">&quot;==&quot;</span><span class="s2">, </span><span class="s3">&quot;!=&quot;</span>
            <span class="s1">ops </span><span class="s2">= </span><span class="s4">2 </span><span class="s2">* ([</span><span class="s1">eq</span><span class="s2">] + [</span><span class="s1">ne</span><span class="s2">])</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;'(Not)?In' nodes are not implemented&quot;</span>

            <span class="s0">for </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">rhs </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">ops</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">):</span>
                <span class="s1">ex </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">lhs</span><span class="s0">} {</span><span class="s1">op</span><span class="s0">} {</span><span class="s1">rhs</span><span class="s0">}</span><span class="s3">&quot;</span>
                <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                    <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s1">ex</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'strings == [&quot;a&quot;, &quot;b&quot;]'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;a&quot;, &quot;b&quot;] == strings'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

            <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[~</span><span class="s1">df</span><span class="s2">.</span><span class="s1">strings</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])]</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'strings != [&quot;a&quot;, &quot;b&quot;]'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'[&quot;a&quot;, &quot;b&quot;] != strings'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_with_string_columns</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aaaabbbbcccc&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aabbccddeeff&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">12</span><span class="s2">),</span>
                <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">12</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">parser </span><span class="s2">== </span><span class="s3">&quot;pandas&quot;</span><span class="s2">:</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a in b&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
            <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">)]</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a in b and c &lt; d&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
            <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">isin</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">) &amp; (</span><span class="s1">df</span><span class="s2">.</span><span class="s1">c </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">d</span><span class="s2">)]</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;'(Not)?In' nodes are not implemented&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a in b&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>

            <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;'BoolOp' nodes are not implemented&quot;</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
                <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a in b and c &lt; d&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_object_array_eq_ne</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">using_infer_string</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aaaabbbbcccc&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;aabbccddeeff&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">12</span><span class="s2">),</span>
                <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">12</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">warning </span><span class="s2">= </span><span class="s1">RuntimeWarning </span><span class="s0">if </span><span class="s1">using_infer_string </span><span class="s0">and </span><span class="s1">engine </span><span class="s2">== </span><span class="s3">&quot;numexpr&quot; </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a == b&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a != b&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">exp </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">!= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">b</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">exp</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_with_nested_strings</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">events </span><span class="s2">= [</span>
            <span class="s3">f&quot;page </span><span class="s0">{</span><span class="s1">n</span><span class="s0">} {</span><span class="s1">act</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">) </span><span class="s0">for </span><span class="s1">act </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;load&quot;</span><span class="s2">, </span><span class="s3">&quot;exit&quot;</span><span class="s2">]</span>
        <span class="s2">] * </span><span class="s4">2</span>
        <span class="s1">stamps1 </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2014-01-01 0:00:01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;30s&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">stamps2 </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2014-02-01 1:00:01&quot;</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;30s&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;id&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">).</span><span class="s1">repeat</span><span class="s2">(</span><span class="s4">2</span><span class="s2">),</span>
                <span class="s3">&quot;event&quot;</span><span class="s2">: </span><span class="s1">events</span><span class="s2">,</span>
                <span class="s3">&quot;timestamp&quot;</span><span class="s2">: </span><span class="s1">stamps1</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">stamps2</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">event </span><span class="s2">== </span><span class="s3">'&quot;page 1 load&quot;'</span><span class="s2">]</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot;'&quot;page 1 load&quot;' in event&quot;&quot;&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_with_nested_special_character</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;test &amp; test&quot;</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]})</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">'a == &quot;test &amp; test&quot;'</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">expec </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">a </span><span class="s2">== </span><span class="s3">&quot;test &amp; test&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expec</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;op, func&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s3">&quot;&lt;&quot;</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">lt</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;&gt;&quot;</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">gt</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;&lt;=&quot;</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">le</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;&gt;=&quot;</span><span class="s2">, </span><span class="s1">operator</span><span class="s2">.</span><span class="s1">ge</span><span class="s2">],</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_query_lex_compare_strings</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">op</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">using_infer_string</span>
    <span class="s2">):</span>
        <span class="s1">a </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abcde&quot;</span><span class="s2">), </span><span class="s4">20</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">a</span><span class="s2">.</span><span class="s1">size</span><span class="s2">))</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;X&quot;</span><span class="s2">: </span><span class="s1">a</span><span class="s2">, </span><span class="s3">&quot;Y&quot;</span><span class="s2">: </span><span class="s1">b</span><span class="s2">})</span>

        <span class="s1">warning </span><span class="s2">= </span><span class="s1">RuntimeWarning </span><span class="s0">if </span><span class="s1">using_infer_string </span><span class="s0">and </span><span class="s1">engine </span><span class="s2">== </span><span class="s3">&quot;numexpr&quot; </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">f'X </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s3">&quot;d&quot;'</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">func</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">X</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">)]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_single_element_booleans</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">columns </span><span class="s2">= </span><span class="s3">&quot;bid&quot;</span><span class="s2">, </span><span class="s3">&quot;bidsize&quot;</span><span class="s2">, </span><span class="s3">&quot;ask&quot;</span><span class="s2">, </span><span class="s3">&quot;asksize&quot;</span>
        <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">integers</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">))).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">bool</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;bid &amp; ask&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">bid </span><span class="s2">&amp; </span><span class="s1">df</span><span class="s2">.</span><span class="s1">ask</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_query_string_scalar_variable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">skip_if_no_pandas_parser</span><span class="s2">(</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;Symbol&quot;</span><span class="s2">: [</span><span class="s3">&quot;BUD US&quot;</span><span class="s2">, </span><span class="s3">&quot;BUD US&quot;</span><span class="s2">, </span><span class="s3">&quot;IBM US&quot;</span><span class="s2">, </span><span class="s3">&quot;IBM US&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;Price&quot;</span><span class="s2">: [</span><span class="s4">109.70</span><span class="s2">, </span><span class="s4">109.72</span><span class="s2">, </span><span class="s4">183.30</span><span class="s2">, </span><span class="s4">183.35</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">e </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">.</span><span class="s1">Symbol </span><span class="s2">== </span><span class="s3">&quot;BUD US&quot;</span><span class="s2">]</span>
        <span class="s1">symb </span><span class="s2">= </span><span class="s3">&quot;BUD US&quot;  </span><span class="s5"># noqa: F841</span>
        <span class="s1">r </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;Symbol == @symb&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">e</span><span class="s2">, </span><span class="s1">r</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s3">&quot;in_list&quot;</span><span class="s2">,</span>
        <span class="s2">[</span>
            <span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;asdf&quot;</span><span class="s2">, </span><span class="s3">&quot;ghjk&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;asdf&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;ghjk&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;asdf&quot;</span><span class="s2">, </span><span class="s3">&quot;ghjk&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;asdf&quot;</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s3">&quot;asdf&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_query_string_null_elements</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">in_list</span><span class="s2">):</span>
        <span class="s5"># GITHUB ISSUE #31516</span>
        <span class="s1">parser </span><span class="s2">= </span><span class="s3">&quot;pandas&quot;</span>
        <span class="s1">engine </span><span class="s2">= </span><span class="s3">&quot;python&quot;</span>
        <span class="s1">expected </span><span class="s2">= {</span><span class="s1">i</span><span class="s2">: </span><span class="s1">value </span><span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">in_list</span><span class="s2">) </span><span class="s0">if </span><span class="s1">value </span><span class="s2">== </span><span class="s3">&quot;asdf&quot;</span><span class="s2">}</span>

        <span class="s1">df_expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">expected</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;string&quot;</span><span class="s2">)</span>
        <span class="s1">df_expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">df_expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">in_list</span><span class="s2">}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;string&quot;</span><span class="s2">)</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a == 'asdf'&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">] == </span><span class="s3">&quot;asdf&quot;</span><span class="s2">]</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &lt;= 'asdf'&quot;</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">df_expected</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameEvalWithFrame</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">frame</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_simple_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;a + b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">a </span><span class="s2">+ </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">b</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bool_arith_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;a[a &lt; 1] + b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">a</span><span class="s2">[</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">a </span><span class="s2">&lt; </span><span class="s4">1</span><span class="s2">] + </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">b</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;op&quot;</span><span class="s2">, [</span><span class="s3">&quot;+&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;*&quot;</span><span class="s2">, </span><span class="s3">&quot;/&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_invalid_type_for_operator_raises</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">, </span><span class="s1">op</span><span class="s2">):</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s3">&quot;c&quot;</span><span class="s2">, </span><span class="s3">&quot;d&quot;</span><span class="s2">]})</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;unsupported operand type\(s\) for .+: '.+' and '.+'|Cannot&quot;</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">f&quot;a </span><span class="s0">{</span><span class="s1">op</span><span class="s0">} </span><span class="s3">b&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">=</span><span class="s1">parser</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestDataFrameQueryBacktickQuoting</span><span class="s2">:</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
    <span class="s0">def </span><span class="s1">df</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Yields a dataframe with strings that may or may not need escaping 
        by backticks. The last two columns cannot be escaped by backticks 
        and should raise a ValueError. 
        &quot;&quot;&quot;</span>
        <span class="s0">yield </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                <span class="s3">&quot;B B&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s3">&quot;C C&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                <span class="s3">&quot;C  C&quot;</span><span class="s2">: [</span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                <span class="s3">&quot;C_C&quot;</span><span class="s2">: [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
                <span class="s3">&quot;D_D D&quot;</span><span class="s2">: [</span><span class="s4">11</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">101</span><span class="s2">],</span>
                <span class="s3">&quot;E.E&quot;</span><span class="s2">: [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                <span class="s3">&quot;F-F&quot;</span><span class="s2">: [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">],</span>
                <span class="s3">&quot;1e1&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
                <span class="s3">&quot;def&quot;</span><span class="s2">: [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                <span class="s3">&quot;A (x)&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                <span class="s3">&quot;B(x)&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                <span class="s3">&quot;B (x)&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">4</span><span class="s2">],</span>
                <span class="s3">&quot;  &amp;^ :!$?(} &gt;    &lt;++*''  &quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                <span class="s3">&quot;&quot;</span><span class="s2">: [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s3">&quot; A&quot;</span><span class="s2">: [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">9</span><span class="s2">],</span>
                <span class="s3">&quot;  &quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s3">&quot;it's&quot;</span><span class="s2">: [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s3">&quot;that's&quot;</span><span class="s2">: [</span><span class="s4">9</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">8</span><span class="s2">],</span>
                <span class="s3">&quot;&quot;</span><span class="s2">: [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">6</span><span class="s2">],</span>
                <span class="s3">&quot;foo#bar&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                <span class="s4">1</span><span class="s2">: [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">9</span><span class="s2">],</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_backtick_variable_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;1 &lt; `B B`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s4">1 </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B B&quot;</span><span class="s2">]]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_two_backtick_variables_query</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;1 &lt; `B B` and 4 &lt; `C C`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[(</span><span class="s4">1 </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B B&quot;</span><span class="s2">]) &amp; (</span><span class="s4">4 </span><span class="s2">&lt; </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C C&quot;</span><span class="s2">])]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_single_backtick_variable_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A + `B B`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B B&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_two_backtick_variables_expr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;`B B` + `C C`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B B&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C C&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_already_underscore_variable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;`C_C` + A&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C_C&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_same_name_but_underscores</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;C_C + `C C`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C_C&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C C&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_mixed_underscores_and_spaces</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A + `D_D D`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;D_D D&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_backtick_quote_name_with_no_spaces</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A + `C_C`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C_C&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_special_characters</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;`E.E` + `F-F` - A&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;E.E&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;F-F&quot;</span><span class="s2">] - </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_start_with_digit</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A + `1e1`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;1e1&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_keyword</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;A + `def`&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;def&quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_unneeded_quoting</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`A` &gt; 2&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_parenthesis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`A (x)` &gt; 2&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;A (x)&quot;</span><span class="s2">] &gt; </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_empty_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`` &gt; 5&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;&quot;</span><span class="s2">] &gt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiple_spaces</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`C  C` &gt; 5&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;C  C&quot;</span><span class="s2">] &gt; </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_start_with_spaces</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;` A` + `  `&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot; A&quot;</span><span class="s2">] + </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;  &quot;</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lots_of_operators_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`  &amp;^ :!$?(} &gt;    &lt;++*''  ` &gt; 4&quot;</span><span class="s2">)</span>
        <span class="s1">expect </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;  &amp;^ :!$?(} &gt;    &lt;++*''  &quot;</span><span class="s2">] &gt; </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expect</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_missing_attribute</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s3">&quot;module 'pandas' has no attribute 'thing'&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;@pd.thing&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_failing_quote</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;(Could not convert ).*( to a valid Python identifier.)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`it's` &gt; `that's`&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_failing_character_outside_range</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;(Could not convert ).*( to a valid Python identifier.)&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`` &gt; 4&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_failing_hashtag</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Failed to parse backticks&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">SyntaxError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;`foo#bar` &gt; 4&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_call_non_named_expression</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">df</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Only attributes and variables ('named functions') can be called. 
        .__call__() is not an allowed attribute because that would allow 
        calling anything. 
        https://github.com/pandas-dev/pandas/pull/32460 
        &quot;&quot;&quot;</span>

        <span class="s0">def </span><span class="s1">func</span><span class="s2">(*</span><span class="s1">_</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s4">1</span>

        <span class="s1">funcs </span><span class="s2">= [</span><span class="s1">func</span><span class="s2">]  </span><span class="s5"># noqa: F841</span>

        <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;@func()&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Only named functions are supported&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;@funcs[0]()&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Only named functions are supported&quot;</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;@funcs[0].__call__()&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ea_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">any_numeric_ea_and_arrow_dtype</span><span class="s2">):</span>
        <span class="s5"># GH#29618</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">any_numeric_ea_and_arrow_dtype</span>
        <span class="s2">)</span>
        <span class="s1">warning </span><span class="s2">= </span><span class="s1">RuntimeWarning </span><span class="s0">if </span><span class="s1">NUMEXPR_INSTALLED </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;c = b - a&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]],</span>
            <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
            <span class="s1">dtype</span><span class="s2">=</span><span class="s1">any_numeric_ea_and_arrow_dtype</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ea_dtypes_and_scalar</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH#29618</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Float64&quot;</span><span class="s2">)</span>
        <span class="s1">warning </span><span class="s2">= </span><span class="s1">RuntimeWarning </span><span class="s0">if </span><span class="s1">NUMEXPR_INSTALLED </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;c = b - 1&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Float64&quot;</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_ea_dtypes_and_scalar_operation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">any_numeric_ea_and_arrow_dtype</span><span class="s2">):</span>
        <span class="s5"># GH#29618</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">any_numeric_ea_and_arrow_dtype</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">eval</span><span class="s2">(</span><span class="s3">&quot;c = 2 - 1&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">any_numeric_ea_and_arrow_dtype</span><span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">any_numeric_ea_and_arrow_dtype</span><span class="s2">),</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;c&quot;</span><span class="s2">].</span><span class="s1">dtype</span><span class="s2">),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;Int64&quot;</span><span class="s2">, </span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_query_ea_dtypes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s5"># GH#50261</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)})</span>
        <span class="s1">ref </span><span class="s2">= {</span><span class="s4">2</span><span class="s2">}  </span><span class="s5"># noqa: F841</span>
        <span class="s1">warning </span><span class="s2">= </span><span class="s1">RuntimeWarning </span><span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s3">&quot;Int64&quot; </span><span class="s0">and </span><span class="s1">NUMEXPR_INSTALLED </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a in @ref&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">])})</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;engine&quot;</span><span class="s2">, [</span><span class="s3">&quot;python&quot;</span><span class="s2">, </span><span class="s3">&quot;numexpr&quot;</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype&quot;</span><span class="s2">, [</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;Int64&quot;</span><span class="s2">, </span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_query_ea_equality_comparison</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s5"># GH#50261</span>
        <span class="s1">warning </span><span class="s2">= </span><span class="s1">RuntimeWarning </span><span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s3">&quot;numexpr&quot; </span><span class="s0">else None</span>
        <span class="s0">if </span><span class="s1">engine </span><span class="s2">== </span><span class="s3">&quot;numexpr&quot; </span><span class="s0">and not </span><span class="s1">NUMEXPR_INSTALLED</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;numexpr not installed&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s2">== </span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">), </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)}</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">warning</span><span class="s2">):</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;A == B&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s1">engine</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
                <span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]),</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_all_nat_in_object</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># GH#57068</span>
        <span class="s1">now </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">Timestamp</span><span class="s2">.</span><span class="s1">now</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">)  </span><span class="s5"># noqa: F841</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">utc</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s3">&quot;a &gt; @now&quot;</span><span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: []}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
</pre>
</body>
</html>