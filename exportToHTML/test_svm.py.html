<html>
<head>
<title>test_svm.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_svm.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Testing for Support Vector Machine module (sklearn.svm) 
 
TODO: remove hard coded numerical results when possible 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_equal</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s2">from </span><span class="s1">sklearn </span><span class="s2">import </span><span class="s1">base</span><span class="s3">, </span><span class="s1">datasets</span><span class="s3">, </span><span class="s1">linear_model</span><span class="s3">, </span><span class="s1">metrics</span><span class="s3">, </span><span class="s1">svm</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s1">make_blobs</span><span class="s3">, </span><span class="s1">make_classification</span><span class="s3">, </span><span class="s1">make_regression</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s3">(</span>
    <span class="s1">ConvergenceWarning</span><span class="s3">,</span>
    <span class="s1">NotFittedError</span><span class="s3">,</span>
    <span class="s1">UndefinedMetricWarning</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics </span><span class="s2">import </span><span class="s1">f1_score</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">pairwise </span><span class="s2">import </span><span class="s1">rbf_kernel</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">model_selection </span><span class="s2">import </span><span class="s1">train_test_split</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">multiclass </span><span class="s2">import </span><span class="s1">OneVsRestClassifier</span>

<span class="s4"># mypy error: Module 'sklearn.svm' has no attribute '_libsvm'</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">svm </span><span class="s2">import </span><span class="s3">(  </span><span class="s4"># type: ignore</span>
    <span class="s1">SVR</span><span class="s3">,</span>
    <span class="s1">LinearSVC</span><span class="s3">,</span>
    <span class="s1">LinearSVR</span><span class="s3">,</span>
    <span class="s1">NuSVR</span><span class="s3">,</span>
    <span class="s1">OneClassSVM</span><span class="s3">,</span>
    <span class="s1">_libsvm</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">_classes </span><span class="s2">import </span><span class="s1">_validate_dual_parameter</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">check_random_state</span><span class="s3">, </span><span class="s1">shuffle</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s1">ignore_warnings</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s1">_IS_32BIT</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">, </span><span class="s1">LIL_CONTAINERS</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">validation </span><span class="s2">import </span><span class="s1">_num_samples</span>

<span class="s4"># toy sample</span>
<span class="s1">X </span><span class="s3">= [[-</span><span class="s5">2</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]</span>
<span class="s1">Y </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>
<span class="s1">T </span><span class="s3">= [[-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]]</span>
<span class="s1">true_result </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">]</span>

<span class="s4"># also load the iris dataset</span>
<span class="s1">iris </span><span class="s3">= </span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">load_iris</span><span class="s3">()</span>
<span class="s1">rng </span><span class="s3">= </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s5">42</span><span class="s3">)</span>
<span class="s1">perm </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">permutation</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">size</span><span class="s3">)</span>
<span class="s1">iris</span><span class="s3">.</span><span class="s1">data </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">perm</span><span class="s3">]</span>
<span class="s1">iris</span><span class="s3">.</span><span class="s1">target </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">[</span><span class="s1">perm</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">test_libsvm_parameters</span><span class="s3">():</span>
    <span class="s4"># Test parameters on classes that make use of libsvm.</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, [[-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_vectors_</span><span class="s3">, (</span><span class="s1">X</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">X</span><span class="s3">[</span><span class="s5">3</span><span class="s3">]))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, [</span><span class="s5">0.0</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">Y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_libsvm_iris</span><span class="s3">():</span>
    <span class="s4"># Check consistency on dataset iris.</span>

    <span class="s4"># shuffle the dataset so that labels are not ordered</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s6">&quot;rbf&quot;</span><span class="s3">):</span>
        <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s1">k</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">) == </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">) &gt; </span><span class="s5">0.9</span>
        <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">, </span><span class="s6">&quot;coef_&quot;</span><span class="s3">) == (</span><span class="s1">k </span><span class="s3">== </span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">classes_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">classes_</span><span class="s3">))</span>

    <span class="s4"># check also the low-level API</span>
    <span class="s4"># We unpack the values to create a dictionary with some of the return values</span>
    <span class="s4"># from Libsvm's fit.</span>
    <span class="s3">(</span>
        <span class="s1">libsvm_support</span><span class="s3">,</span>
        <span class="s1">libsvm_support_vectors</span><span class="s3">,</span>
        <span class="s1">libsvm_n_class_SV</span><span class="s3">,</span>
        <span class="s1">libsvm_sv_coef</span><span class="s3">,</span>
        <span class="s1">libsvm_intercept</span><span class="s3">,</span>
        <span class="s1">libsvm_probA</span><span class="s3">,</span>
        <span class="s1">libsvm_probB</span><span class="s3">,</span>
        <span class="s4"># libsvm_fit_status and libsvm_n_iter won't be used below.</span>
        <span class="s1">libsvm_fit_status</span><span class="s3">,</span>
        <span class="s1">libsvm_n_iter</span><span class="s3">,</span>
    <span class="s3">) = </span><span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">))</span>

    <span class="s1">model_params </span><span class="s3">= {</span>
        <span class="s6">&quot;support&quot;</span><span class="s3">: </span><span class="s1">libsvm_support</span><span class="s3">,</span>
        <span class="s6">&quot;SV&quot;</span><span class="s3">: </span><span class="s1">libsvm_support_vectors</span><span class="s3">,</span>
        <span class="s6">&quot;nSV&quot;</span><span class="s3">: </span><span class="s1">libsvm_n_class_SV</span><span class="s3">,</span>
        <span class="s6">&quot;sv_coef&quot;</span><span class="s3">: </span><span class="s1">libsvm_sv_coef</span><span class="s3">,</span>
        <span class="s6">&quot;intercept&quot;</span><span class="s3">: </span><span class="s1">libsvm_intercept</span><span class="s3">,</span>
        <span class="s6">&quot;probA&quot;</span><span class="s3">: </span><span class="s1">libsvm_probA</span><span class="s3">,</span>
        <span class="s6">&quot;probB&quot;</span><span class="s3">: </span><span class="s1">libsvm_probB</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, **</span><span class="s1">model_params</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">) &gt; </span><span class="s5">0.95</span>

    <span class="s4"># We unpack the values to create a dictionary with some of the return values</span>
    <span class="s4"># from Libsvm's fit.</span>
    <span class="s3">(</span>
        <span class="s1">libsvm_support</span><span class="s3">,</span>
        <span class="s1">libsvm_support_vectors</span><span class="s3">,</span>
        <span class="s1">libsvm_n_class_SV</span><span class="s3">,</span>
        <span class="s1">libsvm_sv_coef</span><span class="s3">,</span>
        <span class="s1">libsvm_intercept</span><span class="s3">,</span>
        <span class="s1">libsvm_probA</span><span class="s3">,</span>
        <span class="s1">libsvm_probB</span><span class="s3">,</span>
        <span class="s4"># libsvm_fit_status and libsvm_n_iter won't be used below.</span>
        <span class="s1">libsvm_fit_status</span><span class="s3">,</span>
        <span class="s1">libsvm_n_iter</span><span class="s3">,</span>
    <span class="s3">) = </span><span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>

    <span class="s1">model_params </span><span class="s3">= {</span>
        <span class="s6">&quot;support&quot;</span><span class="s3">: </span><span class="s1">libsvm_support</span><span class="s3">,</span>
        <span class="s6">&quot;SV&quot;</span><span class="s3">: </span><span class="s1">libsvm_support_vectors</span><span class="s3">,</span>
        <span class="s6">&quot;nSV&quot;</span><span class="s3">: </span><span class="s1">libsvm_n_class_SV</span><span class="s3">,</span>
        <span class="s6">&quot;sv_coef&quot;</span><span class="s3">: </span><span class="s1">libsvm_sv_coef</span><span class="s3">,</span>
        <span class="s6">&quot;intercept&quot;</span><span class="s3">: </span><span class="s1">libsvm_intercept</span><span class="s3">,</span>
        <span class="s6">&quot;probA&quot;</span><span class="s3">: </span><span class="s1">libsvm_probA</span><span class="s3">,</span>
        <span class="s6">&quot;probB&quot;</span><span class="s3">: </span><span class="s1">libsvm_probB</span><span class="s3">,</span>
    <span class="s3">}</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, **</span><span class="s1">model_params</span><span class="s3">, </span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">) &gt; </span><span class="s5">0.95</span>

    <span class="s1">pred </span><span class="s3">= </span><span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">cross_validation</span><span class="s3">(</span>
        <span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s5">5</span><span class="s3">, </span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_seed</span><span class="s3">=</span><span class="s5">0</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">) &gt; </span><span class="s5">0.95</span>

    <span class="s4"># If random_seed &gt;= 0, the libsvm rng is seeded (by calling `srand`), hence</span>
    <span class="s4"># we should get deterministic results (assuming that there is no other</span>
    <span class="s4"># thread calling this wrapper calling `srand` concurrently).</span>
    <span class="s1">pred2 </span><span class="s3">= </span><span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">cross_validation</span><span class="s3">(</span>
        <span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s5">5</span><span class="s3">, </span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_seed</span><span class="s3">=</span><span class="s5">0</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">pred2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_precomputed</span><span class="s3">():</span>
    <span class="s4"># SVC with a precomputed kernel.</span>
    <span class="s4"># We test it with a toy dataset and with iris.</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">)</span>
    <span class="s4"># Gram matrix for train data (square matrix)</span>
    <span class="s4"># (we use just a linear kernel)</span>
    <span class="s1">K </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">K</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s4"># Gram matrix for test data (rectangular matrix)</span>
    <span class="s1">KT </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">T</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">KT</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">KT</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, [[-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># Gram matrix for test data but compute KT[i,j]</span>
    <span class="s4"># for support vectors j only.</span>
    <span class="s1">KT </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">KT</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)):</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">:</span>
            <span class="s1">KT</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">T</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">X</span><span class="s3">[</span><span class="s1">j</span><span class="s3">])</span>

    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">KT</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># same as before, but using a callable function instead of the kernel</span>
    <span class="s4"># matrix. kernel is just a linear kernel</span>

    <span class="s2">def </span><span class="s1">kfunc</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s1">kfunc</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, [[-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># test a precomputed kernel with the iris dataset</span>
    <span class="s4"># and check parameters against a linear SVC</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">)</span>
    <span class="s1">clf2 </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">K </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">K</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">clf2</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">K</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">clf2</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">), </span><span class="s5">0.99</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s4"># Gram matrix for test data but compute KT[i,j]</span>
    <span class="s4"># for support vectors j only.</span>
    <span class="s1">K </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros_like</span><span class="s3">(</span><span class="s1">K</span><span class="s3">)</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)):</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_</span><span class="s3">:</span>
            <span class="s1">K</span><span class="s3">[</span><span class="s1">i</span><span class="s3">, </span><span class="s1">j</span><span class="s3">] = </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">i</span><span class="s3">], </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[</span><span class="s1">j</span><span class="s3">])</span>

    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">K</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">), </span><span class="s5">0.99</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s1">kfunc</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">), </span><span class="s5">0.99</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_svr</span><span class="s3">():</span>
    <span class="s4"># Test Support Vector Regression</span>

    <span class="s1">diabetes </span><span class="s3">= </span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">load_diabetes</span><span class="s3">()</span>
    <span class="s2">for </span><span class="s1">clf </span><span class="s2">in </span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">nu</span><span class="s3">=</span><span class="s5">0.4</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">1.0</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">nu</span><span class="s3">=</span><span class="s5">0.4</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">10.0</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">10.0</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">10.0</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">10.0</span><span class="s3">),</span>
    <span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">) &gt; </span><span class="s5">0.02</span>

    <span class="s4"># non-regression test; previously, BaseLibSVM would check that</span>
    <span class="s4"># len(np.unique(y)) &lt; 2, which must only be done for SVC</span>
    <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)))</span>
    <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)))</span>


<span class="s2">def </span><span class="s1">test_linearsvr</span><span class="s3">():</span>
    <span class="s4"># check that SVR(kernel='linear') and LinearSVC() give</span>
    <span class="s4"># comparable results</span>
    <span class="s1">diabetes </span><span class="s3">= </span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">load_diabetes</span><span class="s3">()</span>
    <span class="s1">lsvr </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">score1 </span><span class="s3">= </span><span class="s1">lsvr</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">svr </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e3</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">score2 </span><span class="s3">= </span><span class="s1">svr</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">lsvr</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">svr</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">), </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.0001</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score1</span><span class="s3">, </span><span class="s1">score2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_linearsvr_fit_sampleweight</span><span class="s3">():</span>
    <span class="s4"># check correct result when sample_weight is 1</span>
    <span class="s4"># check that SVR(kernel='linear') and LinearSVC() give</span>
    <span class="s4"># comparable results</span>
    <span class="s1">diabetes </span><span class="s3">= </span><span class="s1">datasets</span><span class="s3">.</span><span class="s1">load_diabetes</span><span class="s3">()</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">unit_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">lsvr </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e3</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">unit_weight</span>
    <span class="s3">)</span>
    <span class="s1">score1 </span><span class="s3">= </span><span class="s1">lsvr</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">lsvr_no_weight </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e3</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s3">)</span>
    <span class="s1">score2 </span><span class="s3">= </span><span class="s1">lsvr_no_weight</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">lsvr</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">lsvr_no_weight</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">), </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.0001</span>
    <span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score1</span><span class="s3">, </span><span class="s1">score2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s4"># check that fit(X)  = fit([X1, X2, X3], sample_weight = [n1, n2, n3]) where</span>
    <span class="s4"># X = X1 repeated n1 times, X2 repeated n2 times and so forth</span>
    <span class="s1">random_state </span><span class="s3">= </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">random_weight </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">lsvr_unflat </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e3</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">random_weight</span>
    <span class="s3">)</span>
    <span class="s1">score3 </span><span class="s3">= </span><span class="s1">lsvr_unflat</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span>
        <span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">random_weight</span>
    <span class="s3">)</span>

    <span class="s1">X_flat </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">random_weight</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">y_flat </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s1">diabetes</span><span class="s3">.</span><span class="s1">target</span><span class="s3">, </span><span class="s1">random_weight</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">lsvr_flat </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e3</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">10000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_flat</span><span class="s3">, </span><span class="s1">y_flat</span><span class="s3">)</span>
    <span class="s1">score4 </span><span class="s3">= </span><span class="s1">lsvr_flat</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X_flat</span><span class="s3">, </span><span class="s1">y_flat</span><span class="s3">)</span>

    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">score3</span><span class="s3">, </span><span class="s1">score4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_svr_errors</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">0.0</span><span class="s3">], [</span><span class="s5">1.0</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">]</span>

    <span class="s4"># Bad kernel</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1.0</span><span class="s3">]]))</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_oneclass</span><span class="s3">():</span>
    <span class="s4"># Test OneClassSVM</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">()</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, [</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">pred</span><span class="s3">.</span><span class="s1">dtype </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s6">&quot;intp&quot;</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, [-</span><span class="s5">1.218</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, [[</span><span class="s5">0.750</span><span class="s3">, </span><span class="s5">0.750</span><span class="s3">, </span><span class="s5">0.750</span><span class="s3">, </span><span class="s5">0.750</span><span class="s3">]], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">):</span>
        <span class="s3">(</span><span class="s2">lambda</span><span class="s3">: </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">)()</span>


<span class="s2">def </span><span class="s1">test_oneclass_decision_function</span><span class="s3">():</span>
    <span class="s4"># Test OneClassSVM decision function</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">()</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s4"># Generate train data</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s5">0.3 </span><span class="s3">* </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">100</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">X_train </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">X </span><span class="s3">+ </span><span class="s5">2</span><span class="s3">, </span><span class="s1">X </span><span class="s3">- </span><span class="s5">2</span><span class="s3">]</span>

    <span class="s4"># Generate some regular novel observations</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s5">0.3 </span><span class="s3">* </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">X_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span><span class="s1">X </span><span class="s3">+ </span><span class="s5">2</span><span class="s3">, </span><span class="s1">X </span><span class="s3">- </span><span class="s5">2</span><span class="s3">]</span>
    <span class="s4"># Generate some abnormal novel observations</span>
    <span class="s1">X_outliers </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">low</span><span class="s3">=-</span><span class="s5">4</span><span class="s3">, </span><span class="s1">high</span><span class="s3">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>

    <span class="s4"># fit the model</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">(</span><span class="s1">nu</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;rbf&quot;</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">)</span>

    <span class="s4"># predict things</span>
    <span class="s1">y_pred_test </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">y_pred_test </span><span class="s3">== </span><span class="s5">1</span><span class="s3">) &gt; </span><span class="s5">0.9</span>
    <span class="s1">y_pred_outliers </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_outliers</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">y_pred_outliers </span><span class="s3">== -</span><span class="s5">1</span><span class="s3">) &gt; </span><span class="s5">0.9</span>
    <span class="s1">dec_func_test </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">((</span><span class="s1">dec_func_test </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">y_pred_test </span><span class="s3">== </span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">dec_func_outliers </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X_outliers</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">((</span><span class="s1">dec_func_outliers </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">y_pred_outliers </span><span class="s3">== </span><span class="s5">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_oneclass_score_samples</span><span class="s3">():</span>
    <span class="s1">X_train </span><span class="s3">= [[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">(</span><span class="s1">gamma</span><span class="s3">=</span><span class="s5">1</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">score_samples</span><span class="s3">([[</span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]]),</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">([[</span><span class="s5">2.0</span><span class="s3">, </span><span class="s5">2.0</span><span class="s3">]]) + </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">offset_</span><span class="s3">,</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_tweak_params</span><span class="s3">():</span>
    <span class="s4"># Make sure some tweaking of parameters works.</span>
    <span class="s4"># We change clf.dual_coef_ at run time and expect .predict() to change</span>
    <span class="s4"># accordingly. Notice that this is not trivial since it involves a lot</span>
    <span class="s4"># of C/Python copying in the libsvm bindings.</span>
    <span class="s4"># The success of this test ensures that the mapping between libsvm and</span>
    <span class="s4"># the python classifier is complete.</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">1.0</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, [[-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.25</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[-</span><span class="s5">0.1</span><span class="s3">, -</span><span class="s5">0.1</span><span class="s3">]]), [</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">_dual_coef_ </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[-</span><span class="s5">0.1</span><span class="s3">, -</span><span class="s5">0.1</span><span class="s3">]]), [</span><span class="s5">2</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_probability</span><span class="s3">():</span>
    <span class="s4"># Predict probabilities using SVC</span>
    <span class="s4"># This uses cross validation, so we use a slightly bigger testing set.</span>

    <span class="s2">for </span><span class="s1">clf </span><span class="s2">in </span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">1.0</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
    <span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

        <span class="s1">prob_predict </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">prob_predict</span><span class="s3">, </span><span class="s5">1</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]))</span>
        <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">prob_predict</span><span class="s3">, </span><span class="s5">1</span><span class="s3">) == </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)) &gt; </span><span class="s5">0.9</span>

        <span class="s1">assert_almost_equal</span><span class="s3">(</span>
            <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">exp</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict_log_proba</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)), </span><span class="s5">8</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_decision_function</span><span class="s3">():</span>
    <span class="s4"># Test decision_function</span>
    <span class="s4"># Sanity check, test that decision_function implemented in python</span>
    <span class="s4"># returns the same as the one in libsvm</span>
    <span class="s4"># multi class:</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovo&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s3">)</span>

    <span class="s1">dec </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">) + </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s4"># binary:</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">) + </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">prediction </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">prediction</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">classes_</span><span class="s3">[(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) &gt; </span><span class="s5">0</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">)]</span>
    <span class="s3">)</span>
    <span class="s1">expected </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([-</span><span class="s5">1.0</span><span class="s3">, -</span><span class="s5">0.66</span><span class="s3">, -</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.66</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">])</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">expected</span><span class="s3">, </span><span class="s5">2</span><span class="s3">)</span>

    <span class="s4"># kernel binary:</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;rbf&quot;</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovo&quot;</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>

    <span class="s1">rbfs </span><span class="s3">= </span><span class="s1">rbf_kernel</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">support_vectors_</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">=</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">)</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">rbfs</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">) + </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;SVM&quot;</span><span class="s3">, (</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_decision_function_shape</span><span class="s3">(</span><span class="s1">SVM</span><span class="s3">):</span>
    <span class="s4"># check that decision_function_shape='ovr' or 'ovo' gives</span>
    <span class="s4"># correct shape and is consistent with predict</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVM</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>
    <span class="s3">)</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dec</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">), </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">))</span>

    <span class="s4"># with five classes:</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s5">80</span><span class="s3">, </span><span class="s1">centers</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">X_train</span><span class="s3">, </span><span class="s1">X_test</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">, </span><span class="s1">y_test </span><span class="s3">= </span><span class="s1">train_test_split</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVM</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">)</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dec</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">), </span><span class="s5">5</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">))</span>

    <span class="s4"># check shape of ovo_decition_function=True</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">SVM</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovo&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">)</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dec</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">), </span><span class="s5">10</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_svr_predict</span><span class="s3">():</span>
    <span class="s4"># Test SVR's decision_function</span>
    <span class="s4"># Sanity check, test that predict implemented in python</span>
    <span class="s4"># returns the same as the one in libsvm</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span>

    <span class="s4"># linear kernel</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">C</span><span class="s3">=</span><span class="s5">0.1</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">dec </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">) + </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">())</span>

    <span class="s4"># rbf kernel</span>
    <span class="s1">reg </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;rbf&quot;</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">=</span><span class="s5">1</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">rbfs </span><span class="s3">= </span><span class="s1">rbf_kernel</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">support_vectors_</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">=</span><span class="s1">reg</span><span class="s3">.</span><span class="s1">gamma</span><span class="s3">)</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">rbfs</span><span class="s3">, </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">) + </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">reg</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_weight</span><span class="s3">():</span>
    <span class="s4"># Test class weights</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">class_weight</span><span class="s3">={</span><span class="s5">1</span><span class="s3">: </span><span class="s5">0.1</span><span class="s3">})</span>
    <span class="s4"># we give a small weights to class 1</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s4"># so all predicted values belong to class 2</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), [</span><span class="s5">2</span><span class="s3">] * </span><span class="s5">6</span><span class="s3">)</span>

    <span class="s1">X_</span><span class="s3">, </span><span class="s1">y_ </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s5">200</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s5">10</span><span class="s3">, </span><span class="s1">weights</span><span class="s3">=[</span><span class="s5">0.833</span><span class="s3">, </span><span class="s5">0.167</span><span class="s3">], </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">2</span>
    <span class="s3">)</span>

    <span class="s2">for </span><span class="s1">clf </span><span class="s2">in </span><span class="s3">(</span>
        <span class="s1">linear_model</span><span class="s3">.</span><span class="s1">LogisticRegression</span><span class="s3">(),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(),</span>
    <span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">class_weight</span><span class="s3">={</span><span class="s5">0</span><span class="s3">: </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">: </span><span class="s5">10</span><span class="s3">})</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_</span><span class="s3">[:</span><span class="s5">100</span><span class="s3">], </span><span class="s1">y_</span><span class="s3">[:</span><span class="s5">100</span><span class="s3">])</span>
        <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_</span><span class="s3">[</span><span class="s5">100</span><span class="s3">:])</span>
        <span class="s2">assert </span><span class="s1">f1_score</span><span class="s3">(</span><span class="s1">y_</span><span class="s3">[</span><span class="s5">100</span><span class="s3">:], </span><span class="s1">y_pred</span><span class="s3">) &gt; </span><span class="s5">0.3</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;estimator&quot;</span><span class="s3">, [</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">), </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">()])</span>
<span class="s2">def </span><span class="s1">test_svm_classifier_sided_sample_weight</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">):</span>
    <span class="s4"># fit a linear SVM and check that giving more weight to opposed samples</span>
    <span class="s4"># in the space will flip the decision toward these samples.</span>
    <span class="s1">X </span><span class="s3">= [[-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>

    <span class="s4"># check that with unit weights, a sample is supposed to be predicted on</span>
    <span class="s4"># the boundary</span>
    <span class="s1">sample_weight </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">] * </span><span class="s5">6</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">([[-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">y_pred </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s4"># give more weights to opposed samples</span>
    <span class="s1">sample_weight </span><span class="s3">= [</span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">([[-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">y_pred </span><span class="s3">&lt; </span><span class="s5">0</span>

    <span class="s1">sample_weight </span><span class="s3">= [</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">]</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">([[-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">y_pred </span><span class="s3">&gt; </span><span class="s5">0</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;estimator&quot;</span><span class="s3">, [</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">), </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e-2</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_svm_regressor_sided_sample_weight</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">):</span>
    <span class="s4"># similar test to test_svm_classifier_sided_sample_weight but for</span>
    <span class="s4"># SVM regressors</span>
    <span class="s1">X </span><span class="s3">= [[-</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, -</span><span class="s5">2</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">]]</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>

    <span class="s4"># check that with unit weights, a sample is supposed to be predicted on</span>
    <span class="s4"># the boundary</span>
    <span class="s1">sample_weight </span><span class="s3">= [</span><span class="s5">1</span><span class="s3">] * </span><span class="s5">6</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">y_pred </span><span class="s3">== </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s5">1.5</span><span class="s3">)</span>

    <span class="s4"># give more weights to opposed samples</span>
    <span class="s1">sample_weight </span><span class="s3">= [</span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">y_pred </span><span class="s3">&lt; </span><span class="s5">1.5</span>

    <span class="s1">sample_weight </span><span class="s3">= [</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">10.0</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">]</span>
    <span class="s1">estimator</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">([[-</span><span class="s5">1.0</span><span class="s3">, </span><span class="s5">1.0</span><span class="s3">]])</span>
    <span class="s2">assert </span><span class="s1">y_pred </span><span class="s3">&gt; </span><span class="s5">1.5</span>


<span class="s2">def </span><span class="s1">test_svm_equivalence_sample_weight_C</span><span class="s3">():</span>
    <span class="s4"># test that rescaling all samples is the same as changing C</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">dual_coef_no_weight </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s5">0.01</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">dual_coef_no_weight</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;Estimator, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s6">&quot;Invalid input - all samples have zero or negative weights.&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">, </span><span class="s6">&quot;(negative dimensions are not allowed|nu is infeasible)&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">, </span><span class="s6">&quot;Invalid input - all samples have zero or negative weights.&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">, </span><span class="s6">&quot;Invalid input - all samples have zero or negative weights.&quot;</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">, </span><span class="s6">&quot;Invalid input - all samples have zero or negative weights.&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;SVC&quot;</span><span class="s3">, </span><span class="s6">&quot;NuSVC&quot;</span><span class="s3">, </span><span class="s6">&quot;SVR&quot;</span><span class="s3">, </span><span class="s6">&quot;NuSVR&quot;</span><span class="s3">, </span><span class="s6">&quot;OneClassSVM&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;sample_weight&quot;</span><span class="s3">,</span>
    <span class="s3">[[</span><span class="s5">0</span><span class="s3">] * </span><span class="s1">len</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">), [-</span><span class="s5">0.3</span><span class="s3">] * </span><span class="s1">len</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;weights-are-zero&quot;</span><span class="s3">, </span><span class="s6">&quot;weights-are-negative&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_negative_sample_weights_mask_all_samples</span><span class="s3">(</span><span class="s1">Estimator</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">):</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;Classifier, err_msg&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span>
            <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">,</span>
            <span class="s3">(</span>
                <span class="s6">&quot;Invalid input - all samples with positive weights belong to the same&quot;</span>
                <span class="s6">&quot; class&quot;</span>
            <span class="s3">),</span>
        <span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">, </span><span class="s6">&quot;specified nu is infeasible&quot;</span><span class="s3">),</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;SVC&quot;</span><span class="s3">, </span><span class="s6">&quot;NuSVC&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;sample_weight&quot;</span><span class="s3">,</span>
    <span class="s3">[[</span><span class="s5">0</span><span class="s3">, -</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, -</span><span class="s5">0.1</span><span class="s3">, -</span><span class="s5">0.3</span><span class="s3">]],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;mask-label-1&quot;</span><span class="s3">, </span><span class="s6">&quot;mask-label-2&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_negative_weights_svc_leave_just_one_label</span><span class="s3">(</span><span class="s1">Classifier</span><span class="s3">, </span><span class="s1">err_msg</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">):</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Classifier</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">err_msg</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;Classifier, model&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, {</span><span class="s6">&quot;when-left&quot;</span><span class="s3">: [</span><span class="s5">0.3998</span><span class="s3">, </span><span class="s5">0.4</span><span class="s3">], </span><span class="s6">&quot;when-right&quot;</span><span class="s3">: [</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.3999</span><span class="s3">]}),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">, {</span><span class="s6">&quot;when-left&quot;</span><span class="s3">: [</span><span class="s5">0.3333</span><span class="s3">, </span><span class="s5">0.3333</span><span class="s3">], </span><span class="s6">&quot;when-right&quot;</span><span class="s3">: [</span><span class="s5">0.3333</span><span class="s3">, </span><span class="s5">0.3333</span><span class="s3">]}),</span>
    <span class="s3">],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;SVC&quot;</span><span class="s3">, </span><span class="s6">&quot;NuSVC&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;sample_weight, mask_side&quot;</span><span class="s3">,</span>
    <span class="s3">[([</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s6">&quot;when-left&quot;</span><span class="s3">), ([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], </span><span class="s6">&quot;when-right&quot;</span><span class="s3">)],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;partial-mask-label-1&quot;</span><span class="s3">, </span><span class="s6">&quot;partial-mask-label-2&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_negative_weights_svc_leave_two_labels</span><span class="s3">(</span>
    <span class="s1">Classifier</span><span class="s3">, </span><span class="s1">model</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">mask_side</span>
<span class="s3">):</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">Classifier</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, [</span><span class="s1">model</span><span class="s3">[</span><span class="s1">mask_side</span><span class="s3">]], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;Estimator&quot;</span><span class="s3">, [</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">], </span><span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;SVC&quot;</span><span class="s3">, </span><span class="s6">&quot;NuSVC&quot;</span><span class="s3">, </span><span class="s6">&quot;NuSVR&quot;</span><span class="s3">]</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;sample_weight&quot;</span><span class="s3">,</span>
    <span class="s3">[[</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]],</span>
    <span class="s1">ids</span><span class="s3">=[</span><span class="s6">&quot;partial-mask-label-1&quot;</span><span class="s3">, </span><span class="s6">&quot;partial-mask-label-2&quot;</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_negative_weight_equal_coeffs</span><span class="s3">(</span><span class="s1">Estimator</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">):</span>
    <span class="s4"># model generates equal coefficients</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span><span class="s3">)</span>
    <span class="s1">coef </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">est</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">).</span><span class="s1">ravel</span><span class="s3">()</span>
    <span class="s2">assert </span><span class="s1">coef</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">approx</span><span class="s3">(</span><span class="s1">coef</span><span class="s3">[</span><span class="s5">1</span><span class="s3">], </span><span class="s1">rel</span><span class="s3">=</span><span class="s5">1e-3</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">ignore_warnings</span><span class="s3">(</span><span class="s1">category</span><span class="s3">=</span><span class="s1">UndefinedMetricWarning</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_auto_weight</span><span class="s3">():</span>
    <span class="s4"># Test class weights for imbalanced data</span>
    <span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">linear_model </span><span class="s2">import </span><span class="s1">LogisticRegression</span>

    <span class="s4"># We take as dataset the two-dimensional projection of iris so</span>
    <span class="s4"># that it is not separable and remove half of predictors from</span>
    <span class="s4"># class 1.</span>
    <span class="s4"># We add one to the targets as a non-regression test:</span>
    <span class="s4"># class_weight=&quot;balanced&quot;</span>
    <span class="s4"># used to work only when the labels where a range [0..K).</span>
    <span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">compute_class_weight</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">[:, :</span><span class="s5">2</span><span class="s3">], </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target </span><span class="s3">+ </span><span class="s5">1</span>
    <span class="s1">unbalanced </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">delete</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">y</span><span class="s3">.</span><span class="s1">size</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">where</span><span class="s3">(</span><span class="s1">y </span><span class="s3">&gt; </span><span class="s5">2</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">][::</span><span class="s5">2</span><span class="s3">])</span>

    <span class="s1">classes </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">[</span><span class="s1">unbalanced</span><span class="s3">])</span>
    <span class="s1">class_weights </span><span class="s3">= </span><span class="s1">compute_class_weight</span><span class="s3">(</span><span class="s6">&quot;balanced&quot;</span><span class="s3">, </span><span class="s1">classes</span><span class="s3">=</span><span class="s1">classes</span><span class="s3">, </span><span class="s1">y</span><span class="s3">=</span><span class="s1">y</span><span class="s3">[</span><span class="s1">unbalanced</span><span class="s3">])</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">class_weights</span><span class="s3">) == </span><span class="s5">2</span>

    <span class="s2">for </span><span class="s1">clf </span><span class="s2">in </span><span class="s3">(</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
        <span class="s1">LogisticRegression</span><span class="s3">(),</span>
    <span class="s3">):</span>
        <span class="s4"># check that score is better when class='balanced' is set.</span>
        <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[</span><span class="s1">unbalanced</span><span class="s3">], </span><span class="s1">y</span><span class="s3">[</span><span class="s1">unbalanced</span><span class="s3">]).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">class_weight</span><span class="s3">=</span><span class="s6">&quot;balanced&quot;</span><span class="s3">)</span>
        <span class="s1">y_pred_balanced </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span>
            <span class="s1">X</span><span class="s3">[</span><span class="s1">unbalanced</span><span class="s3">],</span>
            <span class="s1">y</span><span class="s3">[</span><span class="s1">unbalanced</span><span class="s3">],</span>
        <span class="s3">).</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">f1_score</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred</span><span class="s3">, </span><span class="s1">average</span><span class="s3">=</span><span class="s6">&quot;macro&quot;</span><span class="s3">) &lt;= </span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">f1_score</span><span class="s3">(</span>
            <span class="s1">y</span><span class="s3">, </span><span class="s1">y_pred_balanced</span><span class="s3">, </span><span class="s1">average</span><span class="s3">=</span><span class="s6">&quot;macro&quot;</span>
        <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;lil_container&quot;</span><span class="s3">, </span><span class="s1">LIL_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_bad_input</span><span class="s3">(</span><span class="s1">lil_container</span><span class="s3">):</span>
    <span class="s4"># Test dimensions for labels</span>
    <span class="s1">Y2 </span><span class="s3">= </span><span class="s1">Y</span><span class="s3">[:-</span><span class="s5">1</span><span class="s3">]  </span><span class="s4"># wrong dimensions for labels</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y2</span><span class="s3">)</span>

    <span class="s4"># Test with arrays that are non-contiguous.</span>
    <span class="s2">for </span><span class="s1">clf </span><span class="s2">in </span><span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(), </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)):</span>
        <span class="s1">Xf </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asfortranarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert not </span><span class="s1">Xf</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s1">yf </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ascontiguousarray</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">tile</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">, (</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)).</span><span class="s1">T</span><span class="s3">)</span>
        <span class="s1">yf </span><span class="s3">= </span><span class="s1">yf</span><span class="s3">[:, -</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">assert not </span><span class="s1">yf</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;F_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s2">assert not </span><span class="s1">yf</span><span class="s3">.</span><span class="s1">flags</span><span class="s3">[</span><span class="s6">&quot;C_CONTIGUOUS&quot;</span><span class="s3">]</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">Xf</span><span class="s3">, </span><span class="s1">yf</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># error for precomputed kernelsx</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>

    <span class="s4"># predict with sparse input when trained with dense</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">lil_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>

    <span class="s1">Xt </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Xt</span><span class="s3">), </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">Xt</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_svc_nonfinite_params</span><span class="s3">():</span>
    <span class="s4"># Check SVC throws ValueError when dealing with non-finite parameter values</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s5">10</span>
    <span class="s1">fmax </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">max</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">fmax </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">uniform</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n_samples</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=</span><span class="s1">n_samples</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;The dual coefficients or intercepts are not finite&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_unicode_kernel</span><span class="s3">():</span>
    <span class="s4"># Test that a unicode kernel name does not cause a TypeError</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">_libsvm</span><span class="s3">.</span><span class="s1">cross_validation</span><span class="s3">(</span>
        <span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">), </span><span class="s5">5</span><span class="s3">, </span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">random_seed</span><span class="s3">=</span><span class="s5">0</span>
    <span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sparse_precomputed</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">)</span>
    <span class="s1">sparse_gram </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">TypeError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Sparse precomputed&quot;</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">sparse_gram</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_sparse_fit_support_vectors_empty</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s4"># Regression test for #14893</span>
    <span class="s1">X_train </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s1">y_train </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">0.04</span><span class="s3">, </span><span class="s5">0.04</span><span class="s3">, </span><span class="s5">0.10</span><span class="s3">, </span><span class="s5">0.16</span><span class="s3">])</span>
    <span class="s1">model </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">)</span>
    <span class="s1">model</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">model</span><span class="s3">.</span><span class="s1">support_vectors_</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">size</span>
    <span class="s2">assert not </span><span class="s1">model</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">.</span><span class="s1">data</span><span class="s3">.</span><span class="s1">size</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;loss&quot;</span><span class="s3">, [</span><span class="s6">&quot;hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;penalty&quot;</span><span class="s3">, [</span><span class="s6">&quot;l1&quot;</span><span class="s3">, </span><span class="s6">&quot;l2&quot;</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;dual&quot;</span><span class="s3">, [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_linearsvc_parameters</span><span class="s3">(</span><span class="s1">loss</span><span class="s3">, </span><span class="s1">penalty</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">):</span>
    <span class="s4"># Test possible parameter combinations in LinearSVC</span>
    <span class="s4"># Generate list of possible parameter combinations</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">penalty</span><span class="s3">=</span><span class="s1">penalty</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">=</span><span class="s1">loss</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">=</span><span class="s1">dual</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">loss</span><span class="s3">, </span><span class="s1">penalty</span><span class="s3">) == (</span><span class="s6">&quot;hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;l1&quot;</span><span class="s3">)</span>
        <span class="s2">or </span><span class="s3">(</span><span class="s1">loss</span><span class="s3">, </span><span class="s1">penalty</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">) == (</span><span class="s6">&quot;hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s2">False</span><span class="s3">)</span>
        <span class="s2">or </span><span class="s3">(</span><span class="s1">penalty</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">) == (</span><span class="s6">&quot;l1&quot;</span><span class="s3">, </span><span class="s2">True</span><span class="s3">)</span>
    <span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span>
            <span class="s1">ValueError</span><span class="s3">,</span>
            <span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Unsupported set of arguments.*penalty='%s.*loss='%s.*dual=%s&quot;</span>
            <span class="s3">% (</span><span class="s1">penalty</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">),</span>
        <span class="s3">):</span>
            <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_linearsvc</span><span class="s3">():</span>
    <span class="s4"># Test basic routines using LinearSVC</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>

    <span class="s4"># by default should have intercept</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit_intercept</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), </span><span class="s1">true_result</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, [</span><span class="s5">0</span><span class="s3">], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">3</span><span class="s3">)</span>

    <span class="s4"># the same with l1 penalty</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span>
        <span class="s1">penalty</span><span class="s3">=</span><span class="s6">&quot;l1&quot;</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">=</span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># l2 penalty with dual formulation</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">penalty</span><span class="s3">=</span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># l2 penalty, l1 loss</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">penalty</span><span class="s3">=</span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">=</span><span class="s6">&quot;hinge&quot;</span><span class="s3">, </span><span class="s1">dual</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), </span><span class="s1">true_result</span><span class="s3">)</span>

    <span class="s4"># test also decision function</span>
    <span class="s1">dec </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s1">res </span><span class="s3">= (</span><span class="s1">dec </span><span class="s3">&gt; </span><span class="s5">0</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">int</span><span class="s3">) + </span><span class="s5">1</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">res</span><span class="s3">, </span><span class="s1">true_result</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_linearsvc_crammer_singer</span><span class="s3">():</span>
    <span class="s4"># Test LinearSVC with crammer_singer multi-class svm</span>
    <span class="s1">ovr_clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">cs_clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">multi_class</span><span class="s3">=</span><span class="s6">&quot;crammer_singer&quot;</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s4"># similar prediction for ovr and crammer-singer:</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s1">ovr_clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">) == </span><span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)).</span><span class="s1">mean</span><span class="s3">() &gt; </span><span class="s5">0.9</span>

    <span class="s4"># classifiers shouldn't be the same</span>
    <span class="s2">assert </span><span class="s3">(</span><span class="s1">ovr_clf</span><span class="s3">.</span><span class="s1">coef_ </span><span class="s3">!= </span><span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">).</span><span class="s1">all</span><span class="s3">()</span>

    <span class="s4"># test decision function</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span>
        <span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">), </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s1">dec_func </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">T</span><span class="s3">) + </span><span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">dec_func</span><span class="s3">, </span><span class="s1">cs_clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_linearsvc_fit_sampleweight</span><span class="s3">():</span>
    <span class="s4"># check correct result when sample_weight is 1</span>
    <span class="s1">n_samples </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">unit_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">clf_unitweight </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">unit_weight</span>
    <span class="s3">)</span>

    <span class="s4"># check if same as sample_weight=None</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clf_unitweight</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">), </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">clf_unitweight</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.0001</span><span class="s3">)</span>

    <span class="s4"># check that fit(X)  = fit([X1, X2, X3],sample_weight = [n1, n2, n3]) where</span>
    <span class="s4"># X = X1 repeated n1 times, X2 repeated n2 times and so forth</span>

    <span class="s1">random_state </span><span class="s3">= </span><span class="s1">check_random_state</span><span class="s3">(</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">random_weight </span><span class="s3">= </span><span class="s1">random_state</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">)</span>
    <span class="s1">lsvc_unflat </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">random_weight</span>
    <span class="s3">)</span>

    <span class="s1">pred1 </span><span class="s3">= </span><span class="s1">lsvc_unflat</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">X_flat </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">random_weight</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">y_flat </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">repeat</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">, </span><span class="s1">random_weight</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">lsvc_flat </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X_flat</span><span class="s3">, </span><span class="s1">y_flat</span>
    <span class="s3">)</span>
    <span class="s1">pred2 </span><span class="s3">= </span><span class="s1">lsvc_flat</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">T</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred1</span><span class="s3">, </span><span class="s1">pred2</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lsvc_unflat</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s1">lsvc_flat</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">0.0001</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_crammer_singer_binary</span><span class="s3">():</span>
    <span class="s4"># Test Crammer-Singer formulation in the binary case</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">fit_intercept </span><span class="s2">in </span><span class="s3">(</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">):</span>
        <span class="s1">acc </span><span class="s3">= (</span>
            <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span>
                <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s1">fit_intercept</span><span class="s3">,</span>
                <span class="s1">multi_class</span><span class="s3">=</span><span class="s6">&quot;crammer_singer&quot;</span><span class="s3">,</span>
                <span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
            <span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">acc </span><span class="s3">&gt; </span><span class="s5">0.9</span>


<span class="s2">def </span><span class="s1">test_linearsvc_iris</span><span class="s3">():</span>
    <span class="s4"># Test that LinearSVC gives plausible predictions on the iris dataset</span>
    <span class="s4"># Also, test symbolic class names (classes_).</span>
    <span class="s1">target </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target_names</span><span class="s3">[</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">target</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">classes_</span><span class="s3">) == </span><span class="s1">set</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target_names</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">mean</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">) == </span><span class="s1">target</span><span class="s3">) &gt; </span><span class="s5">0.8</span>

    <span class="s1">dec </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target_names</span><span class="s3">[</span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">dec</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)]</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">pred</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_dense_liblinear_intercept_handling</span><span class="s3">(</span><span class="s1">classifier</span><span class="s3">=</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">):</span>
    <span class="s4"># Test that dense liblinear honours intercept_scaling param</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">classifier</span><span class="s3">(</span>
        <span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">penalty</span><span class="s3">=</span><span class="s6">&quot;l1&quot;</span><span class="s3">,</span>
        <span class="s1">loss</span><span class="s3">=</span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">,</span>
        <span class="s1">dual</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s1">C</span><span class="s3">=</span><span class="s5">4</span><span class="s3">,</span>
        <span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-7</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_scaling </span><span class="s3">== </span><span class="s5">1</span><span class="s3">, </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_scaling</span>
    <span class="s2">assert </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">fit_intercept</span>

    <span class="s4"># when intercept_scaling is low the intercept value is highly &quot;penalized&quot;</span>
    <span class="s4"># by regularization</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_scaling </span><span class="s3">= </span><span class="s5">1</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">5</span><span class="s3">)</span>

    <span class="s4"># when intercept_scaling is sufficiently high, the intercept value</span>
    <span class="s4"># is not affected by regularization</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_scaling </span><span class="s3">= </span><span class="s5">100</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">intercept1 </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s2">assert </span><span class="s1">intercept1 </span><span class="s3">&lt; -</span><span class="s5">1</span>

    <span class="s4"># when intercept_scaling is sufficiently high, the intercept value</span>
    <span class="s4"># doesn't depend on intercept_scaling value</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_scaling </span><span class="s3">= </span><span class="s5">1000</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">intercept2 </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">intercept1</span><span class="s3">, </span><span class="s1">intercept2</span><span class="s3">, </span><span class="s1">decimal</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_liblinear_set_coef</span><span class="s3">():</span>
    <span class="s4"># multi-class case</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s1">values </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_ </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_ </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">values2 </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">values</span><span class="s3">, </span><span class="s1">values2</span><span class="s3">)</span>

    <span class="s4"># binary-class case</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">3</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">], [</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]]</span>
    <span class="s1">y </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">().</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">values </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_ </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_ </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">values2 </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">values</span><span class="s3">, </span><span class="s1">values2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_immutable_coef_property</span><span class="s3">():</span>
    <span class="s4"># Check that primal coef modification are not silently ignored</span>
    <span class="s1">svms </span><span class="s3">= [</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">),</span>
    <span class="s3">]</span>
    <span class="s2">for </span><span class="s1">clf </span><span class="s2">in </span><span class="s1">svms</span><span class="s3">:</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">AttributeError</span><span class="s3">):</span>
            <span class="s1">clf</span><span class="s3">.</span><span class="s1">__setattr__</span><span class="s3">(</span><span class="s6">&quot;coef_&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s5">3</span><span class="s3">))</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">((</span><span class="s1">RuntimeError</span><span class="s3">, </span><span class="s1">ValueError</span><span class="s3">)):</span>
            <span class="s1">clf</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">__setitem__</span><span class="s3">((</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0</span><span class="s3">), </span><span class="s5">0</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_linearsvc_verbose</span><span class="s3">():</span>
    <span class="s4"># stdout: redirect</span>
    <span class="s2">import </span><span class="s1">os</span>

    <span class="s1">stdout </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">dup</span><span class="s3">(</span><span class="s5">1</span><span class="s3">)  </span><span class="s4"># save original stdout</span>
    <span class="s1">os</span><span class="s3">.</span><span class="s1">dup2</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">pipe</span><span class="s3">()[</span><span class="s5">1</span><span class="s3">], </span><span class="s5">1</span><span class="s3">)  </span><span class="s4"># replace it</span>

    <span class="s4"># actual call</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">verbose</span><span class="s3">=</span><span class="s5">1</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>

    <span class="s4"># stdout: restore</span>
    <span class="s1">os</span><span class="s3">.</span><span class="s1">dup2</span><span class="s3">(</span><span class="s1">stdout</span><span class="s3">, </span><span class="s5">1</span><span class="s3">)  </span><span class="s4"># restore original stdout</span>


<span class="s2">def </span><span class="s1">test_svc_clone_with_callable_kernel</span><span class="s3">():</span>
    <span class="s4"># create SVM with callable linear kernel, check that results are the same</span>
    <span class="s4"># as with built-in linear kernel</span>
    <span class="s1">svm_callable </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span>
        <span class="s1">kernel</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">T</span><span class="s3">),</span>
        <span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">,</span>
        <span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s4"># clone for checking clonability with lambda functions..</span>
    <span class="s1">svm_cloned </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">(</span><span class="s1">svm_callable</span><span class="s3">)</span>
    <span class="s1">svm_cloned</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">svm_builtin </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span>
        <span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span>
    <span class="s3">)</span>
    <span class="s1">svm_builtin</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">svm_cloned</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">, </span><span class="s1">svm_builtin</span><span class="s3">.</span><span class="s1">dual_coef_</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">svm_cloned</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">, </span><span class="s1">svm_builtin</span><span class="s3">.</span><span class="s1">intercept_</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">svm_cloned</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svm_builtin</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">))</span>

    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">svm_cloned</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">svm_builtin</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">decimal</span><span class="s3">=</span><span class="s5">4</span><span class="s3">,</span>
    <span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
        <span class="s1">svm_cloned</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">),</span>
        <span class="s1">svm_builtin</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">),</span>
    <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_svc_bad_kernel</span><span class="s3">():</span>
    <span class="s1">svc </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">x</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">):</span>
        <span class="s1">svc</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_libsvm_convergence_warnings</span><span class="s3">():</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span>
        <span class="s1">kernel</span><span class="s3">=</span><span class="s2">lambda </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">: </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">.</span><span class="s1">T</span><span class="s3">), </span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">2</span>
    <span class="s3">)</span>
    <span class="s1">warning_msg </span><span class="s3">= (</span>
        <span class="s6">r&quot;Solver terminated early \(max_iter=2\).  Consider pre-processing &quot;</span>
        <span class="s6">r&quot;your data with StandardScaler or MinMaxScaler.&quot;</span>
    <span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">ConvergenceWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_msg</span><span class="s3">):</span>
        <span class="s1">a</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">a</span><span class="s3">.</span><span class="s1">n_iter_ </span><span class="s3">== </span><span class="s5">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_unfitted</span><span class="s3">():</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s6">&quot;foo!&quot;  </span><span class="s4"># input validation not required when SVM not fitted</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;.*\bSVC\b.*\bnot\b.*\bfitted\b&quot;</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">()</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">r&quot;.*\bNuSVR\b.*\bnot\b.*\bfitted\b&quot;</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s4"># ignore convergence warnings from max_iter=1</span>
<span class="s3">@</span><span class="s1">ignore_warnings</span>
<span class="s2">def </span><span class="s1">test_consistent_proba</span><span class="s3">():</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">proba_1 </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">).</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">a </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
    <span class="s1">proba_2 </span><span class="s3">= </span><span class="s1">a</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">).</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s3">(</span><span class="s1">proba_1</span><span class="s3">, </span><span class="s1">proba_2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_linear_svm_convergence_warnings</span><span class="s3">():</span>
    <span class="s4"># Test that warnings are raised if model does not converge</span>

    <span class="s1">lsvc </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">warning_msg </span><span class="s3">= </span><span class="s6">&quot;Liblinear failed to converge, increase the number of iterations.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">ConvergenceWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_msg</span><span class="s3">):</span>
        <span class="s1">lsvc</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s4"># Check that we have an n_iter_ attribute with int type as opposed to a</span>
    <span class="s4"># numpy array or an np.int32 so as to match the docstring.</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">lsvc</span><span class="s3">.</span><span class="s1">n_iter_</span><span class="s3">, </span><span class="s1">int</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">lsvc</span><span class="s3">.</span><span class="s1">n_iter_ </span><span class="s3">== </span><span class="s5">2</span>

    <span class="s1">lsvr </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">ConvergenceWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">warning_msg</span><span class="s3">):</span>
        <span class="s1">lsvr</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">lsvr</span><span class="s3">.</span><span class="s1">n_iter_</span><span class="s3">, </span><span class="s1">int</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">lsvr</span><span class="s3">.</span><span class="s1">n_iter_ </span><span class="s3">== </span><span class="s5">2</span>


<span class="s2">def </span><span class="s1">test_svr_coef_sign</span><span class="s3">():</span>
    <span class="s4"># Test that SVR(kernel=&quot;linear&quot;) has coef_ with the right sign.</span>
    <span class="s4"># Non-regression test for #2933.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">21</span><span class="s3">).</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">3</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s5">12</span><span class="s3">).</span><span class="s1">randn</span><span class="s3">(</span><span class="s5">10</span><span class="s3">)</span>

    <span class="s2">for </span><span class="s1">svr </span><span class="s2">in </span><span class="s3">[</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">),</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVR</span><span class="s3">(),</span>
    <span class="s3">]:</span>
        <span class="s1">svr</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s3">(</span>
            <span class="s1">svr</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">svr</span><span class="s3">.</span><span class="s1">coef_</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()) + </span><span class="s1">svr</span><span class="s3">.</span><span class="s1">intercept_</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_lsvc_intercept_scaling_zero</span><span class="s3">():</span>
    <span class="s4"># Test that intercept_scaling is ignored when fit_intercept is False</span>

    <span class="s1">lsvc </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">LinearSVC</span><span class="s3">(</span><span class="s1">fit_intercept</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">lsvc</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">lsvc</span><span class="s3">.</span><span class="s1">intercept_ </span><span class="s3">== </span><span class="s5">0.0</span>


<span class="s2">def </span><span class="s1">test_hasattr_predict_proba</span><span class="s3">():</span>
    <span class="s4"># Method must be (un)available before or after fit, switched by</span>
    <span class="s4"># `probability` param</span>

    <span class="s1">G </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">G</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">)</span>
    <span class="s1">G</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">G</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">)</span>

    <span class="s1">G </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">probability</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">G</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">)</span>
    <span class="s1">G</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">, </span><span class="s1">iris</span><span class="s3">.</span><span class="s1">target</span><span class="s3">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">G</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">)</span>

    <span class="s4"># Switching to `probability=True` after fitting should make</span>
    <span class="s4"># predict_proba available, but calling it must not work:</span>
    <span class="s1">G</span><span class="s3">.</span><span class="s1">probability </span><span class="s3">= </span><span class="s2">True</span>
    <span class="s2">assert </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">G</span><span class="s3">, </span><span class="s6">&quot;predict_proba&quot;</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;predict_proba is not available when fitted with probability=False&quot;</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">NotFittedError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">G</span><span class="s3">.</span><span class="s1">predict_proba</span><span class="s3">(</span><span class="s1">iris</span><span class="s3">.</span><span class="s1">data</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_decision_function_shape_two_class</span><span class="s3">():</span>
    <span class="s2">for </span><span class="s1">n_classes </span><span class="s2">in </span><span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]:</span>
        <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span><span class="s1">centers</span><span class="s3">=</span><span class="s1">n_classes</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>
        <span class="s2">for </span><span class="s1">estimator </span><span class="s2">in </span><span class="s3">[</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">]:</span>
            <span class="s1">clf </span><span class="s3">= </span><span class="s1">OneVsRestClassifier</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">(</span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span><span class="s3">)).</span><span class="s1">fit</span><span class="s3">(</span>
                <span class="s1">X</span><span class="s3">, </span><span class="s1">y</span>
            <span class="s3">)</span>
            <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)) == </span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_ovr_decision_function</span><span class="s3">():</span>
    <span class="s4"># One point from each quadrant represents one class</span>
    <span class="s1">X_train </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s1">y_train </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s3">]</span>

    <span class="s4"># First point is closer to the decision boundaries than the second point</span>
    <span class="s1">base_points </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">5</span><span class="s3">, </span><span class="s5">5</span><span class="s3">], [</span><span class="s5">10</span><span class="s3">, </span><span class="s5">10</span><span class="s3">]])</span>

    <span class="s4"># For all the quadrants (classes)</span>
    <span class="s1">X_test </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">(</span>
        <span class="s3">(</span>
            <span class="s1">base_points </span><span class="s3">* [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],  </span><span class="s4"># Q1</span>
            <span class="s1">base_points </span><span class="s3">* [-</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],  </span><span class="s4"># Q2</span>
            <span class="s1">base_points </span><span class="s3">* [-</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">],  </span><span class="s4"># Q3</span>
            <span class="s1">base_points </span><span class="s3">* [</span><span class="s5">1</span><span class="s3">, -</span><span class="s5">1</span><span class="s3">],  </span><span class="s4"># Q4</span>
        <span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s1">y_test </span><span class="s3">= [</span><span class="s5">0</span><span class="s3">] * </span><span class="s5">2 </span><span class="s3">+ [</span><span class="s5">1</span><span class="s3">] * </span><span class="s5">2 </span><span class="s3">+ [</span><span class="s5">2</span><span class="s3">] * </span><span class="s5">2 </span><span class="s3">+ [</span><span class="s5">3</span><span class="s3">] * </span><span class="s5">2</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_train</span><span class="s3">, </span><span class="s1">y_train</span><span class="s3">)</span>

    <span class="s1">y_pred </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>

    <span class="s4"># Test if the prediction is the same as y</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">y_pred</span><span class="s3">, </span><span class="s1">y_test</span><span class="s3">)</span>

    <span class="s1">deci_val </span><span class="s3">= </span><span class="s1">clf</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X_test</span><span class="s3">)</span>

    <span class="s4"># Assert that the predicted class has the maximum value</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">deci_val</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">), </span><span class="s1">y_pred</span><span class="s3">)</span>

    <span class="s4"># Get decision value at test points for the predicted class</span>
    <span class="s1">pred_class_deci_val </span><span class="s3">= </span><span class="s1">deci_val</span><span class="s3">[</span><span class="s1">range</span><span class="s3">(</span><span class="s5">8</span><span class="s3">), </span><span class="s1">y_pred</span><span class="s3">].</span><span class="s1">reshape</span><span class="s3">((</span><span class="s5">4</span><span class="s3">, </span><span class="s5">2</span><span class="s3">))</span>

    <span class="s4"># Assert pred_class_deci_val &gt; 0 here</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">pred_class_deci_val</span><span class="s3">) &gt; </span><span class="s5">0.0</span>

    <span class="s4"># Test if the first point has lower decision value on every quadrant</span>
    <span class="s4"># compared to the second point</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">pred_class_deci_val</span><span class="s3">[:, </span><span class="s5">0</span><span class="s3">] &lt; </span><span class="s1">pred_class_deci_val</span><span class="s3">[:, </span><span class="s5">1</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;SVCClass&quot;</span><span class="s3">, [</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_svc_invalid_break_ties_param</span><span class="s3">(</span><span class="s1">SVCClass</span><span class="s3">):</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">42</span><span class="s3">)</span>

    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVCClass</span><span class="s3">(</span>
        <span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovo&quot;</span><span class="s3">, </span><span class="s1">break_ties</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">42</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;break_ties must be False&quot;</span><span class="s3">):</span>
        <span class="s1">svm</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">y</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;SVCClass&quot;</span><span class="s3">, [</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_svc_ovr_tie_breaking</span><span class="s3">(</span><span class="s1">SVCClass</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test if predict breaks ties in OVR mode. 
    Related issue: https://github.com/scikit-learn/scikit-learn/issues/8277 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">SVCClass</span><span class="s3">.</span><span class="s1">__name__ </span><span class="s3">== </span><span class="s6">&quot;NuSVC&quot; </span><span class="s2">and </span><span class="s1">_IS_32BIT</span><span class="s3">:</span>
        <span class="s4"># XXX: known failure to be investigated. Either the code needs to be</span>
        <span class="s4"># fixed or the test itself might need to be made less sensitive to</span>
        <span class="s4"># random changes in test data and rounding errors more generally.</span>
        <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/29633</span>
        <span class="s1">pytest</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s6">&quot;Failing test on 32bit OS&quot;</span><span class="s3">)</span>

    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">n_samples</span><span class="s3">=</span><span class="s5">20</span><span class="s3">, </span><span class="s1">n_features</span><span class="s3">=</span><span class="s5">2</span><span class="s3">)</span>

    <span class="s1">xs </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, </span><span class="s5">0</span><span class="s3">].</span><span class="s1">min</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">[:, </span><span class="s5">0</span><span class="s3">].</span><span class="s1">max</span><span class="s3">(), </span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">ys </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linspace</span><span class="s3">(</span><span class="s1">X</span><span class="s3">[:, </span><span class="s5">1</span><span class="s3">].</span><span class="s1">min</span><span class="s3">(), </span><span class="s1">X</span><span class="s3">[:, </span><span class="s5">1</span><span class="s3">].</span><span class="s1">max</span><span class="s3">(), </span><span class="s5">100</span><span class="s3">)</span>
    <span class="s1">xx</span><span class="s3">, </span><span class="s1">yy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">meshgrid</span><span class="s3">(</span><span class="s1">xs</span><span class="s3">, </span><span class="s1">ys</span><span class="s3">)</span>

    <span class="s1">common_params </span><span class="s3">= </span><span class="s1">dict</span><span class="s3">(</span>
        <span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;rbf&quot;</span><span class="s3">, </span><span class="s1">gamma</span><span class="s3">=</span><span class="s5">1e6</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">42</span><span class="s3">, </span><span class="s1">decision_function_shape</span><span class="s3">=</span><span class="s6">&quot;ovr&quot;</span>
    <span class="s3">)</span>
    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVCClass</span><span class="s3">(</span>
        <span class="s1">break_ties</span><span class="s3">=</span><span class="s2">False</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">common_params</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">xx</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">yy</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()])</span>
    <span class="s1">dv </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">xx</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">yy</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()])</span>
    <span class="s2">assert not </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">dv</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">))</span>

    <span class="s1">svm </span><span class="s3">= </span><span class="s1">SVCClass</span><span class="s3">(</span>
        <span class="s1">break_ties</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
        <span class="s3">**</span><span class="s1">common_params</span><span class="s3">,</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">pred </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">xx</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">yy</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()])</span>
    <span class="s1">dv </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">c_</span><span class="s3">[</span><span class="s1">xx</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">(), </span><span class="s1">yy</span><span class="s3">.</span><span class="s1">ravel</span><span class="s3">()])</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">all</span><span class="s3">(</span><span class="s1">pred </span><span class="s3">== </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmax</span><span class="s3">(</span><span class="s1">dv</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s5">1</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_gamma_scale</span><span class="s3">():</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= [[</span><span class="s5">0.0</span><span class="s3">], [</span><span class="s5">1.0</span><span class="s3">]], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]</span>

    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">()</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">clf</span><span class="s3">.</span><span class="s1">_gamma</span><span class="s3">, </span><span class="s5">4</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;SVM, params&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">LinearSVC</span><span class="s3">, {</span><span class="s6">&quot;penalty&quot;</span><span class="s3">: </span><span class="s6">&quot;l1&quot;</span><span class="s3">, </span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearSVC</span><span class="s3">, {</span><span class="s6">&quot;penalty&quot;</span><span class="s3">: </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearSVC</span><span class="s3">, {</span><span class="s6">&quot;penalty&quot;</span><span class="s3">: </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">False</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearSVC</span><span class="s3">, {</span><span class="s6">&quot;penalty&quot;</span><span class="s3">: </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearSVR</span><span class="s3">, {</span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;epsilon_insensitive&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearSVR</span><span class="s3">, {</span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;squared_epsilon_insensitive&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}),</span>
        <span class="s3">(</span><span class="s1">LinearSVR</span><span class="s3">, {</span><span class="s6">&quot;loss&quot;</span><span class="s3">: </span><span class="s6">&quot;squared_epsilon_insensitive&quot;</span><span class="s3">, </span><span class="s6">&quot;dual&quot;</span><span class="s3">: </span><span class="s2">True</span><span class="s3">}),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_linearsvm_liblinear_sample_weight</span><span class="s3">(</span><span class="s1">SVM</span><span class="s3">, </span><span class="s1">params</span><span class="s3">):</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">3</span><span class="s3">, </span><span class="s5">3</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
            <span class="s3">[</span><span class="s5">4</span><span class="s3">, </span><span class="s5">1</span><span class="s3">],</span>
        <span class="s3">],</span>
        <span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s6">&quot;float&quot;</span><span class="s3">),</span>
    <span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span>
        <span class="s3">[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">(</span><span class="s6">&quot;int&quot;</span><span class="s3">)</span>
    <span class="s3">)</span>

    <span class="s1">X2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">([</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">])</span>
    <span class="s1">y2 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">hstack</span><span class="s3">([</span><span class="s1">y</span><span class="s3">, </span><span class="s5">3 </span><span class="s3">- </span><span class="s1">y</span><span class="s3">])</span>
    <span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">shape</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">) * </span><span class="s5">2</span><span class="s3">)</span>
    <span class="s1">sample_weight</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">y</span><span class="s3">) :] = </span><span class="s5">0</span>
    <span class="s1">X2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">sample_weight </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">)</span>

    <span class="s1">base_estimator </span><span class="s3">= </span><span class="s1">SVM</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">42</span><span class="s3">)</span>
    <span class="s1">base_estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(**</span><span class="s1">params</span><span class="s3">)</span>
    <span class="s1">base_estimator</span><span class="s3">.</span><span class="s1">set_params</span><span class="s3">(</span><span class="s1">tol</span><span class="s3">=</span><span class="s5">1e-12</span><span class="s3">, </span><span class="s1">max_iter</span><span class="s3">=</span><span class="s5">1000</span><span class="s3">)</span>
    <span class="s1">est_no_weight </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">(</span><span class="s1">base_estimator</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">est_with_weight </span><span class="s3">= </span><span class="s1">base</span><span class="s3">.</span><span class="s1">clone</span><span class="s3">(</span><span class="s1">base_estimator</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
        <span class="s1">X2</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">sample_weight</span><span class="s3">=</span><span class="s1">sample_weight</span>
    <span class="s3">)</span>

    <span class="s2">for </span><span class="s1">method </span><span class="s2">in </span><span class="s3">(</span><span class="s6">&quot;predict&quot;</span><span class="s3">, </span><span class="s6">&quot;decision_function&quot;</span><span class="s3">):</span>
        <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">base_estimator</span><span class="s3">, </span><span class="s1">method</span><span class="s3">):</span>
            <span class="s1">X_est_no_weight </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est_no_weight</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">X_est_with_weight </span><span class="s3">= </span><span class="s1">getattr</span><span class="s3">(</span><span class="s1">est_with_weight</span><span class="s3">, </span><span class="s1">method</span><span class="s3">)(</span><span class="s1">X</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">X_est_no_weight</span><span class="s3">, </span><span class="s1">X_est_with_weight</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;Klass&quot;</span><span class="s3">, (</span><span class="s1">OneClassSVM</span><span class="s3">, </span><span class="s1">SVR</span><span class="s3">, </span><span class="s1">NuSVR</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_n_support</span><span class="s3">(</span><span class="s1">Klass</span><span class="s3">):</span>
    <span class="s4"># Make n_support is correct for oneclass and SVR (used to be</span>
    <span class="s4"># non-initialized)</span>
    <span class="s4"># this is a non regression test for issue #14774</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0.44</span><span class="s3">], [</span><span class="s5">0.45</span><span class="s3">], [</span><span class="s5">0.46</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">]])</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">est </span><span class="s3">= </span><span class="s1">Klass</span><span class="s3">()</span>
    <span class="s2">assert not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">est</span><span class="s3">, </span><span class="s6">&quot;n_support_&quot;</span><span class="s3">)</span>
    <span class="s1">est</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">est</span><span class="s3">.</span><span class="s1">n_support_</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] == </span><span class="s1">est</span><span class="s3">.</span><span class="s1">support_vectors_</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s2">assert </span><span class="s1">est</span><span class="s3">.</span><span class="s1">n_support_</span><span class="s3">.</span><span class="s1">size </span><span class="s3">== </span><span class="s5">1</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;Estimator&quot;</span><span class="s3">, [</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_custom_kernel_not_array_input</span><span class="s3">(</span><span class="s1">Estimator</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test using a custom kernel that is not fed with array-like for floats&quot;&quot;&quot;</span>
    <span class="s1">data </span><span class="s3">= [</span><span class="s6">&quot;A A&quot;</span><span class="s3">, </span><span class="s6">&quot;A&quot;</span><span class="s3">, </span><span class="s6">&quot;B&quot;</span><span class="s3">, </span><span class="s6">&quot;B B&quot;</span><span class="s3">, </span><span class="s6">&quot;A B&quot;</span><span class="s3">]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s5">2</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">], [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">2</span><span class="s3">], [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">]])  </span><span class="s4"># count encoding</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">2</span><span class="s3">, </span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">def </span><span class="s1">string_kernel</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">, </span><span class="s1">X2</span><span class="s3">):</span>
        <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">[</span><span class="s5">0</span><span class="s3">], </span><span class="s1">str</span><span class="s3">)</span>
        <span class="s1">n_samples1 </span><span class="s3">= </span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X1</span><span class="s3">)</span>
        <span class="s1">n_samples2 </span><span class="s3">= </span><span class="s1">_num_samples</span><span class="s3">(</span><span class="s1">X2</span><span class="s3">)</span>
        <span class="s1">K </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s1">n_samples1</span><span class="s3">, </span><span class="s1">n_samples2</span><span class="s3">))</span>
        <span class="s2">for </span><span class="s1">ii </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">n_samples1</span><span class="s3">):</span>
            <span class="s2">for </span><span class="s1">jj </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">ii</span><span class="s3">, </span><span class="s1">n_samples2</span><span class="s3">):</span>
                <span class="s1">K</span><span class="s3">[</span><span class="s1">ii</span><span class="s3">, </span><span class="s1">jj</span><span class="s3">] = </span><span class="s1">X1</span><span class="s3">[</span><span class="s1">ii</span><span class="s3">].</span><span class="s1">count</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">) * </span><span class="s1">X2</span><span class="s3">[</span><span class="s1">jj</span><span class="s3">].</span><span class="s1">count</span><span class="s3">(</span><span class="s6">&quot;A&quot;</span><span class="s3">)</span>
                <span class="s1">K</span><span class="s3">[</span><span class="s1">ii</span><span class="s3">, </span><span class="s1">jj</span><span class="s3">] += </span><span class="s1">X1</span><span class="s3">[</span><span class="s1">ii</span><span class="s3">].</span><span class="s1">count</span><span class="s3">(</span><span class="s6">&quot;B&quot;</span><span class="s3">) * </span><span class="s1">X2</span><span class="s3">[</span><span class="s1">jj</span><span class="s3">].</span><span class="s1">count</span><span class="s3">(</span><span class="s6">&quot;B&quot;</span><span class="s3">)</span>
                <span class="s1">K</span><span class="s3">[</span><span class="s1">jj</span><span class="s3">, </span><span class="s1">ii</span><span class="s3">] = </span><span class="s1">K</span><span class="s3">[</span><span class="s1">ii</span><span class="s3">, </span><span class="s1">jj</span><span class="s3">]</span>
        <span class="s2">return </span><span class="s1">K</span>

    <span class="s1">K </span><span class="s3">= </span><span class="s1">string_kernel</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">data</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span><span class="s3">), </span><span class="s1">K</span><span class="s3">)</span>

    <span class="s1">svc1 </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s1">string_kernel</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">svc2 </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">svc3 </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;precomputed&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">K</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s2">assert </span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) == </span><span class="s1">svc3</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">K</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">data</span><span class="s3">, </span><span class="s1">y</span><span class="s3">) == </span><span class="s1">svc2</span><span class="s3">.</span><span class="s1">score</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">, </span><span class="s6">&quot;decision_function&quot;</span><span class="s3">):  </span><span class="s4"># classifier</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svc2</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svc3</span><span class="s3">.</span><span class="s1">decision_function</span><span class="s3">(</span><span class="s1">K</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svc2</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svc3</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">K</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:  </span><span class="s4"># regressor</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svc2</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">svc1</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">data</span><span class="s3">), </span><span class="s1">svc3</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">K</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_svc_raises_error_internal_representation</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that SVC raises error when internal representation is altered. 
 
    Non-regression test for #18891 and https://nvd.nist.gov/vuln/detail/CVE-2020-28975 
    &quot;&quot;&quot;</span>
    <span class="s1">clf </span><span class="s3">= </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">clf</span><span class="s3">.</span><span class="s1">_n_support</span><span class="s3">[</span><span class="s5">0</span><span class="s3">] = </span><span class="s5">1000000</span>

    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;The internal representation of SVC was altered&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;estimator, expected_n_iter_type&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ndarray</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">, </span><span class="s1">int</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVR</span><span class="s3">, </span><span class="s1">int</span><span class="s3">),</span>
        <span class="s3">(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">OneClassSVM</span><span class="s3">, </span><span class="s1">int</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;dataset&quot;</span><span class="s3">,</span>
    <span class="s3">[</span>
        <span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">n_informative</span><span class="s3">=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
        <span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">n_informative</span><span class="s3">=</span><span class="s5">3</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
        <span class="s1">make_classification</span><span class="s3">(</span><span class="s1">n_classes</span><span class="s3">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">n_informative</span><span class="s3">=</span><span class="s5">4</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s5">0</span><span class="s3">),</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_n_iter_libsvm</span><span class="s3">(</span><span class="s1">estimator</span><span class="s3">, </span><span class="s1">expected_n_iter_type</span><span class="s3">, </span><span class="s1">dataset</span><span class="s3">):</span>
    <span class="s4"># Check that the type of n_iter_ is correct for the classes that inherit</span>
    <span class="s4"># from BaseSVC.</span>
    <span class="s4"># Note that for SVC, and NuSVC this is an ndarray; while for SVR, NuSVR, and</span>
    <span class="s4"># OneClassSVM, it is an int.</span>
    <span class="s4"># For SVC and NuSVC also check the shape of n_iter_.</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">dataset</span>
    <span class="s1">n_iter </span><span class="s3">= </span><span class="s1">estimator</span><span class="s3">(</span><span class="s1">kernel</span><span class="s3">=</span><span class="s6">&quot;linear&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">).</span><span class="s1">n_iter_</span>
    <span class="s2">assert </span><span class="s1">type</span><span class="s3">(</span><span class="s1">n_iter</span><span class="s3">) == </span><span class="s1">expected_n_iter_type</span>
    <span class="s2">if </span><span class="s1">estimator </span><span class="s2">in </span><span class="s3">[</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">svm</span><span class="s3">.</span><span class="s1">NuSVC</span><span class="s3">]:</span>
        <span class="s1">n_classes </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">y</span><span class="s3">))</span>
        <span class="s2">assert </span><span class="s1">n_iter</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">n_classes </span><span class="s3">* (</span><span class="s1">n_classes </span><span class="s3">- </span><span class="s5">1</span><span class="s3">) // </span><span class="s5">2</span><span class="s3">,)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;loss&quot;</span><span class="s3">, [</span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;squared_epsilon_insensitive&quot;</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_dual_auto</span><span class="s3">(</span><span class="s1">loss</span><span class="s3">):</span>
    <span class="s4"># OvR, L2, N &gt; M (6,2)</span>
    <span class="s1">dual </span><span class="s3">= </span><span class="s1">_validate_dual_parameter</span><span class="s3">(</span><span class="s6">&quot;auto&quot;</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">, </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;ovr&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">dual </span><span class="s2">is False</span>
    <span class="s4"># OvR, L2, N &lt; M (2,6)</span>
    <span class="s1">dual </span><span class="s3">= </span><span class="s1">_validate_dual_parameter</span><span class="s3">(</span><span class="s6">&quot;auto&quot;</span><span class="s3">, </span><span class="s1">loss</span><span class="s3">, </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;ovr&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dual </span><span class="s2">is True</span>


<span class="s2">def </span><span class="s1">test_dual_auto_edge_cases</span><span class="s3">():</span>
    <span class="s4"># Hinge, OvR, L2, N &gt; M (6,2)</span>
    <span class="s1">dual </span><span class="s3">= </span><span class="s1">_validate_dual_parameter</span><span class="s3">(</span><span class="s6">&quot;auto&quot;</span><span class="s3">, </span><span class="s6">&quot;hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;ovr&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
    <span class="s2">assert </span><span class="s1">dual </span><span class="s2">is True  </span><span class="s4"># only supports True</span>
    <span class="s1">dual </span><span class="s3">= </span><span class="s1">_validate_dual_parameter</span><span class="s3">(</span>
        <span class="s6">&quot;auto&quot;</span><span class="s3">, </span><span class="s6">&quot;epsilon_insensitive&quot;</span><span class="s3">, </span><span class="s6">&quot;l2&quot;</span><span class="s3">, </span><span class="s6">&quot;ovr&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dual </span><span class="s2">is True  </span><span class="s4"># only supports True</span>
    <span class="s4"># SqHinge, OvR, L1, N &lt; M (2,6)</span>
    <span class="s1">dual </span><span class="s3">= </span><span class="s1">_validate_dual_parameter</span><span class="s3">(</span>
        <span class="s6">&quot;auto&quot;</span><span class="s3">, </span><span class="s6">&quot;squared_hinge&quot;</span><span class="s3">, </span><span class="s6">&quot;l1&quot;</span><span class="s3">, </span><span class="s6">&quot;ovr&quot;</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">T</span>
    <span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">dual </span><span class="s2">is False  </span><span class="s4"># only supports False</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s6">&quot;Estimator, make_dataset&quot;</span><span class="s3">,</span>
    <span class="s3">[(</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVC</span><span class="s3">, </span><span class="s1">make_classification</span><span class="s3">), (</span><span class="s1">svm</span><span class="s3">.</span><span class="s1">SVR</span><span class="s3">, </span><span class="s1">make_regression</span><span class="s3">)],</span>
<span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;C_inf&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">float</span><span class="s3">(</span><span class="s6">&quot;inf&quot;</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_svm_with_infinite_C</span><span class="s3">(</span><span class="s1">Estimator</span><span class="s3">, </span><span class="s1">make_dataset</span><span class="s3">, </span><span class="s1">C_inf</span><span class="s3">, </span><span class="s1">global_random_seed</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can pass `C=inf` that is equivalent to a very large C value. 
 
    Non-regression test for 
    https://github.com/scikit-learn/scikit-learn/issues/29772 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">y </span><span class="s3">= </span><span class="s1">make_dataset</span><span class="s3">(</span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">global_random_seed</span><span class="s3">)</span>
    <span class="s1">estimator_C_inf </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s1">C_inf</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>
    <span class="s1">estimator_C_large </span><span class="s3">= </span><span class="s1">Estimator</span><span class="s3">(</span><span class="s1">C</span><span class="s3">=</span><span class="s5">1e10</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">y</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">estimator_C_large</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">estimator_C_inf</span><span class="s3">.</span><span class="s1">predict</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>
</pre>
</body>
</html>