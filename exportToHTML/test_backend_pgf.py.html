<html>
<head>
<title>test_backend_pgf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backend_pgf.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">shutil</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">version </span><span class="s0">import </span><span class="s1">parse </span><span class="s0">as </span><span class="s1">parse_version</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">_has_tex_package</span><span class="s2">, </span><span class="s1">_check_for_pgf</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">ImageComparisonFailure</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">compare </span><span class="s0">import </span><span class="s1">compare_images</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">backends</span><span class="s2">.</span><span class="s1">backend_pgf </span><span class="s0">import </span><span class="s1">PdfPages</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_image_directories</span><span class="s2">, </span><span class="s1">check_figures_equal</span><span class="s2">, </span><span class="s1">image_comparison</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">_markers </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">needs_ghostscript</span><span class="s2">, </span><span class="s1">needs_pgf_lualatex</span><span class="s2">, </span><span class="s1">needs_pgf_pdflatex</span><span class="s2">,</span>
    <span class="s1">needs_pgf_xelatex</span><span class="s2">)</span>


<span class="s1">baseline_dir</span><span class="s2">, </span><span class="s1">result_dir </span><span class="s2">= </span><span class="s1">_image_directories</span><span class="s2">(</span><span class="s0">lambda</span><span class="s2">: </span><span class="s3">'dummy func'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">compare_figure</span><span class="s2">(</span><span class="s1">fname</span><span class="s2">, </span><span class="s1">savefig_kwargs</span><span class="s2">={}, </span><span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
    <span class="s1">actual </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">result_dir</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">actual</span><span class="s2">, **</span><span class="s1">savefig_kwargs</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">result_dir</span><span class="s2">, </span><span class="s3">&quot;expected_%s&quot; </span><span class="s2">% </span><span class="s1">fname</span><span class="s2">)</span>
    <span class="s1">shutil</span><span class="s2">.</span><span class="s1">copyfile</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">baseline_dir</span><span class="s2">, </span><span class="s1">fname</span><span class="s2">), </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">err </span><span class="s2">= </span><span class="s1">compare_images</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">actual</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">err</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ImageComparisonFailure</span><span class="s2">(</span><span class="s1">err</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">needs_ghostscript</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_tex_special_chars</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s3">&quot;%_^ $a_b^c$&quot;</span><span class="s2">)</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s1">backend</span><span class="s2">=</span><span class="s3">&quot;pgf&quot;</span><span class="s2">)</span>
    <span class="s1">buf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s2">(</span><span class="s1">t </span><span class="s2">== </span><span class="s4">1</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()  </span><span class="s5"># The leading &quot;%&quot; didn't eat up everything.</span>


<span class="s0">def </span><span class="s1">create_figure</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">15</span><span class="s2">)</span>

    <span class="s5"># line plot</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x </span><span class="s2">** </span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;b-&quot;</span><span class="s2">)</span>

    <span class="s5"># marker</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">1 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;g&gt;&quot;</span><span class="s2">)</span>

    <span class="s5"># filled paths and patterns</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">fill_between</span><span class="s2">([</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">.4</span><span class="s2">], [</span><span class="s4">.4</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">], </span><span class="s1">hatch</span><span class="s2">=</span><span class="s3">'//'</span><span class="s2">, </span><span class="s1">facecolor</span><span class="s2">=</span><span class="s3">&quot;lightgray&quot;</span><span class="s2">,</span>
                     <span class="s1">edgecolor</span><span class="s2">=</span><span class="s3">&quot;red&quot;</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">fill</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">.8</span><span class="s2">, </span><span class="s4">.8</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">)</span>

    <span class="s5"># text and typesetting</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0.9</span><span class="s2">], [</span><span class="s4">0.5</span><span class="s2">], </span><span class="s3">&quot;ro&quot;</span><span class="s2">, </span><span class="s1">markersize</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">0.9</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s3">'unicode (ü, °, </span><span class="s0">\N{Section Sign}</span><span class="s3">) and math ($</span><span class="s0">\\</span><span class="s3">mu_i = x_i^2$)'</span><span class="s2">,</span>
             <span class="s1">ha</span><span class="s2">=</span><span class="s3">'right'</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s4">20</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">ylabel</span><span class="s2">(</span><span class="s3">'sans-serif, blue, $</span><span class="s0">\\</span><span class="s3">frac{</span><span class="s0">\\</span><span class="s3">sqrt{x}}{y^2}$..'</span><span class="s2">,</span>
               <span class="s1">family</span><span class="s2">=</span><span class="s3">'sans-serif'</span><span class="s2">, </span><span class="s1">color</span><span class="s2">=</span><span class="s3">'blue'</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s3">'should be clipped as default clip_box is Axes bbox'</span><span class="s2">,</span>
             <span class="s1">fontsize</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">clip_on</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">xlim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">ylim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>


<span class="s5"># test compiling a figure to pdf with xelatex</span>
<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'pgf_xelatex.pdf'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_xelatex</span><span class="s2">():</span>
    <span class="s1">rc_xelatex </span><span class="s2">= {</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'serif'</span><span class="s2">,</span>
                  <span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">}</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">rc_xelatex</span><span class="s2">)</span>
    <span class="s1">create_figure</span><span class="s2">()</span>


<span class="s0">try</span><span class="s2">:</span>
    <span class="s1">_old_gs_version </span><span class="s2">= </span><span class="s1">\</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">_get_executable_info</span><span class="s2">(</span><span class="s3">'gs'</span><span class="s2">).</span><span class="s1">version </span><span class="s2">&lt; </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s3">'9.50'</span><span class="s2">)</span>
<span class="s0">except </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">ExecutableNotFoundError</span><span class="s2">:</span>
    <span class="s1">_old_gs_version </span><span class="s2">= </span><span class="s0">True</span>


<span class="s5"># test compiling a figure to pdf with pdflatex</span>
<span class="s2">@</span><span class="s1">needs_pgf_pdflatex</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">_has_tex_package</span><span class="s2">(</span><span class="s3">'type1ec'</span><span class="s2">), </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">'needs type1ec.sty'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skipif</span><span class="s2">(</span><span class="s0">not </span><span class="s1">_has_tex_package</span><span class="s2">(</span><span class="s3">'ucs'</span><span class="s2">), </span><span class="s1">reason</span><span class="s2">=</span><span class="s3">'needs ucs.sty'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'pgf_pdflatex.pdf'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'default'</span><span class="s2">,</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s4">11.71 </span><span class="s0">if </span><span class="s1">_old_gs_version </span><span class="s0">else </span><span class="s4">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pdflatex</span><span class="s2">():</span>
    <span class="s1">rc_pdflatex </span><span class="s2">= {</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'serif'</span><span class="s2">,</span>
                   <span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
                   <span class="s3">'pgf.texsystem'</span><span class="s2">: </span><span class="s3">'pdflatex'</span><span class="s2">,</span>
                   <span class="s3">'pgf.preamble'</span><span class="s2">: (</span><span class="s3">'</span><span class="s0">\\</span><span class="s3">usepackage[utf8x]{inputenc}'</span>
                                    <span class="s3">'</span><span class="s0">\\</span><span class="s3">usepackage[T1]{fontenc}'</span><span class="s2">)}</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">rc_pdflatex</span><span class="s2">)</span>
    <span class="s1">create_figure</span><span class="s2">()</span>


<span class="s5"># test updating the rc parameters for each figure</span>
<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">needs_pgf_pdflatex</span>
<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_rcupdate</span><span class="s2">():</span>
    <span class="s1">rc_sets </span><span class="s2">= [{</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'sans-serif'</span><span class="s2">,</span>
                <span class="s3">'font.size'</span><span class="s2">: </span><span class="s4">30</span><span class="s2">,</span>
                <span class="s3">'figure.subplot.left'</span><span class="s2">: </span><span class="s4">.2</span><span class="s2">,</span>
                <span class="s3">'lines.markersize'</span><span class="s2">: </span><span class="s4">10</span><span class="s2">,</span>
                <span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
                <span class="s3">'pgf.texsystem'</span><span class="s2">: </span><span class="s3">'xelatex'</span><span class="s2">},</span>
               <span class="s2">{</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'monospace'</span><span class="s2">,</span>
                <span class="s3">'font.size'</span><span class="s2">: </span><span class="s4">10</span><span class="s2">,</span>
                <span class="s3">'figure.subplot.left'</span><span class="s2">: </span><span class="s4">.1</span><span class="s2">,</span>
                <span class="s3">'lines.markersize'</span><span class="s2">: </span><span class="s4">20</span><span class="s2">,</span>
                <span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
                <span class="s3">'pgf.texsystem'</span><span class="s2">: </span><span class="s3">'pdflatex'</span><span class="s2">,</span>
                <span class="s3">'pgf.preamble'</span><span class="s2">: (</span><span class="s3">'</span><span class="s0">\\</span><span class="s3">usepackage[utf8x]{inputenc}'</span>
                                 <span class="s3">'</span><span class="s0">\\</span><span class="s3">usepackage[T1]{fontenc}'</span>
                                 <span class="s3">'</span><span class="s0">\\</span><span class="s3">usepackage{sfmath}'</span><span class="s2">)}]</span>
    <span class="s1">tol </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">13.2</span><span class="s2">] </span><span class="s0">if </span><span class="s1">_old_gs_version </span><span class="s0">else </span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">rc_set </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">rc_sets</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rc_context</span><span class="s2">(</span><span class="s1">rc_set</span><span class="s2">):</span>
            <span class="s0">for </span><span class="s1">substring</span><span class="s2">, </span><span class="s1">pkg </span><span class="s0">in </span><span class="s2">[(</span><span class="s3">'sfmath'</span><span class="s2">, </span><span class="s3">'sfmath'</span><span class="s2">), (</span><span class="s3">'utf8x'</span><span class="s2">, </span><span class="s3">'ucs'</span><span class="s2">)]:</span>
                <span class="s0">if </span><span class="s2">(</span><span class="s1">substring </span><span class="s0">in </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">'pgf.preamble'</span><span class="s2">]</span>
                        <span class="s0">and not </span><span class="s1">_has_tex_package</span><span class="s2">(</span><span class="s1">pkg</span><span class="s2">)):</span>
                    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">f'needs </span><span class="s0">{</span><span class="s1">pkg</span><span class="s0">}</span><span class="s3">.sty'</span><span class="s2">)</span>
            <span class="s1">create_figure</span><span class="s2">()</span>
            <span class="s1">compare_figure</span><span class="s2">(</span><span class="s3">f'pgf_rcupdate</span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">}</span><span class="s3">.pdf'</span><span class="s2">, </span><span class="s1">tol</span><span class="s2">=</span><span class="s1">tol</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])</span>


<span class="s5"># test backend-side clipping, since large numbers are not supported by TeX</span>
<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pathclip</span><span class="s2">():</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">19680801</span><span class="s2">)</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'serif'</span><span class="s2">, </span><span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">})</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">axs </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1e100</span><span class="s2">], [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1e100</span><span class="s2">])</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>

    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">scatter</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">hist</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">1000</span><span class="s2">), </span><span class="s1">bins</span><span class="s2">=</span><span class="s4">20</span><span class="s2">, </span><span class="s1">range</span><span class="s2">=[-</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">])</span>
    <span class="s1">axs</span><span class="s2">[</span><span class="s4">1</span><span class="s2">].</span><span class="s1">set_xscale</span><span class="s2">(</span><span class="s3">'log'</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;pdf&quot;</span><span class="s2">)  </span><span class="s5"># No image comparison.</span>


<span class="s5"># test mixed mode rendering</span>
<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s3">'pgf_mixedmode.pdf'</span><span class="s2">], </span><span class="s1">style</span><span class="s2">=</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mixedmode</span><span class="s2">():</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'serif'</span><span class="s2">, </span><span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">})</span>
    <span class="s1">Y</span><span class="s2">, </span><span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ogrid</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">:</span><span class="s4">1</span><span class="s2">:</span><span class="s4">40j</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">:</span><span class="s4">1</span><span class="s2">:</span><span class="s4">40j</span><span class="s2">]</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">pcolor</span><span class="s2">(</span><span class="s1">X</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s1">Y</span><span class="s2">**</span><span class="s4">2</span><span class="s2">).</span><span class="s1">set_rasterized</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>


<span class="s5"># test bbox_inches clipping</span>
<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_bbox_inches</span><span class="s2">():</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'serif'</span><span class="s2">, </span><span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">})</span>
    <span class="s1">fig</span><span class="s2">, (</span><span class="s1">ax1</span><span class="s2">, </span><span class="s1">ax2</span><span class="s2">) = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>
    <span class="s1">bbox </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">get_window_extent</span><span class="s2">().</span><span class="s1">transformed</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">dpi_scale_trans</span><span class="s2">.</span><span class="s1">inverted</span><span class="s2">())</span>
    <span class="s1">compare_figure</span><span class="s2">(</span><span class="s3">'pgf_bbox_inches.pdf'</span><span class="s2">, </span><span class="s1">savefig_kwargs</span><span class="s2">={</span><span class="s3">'bbox_inches'</span><span class="s2">: </span><span class="s1">bbox</span><span class="s2">},</span>
                   <span class="s1">tol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'system'</span><span class="s2">, [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'lualatex'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">needs_pgf_lualatex</span><span class="s2">]),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'pdflatex'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">needs_pgf_pdflatex</span><span class="s2">]),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'xelatex'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">needs_pgf_xelatex</span><span class="s2">]),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pdf_pages</span><span class="s2">(</span><span class="s1">system</span><span class="s2">):</span>
    <span class="s1">rc_pdflatex </span><span class="s2">= {</span>
        <span class="s3">'font.family'</span><span class="s2">: </span><span class="s3">'serif'</span><span class="s2">,</span>
        <span class="s3">'pgf.rcfonts'</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s3">'pgf.texsystem'</span><span class="s2">: </span><span class="s1">system</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">rc_pdflatex</span><span class="s2">)</span>

    <span class="s1">fig1</span><span class="s2">, </span><span class="s1">ax1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">fig1</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>

    <span class="s1">fig2</span><span class="s2">, </span><span class="s1">ax2 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s1">fig2</span><span class="s2">.</span><span class="s1">tight_layout</span><span class="s2">()</span>

    <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">result_dir</span><span class="s2">, </span><span class="s3">f'pdfpages_</span><span class="s0">{</span><span class="s1">system</span><span class="s0">}</span><span class="s3">.pdf'</span><span class="s2">)</span>
    <span class="s1">md </span><span class="s2">= {</span>
        <span class="s3">'Author'</span><span class="s2">: </span><span class="s3">'me'</span><span class="s2">,</span>
        <span class="s3">'Title'</span><span class="s2">: </span><span class="s3">'Multipage PDF with pgf'</span><span class="s2">,</span>
        <span class="s3">'Subject'</span><span class="s2">: </span><span class="s3">'Test page'</span><span class="s2">,</span>
        <span class="s3">'Keywords'</span><span class="s2">: </span><span class="s3">'test,pdf,multipage'</span><span class="s2">,</span>
        <span class="s3">'ModDate'</span><span class="s2">: </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span>
            <span class="s4">1968</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">tzinfo</span><span class="s2">=</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timedelta</span><span class="s2">(</span><span class="s4">0</span><span class="s2">))),</span>
        <span class="s3">'Trapped'</span><span class="s2">: </span><span class="s3">'Unknown'</span>
    <span class="s2">}</span>

    <span class="s0">with </span><span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">md</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fig1</span><span class="s2">)</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fig2</span><span class="s2">)</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fig1</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">pdf</span><span class="s2">.</span><span class="s1">get_pagecount</span><span class="s2">() == </span><span class="s4">3</span>


<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s3">'default'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">'pgf'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">'system'</span><span class="s2">, [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'lualatex'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">needs_pgf_lualatex</span><span class="s2">]),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'pdflatex'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">needs_pgf_pdflatex</span><span class="s2">]),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">'xelatex'</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=[</span><span class="s1">needs_pgf_xelatex</span><span class="s2">]),</span>
<span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pdf_pages_metadata_check</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">system</span><span class="s2">):</span>
    <span class="s5"># Basically the same as test_pdf_pages, but we keep it separate to leave</span>
    <span class="s5"># pikepdf as an optional dependency.</span>
    <span class="s1">pikepdf </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">'pikepdf'</span><span class="s2">)</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s3">'SOURCE_DATE_EPOCH'</span><span class="s2">, </span><span class="s3">'0'</span><span class="s2">)</span>

    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s3">'pgf.texsystem'</span><span class="s2">: </span><span class="s1">system</span><span class="s2">})</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>

    <span class="s1">md </span><span class="s2">= {</span>
        <span class="s3">'Author'</span><span class="s2">: </span><span class="s3">'me'</span><span class="s2">,</span>
        <span class="s3">'Title'</span><span class="s2">: </span><span class="s3">'Multipage PDF with pgf'</span><span class="s2">,</span>
        <span class="s3">'Subject'</span><span class="s2">: </span><span class="s3">'Test page'</span><span class="s2">,</span>
        <span class="s3">'Keywords'</span><span class="s2">: </span><span class="s3">'test,pdf,multipage'</span><span class="s2">,</span>
        <span class="s3">'ModDate'</span><span class="s2">: </span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span>
            <span class="s4">1968</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">tzinfo</span><span class="s2">=</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timezone</span><span class="s2">(</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">timedelta</span><span class="s2">(</span><span class="s4">0</span><span class="s2">))),</span>
        <span class="s3">'Trapped'</span><span class="s2">: </span><span class="s3">'True'</span>
    <span class="s2">}</span>
    <span class="s1">path </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">result_dir</span><span class="s2">, </span><span class="s3">f'pdfpages_meta_check_</span><span class="s0">{</span><span class="s1">system</span><span class="s0">}</span><span class="s3">.pdf'</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">md</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pikepdf</span><span class="s2">.</span><span class="s1">Pdf</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">path</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s1">info </span><span class="s2">= {</span><span class="s1">k</span><span class="s2">: </span><span class="s1">str</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">pdf</span><span class="s2">.</span><span class="s1">docinfo</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>

    <span class="s5"># Not set by us, so don't bother checking.</span>
    <span class="s0">if </span><span class="s3">'/PTEX.FullBanner' </span><span class="s0">in </span><span class="s1">info</span><span class="s2">:</span>
        <span class="s0">del </span><span class="s1">info</span><span class="s2">[</span><span class="s3">'/PTEX.FullBanner'</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s3">'/PTEX.Fullbanner' </span><span class="s0">in </span><span class="s1">info</span><span class="s2">:</span>
        <span class="s0">del </span><span class="s1">info</span><span class="s2">[</span><span class="s3">'/PTEX.Fullbanner'</span><span class="s2">]</span>

    <span class="s5"># Some LaTeX engines ignore this setting, and state themselves as producer.</span>
    <span class="s1">producer </span><span class="s2">= </span><span class="s1">info</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s3">'/Producer'</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">producer </span><span class="s2">== </span><span class="s3">f'Matplotlib pgf backend v</span><span class="s0">{</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">__version__</span><span class="s0">}</span><span class="s3">' </span><span class="s0">or </span><span class="s2">(</span>
            <span class="s1">system </span><span class="s2">== </span><span class="s3">'lualatex' </span><span class="s0">and </span><span class="s3">'LuaTeX' </span><span class="s0">in </span><span class="s1">producer</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">info </span><span class="s2">== {</span>
        <span class="s3">'/Author'</span><span class="s2">: </span><span class="s3">'me'</span><span class="s2">,</span>
        <span class="s3">'/CreationDate'</span><span class="s2">: </span><span class="s3">'D:19700101000000Z'</span><span class="s2">,</span>
        <span class="s3">'/Creator'</span><span class="s2">: </span><span class="s3">f'Matplotlib v</span><span class="s0">{</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">__version__</span><span class="s0">}</span><span class="s3">, https://matplotlib.org'</span><span class="s2">,</span>
        <span class="s3">'/Keywords'</span><span class="s2">: </span><span class="s3">'test,pdf,multipage'</span><span class="s2">,</span>
        <span class="s3">'/ModDate'</span><span class="s2">: </span><span class="s3">'D:19680801000000Z'</span><span class="s2">,</span>
        <span class="s3">'/Subject'</span><span class="s2">: </span><span class="s3">'Test page'</span><span class="s2">,</span>
        <span class="s3">'/Title'</span><span class="s2">: </span><span class="s3">'Multipage PDF with pgf'</span><span class="s2">,</span>
        <span class="s3">'/Trapped'</span><span class="s2">: </span><span class="s3">'/True'</span><span class="s2">,</span>
    <span class="s2">}</span>


<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_multipage_keep_empty</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s5"># test empty pdf files</span>

    <span class="s5"># an empty pdf is left behind with keep_empty unset</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;a.pdf&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">MatplotlibDeprecationWarning</span><span class="s2">), </span><span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">assert </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s5"># an empty pdf is left behind with keep_empty=True</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;b.pdf&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">MatplotlibDeprecationWarning</span><span class="s2">), </span><span class="s1">\</span>
            <span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">keep_empty</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">assert </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s5"># an empty pdf deletes itself afterwards with keep_empty=False</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;c.pdf&quot;</span>
    <span class="s0">with </span><span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">keep_empty</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s0">pass</span>
    <span class="s0">assert not </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s5"># test pdf files with content, they should never be deleted</span>

    <span class="s5"># a non-empty pdf is left behind with keep_empty unset</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;d.pdf&quot;</span>
    <span class="s0">with </span><span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s5"># a non-empty pdf is left behind with keep_empty=True</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;e.pdf&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">MatplotlibDeprecationWarning</span><span class="s2">), </span><span class="s1">\</span>
            <span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">keep_empty</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">()</span>

    <span class="s5"># a non-empty pdf is left behind with keep_empty=False</span>
    <span class="s1">fn </span><span class="s2">= </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s3">&quot;f.pdf&quot;</span>
    <span class="s0">with </span><span class="s1">PdfPages</span><span class="s2">(</span><span class="s1">fn</span><span class="s2">, </span><span class="s1">keep_empty</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pdf</span><span class="s2">:</span>
        <span class="s1">pdf</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">fn</span><span class="s2">.</span><span class="s1">exists</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_tex_restart_after_error</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">r&quot;\oops&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;pgf&quot;</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()  </span><span class="s5"># start from scratch</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s3">r&quot;this is ok&quot;</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;pgf&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_bbox_inches_tight</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]])</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;pdf&quot;</span><span class="s2">, </span><span class="s1">backend</span><span class="s2">=</span><span class="s3">&quot;pgf&quot;</span><span class="s2">, </span><span class="s1">bbox_inches</span><span class="s2">=</span><span class="s3">&quot;tight&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s2">@</span><span class="s1">needs_ghostscript</span>
<span class="s0">def </span><span class="s1">test_png_transparency</span><span class="s2">():  </span><span class="s5"># Actually, also just testing that png works.</span>
    <span class="s1">buf </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">().</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;png&quot;</span><span class="s2">, </span><span class="s1">backend</span><span class="s2">=</span><span class="s3">&quot;pgf&quot;</span><span class="s2">, </span><span class="s1">transparent</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">buf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">t</span><span class="s2">[..., </span><span class="s4">3</span><span class="s2">] == </span><span class="s4">0</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()  </span><span class="s5"># fully transparent.</span>


<span class="s2">@</span><span class="s1">needs_pgf_xelatex</span>
<span class="s0">def </span><span class="s1">test_unknown_font</span><span class="s2">(</span><span class="s1">caplog</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">caplog</span><span class="s2">.</span><span class="s1">at_level</span><span class="s2">(</span><span class="s3">&quot;WARNING&quot;</span><span class="s2">):</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">&quot;font.family&quot;</span><span class="s2">] = </span><span class="s3">&quot;this-font-does-not-exist&quot;</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">figtext</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s3">&quot;hello, world&quot;</span><span class="s2">)</span>
        <span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s3">&quot;pgf&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;Ignoring unknown font: this-font-does-not-exist&quot; </span><span class="s0">in </span><span class="s2">[</span>
        <span class="s1">r</span><span class="s2">.</span><span class="s1">getMessage</span><span class="s2">() </span><span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">caplog</span><span class="s2">.</span><span class="s1">records</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s3">&quot;pdf&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;texsystem&quot;</span><span class="s2">, (</span><span class="s3">&quot;pdflatex&quot;</span><span class="s2">, </span><span class="s3">&quot;xelatex&quot;</span><span class="s2">, </span><span class="s3">&quot;lualatex&quot;</span><span class="s2">))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">&quot;pgf&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_minus_signs_with_tex</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">, </span><span class="s1">texsystem</span><span class="s2">):</span>
    <span class="s0">if not </span><span class="s1">_check_for_pgf</span><span class="s2">(</span><span class="s1">texsystem</span><span class="s2">):</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s1">texsystem </span><span class="s2">+ </span><span class="s3">' + pgf is required'</span><span class="s2">)</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s3">&quot;pgf.texsystem&quot;</span><span class="s2">] = </span><span class="s1">texsystem</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s3">&quot;$-1$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">.5</span><span class="s2">, </span><span class="s3">&quot;$</span><span class="s0">\N{MINUS SIGN}</span><span class="s3">1$&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">backend</span><span class="s2">(</span><span class="s3">&quot;pgf&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sketch_params</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xticks</span><span class="s2">([])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_yticks</span><span class="s2">([])</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_frame_on</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">handle</span><span class="s2">, = </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">handle</span><span class="s2">.</span><span class="s1">set_sketch_params</span><span class="s2">(</span><span class="s1">scale</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">length</span><span class="s2">=</span><span class="s4">30</span><span class="s2">, </span><span class="s1">randomness</span><span class="s2">=</span><span class="s4">42</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s3">'pgf'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s1">baseline </span><span class="s2">= </span><span class="s3">r&quot;&quot;&quot;\pgfpathmoveto{\pgfqpoint{0.375000in}{0.300000in}}% 
\pgfpathlineto{\pgfqpoint{2.700000in}{2.700000in}}% 
\usepgfmodule{decorations}% 
\usepgflibrary{decorations.pathmorphing}% 
\pgfkeys{/pgf/decoration/.cd, &quot;&quot;&quot; </span><span class="s1">\</span>
    <span class="s3">r&quot;&quot;&quot;segment length = 0.150000in, amplitude = 0.100000in}% 
\pgfmathsetseed{42}% 
\pgfdecoratecurrentpath{random steps}% 
\pgfusepath{stroke}%&quot;&quot;&quot;</span>
    <span class="s5"># \pgfdecoratecurrentpath must be after the path definition and before the</span>
    <span class="s5"># path is used (\pgfusepath)</span>
    <span class="s0">assert </span><span class="s1">baseline </span><span class="s0">in </span><span class="s1">buf</span>
</pre>
</body>
</html>