<html>
<head>
<title>test_chandrupatla.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_chandrupatla.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_array_less</span>

<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">stats</span><span class="s2">, </span><span class="s1">special</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_elementwise_iterative_method </span><span class="s0">as </span><span class="s1">eim</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">conftest </span><span class="s0">import </span><span class="s1">array_api_compatible</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_array_api </span><span class="s0">import </span><span class="s2">(</span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">xp_assert_close</span><span class="s2">, </span><span class="s1">xp_assert_equal</span><span class="s2">,</span>
                                   <span class="s1">xp_assert_less</span><span class="s2">, </span><span class="s1">xp_minimum</span><span class="s2">, </span><span class="s1">is_numpy</span><span class="s2">, </span><span class="s1">is_cupy</span><span class="s2">)</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">_chandrupatla </span><span class="s0">import </span><span class="s2">(</span><span class="s1">_chandrupatla_minimize</span><span class="s2">,</span>
                                          <span class="s1">_chandrupatla </span><span class="s0">as </span><span class="s1">_chandrupatla_root</span><span class="s2">)</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">optimize</span><span class="s2">.</span><span class="s1">_tstutils </span><span class="s0">import </span><span class="s1">_CHANDRUPATLA_TESTS</span>

<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">permutations</span>
<span class="s0">from </span><span class="s2">.</span><span class="s1">test_zeros </span><span class="s0">import </span><span class="s1">TestScalarRootFinders</span>

<span class="s0">def </span><span class="s1">f1</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s3">100</span><span class="s2">*(</span><span class="s3">1 </span><span class="s2">- </span><span class="s1">x</span><span class="s2">**</span><span class="s3">3.</span><span class="s2">)**</span><span class="s3">2 </span><span class="s2">+ (</span><span class="s3">1</span><span class="s2">-</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2.</span><span class="s2">) + </span><span class="s3">2</span><span class="s2">*(</span><span class="s3">1</span><span class="s2">-</span><span class="s1">x</span><span class="s2">)**</span><span class="s3">2.</span>


<span class="s0">def </span><span class="s1">f2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s3">5 </span><span class="s2">+ (</span><span class="s1">x </span><span class="s2">- </span><span class="s3">2.</span><span class="s2">)**</span><span class="s3">6</span>


<span class="s0">def </span><span class="s1">f3</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) - </span><span class="s3">5</span><span class="s2">*</span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">f4</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">x</span><span class="s2">**</span><span class="s3">5. </span><span class="s2">- </span><span class="s3">5</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s3">3. </span><span class="s2">- </span><span class="s3">20.</span><span class="s2">*</span><span class="s1">x </span><span class="s2">+ </span><span class="s3">5.</span>


<span class="s0">def </span><span class="s1">f5</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s3">8</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">2</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">7</span><span class="s2">*</span><span class="s1">x </span><span class="s2">+ </span><span class="s3">3</span>


<span class="s0">def </span><span class="s1">_bracket_minimum</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">):</span>
    <span class="s1">phi </span><span class="s2">= </span><span class="s3">1.61803398875</span>
    <span class="s1">maxiter </span><span class="s2">= </span><span class="s3">100</span>
    <span class="s1">f1 </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">)</span>
    <span class="s1">f2 </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">)</span>
    <span class="s1">step </span><span class="s2">= </span><span class="s1">x2 </span><span class="s2">- </span><span class="s1">x1</span>
    <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">step </span><span class="s2">= ((</span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">, -</span><span class="s1">step</span><span class="s2">) </span><span class="s0">if </span><span class="s1">f2 </span><span class="s2">&gt; </span><span class="s1">f1</span>
                            <span class="s0">else </span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">step</span><span class="s2">))</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">maxiter</span><span class="s2">):</span>
        <span class="s1">step </span><span class="s2">*= </span><span class="s1">phi</span>
        <span class="s1">x3 </span><span class="s2">= </span><span class="s1">x2 </span><span class="s2">+ </span><span class="s1">step</span>
        <span class="s1">f3 </span><span class="s2">= </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x3</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">f3 </span><span class="s2">&lt; </span><span class="s1">f2</span><span class="s2">:</span>
            <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">, </span><span class="s1">f2 </span><span class="s2">= </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f3</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">break</span>
    <span class="s0">return </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f3</span>


<span class="s1">cases </span><span class="s2">= [</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">13</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">13</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">8</span><span class="s2">, </span><span class="s3">15</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">16</span><span class="s2">, </span><span class="s3">16</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">32</span><span class="s2">, </span><span class="s3">19</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">64</span><span class="s2">, </span><span class="s3">20</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">128</span><span class="s2">, </span><span class="s3">21</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">256</span><span class="s2">, </span><span class="s3">21</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">512</span><span class="s2">, </span><span class="s3">19</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f1</span><span class="s2">, -</span><span class="s3">1024</span><span class="s2">, </span><span class="s3">24</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">8</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">8</span><span class="s2">, </span><span class="s3">7</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">16</span><span class="s2">, </span><span class="s3">8</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">32</span><span class="s2">, </span><span class="s3">8</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">64</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">128</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">256</span><span class="s2">, </span><span class="s3">13</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">512</span><span class="s2">, </span><span class="s3">12</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f2</span><span class="s2">, -</span><span class="s3">1024</span><span class="s2">, </span><span class="s3">13</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">2</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">8</span><span class="s2">, </span><span class="s3">10</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">16</span><span class="s2">, </span><span class="s3">14</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">32</span><span class="s2">, </span><span class="s3">12</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">64</span><span class="s2">, </span><span class="s3">15</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">128</span><span class="s2">, </span><span class="s3">18</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">256</span><span class="s2">, </span><span class="s3">18</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">512</span><span class="s2">, </span><span class="s3">19</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f3</span><span class="s2">, -</span><span class="s3">1024</span><span class="s2">, </span><span class="s3">19</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.15</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.20</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">11</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.30</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.35</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.40</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.45</span><span class="s2">, </span><span class="s3">10</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.50</span><span class="s2">, </span><span class="s3">10</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f4</span><span class="s2">, -</span><span class="s3">0.55</span><span class="s2">, </span><span class="s3">10</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.10</span><span class="s2">, </span><span class="s3">7</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.15</span><span class="s2">, </span><span class="s3">8</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.20</span><span class="s2">, </span><span class="s3">10</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.30</span><span class="s2">, </span><span class="s3">8</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.35</span><span class="s2">, </span><span class="s3">7</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.40</span><span class="s2">, </span><span class="s3">7</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.45</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.50</span><span class="s2">, </span><span class="s3">9</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s1">f5</span><span class="s2">, -</span><span class="s3">0.55</span><span class="s2">, </span><span class="s3">8</span><span class="s2">)</span>
<span class="s2">]</span>


<span class="s0">class </span><span class="s1">TestChandrupatlaMinimize</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s1">dist </span><span class="s2">= </span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s2">-</span><span class="s1">dist</span><span class="s2">.</span><span class="s1">pdf</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s1">loc</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'loc'</span><span class="s2">, [</span><span class="s3">0.6</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1.05</span><span class="s2">, </span><span class="s3">1.05</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
        <span class="s5"># Find mode of normal distribution. Compare mode against location</span>
        <span class="s5"># parameter and value of pdf at mode against expected pdf.</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">loc</span><span class="s2">,))</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">loc</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-6</span><span class="s2">)</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, -</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">.</span><span class="s1">pdf</span><span class="s2">(</span><span class="s3">0</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape'</span><span class="s2">, [</span><span class="s1">tuple</span><span class="s2">(), (</span><span class="s3">12</span><span class="s2">,), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_vectorization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">):</span>
        <span class="s5"># Test for correct functionality, output shapes, and dtypes for various</span>
        <span class="s5"># input shapes.</span>
        <span class="s1">loc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">1.05</span><span class="s2">, </span><span class="s3">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) </span><span class="s0">if </span><span class="s1">shape </span><span class="s0">else </span><span class="s3">0.6</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">loc</span><span class="s2">,)</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">chandrupatla_single</span><span class="s2">(</span><span class="s1">loc_single</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">loc_single</span><span class="s2">,))</span>

        <span class="s0">def </span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">)</span>
        <span class="s1">refs </span><span class="s2">= </span><span class="s1">chandrupatla_single</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">()</span>

        <span class="s1">ref_x </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">x </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_x</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s1">ref_fun </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fun </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_fun</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">))</span>

        <span class="s1">ref_success </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">success </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_success</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>

        <span class="s1">ref_flag </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">status </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_flag</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>

        <span class="s1">ref_nfev </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">nfev </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_nfev</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">), </span><span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>

        <span class="s1">ref_nit </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">nit </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_nit</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">), </span><span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals</span><span class="s2">-</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>

        <span class="s1">ref_xl </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">xl </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_xl</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s1">ref_xm </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">xm </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_xm</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s1">ref_xr </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">xr </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_xr</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s1">ref_fl </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fl </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_fl</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">))</span>

        <span class="s1">ref_fm </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fm </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_fm</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fm</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">))</span>

        <span class="s1">ref_fr </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fr </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">ref_fr</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test cases that should produce different status flags; show that all</span>
        <span class="s5"># can be produced simultaneously.</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">js</span><span class="s2">):</span>
            <span class="s1">funcs </span><span class="s2">= [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: (</span><span class="s1">x </span><span class="s2">- </span><span class="s3">2.5</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">,</span>
                     <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">- </span><span class="s3">10</span><span class="s2">,</span>
                     <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: (</span><span class="s1">x </span><span class="s2">- </span><span class="s3">2.5</span><span class="s2">) ** </span><span class="s3">4</span><span class="s2">,</span>
                     <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>

            <span class="s0">return </span><span class="s2">[</span><span class="s1">funcs</span><span class="s2">[</span><span class="s1">j</span><span class="s2">](</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">js</span><span class="s2">)]</span>

        <span class="s1">args </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, [</span><span class="s3">0</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">,</span>
                                     <span class="s1">maxiter</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)</span>

        <span class="s1">ref_flags </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERGED</span><span class="s2">,</span>
                              <span class="s1">eim</span><span class="s2">.</span><span class="s1">_ESIGNERR</span><span class="s2">,</span>
                              <span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERR</span><span class="s2">,</span>
                              <span class="s1">eim</span><span class="s2">.</span><span class="s1">_EVALUEERR</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">, </span><span class="s1">ref_flags</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_convergence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test that the convergence tolerances behave as expected</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2585255913088665241</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">bracket </span><span class="s2">= (-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">p</span><span class="s2">,)</span>
        <span class="s1">kwargs0 </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xatol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">j1 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">j1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xatol'</span><span class="s2">])</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xatol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">j2 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">j2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xatol'</span><span class="s2">])</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">j2</span><span class="s2">, </span><span class="s1">j1</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xrtol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">j1 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">j1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xrtol'</span><span class="s2">]*</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xrtol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">j2 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">j2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xrtol'</span><span class="s2">]*</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">j2</span><span class="s2">, </span><span class="s1">j1</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'fatol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">h1 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fl </span><span class="s2">- </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fm </span><span class="s2">+ </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">h1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'fatol'</span><span class="s2">])</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'fatol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">h2 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fl </span><span class="s2">- </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fm </span><span class="s2">+ </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'fatol'</span><span class="s2">])</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">, </span><span class="s1">h1</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'frtol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">h1 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fl </span><span class="s2">- </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fm </span><span class="s2">+ </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">h1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'frtol'</span><span class="s2">]*</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">))</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'frtol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">h2 </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fl </span><span class="s2">- </span><span class="s3">2 </span><span class="s2">* </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fm </span><span class="s2">+ </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">)</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">*</span><span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'frtol'</span><span class="s2">]*</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">))</span>
        <span class="s1">assert_array_less</span><span class="s2">(</span><span class="s1">h2</span><span class="s2">, </span><span class="s1">h1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_maxiter_callback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test behavior of `maxiter` parameter and `callback` interface</span>
        <span class="s1">loc </span><span class="s2">= </span><span class="s3">0.612814</span>
        <span class="s1">bracket </span><span class="s2">= (-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">maxiter </span><span class="s2">= </span><span class="s3">5</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">loc</span><span class="s2">,),</span>
                                     <span class="s1">maxiter</span><span class="s2">=</span><span class="s1">maxiter</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">== </span><span class="s1">maxiter</span><span class="s2">+</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit </span><span class="s2">== </span><span class="s1">maxiter</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">callback</span><span class="s2">(</span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">callback</span><span class="s2">.</span><span class="s1">res </span><span class="s2">= </span><span class="s1">res</span>
            <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s4">'x'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s5"># callback is called once with initial bracket</span>
                <span class="s0">assert </span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">) == </span><span class="s1">bracket</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">changed_xr </span><span class="s2">= (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">== </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">) &amp; (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">!= </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">)</span>
                <span class="s1">changed_xl </span><span class="s2">= (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">!= </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">) &amp; (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">== </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">)</span>
                <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">changed_xr </span><span class="s2">| </span><span class="s1">changed_xl</span><span class="s2">)</span>

            <span class="s1">callback</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span>
            <span class="s1">callback</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status </span><span class="s2">== </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EINPROGRESS</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fm</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">)</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">== </span><span class="s1">maxiter</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">StopIteration</span>

        <span class="s1">callback</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">= -</span><span class="s3">1  </span><span class="s5"># callback called once before first iteration</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">res </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">loc</span><span class="s2">,),</span>
                                      <span class="s1">callback</span><span class="s2">=</span><span class="s1">callback</span><span class="s2">)</span>

        <span class="s5"># terminating with callback is identical to terminating due to maxiter</span>
        <span class="s5"># (except for `status`)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">res</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s4">'status'</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] == </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERR</span>
                <span class="s0">assert </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] == </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EINPROGRESS</span>
                <span class="s0">assert </span><span class="s1">res2</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] == </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECALLBACK</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">assert </span><span class="s1">res2</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] == </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] == </span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'case'</span><span class="s2">, </span><span class="s1">cases</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_nit_expected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">case</span><span class="s2">):</span>
        <span class="s5"># Test that `_chandrupatla` implements Chandrupatla's algorithm:</span>
        <span class="s5"># in all 55 test cases, the number of iterations performed</span>
        <span class="s5"># matches the number reported in the original paper.</span>
        <span class="s1">func</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">nit </span><span class="s2">= </span><span class="s1">case</span>

        <span class="s5"># Find bracket using the algorithm in the paper</span>
        <span class="s1">step </span><span class="s2">= </span><span class="s3">0.2</span>
        <span class="s1">x2 </span><span class="s2">= </span><span class="s1">x1 </span><span class="s2">+ </span><span class="s1">step</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">f1</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">f3 </span><span class="s2">= </span><span class="s1">_bracket_minimum</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">)</span>

        <span class="s5"># Use tolerances from original paper</span>
        <span class="s1">xatol </span><span class="s2">= </span><span class="s3">0.0001</span>
        <span class="s1">fatol </span><span class="s2">= </span><span class="s3">0.000001</span>
        <span class="s1">xrtol </span><span class="s2">= </span><span class="s3">1e-16</span>
        <span class="s1">frtol </span><span class="s2">= </span><span class="s3">1e-16</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">x3</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=</span><span class="s1">xatol</span><span class="s2">,</span>
                                     <span class="s1">fatol</span><span class="s2">=</span><span class="s1">fatol</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s1">xrtol</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s1">frtol</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">, </span><span class="s1">nit</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;loc&quot;</span><span class="s2">, (</span><span class="s3">0.65</span><span class="s2">, [</span><span class="s3">0.65</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">]))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float16</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
        <span class="s5"># Test that dtypes are preserved</span>

        <span class="s1">loc </span><span class="s2">= </span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
            <span class="s0">return </span><span class="s2">((</span><span class="s1">x </span><span class="s2">- </span><span class="s1">loc</span><span class="s2">) ** </span><span class="s3">2</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">(-</span><span class="s3">3</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">(</span><span class="s3">5</span><span class="s2">),</span>
                                     <span class="s1">args</span><span class="s2">=(</span><span class="s1">loc</span><span class="s2">,))</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">finfo</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">).</span><span class="s1">eps</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_input_validation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test input validation for appropriate error messages</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'`func` must be callable.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'Abscissae and function output must be real numbers.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">&quot;shape mismatch: objects cannot be broadcast&quot;</span>
        <span class="s5"># raised by `np.broadcast, but the traceback is readable IMO</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, [-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">&quot;The shape of the array returned by `func` must be the same&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]], [-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">],</span>
                                   <span class="s2">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], [</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'Tolerances must be non-negative scalars.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s4">'ekki'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'`maxiter` must be a non-negative integer.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'`callback` must be callable.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, -</span><span class="s3">4</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">=</span><span class="s4">'shrubbery'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bracket_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Confirm that order of points in bracket doesn't matter</span>
        <span class="s1">loc </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">)[:, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">newaxis</span><span class="s2">]</span>
        <span class="s1">brackets </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">permutations</span><span class="s2">([-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">5</span><span class="s2">]))).</span><span class="s1">T</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">brackets</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">loc</span><span class="s2">,))</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">) | (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">loc</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">)))</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[:, </span><span class="s3">0</span><span class="s2">]  </span><span class="s5"># all columns should be the same</span>
        <span class="s1">assert_allclose</span><span class="s2">(*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">broadcast_arrays</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_special_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s5"># Test edge cases and other special cases</span>

        <span class="s5"># Test that integers are not passed to `f`</span>
        <span class="s5"># (otherwise this would overflow)</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">issubdtype</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s3">1</span><span class="s2">) ** </span><span class="s3">100</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, -</span><span class="s3">7</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

        <span class="s5"># Test that if all elements of bracket equal minimizer, algorithm</span>
        <span class="s5"># reports convergence</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s3">1</span><span class="s2">)**</span><span class="s3">2</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s5"># Test maxiter = 0. Should do nothing to bracket.</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s3">1</span><span class="s2">)**</span><span class="s3">2</span>

        <span class="s1">bracket </span><span class="s2">= (-</span><span class="s3">3</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">== </span><span class="s1">bracket</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit </span><span class="s2">== </span><span class="s3">0</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">== </span><span class="s3">3</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status </span><span class="s2">== -</span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x </span><span class="s2">== </span><span class="s3">1.1  </span><span class="s5"># best so far</span>

        <span class="s5"># Test scalar `args` (not in tuple)</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s1">c</span><span class="s2">)**</span><span class="s3">2 </span><span class="s2">- </span><span class="s3">1</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, -</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">)</span>

        <span class="s5"># Test zero tolerances</span>
        <span class="s5"># TODO: fatol/frtol = 0?</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_minimize</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">,</span>
                                     <span class="s1">fatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span>
        <span class="s5"># found a minimum exactly (according to floating point arithmetic)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">&lt; </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm </span><span class="s2">&lt; </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span>
        <span class="s0">assert </span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">) == </span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xm</span><span class="s2">) == </span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">array_api_compatible</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">usefixtures</span><span class="s2">(</span><span class="s4">&quot;skip_xp_backends&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">skip_xp_backends</span><span class="s2">(</span><span class="s4">'array_api_strict'</span><span class="s2">, </span><span class="s4">'jax.numpy'</span><span class="s2">,</span>
                              <span class="s1">reasons</span><span class="s2">=[</span><span class="s4">'Currently uses fancy indexing assignment.'</span><span class="s2">,</span>
                                       <span class="s4">'JAX arrays do not support item assignment.'</span><span class="s2">])</span>
<span class="s0">class </span><span class="s1">TestChandrupatla</span><span class="s2">(</span><span class="s1">TestScalarRootFinders</span><span class="s2">):</span>

    <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">q</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
        <span class="s0">return </span><span class="s1">special</span><span class="s2">.</span><span class="s1">ndtr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">) - </span><span class="s1">p</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'p'</span><span class="s2">, [</span><span class="s3">0.6</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">1.05</span><span class="s2">, </span><span class="s3">10</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_basic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Invert distribution CDF and compare against distrtibution `ppf`</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">5.</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">p</span><span class="s2">),))</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">stats</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">().</span><span class="s1">ppf</span><span class="s2">(</span><span class="s1">p</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">p</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ref</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'shape'</span><span class="s2">, [</span><span class="s1">tuple</span><span class="s2">(), (</span><span class="s3">12</span><span class="s2">,), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">), (</span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_vectorization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">shape</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test for correct functionality, output shapes, and dtypes for various</span>
        <span class="s5"># input shapes.</span>
        <span class="s1">p </span><span class="s2">= (</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">1.05</span><span class="s2">, </span><span class="s3">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">shape</span><span class="s2">) </span><span class="s0">if </span><span class="s1">shape</span>
             <span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">(</span><span class="s3">0.6</span><span class="s2">))</span>
        <span class="s1">p_xp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
        <span class="s1">args_xp </span><span class="s2">= (</span><span class="s1">p_xp</span><span class="s2">,)</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">p_xp</span><span class="s2">.</span><span class="s1">dtype</span>
        <span class="s1">xp_test </span><span class="s2">= </span><span class="s1">array_namespace</span><span class="s2">(</span><span class="s1">p_xp</span><span class="s2">)  </span><span class="s5"># need xp.bool</span>

        <span class="s2">@</span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span>
        <span class="s0">def </span><span class="s1">chandrupatla_single</span><span class="s2">(</span><span class="s1">p</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, -</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">p</span><span class="s2">,))</span>

        <span class="s0">def </span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">):</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">5.</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=</span><span class="s1">args_xp</span><span class="s2">)</span>
        <span class="s1">refs </span><span class="s2">= </span><span class="s1">chandrupatla_single</span><span class="s2">(</span><span class="s1">p</span><span class="s2">).</span><span class="s1">ravel</span><span class="s2">()</span>

        <span class="s1">ref_x </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">x </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_x </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_x</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">ref_x</span><span class="s2">)</span>

        <span class="s1">ref_fun </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fun </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_fun </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_fun</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">ref_fun</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-15</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, *</span><span class="s1">args_xp</span><span class="s2">))</span>

        <span class="s1">ref_success </span><span class="s2">= [</span><span class="s1">bool</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">success</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_success </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_success</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp_test</span><span class="s2">.</span><span class="s1">bool</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">, </span><span class="s1">ref_success</span><span class="s2">)</span>

        <span class="s1">ref_flag </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">status </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_flag </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_flag</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">, </span><span class="s1">ref_flag</span><span class="s2">)</span>

        <span class="s1">ref_nfev </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">nfev </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_nfev </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_nfev</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">):</span>
            <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">ref_nfev</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">) == </span><span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals</span>
        <span class="s0">else</span><span class="s2">:  </span><span class="s5"># different backend may lead to different nfev</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">shape</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span>

        <span class="s1">ref_nit </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">nit </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_nit </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_nit</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">):</span>
            <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">, </span><span class="s1">ref_nit</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">max</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">) == </span><span class="s1">f</span><span class="s2">.</span><span class="s1">f_evals</span><span class="s2">-</span><span class="s3">2</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">shape</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span>

        <span class="s1">ref_xl </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">xl </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_xl </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_xl</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">ref_xl</span><span class="s2">)</span>

        <span class="s1">ref_xr </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">xr </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_xr </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_xr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">, </span><span class="s1">ref_xr</span><span class="s2">)</span>

        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">)</span>
        <span class="s1">finite </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">((</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">] == </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">])</span>
                      <span class="s2">| (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">] == </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">]))</span>

        <span class="s5"># PyTorch and CuPy don't solve to the same accuracy as NumPy - that's OK.</span>
        <span class="s1">atol </span><span class="s2">= </span><span class="s3">1e-15 </span><span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">) </span><span class="s0">else </span><span class="s3">1e-9</span>

        <span class="s1">ref_fl </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fl </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_fl </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_fl</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">, </span><span class="s1">ref_fl</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, *</span><span class="s1">args_xp</span><span class="s2">))</span>

        <span class="s1">ref_fr </span><span class="s2">= [</span><span class="s1">ref</span><span class="s2">.</span><span class="s1">fr </span><span class="s0">for </span><span class="s1">ref </span><span class="s0">in </span><span class="s1">refs</span><span class="s2">]</span>
        <span class="s1">ref_fr </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ref_fr</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">shape</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">, </span><span class="s1">ref_fr</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">, *</span><span class="s1">args_xp</span><span class="s2">))</span>

        <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">]) ==</span>
                      <span class="s1">xp_minimum</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">]),</span>
                                 <span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">[</span><span class="s1">finite</span><span class="s2">])))</span>

    <span class="s0">def </span><span class="s1">test_flags</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test cases that should produce different status flags; show that all</span>
        <span class="s5"># can be produced simultaneously.</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">js</span><span class="s2">):</span>
            <span class="s5"># Note that full_like and int(j) shouldn't really be required. CuPy</span>
            <span class="s5"># is just really picky here, so I'm making it a special case to</span>
            <span class="s5"># make sure the other backends work when the user is less careful.</span>
            <span class="s0">assert </span><span class="s1">js</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int64</span>
            <span class="s0">if </span><span class="s1">is_cupy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">):</span>
                <span class="s1">funcs </span><span class="s2">= [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">- </span><span class="s3">2.5</span><span class="s2">,</span>
                         <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">- </span><span class="s3">10</span><span class="s2">,</span>
                         <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: (</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.1</span><span class="s2">)**</span><span class="s3">3</span><span class="s2">,</span>
                         <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)]</span>
                <span class="s0">return </span><span class="s2">[</span><span class="s1">funcs</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">j</span><span class="s2">)](</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">js</span><span class="s2">)]</span>

            <span class="s1">funcs </span><span class="s2">= [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">- </span><span class="s3">2.5</span><span class="s2">,</span>
                     <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x </span><span class="s2">- </span><span class="s3">10</span><span class="s2">,</span>
                     <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: (</span><span class="s1">x </span><span class="s2">- </span><span class="s3">0.1</span><span class="s2">) ** </span><span class="s3">3</span><span class="s2">,</span>
                     <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]</span>
            <span class="s0">return </span><span class="s2">[</span><span class="s1">funcs</span><span class="s2">[</span><span class="s1">j</span><span class="s2">](</span><span class="s1">x</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">xs</span><span class="s2">, </span><span class="s1">js</span><span class="s2">)]</span>

        <span class="s1">args </span><span class="s2">= (</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">4</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">),)</span>
        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0.</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">]*</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

        <span class="s1">ref_flags </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERGED</span><span class="s2">,</span>
                                <span class="s1">eim</span><span class="s2">.</span><span class="s1">_ESIGNERR</span><span class="s2">,</span>
                                <span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERR</span><span class="s2">,</span>
                                <span class="s1">eim</span><span class="s2">.</span><span class="s1">_EVALUEERR</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">, </span><span class="s1">ref_flags</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_convergence</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test that the convergence tolerances behave as expected</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s3">2585255913088665241</span><span class="s2">)</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">bracket </span><span class="s2">= (-</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">))</span>
        <span class="s1">args </span><span class="s2">= (</span><span class="s1">p</span><span class="s2">,)</span>
        <span class="s1">kwargs0 </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">args</span><span class="s2">=</span><span class="s1">args</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xatol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">1e-3</span><span class="s2">))</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xatol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">1e-6</span><span class="s2">))</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xrtol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s3">1e-3 </span><span class="s2">* </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'xrtol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s3">1e-6 </span><span class="s2">* </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">x</span><span class="s2">))</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res2</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">- </span><span class="s1">res1</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">)</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'fatol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">1e-3</span><span class="s2">))</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'fatol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full_like</span><span class="s2">(</span><span class="s1">p</span><span class="s2">, </span><span class="s3">1e-6</span><span class="s2">))</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">))</span>

        <span class="s1">kwargs </span><span class="s2">= </span><span class="s1">kwargs0</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'frtol'</span><span class="s2">] = </span><span class="s3">1e-3</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 </span><span class="s2">= </span><span class="s1">bracket</span>
        <span class="s1">f0 </span><span class="s2">= </span><span class="s1">xp_minimum</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">x1</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">)), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">x2</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">)))</span>
        <span class="s1">res1 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">), </span><span class="s3">1e-3</span><span class="s2">*</span><span class="s1">f0</span><span class="s2">)</span>
        <span class="s1">kwargs</span><span class="s2">[</span><span class="s4">'frtol'</span><span class="s2">] = </span><span class="s3">1e-6</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">), </span><span class="s3">1e-6</span><span class="s2">*</span><span class="s1">f0</span><span class="s2">)</span>
        <span class="s1">xp_assert_less</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_maxiter_callback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test behavior of `maxiter` parameter and `callback` interface</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">0.612814</span><span class="s2">)</span>
        <span class="s1">bracket </span><span class="s2">= (</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">5.</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">))</span>
        <span class="s1">maxiter </span><span class="s2">= </span><span class="s3">5</span>

        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">q</span><span class="s2">, </span><span class="s1">p</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">special</span><span class="s2">.</span><span class="s1">ndtr</span><span class="s2">(</span><span class="s1">q</span><span class="s2">) - </span><span class="s1">p</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s1">q</span>
            <span class="s1">f</span><span class="s2">.</span><span class="s1">fun </span><span class="s2">= </span><span class="s1">res</span>
            <span class="s0">return </span><span class="s1">res</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">x </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">f</span><span class="s2">.</span><span class="s1">fun </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">p</span><span class="s2">,), </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s1">maxiter</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">any</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev </span><span class="s2">== </span><span class="s1">maxiter</span><span class="s2">+</span><span class="s3">2</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit </span><span class="s2">== </span><span class="s1">maxiter</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">callback</span><span class="s2">(</span><span class="s1">res</span><span class="s2">):</span>
            <span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">+= </span><span class="s3">1</span>
            <span class="s1">callback</span><span class="s2">.</span><span class="s1">res </span><span class="s2">= </span><span class="s1">res</span>
            <span class="s0">assert </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s4">'x'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s5"># callback is called once with initial bracket</span>
                <span class="s0">assert </span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">) == </span><span class="s1">bracket</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">changed </span><span class="s2">= (((</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">== </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">) &amp; (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">!= </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">))</span>
                           <span class="s2">| ((</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">!= </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">) &amp; (</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">== </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">)))</span>
                <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">changed</span><span class="s2">)</span>

            <span class="s1">callback</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span>
            <span class="s1">callback</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">= </span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">status </span><span class="s2">== </span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_EINPROGRESS</span>
            <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fl</span><span class="s2">)</span>
            <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fr</span><span class="s2">)</span>
            <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">f</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">p</span><span class="s2">), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">== </span><span class="s1">maxiter</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">StopIteration</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">iter </span><span class="s2">= -</span><span class="s3">1  </span><span class="s5"># callback called once before first iteration</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">res </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">xl </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">callback</span><span class="s2">.</span><span class="s1">xr </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">p</span><span class="s2">,), </span><span class="s1">callback</span><span class="s2">=</span><span class="s1">callback</span><span class="s2">)</span>

        <span class="s5"># terminating with callback is identical to terminating due to maxiter</span>
        <span class="s5"># (except for `status`)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">res</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s4">'status'</span><span class="s2">:</span>
                <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECONVERR</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
                <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">eim</span><span class="s2">.</span><span class="s1">_ECALLBACK</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
            <span class="s0">elif </span><span class="s1">key</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">'_'</span><span class="s2">):</span>
                <span class="s0">continue</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">[</span><span class="s1">key</span><span class="s2">], </span><span class="s1">res</span><span class="s2">[</span><span class="s1">key</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'case'</span><span class="s2">, </span><span class="s1">_CHANDRUPATLA_TESTS</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_nit_expected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">case</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test that `_chandrupatla` implements Chandrupatla's algorithm:</span>
        <span class="s5"># in all 40 test cases, the number of iterations performed</span>
        <span class="s5"># matches the number reported in the original paper.</span>
        <span class="s1">f</span><span class="s2">, </span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">root</span><span class="s2">, </span><span class="s1">nfeval</span><span class="s2">, </span><span class="s1">id </span><span class="s2">= </span><span class="s1">case</span>
        <span class="s5"># Chandrupatla's criterion is equivalent to</span>
        <span class="s5"># abs(x2-x1) &lt; 4*abs(xmin)*xrtol + xatol, but we use the more standard</span>
        <span class="s5"># abs(x2-x1) &lt; abs(xmin)*xrtol + xatol. Therefore, set xrtol to 4x</span>
        <span class="s5"># that used by Chandrupatla in tests.</span>
        <span class="s1">bracket </span><span class="s2">= (</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">bracket</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                   <span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">bracket</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">))</span>
        <span class="s1">root </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s3">4e-10</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=</span><span class="s3">1e-5</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">f</span><span class="s2">(</span><span class="s1">root</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
                        <span class="s1">rtol</span><span class="s2">=</span><span class="s3">1e-8</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">2e-3</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">nfeval</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;root&quot;</span><span class="s2">, (</span><span class="s3">0.622</span><span class="s2">, [</span><span class="s3">0.622</span><span class="s2">, </span><span class="s3">0.623</span><span class="s2">]))</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;dtype&quot;</span><span class="s2">, (</span><span class="s4">'float16'</span><span class="s2">, </span><span class="s4">'float32'</span><span class="s2">, </span><span class="s4">'float64'</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_dtype</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">root</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test that dtypes are preserved</span>
        <span class="s1">not_numpy </span><span class="s2">= </span><span class="s0">not </span><span class="s1">is_numpy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">not_numpy </span><span class="s0">and </span><span class="s1">dtype </span><span class="s2">== </span><span class="s4">'float16'</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;`float16` dtype only supported for NumPy arrays.&quot;</span><span class="s2">)</span>

        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">xp</span><span class="s0">} </span><span class="s4">does not support </span><span class="s0">{</span><span class="s1">dtype</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">root</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= (</span><span class="s1">x </span><span class="s2">- </span><span class="s1">root</span><span class="s2">) ** </span><span class="s3">3.</span>
            <span class="s0">if </span><span class="s1">is_numpy</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">):  </span><span class="s5"># NumPy does not preserve dtype</span>
                <span class="s0">return </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">res</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">root </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">root</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">root</span><span class="s2">,), </span><span class="s1">xatol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">root</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s3">1e-3</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">AssertionError</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">dtype</span>
            <span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">fun </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_input_validation</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test input validation for appropriate error messages</span>

        <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">x</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'`func` must be callable.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">bracket </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">4</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">4</span><span class="s2">)</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s0">None</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'Abscissae and function output must be real numbers.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">bracket </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">4</span><span class="s2">+</span><span class="s3">1j</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">4</span><span class="s2">)</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">)</span>

        <span class="s5"># raised by `np.broadcast, but the traceback is readable IMO</span>
        <span class="s1">message </span><span class="s2">= </span><span class="s4">&quot;...not be broadcast...&quot;  </span><span class="s5"># all messages include this part</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">((</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">RuntimeError</span><span class="s2">), </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">bracket </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([-</span><span class="s3">2</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">]), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">&quot;The shape of the array returned by `func`...&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">bracket </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([-</span><span class="s3">3</span><span class="s2">, -</span><span class="s3">3</span><span class="s2">]), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]], *</span><span class="s1">bracket</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'Tolerances must be non-negative scalars.'</span>
        <span class="s1">bracket </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">4</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">4</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">xatol</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">xrtol</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">fatol</span><span class="s2">=</span><span class="s4">'ekki'</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">frtol</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'`maxiter` must be a non-negative integer.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=-</span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">message </span><span class="s2">= </span><span class="s4">'`callback` must be callable.'</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">):</span>
            <span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">func</span><span class="s2">, *</span><span class="s1">bracket</span><span class="s2">, </span><span class="s1">callback</span><span class="s2">=</span><span class="s4">'shrubbery'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_special_cases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">):</span>
        <span class="s5"># Test edge cases and other special cases</span>

        <span class="s5"># Test infinite function values</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s3">1 </span><span class="s2">/ </span><span class="s1">x </span><span class="s2">+ </span><span class="s3">1 </span><span class="s2">- </span><span class="s3">1 </span><span class="s2">/ (-</span><span class="s1">x </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">]),  </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">])</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">divide</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">, </span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">)</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s3">1</span><span class="s2">:], </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">full</span><span class="s2">((</span><span class="s3">3</span><span class="s2">,), </span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]))</span>

        <span class="s5"># Test that integers are not passed to `f`</span>
        <span class="s5"># (otherwise this would overflow)</span>
        <span class="s1">xp_test </span><span class="s2">= </span><span class="s1">array_namespace</span><span class="s2">(</span><span class="s1">a</span><span class="s2">)  </span><span class="s5"># need isdtype</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">xp_test</span><span class="s2">.</span><span class="s1">isdtype</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, </span><span class="s4">&quot;real floating&quot;</span><span class="s2">)</span>
            <span class="s5"># this would overflow if x were an xp integer dtype</span>
            <span class="s0">return </span><span class="s1">x </span><span class="s2">** </span><span class="s3">31 </span><span class="s2">- </span><span class="s3">1</span>

        <span class="s5"># note that all inputs are integer type; result is automatically default float</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">7</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">))</span>

        <span class="s5"># Test that if both ends of bracket equal root, algorithm reports</span>
        <span class="s5"># convergence.</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">root</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">x</span><span class="s2">**</span><span class="s3">2 </span><span class="s2">- </span><span class="s1">root</span>

        <span class="s1">root </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=(</span><span class="s1">root</span><span class="s2">,))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">]))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">]))</span>

        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s3">1</span><span class="s2">/</span><span class="s1">x</span>

        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s4">'ignore'</span><span class="s2">):</span>
            <span class="s1">inf </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">)</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">, </span><span class="s1">inf</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">))</span>

        <span class="s5"># Test maxiter = 0. Should do nothing to bracket.</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">x</span><span class="s2">**</span><span class="s3">3 </span><span class="s2">- </span><span class="s3">1</span>

        <span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">3.</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">5.</span><span class="s2">)</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s0">False</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xl</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">xr</span><span class="s2">, </span><span class="s1">b</span><span class="s2">)</span>
        <span class="s5"># The `x` attribute is the one with the smaller function value</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">a</span><span class="s2">)</span>
        <span class="s5"># Reverse bracket; check that this is still true</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, -</span><span class="s1">b</span><span class="s2">, -</span><span class="s1">a</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, -</span><span class="s1">a</span><span class="s2">)</span>

        <span class="s5"># Test maxiter = 1</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">maxiter</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">success</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s0">True</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">status</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nit</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">xp_assert_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">nfev</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">3</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">))</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1.</span><span class="s2">))</span>

        <span class="s5"># Test scalar `args` (not in tuple)</span>
        <span class="s0">def </span><span class="s1">f</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">c</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">c</span><span class="s2">*</span><span class="s1">x </span><span class="s2">- </span><span class="s3">1</span>

        <span class="s1">res </span><span class="s2">= </span><span class="s1">_chandrupatla_root</span><span class="s2">(</span><span class="s1">f</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(-</span><span class="s3">1</span><span class="s2">), </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">), </span><span class="s1">args</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">3</span><span class="s2">))</span>
        <span class="s1">xp_assert_close</span><span class="s2">(</span><span class="s1">res</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s3">1</span><span class="s2">/</span><span class="s3">3</span><span class="s2">))</span>

        <span class="s5"># # TODO: Test zero tolerance</span>
        <span class="s5"># # ~~What's going on here - why are iterations repeated?~~</span>
        <span class="s5"># # tl goes to zero when xatol=xrtol=0. When function is nearly linear,</span>
        <span class="s5"># # this causes convergence issues.</span>
        <span class="s5"># def f(x):</span>
        <span class="s5">#     return np.cos(x)</span>
        <span class="s5">#</span>
        <span class="s5"># res = _chandrupatla_root(f, 0, np.pi, xatol=0, xrtol=0)</span>
        <span class="s5"># assert res.nit &lt; 100</span>
        <span class="s5"># xp = np.nextafter(res.x, np.inf)</span>
        <span class="s5"># xm = np.nextafter(res.x, -np.inf)</span>
        <span class="s5"># assert np.abs(res.fun) &lt; np.abs(f(xp))</span>
        <span class="s5"># assert np.abs(res.fun) &lt; np.abs(f(xm))</span>
</pre>
</body>
</html>