<html>
<head>
<title>connection.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #cf8e6d;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
connection.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2023, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s0"># mypy: disable-error-code=&quot;arg-type,operator,attr-defined,assignment&quot;</span>

<span class="s2">&quot;&quot;&quot;Implemention of the communication with MySQL servers in pure Python.&quot;&quot;&quot;</span>

<span class="s1">__all__ </span><span class="s3">= [</span><span class="s4">&quot;MySQLConnection&quot;</span><span class="s3">]</span>

<span class="s5">import </span><span class="s1">asyncio</span>
<span class="s5">import </span><span class="s1">contextlib</span>
<span class="s5">import </span><span class="s1">datetime</span>
<span class="s5">import </span><span class="s1">getpass</span>
<span class="s5">import </span><span class="s1">os</span>
<span class="s5">import </span><span class="s1">socket</span>
<span class="s5">import </span><span class="s1">struct</span>
<span class="s5">import </span><span class="s1">warnings</span>

<span class="s5">from </span><span class="s1">decimal </span><span class="s5">import </span><span class="s1">Decimal</span>
<span class="s5">from </span><span class="s1">io </span><span class="s5">import </span><span class="s1">IOBase</span>
<span class="s5">from </span><span class="s1">typing </span><span class="s5">import </span><span class="s3">(</span>
    <span class="s1">Any</span><span class="s3">,</span>
    <span class="s1">AsyncGenerator</span><span class="s3">,</span>
    <span class="s1">BinaryIO</span><span class="s3">,</span>
    <span class="s1">Callable</span><span class="s3">,</span>
    <span class="s1">Dict</span><span class="s3">,</span>
    <span class="s1">List</span><span class="s3">,</span>
    <span class="s1">Mapping</span><span class="s3">,</span>
    <span class="s1">Optional</span><span class="s3">,</span>
    <span class="s1">Sequence</span><span class="s3">,</span>
    <span class="s1">Tuple</span><span class="s3">,</span>
    <span class="s1">Type</span><span class="s3">,</span>
    <span class="s1">Union</span><span class="s3">,</span>
<span class="s3">)</span>

<span class="s5">from </span><span class="s3">.. </span><span class="s5">import </span><span class="s1">version</span>
<span class="s5">from </span><span class="s3">..</span><span class="s1">constants </span><span class="s5">import </span><span class="s3">(</span>
    <span class="s1">ClientFlag</span><span class="s3">,</span>
    <span class="s1">FieldType</span><span class="s3">,</span>
    <span class="s1">RefreshOption</span><span class="s3">,</span>
    <span class="s1">ServerCmd</span><span class="s3">,</span>
    <span class="s1">ServerFlag</span><span class="s3">,</span>
    <span class="s1">flag_is_set</span><span class="s3">,</span>
    <span class="s1">raise_warning_against_deprecated_cursor_class</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s5">from </span><span class="s3">..</span><span class="s1">errors </span><span class="s5">import </span><span class="s3">(</span>
    <span class="s1">DatabaseError</span><span class="s3">,</span>
    <span class="s1">Error</span><span class="s3">,</span>
    <span class="s1">InterfaceError</span><span class="s3">,</span>
    <span class="s1">InternalError</span><span class="s3">,</span>
    <span class="s1">NotSupportedError</span><span class="s3">,</span>
    <span class="s1">OperationalError</span><span class="s3">,</span>
    <span class="s1">ProgrammingError</span><span class="s3">,</span>
    <span class="s1">get_exception</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s5">from </span><span class="s3">..</span><span class="s1">types </span><span class="s5">import </span><span class="s3">(</span>
    <span class="s1">BinaryProtocolType</span><span class="s3">,</span>
    <span class="s1">DescriptionType</span><span class="s3">,</span>
    <span class="s1">EofPacketType</span><span class="s3">,</span>
    <span class="s1">OkPacketType</span><span class="s3">,</span>
    <span class="s1">ResultType</span><span class="s3">,</span>
    <span class="s1">RowType</span><span class="s3">,</span>
    <span class="s1">StatsPacketType</span><span class="s3">,</span>
    <span class="s1">StrOrBytes</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s5">from </span><span class="s3">..</span><span class="s1">utils </span><span class="s5">import </span><span class="s3">(</span>
    <span class="s1">get_platform</span><span class="s3">,</span>
    <span class="s1">int1store</span><span class="s3">,</span>
    <span class="s1">int4store</span><span class="s3">,</span>
    <span class="s1">lc_int</span><span class="s3">,</span>
    <span class="s1">warn_ciphersuites_deprecated</span><span class="s3">,</span>
    <span class="s1">warn_tls_version_deprecated</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s5">from </span><span class="s3">.</span><span class="s1">abstracts </span><span class="s5">import </span><span class="s1">MySQLConnectionAbstract</span><span class="s3">, </span><span class="s1">MySQLCursorAbstract</span><span class="s3">, </span><span class="s1">ServerInfo</span>
<span class="s5">from </span><span class="s3">.</span><span class="s1">charsets </span><span class="s5">import </span><span class="s1">charsets</span>
<span class="s5">from </span><span class="s3">.</span><span class="s1">cursor </span><span class="s5">import </span><span class="s3">(</span>
    <span class="s1">MySQLCursor</span><span class="s3">,</span>
    <span class="s1">MySQLCursorBuffered</span><span class="s3">,</span>
    <span class="s1">MySQLCursorBufferedDict</span><span class="s3">,</span>
    <span class="s1">MySQLCursorBufferedNamedTuple</span><span class="s3">,</span>
    <span class="s1">MySQLCursorBufferedRaw</span><span class="s3">,</span>
    <span class="s1">MySQLCursorDict</span><span class="s3">,</span>
    <span class="s1">MySQLCursorNamedTuple</span><span class="s3">,</span>
    <span class="s1">MySQLCursorPrepared</span><span class="s3">,</span>
    <span class="s1">MySQLCursorPreparedDict</span><span class="s3">,</span>
    <span class="s1">MySQLCursorPreparedNamedTuple</span><span class="s3">,</span>
    <span class="s1">MySQLCursorPreparedRaw</span><span class="s3">,</span>
    <span class="s1">MySQLCursorRaw</span><span class="s3">,</span>
<span class="s3">)</span>
<span class="s5">from </span><span class="s3">.</span><span class="s1">logger </span><span class="s5">import </span><span class="s1">logger</span>
<span class="s5">from </span><span class="s3">.</span><span class="s1">network </span><span class="s5">import </span><span class="s1">MySQLTcpSocket</span><span class="s3">, </span><span class="s1">MySQLUnixSocket</span>


<span class="s5">class </span><span class="s1">MySQLConnection</span><span class="s3">(</span><span class="s1">MySQLConnectionAbstract</span><span class="s3">):</span>
    <span class="s2">&quot;&quot;&quot;Implementation of the pure Python MySQL connection.&quot;&quot;&quot;</span>

    <span class="s1">_mfa_nfactor</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span>

    <span class="s3">@</span><span class="s1">property</span>
    <span class="s5">def </span><span class="s1">connection_id</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">]:</span>
        <span class="s2">&quot;&quot;&quot;MySQL connection ID.&quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">&quot;server_threadid&quot;</span><span class="s3">)  </span><span class="s0"># type: ignore[return-value]</span>
        <span class="s5">return None</span>

    <span class="s5">async def </span><span class="s1">connect</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_unix_socket </span><span class="s5">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;posix&quot;</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket </span><span class="s3">= </span><span class="s1">MySQLUnixSocket</span><span class="s3">(</span><span class="s1">unix_socket</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_unix_socket</span><span class="s3">)</span>
            <span class="s5">else</span><span class="s3">:</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket </span><span class="s3">= </span><span class="s1">MySQLTcpSocket</span><span class="s3">(</span><span class="s1">host</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_host</span><span class="s3">, </span><span class="s1">port</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_port</span><span class="s3">)</span>
            <span class="s5">await </span><span class="s1">asyncio</span><span class="s3">.</span><span class="s1">wait_for</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">open_connection</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connection_timeout</span>
            <span class="s3">)</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_do_handshake</span><span class="s3">()</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_do_auth</span><span class="s3">()</span>
        <span class="s5">except </span><span class="s3">(</span><span class="s1">asyncio</span><span class="s3">.</span><span class="s1">CancelledError</span><span class="s3">, </span><span class="s1">asyncio</span><span class="s3">.</span><span class="s1">TimeoutError</span><span class="s3">):</span>
            <span class="s5">raise</span>
        <span class="s5">except </span><span class="s1">Exception</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">close_connection</span><span class="s3">()</span>
            <span class="s5">raise</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">COMPRESS</span><span class="s3">:</span>
            <span class="s0"># Update the network layer accordingly</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">switch_to_compressed_mode</span><span class="s3">()</span>

        <span class="s0"># Set converter class</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">set_converter_class</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_converter_class</span><span class="s3">)</span>
        <span class="s5">except </span><span class="s1">TypeError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">AttributeError</span><span class="s3">(</span>
                <span class="s4">&quot;Converter classA should be a subclass of &quot;</span>
                <span class="s4">&quot;conversion.MySQLConverterBase&quot;</span>
            <span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

        <span class="s0"># Post connection settings</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_post_connection</span><span class="s3">()</span>

        <span class="s0"># pylint: disable=protected-access</span>
        <span class="s5">if </span><span class="s3">(</span>
            <span class="s5">not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_disabled</span>
            <span class="s5">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">_writer</span><span class="s3">, </span><span class="s4">&quot;get_extra_info&quot;</span><span class="s3">)</span>
            <span class="s5">and </span><span class="s1">callable</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">_writer</span><span class="s3">.</span><span class="s1">get_extra_info</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s0"># Raise a deprecation warning if deprecated TLS version</span>
            <span class="s0"># or cipher is being used.</span>

            <span class="s0"># `get_extra_info(&quot;cipher&quot;)` returns a three-value tuple containing the name</span>
            <span class="s0"># of the cipher being used, the version of the SSL protocol</span>
            <span class="s0"># that defines its use, and the number of secret bits being used.</span>
            <span class="s1">cipher</span><span class="s3">, </span><span class="s1">tls_version</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">_writer</span><span class="s3">.</span><span class="s1">get_extra_info</span><span class="s3">(</span><span class="s4">&quot;cipher&quot;</span><span class="s3">)</span>
            <span class="s1">warn_tls_version_deprecated</span><span class="s3">(</span><span class="s1">tls_version</span><span class="s3">)</span>
            <span class="s1">warn_ciphersuites_deprecated</span><span class="s3">(</span><span class="s1">cipher</span><span class="s3">, </span><span class="s1">tls_version</span><span class="s3">)</span>

    <span class="s5">def </span><span class="s1">_add_default_conn_attrs</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Add the default connection attributes.&quot;&quot;&quot;</span>
        <span class="s1">platform </span><span class="s3">= </span><span class="s1">get_platform</span><span class="s3">()</span>
        <span class="s1">license_chunks </span><span class="s3">= </span><span class="s1">version</span><span class="s3">.</span><span class="s1">LICENSE</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">&quot; &quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">license_chunks</span><span class="s3">[</span><span class="s6">0</span><span class="s3">] == </span><span class="s4">&quot;GPLv2&quot;</span><span class="s3">:</span>
            <span class="s1">client_license </span><span class="s3">= </span><span class="s4">&quot;GPL-2.0&quot;</span>
        <span class="s5">else</span><span class="s3">:</span>
            <span class="s1">client_license </span><span class="s3">= </span><span class="s4">&quot;Commercial&quot;</span>
        <span class="s1">default_conn_attrs </span><span class="s3">= {</span>
            <span class="s4">&quot;_pid&quot;</span><span class="s3">: </span><span class="s1">str</span><span class="s3">(</span><span class="s1">os</span><span class="s3">.</span><span class="s1">getpid</span><span class="s3">()),</span>
            <span class="s4">&quot;_platform&quot;</span><span class="s3">: </span><span class="s1">platform</span><span class="s3">[</span><span class="s4">&quot;arch&quot;</span><span class="s3">],</span>
            <span class="s4">&quot;_source_host&quot;</span><span class="s3">: </span><span class="s1">socket</span><span class="s3">.</span><span class="s1">gethostname</span><span class="s3">(),</span>
            <span class="s4">&quot;_client_name&quot;</span><span class="s3">: </span><span class="s4">&quot;mysql-connector-python&quot;</span><span class="s3">,</span>
            <span class="s4">&quot;_client_license&quot;</span><span class="s3">: </span><span class="s1">client_license</span><span class="s3">,</span>
            <span class="s4">&quot;_client_version&quot;</span><span class="s3">: </span><span class="s4">&quot;.&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s1">str</span><span class="s3">(</span><span class="s1">x</span><span class="s3">) </span><span class="s5">for </span><span class="s1">x </span><span class="s5">in </span><span class="s1">version</span><span class="s3">.</span><span class="s1">VERSION</span><span class="s3">[</span><span class="s6">0</span><span class="s3">:</span><span class="s6">3</span><span class="s3">]]),</span>
            <span class="s4">&quot;_os&quot;</span><span class="s3">: </span><span class="s1">platform</span><span class="s3">[</span><span class="s4">&quot;version&quot;</span><span class="s3">],</span>
        <span class="s3">}</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_connection_attrs</span><span class="s3">.</span><span class="s1">update</span><span class="s3">((</span><span class="s1">default_conn_attrs</span><span class="s3">))</span>

    <span class="s5">async def </span><span class="s1">_execute_query</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">query</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; ResultType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Execute a query. 
 
        This method simply calls cmd_query() after checking for unread result. If there 
        are still unread result, an InterfaceError is raised. Otherwise whatever 
        cmd_query() returns is returned. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>
        <span class="s5">return await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s1">query</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">_do_handshake</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Get the handshake from the MySQL server.&quot;&quot;&quot;</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;Protocol::Handshake packet: %s&quot;</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">255</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_handshake</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info </span><span class="s3">= </span><span class="s1">ServerInfo</span><span class="s3">(</span>
            <span class="s1">protocol</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;protocol&quot;</span><span class="s3">],</span>
            <span class="s1">version</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;server_version_original&quot;</span><span class="s3">],</span>
            <span class="s1">thread_id</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;server_threadid&quot;</span><span class="s3">],</span>
            <span class="s1">charset</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;charset&quot;</span><span class="s3">],</span>
            <span class="s1">status_flags</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;server_status&quot;</span><span class="s3">],</span>
            <span class="s1">auth_plugin</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;auth_plugin&quot;</span><span class="s3">],</span>
            <span class="s1">auth_data</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;auth_data&quot;</span><span class="s3">],</span>
            <span class="s1">capabilities</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">],</span>
        <span class="s3">)</span>

        <span class="s0"># Set the charsets for the correspondent server major version</span>
        <span class="s1">charsets</span><span class="s3">.</span><span class="s1">set_mysql_major_version</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info</span><span class="s3">.</span><span class="s1">version_tuple</span><span class="s3">[</span><span class="s6">0</span><span class="s3">])</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;Protocol::Handshake charset: %s&quot;</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info</span><span class="s3">.</span><span class="s1">charset</span><span class="s3">)</span>

        <span class="s0"># Set charset if provided else use the server default</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_name </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_collation</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_charset </span><span class="s3">= </span><span class="s1">charsets</span><span class="s3">.</span><span class="s1">get_by_name_and_collation</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_name</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_collation</span>
            <span class="s3">)</span>
        <span class="s5">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_name</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_charset </span><span class="s3">= </span><span class="s1">charsets</span><span class="s3">.</span><span class="s1">get_by_name</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_name</span><span class="s3">)</span>
        <span class="s5">elif </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_collation</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_charset </span><span class="s3">= </span><span class="s1">charsets</span><span class="s3">.</span><span class="s1">get_by_collation</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset_collation</span><span class="s3">)</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">] &amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">SSL</span><span class="s3">:</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin </span><span class="s3">== </span><span class="s4">&quot;mysql_clear_password&quot; </span><span class="s5">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">is_secure</span><span class="s3">:</span>
                <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span>
                    <span class="s4">&quot;Clear password authentication is not supported over &quot;</span>
                    <span class="s4">&quot;insecure channels&quot;</span>
                <span class="s3">)</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_verify_cert</span><span class="s3">:</span>
                <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span>
                    <span class="s4">&quot;SSL is required but the server doesn't support it&quot;</span><span class="s3">,</span>
                    <span class="s1">errno</span><span class="s3">=</span><span class="s6">2026</span><span class="s3">,</span>
                <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp;= ~</span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">SSL</span>
        <span class="s5">elif not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_disabled</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">|= </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">SSL</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">] &amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">PLUGIN_AUTH</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">set_client_flags</span><span class="s3">([</span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">PLUGIN_AUTH</span><span class="s3">])</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">] &amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CLIENT_QUERY_ATTRIBUTES</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info</span><span class="s3">.</span><span class="s1">query_attrs_is_supported </span><span class="s3">= </span><span class="s5">True</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">set_client_flags</span><span class="s3">([</span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CLIENT_QUERY_ATTRIBUTES</span><span class="s3">])</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">[</span><span class="s4">&quot;capabilities&quot;</span><span class="s3">] &amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">MULTI_FACTOR_AUTHENTICATION</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">set_client_flags</span><span class="s3">([</span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">MULTI_FACTOR_AUTHENTICATION</span><span class="s3">])</span>

    <span class="s5">async def </span><span class="s1">_do_auth</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Authenticate with the MySQL server. 
 
        Authentication happens in two parts. We first send a response to the 
        handshake. The MySQL server will then send either an AuthSwitchRequest 
        or an error packet. 
 
        Raises NotSupportedError when we get the old, insecure password 
        reply back. Raises any error coming from MySQL. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s3">(  </span><span class="s0"># pylint: disable=too-many-boolean-expressions</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span>
            <span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;authentication_oci&quot;</span><span class="s3">)</span>
            <span class="s5">or </span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span>
                <span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s4">&quot;authentication_kerberos&quot;</span><span class="s3">)</span>
                <span class="s5">and </span><span class="s1">os</span><span class="s3">.</span><span class="s1">name </span><span class="s3">== </span><span class="s4">&quot;nt&quot;</span>
            <span class="s3">)</span>
        <span class="s3">) </span><span class="s5">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_user</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_user </span><span class="s3">= </span><span class="s1">getpass</span><span class="s3">.</span><span class="s1">getuser</span><span class="s3">()</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span>
                <span class="s4">&quot;MySQL user is empty, OS user: %s will be used for %s&quot;</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_user</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span><span class="s3">,</span>
            <span class="s3">)</span>

        <span class="s1">password </span><span class="s3">= (</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_password1</span>
            <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password1 </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password1</span>
            <span class="s5">else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password</span>
        <span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_active </span><span class="s3">= </span><span class="s5">False</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_disabled </span><span class="s5">and </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">SSL</span><span class="s3">):</span>
            <span class="s1">ssl_context </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">build_ssl_context</span><span class="s3">(</span>
                <span class="s1">ssl_ca</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_ca</span><span class="s3">,</span>
                <span class="s1">ssl_cert</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_cert</span><span class="s3">,</span>
                <span class="s1">ssl_key</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_key</span><span class="s3">,</span>
                <span class="s1">ssl_verify_cert</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_verify_cert</span><span class="s3">,</span>
                <span class="s1">ssl_verify_identity</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_verify_identity</span><span class="s3">,</span>
                <span class="s1">tls_versions</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tls_versions</span><span class="s3">,</span>
                <span class="s1">tls_cipher_suites</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_tls_ciphersuites</span><span class="s3">,</span>
            <span class="s3">)</span>
            <span class="s1">packet</span><span class="s3">: </span><span class="s1">bytes </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_auth_ssl</span><span class="s3">(</span>
                <span class="s1">charset</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset</span><span class="s3">.</span><span class="s1">charset_id</span><span class="s3">, </span><span class="s1">client_flags</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags</span>
            <span class="s3">)</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">switch_to_ssl</span><span class="s3">(</span><span class="s1">ssl_context</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_active </span><span class="s3">= </span><span class="s5">True</span>

        <span class="s1">ok_pkt </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_authenticator</span><span class="s3">.</span><span class="s1">authenticate</span><span class="s3">(</span>
            <span class="s1">sock</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">,</span>
            <span class="s1">handshake</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">,</span>
            <span class="s1">username</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_user</span><span class="s3">,</span>
            <span class="s1">password1</span><span class="s3">=</span><span class="s1">password</span><span class="s3">,</span>
            <span class="s1">password2</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password2</span><span class="s3">,</span>
            <span class="s1">password3</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password3</span><span class="s3">,</span>
            <span class="s1">database</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_database</span><span class="s3">,</span>
            <span class="s1">charset</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset</span><span class="s3">.</span><span class="s1">charset_id</span><span class="s3">,</span>
            <span class="s1">client_flags</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags</span><span class="s3">,</span>
            <span class="s1">auth_plugin</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span><span class="s3">,</span>
            <span class="s1">auth_plugin_class</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin_class</span><span class="s3">,</span>
            <span class="s1">conn_attrs</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connection_attrs</span><span class="s3">,</span>
            <span class="s1">krb_service_principal</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_krb_service_principal</span><span class="s3">,</span>
            <span class="s1">oci_config_file</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_oci_config_file</span><span class="s3">,</span>
            <span class="s1">oci_config_profile</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_oci_config_profile</span><span class="s3">,</span>
            <span class="s1">webauthn_callback</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_webauthn_callback</span><span class="s3">,</span>
        <span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s1">ok_pkt</span><span class="s3">)</span>

        <span class="s5">if not </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CONNECT_WITH_DB</span><span class="s3">) </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_database</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_init_db</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_database</span><span class="s3">)</span>

    <span class="s5">def </span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; OkPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a MySQL OK packet. 
 
        This method handles a MySQL OK packet. When the packet is found to be an Error 
        packet, an error will be raised. If the packet is neither an OK or an Error 
        packet, InterfaceError will be raised. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s1">ok_pkt </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_ok</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_server_status</span><span class="s3">(</span><span class="s1">ok_pkt</span><span class="s3">[</span><span class="s4">&quot;status_flag&quot;</span><span class="s3">])</span>
            <span class="s5">return </span><span class="s1">ok_pkt</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">255</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Expected OK packet&quot;</span><span class="s3">)</span>

    <span class="s5">def </span><span class="s1">_handle_server_status</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Handle the server flags found in MySQL packets. 
 
        This method handles the server flags send by MySQL OK and EOF packets. 
        It, for example, checks whether there exists more result sets or whether there 
        is an ongoing transaction. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_have_next_result </span><span class="s3">= </span><span class="s1">flag_is_set</span><span class="s3">(</span><span class="s1">ServerFlag</span><span class="s3">.</span><span class="s1">MORE_RESULTS_EXISTS</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_in_transaction </span><span class="s3">= </span><span class="s1">flag_is_set</span><span class="s3">(</span><span class="s1">ServerFlag</span><span class="s3">.</span><span class="s1">STATUS_IN_TRANS</span><span class="s3">, </span><span class="s1">flags</span><span class="s3">)</span>

    <span class="s5">def </span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; EofPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a MySQL EOF packet. 
 
        This method handles a MySQL EOF packet. When the packet is found to be an Error 
        packet, an error will be raised. If the packet is neither and OK or an Error 
        packet, InterfaceError will be raised. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">254</span><span class="s3">:</span>
            <span class="s1">eof </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_eof</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_server_status</span><span class="s3">(</span><span class="s1">eof</span><span class="s3">[</span><span class="s4">&quot;status_flag&quot;</span><span class="s3">])</span>
            <span class="s5">return </span><span class="s1">eof</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">255</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Expected EOF packet&quot;</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">_handle_load_data_infile</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">filename</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; OkPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a LOAD DATA INFILE LOCAL request.&quot;&quot;&quot;</span>
        <span class="s1">file_name </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">islink</span><span class="s3">(</span><span class="s1">file_name</span><span class="s3">):</span>
            <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;Use of symbolic link is not allowed&quot;</span><span class="s3">)</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_allow_local_infile </span><span class="s5">and not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_allow_local_infile_in_path</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">DatabaseError</span><span class="s3">(</span>
                <span class="s4">&quot;LOAD DATA LOCAL INFILE file request rejected due to &quot;</span>
                <span class="s4">&quot;restrictions on access.&quot;</span>
            <span class="s3">)</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_allow_local_infile </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_allow_local_infile_in_path</span><span class="s3">:</span>
            <span class="s0"># Validate filename is inside of allow_local_infile_in_path path.</span>
            <span class="s1">infile_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_allow_local_infile_in_path</span><span class="s3">)</span>
            <span class="s1">c_path </span><span class="s3">= </span><span class="s5">None</span>
            <span class="s5">try</span><span class="s3">:</span>
                <span class="s1">c_path </span><span class="s3">= </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path</span><span class="s3">.</span><span class="s1">commonpath</span><span class="s3">([</span><span class="s1">infile_path</span><span class="s3">, </span><span class="s1">file_name</span><span class="s3">])</span>
            <span class="s5">except </span><span class="s1">ValueError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
                <span class="s1">err_msg </span><span class="s3">= (</span>
                    <span class="s4">&quot;{} while loading file `{}` and path `{}` given&quot;</span>
                    <span class="s4">&quot; in allow_local_infile_in_path&quot;</span>
                <span class="s3">)</span>
                <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span>
                    <span class="s1">err_msg</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">err</span><span class="s3">), </span><span class="s1">file_name</span><span class="s3">, </span><span class="s1">infile_path</span><span class="s3">)</span>
                <span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

            <span class="s5">if </span><span class="s1">c_path </span><span class="s3">!= </span><span class="s1">infile_path</span><span class="s3">:</span>
                <span class="s1">err_msg </span><span class="s3">= (</span>
                    <span class="s4">&quot;The file `{}` is not found in the given &quot;</span>
                    <span class="s4">&quot;allow_local_infile_in_path {}&quot;</span>
                <span class="s3">)</span>
                <span class="s5">raise </span><span class="s1">DatabaseError</span><span class="s3">(</span><span class="s1">err_msg</span><span class="s3">.</span><span class="s1">format</span><span class="s3">(</span><span class="s1">file_name</span><span class="s3">, </span><span class="s1">infile_path</span><span class="s3">))</span>

        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">data_file </span><span class="s3">= </span><span class="s1">open</span><span class="s3">(</span><span class="s1">file_name</span><span class="s3">, </span><span class="s4">&quot;rb&quot;</span><span class="s3">)  </span><span class="s0"># pylint: disable=consider-using-with</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_data</span><span class="s3">(</span><span class="s1">data_file</span><span class="s3">, </span><span class="s1">send_empty_packet</span><span class="s3">=</span><span class="s5">True</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s5">except </span><span class="s1">IOError</span><span class="s3">:</span>
            <span class="s0"># Send a empty packet to cancel the operation</span>
            <span class="s5">try</span><span class="s3">:</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s7">b&quot;&quot;</span><span class="s3">)</span>
            <span class="s5">except </span><span class="s1">AttributeError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
                <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;MySQL Connection not available&quot;</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>
            <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">f&quot;File '</span><span class="s5">{</span><span class="s1">file_name</span><span class="s5">}</span><span class="s4">' could not be read&quot;</span><span class="s3">) </span><span class="s5">from None</span>
        <span class="s5">finally</span><span class="s3">:</span>
            <span class="s5">try</span><span class="s3">:</span>
                <span class="s1">data_file</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
            <span class="s5">except </span><span class="s3">(</span><span class="s1">IOError</span><span class="s3">, </span><span class="s1">NameError</span><span class="s3">):</span>
                <span class="s5">pass</span>

    <span class="s5">async def </span><span class="s1">_handle_result</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; ResultType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Handle a MySQL Result. 
 
        This method handles a MySQL result, for example, after sending the query 
        command. OK and EOF packets will be handled and returned. 
        If the packet is an Error packet, an Error-exception will be raised. 
 
        The dictionary returned of: 
        - columns: column information 
        - eof: the EOF-packet information 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">packet </span><span class="s5">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">) &lt; </span><span class="s6">4</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Empty response&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">251</span><span class="s3">:</span>
            <span class="s1">filename </span><span class="s3">= </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">5</span><span class="s3">:].</span><span class="s1">decode</span><span class="s3">()</span>
            <span class="s5">return await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_load_data_infile</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">254</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">255</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>

        <span class="s0"># We have a text result set</span>
        <span class="s1">column_count </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_column_count</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if not </span><span class="s1">column_count </span><span class="s5">or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">column_count</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
            <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Illegal result set&quot;</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_columns_desc </span><span class="s3">= [</span>
            <span class="s5">None</span><span class="s3">,</span>
        <span class="s3">] * </span><span class="s1">column_count</span>
        <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">column_count</span><span class="s3">):</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_columns_desc</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_column</span><span class="s3">(</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">python_charset</span>
            <span class="s3">)</span>

        <span class="s1">eof </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result </span><span class="s3">= </span><span class="s5">True</span>
        <span class="s5">return </span><span class="s3">{</span><span class="s4">&quot;columns&quot;</span><span class="s3">: </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_columns_desc</span><span class="s3">, </span><span class="s4">&quot;eof&quot;</span><span class="s3">: </span><span class="s1">eof</span><span class="s3">}</span>

    <span class="s5">def </span><span class="s1">_handle_binary_ok</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">: </span><span class="s1">bytes</span><span class="s3">) </span><span class="s1">-&gt; Dict</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">int</span><span class="s3">]:</span>
        <span class="s2">&quot;&quot;&quot;Handle a MySQL Binary Protocol OK packet 
 
        This method handles a MySQL Binary Protocol OK packet. When the 
        packet is found to be an Error packet, an error will be raised. If 
        the packet is neither an OK or an Error packet, InterfaceError 
        will be raised. 
 
        Returns a dict() 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_binary_prepare_ok</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">255</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Expected Binary OK packet&quot;</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">_handle_binary_result</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">: </span><span class="s1">bytes</span>
    <span class="s3">) </span><span class="s1">-&gt; Union</span><span class="s3">[</span><span class="s1">OkPacketType</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">DescriptionType</span><span class="s3">], </span><span class="s1">EofPacketType</span><span class="s3">]]:</span>
        <span class="s2">&quot;&quot;&quot;Handle a MySQL Result 
 
        This method handles a MySQL result, for example, after sending the 
        query command. OK and EOF packets will be handled and returned. If 
        the packet is an Error packet, an Error exception will be raised. 
 
        The tuple returned by this method consist of: 
        - the number of columns in the result, 
        - a list of tuples with information about the columns, 
        - the EOF packet information as a dictionary. 
 
        Returns tuple() or dict() 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">packet </span><span class="s5">or </span><span class="s1">len</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">) &lt; </span><span class="s6">4</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Empty response&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">254</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">packet</span><span class="s3">[</span><span class="s6">4</span><span class="s3">] == </span><span class="s6">255</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">get_exception</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>

        <span class="s0"># We have a binary result set</span>
        <span class="s1">column_count </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_column_count</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">if not </span><span class="s1">column_count </span><span class="s5">or not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">column_count</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
            <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Illegal result set.&quot;</span><span class="s3">)</span>

        <span class="s1">columns</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">DescriptionType</span><span class="s3">] = [</span><span class="s5">None</span><span class="s3">] * </span><span class="s1">column_count</span>
        <span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">column_count</span><span class="s3">):</span>
            <span class="s1">columns</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_column</span><span class="s3">(</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">python_charset</span>
            <span class="s3">)</span>

        <span class="s1">eof </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
        <span class="s5">return </span><span class="s3">(</span><span class="s1">column_count</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">, </span><span class="s1">eof</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">_send_cmd</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">command</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,</span>
        <span class="s1">argument</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">packet_number</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
        <span class="s1">packet</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">expect_response</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">True</span><span class="s3">,</span>
        <span class="s1">compressed_packet_number</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">bytearray</span><span class="s3">]:</span>
        <span class="s2">&quot;&quot;&quot;Send a command to the MySQL server. 
 
        This method sends a command with an optional argument. 
        If packet is not None, it will be sent and the argument will be ignored. 
 
        The packet_number is optional and should usually not be used. 
 
        Some commands might not result in the MySQL server returning a response. If a 
        command does not return anything, you should set expect_response to False. 
        The _send_cmd method will then return None instead of a MySQL packet. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>

        <span class="s5">try</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_command</span><span class="s3">(</span><span class="s1">command</span><span class="s3">, </span><span class="s1">packet </span><span class="s5">or </span><span class="s1">argument</span><span class="s3">),</span>
                <span class="s1">packet_number</span><span class="s3">,</span>
                <span class="s1">compressed_packet_number</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s5">except </span><span class="s1">AttributeError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;MySQL Connection not available&quot;</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

        <span class="s5">if not </span><span class="s1">expect_response</span><span class="s3">:</span>
            <span class="s5">return None</span>
        <span class="s5">return await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>

    <span class="s5">async def </span><span class="s1">_send_data</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">data_file</span><span class="s3">: </span><span class="s1">BinaryIO</span><span class="s3">, </span><span class="s1">send_empty_packet</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span>
    <span class="s3">) </span><span class="s1">-&gt; bytearray</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send data to the MySQL server 
 
        This method accepts a file-like object and sends its data 
        as is to the MySQL server. If the send_empty_packet is 
        True, it will send an extra empty package (for example 
        when using LOAD LOCAL DATA INFILE). 
 
        Returns a MySQL packet. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>

        <span class="s5">if not </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">data_file</span><span class="s3">, </span><span class="s4">&quot;read&quot;</span><span class="s3">):</span>
            <span class="s5">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;expecting a file-like object&quot;</span><span class="s3">)</span>

        <span class="s1">chunk_size </span><span class="s3">= </span><span class="s6">131072  </span><span class="s0"># 128 KB</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">buf </span><span class="s3">= </span><span class="s1">data_file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunk_size </span><span class="s3">- </span><span class="s6">16</span><span class="s3">)</span>
            <span class="s5">while </span><span class="s1">buf</span><span class="s3">:</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">)</span>
                <span class="s1">buf </span><span class="s3">= </span><span class="s1">data_file</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunk_size </span><span class="s3">- </span><span class="s6">16</span><span class="s3">)</span>
        <span class="s5">except </span><span class="s1">AttributeError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;MySQL Connection not available&quot;</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

        <span class="s5">if </span><span class="s1">send_empty_packet</span><span class="s3">:</span>
            <span class="s5">try</span><span class="s3">:</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s7">b&quot;&quot;</span><span class="s3">)</span>
            <span class="s5">except </span><span class="s1">AttributeError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
                <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;MySQL Connection not available&quot;</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">()</span>
        <span class="s5">return </span><span class="s1">res</span>

    <span class="s5">def </span><span class="s1">is_socket_connected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Reports whether the socket is connected. 
 
        Instead of ping the server like ``is_connected()``, it only checks if the 
        socket connection flag is set. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">bool</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">is_connected</span><span class="s3">())</span>

    <span class="s5">async def </span><span class="s1">is_connected</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Reports whether the connection to MySQL Server is available. 
 
        This method checks whether the connection to MySQL is available. 
        It is similar to ``ping()``, but unlike the ``ping()`` method, either `True` 
        or `False` is returned and no exception is raised. 
        &quot;&quot;&quot;</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_ping</span><span class="s3">()</span>
        <span class="s5">except </span><span class="s1">Error</span><span class="s3">:</span>
            <span class="s5">return False</span>
        <span class="s5">return True</span>

    <span class="s5">async def </span><span class="s1">ping</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">reconnect</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span><span class="s3">, </span><span class="s1">attempts</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">, </span><span class="s1">delay</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span>
    <span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Check availability of the MySQL server. 
 
        When reconnect is set to `True`, one or more attempts are made to try to 
        reconnect to the MySQL server using the ``reconnect()`` method. 
 
        ``delay`` is the number of seconds to wait between each retry. 
 
        When the connection is not available, an InterfaceError is raised. Use the 
        ``is_connected()`` method if you just want to check the connection without 
        raising an error. 
 
        Raises: 
            InterfaceError: On errors. 
        &quot;&quot;&quot;</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_ping</span><span class="s3">()</span>
        <span class="s5">except </span><span class="s1">Error </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s5">if </span><span class="s1">reconnect</span><span class="s3">:</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">reconnect</span><span class="s3">(</span><span class="s1">attempts</span><span class="s3">=</span><span class="s1">attempts</span><span class="s3">, </span><span class="s1">delay</span><span class="s3">=</span><span class="s1">delay</span><span class="s3">)</span>
            <span class="s5">else</span><span class="s3">:</span>
                <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span><span class="s4">&quot;Connection to MySQL is not available&quot;</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

    <span class="s5">async def </span><span class="s1">shutdown</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Shut down connection to MySQL Server. 
 
        This method closes the socket. It raises no exceptions. 
 
        Unlike `disconnect()`, `shutdown()` closes the client connection without 
        attempting to send a QUIT command to the server first. Thus, it will not 
        block if the connection is disrupted for some reason such as network failure. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">:</span>
            <span class="s5">return</span>

        <span class="s5">try</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">close_connection</span><span class="s3">()</span>
        <span class="s5">except </span><span class="s1">Exception</span><span class="s3">:  </span><span class="s0"># pylint: disable=broad-exception-caught</span>
            <span class="s5">pass  </span><span class="s0"># Getting an exception would mean we are disconnected.</span>

    <span class="s5">async def </span><span class="s1">close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Close the connection. 
 
        It closes any opened cursor associated to this connection, and closes the 
        underling socket connection. 
 
        `MySQLConnection.close()` is a synonymous for `MySQLConnection.disconnect()` 
        method name and more commonly used. 
 
        This method tries to send a `QUIT` command and close the socket. It raises 
        no exceptions. 
        &quot;&quot;&quot;</span>
        <span class="s5">for </span><span class="s1">cursor </span><span class="s5">in </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_cursors</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">cursor</span><span class="s3">.</span><span class="s1">close</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_cursors</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">is_connected</span><span class="s3">():</span>
            <span class="s5">with </span><span class="s1">contextlib</span><span class="s3">.</span><span class="s1">suppress</span><span class="s3">(</span><span class="s1">Error</span><span class="s3">):</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_quit</span><span class="s3">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">close_connection</span><span class="s3">()</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket </span><span class="s3">= </span><span class="s5">None</span>

    <span class="s1">disconnect</span><span class="s3">: </span><span class="s1">Callable</span><span class="s3">[[], </span><span class="s1">Any</span><span class="s3">] = </span><span class="s1">close</span>

    <span class="s5">async def </span><span class="s1">cursor</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">buffered</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">raw</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">prepared</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">cursor_class</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">Type</span><span class="s3">[</span><span class="s1">MySQLCursorAbstract</span><span class="s3">]] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">dictionary</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">named_tuple</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; MySQLCursor</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Instantiate and return a cursor. 
 
        By default, MySQLCursor is returned. Depending on the options while 
        connecting, a buffered and/or raw cursor is instantiated instead. 
        Also depending upon the cursor options, rows can be returned as dictionary or 
        named tuple. 
 
        It is possible to also give a custom cursor through the cursor_class 
        parameter, but it needs to be a subclass of 
        mysql.connector.aio.abstracts.MySQLCursorAbstract. 
 
        Raises: 
            ProgrammingError: When cursor_class is not a subclass of 
                              MySQLCursor. 
            ValueError: When cursor is not available. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket </span><span class="s5">or not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">is_connected</span><span class="s3">():</span>
            <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;MySQL Connection not available&quot;</span><span class="s3">)</span>

        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>

        <span class="s5">if </span><span class="s1">cursor_class </span><span class="s5">is not None</span><span class="s3">:</span>
            <span class="s5">if not </span><span class="s1">issubclass</span><span class="s3">(</span><span class="s1">cursor_class</span><span class="s3">, </span><span class="s1">MySQLCursor</span><span class="s3">):</span>
                <span class="s5">raise </span><span class="s1">ProgrammingError</span><span class="s3">(</span>
                    <span class="s4">&quot;Cursor class needs be to subclass of MySQLCursorAbstract&quot;</span>
                <span class="s3">)</span>
            <span class="s5">return </span><span class="s3">(</span><span class="s1">cursor_class</span><span class="s3">)(</span><span class="s1">self</span><span class="s3">)</span>

        <span class="s1">buffered </span><span class="s3">= </span><span class="s1">buffered </span><span class="s5">if </span><span class="s1">buffered </span><span class="s5">is not None else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_buffered</span>
        <span class="s1">raw </span><span class="s3">= </span><span class="s1">raw </span><span class="s5">if </span><span class="s1">raw </span><span class="s5">is not None else </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_raw</span>

        <span class="s1">cursor_type </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s5">if </span><span class="s1">buffered </span><span class="s5">is True</span><span class="s3">:</span>
            <span class="s1">cursor_type </span><span class="s3">|= </span><span class="s6">1</span>
        <span class="s5">if </span><span class="s1">raw </span><span class="s5">is True</span><span class="s3">:</span>
            <span class="s1">cursor_type </span><span class="s3">|= </span><span class="s6">2</span>
        <span class="s5">if </span><span class="s1">dictionary </span><span class="s5">is True</span><span class="s3">:</span>
            <span class="s1">cursor_type </span><span class="s3">|= </span><span class="s6">4</span>
        <span class="s5">if </span><span class="s1">named_tuple </span><span class="s5">is True</span><span class="s3">:</span>
            <span class="s1">cursor_type </span><span class="s3">|= </span><span class="s6">8</span>
        <span class="s5">if </span><span class="s1">prepared </span><span class="s5">is True</span><span class="s3">:</span>
            <span class="s1">cursor_type </span><span class="s3">|= </span><span class="s6">16</span>

        <span class="s1">types </span><span class="s3">= {</span>
            <span class="s6">0</span><span class="s3">: </span><span class="s1">MySQLCursor</span><span class="s3">,</span>
            <span class="s6">1</span><span class="s3">: </span><span class="s1">MySQLCursorBuffered</span><span class="s3">,</span>
            <span class="s6">2</span><span class="s3">: </span><span class="s1">MySQLCursorRaw</span><span class="s3">,</span>
            <span class="s6">3</span><span class="s3">: </span><span class="s1">MySQLCursorBufferedRaw</span><span class="s3">,</span>
            <span class="s6">4</span><span class="s3">: </span><span class="s1">MySQLCursorDict</span><span class="s3">,</span>
            <span class="s6">5</span><span class="s3">: </span><span class="s1">MySQLCursorBufferedDict</span><span class="s3">,</span>
            <span class="s6">8</span><span class="s3">: </span><span class="s1">MySQLCursorNamedTuple</span><span class="s3">,</span>
            <span class="s6">9</span><span class="s3">: </span><span class="s1">MySQLCursorBufferedNamedTuple</span><span class="s3">,</span>
            <span class="s6">16</span><span class="s3">: </span><span class="s1">MySQLCursorPrepared</span><span class="s3">,</span>
            <span class="s6">18</span><span class="s3">: </span><span class="s1">MySQLCursorPreparedRaw</span><span class="s3">,</span>
            <span class="s6">20</span><span class="s3">: </span><span class="s1">MySQLCursorPreparedDict</span><span class="s3">,</span>
            <span class="s6">24</span><span class="s3">: </span><span class="s1">MySQLCursorPreparedNamedTuple</span><span class="s3">,</span>
        <span class="s3">}</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">raise_warning_against_deprecated_cursor_class</span><span class="s3">(</span>
                <span class="s1">cursor_name</span><span class="s3">=</span><span class="s1">types</span><span class="s3">[</span><span class="s1">cursor_type</span><span class="s3">].</span><span class="s1">__name__</span>
            <span class="s3">)</span>
            <span class="s5">return </span><span class="s3">(</span><span class="s1">types</span><span class="s3">[</span><span class="s1">cursor_type</span><span class="s3">])(</span><span class="s1">self</span><span class="s3">)</span>
        <span class="s5">except </span><span class="s1">KeyError</span><span class="s3">:</span>
            <span class="s1">args </span><span class="s3">= (</span><span class="s4">&quot;buffered&quot;</span><span class="s3">, </span><span class="s4">&quot;raw&quot;</span><span class="s3">, </span><span class="s4">&quot;dictionary&quot;</span><span class="s3">, </span><span class="s4">&quot;named_tuple&quot;</span><span class="s3">, </span><span class="s4">&quot;prepared&quot;</span><span class="s3">)</span>
            <span class="s1">criteria </span><span class="s3">= </span><span class="s4">&quot;, &quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">(</span>
                <span class="s3">[</span><span class="s1">args</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] </span><span class="s5">for </span><span class="s1">i </span><span class="s5">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">5</span><span class="s3">) </span><span class="s5">if </span><span class="s1">cursor_type </span><span class="s3">&amp; (</span><span class="s6">1 </span><span class="s3">&lt;&lt; </span><span class="s1">i</span><span class="s3">) != </span><span class="s6">0</span><span class="s3">]</span>
            <span class="s3">)</span>
            <span class="s5">raise </span><span class="s1">ValueError</span><span class="s3">(</span>
                <span class="s4">f&quot;Cursor not available with given criteria: </span><span class="s5">{</span><span class="s1">criteria</span><span class="s5">}</span><span class="s4">&quot;</span>
            <span class="s3">) </span><span class="s5">from None</span>

    <span class="s5">async def </span><span class="s1">get_row</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">binary</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span><span class="s3">,</span>
        <span class="s1">columns</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">DescriptionType</span><span class="s3">]] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">raw</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">RowType</span><span class="s3">], </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">EofPacketType</span><span class="s3">]]:</span>
        <span class="s2">&quot;&quot;&quot;Get the next rows returned by the MySQL server. 
 
        This method gets one row from the result set after sending, for example, the 
        query command. The result is a tuple consisting of the row and the EOF packet. 
        If no row was available in the result set, the row data will be None. 
        &quot;&quot;&quot;</span>
        <span class="s1">rows</span><span class="s3">, </span><span class="s1">eof </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rows</span><span class="s3">(</span>
            <span class="s1">count</span><span class="s3">=</span><span class="s6">1</span><span class="s3">, </span><span class="s1">binary</span><span class="s3">=</span><span class="s1">binary</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">=</span><span class="s1">columns</span><span class="s3">, </span><span class="s1">raw</span><span class="s3">=</span><span class="s1">raw</span>
        <span class="s3">)</span>
        <span class="s5">if </span><span class="s1">rows</span><span class="s3">:</span>
            <span class="s5">return </span><span class="s3">(</span><span class="s1">rows</span><span class="s3">[</span><span class="s6">0</span><span class="s3">], </span><span class="s1">eof</span><span class="s3">)</span>
        <span class="s5">return </span><span class="s3">(</span><span class="s5">None</span><span class="s3">, </span><span class="s1">eof</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">get_rows</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">count</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">binary</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span><span class="s3">,</span>
        <span class="s1">columns</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">DescriptionType</span><span class="s3">]] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">raw</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">bool</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">prep_stmt</span><span class="s3">: </span><span class="s1">Any </span><span class="s3">= </span><span class="s5">None</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Tuple</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">RowType</span><span class="s3">], </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">EofPacketType</span><span class="s3">]]:</span>
        <span class="s2">&quot;&quot;&quot;Get all rows returned by the MySQL server. 
 
        This method gets all rows returned by the MySQL server after sending, for 
        example, the query command. The result is a tuple consisting of a list of rows 
        and the EOF packet. 
        &quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">raw </span><span class="s5">is None</span><span class="s3">:</span>
            <span class="s1">raw </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_raw</span>

        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">InternalError</span><span class="s3">(</span><span class="s4">&quot;No result set available&quot;</span><span class="s3">)</span>

        <span class="s1">rows</span><span class="s3">: </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">List</span><span class="s3">[</span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">, ...]], </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">EofPacketType</span><span class="s3">]] = ([], </span><span class="s5">None</span><span class="s3">)</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s5">if </span><span class="s1">binary</span><span class="s3">:</span>
                <span class="s1">charset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">charset</span>
                <span class="s5">if </span><span class="s1">charset </span><span class="s3">== </span><span class="s4">&quot;utf8mb4&quot;</span><span class="s3">:</span>
                    <span class="s1">charset </span><span class="s3">= </span><span class="s4">&quot;utf8&quot;</span>
                <span class="s1">rows </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">read_binary_result</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">, </span><span class="s1">columns</span><span class="s3">, </span><span class="s1">count</span><span class="s3">, </span><span class="s1">charset</span>
                <span class="s3">)</span>
            <span class="s5">else</span><span class="s3">:</span>
                <span class="s1">rows </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">read_text_result</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info</span><span class="s3">.</span><span class="s1">version</span><span class="s3">, </span><span class="s1">count</span><span class="s3">=</span><span class="s1">count</span>
                <span class="s3">)</span>
        <span class="s5">except </span><span class="s1">Error </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result </span><span class="s3">= </span><span class="s5">False</span>
            <span class="s5">raise </span><span class="s1">err</span>

        <span class="s1">rows</span><span class="s3">, </span><span class="s1">eof_p </span><span class="s3">= </span><span class="s1">rows</span>
        <span class="s5">if </span><span class="s3">(</span>
            <span class="s5">not </span><span class="s3">(</span><span class="s1">binary </span><span class="s5">or </span><span class="s1">raw</span><span class="s3">)</span>
            <span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_columns_desc </span><span class="s5">is not None</span>
            <span class="s5">and </span><span class="s1">rows</span>
            <span class="s5">and </span><span class="s1">hasattr</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s4">&quot;converter&quot;</span><span class="s3">)</span>
        <span class="s3">):</span>
            <span class="s1">row_to_python </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">converter</span><span class="s3">.</span><span class="s1">row_to_python</span>
            <span class="s1">rows </span><span class="s3">= [</span><span class="s1">row_to_python</span><span class="s3">(</span><span class="s1">row</span><span class="s3">, </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_columns_desc</span><span class="s3">) </span><span class="s5">for </span><span class="s1">row </span><span class="s5">in </span><span class="s1">rows</span><span class="s3">]</span>

        <span class="s5">if </span><span class="s1">eof_p </span><span class="s5">is not None</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_server_status</span><span class="s3">(</span>
                <span class="s1">eof_p</span><span class="s3">[</span><span class="s4">&quot;status_flag&quot;</span><span class="s3">]</span>
                <span class="s5">if </span><span class="s4">&quot;status_flag&quot; </span><span class="s5">in </span><span class="s1">eof_p</span>
                <span class="s5">else </span><span class="s1">eof_p</span><span class="s3">[</span><span class="s4">&quot;server_status&quot;</span><span class="s3">]</span>
            <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result </span><span class="s3">= </span><span class="s5">False</span>

        <span class="s5">return </span><span class="s1">rows</span><span class="s3">, </span><span class="s1">eof_p</span>

    <span class="s5">async def </span><span class="s1">commit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Commit current transaction.&quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_execute_query</span><span class="s3">(</span><span class="s4">&quot;COMMIT&quot;</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">rollback</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Rollback current transaction.&quot;&quot;&quot;</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">get_rows</span><span class="s3">()</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_execute_query</span><span class="s3">(</span><span class="s4">&quot;ROLLBACK&quot;</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">cmd_reset_connection</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Resets the session state without re-authenticating. 
 
        Reset command only works on MySQL server 5.7.3 or later. 
        The result is True for a successful reset otherwise False. 
        &quot;&quot;&quot;</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">RESET_CONNECTION</span><span class="s3">))</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_post_connection</span><span class="s3">()</span>
            <span class="s5">return True</span>
        <span class="s5">except </span><span class="s3">(</span><span class="s1">NotSupportedError</span><span class="s3">, </span><span class="s1">OperationalError</span><span class="s3">):</span>
            <span class="s5">return False</span>

    <span class="s5">async def </span><span class="s1">cmd_init_db</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">database</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; OkPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Change the current database. 
 
        This method changes the current (default) database by sending the INIT_DB 
        command. The result is a dictionary containing the OK packet infawaitormation. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">INIT_DB</span><span class="s3">, </span><span class="s1">database</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">&quot;utf-8&quot;</span><span class="s3">))</span>
        <span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">cmd_query</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">query</span><span class="s3">: </span><span class="s1">StrOrBytes</span><span class="s3">,</span>
        <span class="s1">raw</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span><span class="s3">,</span>
        <span class="s1">buffered</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span><span class="s3">,</span>
        <span class="s1">raw_as_string</span><span class="s3">: </span><span class="s1">bool </span><span class="s3">= </span><span class="s5">False</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; ResultType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send a query to the MySQL server. 
 
        This method send the query to the MySQL server and returns the result. 
 
        If there was a text result, a tuple will be returned consisting of the number 
        of columns and a list containing information about these columns. 
 
        When the query doesn't return a text result, the OK or EOF packet information 
        as dictionary will be returned. In case the result was an error, exception 
        Error will be raised. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">bytearray</span><span class="s3">):</span>
            <span class="s5">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">query</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">query </span><span class="s3">= </span><span class="s1">query</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">()</span>
            <span class="s1">query </span><span class="s3">= </span><span class="s1">bytearray</span><span class="s3">(</span><span class="s1">query</span><span class="s3">)</span>
        <span class="s0"># Prepare query attrs</span>
        <span class="s1">charset </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset</span><span class="s3">.</span><span class="s1">name </span><span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset</span><span class="s3">.</span><span class="s1">name </span><span class="s3">!= </span><span class="s4">&quot;utf8mb4&quot; </span><span class="s5">else </span><span class="s4">&quot;utf8&quot;</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s1">bytearray</span><span class="s3">()</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info</span><span class="s3">.</span><span class="s1">query_attrs_is_supported </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs</span><span class="s3">:</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s4">&quot;This version of the server does not support Query Attributes&quot;</span><span class="s3">,</span>
                <span class="s1">category</span><span class="s3">=</span><span class="s1">Warning</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CLIENT_QUERY_ATTRIBUTES</span><span class="s3">:</span>
            <span class="s1">names </span><span class="s3">= []</span>
            <span class="s1">types </span><span class="s3">= []</span>
            <span class="s1">values</span><span class="s3">: </span><span class="s1">List</span><span class="s3">[</span><span class="s1">bytes</span><span class="s3">] = []</span>
            <span class="s1">null_bitmap </span><span class="s3">= [</span><span class="s6">0</span><span class="s3">] * ((</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs</span><span class="s3">) + </span><span class="s6">7</span><span class="s3">) // </span><span class="s6">8</span><span class="s3">)</span>
            <span class="s5">for </span><span class="s1">pos</span><span class="s3">, </span><span class="s1">attr_tuple </span><span class="s5">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs</span><span class="s3">):</span>
                <span class="s1">value </span><span class="s3">= </span><span class="s1">attr_tuple</span><span class="s3">[</span><span class="s6">1</span><span class="s3">]</span>
                <span class="s1">flags </span><span class="s3">= </span><span class="s6">0</span>
                <span class="s5">if </span><span class="s1">value </span><span class="s5">is None</span><span class="s3">:</span>
                    <span class="s1">null_bitmap</span><span class="s3">[(</span><span class="s1">pos </span><span class="s3">// </span><span class="s6">8</span><span class="s3">)] |= </span><span class="s6">1 </span><span class="s3">&lt;&lt; (</span><span class="s1">pos </span><span class="s3">% </span><span class="s6">8</span><span class="s3">)</span>
                    <span class="s1">types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">int1store</span><span class="s3">(</span><span class="s1">FieldType</span><span class="s3">.</span><span class="s1">NULL</span><span class="s3">) + </span><span class="s1">int1store</span><span class="s3">(</span><span class="s1">flags</span><span class="s3">))</span>
                    <span class="s5">continue</span>
                <span class="s5">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
                    <span class="s3">(</span>
                        <span class="s1">packed</span><span class="s3">,</span>
                        <span class="s1">field_type</span><span class="s3">,</span>
                        <span class="s1">flags</span><span class="s3">,</span>
                    <span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">prepare_binary_integer</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">packed</span><span class="s3">)</span>
                <span class="s5">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                    <span class="s1">value </span><span class="s3">= </span><span class="s1">value</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">)</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)) + </span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s1">field_type </span><span class="s3">= </span><span class="s1">FieldType</span><span class="s3">.</span><span class="s1">VARCHAR</span>
                <span class="s5">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">bytes</span><span class="s3">):</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)) + </span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s1">field_type </span><span class="s3">= </span><span class="s1">FieldType</span><span class="s3">.</span><span class="s1">BLOB</span>
                <span class="s5">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">Decimal</span><span class="s3">):</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span>
                        <span class="s1">lc_int</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">str</span><span class="s3">(</span><span class="s1">value</span><span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">)))</span>
                        <span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">value</span><span class="s3">).</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">)</span>
                    <span class="s3">)</span>
                    <span class="s1">field_type </span><span class="s3">= </span><span class="s1">FieldType</span><span class="s3">.</span><span class="s1">DECIMAL</span>
                <span class="s5">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, </span><span class="s1">float</span><span class="s3">):</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">struct</span><span class="s3">.</span><span class="s1">pack</span><span class="s3">(</span><span class="s4">&quot;&lt;d&quot;</span><span class="s3">, </span><span class="s1">value</span><span class="s3">))</span>
                    <span class="s1">field_type </span><span class="s3">= </span><span class="s1">FieldType</span><span class="s3">.</span><span class="s1">DOUBLE</span>
                <span class="s5">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, (</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">, </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">date</span><span class="s3">)):</span>
                    <span class="s3">(</span>
                        <span class="s1">packed</span><span class="s3">,</span>
                        <span class="s1">field_type</span><span class="s3">,</span>
                    <span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">prepare_binary_timestamp</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">packed</span><span class="s3">)</span>
                <span class="s5">elif </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">value</span><span class="s3">, (</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timedelta</span><span class="s3">, </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">time</span><span class="s3">)):</span>
                    <span class="s3">(</span><span class="s1">packed</span><span class="s3">, </span><span class="s1">field_type</span><span class="s3">) = </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">prepare_binary_time</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>
                    <span class="s1">values</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">packed</span><span class="s3">)</span>
                <span class="s5">else</span><span class="s3">:</span>
                    <span class="s5">raise </span><span class="s1">ProgrammingError</span><span class="s3">(</span>
                        <span class="s4">&quot;MySQL binary protocol can not handle &quot;</span>
                        <span class="s4">f&quot;'</span><span class="s5">{</span><span class="s1">value</span><span class="s3">.</span><span class="s1">__class__</span><span class="s3">.</span><span class="s1">__name__</span><span class="s5">}</span><span class="s4">' objects&quot;</span>
                    <span class="s3">)</span>
                <span class="s1">types</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">int1store</span><span class="s3">(</span><span class="s1">field_type</span><span class="s3">) + </span><span class="s1">int1store</span><span class="s3">(</span><span class="s1">flags</span><span class="s3">))</span>
                <span class="s1">name </span><span class="s3">= </span><span class="s1">attr_tuple</span><span class="s3">[</span><span class="s6">0</span><span class="s3">].</span><span class="s1">encode</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">)</span>
                <span class="s1">names</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) + </span><span class="s1">name</span><span class="s3">)</span>

            <span class="s0"># int&lt;lenenc&gt;    parameter_count    Number of parameters</span>
            <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs</span><span class="s3">)))</span>
            <span class="s0"># int&lt;lenenc&gt;    parameter_set_count    Number of parameter sets.</span>
            <span class="s0"># Currently always 1</span>
            <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s6">1</span><span class="s3">))</span>
            <span class="s5">if </span><span class="s1">values</span><span class="s3">:</span>
                <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span>
                    <span class="s7">b&quot;&quot;</span><span class="s3">.</span><span class="s1">join</span><span class="s3">([</span><span class="s1">struct</span><span class="s3">.</span><span class="s1">pack</span><span class="s3">(</span><span class="s4">&quot;B&quot;</span><span class="s3">, </span><span class="s1">bit</span><span class="s3">) </span><span class="s5">for </span><span class="s1">bit </span><span class="s5">in </span><span class="s1">null_bitmap</span><span class="s3">])</span>
                    <span class="s3">+ </span><span class="s1">int1store</span><span class="s3">(</span><span class="s6">1</span><span class="s3">)</span>
                <span class="s3">)</span>
                <span class="s5">for </span><span class="s1">_type</span><span class="s3">, </span><span class="s1">name </span><span class="s5">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">types</span><span class="s3">, </span><span class="s1">names</span><span class="s3">):</span>
                    <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">_type</span><span class="s3">)</span>
                    <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

                <span class="s5">for </span><span class="s1">value </span><span class="s5">in </span><span class="s1">values</span><span class="s3">:</span>
                    <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">value</span><span class="s3">)</span>

        <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">query</span><span class="s3">)</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s1">bytes</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">result </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_result</span><span class="s3">(</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">QUERY</span><span class="s3">, </span><span class="s1">query</span><span class="s3">)</span>
            <span class="s3">)</span>
        <span class="s5">except </span><span class="s1">ProgrammingError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s5">if </span><span class="s1">err</span><span class="s3">.</span><span class="s1">errno </span><span class="s3">== </span><span class="s6">3948 </span><span class="s5">and </span><span class="s4">&quot;Loading local data is disabled&quot; </span><span class="s5">in </span><span class="s1">err</span><span class="s3">.</span><span class="s1">msg</span><span class="s3">:</span>
                <span class="s1">err_msg </span><span class="s3">= (</span>
                    <span class="s4">&quot;LOAD DATA LOCAL INFILE file request rejected due &quot;</span>
                    <span class="s4">&quot;to restrictions on access.&quot;</span>
                <span class="s3">)</span>
                <span class="s5">raise </span><span class="s1">DatabaseError</span><span class="s3">(</span><span class="s1">err_msg</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>
            <span class="s5">raise</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_have_next_result</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">InterfaceError</span><span class="s3">(</span>
                <span class="s4">&quot;Use cmd_query_iter for statements with multiple queries.&quot;</span>
            <span class="s3">)</span>

        <span class="s5">return </span><span class="s1">result</span>

    <span class="s5">async def </span><span class="s1">cmd_query_iter</span><span class="s3">(  </span><span class="s0"># type: ignore[override]</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">statements</span><span class="s3">: </span><span class="s1">StrOrBytes</span>
    <span class="s3">) </span><span class="s1">-&gt; AsyncGenerator</span><span class="s3">[</span><span class="s1">ResultType</span><span class="s3">, </span><span class="s5">None</span><span class="s3">]:</span>
        <span class="s2">&quot;&quot;&quot;Send one or more statements to the MySQL server. 
 
        Similar to the cmd_query method, but instead returns a generator 
        object to iterate through results. It sends the statements to the 
        MySQL server and through the iterator you can get the results. 
 
        statement = 'SELECT 1; INSERT INTO t1 VALUES (); SELECT 2' 
        for result in await cnx.cmd_query(statement, iterate=True): 
            if 'columns' in result: 
                columns = result['columns'] 
                rows = await cnx.get_rows() 
            else: 
                # do something useful with INSERT result 
        &quot;&quot;&quot;</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s1">bytearray</span><span class="s3">()</span>
        <span class="s5">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">statements</span><span class="s3">, </span><span class="s1">bytearray</span><span class="s3">):</span>
            <span class="s5">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">statements</span><span class="s3">, </span><span class="s1">str</span><span class="s3">):</span>
                <span class="s1">statements </span><span class="s3">= </span><span class="s1">statements</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">&quot;utf8&quot;</span><span class="s3">)</span>
            <span class="s1">statements </span><span class="s3">= </span><span class="s1">bytearray</span><span class="s3">(</span><span class="s1">statements</span><span class="s3">)</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CLIENT_QUERY_ATTRIBUTES</span><span class="s3">:</span>
            <span class="s0"># int&lt;lenenc&gt;    parameter_count    Number of parameters</span>
            <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s6">0</span><span class="s3">))</span>
            <span class="s0"># int&lt;lenenc&gt;    parameter_set_count    Number of parameter sets.</span>
            <span class="s0"># Currently always 1</span>
            <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">lc_int</span><span class="s3">(</span><span class="s6">1</span><span class="s3">))</span>

        <span class="s1">packet</span><span class="s3">.</span><span class="s1">extend</span><span class="s3">(</span><span class="s1">statements</span><span class="s3">)</span>
        <span class="s1">query </span><span class="s3">= </span><span class="s1">bytes</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s0"># Handle the first query result</span>
        <span class="s5">yield await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_result</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">QUERY</span><span class="s3">, </span><span class="s1">query</span><span class="s3">))</span>

        <span class="s0"># Handle next results, if any</span>
        <span class="s5">while </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_have_next_result</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>
            <span class="s5">yield await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_result</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>

    <span class="s5">async def </span><span class="s1">cmd_stmt_fetch</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">statement_id</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">1</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Fetch a MySQL statement Result Set. 
 
        This method will send the FETCH command to MySQL together with the given 
        statement id and the number of rows to fetch. 
        &quot;&quot;&quot;</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_stmt_fetch</span><span class="s3">(</span><span class="s1">statement_id</span><span class="s3">, </span><span class="s1">rows</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result </span><span class="s3">= </span><span class="s5">False</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STMT_FETCH</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">, </span><span class="s1">expect_response</span><span class="s3">=</span><span class="s5">False</span><span class="s3">)</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">unread_result </span><span class="s3">= </span><span class="s5">True</span>

    <span class="s5">async def </span><span class="s1">cmd_stmt_prepare</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">statement</span><span class="s3">: </span><span class="s1">bytes</span>
    <span class="s3">) </span><span class="s1">-&gt; Mapping</span><span class="s3">[</span><span class="s1">str</span><span class="s3">, </span><span class="s1">Union</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">DescriptionType</span><span class="s3">]]]:</span>
        <span class="s2">&quot;&quot;&quot;Prepare a MySQL statement. 
 
        This method will send the PREPARE command to MySQL together with the given 
        statement. 
        &quot;&quot;&quot;</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STMT_PREPARE</span><span class="s3">, </span><span class="s1">statement</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_binary_ok</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>

        <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;columns&quot;</span><span class="s3">] = []</span>
        <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;parameters&quot;</span><span class="s3">] = []</span>
        <span class="s5">if </span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;num_params&quot;</span><span class="s3">] &gt; </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s5">for </span><span class="s1">_ </span><span class="s5">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;num_params&quot;</span><span class="s3">]):</span>
                <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;parameters&quot;</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_column</span><span class="s3">(</span>
                        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">python_charset</span>
                    <span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>
        <span class="s5">if </span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;num_columns&quot;</span><span class="s3">] &gt; </span><span class="s6">0</span><span class="s3">:</span>
            <span class="s5">for </span><span class="s1">_ </span><span class="s5">in </span><span class="s1">range</span><span class="s3">(</span><span class="s6">0</span><span class="s3">, </span><span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;num_columns&quot;</span><span class="s3">]):</span>
                <span class="s1">result</span><span class="s3">[</span><span class="s4">&quot;columns&quot;</span><span class="s3">].</span><span class="s1">append</span><span class="s3">(</span>
                    <span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_column</span><span class="s3">(</span>
                        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(), </span><span class="s1">self</span><span class="s3">.</span><span class="s1">python_charset</span>
                    <span class="s3">)</span>
                <span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>

        <span class="s5">return </span><span class="s1">result</span>

    <span class="s5">async def </span><span class="s1">cmd_stmt_execute</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">statement_id</span><span class="s3">: </span><span class="s1">int</span><span class="s3">,  </span><span class="s0"># type: ignore[override]</span>
        <span class="s1">data</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">BinaryProtocolType</span><span class="s3">] = (),</span>
        <span class="s1">parameters</span><span class="s3">: </span><span class="s1">Sequence</span><span class="s3">[</span><span class="s1">Any</span><span class="s3">] = (),</span>
        <span class="s1">flags</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s6">0</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Union</span><span class="s3">[</span><span class="s1">OkPacketType</span><span class="s3">, </span><span class="s1">Tuple</span><span class="s3">[</span><span class="s1">int</span><span class="s3">, </span><span class="s1">List</span><span class="s3">[</span><span class="s1">DescriptionType</span><span class="s3">], </span><span class="s1">EofPacketType</span><span class="s3">]]:</span>
        <span class="s2">&quot;&quot;&quot;Execute a prepared MySQL statement.&quot;&quot;&quot;</span>
        <span class="s1">parameters </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">parameters</span><span class="s3">)</span>
        <span class="s1">long_data_used </span><span class="s3">= {}</span>

        <span class="s5">if </span><span class="s1">data</span><span class="s3">:</span>
            <span class="s5">for </span><span class="s1">param_id</span><span class="s3">, </span><span class="s1">_ </span><span class="s5">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">parameters</span><span class="s3">):</span>
                <span class="s5">if </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">data</span><span class="s3">[</span><span class="s1">param_id</span><span class="s3">], </span><span class="s1">IOBase</span><span class="s3">):</span>
                    <span class="s1">binary </span><span class="s3">= </span><span class="s5">True</span>
                    <span class="s5">try</span><span class="s3">:</span>
                        <span class="s1">binary </span><span class="s3">= </span><span class="s4">&quot;b&quot; </span><span class="s5">not in </span><span class="s1">data</span><span class="s3">[</span><span class="s1">param_id</span><span class="s3">].</span><span class="s1">mode  </span><span class="s0"># type: ignore[union-attr]</span>
                    <span class="s5">except </span><span class="s1">AttributeError</span><span class="s3">:</span>
                        <span class="s5">pass</span>
                    <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_stmt_send_long_data</span><span class="s3">(</span>
                        <span class="s1">statement_id</span><span class="s3">, </span><span class="s1">param_id</span><span class="s3">, </span><span class="s1">data</span><span class="s3">[</span><span class="s1">param_id</span><span class="s3">]</span>
                    <span class="s3">)</span>
                    <span class="s1">long_data_used</span><span class="s3">[</span><span class="s1">param_id</span><span class="s3">] = (</span><span class="s1">binary</span><span class="s3">,)</span>
        <span class="s5">if not </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs_supported </span><span class="s5">and </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs</span><span class="s3">:</span>
            <span class="s1">warnings</span><span class="s3">.</span><span class="s1">warn</span><span class="s3">(</span>
                <span class="s4">&quot;This version of the server does not support Query Attributes&quot;</span><span class="s3">,</span>
                <span class="s1">category</span><span class="s3">=</span><span class="s1">Warning</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CLIENT_QUERY_ATTRIBUTES</span><span class="s3">:</span>
            <span class="s1">execute_packet </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_stmt_execute</span><span class="s3">(</span>
                <span class="s1">statement_id</span><span class="s3">,</span>
                <span class="s1">data</span><span class="s3">,</span>
                <span class="s1">tuple</span><span class="s3">(</span><span class="s1">parameters</span><span class="s3">),</span>
                <span class="s1">flags</span><span class="s3">,</span>
                <span class="s1">long_data_used</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">charset</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_query_attrs</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">_converter_str_fallback</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s5">else</span><span class="s3">:</span>
            <span class="s1">execute_packet </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_stmt_execute</span><span class="s3">(</span>
                <span class="s1">statement_id</span><span class="s3">,</span>
                <span class="s1">data</span><span class="s3">,</span>
                <span class="s1">tuple</span><span class="s3">(</span><span class="s1">parameters</span><span class="s3">),</span>
                <span class="s1">flags</span><span class="s3">,</span>
                <span class="s1">long_data_used</span><span class="s3">,</span>
                <span class="s1">self</span><span class="s3">.</span><span class="s1">charset</span><span class="s3">,</span>
                <span class="s1">converter_str_fallback</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_converter_str_fallback</span><span class="s3">,</span>
            <span class="s3">)</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STMT_EXECUTE</span><span class="s3">, </span><span class="s1">packet</span><span class="s3">=</span><span class="s1">execute_packet</span><span class="s3">)</span>
        <span class="s1">result </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_binary_result</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">return </span><span class="s1">result</span>

    <span class="s5">async def </span><span class="s1">cmd_stmt_reset</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">statement_id</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Reset data for prepared statement sent as long data. 
 
        The result is a dictionary with OK packet information. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STMT_RESET</span><span class="s3">, </span><span class="s1">int4store</span><span class="s3">(</span><span class="s1">statement_id</span><span class="s3">)),</span>
        <span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">cmd_stmt_close</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">statement_id</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Deallocate a prepared MySQL statement. 
 
        This method deallocates the prepared statement using the statement_id. 
        Note that the MySQL server does not return anything. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span>
            <span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STMT_CLOSE</span><span class="s3">,</span>
            <span class="s1">int4store</span><span class="s3">(</span><span class="s1">statement_id</span><span class="s3">),</span>
            <span class="s1">expect_response</span><span class="s3">=</span><span class="s5">False</span><span class="s3">,</span>
        <span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">cmd_refresh</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">options</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; OkPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send the Refresh command to the MySQL server. 
 
        This method sends the Refresh command to the MySQL server. The options 
        argument should be a bitwise value using constants.RefreshOption. 
 
        Usage example: 
           RefreshOption = mysql.connector.RefreshOption 
           refresh = RefreshOption.LOG | RefreshOption.INFO 
           cnx.cmd_refresh(refresh) 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">options </span><span class="s3">&amp; (</span>
            <span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">GRANT</span>
            <span class="s3">| </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">LOG</span>
            <span class="s3">| </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">TABLES</span>
            <span class="s3">| </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">HOST</span>
            <span class="s3">| </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">STATUS</span>
            <span class="s3">| </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">REPLICA</span>
        <span class="s3">):</span>
            <span class="s5">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;Invalid command REFRESH option&quot;</span><span class="s3">)</span>

        <span class="s1">res </span><span class="s3">= </span><span class="s5">None</span>
        <span class="s5">if </span><span class="s1">options </span><span class="s3">&amp; </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">GRANT</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">&quot;FLUSH PRIVILEGES&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">options </span><span class="s3">&amp; </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">LOG</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">&quot;FLUSH LOGS&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">options </span><span class="s3">&amp; </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">TABLES</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">&quot;FLUSH TABLES&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">options </span><span class="s3">&amp; </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">HOST</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">&quot;TRUNCATE TABLE performance_schema.host_cache&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">options </span><span class="s3">&amp; </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">STATUS</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">&quot;FLUSH STATUS&quot;</span><span class="s3">)</span>
        <span class="s5">if </span><span class="s1">options </span><span class="s3">&amp; </span><span class="s1">RefreshOption</span><span class="s3">.</span><span class="s1">REPLICA</span><span class="s3">:</span>
            <span class="s1">res </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span>
                <span class="s4">&quot;RESET SLAVE&quot;</span>
                <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_server_info</span><span class="s3">.</span><span class="s1">version_tuple </span><span class="s3">&lt; (</span><span class="s6">8</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">22</span><span class="s3">)</span>
                <span class="s5">else </span><span class="s4">&quot;RESET REPLICA&quot;</span>
            <span class="s3">)</span>

        <span class="s5">return </span><span class="s1">res  </span><span class="s0"># type: ignore[return-value]</span>

    <span class="s5">async def </span><span class="s1">cmd_stmt_send_long_data</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">, </span><span class="s1">statement_id</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">param_id</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">data</span><span class="s3">: </span><span class="s1">BinaryIO</span>
    <span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send data for a column. 
 
        This methods send data for a column (for example BLOB) for statement identified 
        by statement_id. The param_id indicate which parameter the data belongs too. 
        The data argument should be a file-like object. 
 
        Since MySQL does not send anything back, no error is raised. When the MySQL 
        server is not reachable, an OperationalError is raised. 
 
        cmd_stmt_send_long_data should be called before cmd_stmt_execute. 
 
        The total bytes send is returned. 
        &quot;&quot;&quot;</span>
        <span class="s1">chunk_size </span><span class="s3">= </span><span class="s6">131072  </span><span class="s0"># 128 KB</span>
        <span class="s1">total_sent </span><span class="s3">= </span><span class="s6">0</span>
        <span class="s5">try</span><span class="s3">:</span>
            <span class="s1">buf </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunk_size</span><span class="s3">)</span>
            <span class="s5">while </span><span class="s1">buf</span><span class="s3">:</span>
                <span class="s1">packet </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">prepare_stmt_send_long_data</span><span class="s3">(</span>
                    <span class="s1">statement_id</span><span class="s3">, </span><span class="s1">param_id</span><span class="s3">, </span><span class="s1">buf</span>
                <span class="s3">)</span>
                <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span>
                    <span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STMT_SEND_LONG_DATA</span><span class="s3">,</span>
                    <span class="s1">packet</span><span class="s3">=</span><span class="s1">packet</span><span class="s3">,</span>
                    <span class="s1">expect_response</span><span class="s3">=</span><span class="s5">False</span><span class="s3">,</span>
                <span class="s3">)</span>
                <span class="s1">total_sent </span><span class="s3">+= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">buf</span><span class="s3">)</span>
                <span class="s1">buf </span><span class="s3">= </span><span class="s1">data</span><span class="s3">.</span><span class="s1">read</span><span class="s3">(</span><span class="s1">chunk_size</span><span class="s3">)</span>
        <span class="s5">except </span><span class="s1">AttributeError </span><span class="s5">as </span><span class="s1">err</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">OperationalError</span><span class="s3">(</span><span class="s4">&quot;MySQL Connection not available&quot;</span><span class="s3">) </span><span class="s5">from </span><span class="s1">err</span>

        <span class="s5">return </span><span class="s1">total_sent</span>

    <span class="s5">async def </span><span class="s1">cmd_quit</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; bytes</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Close the current connection with the server. 
 
        Send the QUIT command to the MySQL server, closing the current connection. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>
        <span class="s1">packet </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_command</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">QUIT</span><span class="s3">)</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">)</span>
        <span class="s5">return </span><span class="s1">packet</span>

    <span class="s5">async def </span><span class="s1">cmd_shutdown</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">shutdown_type</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s5">None</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Shut down the MySQL Server. 
 
        This method sends the SHUTDOWN command to the MySQL server. 
        The `shutdown_type` is not used, and it's kept for backward compatibility. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">&quot;SHUTDOWN&quot;</span><span class="s3">)</span>

    <span class="s5">async def </span><span class="s1">cmd_statistics</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; StatsPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send the statistics command to the MySQL Server. 
 
        This method sends the STATISTICS command to the MySQL server. The result is a 
        dictionary with various statistical information. 
        &quot;&quot;&quot;</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>

        <span class="s1">packet </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">make_command</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">STATISTICS</span><span class="s3">)</span>
        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">write</span><span class="s3">(</span><span class="s1">packet</span><span class="s3">, </span><span class="s6">0</span><span class="s3">, </span><span class="s6">0</span><span class="s3">)</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_protocol</span><span class="s3">.</span><span class="s1">parse_statistics</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">.</span><span class="s1">read</span><span class="s3">())</span>

    <span class="s5">async def </span><span class="s1">cmd_process_kill</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">mysql_pid</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; OkPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Kill a MySQL process. 
 
        This method send the PROCESS_KILL command to the server along with the 
        process ID. The result is a dictionary with the OK packet information. 
        &quot;&quot;&quot;</span>
        <span class="s5">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">mysql_pid</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
            <span class="s5">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;MySQL PID must be int&quot;</span><span class="s3">)</span>
        <span class="s5">return await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_query</span><span class="s3">(</span><span class="s4">f&quot;KILL </span><span class="s5">{</span><span class="s1">mysql_pid</span><span class="s5">}</span><span class="s4">&quot;</span><span class="s3">)  </span><span class="s0"># type: ignore[return-value]</span>

    <span class="s5">async def </span><span class="s1">cmd_debug</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; EofPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send the DEBUG command. 
 
        This method sends the DEBUG command to the MySQL server, which requires the 
        MySQL user to have SUPER privilege. The output will go to the MySQL server 
        error log and the result of this method is a dictionary with EOF packet 
        information. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_eof</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">DEBUG</span><span class="s3">))</span>

    <span class="s5">async def </span><span class="s1">cmd_ping</span><span class="s3">(</span><span class="s1">self</span><span class="s3">) </span><span class="s1">-&gt; OkPacketType</span><span class="s3">:</span>
        <span class="s2">&quot;&quot;&quot;Send the PING command. 
 
        This method sends the PING command to the MySQL server. It is used to check 
        if the the connection is still valid. The result of this method is dictionary 
        with OK packet information. 
        &quot;&quot;&quot;</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_send_cmd</span><span class="s3">(</span><span class="s1">ServerCmd</span><span class="s3">.</span><span class="s1">PING</span><span class="s3">))</span>

    <span class="s5">async def </span><span class="s1">cmd_change_user</span><span class="s3">(</span>
        <span class="s1">self</span><span class="s3">,</span>
        <span class="s1">username</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">password</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">database</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">charset</span><span class="s3">: </span><span class="s1">Optional</span><span class="s3">[</span><span class="s1">int</span><span class="s3">] = </span><span class="s5">None</span><span class="s3">,</span>
        <span class="s1">password1</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">password2</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">password3</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">oci_config_file</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
        <span class="s1">oci_config_profile</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">&quot;&quot;</span><span class="s3">,</span>
    <span class="s3">) </span><span class="s1">-&gt; Optional</span><span class="s3">[</span><span class="s1">OkPacketType</span><span class="s3">]:</span>
        <span class="s2">&quot;&quot;&quot;Change the current logged in user. 
 
        This method allows to change the current logged in user information. 
        The result is a dictionary with OK packet information. 
        &quot;&quot;&quot;</span>
        <span class="s0"># If charset isn't defined, we use the same charset ID defined previously,</span>
        <span class="s0"># otherwise, we run a verification and update the charset ID.</span>
        <span class="s5">if </span><span class="s1">charset </span><span class="s5">is not None</span><span class="s3">:</span>
            <span class="s5">if not </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">, </span><span class="s1">int</span><span class="s3">):</span>
                <span class="s5">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;charset must be an integer&quot;</span><span class="s3">)</span>
            <span class="s5">if </span><span class="s1">charset </span><span class="s3">&lt; </span><span class="s6">0</span><span class="s3">:</span>
                <span class="s5">raise </span><span class="s1">ValueError</span><span class="s3">(</span><span class="s4">&quot;charset should be either zero or a postive integer&quot;</span><span class="s3">)</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_charset </span><span class="s3">= </span><span class="s1">charsets</span><span class="s3">.</span><span class="s1">get_by_id</span><span class="s3">(</span><span class="s1">charset</span><span class="s3">)</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_mfa_nfactor </span><span class="s3">= </span><span class="s6">1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_user </span><span class="s3">= </span><span class="s1">username</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_password </span><span class="s3">= </span><span class="s1">password</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_password1 </span><span class="s3">= </span><span class="s1">password1</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_password2 </span><span class="s3">= </span><span class="s1">password2</span>
        <span class="s1">self</span><span class="s3">.</span><span class="s1">_password3 </span><span class="s3">= </span><span class="s1">password3</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password1 </span><span class="s5">and </span><span class="s1">password </span><span class="s3">!= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password1</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_password </span><span class="s3">= </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password1</span>

        <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">handle_unread_result</span><span class="s3">()</span>

        <span class="s5">if </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_compress</span><span class="s3">:</span>
            <span class="s5">raise </span><span class="s1">NotSupportedError</span><span class="s3">(</span><span class="s4">&quot;Change user is not supported with compression&quot;</span><span class="s3">)</span>

        <span class="s5">if </span><span class="s1">oci_config_file</span><span class="s3">:</span>
            <span class="s1">self</span><span class="s3">.</span><span class="s1">_oci_config_file </span><span class="s3">= </span><span class="s1">oci_config_file</span>

        <span class="s1">self</span><span class="s3">.</span><span class="s1">_oci_config_profile </span><span class="s3">= </span><span class="s1">oci_config_profile</span>

        <span class="s1">ok_packet</span><span class="s3">: </span><span class="s1">bytes </span><span class="s3">= </span><span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_authenticator</span><span class="s3">.</span><span class="s1">authenticate</span><span class="s3">(</span>
            <span class="s1">sock</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_socket</span><span class="s3">,</span>
            <span class="s1">handshake</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handshake</span><span class="s3">,</span>
            <span class="s1">username</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_user</span><span class="s3">,</span>
            <span class="s1">password1</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password</span><span class="s3">,</span>
            <span class="s1">password2</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password2</span><span class="s3">,</span>
            <span class="s1">password3</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_password3</span><span class="s3">,</span>
            <span class="s1">database</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_database</span><span class="s3">,</span>
            <span class="s1">charset</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_charset</span><span class="s3">.</span><span class="s1">charset_id</span><span class="s3">,</span>
            <span class="s1">client_flags</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags</span><span class="s3">,</span>
            <span class="s1">ssl_enabled</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_ssl_active</span><span class="s3">,</span>
            <span class="s1">auth_plugin</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin</span><span class="s3">,</span>
            <span class="s1">conn_attrs</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_connection_attrs</span><span class="s3">,</span>
            <span class="s1">auth_plugin_class</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_auth_plugin_class</span><span class="s3">,</span>
            <span class="s1">oci_config_file</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_oci_config_file</span><span class="s3">,</span>
            <span class="s1">oci_config_profile</span><span class="s3">=</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_oci_config_profile</span><span class="s3">,</span>
            <span class="s1">is_change_user_request</span><span class="s3">=</span><span class="s5">True</span><span class="s3">,</span>
        <span class="s3">)</span>

        <span class="s5">if not </span><span class="s3">(</span><span class="s1">self</span><span class="s3">.</span><span class="s1">_client_flags </span><span class="s3">&amp; </span><span class="s1">ClientFlag</span><span class="s3">.</span><span class="s1">CONNECT_WITH_DB</span><span class="s3">) </span><span class="s5">and </span><span class="s1">database</span><span class="s3">:</span>
            <span class="s5">await </span><span class="s1">self</span><span class="s3">.</span><span class="s1">cmd_init_db</span><span class="s3">(</span><span class="s1">database</span><span class="s3">)</span>

        <span class="s0"># return ok_pkt</span>
        <span class="s5">return </span><span class="s1">self</span><span class="s3">.</span><span class="s1">_handle_ok</span><span class="s3">(</span><span class="s1">ok_packet</span><span class="s3">)</span>
</pre>
</body>
</html>