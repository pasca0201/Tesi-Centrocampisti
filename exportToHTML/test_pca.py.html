<html>
<head>
<title>test_pca.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_pca.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">scipy </span><span class="s0">as </span><span class="s1">sp</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_array_equal</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">config_context</span><span class="s2">, </span><span class="s1">datasets</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">clone</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">datasets </span><span class="s0">import </span><span class="s1">load_iris</span><span class="s2">, </span><span class="s1">make_classification</span><span class="s2">, </span><span class="s1">make_low_rank_matrix</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">decomposition </span><span class="s0">import </span><span class="s1">PCA</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">decomposition</span><span class="s2">.</span><span class="s1">_pca </span><span class="s0">import </span><span class="s1">_assess_dimension</span><span class="s2">, </span><span class="s1">_infer_dimension</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_array_api </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_atol_for_type</span><span class="s2">,</span>
    <span class="s1">_convert_to_numpy</span><span class="s2">,</span>
    <span class="s1">yield_namespace_device_dtype_combinations</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_array_api </span><span class="s0">import </span><span class="s1">device </span><span class="s0">as </span><span class="s1">array_device</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">import </span><span class="s1">_array_api_for_tests</span><span class="s2">, </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">estimator_checks </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">_get_check_estimator_ids</span><span class="s2">,</span>
    <span class="s1">check_array_api_input_and_values</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">sklearn</span><span class="s2">.</span><span class="s1">utils</span><span class="s2">.</span><span class="s1">fixes </span><span class="s0">import </span><span class="s1">CSC_CONTAINERS</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS</span>

<span class="s1">iris </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_iris</span><span class="s2">()</span>
<span class="s1">PCA_SOLVERS </span><span class="s2">= [</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s3">&quot;covariance_eigh&quot;</span><span class="s2">, </span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">, </span><span class="s3">&quot;auto&quot;</span><span class="s2">]</span>

<span class="s4"># `SPARSE_M` and `SPARSE_N` could be larger, but be aware:</span>
<span class="s4"># * SciPy's generation of random sparse matrix can be costly</span>
<span class="s4"># * A (SPARSE_M, SPARSE_N) dense array is allocated to compare against</span>
<span class="s1">SPARSE_M</span><span class="s2">, </span><span class="s1">SPARSE_N </span><span class="s2">= </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">300  </span><span class="s4"># arbitrary</span>
<span class="s1">SPARSE_MAX_COMPONENTS </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">SPARSE_M</span><span class="s2">, </span><span class="s1">SPARSE_N</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_check_fitted_pca_close</span><span class="s2">(</span><span class="s1">pca1</span><span class="s2">, </span><span class="s1">pca2</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-7</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-12</span><span class="s2">):</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">pca1</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">, </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span>
    <span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">mean_</span><span class="s2">, </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">mean_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">noise_variance_</span><span class="s2">, </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">noise_variance_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">n_components_</span>
    <span class="s0">assert </span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">n_samples_ </span><span class="s2">== </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">n_samples_</span>
    <span class="s0">assert </span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">n_features_in_ </span><span class="s2">== </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">n_features_in_</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n_components&quot;</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]))</span>
<span class="s0">def </span><span class="s1">test_pca</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">):</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>

    <span class="s4"># check the shape of fit.transform</span>
    <span class="s1">X_r </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_r</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] == </span><span class="s1">n_components</span>

    <span class="s4"># check the equivalence of fit.transform and fit_transform</span>
    <span class="s1">X_r2 </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_r</span><span class="s2">, </span><span class="s1">X_r2</span><span class="s2">)</span>
    <span class="s1">X_r </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_r</span><span class="s2">, </span><span class="s1">X_r2</span><span class="s2">)</span>

    <span class="s4"># Test get_covariance and get_precision</span>
    <span class="s1">cov </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">get_covariance</span><span class="s2">()</span>
    <span class="s1">precision </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">get_precision</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">cov</span><span class="s2">, </span><span class="s1">precision</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-12</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;density&quot;</span><span class="s2">, [</span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.30</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;n_components&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s3">&quot;covariance_eigh&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;scale&quot;</span><span class="s2">, [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pca_sparse</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">sparse_container</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">density</span><span class="s2">, </span><span class="s1">scale</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that the results are the same for sparse and dense input.&quot;&quot;&quot;</span>

    <span class="s4"># Set atol in addition of the default rtol to account for the very wide range of</span>
    <span class="s4"># result values (1e-8 to 1e0).</span>
    <span class="s1">atol </span><span class="s2">= </span><span class="s5">1e-12</span>
    <span class="s1">transform_atol </span><span class="s2">= </span><span class="s5">1e-10</span>

    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span>
            <span class="s1">SPARSE_M</span><span class="s2">,</span>
            <span class="s1">SPARSE_N</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
            <span class="s1">density</span><span class="s2">=</span><span class="s1">density</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s4"># Scale the data + vary the column means</span>
    <span class="s1">scale_vector </span><span class="s2">= </span><span class="s1">random_state</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]) * </span><span class="s1">scale</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">multiply</span><span class="s2">(</span><span class="s1">scale_vector</span><span class="s2">)</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">Xd </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>
    <span class="s1">pcad </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">pcad</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xd</span><span class="s2">)</span>

    <span class="s4"># Fitted attributes equality</span>
    <span class="s1">_check_fitted_pca_close</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">, </span><span class="s1">pcad</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">)</span>

    <span class="s4"># Test transform</span>
    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span>
            <span class="s1">SPARSE_M</span><span class="s2">,</span>
            <span class="s1">SPARSE_N</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
            <span class="s1">density</span><span class="s2">=</span><span class="s1">density</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">X2d </span><span class="s2">= </span><span class="s1">X2</span><span class="s2">.</span><span class="s1">toarray</span><span class="s2">()</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">), </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2d</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">transform_atol</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">), </span><span class="s1">pcad</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2d</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s1">transform_atol</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_sparse_fit_transform</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">, </span><span class="s1">sparse_container</span><span class="s2">):</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span>
            <span class="s1">SPARSE_M</span><span class="s2">,</span>
            <span class="s1">SPARSE_N</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
            <span class="s1">density</span><span class="s2">=</span><span class="s5">0.01</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">X2 </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span>
            <span class="s1">SPARSE_M</span><span class="s2">,</span>
            <span class="s1">SPARSE_N</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
            <span class="s1">density</span><span class="s2">=</span><span class="s5">0.01</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">pca_fit </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">pca_fit_transform </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span>
    <span class="s2">)</span>

    <span class="s1">pca_fit</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">transformed_X </span><span class="s2">= </span><span class="s1">pca_fit_transform</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">_check_fitted_pca_close</span><span class="s2">(</span><span class="s1">pca_fit</span><span class="s2">, </span><span class="s1">pca_fit_transform</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">transformed_X</span><span class="s2">, </span><span class="s1">pca_fit_transform</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">transformed_X</span><span class="s2">, </span><span class="s1">pca_fit</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_fit</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">), </span><span class="s1">pca_fit_transform</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X2</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;randomized&quot;</span><span class="s2">, </span><span class="s3">&quot;full&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sparse_pca_solver_error</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">sparse_container</span><span class="s2">):</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span>
            <span class="s1">SPARSE_M</span><span class="s2">,</span>
            <span class="s1">SPARSE_N</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">30</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>
    <span class="s1">error_msg_pattern </span><span class="s2">= (</span>
        <span class="s3">'PCA only support sparse inputs with the &quot;arpack&quot; and &quot;covariance_eigh&quot;'</span>
        <span class="s3">f' solvers, while &quot;</span><span class="s0">{</span><span class="s1">svd_solver</span><span class="s0">}</span><span class="s3">&quot; was passed'</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">error_msg_pattern</span><span class="s2">):</span>
        <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;sparse_container&quot;</span><span class="s2">, </span><span class="s1">CSR_CONTAINERS </span><span class="s2">+ </span><span class="s1">CSC_CONTAINERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sparse_pca_auto_arpack_singluar_values_consistency</span><span class="s2">(</span>
    <span class="s1">global_random_seed</span><span class="s2">, </span><span class="s1">sparse_container</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check that &quot;auto&quot; and &quot;arpack&quot; solvers are equivalent for sparse inputs.&quot;&quot;&quot;</span>
    <span class="s1">random_state </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">sparse_container</span><span class="s2">(</span>
        <span class="s1">sp</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span>
            <span class="s1">SPARSE_M</span><span class="s2">,</span>
            <span class="s1">SPARSE_N</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">random_state</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">pca_arpack </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;arpack&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">pca_auto </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;auto&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_arpack</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">pca_auto</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_no_empty_slice_warning</span><span class="s2">():</span>
    <span class="s4"># test if we avoid numpy warnings for computing over empty arrays</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s1">n_components </span><span class="s2">+ </span><span class="s5">2  </span><span class="s4"># anything &gt; n_comps triggered it in 0.16</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">warnings</span><span class="s2">.</span><span class="s1">catch_warnings</span><span class="s2">():</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">simplefilter</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s1">RuntimeWarning</span><span class="s2">)</span>
        <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;copy&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_whitening</span><span class="s2">(</span><span class="s1">solver</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">):</span>
    <span class="s4"># Check that PCA output has unit-variance</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">80</span>
    <span class="s1">n_components </span><span class="s2">= </span><span class="s5">30</span>
    <span class="s1">rank </span><span class="s2">= </span><span class="s5">50</span>

    <span class="s4"># some low rank data with correlated features</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span>
        <span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">),</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">diag</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s5">10.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">)), </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">rank</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)),</span>
    <span class="s2">)</span>
    <span class="s4"># the component-wise variance of the first 50 features is 3 times the</span>
    <span class="s4"># mean component-wise variance of the remaining 30 features</span>
    <span class="s1">X</span><span class="s2">[:, :</span><span class="s5">50</span><span class="s2">] *= </span><span class="s5">3</span>

    <span class="s0">assert </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s4"># the component-wise variance is thus highly varying:</span>
    <span class="s0">assert </span><span class="s1">X</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">).</span><span class="s1">std</span><span class="s2">() &gt; </span><span class="s5">43.8</span>

    <span class="s4"># whiten the data while projecting to the lower dim subspace</span>
    <span class="s1">X_ </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()  </span><span class="s4"># make sure we keep an original across iterations.</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">whiten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">,</span>
        <span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
        <span class="s1">iterated_power</span><span class="s2">=</span><span class="s5">7</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s4"># test fit_transform</span>
    <span class="s1">X_whitened </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s1">X_whitened</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">)</span>
    <span class="s1">X_whitened2 </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_whitened</span><span class="s2">, </span><span class="s1">X_whitened2</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-4</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_whitened</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">ddof</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_whitened</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-12</span><span class="s2">)</span>

    <span class="s1">X_ </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s1">copy</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">solver</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">())</span>
    <span class="s1">X_unwhitened </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_unwhitened</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">)</span>

    <span class="s4"># in that case the output components still have varying variances</span>
    <span class="s0">assert </span><span class="s1">X_unwhitened</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(</span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">).</span><span class="s1">std</span><span class="s2">() == </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s5">74.1</span><span class="s2">, </span><span class="s1">rel</span><span class="s2">=</span><span class="s5">1e-1</span><span class="s2">)</span>
    <span class="s4"># we always center, so no test for non-centering.</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;other_svd_solver&quot;</span><span class="s2">, </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">PCA_SOLVERS</span><span class="s2">) - {</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s3">&quot;auto&quot;</span><span class="s2">}))</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;data_shape&quot;</span><span class="s2">, [</span><span class="s3">&quot;tall&quot;</span><span class="s2">, </span><span class="s3">&quot;wide&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;rank_deficient&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;whiten&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pca_solver_equivalence</span><span class="s2">(</span>
    <span class="s1">other_svd_solver</span><span class="s2">,</span>
    <span class="s1">data_shape</span><span class="s2">,</span>
    <span class="s1">rank_deficient</span><span class="s2">,</span>
    <span class="s1">whiten</span><span class="s2">,</span>
    <span class="s1">global_random_seed</span><span class="s2">,</span>
    <span class="s1">global_dtype</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">if </span><span class="s1">data_shape </span><span class="s2">== </span><span class="s3">&quot;tall&quot;</span><span class="s2">:</span>
        <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">30</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">30</span><span class="s2">, </span><span class="s5">100</span>
    <span class="s1">n_samples_test </span><span class="s2">= </span><span class="s5">10</span>

    <span class="s0">if </span><span class="s1">rank_deficient</span><span class="s2">:</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s1">global_random_seed</span><span class="s2">)</span>
        <span class="s1">rank </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) // </span><span class="s5">2</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span>
            <span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples </span><span class="s2">+ </span><span class="s1">n_samples_test</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">)</span>
        <span class="s2">) @ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">standard_normal</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">rank</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">X </span><span class="s2">= </span><span class="s1">make_low_rank_matrix</span><span class="s2">(</span>
            <span class="s1">n_samples</span><span class="s2">=</span><span class="s1">n_samples </span><span class="s2">+ </span><span class="s1">n_samples_test</span><span class="s2">,</span>
            <span class="s1">n_features</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
            <span class="s1">tail_strength</span><span class="s2">=</span><span class="s5">0.5</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s4"># With a non-zero tail strength, the data is actually full-rank.</span>
        <span class="s1">rank </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">global_dtype</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_train</span><span class="s2">, </span><span class="s1">X_test </span><span class="s2">= </span><span class="s1">X</span><span class="s2">[:</span><span class="s1">n_samples</span><span class="s2">], </span><span class="s1">X</span><span class="s2">[</span><span class="s1">n_samples</span><span class="s2">:]</span>

    <span class="s0">if </span><span class="s1">global_dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">:</span>
        <span class="s1">tols </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">atol</span><span class="s2">=</span><span class="s5">3e-2</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-5</span><span class="s2">)</span>
        <span class="s1">variance_threshold </span><span class="s2">= </span><span class="s5">1e-5</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tols </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-10</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-12</span><span class="s2">)</span>
        <span class="s1">variance_threshold </span><span class="s2">= </span><span class="s5">1e-12</span>

    <span class="s1">extra_other_kwargs </span><span class="s2">= {}</span>
    <span class="s0">if </span><span class="s1">other_svd_solver </span><span class="s2">== </span><span class="s3">&quot;randomized&quot;</span><span class="s2">:</span>
        <span class="s4"># Only check for a truncated result with a large number of iterations</span>
        <span class="s4"># to make sure that we can recover precise results.</span>
        <span class="s1">n_components </span><span class="s2">= </span><span class="s5">10</span>
        <span class="s1">extra_other_kwargs </span><span class="s2">= {</span><span class="s3">&quot;iterated_power&quot;</span><span class="s2">: </span><span class="s5">50</span><span class="s2">}</span>
    <span class="s0">elif </span><span class="s1">other_svd_solver </span><span class="s2">== </span><span class="s3">&quot;arpack&quot;</span><span class="s2">:</span>
        <span class="s4"># Test all components except the last one which cannot be estimated by</span>
        <span class="s4"># arpack.</span>
        <span class="s1">n_components </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">minimum</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">) - </span><span class="s5">1</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s4"># Test all components to high precision.</span>
        <span class="s1">n_components </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s1">pca_full </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s1">whiten</span><span class="s2">)</span>
    <span class="s1">pca_other </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">,</span>
        <span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">other_svd_solver</span><span class="s2">,</span>
        <span class="s1">whiten</span><span class="s2">=</span><span class="s1">whiten</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s1">global_random_seed</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">extra_other_kwargs</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">X_trans_full_train </span><span class="s2">= </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">X_trans_full_train</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_trans_full_train</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">global_dtype</span>
    <span class="s1">X_trans_other_train </span><span class="s2">= </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X_train</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">X_trans_other_train</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_trans_other_train</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">global_dtype</span>

    <span class="s0">assert </span><span class="s2">(</span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">explained_variance_ </span><span class="s2">&gt;= </span><span class="s5">0</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">, </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">, **</span><span class="s1">tols</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">pca_full</span><span class="s2">.</span><span class="s1">explained_variance_ratio_</span><span class="s2">,</span>
        <span class="s1">pca_other</span><span class="s2">.</span><span class="s1">explained_variance_ratio_</span><span class="s2">,</span>
        <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">reference_components </span><span class="s2">= </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">components_</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">reference_components</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s1">other_components </span><span class="s2">= </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">components_</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">other_components</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>

    <span class="s4"># For some choice of n_components and data distribution, some components</span>
    <span class="s4"># might be pure noise, let's ignore them in the comparison:</span>
    <span class="s1">stable </span><span class="s2">= </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">explained_variance_ </span><span class="s2">&gt; </span><span class="s1">variance_threshold</span>
    <span class="s0">assert </span><span class="s1">stable</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">() &gt; </span><span class="s5">1</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">reference_components</span><span class="s2">[</span><span class="s1">stable</span><span class="s2">], </span><span class="s1">other_components</span><span class="s2">[</span><span class="s1">stable</span><span class="s2">], **</span><span class="s1">tols</span><span class="s2">)</span>

    <span class="s4"># As a result the output of fit_transform should be the same:</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">X_trans_other_train</span><span class="s2">[:, </span><span class="s1">stable</span><span class="s2">], </span><span class="s1">X_trans_full_train</span><span class="s2">[:, </span><span class="s1">stable</span><span class="s2">], **</span><span class="s1">tols</span>
    <span class="s2">)</span>

    <span class="s4"># And similarly for the output of transform on new data (except for the</span>
    <span class="s4"># last component that can be underdetermined):</span>
    <span class="s1">X_trans_full_test </span><span class="s2">= </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">X_trans_full_test</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_trans_full_test</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">global_dtype</span>
    <span class="s1">X_trans_other_test </span><span class="s2">= </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_test</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">X_trans_other_test</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_trans_other_test</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">global_dtype</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans_other_test</span><span class="s2">[:, </span><span class="s1">stable</span><span class="s2">], </span><span class="s1">X_trans_full_test</span><span class="s2">[:, </span><span class="s1">stable</span><span class="s2">], **</span><span class="s1">tols</span><span class="s2">)</span>

    <span class="s4"># Check that inverse transform reconstructions for both solvers are</span>
    <span class="s4"># compatible.</span>
    <span class="s1">X_recons_full_test </span><span class="s2">= </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans_full_test</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">X_recons_full_test</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_recons_full_test</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">global_dtype</span>
    <span class="s1">X_recons_other_test </span><span class="s2">= </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">X_trans_other_test</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">X_recons_other_test</span><span class="s2">).</span><span class="s1">all</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">X_recons_other_test</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">global_dtype</span>

    <span class="s0">if </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] == </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]:</span>
        <span class="s4"># In this case, the models should have learned the same invertible</span>
        <span class="s4"># transform. They should therefore both be able to reconstruct the test</span>
        <span class="s4"># data.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_recons_full_test</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, **</span><span class="s1">tols</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_recons_other_test</span><span class="s2">, </span><span class="s1">X_test</span><span class="s2">, **</span><span class="s1">tols</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] &lt; </span><span class="s1">rank</span><span class="s2">:</span>
        <span class="s4"># In the absence of noisy components, both models should be able to</span>
        <span class="s4"># reconstruct the same low-rank approximation of the original data.</span>
        <span class="s0">assert </span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">.</span><span class="s1">min</span><span class="s2">() &gt; </span><span class="s1">variance_threshold</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_recons_full_test</span><span class="s2">, </span><span class="s1">X_recons_other_test</span><span class="s2">, **</span><span class="s1">tols</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s4"># When n_features &gt; n_samples and n_components is larger than the rank</span>
        <span class="s4"># of the training set, the output of the `inverse_transform` function</span>
        <span class="s4"># is ill-defined. We can only check that we reach the same fixed point</span>
        <span class="s4"># after another round of transform:</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">pca_full</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_recons_full_test</span><span class="s2">)[:, </span><span class="s1">stable</span><span class="s2">],</span>
            <span class="s1">pca_other</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_recons_other_test</span><span class="s2">)[:, </span><span class="s1">stable</span><span class="s2">],</span>
            <span class="s2">**</span><span class="s1">tols</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;X&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">80</span><span class="s2">),</span>
        <span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span><span class="s5">100</span><span class="s2">, </span><span class="s5">80</span><span class="s2">, </span><span class="s1">n_informative</span><span class="s2">=</span><span class="s5">78</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">],</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">100</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span><span class="s3">&quot;random-tall&quot;</span><span class="s2">, </span><span class="s3">&quot;correlated-tall&quot;</span><span class="s2">, </span><span class="s3">&quot;random-wide&quot;</span><span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_explained_variance_empirical</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X_pca </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s1">X_pca</span><span class="s2">, </span><span class="s1">ddof</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>

    <span class="s1">expected_result </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">eig</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">cov</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">rowvar</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">expected_result </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">expected_result</span><span class="s2">, </span><span class="s1">reverse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)[:</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_</span><span class="s2">, </span><span class="s1">expected_result</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pca_singular_values_consistency</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">80</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s1">pca_full </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">pca_other </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>

    <span class="s1">pca_full</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">pca_other</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_singular_values</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">80</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s4"># compare to the Frobenius norm</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">**</span><span class="s5">2</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">norm</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s3">&quot;fro&quot;</span><span class="s2">) ** </span><span class="s5">2</span>
    <span class="s2">)</span>
    <span class="s4"># Compare to the 2-norms of the score vectors</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">**</span><span class="s5">2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)))</span>

    <span class="s4"># set the singular values and see what er get back</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">110</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">/= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sum</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">**</span><span class="s5">2</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">))</span>
    <span class="s1">X_trans</span><span class="s2">[:, </span><span class="s5">0</span><span class="s2">] *= </span><span class="s5">3.142</span>
    <span class="s1">X_trans</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">] *= </span><span class="s5">2.718</span>
    <span class="s1">X_hat </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">, </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_hat</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">singular_values_</span><span class="s2">, [</span><span class="s5">3.142</span><span class="s2">, </span><span class="s5">2.718</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">])</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_check_projection</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Test that the projection of data is correct</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">3</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1</span>
    <span class="s1">X</span><span class="s2">[:</span><span class="s5">10</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s5">0.1 </span><span class="s2">* </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>

    <span class="s1">Yt </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">).</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">)</span>
    <span class="s1">Yt </span><span class="s2">/= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sqrt</span><span class="s2">((</span><span class="s1">Yt</span><span class="s2">**</span><span class="s5">2</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">())</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">Yt</span><span class="s2">[</span><span class="s5">0</span><span class="s2">][</span><span class="s5">0</span><span class="s2">]), </span><span class="s5">1.0</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_check_projection_list</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Test that the projection of data is correct</span>
    <span class="s1">X </span><span class="s2">= [[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">], [</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">]]</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X_trans </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(), </span><span class="s5">0.00</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-12</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X_trans</span><span class="s2">.</span><span class="s1">std</span><span class="s2">(), </span><span class="s5">0.71</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;whiten&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pca_inverse</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">):</span>
    <span class="s4"># Test that the projection of data can be inverted</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">50</span><span class="s2">, </span><span class="s5">3</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)  </span><span class="s4"># spherical data</span>
    <span class="s1">X</span><span class="s2">[:, </span><span class="s5">1</span><span class="s2">] *= </span><span class="s5">0.00001  </span><span class="s4"># make middle component relatively small</span>
    <span class="s1">X </span><span class="s2">+= [</span><span class="s5">5</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">3</span><span class="s2">]  </span><span class="s4"># make a large mean</span>

    <span class="s4"># same check that we can find the original data from the transformed</span>
    <span class="s4"># signal (since the data is almost of rank n_components)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s1">whiten</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">Y_inverse </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">inverse_transform</span><span class="s2">(</span><span class="s1">Y</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">Y_inverse</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-6</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;data&quot;</span><span class="s2">, [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">], [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">]]).</span><span class="s1">T</span><span class="s2">]</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;svd_solver, n_components, err_msg&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s3">r&quot;must be between 1 and min\(n_samples, n_features\)&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;randomized&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s3">r&quot;must be between 1 and min\(n_samples, n_features\)&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s3">r&quot;must be strictly less than min&quot;</span><span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;auto&quot;</span><span class="s2">,</span>
            <span class="s5">3</span><span class="s2">,</span>
            <span class="s2">(</span>
                <span class="s3">r&quot;n_components=3 must be between 0 and min\(n_samples, &quot;</span>
                <span class="s3">r&quot;n_features\)=2 with svd_solver='full'&quot;</span>
            <span class="s2">),</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_validation</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">):</span>
    <span class="s4"># Ensures that solver-specific extreme inputs for the n_components</span>
    <span class="s4"># parameter raise errors</span>
    <span class="s1">smallest_d </span><span class="s2">= </span><span class="s5">2  </span><span class="s4"># The smallest dimension</span>
    <span class="s1">pca_fitted </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">pca_fitted</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s4"># Additional case for arpack</span>
    <span class="s0">if </span><span class="s1">svd_solver </span><span class="s2">== </span><span class="s3">&quot;arpack&quot;</span><span class="s2">:</span>
        <span class="s1">n_components </span><span class="s2">= </span><span class="s1">smallest_d</span>

        <span class="s1">err_msg </span><span class="s2">= (</span>
            <span class="s3">&quot;n_components={}L? must be strictly less than &quot;</span>
            <span class="s3">r&quot;min\(n_samples, n_features\)={}L? with &quot;</span>
            <span class="s3">&quot;svd_solver='arpack'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">smallest_d</span><span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
            <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;solver, n_components_&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">) - </span><span class="s5">1</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;randomized&quot;</span><span class="s2">, </span><span class="s1">min</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;data&quot;</span><span class="s2">, [</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">T</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_n_components_none</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">, </span><span class="s1">n_components_</span><span class="s2">):</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s1">n_components_</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s3">&quot;full&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_n_components_mle</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Ensure that n_components == 'mle' doesn't raise error for auto/full</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">600</span><span class="s2">, </span><span class="s5">10</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s3">&quot;mle&quot;</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_n_components_mle_error</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Ensure that n_components == 'mle' will raise an error for unsupported</span>
    <span class="s4"># solvers</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">600</span><span class="s2">, </span><span class="s5">10</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s3">&quot;mle&quot;</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>
    <span class="s1">err_msg </span><span class="s2">= </span><span class="s3">&quot;n_components='mle' cannot be a string with svd_solver='{}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span>
        <span class="s1">svd_solver</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">err_msg</span><span class="s2">):</span>
        <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pca_dim</span><span class="s2">():</span>
    <span class="s4"># Check automated dimensionality setting</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">5</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1</span>
    <span class="s1">X</span><span class="s2">[:</span><span class="s5">10</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s3">&quot;mle&quot;</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components </span><span class="s2">== </span><span class="s3">&quot;mle&quot;</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s5">1</span>


<span class="s0">def </span><span class="s1">test_infer_dim_1</span><span class="s2">():</span>
    <span class="s4"># TODO: explain what this is testing</span>
    <span class="s4"># Or at least use explicit variable names...</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">5</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= (</span>
        <span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1</span>
        <span class="s2">+ </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">1</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
        <span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s2">])</span>
    <span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">spect </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_</span>
    <span class="s1">ll </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">_assess_dimension</span><span class="s2">(</span><span class="s1">spect</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">p</span><span class="s2">)])</span>
    <span class="s0">assert </span><span class="s1">ll</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] &gt; </span><span class="s1">ll</span><span class="s2">.</span><span class="s1">max</span><span class="s2">() - </span><span class="s5">0.01 </span><span class="s2">* </span><span class="s1">n</span>


<span class="s0">def </span><span class="s1">test_infer_dim_2</span><span class="s2">():</span>
    <span class="s4"># TODO: explain what this is testing</span>
    <span class="s4"># Or at least use explicit variable names...</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">5</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1</span>
    <span class="s1">X</span><span class="s2">[:</span><span class="s5">10</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s5">10</span><span class="s2">:</span><span class="s5">20</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">spect </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_</span>
    <span class="s0">assert </span><span class="s1">_infer_dimension</span><span class="s2">(</span><span class="s1">spect</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s5">1</span>


<span class="s0">def </span><span class="s1">test_infer_dim_3</span><span class="s2">():</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">5</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1</span>
    <span class="s1">X</span><span class="s2">[:</span><span class="s5">10</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">])</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s5">10</span><span class="s2">:</span><span class="s5">20</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">X</span><span class="s2">[</span><span class="s5">30</span><span class="s2">:</span><span class="s5">40</span><span class="s2">] += </span><span class="s5">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, -</span><span class="s5">1</span><span class="s2">])</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">spect </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_</span>
    <span class="s0">assert </span><span class="s1">_infer_dimension</span><span class="s2">(</span><span class="s1">spect</span><span class="s2">, </span><span class="s1">n</span><span class="s2">) &gt; </span><span class="s5">2</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;X, n_components, n_components_validated&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s5">0.95</span><span class="s2">, </span><span class="s5">2</span><span class="s2">),  </span><span class="s4"># row &gt; col</span>
        <span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">, </span><span class="s5">0.01</span><span class="s2">, </span><span class="s5">1</span><span class="s2">),  </span><span class="s4"># row &gt; col</span>
        <span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">5</span><span class="s2">, </span><span class="s5">20</span><span class="s2">), </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">2</span><span class="s2">),</span>
    <span class="s2">],  </span><span class="s4"># row &lt; col</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_infer_dim_by_explained_variance</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">n_components_validated</span><span class="s2">):</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components </span><span class="s2">== </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">approx</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s1">n_components_validated</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_score</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Test that probabilistic PCA scoring yields a reasonable score</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">3</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">ll1 </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">h </span><span class="s2">= -</span><span class="s5">0.5 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s5">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">exp</span><span class="s2">(</span><span class="s5">1</span><span class="s2">) * </span><span class="s5">0.1</span><span class="s2">**</span><span class="s5">2</span><span class="s2">) * </span><span class="s1">p</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">ll1 </span><span class="s2">/ </span><span class="s1">h</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-2</span><span class="s2">)</span>

    <span class="s1">ll2 </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.2 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]))</span>
    <span class="s0">assert </span><span class="s1">ll1 </span><span class="s2">&gt; </span><span class="s1">ll2</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">ll2 </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">ll1 </span><span class="s2">&gt; </span><span class="s1">ll2</span>


<span class="s0">def </span><span class="s1">test_pca_score3</span><span class="s2">():</span>
    <span class="s4"># Check that probabilistic PCA selects the right model</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">200</span><span class="s2">, </span><span class="s5">3</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">Xl </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) + </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">1</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">Xt </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) + </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s5">1</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">]) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">7</span><span class="s2">])</span>
    <span class="s1">ll </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">p</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">p</span><span class="s2">):</span>
        <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
        <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">Xl</span><span class="s2">)</span>
        <span class="s1">ll</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] = </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">Xt</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">ll</span><span class="s2">.</span><span class="s1">argmax</span><span class="s2">() == </span><span class="s5">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_sanity_noise_variance</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Sanity check for the noise_variance_. For more details see</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/7568</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/8541</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/8544</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_digits</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">30</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">((</span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_ </span><span class="s2">- </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">noise_variance_</span><span class="s2">) &gt;= </span><span class="s5">0</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pca_score_consistency_solvers</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Check the consistency of score between solvers</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">load_digits</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">pca_full </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">30</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">pca_other </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">30</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">pca_full</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">pca_other</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">pca_other</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">), </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">5e-6</span><span class="s2">)</span>


<span class="s4"># arpack raises ValueError for n_components == min(n_samples,  n_features)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, [</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_pca_zero_noise_variance_edge_cases</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># ensure that noise_variance_ is 0 in edge cases</span>
    <span class="s4"># when n_components == min(n_samples, n_features)</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">p </span><span class="s2">= </span><span class="s5">100</span><span class="s2">, </span><span class="s5">3</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">p</span><span class="s2">) * </span><span class="s5">0.1 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">])</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">p</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">)</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">noise_variance_ </span><span class="s2">== </span><span class="s5">0</span>
    <span class="s4"># Non-regression test for gh-12489</span>
    <span class="s4"># ensure no divide-by-zero error for n_components == n_features &lt; n_samples</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">noise_variance_ </span><span class="s2">== </span><span class="s5">0</span>
    <span class="s4"># Non-regression test for gh-12489</span>
    <span class="s4"># ensure no divide-by-zero error for n_components == n_samples &lt; n_features</span>
    <span class="s1">pca</span><span class="s2">.</span><span class="s1">score</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">T</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;n_samples, n_features, n_components, expected_solver&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s4"># case: n_samples &lt; 10 * n_features and max(X.shape) &lt;= 500 =&gt; 'full'</span>
        <span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s3">&quot;full&quot;</span><span class="s2">),</span>
        <span class="s4"># case: n_samples &gt; 10 * n_features and n_features &lt; 500 =&gt; 'covariance_eigh'</span>
        <span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s5">50</span><span class="s2">, </span><span class="s3">&quot;covariance_eigh&quot;</span><span class="s2">),</span>
        <span class="s4"># case: n_components &gt;= .8 * min(X.shape) =&gt; 'full'</span>
        <span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">500</span><span class="s2">, </span><span class="s5">400</span><span class="s2">, </span><span class="s3">&quot;full&quot;</span><span class="s2">),</span>
        <span class="s4"># n_components &gt;= 1 and n_components &lt; .8*min(X.shape) =&gt; 'randomized'</span>
        <span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">500</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s3">&quot;randomized&quot;</span><span class="s2">),</span>
        <span class="s4"># case: n_components in (0,1) =&gt; 'full'</span>
        <span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">500</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s3">&quot;full&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_svd_solver_auto</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">, </span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">expected_solver</span><span class="s2">):</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))</span>
    <span class="s1">pca_auto </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">pca_test </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">expected_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span>
    <span class="s2">)</span>
    <span class="s1">pca_auto</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca_auto</span><span class="s2">.</span><span class="s1">_fit_svd_solver </span><span class="s2">== </span><span class="s1">expected_solver</span>
    <span class="s1">pca_test</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_auto</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">pca_test</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_deterministic_output</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s2">)</span>

    <span class="s1">transformed_X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s5">20</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">20</span><span class="s2">):</span>
        <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">rng</span><span class="s2">)</span>
        <span class="s1">transformed_X</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, :] = </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">fit_transform</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">transformed_X</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">tile</span><span class="s2">(</span><span class="s1">transformed_X</span><span class="s2">[</span><span class="s5">0</span><span class="s2">, :], </span><span class="s5">20</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s5">20</span><span class="s2">, </span><span class="s5">2</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;svd_solver&quot;</span><span class="s2">, </span><span class="s1">PCA_SOLVERS</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_dtype_preservation</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">):</span>
    <span class="s1">check_pca_float_dtype_preservation</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">global_random_seed</span><span class="s2">)</span>
    <span class="s1">check_pca_int_dtype_upcast_to_double</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_pca_float_dtype_preservation</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">seed</span><span class="s2">):</span>
    <span class="s4"># Ensure that PCA does not upscale the dtype when input is float32</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s1">seed</span><span class="s2">).</span><span class="s1">rand</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
    <span class="s1">X_float64 </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_float32 </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>

    <span class="s1">pca_64 </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span>
        <span class="s1">X_float64</span>
    <span class="s2">)</span>
    <span class="s1">pca_32 </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s1">seed</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span>
        <span class="s1">X_float32</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">pca_64</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
    <span class="s0">assert </span><span class="s1">pca_32</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span>
    <span class="s0">assert </span><span class="s1">pca_64</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_float64</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
    <span class="s0">assert </span><span class="s1">pca_32</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_float32</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span>

    <span class="s4"># The atol and rtol are set such that the test passes for all random seeds</span>
    <span class="s4"># on all supported platforms on our CI and conda-forge with the default</span>
    <span class="s4"># random seed.</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_64</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">pca_32</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_pca_int_dtype_upcast_to_double</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">):</span>
    <span class="s4"># Ensure that all int types will be upcast to float64</span>
    <span class="s1">X_i64 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">randint</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">, (</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">4</span><span class="s2">))</span>
    <span class="s1">X_i64 </span><span class="s2">= </span><span class="s1">X_i64</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">X_i32 </span><span class="s2">= </span><span class="s1">X_i64</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">pca_64 </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_i64</span><span class="s2">)</span>
    <span class="s1">pca_32 </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s1">svd_solver</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_i32</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">pca_64</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
    <span class="s0">assert </span><span class="s1">pca_32</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
    <span class="s0">assert </span><span class="s1">pca_64</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_i64</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>
    <span class="s0">assert </span><span class="s1">pca_32</span><span class="s2">.</span><span class="s1">transform</span><span class="s2">(</span><span class="s1">X_i32</span><span class="s2">).</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_64</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">pca_32</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s5">1e-4</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_pca_n_components_mostly_explained_variance_ratio</span><span class="s2">():</span>
    <span class="s4"># when n_components is the second highest cumulative sum of the</span>
    <span class="s4"># explained_variance_ratio_, then n_components_ should equal the</span>
    <span class="s4"># number of features in the dataset #15669</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">load_iris</span><span class="s2">(</span><span class="s1">return_X_y</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">pca1 </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">n_components </span><span class="s2">= </span><span class="s1">pca1</span><span class="s2">.</span><span class="s1">explained_variance_ratio_</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">()[-</span><span class="s5">2</span><span class="s2">]</span>
    <span class="s1">pca2 </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s1">n_components</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca2</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s1">X</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_assess_dimension_bad_rank</span><span class="s2">():</span>
    <span class="s4"># Test error when tested rank not in [1, n_features - 1]</span>
    <span class="s1">spectrum </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1e-30</span><span class="s2">, </span><span class="s5">1e-30</span><span class="s2">, </span><span class="s5">1e-30</span><span class="s2">])</span>
    <span class="s1">n_samples </span><span class="s2">= </span><span class="s5">10</span>
    <span class="s0">for </span><span class="s1">rank </span><span class="s0">in </span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">5</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">r&quot;should be in \[1, n_features - 1\]&quot;</span><span class="s2">):</span>
            <span class="s1">_assess_dimension</span><span class="s2">(</span><span class="s1">spectrum</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_small_eigenvalues_mle</span><span class="s2">():</span>
    <span class="s4"># Test rank associated with tiny eigenvalues are given a log-likelihood of</span>
    <span class="s4"># -inf. The inferred rank will be 1</span>
    <span class="s1">spectrum </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1e-30</span><span class="s2">, </span><span class="s5">1e-30</span><span class="s2">, </span><span class="s5">1e-30</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">_assess_dimension</span><span class="s2">(</span><span class="s1">spectrum</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s5">10</span><span class="s2">) &gt; -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>

    <span class="s0">for </span><span class="s1">rank </span><span class="s0">in </span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">_assess_dimension</span><span class="s2">(</span><span class="s1">spectrum</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">, </span><span class="s5">10</span><span class="s2">) == -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>

    <span class="s0">assert </span><span class="s1">_infer_dimension</span><span class="s2">(</span><span class="s1">spectrum</span><span class="s2">, </span><span class="s5">10</span><span class="s2">) == </span><span class="s5">1</span>


<span class="s0">def </span><span class="s1">test_mle_redundant_data</span><span class="s2">():</span>
    <span class="s4"># Test 'mle' with pathological X: only one relevant feature should give a</span>
    <span class="s4"># rank of 1</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span>
        <span class="s1">n_features</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
        <span class="s1">n_informative</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">n_repeated</span><span class="s2">=</span><span class="s5">18</span><span class="s2">,</span>
        <span class="s1">n_redundant</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">n_clusters_per_class</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s3">&quot;mle&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s5">1</span>


<span class="s0">def </span><span class="s1">test_fit_mle_too_few_samples</span><span class="s2">():</span>
    <span class="s4"># Tests that an error is raised when the number of samples is smaller</span>
    <span class="s4"># than the number of features during an mle fit</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">datasets</span><span class="s2">.</span><span class="s1">make_classification</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">=</span><span class="s5">20</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">=</span><span class="s5">21</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s3">&quot;mle&quot;</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
        <span class="s1">ValueError</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;n_components='mle' is only supported if n_samples &gt;= n_features&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_mle_simple_case</span><span class="s2">():</span>
    <span class="s4"># non-regression test for issue</span>
    <span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/16730</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_dim </span><span class="s2">= </span><span class="s5">1000</span><span class="s2">, </span><span class="s5">10</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">).</span><span class="s1">randn</span><span class="s2">(</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_dim</span><span class="s2">)</span>
    <span class="s1">X</span><span class="s2">[:, -</span><span class="s5">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">mean</span><span class="s2">(</span><span class="s1">X</span><span class="s2">[:, :-</span><span class="s5">1</span><span class="s2">], </span><span class="s1">axis</span><span class="s2">=-</span><span class="s5">1</span><span class="s2">)  </span><span class="s4"># true X dim is ndim - 1</span>
    <span class="s1">pca_skl </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s3">&quot;mle&quot;</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">)</span>
    <span class="s1">pca_skl</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">pca_skl</span><span class="s2">.</span><span class="s1">n_components_ </span><span class="s2">== </span><span class="s1">n_dim </span><span class="s2">- </span><span class="s5">1</span>


<span class="s0">def </span><span class="s1">test_assess_dimesion_rank_one</span><span class="s2">():</span>
    <span class="s4"># Make sure assess_dimension works properly on a matrix of rank 1</span>
    <span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features </span><span class="s2">= </span><span class="s5">9</span><span class="s2">, </span><span class="s5">6</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s1">n_samples</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">))  </span><span class="s4"># rank 1 matrix</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">s</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">svd</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">full_matrices</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s4"># except for rank 1, all eigenvalues are 0 resp. close to 0 (FP)</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">s</span><span class="s2">[</span><span class="s5">1</span><span class="s2">:], </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n_features </span><span class="s2">- </span><span class="s5">1</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s5">1e-12</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isfinite</span><span class="s2">(</span><span class="s1">_assess_dimension</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">=</span><span class="s1">n_samples</span><span class="s2">))</span>
    <span class="s0">for </span><span class="s1">rank </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">_assess_dimension</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s1">rank</span><span class="s2">, </span><span class="s1">n_samples</span><span class="s2">) == -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span>


<span class="s0">def </span><span class="s1">test_pca_randomized_svd_n_oversamples</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check that exposing and setting `n_oversamples` will provide accurate results 
    even when `X` as a large number of features. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/20589 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">n_features </span><span class="s2">= </span><span class="s5">100</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">1_000</span><span class="s2">, </span><span class="s1">n_features</span><span class="s2">)</span>

    <span class="s4"># The default value of `n_oversamples` will lead to inaccurate results</span>
    <span class="s4"># We force it to the number of features.</span>
    <span class="s1">pca_randomized </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span>
        <span class="s1">n_components</span><span class="s2">=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;randomized&quot;</span><span class="s2">,</span>
        <span class="s1">n_oversamples</span><span class="s2">=</span><span class="s1">n_features</span><span class="s2">,</span>
        <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,</span>
    <span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">pca_full </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">pca_arpack </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>

    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pca_full</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pca_arpack</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">))</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pca_randomized</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">pca_arpack</span><span class="s2">.</span><span class="s1">components_</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">test_feature_names_out</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Check feature names out for PCA.&quot;&quot;&quot;</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">names </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">get_feature_names_out</span><span class="s2">()</span>
    <span class="s1">assert_array_equal</span><span class="s2">([</span><span class="s3">f&quot;pca</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s5">2</span><span class="s2">)], </span><span class="s1">names</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;copy&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_variance_correctness</span><span class="s2">(</span><span class="s1">copy</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Check the accuracy of PCA's internal variance calculation&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">RandomState</span><span class="s2">(</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">randn</span><span class="s2">(</span><span class="s5">1000</span><span class="s2">, </span><span class="s5">200</span><span class="s2">)</span>
    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">().</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">)</span>
    <span class="s1">pca_var </span><span class="s2">= </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_ </span><span class="s2">/ </span><span class="s1">pca</span><span class="s2">.</span><span class="s1">explained_variance_ratio_</span>
    <span class="s1">true_var </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">var</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">ddof</span><span class="s2">=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s5">0</span><span class="s2">).</span><span class="s1">sum</span><span class="s2">()</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">pca_var</span><span class="s2">, </span><span class="s1">true_var</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_array_api_get_precision</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">, </span><span class="s1">dtype_name</span><span class="s2">):</span>
    <span class="s1">xp </span><span class="s2">= </span><span class="s1">_array_api_for_tests</span><span class="s2">(</span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">)</span>
    <span class="s1">iris_np </span><span class="s2">= </span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype_name</span><span class="s2">)</span>
    <span class="s1">iris_xp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">iris_np</span><span class="s2">, </span><span class="s1">device</span><span class="s2">=</span><span class="s1">device</span><span class="s2">)</span>

    <span class="s1">estimator</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris_np</span><span class="s2">)</span>
    <span class="s1">precision_np </span><span class="s2">= </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">get_precision</span><span class="s2">()</span>
    <span class="s1">covariance_np </span><span class="s2">= </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">get_covariance</span><span class="s2">()</span>

    <span class="s1">rtol </span><span class="s2">= </span><span class="s5">2e-4 </span><span class="s0">if </span><span class="s1">iris_np</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s3">&quot;float32&quot; </span><span class="s0">else </span><span class="s5">2e-7</span>
    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">array_api_dispatch</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">estimator_xp </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">).</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris_xp</span><span class="s2">)</span>
        <span class="s1">precision_xp </span><span class="s2">= </span><span class="s1">estimator_xp</span><span class="s2">.</span><span class="s1">get_precision</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">precision_xp</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">precision_xp</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">iris_xp</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">_convert_to_numpy</span><span class="s2">(</span><span class="s1">precision_xp</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">),</span>
            <span class="s1">precision_np</span><span class="s2">,</span>
            <span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">,</span>
            <span class="s1">atol</span><span class="s2">=</span><span class="s1">_atol_for_type</span><span class="s2">(</span><span class="s1">dtype_name</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">covariance_xp </span><span class="s2">= </span><span class="s1">estimator_xp</span><span class="s2">.</span><span class="s1">get_covariance</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s1">covariance_xp</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s5">4</span><span class="s2">, </span><span class="s5">4</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">covariance_xp</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">iris_xp</span><span class="s2">.</span><span class="s1">dtype</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">_convert_to_numpy</span><span class="s2">(</span><span class="s1">covariance_xp</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">),</span>
            <span class="s1">covariance_np</span><span class="s2">,</span>
            <span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">,</span>
            <span class="s1">atol</span><span class="s2">=</span><span class="s1">_atol_for_type</span><span class="s2">(</span><span class="s1">dtype_name</span><span class="s2">),</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;array_namespace, device, dtype_name&quot;</span><span class="s2">, </span><span class="s1">yield_namespace_device_dtype_combinations</span><span class="s2">()</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;check&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s1">check_array_api_input_and_values</span><span class="s2">, </span><span class="s1">check_array_api_get_precision</span><span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=</span><span class="s1">_get_check_estimator_ids</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">),</span>
        <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
        <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">0.1</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
        <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;covariance_eigh&quot;</span><span class="s2">),</span>
        <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;covariance_eigh&quot;</span><span class="s2">, </span><span class="s1">whiten</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
        <span class="s1">PCA</span><span class="s2">(</span>
            <span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">,</span>
            <span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;randomized&quot;</span><span class="s2">,</span>
            <span class="s1">power_iteration_normalizer</span><span class="s2">=</span><span class="s3">&quot;QR&quot;</span><span class="s2">,</span>
            <span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">,  </span><span class="s4"># how to use global_random_seed here?</span>
        <span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=</span><span class="s1">_get_check_estimator_ids</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_array_api_compliance</span><span class="s2">(</span>
    <span class="s1">estimator</span><span class="s2">, </span><span class="s1">check</span><span class="s2">, </span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">, </span><span class="s1">dtype_name</span>
<span class="s2">):</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">=</span><span class="s1">device</span><span class="s2">, </span><span class="s1">dtype_name</span><span class="s2">=</span><span class="s1">dtype_name</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;array_namespace, device, dtype_name&quot;</span><span class="s2">, </span><span class="s1">yield_namespace_device_dtype_combinations</span><span class="s2">()</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;check&quot;</span><span class="s2">,</span>
    <span class="s2">[</span><span class="s1">check_array_api_get_precision</span><span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=</span><span class="s1">_get_check_estimator_ids</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;estimator&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s4"># PCA with mle cannot use check_array_api_input_and_values because of</span>
        <span class="s4"># rounding errors in the noisy (low variance) components. Even checking</span>
        <span class="s4"># the shape of the `components_` is problematic because the number of</span>
        <span class="s4"># components depends on trimming threshold of the mle algorithm which</span>
        <span class="s4"># can depend on device-specific rounding errors.</span>
        <span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s3">&quot;mle&quot;</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;full&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=</span><span class="s1">_get_check_estimator_ids</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pca_mle_array_api_compliance</span><span class="s2">(</span>
    <span class="s1">estimator</span><span class="s2">, </span><span class="s1">check</span><span class="s2">, </span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">, </span><span class="s1">dtype_name</span>
<span class="s2">):</span>
    <span class="s1">name </span><span class="s2">= </span><span class="s1">estimator</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
    <span class="s1">check</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">estimator</span><span class="s2">, </span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">=</span><span class="s1">device</span><span class="s2">, </span><span class="s1">dtype_name</span><span class="s2">=</span><span class="s1">dtype_name</span><span class="s2">)</span>

    <span class="s4"># Simpler variant of the generic check_array_api_input checker tailored for</span>
    <span class="s4"># the specific case of PCA with mle-trimmed components.</span>
    <span class="s1">xp </span><span class="s2">= </span><span class="s1">_array_api_for_tests</span><span class="s2">(</span><span class="s1">array_namespace</span><span class="s2">, </span><span class="s1">device</span><span class="s2">)</span>

    <span class="s1">X</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">make_classification</span><span class="s2">(</span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">42</span><span class="s2">)</span>
    <span class="s1">X </span><span class="s2">= </span><span class="s1">X</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype_name</span><span class="s2">, </span><span class="s1">copy</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">atol </span><span class="s2">= </span><span class="s1">_atol_for_type</span><span class="s2">(</span><span class="s1">X</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">est </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">estimator</span><span class="s2">)</span>

    <span class="s1">X_xp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">device</span><span class="s2">=</span><span class="s1">device</span><span class="s2">)</span>
    <span class="s1">y_xp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">device</span><span class="s2">=</span><span class="s1">device</span><span class="s2">)</span>

    <span class="s1">est</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">components_np </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">components_</span>
    <span class="s1">explained_variance_np </span><span class="s2">= </span><span class="s1">est</span><span class="s2">.</span><span class="s1">explained_variance_</span>

    <span class="s1">est_xp </span><span class="s2">= </span><span class="s1">clone</span><span class="s2">(</span><span class="s1">est</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">array_api_dispatch</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">est_xp</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">X_xp</span><span class="s2">, </span><span class="s1">y_xp</span><span class="s2">)</span>
        <span class="s1">components_xp </span><span class="s2">= </span><span class="s1">est_xp</span><span class="s2">.</span><span class="s1">components_</span>
        <span class="s0">assert </span><span class="s1">array_device</span><span class="s2">(</span><span class="s1">components_xp</span><span class="s2">) == </span><span class="s1">array_device</span><span class="s2">(</span><span class="s1">X_xp</span><span class="s2">)</span>
        <span class="s1">components_xp_np </span><span class="s2">= </span><span class="s1">_convert_to_numpy</span><span class="s2">(</span><span class="s1">components_xp</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>

        <span class="s1">explained_variance_xp </span><span class="s2">= </span><span class="s1">est_xp</span><span class="s2">.</span><span class="s1">explained_variance_</span>
        <span class="s0">assert </span><span class="s1">array_device</span><span class="s2">(</span><span class="s1">explained_variance_xp</span><span class="s2">) == </span><span class="s1">array_device</span><span class="s2">(</span><span class="s1">X_xp</span><span class="s2">)</span>
        <span class="s1">explained_variance_xp_np </span><span class="s2">= </span><span class="s1">_convert_to_numpy</span><span class="s2">(</span><span class="s1">explained_variance_xp</span><span class="s2">, </span><span class="s1">xp</span><span class="s2">=</span><span class="s1">xp</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">components_xp_np</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">components_np</span><span class="s2">.</span><span class="s1">dtype</span>
    <span class="s0">assert </span><span class="s1">components_xp_np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">] == </span><span class="s1">components_np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">explained_variance_xp_np</span><span class="s2">.</span><span class="s1">dtype </span><span class="s2">== </span><span class="s1">explained_variance_np</span><span class="s2">.</span><span class="s1">dtype</span>

    <span class="s4"># Check that the explained variance values match for the</span>
    <span class="s4"># common components:</span>
    <span class="s1">min_components </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">components_xp_np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">], </span><span class="s1">components_np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">])</span>
    <span class="s1">assert_allclose</span><span class="s2">(</span>
        <span class="s1">explained_variance_xp_np</span><span class="s2">[:</span><span class="s1">min_components</span><span class="s2">],</span>
        <span class="s1">explained_variance_np</span><span class="s2">[:</span><span class="s1">min_components</span><span class="s2">],</span>
        <span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s4"># If the number of components differ, check that the explained variance of</span>
    <span class="s4"># the trimmed components is very small.</span>
    <span class="s0">if </span><span class="s1">components_xp_np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">] != </span><span class="s1">components_np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s5">0</span><span class="s2">]:</span>
        <span class="s1">reference_variance </span><span class="s2">= </span><span class="s1">explained_variance_np</span><span class="s2">[-</span><span class="s5">1</span><span class="s2">]</span>
        <span class="s1">extra_variance_np </span><span class="s2">= </span><span class="s1">explained_variance_np</span><span class="s2">[</span><span class="s1">min_components</span><span class="s2">:]</span>
        <span class="s1">extra_variance_xp_np </span><span class="s2">= </span><span class="s1">explained_variance_xp_np</span><span class="s2">[</span><span class="s1">min_components</span><span class="s2">:]</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">extra_variance_np </span><span class="s2">- </span><span class="s1">reference_variance</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">abs</span><span class="s2">(</span><span class="s1">extra_variance_xp_np </span><span class="s2">- </span><span class="s1">reference_variance</span><span class="s2">) &lt; </span><span class="s1">atol</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_array_api_error_and_warnings_on_unsupported_params</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;array_api_compat&quot;</span><span class="s2">)</span>
    <span class="s1">xp </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;array_api_strict&quot;</span><span class="s2">)</span>
    <span class="s1">iris_xp </span><span class="s2">= </span><span class="s1">xp</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">data</span><span class="s2">)</span>

    <span class="s1">pca </span><span class="s2">= </span><span class="s1">PCA</span><span class="s2">(</span><span class="s1">n_components</span><span class="s2">=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;arpack&quot;</span><span class="s2">, </span><span class="s1">random_state</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
    <span class="s1">expected_msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s3">&quot;PCA with svd_solver='arpack' is not supported for Array API inputs.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_msg</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">array_api_dispatch</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris_xp</span><span class="s2">)</span>

    <span class="s1">pca</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;randomized&quot;</span><span class="s2">, </span><span class="s1">power_iteration_normalizer</span><span class="s2">=</span><span class="s3">&quot;LU&quot;</span><span class="s2">)</span>
    <span class="s1">expected_msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s3">&quot;Array API does not support LU factorization. Set&quot;</span>
        <span class="s3">&quot; `power_iteration_normalizer='QR'` instead.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_msg</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">array_api_dispatch</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris_xp</span><span class="s2">)</span>

    <span class="s1">pca</span><span class="s2">.</span><span class="s1">set_params</span><span class="s2">(</span><span class="s1">svd_solver</span><span class="s2">=</span><span class="s3">&quot;randomized&quot;</span><span class="s2">, </span><span class="s1">power_iteration_normalizer</span><span class="s2">=</span><span class="s3">&quot;auto&quot;</span><span class="s2">)</span>
    <span class="s1">expected_msg </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span>
        <span class="s3">&quot;Array API does not support LU factorization, falling back to QR instead. Set&quot;</span>
        <span class="s3">&quot; `power_iteration_normalizer='QR'` explicitly to silence this warning.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">warns</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">expected_msg</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">config_context</span><span class="s2">(</span><span class="s1">array_api_dispatch</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
            <span class="s1">pca</span><span class="s2">.</span><span class="s1">fit</span><span class="s2">(</span><span class="s1">iris_xp</span><span class="s2">)</span>
</pre>
</body>
</html>