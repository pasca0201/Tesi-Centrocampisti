<html>
<head>
<title>test_lobpcg.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_lobpcg.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; Test functions for the sparse.linalg._eigen.lobpcg module 
&quot;&quot;&quot;</span>

<span class="s2">import </span><span class="s1">itertools</span>
<span class="s2">import </span><span class="s1">platform</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy </span><span class="s2">import </span><span class="s1">ones</span><span class="s3">, </span><span class="s1">r_</span><span class="s3">, </span><span class="s1">diag</span>
<span class="s2">from </span><span class="s1">numpy</span><span class="s3">.</span><span class="s1">testing </span><span class="s2">import </span><span class="s3">(</span><span class="s1">assert_almost_equal</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">,</span>
                           <span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_array_less</span><span class="s3">)</span>

<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">sparse</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">linalg </span><span class="s2">import </span><span class="s1">eig</span><span class="s3">, </span><span class="s1">eigh</span><span class="s3">, </span><span class="s1">toeplitz</span><span class="s3">, </span><span class="s1">orth</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse </span><span class="s2">import </span><span class="s1">spdiags</span><span class="s3">, </span><span class="s1">diags</span><span class="s3">, </span><span class="s1">eye</span><span class="s3">, </span><span class="s1">csr_matrix</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">linalg </span><span class="s2">import </span><span class="s1">eigs</span><span class="s3">, </span><span class="s1">LinearOperator</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">_eigen</span><span class="s3">.</span><span class="s1">lobpcg </span><span class="s2">import </span><span class="s1">lobpcg</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">sparse</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">_eigen</span><span class="s3">.</span><span class="s1">lobpcg</span><span class="s3">.</span><span class="s1">lobpcg </span><span class="s2">import </span><span class="s1">_b_orthonormalize</span>
<span class="s2">from </span><span class="s1">scipy</span><span class="s3">.</span><span class="s1">_lib</span><span class="s3">.</span><span class="s1">_util </span><span class="s2">import </span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np_ulong</span>

<span class="s1">_IS_32BIT </span><span class="s3">= (</span><span class="s1">sys</span><span class="s3">.</span><span class="s1">maxsize </span><span class="s3">&lt; </span><span class="s4">2</span><span class="s3">**</span><span class="s4">32</span><span class="s3">)</span>

<span class="s1">INT_DTYPES </span><span class="s3">= {</span><span class="s1">np</span><span class="s3">.</span><span class="s1">intc</span><span class="s3">, </span><span class="s1">np_long</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">longlong</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">uintc</span><span class="s3">, </span><span class="s1">np_ulong</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ulonglong</span><span class="s3">}</span>
<span class="s5"># np.half is unsupported on many test systems so excluded</span>
<span class="s1">REAL_DTYPES </span><span class="s3">= {</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">longdouble</span><span class="s3">}</span>
<span class="s1">COMPLEX_DTYPES </span><span class="s3">= {</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">clongdouble</span><span class="s3">}</span>
<span class="s5"># use sorted list to ensure fixed order of tests</span>
<span class="s1">VDTYPES </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">REAL_DTYPES </span><span class="s3">^ </span><span class="s1">COMPLEX_DTYPES</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">str</span><span class="s3">)</span>
<span class="s1">MDTYPES </span><span class="s3">= </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">INT_DTYPES </span><span class="s3">^ </span><span class="s1">REAL_DTYPES </span><span class="s3">^ </span><span class="s1">COMPLEX_DTYPES</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">str</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">sign_align</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Align signs of columns of A match those of B: column-wise remove 
    sign of A by multiplying with its sign then multiply in sign of B. 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s1">col_A </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">col_A</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]) * </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sign</span><span class="s3">(</span><span class="s1">col_B</span><span class="s3">[</span><span class="s4">0</span><span class="s3">])</span>
                     <span class="s2">for </span><span class="s1">col_A</span><span class="s3">, </span><span class="s1">col_B </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span><span class="s3">, </span><span class="s1">B</span><span class="s3">.</span><span class="s1">T</span><span class="s3">)]).</span><span class="s1">T</span>

<span class="s2">def </span><span class="s1">ElasticRod</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Build the matrices for the generalized eigenvalue problem of the 
    fixed-free elastic rod vibration model. 
    &quot;&quot;&quot;</span>
    <span class="s1">L </span><span class="s3">= </span><span class="s4">1.0</span>
    <span class="s1">le </span><span class="s3">= </span><span class="s1">L</span><span class="s3">/</span><span class="s1">n</span>
    <span class="s1">rho </span><span class="s3">= </span><span class="s4">7.85e3</span>
    <span class="s1">S </span><span class="s3">= </span><span class="s4">1.e-4</span>
    <span class="s1">E </span><span class="s3">= </span><span class="s4">2.1e11</span>
    <span class="s1">mass </span><span class="s3">= </span><span class="s1">rho</span><span class="s3">*</span><span class="s1">S</span><span class="s3">*</span><span class="s1">le</span><span class="s3">/</span><span class="s4">6.</span>
    <span class="s1">k </span><span class="s3">= </span><span class="s1">E</span><span class="s3">*</span><span class="s1">S</span><span class="s3">/</span><span class="s1">le</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">k</span><span class="s3">*(</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">r_</span><span class="s3">[</span><span class="s4">2.</span><span class="s3">*</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">), </span><span class="s4">1</span><span class="s3">])-</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">), </span><span class="s4">1</span><span class="s3">)-</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">), -</span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">B </span><span class="s3">= </span><span class="s1">mass</span><span class="s3">*(</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">r_</span><span class="s3">[</span><span class="s4">4.</span><span class="s3">*</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">), </span><span class="s4">2</span><span class="s3">])+</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">), </span><span class="s4">1</span><span class="s3">)+</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">), -</span><span class="s4">1</span><span class="s3">))</span>
    <span class="s2">return </span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span>


<span class="s2">def </span><span class="s1">MikotaPair</span><span class="s3">(</span><span class="s1">n</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Build a pair of full diagonal matrices for the generalized eigenvalue 
    problem. The Mikota pair acts as a nice test since the eigenvalues are the 
    squares of the integers n, n=1,2,... 
    &quot;&quot;&quot;</span>
    <span class="s1">x </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">+</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">B </span><span class="s3">= </span><span class="s1">diag</span><span class="s3">(</span><span class="s4">1.</span><span class="s3">/</span><span class="s1">x</span><span class="s3">)</span>
    <span class="s1">y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">z </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">2</span><span class="s3">*</span><span class="s1">n</span><span class="s3">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">diag</span><span class="s3">(</span><span class="s1">z</span><span class="s3">)-</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">)-</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">y</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span>


<span class="s2">def </span><span class="s1">compare_solutions</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check eig vs. lobpcg consistency. 
    &quot;&quot;&quot;</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">V </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">orth</span><span class="s3">(</span><span class="s1">V</span><span class="s3">)</span>
    <span class="s1">eigvals</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">B</span><span class="s3">=</span><span class="s1">B</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1e-2</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">50</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">eigvals</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
    <span class="s1">w</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">eig</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">b</span><span class="s3">=</span><span class="s1">B</span><span class="s3">)</span>
    <span class="s1">w</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">()</span>
    <span class="s1">assert_almost_equal</span><span class="s3">(</span><span class="s1">w</span><span class="s3">[:</span><span class="s1">int</span><span class="s3">(</span><span class="s1">m</span><span class="s3">/</span><span class="s4">2</span><span class="s3">)], </span><span class="s1">eigvals</span><span class="s3">[:</span><span class="s1">int</span><span class="s3">(</span><span class="s1">m</span><span class="s3">/</span><span class="s4">2</span><span class="s3">)], </span><span class="s1">decimal</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_Small</span><span class="s3">():</span>
    <span class="s1">A</span><span class="s3">, </span><span class="s1">B </span><span class="s3">= </span><span class="s1">ElasticRod</span><span class="s3">(</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;The problem size&quot;</span><span class="s3">):</span>
        <span class="s1">compare_solutions</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>
    <span class="s1">A</span><span class="s3">, </span><span class="s1">B </span><span class="s3">= </span><span class="s1">MikotaPair</span><span class="s3">(</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;The problem size&quot;</span><span class="s3">):</span>
        <span class="s1">compare_solutions</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s4">10</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_ElasticRod</span><span class="s3">():</span>
    <span class="s1">A</span><span class="s3">, </span><span class="s1">B </span><span class="s3">= </span><span class="s1">ElasticRod</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Exited at iteration.*|Exited postprocessing with accuracies.*&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">compare_solutions</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_MikotaPair</span><span class="s3">():</span>
    <span class="s1">A</span><span class="s3">, </span><span class="s1">B </span><span class="s3">= </span><span class="s1">MikotaPair</span><span class="s3">(</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s1">compare_solutions</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;n&quot;</span><span class="s3">, [</span><span class="s4">50</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;m&quot;</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">10</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;Vdtype&quot;</span><span class="s3">, </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">REAL_DTYPES</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">str</span><span class="s3">))</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;Bdtype&quot;</span><span class="s3">, </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">REAL_DTYPES</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">str</span><span class="s3">))</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;BVdtype&quot;</span><span class="s3">, </span><span class="s1">sorted</span><span class="s3">(</span><span class="s1">REAL_DTYPES</span><span class="s3">, </span><span class="s1">key</span><span class="s3">=</span><span class="s1">str</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_b_orthonormalize</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">Vdtype</span><span class="s3">, </span><span class="s1">Bdtype</span><span class="s3">, </span><span class="s1">BVdtype</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test B-orthonormalization by Cholesky with callable 'B'. 
    The function '_b_orthonormalize' is key in LOBPCG but may 
    lead to numerical instabilities. The input vectors are often 
    badly scaled, so the function needs scale-invariant Cholesky; 
    see https://netlib.org/lapack/lawnspdf/lawn14.pdf. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">Vdtype</span><span class="s3">)</span>
    <span class="s1">Xcopy </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">vals </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
    <span class="s1">B </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">Bdtype</span><span class="s3">)</span>
    <span class="s1">BX </span><span class="s3">= </span><span class="s1">B </span><span class="s3">@ </span><span class="s1">X</span>
    <span class="s1">BX </span><span class="s3">= </span><span class="s1">BX</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">BVdtype</span><span class="s3">)</span>
    <span class="s1">dtype </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">B</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">, </span><span class="s1">BX</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
    <span class="s5"># np.longdouble tol cannot be achieved on most systems</span>
    <span class="s1">atol </span><span class="s3">= </span><span class="s1">m </span><span class="s3">* </span><span class="s1">n </span><span class="s3">* </span><span class="s1">max</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">dtype</span><span class="s3">).</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">finfo</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">).</span><span class="s1">eps</span><span class="s3">)</span>

    <span class="s1">Xo</span><span class="s3">, </span><span class="s1">BXo</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">_b_orthonormalize</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">B </span><span class="s3">@ </span><span class="s1">v</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">BX</span><span class="s3">)</span>
    <span class="s5"># Check in-place.</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Xo</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">id</span><span class="s3">(</span><span class="s1">Xo</span><span class="s3">))</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">BX</span><span class="s3">, </span><span class="s1">BXo</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">BX</span><span class="s3">), </span><span class="s1">id</span><span class="s3">(</span><span class="s1">BXo</span><span class="s3">))</span>
    <span class="s5"># Check BXo.</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">B </span><span class="s3">@ </span><span class="s1">Xo</span><span class="s3">, </span><span class="s1">BXo</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
    <span class="s5"># Check B-orthonormality</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Xo</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">conj</span><span class="s3">() @ </span><span class="s1">B </span><span class="s3">@ </span><span class="s1">Xo</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">m</span><span class="s3">),</span>
                    <span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
    <span class="s5"># Repeat without BX in outputs</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">(</span><span class="s1">Xcopy</span><span class="s3">)</span>
    <span class="s1">Xo1</span><span class="s3">, </span><span class="s1">BXo1</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">_b_orthonormalize</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">B </span><span class="s3">@ </span><span class="s1">v</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Xo</span><span class="s3">, </span><span class="s1">Xo1</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">BXo</span><span class="s3">, </span><span class="s1">BXo1</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
    <span class="s5"># Check in-place.</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">Xo1</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">id</span><span class="s3">(</span><span class="s1">X</span><span class="s3">), </span><span class="s1">id</span><span class="s3">(</span><span class="s1">Xo1</span><span class="s3">))</span>
    <span class="s5"># Check BXo1.</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">B </span><span class="s3">@ </span><span class="s1">Xo1</span><span class="s3">, </span><span class="s1">BXo1</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>

    <span class="s5"># Introduce column-scaling in X.</span>
    <span class="s1">scaling </span><span class="s3">= </span><span class="s4">1.0 </span><span class="s3">/ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">geomspace</span><span class="s3">(</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1e10</span><span class="s3">, </span><span class="s1">num</span><span class="s3">=</span><span class="s1">m</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">Xcopy </span><span class="s3">* </span><span class="s1">scaling</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">Vdtype</span><span class="s3">)</span>
    <span class="s1">BX </span><span class="s3">= </span><span class="s1">B </span><span class="s3">@ </span><span class="s1">X</span>
    <span class="s1">BX </span><span class="s3">= </span><span class="s1">BX</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">BVdtype</span><span class="s3">)</span>
    <span class="s5"># Check scaling-invariance of Cholesky-based orthonormalization</span>
    <span class="s1">Xo1</span><span class="s3">, </span><span class="s1">BXo1</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">_b_orthonormalize</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">B </span><span class="s3">@ </span><span class="s1">v</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">BX</span><span class="s3">)</span>
    <span class="s5"># The output should be the same, up the signs of the columns.</span>
    <span class="s1">Xo1 </span><span class="s3">=  </span><span class="s1">sign_align</span><span class="s3">(</span><span class="s1">Xo1</span><span class="s3">, </span><span class="s1">Xo</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">Xo</span><span class="s3">, </span><span class="s1">Xo1</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>
    <span class="s1">BXo1 </span><span class="s3">=  </span><span class="s1">sign_align</span><span class="s3">(</span><span class="s1">BXo1</span><span class="s3">, </span><span class="s1">BXo</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">BXo</span><span class="s3">, </span><span class="s1">BXo1</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited at iteration 0&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited postprocessing&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_nonhermitian_warning</span><span class="s3">(</span><span class="s1">capsys</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the warning of a Ritz matrix being not Hermitian 
    by feeding a non-Hermitian input matrix. 
    Also check stdout since verbosityLevel=1 and lack of stderr. 
    &quot;&quot;&quot;</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s4">10</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n </span><span class="s3">* </span><span class="s4">2</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s4">2</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n </span><span class="s3">* </span><span class="s1">n</span><span class="s3">).</span><span class="s1">reshape</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Matrix gramA&quot;</span><span class="s3">):</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">()  </span><span class="s5"># Capture output</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s6">&quot;Solving standard eigenvalue&quot;</span><span class="s3">)  </span><span class="s5"># Test stdout</span>
    <span class="s2">assert </span><span class="s1">err </span><span class="s3">== </span><span class="s6">''  </span><span class="s5"># Test empty stderr</span>
    <span class="s5"># Make the matrix symmetric and the UserWarning disappears.</span>
    <span class="s1">A </span><span class="s3">+= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">out</span><span class="s3">, </span><span class="s1">err </span><span class="s3">= </span><span class="s1">capsys</span><span class="s3">.</span><span class="s1">readouterr</span><span class="s3">()  </span><span class="s5"># Capture output</span>
    <span class="s2">assert </span><span class="s1">out</span><span class="s3">.</span><span class="s1">startswith</span><span class="s3">(</span><span class="s6">&quot;Solving standard eigenvalue&quot;</span><span class="s3">)  </span><span class="s5"># Test stdout</span>
    <span class="s2">assert </span><span class="s1">err </span><span class="s3">== </span><span class="s6">''  </span><span class="s5"># Test empty stderr</span>


<span class="s2">def </span><span class="s1">test_regression</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the eigenvalue of the identity matrix is one. 
    &quot;&quot;&quot;</span>
    <span class="s5"># https://mail.python.org/pipermail/scipy-user/2010-October/026944.html</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s4">10</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">identity</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
    <span class="s1">w</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:The problem size&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'n, m, m_excluded'</span><span class="s3">, [(</span><span class="s4">30</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s3">), (</span><span class="s4">4</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_diagonal</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">, </span><span class="s1">m_excluded</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test ``m - m_excluded`` eigenvalues and eigenvectors of 
    diagonal matrices of the size ``n`` varying matrix formats: 
    dense array, spare matrix, and ``LinearOperator`` for both 
    matrixes in the generalized eigenvalue problem ``Av = cBv`` 
    and for the preconditioner. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s5"># Define the generalized eigenvalue problem Av = cBv</span>
    <span class="s5"># where (c, v) is a generalized eigenpair,</span>
    <span class="s5"># A is the diagonal matrix whose entries are 1,...n,</span>
    <span class="s5"># B is the identity matrix.</span>
    <span class="s1">vals </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
    <span class="s1">A_s </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s1">A_a </span><span class="s3">= </span><span class="s1">A_s</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">A_f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">A_s </span><span class="s3">@ </span><span class="s1">x</span>

    <span class="s1">A_lo </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">A_f</span><span class="s3">,</span>
                          <span class="s1">matmat</span><span class="s3">=</span><span class="s1">A_f</span><span class="s3">,</span>
                          <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>

    <span class="s1">B_a </span><span class="s3">= </span><span class="s1">eye</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
    <span class="s1">B_s </span><span class="s3">= </span><span class="s1">csr_matrix</span><span class="s3">(</span><span class="s1">B_a</span><span class="s3">)</span>

    <span class="s2">def </span><span class="s1">B_f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">B_a </span><span class="s3">@ </span><span class="s1">x</span>

    <span class="s1">B_lo </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">B_f</span><span class="s3">,</span>
                          <span class="s1">matmat</span><span class="s3">=</span><span class="s1">B_f</span><span class="s3">,</span>
                          <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>

    <span class="s5"># Let the preconditioner M be the inverse of A.</span>
    <span class="s1">M_s </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s4">1.</span><span class="s3">/</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s1">M_a </span><span class="s3">= </span><span class="s1">M_s</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

    <span class="s2">def </span><span class="s1">M_f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">M_s </span><span class="s3">@ </span><span class="s1">x</span>

    <span class="s1">M_lo </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">M_f</span><span class="s3">,</span>
                          <span class="s1">matmat</span><span class="s3">=</span><span class="s1">M_f</span><span class="s3">,</span>
                          <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>

    <span class="s5"># Pick random initial vectors.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">normal</span><span class="s3">(</span><span class="s1">size</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>

    <span class="s5"># Require that the returned eigenvectors be in the orthogonal complement</span>
    <span class="s5"># of the first few standard basis vectors.</span>
    <span class="s2">if </span><span class="s1">m_excluded </span><span class="s3">&gt; </span><span class="s4">0</span><span class="s3">:</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m_excluded</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">Y </span><span class="s3">= </span><span class="s2">None</span>

    <span class="s2">for </span><span class="s1">A </span><span class="s2">in </span><span class="s3">[</span><span class="s1">A_a</span><span class="s3">, </span><span class="s1">A_s</span><span class="s3">, </span><span class="s1">A_lo</span><span class="s3">]:</span>
        <span class="s2">for </span><span class="s1">B </span><span class="s2">in </span><span class="s3">[</span><span class="s1">B_a</span><span class="s3">, </span><span class="s1">B_s</span><span class="s3">, </span><span class="s1">B_lo</span><span class="s3">]:</span>
            <span class="s2">for </span><span class="s1">M </span><span class="s2">in </span><span class="s3">[</span><span class="s1">M_a</span><span class="s3">, </span><span class="s1">M_s</span><span class="s3">, </span><span class="s1">M_lo</span><span class="s3">]:</span>
                <span class="s1">eigvals</span><span class="s3">, </span><span class="s1">vecs </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s1">M</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">=</span><span class="s1">Y</span><span class="s3">,</span>
                                       <span class="s1">maxiter</span><span class="s3">=</span><span class="s4">40</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

                <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">eigvals</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">+</span><span class="s1">m_excluded</span><span class="s3">,</span>
                                                   <span class="s4">1</span><span class="s3">+</span><span class="s1">m_excluded</span><span class="s3">+</span><span class="s1">m</span><span class="s3">))</span>
                <span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">eigvals</span><span class="s3">, </span><span class="s1">vecs</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-3</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-3</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">M</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">V</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-8</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-14</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check if the eigenvalue residual is small. 
    &quot;&quot;&quot;</span>
    <span class="s1">mult_wV </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">multiply</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">V</span><span class="s3">)</span>
    <span class="s1">dot_MV </span><span class="s3">= </span><span class="s1">M</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">V</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">mult_wV</span><span class="s3">, </span><span class="s1">dot_MV</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s1">rtol</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_check_fiedler</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check the Fiedler vector computation. 
    &quot;&quot;&quot;</span>
    <span class="s5"># This is not necessarily the recommended way to find the Fiedler vector.</span>
    <span class="s1">col </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">(</span><span class="s1">n</span><span class="s3">)</span>
    <span class="s1">col</span><span class="s3">[</span><span class="s4">1</span><span class="s3">] = </span><span class="s4">1</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">toeplitz</span><span class="s3">(</span><span class="s1">col</span><span class="s3">)</span>
    <span class="s1">D </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">A</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">L </span><span class="s3">= </span><span class="s1">D </span><span class="s3">- </span><span class="s1">A</span>
    <span class="s5"># Compute the full eigendecomposition using tricks, e.g.</span>
    <span class="s5"># http://www.cs.yale.edu/homes/spielman/561/2009/lect02-09.pdf</span>
    <span class="s1">tmp </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">pi </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) / </span><span class="s1">n</span>
    <span class="s1">analytic_w </span><span class="s3">= </span><span class="s4">2 </span><span class="s3">* (</span><span class="s4">1 </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">tmp</span><span class="s3">))</span>
    <span class="s1">analytic_V </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">cos</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">outer</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s1">n</span><span class="s3">) + </span><span class="s4">1</span><span class="s3">/</span><span class="s4">2</span><span class="s3">, </span><span class="s1">tmp</span><span class="s3">))</span>
    <span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">analytic_w</span><span class="s3">, </span><span class="s1">analytic_V</span><span class="s3">)</span>
    <span class="s5"># Compute the full eigendecomposition using eigh.</span>
    <span class="s1">eigh_w</span><span class="s3">, </span><span class="s1">eigh_V </span><span class="s3">= </span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">L</span><span class="s3">)</span>
    <span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">eigh_w</span><span class="s3">, </span><span class="s1">eigh_V</span><span class="s3">)</span>
    <span class="s5"># Check that the first eigenvalue is near zero and that the rest agree.</span>
    <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">([</span><span class="s1">eigh_w</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">analytic_w</span><span class="s3">[</span><span class="s4">0</span><span class="s3">]]), </span><span class="s4">1e-14</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">eigh_w</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:], </span><span class="s1">analytic_w</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:])</span>

    <span class="s5"># Check small lobpcg eigenvalues.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">analytic_V</span><span class="s3">[:, :</span><span class="s1">p</span><span class="s3">]</span>
    <span class="s1">lobpcg_w</span><span class="s3">, </span><span class="s1">lobpcg_V </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">p</span><span class="s3">,))</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">lobpcg_V</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">))</span>
    <span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">lobpcg_w</span><span class="s3">, </span><span class="s1">lobpcg_V</span><span class="s3">)</span>
    <span class="s1">assert_array_less</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">min</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">)), </span><span class="s4">1e-14</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">)[</span><span class="s4">1</span><span class="s3">:], </span><span class="s1">analytic_w</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:</span><span class="s1">p</span><span class="s3">])</span>

    <span class="s5"># Check large lobpcg eigenvalues.</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">analytic_V</span><span class="s3">[:, -</span><span class="s1">p</span><span class="s3">:]</span>
    <span class="s1">lobpcg_w</span><span class="s3">, </span><span class="s1">lobpcg_V </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">p</span><span class="s3">,))</span>
    <span class="s1">assert_equal</span><span class="s3">(</span><span class="s1">lobpcg_V</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">, (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">))</span>
    <span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">lobpcg_w</span><span class="s3">, </span><span class="s1">lobpcg_V</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">), </span><span class="s1">analytic_w</span><span class="s3">[-</span><span class="s1">p</span><span class="s3">:])</span>

    <span class="s5"># Look for the Fiedler vector using good but not exactly correct guesses.</span>
    <span class="s1">fiedler_guess </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">concatenate</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">//</span><span class="s4">2</span><span class="s3">), -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">-</span><span class="s1">n</span><span class="s3">//</span><span class="s4">2</span><span class="s3">)))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">(</span><span class="s1">n</span><span class="s3">), </span><span class="s1">fiedler_guess</span><span class="s3">)).</span><span class="s1">T</span>
    <span class="s1">lobpcg_w</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">L</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s5"># Mathematically, the smaller eigenvalue should be zero</span>
    <span class="s5"># and the larger should be the algebraic connectivity.</span>
    <span class="s1">lobpcg_w </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">lobpcg_w</span><span class="s3">, </span><span class="s1">analytic_w</span><span class="s3">[:</span><span class="s4">2</span><span class="s3">], </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-14</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fiedler_small_8</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the dense workaround path for small matrices. 
    &quot;&quot;&quot;</span>
    <span class="s5"># This triggers the dense path because 8 &lt; 2*5.</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;The problem size&quot;</span><span class="s3">):</span>
        <span class="s1">_check_fiedler</span><span class="s3">(</span><span class="s4">8</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_fiedler_large_12</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check the dense workaround path avoided for non-small matrices. 
    &quot;&quot;&quot;</span>
    <span class="s5"># This does not trigger the dense path, because 2*5 &lt;= 12.</span>
    <span class="s1">_check_fiedler</span><span class="s3">(</span><span class="s4">12</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Failed at iteration&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited at iteration&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited postprocessing&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_failure_to_run_iterations</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that the code exits gracefully without breaking. Issue #10974. 
    The code may or not issue a warning, filtered out. Issue #15935, #17954. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s4">100</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">X </span><span class="s3">@ </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">Q </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">4</span><span class="s3">))</span>
    <span class="s1">eigenvalues</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">Q</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">40</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1e-12</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">eigenvalues</span><span class="s3">) &gt; </span><span class="s4">0</span>


<span class="s2">def </span><span class="s1">test_failure_to_run_iterations_nonsymmetric</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that the code exists gracefully without breaking 
    if the matrix in not symmetric. 
    &quot;&quot;&quot;</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">zeros</span><span class="s3">((</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">A</span><span class="s3">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">] = </span><span class="s4">1</span>
    <span class="s1">Q </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">ones</span><span class="s3">((</span><span class="s4">10</span><span class="s3">, </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Exited at iteration 2|Exited postprocessing with accuracies.*&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">eigenvalues</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">Q</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">20</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">eigenvalues</span><span class="s3">) &gt; </span><span class="s4">0</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:The problem size&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_hermitian</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check complex-value Hermitian cases. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">sizes </span><span class="s3">= [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">12</span><span class="s3">]</span>
    <span class="s1">ks </span><span class="s3">= [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">]</span>
    <span class="s1">gens </span><span class="s3">= [</span><span class="s2">True</span><span class="s3">, </span><span class="s2">False</span><span class="s3">]</span>

    <span class="s2">for </span><span class="s1">s</span><span class="s3">, </span><span class="s1">k</span><span class="s3">, </span><span class="s1">gen</span><span class="s3">, </span><span class="s1">dh</span><span class="s3">, </span><span class="s1">dx</span><span class="s3">, </span><span class="s1">db </span><span class="s2">in </span><span class="s3">(</span>
        <span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">(</span><span class="s1">sizes</span><span class="s3">, </span><span class="s1">ks</span><span class="s3">, </span><span class="s1">gens</span><span class="s3">, </span><span class="s1">gens</span><span class="s3">, </span><span class="s1">gens</span><span class="s3">, </span><span class="s1">gens</span><span class="s3">)</span>
    <span class="s3">):</span>
        <span class="s1">H </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)) + </span><span class="s4">1.j </span><span class="s3">* </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">s</span><span class="s3">))</span>
        <span class="s1">H </span><span class="s3">= </span><span class="s4">10 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) + </span><span class="s1">H </span><span class="s3">+ </span><span class="s1">H</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">conj</span><span class="s3">()</span>
        <span class="s1">H </span><span class="s3">= </span><span class="s1">H</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">) </span><span class="s2">if </span><span class="s1">dh </span><span class="s2">else </span><span class="s1">H</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">)</span>

        <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">k</span><span class="s3">))</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">X </span><span class="s3">+ </span><span class="s4">1.j </span><span class="s3">* </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">k</span><span class="s3">))</span>
        <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">) </span><span class="s2">if </span><span class="s1">dx </span><span class="s2">else </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">)</span>

        <span class="s2">if not </span><span class="s1">gen</span><span class="s3">:</span>
            <span class="s1">B </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">s</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">H</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">99</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
            <span class="s5"># Also test mixing complex H with real B.</span>
            <span class="s1">wb</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">H</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">99</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">wb</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-6</span><span class="s3">)</span>
            <span class="s1">w0</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">H</span><span class="s3">)</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">B </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">s</span><span class="s3">)) + </span><span class="s4">1.j </span><span class="s3">* </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">s</span><span class="s3">, </span><span class="s1">s</span><span class="s3">))</span>
            <span class="s1">B </span><span class="s3">= </span><span class="s4">10 </span><span class="s3">* </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">s</span><span class="s3">) + </span><span class="s1">B</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">B</span><span class="s3">.</span><span class="s1">T</span><span class="s3">.</span><span class="s1">conj</span><span class="s3">())</span>
            <span class="s1">B </span><span class="s3">= </span><span class="s1">B</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex128</span><span class="s3">) </span><span class="s2">if </span><span class="s1">db </span><span class="s2">else </span><span class="s1">B</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">complex64</span><span class="s3">)</span>
            <span class="s1">w</span><span class="s3">, </span><span class="s1">v </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">H</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">99</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
            <span class="s1">w0</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">eigh</span><span class="s3">(</span><span class="s1">H</span><span class="s3">, </span><span class="s1">B</span><span class="s3">)</span>

        <span class="s2">for </span><span class="s1">wx</span><span class="s3">, </span><span class="s1">vx </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(</span><span class="s1">w</span><span class="s3">, </span><span class="s1">v</span><span class="s3">.</span><span class="s1">T</span><span class="s3">):</span>
            <span class="s5"># Check eigenvector</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">H</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">vx</span><span class="s3">) - </span><span class="s1">B</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">vx</span><span class="s3">) * </span><span class="s1">wx</span><span class="s3">)</span>
                            <span class="s3">/ </span><span class="s1">np</span><span class="s3">.</span><span class="s1">linalg</span><span class="s3">.</span><span class="s1">norm</span><span class="s3">(</span><span class="s1">H</span><span class="s3">.</span><span class="s1">dot</span><span class="s3">(</span><span class="s1">vx</span><span class="s3">)),</span>
                            <span class="s4">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">5e-2</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

            <span class="s5"># Compare eigenvalues</span>
            <span class="s1">j </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">argmin</span><span class="s3">(</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">w0 </span><span class="s3">- </span><span class="s1">wx</span><span class="s3">))</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">wx</span><span class="s3">, </span><span class="s1">w0</span><span class="s3">[</span><span class="s1">j</span><span class="s3">], </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-4</span><span class="s3">)</span>


<span class="s5"># The n=5 case tests the alternative small matrix code path that uses eigh().</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:The problem size&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">'n, atol'</span><span class="s3">, [(</span><span class="s4">20</span><span class="s3">, </span><span class="s4">1e-3</span><span class="s3">), (</span><span class="s4">5</span><span class="s3">, </span><span class="s4">1e-8</span><span class="s3">)])</span>
<span class="s2">def </span><span class="s1">test_eigs_consistency</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check eigs vs. lobpcg consistency. 
    &quot;&quot;&quot;</span>
    <span class="s1">vals </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n</span><span class="s3">+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">spdiags</span><span class="s3">(</span><span class="s1">vals</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">)</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s4">2</span><span class="s3">))</span>
    <span class="s1">lvals</span><span class="s3">, </span><span class="s1">lvecs </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">100</span><span class="s3">)</span>
    <span class="s1">vals</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">eigs</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">k</span><span class="s3">=</span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">_check_eigen</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">lvals</span><span class="s3">, </span><span class="s1">lvecs</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s1">atol</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">vals</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">lvals</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-14</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_verbosity</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check that nonzero verbosity level code runs. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">X </span><span class="s3">@ </span><span class="s1">X</span><span class="s3">.</span><span class="s1">T</span>
    <span class="s1">Q </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">1</span><span class="s3">))</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Exited at iteration.*|Exited postprocessing with accuracies.*&quot;</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">_</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">Q</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">9</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">_IS_32BIT </span><span class="s2">and </span><span class="s1">sys</span><span class="s3">.</span><span class="s1">platform </span><span class="s3">== </span><span class="s6">'win32'</span><span class="s3">,</span>
                   <span class="s1">reason</span><span class="s3">=</span><span class="s6">&quot;tolerance violation on windows&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">xfail</span><span class="s3">(</span><span class="s1">platform</span><span class="s3">.</span><span class="s1">machine</span><span class="s3">() == </span><span class="s6">'ppc64le'</span><span class="s3">,</span>
                   <span class="s1">reason</span><span class="s3">=</span><span class="s6">&quot;fails on ppc64le&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited postprocessing&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_tolerance_float32</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check lobpcg for attainable tolerance in float32. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s4">50</span>
    <span class="s1">m </span><span class="s3">= </span><span class="s4">3</span>
    <span class="s1">vals </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">eigvals</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1.25e-5</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">50</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">eigvals</span><span class="s3">, -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">2e-5</span><span class="s3">, </span><span class="s1">rtol</span><span class="s3">=</span><span class="s4">1e-5</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;vdtype&quot;</span><span class="s3">, </span><span class="s1">VDTYPES</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;mdtype&quot;</span><span class="s3">, </span><span class="s1">MDTYPES</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;arr_type&quot;</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">,</span>
                                      <span class="s1">sparse</span><span class="s3">.</span><span class="s1">csr_matrix</span><span class="s3">,</span>
                                      <span class="s1">sparse</span><span class="s3">.</span><span class="s1">coo_matrix</span><span class="s3">])</span>
<span class="s2">def </span><span class="s1">test_dtypes</span><span class="s3">(</span><span class="s1">vdtype</span><span class="s3">, </span><span class="s1">mdtype</span><span class="s3">, </span><span class="s1">arr_type</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Test lobpcg in various dtypes. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s4">12</span>
    <span class="s1">m </span><span class="s3">= </span><span class="s4">2</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">arr_type</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">diag</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">mdtype</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">vdtype</span><span class="s3">)</span>
    <span class="s1">eigvals</span><span class="s3">, </span><span class="s1">eigvecs </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1e-2</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">eigvals</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">), </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-1</span><span class="s3">)</span>
    <span class="s5"># eigenvectors must be nearly real in any case</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">abs</span><span class="s3">(</span><span class="s1">eigvecs </span><span class="s3">- </span><span class="s1">eigvecs</span><span class="s3">.</span><span class="s1">conj</span><span class="s3">())), </span><span class="s4">0</span><span class="s3">, </span><span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-2</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited at iteration&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited postprocessing&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_inplace_warning</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check lobpcg gives a warning in '_b_orthonormalize' 
    that in-place orthogonalization is impossible due to dtype mismatch. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s4">6</span>
    <span class="s1">m </span><span class="s3">= </span><span class="s4">1</span>
    <span class="s1">vals </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">cdouble</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s6">&quot;Inplace update&quot;</span><span class="s3">):</span>
        <span class="s1">eigvals</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">verbosityLevel</span><span class="s3">=</span><span class="s4">1</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_maxit</span><span class="s3">():</span>
    <span class="s0">&quot;&quot;&quot;Check lobpcg if maxit=maxiter runs maxiter iterations and 
    if maxit=None runs 20 iterations (the default) 
    by checking the size of the iteration history output, which should 
    be the number of iterations plus 3 (initial, final, and postprocessing) 
    typically when maxiter is small and the choice of the best is passive. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n </span><span class="s3">= </span><span class="s4">50</span>
    <span class="s1">m </span><span class="s3">= </span><span class="s4">4</span>
    <span class="s1">vals </span><span class="s3">= -</span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">))</span>
    <span class="s1">A </span><span class="s3">= </span><span class="s1">A</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">standard_normal</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float64</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s6">&quot;Exited at iteration.*|Exited postprocessing with accuracies.*&quot;</span>
    <span class="s2">for </span><span class="s1">maxiter </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">):</span>
        <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
            <span class="s1">_</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">l_h</span><span class="s3">, </span><span class="s1">r_h </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1e-8</span><span class="s3">, </span><span class="s1">maxiter</span><span class="s3">=</span><span class="s1">maxiter</span><span class="s3">,</span>
                                    <span class="s1">retLambdaHistory</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                                    <span class="s1">retResidualNormsHistory</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">l_h</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">maxiter</span><span class="s3">+</span><span class="s4">3</span><span class="s3">)</span>
        <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">r_h</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">], </span><span class="s1">maxiter</span><span class="s3">+</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">l</span><span class="s3">, </span><span class="s1">_</span><span class="s3">, </span><span class="s1">l_h</span><span class="s3">, </span><span class="s1">r_h </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1e-8</span><span class="s3">,</span>
                                <span class="s1">retLambdaHistory</span><span class="s3">=</span><span class="s2">True</span><span class="s3">,</span>
                                <span class="s1">retResidualNormsHistory</span><span class="s3">=</span><span class="s2">True</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">l_h</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">20</span><span class="s3">+</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">r_h</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">20</span><span class="s3">+</span><span class="s4">3</span><span class="s3">)</span>
    <span class="s5"># Check that eigenvalue output is the last one in history</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">l</span><span class="s3">, </span><span class="s1">l_h</span><span class="s3">[-</span><span class="s4">1</span><span class="s3">])</span>
    <span class="s5"># Make sure that both history outputs are lists</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">l_h</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">isinstance</span><span class="s3">(</span><span class="s1">r_h</span><span class="s3">, </span><span class="s1">list</span><span class="s3">)</span>
    <span class="s5"># Make sure that both history lists are arrays-like</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">l_h</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">l_h</span><span class="s3">)))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">r_h</span><span class="s3">), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">asarray</span><span class="s3">(</span><span class="s1">r_h</span><span class="s3">)))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">slow</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;n&quot;</span><span class="s3">, [</span><span class="s4">15</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s6">&quot;m&quot;</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited at iteration&quot;</span><span class="s3">)</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">filterwarnings</span><span class="s3">(</span><span class="s6">&quot;ignore:Exited postprocessing&quot;</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_diagonal_data_types</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot;Check lobpcg for diagonal matrices for all matrix types. 
    Constraints are imposed, so a dense eigensolver eig cannot run. 
    &quot;&quot;&quot;</span>
    <span class="s1">rnd </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s5"># Define the generalized eigenvalue problem Av = cBv</span>
    <span class="s5"># where (c, v) is a generalized eigenpair,</span>
    <span class="s5"># and where we choose A  and B to be diagonal.</span>
    <span class="s1">vals </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n </span><span class="s3">+ </span><span class="s4">1</span><span class="s3">)</span>

    <span class="s1">list_sparse_format </span><span class="s3">= [</span><span class="s6">'bsr'</span><span class="s3">, </span><span class="s6">'coo'</span><span class="s3">, </span><span class="s6">'csc'</span><span class="s3">, </span><span class="s6">'csr'</span><span class="s3">, </span><span class="s6">'dia'</span><span class="s3">, </span><span class="s6">'dok'</span><span class="s3">, </span><span class="s6">'lil'</span><span class="s3">]</span>
    <span class="s2">for </span><span class="s1">s_f_i</span><span class="s3">, </span><span class="s1">s_f </span><span class="s2">in </span><span class="s1">enumerate</span><span class="s3">(</span><span class="s1">list_sparse_format</span><span class="s3">):</span>

        <span class="s1">As64 </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals </span><span class="s3">* </span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">format</span><span class="s3">=</span><span class="s1">s_f</span><span class="s3">)</span>
        <span class="s1">As32 </span><span class="s3">= </span><span class="s1">As64</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">Af64 </span><span class="s3">= </span><span class="s1">As64</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>
        <span class="s1">Af32 </span><span class="s3">= </span><span class="s1">Af64</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">As32f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">As32 </span><span class="s3">@ </span><span class="s1">x</span>
        <span class="s1">As32LO </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">As32f</span><span class="s3">,</span>
                                <span class="s1">matmat</span><span class="s3">=</span><span class="s1">As32f</span><span class="s3">,</span>
                                <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">),</span>
                                <span class="s1">dtype</span><span class="s3">=</span><span class="s1">As32</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>

        <span class="s1">listA </span><span class="s3">= [</span><span class="s1">Af64</span><span class="s3">, </span><span class="s1">As64</span><span class="s3">, </span><span class="s1">Af32</span><span class="s3">, </span><span class="s1">As32</span><span class="s3">, </span><span class="s1">As32f</span><span class="s3">, </span><span class="s1">As32LO</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">As32 </span><span class="s3">@ </span><span class="s1">v</span><span class="s3">]</span>

        <span class="s1">Bs64 </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">format</span><span class="s3">=</span><span class="s1">s_f</span><span class="s3">)</span>
        <span class="s1">Bf64 </span><span class="s3">= </span><span class="s1">Bs64</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>
        <span class="s1">Bs32 </span><span class="s3">= </span><span class="s1">Bs64</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">Bs32f</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Bs32 </span><span class="s3">@ </span><span class="s1">x</span>
        <span class="s1">Bs32LO </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">Bs32f</span><span class="s3">,</span>
                                <span class="s1">matmat</span><span class="s3">=</span><span class="s1">Bs32f</span><span class="s3">,</span>
                                <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">),</span>
                                <span class="s1">dtype</span><span class="s3">=</span><span class="s1">Bs32</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">listB </span><span class="s3">= [</span><span class="s1">Bf64</span><span class="s3">, </span><span class="s1">Bs64</span><span class="s3">, </span><span class="s1">Bs32</span><span class="s3">, </span><span class="s1">Bs32f</span><span class="s3">, </span><span class="s1">Bs32LO</span><span class="s3">, </span><span class="s2">lambda </span><span class="s1">v</span><span class="s3">: </span><span class="s1">Bs32 </span><span class="s3">@ </span><span class="s1">v</span><span class="s3">]</span>

        <span class="s5"># Define the preconditioner function as LinearOperator.</span>
        <span class="s1">Ms64 </span><span class="s3">= </span><span class="s1">diags</span><span class="s3">([</span><span class="s4">1.</span><span class="s3">/</span><span class="s1">vals</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">], (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">), </span><span class="s1">format</span><span class="s3">=</span><span class="s1">s_f</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">Ms64precond</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Ms64 </span><span class="s3">@ </span><span class="s1">x</span>
        <span class="s1">Ms64precondLO </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">Ms64precond</span><span class="s3">,</span>
                                       <span class="s1">matmat</span><span class="s3">=</span><span class="s1">Ms64precond</span><span class="s3">,</span>
                                       <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">),</span>
                                       <span class="s1">dtype</span><span class="s3">=</span><span class="s1">Ms64</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">Mf64 </span><span class="s3">= </span><span class="s1">Ms64</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">Mf64precond</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Mf64 </span><span class="s3">@ </span><span class="s1">x</span>
        <span class="s1">Mf64precondLO </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">Mf64precond</span><span class="s3">,</span>
                                       <span class="s1">matmat</span><span class="s3">=</span><span class="s1">Mf64precond</span><span class="s3">,</span>
                                       <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">),</span>
                                       <span class="s1">dtype</span><span class="s3">=</span><span class="s1">Mf64</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">Ms32 </span><span class="s3">= </span><span class="s1">Ms64</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>

        <span class="s2">def </span><span class="s1">Ms32precond</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Ms32 </span><span class="s3">@ </span><span class="s1">x</span>
        <span class="s1">Ms32precondLO </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">Ms32precond</span><span class="s3">,</span>
                                       <span class="s1">matmat</span><span class="s3">=</span><span class="s1">Ms32precond</span><span class="s3">,</span>
                                       <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">),</span>
                                       <span class="s1">dtype</span><span class="s3">=</span><span class="s1">Ms32</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">Mf32 </span><span class="s3">= </span><span class="s1">Ms32</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">()</span>

        <span class="s2">def </span><span class="s1">Mf32precond</span><span class="s3">(</span><span class="s1">x</span><span class="s3">):</span>
            <span class="s2">return </span><span class="s1">Mf32 </span><span class="s3">@ </span><span class="s1">x</span>
        <span class="s1">Mf32precondLO </span><span class="s3">= </span><span class="s1">LinearOperator</span><span class="s3">(</span><span class="s1">matvec</span><span class="s3">=</span><span class="s1">Mf32precond</span><span class="s3">,</span>
                                       <span class="s1">matmat</span><span class="s3">=</span><span class="s1">Mf32precond</span><span class="s3">,</span>
                                       <span class="s1">shape</span><span class="s3">=(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">n</span><span class="s3">),</span>
                                       <span class="s1">dtype</span><span class="s3">=</span><span class="s1">Mf32</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">)</span>
        <span class="s1">listM </span><span class="s3">= [</span><span class="s2">None</span><span class="s3">, </span><span class="s1">Ms64</span><span class="s3">, </span><span class="s1">Ms64precondLO</span><span class="s3">, </span><span class="s1">Mf64precondLO</span><span class="s3">, </span><span class="s1">Ms64precond</span><span class="s3">,</span>
                 <span class="s1">Ms32</span><span class="s3">, </span><span class="s1">Ms32precondLO</span><span class="s3">, </span><span class="s1">Mf32precondLO</span><span class="s3">, </span><span class="s1">Ms32precond</span><span class="s3">]</span>

        <span class="s5"># Setup matrix of the initial approximation to the eigenvectors</span>
        <span class="s5"># (cannot be sparse array).</span>
        <span class="s1">Xf64 </span><span class="s3">= </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">((</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m</span><span class="s3">))</span>
        <span class="s1">Xf32 </span><span class="s3">= </span><span class="s1">Xf64</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">listX </span><span class="s3">= [</span><span class="s1">Xf64</span><span class="s3">, </span><span class="s1">Xf32</span><span class="s3">]</span>

        <span class="s5"># Require that the returned eigenvectors be in the orthogonal complement</span>
        <span class="s5"># of the first few standard basis vectors (cannot be sparse array).</span>
        <span class="s1">m_excluded </span><span class="s3">= </span><span class="s4">3</span>
        <span class="s1">Yf64 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m_excluded</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">float</span><span class="s3">)</span>
        <span class="s1">Yf32 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">eye</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">m_excluded</span><span class="s3">, </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">float32</span><span class="s3">)</span>
        <span class="s1">listY </span><span class="s3">= [</span><span class="s1">Yf64</span><span class="s3">, </span><span class="s1">Yf32</span><span class="s3">]</span>

        <span class="s1">tests </span><span class="s3">= </span><span class="s1">list</span><span class="s3">(</span><span class="s1">itertools</span><span class="s3">.</span><span class="s1">product</span><span class="s3">(</span><span class="s1">listA</span><span class="s3">, </span><span class="s1">listB</span><span class="s3">, </span><span class="s1">listM</span><span class="s3">, </span><span class="s1">listX</span><span class="s3">, </span><span class="s1">listY</span><span class="s3">))</span>

        <span class="s2">for </span><span class="s1">A</span><span class="s3">, </span><span class="s1">B</span><span class="s3">, </span><span class="s1">M</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">Y </span><span class="s2">in </span><span class="s1">tests</span><span class="s3">:</span>
            <span class="s5"># This is one of the slower tests because there are &gt;1,000 configs</span>
            <span class="s5"># to test here. Flip a biased coin to decide whether to run  each</span>
            <span class="s5"># test to get decent coverage in less time.</span>
            <span class="s2">if </span><span class="s1">rnd</span><span class="s3">.</span><span class="s1">random</span><span class="s3">() &lt; </span><span class="s4">0.98</span><span class="s3">:</span>
                <span class="s2">continue  </span><span class="s5"># too many tests</span>
            <span class="s1">eigvals</span><span class="s3">, </span><span class="s1">_ </span><span class="s3">= </span><span class="s1">lobpcg</span><span class="s3">(</span><span class="s1">A</span><span class="s3">, </span><span class="s1">X</span><span class="s3">, </span><span class="s1">B</span><span class="s3">=</span><span class="s1">B</span><span class="s3">, </span><span class="s1">M</span><span class="s3">=</span><span class="s1">M</span><span class="s3">, </span><span class="s1">Y</span><span class="s3">=</span><span class="s1">Y</span><span class="s3">, </span><span class="s1">tol</span><span class="s3">=</span><span class="s4">1e-4</span><span class="s3">,</span>
                                <span class="s1">maxiter</span><span class="s3">=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">largest</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
            <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">eigvals</span><span class="s3">,</span>
                            <span class="s1">np</span><span class="s3">.</span><span class="s1">arange</span><span class="s3">(</span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">m_excluded</span><span class="s3">, </span><span class="s4">1 </span><span class="s3">+ </span><span class="s1">m_excluded </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">),</span>
                            <span class="s1">atol</span><span class="s3">=</span><span class="s4">1e-5</span><span class="s3">)</span>
</pre>
</body>
</html>