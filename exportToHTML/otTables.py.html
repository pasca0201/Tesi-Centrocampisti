<html>
<head>
<title>otTables.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
otTables.py</font>
</center></td></tr></table>
<pre><span class="s0"># coding: utf-8</span>
<span class="s2">&quot;&quot;&quot;fontTools.ttLib.tables.otTables -- A collection of classes representing the various 
OpenType subtables. 
 
Most are constructed upon import from data in otData.py, all are populated with 
converter objects from otConverters.py. 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">copy</span>
<span class="s3">from </span><span class="s1">enum </span><span class="s3">import </span><span class="s1">IntEnum</span>
<span class="s3">from </span><span class="s1">functools </span><span class="s3">import </span><span class="s1">reduce</span>
<span class="s3">from </span><span class="s1">math </span><span class="s3">import </span><span class="s1">radians</span>
<span class="s3">import </span><span class="s1">itertools</span>
<span class="s3">from </span><span class="s1">collections </span><span class="s3">import </span><span class="s1">defaultdict</span><span class="s4">, </span><span class="s1">namedtuple</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">ttLib</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">.</span><span class="s1">TupleVariation </span><span class="s3">import </span><span class="s1">TupleVariation</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">ttLib</span><span class="s4">.</span><span class="s1">tables</span><span class="s4">.</span><span class="s1">otTraverse </span><span class="s3">import </span><span class="s1">dfs_base_table</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">arrayTools </span><span class="s3">import </span><span class="s1">quantizeRect</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">roundTools </span><span class="s3">import </span><span class="s1">otRound</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">transform </span><span class="s3">import </span><span class="s1">Transform</span><span class="s4">, </span><span class="s1">Identity</span><span class="s4">, </span><span class="s1">DecomposedTransform</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">textTools </span><span class="s3">import </span><span class="s1">bytesjoin</span><span class="s4">, </span><span class="s1">pad</span><span class="s4">, </span><span class="s1">safeEval</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">vector </span><span class="s3">import </span><span class="s1">Vector</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">pens</span><span class="s4">.</span><span class="s1">boundsPen </span><span class="s3">import </span><span class="s1">ControlBoundsPen</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">pens</span><span class="s4">.</span><span class="s1">transformPen </span><span class="s3">import </span><span class="s1">TransformPen</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">otBase </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">BaseTable</span><span class="s4">,</span>
    <span class="s1">FormatSwitchingBaseTable</span><span class="s4">,</span>
    <span class="s1">ValueRecord</span><span class="s4">,</span>
    <span class="s1">CountReference</span><span class="s4">,</span>
    <span class="s1">getFormatSwitchingBaseTableClass</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">fixedTools </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">fixedToFloat </span><span class="s3">as </span><span class="s1">fi2fl</span><span class="s4">,</span>
    <span class="s1">floatToFixed </span><span class="s3">as </span><span class="s1">fl2fi</span><span class="s4">,</span>
    <span class="s1">floatToFixedToStr </span><span class="s3">as </span><span class="s1">fl2str</span><span class="s4">,</span>
    <span class="s1">strToFixedToFloat </span><span class="s3">as </span><span class="s1">str2fl</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">feaLib</span><span class="s4">.</span><span class="s1">lookupDebugInfo </span><span class="s3">import </span><span class="s1">LookupDebugInfo</span><span class="s4">, </span><span class="s1">LOOKUP_DEBUG_INFO_KEY</span>
<span class="s3">import </span><span class="s1">logging</span>
<span class="s3">import </span><span class="s1">struct</span>
<span class="s3">import </span><span class="s1">array</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">from </span><span class="s1">enum </span><span class="s3">import </span><span class="s1">IntFlag</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TYPE_CHECKING</span><span class="s4">, </span><span class="s1">Iterator</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Set</span>

<span class="s3">if </span><span class="s1">TYPE_CHECKING</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">ttLib</span><span class="s4">.</span><span class="s1">ttGlyphSet </span><span class="s3">import </span><span class="s1">_TTGlyphSet</span>


<span class="s1">log </span><span class="s4">= </span><span class="s1">logging</span><span class="s4">.</span><span class="s1">getLogger</span><span class="s4">(</span><span class="s1">__name__</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">VarComponentFlags</span><span class="s4">(</span><span class="s1">IntFlag</span><span class="s4">):</span>
    <span class="s1">RESET_UNSPECIFIED_AXES </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">0</span>

    <span class="s1">HAVE_AXES </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">1</span>

    <span class="s1">AXIS_VALUES_HAVE_VARIATION </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">2</span>
    <span class="s1">TRANSFORM_HAS_VARIATION </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">3</span>

    <span class="s1">HAVE_TRANSLATE_X </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">4</span>
    <span class="s1">HAVE_TRANSLATE_Y </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">5</span>
    <span class="s1">HAVE_ROTATION </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">6</span>

    <span class="s1">HAVE_CONDITION </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">7</span>

    <span class="s1">HAVE_SCALE_X </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">8</span>
    <span class="s1">HAVE_SCALE_Y </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">9</span>
    <span class="s1">HAVE_TCENTER_X </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">10</span>
    <span class="s1">HAVE_TCENTER_Y </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">11</span>

    <span class="s1">GID_IS_24BIT </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">12</span>

    <span class="s1">HAVE_SKEW_X </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">13</span>
    <span class="s1">HAVE_SKEW_Y </span><span class="s4">= </span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">14</span>

    <span class="s1">RESERVED_MASK </span><span class="s4">= (</span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">32</span><span class="s4">) - (</span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s5">15</span><span class="s4">)</span>


<span class="s1">VarTransformMappingValues </span><span class="s4">= </span><span class="s1">namedtuple</span><span class="s4">(</span>
    <span class="s6">&quot;VarTransformMappingValues&quot;</span><span class="s4">,</span>
    <span class="s4">[</span><span class="s6">&quot;flag&quot;</span><span class="s4">, </span><span class="s6">&quot;fractionalBits&quot;</span><span class="s4">, </span><span class="s6">&quot;scale&quot;</span><span class="s4">, </span><span class="s6">&quot;defaultValue&quot;</span><span class="s4">],</span>
<span class="s4">)</span>

<span class="s1">VAR_TRANSFORM_MAPPING </span><span class="s4">= {</span>
    <span class="s6">&quot;translateX&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span>
        <span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_TRANSLATE_X</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span>
    <span class="s4">),</span>
    <span class="s6">&quot;translateY&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span>
        <span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_TRANSLATE_Y</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span>
    <span class="s4">),</span>
    <span class="s6">&quot;rotation&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_ROTATION</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">180</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
    <span class="s6">&quot;scaleX&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_SCALE_X</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
    <span class="s6">&quot;scaleY&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_SCALE_Y</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),</span>
    <span class="s6">&quot;skewX&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_SKEW_X</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, -</span><span class="s5">180</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
    <span class="s6">&quot;skewY&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_SKEW_Y</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">180</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
    <span class="s6">&quot;tCenterX&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_TCENTER_X</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
    <span class="s6">&quot;tCenterY&quot;</span><span class="s4">: </span><span class="s1">VarTransformMappingValues</span><span class="s4">(</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_TCENTER_Y</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">),</span>
<span class="s4">}</span>

<span class="s0"># Probably should be somewhere in fontTools.misc</span>
<span class="s1">_packer </span><span class="s4">= {</span>
    <span class="s5">1</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;B&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">),</span>
    <span class="s5">2</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;H&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">),</span>
    <span class="s5">3</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)[</span><span class="s5">1</span><span class="s4">:],</span>
    <span class="s5">4</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">),</span>
<span class="s4">}</span>
<span class="s1">_unpacker </span><span class="s4">= {</span>
    <span class="s5">1</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;&gt;B&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)[</span><span class="s5">0</span><span class="s4">],</span>
    <span class="s5">2</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;&gt;H&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)[</span><span class="s5">0</span><span class="s4">],</span>
    <span class="s5">3</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\0</span><span class="s7">&quot; </span><span class="s4">+ </span><span class="s1">v</span><span class="s4">)[</span><span class="s5">0</span><span class="s4">],</span>
    <span class="s5">4</span><span class="s4">: </span><span class="s3">lambda </span><span class="s1">v</span><span class="s4">: </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)[</span><span class="s5">0</span><span class="s4">],</span>
<span class="s4">}</span>


<span class="s3">def </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Read a variable-length number from data starting at index i. 
 
    Return the number and the next index. 
    &quot;&quot;&quot;</span>

    <span class="s1">b0 </span><span class="s4">= </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
    <span class="s3">if </span><span class="s1">b0 </span><span class="s4">&lt; </span><span class="s5">0x80</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">b0</span><span class="s4">, </span><span class="s1">i </span><span class="s4">+ </span><span class="s5">1</span>
    <span class="s3">elif </span><span class="s1">b0 </span><span class="s4">&lt; </span><span class="s5">0xC0</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">b0 </span><span class="s4">- </span><span class="s5">0x80</span><span class="s4">) &lt;&lt; </span><span class="s5">8 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">], </span><span class="s1">i </span><span class="s4">+ </span><span class="s5">2</span>
    <span class="s3">elif </span><span class="s1">b0 </span><span class="s4">&lt; </span><span class="s5">0xE0</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">b0 </span><span class="s4">- </span><span class="s5">0xC0</span><span class="s4">) &lt;&lt; </span><span class="s5">16 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">] &lt;&lt; </span><span class="s5">8 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">2</span><span class="s4">], </span><span class="s1">i </span><span class="s4">+ </span><span class="s5">3</span>
    <span class="s3">elif </span><span class="s1">b0 </span><span class="s4">&lt; </span><span class="s5">0xF0</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">b0 </span><span class="s4">- </span><span class="s5">0xE0</span><span class="s4">) &lt;&lt; </span><span class="s5">24 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">] &lt;&lt; </span><span class="s5">16 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">2</span><span class="s4">] &lt;&lt; </span><span class="s5">8 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span>
            <span class="s1">i </span><span class="s4">+ </span><span class="s5">3</span>
        <span class="s4">], </span><span class="s1">i </span><span class="s4">+ </span><span class="s5">4</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">b0 </span><span class="s4">- </span><span class="s5">0xF0</span><span class="s4">) &lt;&lt; </span><span class="s5">32 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">] &lt;&lt; </span><span class="s5">24 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">2</span><span class="s4">] &lt;&lt; </span><span class="s5">16 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span>
            <span class="s1">i </span><span class="s4">+ </span><span class="s5">3</span>
        <span class="s4">] &lt;&lt; </span><span class="s5">8 </span><span class="s4">| </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">+ </span><span class="s5">4</span><span class="s4">], </span><span class="s1">i </span><span class="s4">+ </span><span class="s5">5</span>


<span class="s3">def </span><span class="s1">_write_uint32var</span><span class="s4">(</span><span class="s1">v</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Write a variable-length number. 
 
    Return the data. 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">v </span><span class="s4">&lt; </span><span class="s5">0x80</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;B&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)</span>
    <span class="s3">elif </span><span class="s1">v </span><span class="s4">&lt; </span><span class="s5">0x4000</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;H&quot;</span><span class="s4">, (</span><span class="s1">v </span><span class="s4">| </span><span class="s5">0x8000</span><span class="s4">))</span>
    <span class="s3">elif </span><span class="s1">v </span><span class="s4">&lt; </span><span class="s5">0x200000</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, (</span><span class="s1">v </span><span class="s4">| </span><span class="s5">0xC00000</span><span class="s4">))[</span><span class="s5">1</span><span class="s4">:]</span>
    <span class="s3">elif </span><span class="s1">v </span><span class="s4">&lt; </span><span class="s5">0x10000000</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, (</span><span class="s1">v </span><span class="s4">| </span><span class="s5">0xE0000000</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;B&quot;</span><span class="s4">, </span><span class="s5">0xF0</span><span class="s4">) + </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, </span><span class="s1">v</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">VarComponent</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">populateDefaults</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphName </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues </span><span class="s4">= ()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex </span><span class="s4">= </span><span class="s1">NO_VARIATION_INDEX</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex </span><span class="s4">= </span><span class="s1">NO_VARIATION_INDEX</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">transform </span><span class="s4">= </span><span class="s1">DecomposedTransform</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">localState</span><span class="s4">):</span>
        <span class="s1">i </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span>

        <span class="s1">gidSize </span><span class="s4">= </span><span class="s5">3 </span><span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">GID_IS_24BIT </span><span class="s3">else </span><span class="s5">2</span>
        <span class="s1">glyphID </span><span class="s4">= </span><span class="s1">_unpacker</span><span class="s4">[</span><span class="s1">gidSize</span><span class="s4">](</span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">: </span><span class="s1">i </span><span class="s4">+ </span><span class="s1">gidSize</span><span class="s4">])</span>
        <span class="s1">i </span><span class="s4">+= </span><span class="s1">gidSize</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphName </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">glyphOrder</span><span class="s4">[</span><span class="s1">glyphID</span><span class="s4">]</span>

        <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_CONDITION</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_AXES</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">numAxes </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">axisIndices </span><span class="s4">= </span><span class="s1">localState</span><span class="s4">[</span><span class="s6">&quot;AxisIndicesList&quot;</span><span class="s4">].</span><span class="s1">Item</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex</span><span class="s4">]</span>
            <span class="s1">numAxes </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">axisIndices</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_AXES</span><span class="s4">:</span>
            <span class="s1">axisValues</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">TupleVariation</span><span class="s4">.</span><span class="s1">decompileDeltas_</span><span class="s4">(</span><span class="s1">numAxes</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">fi2fl</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s5">14</span><span class="s4">) </span><span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">axisValues</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues </span><span class="s4">= ()</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues</span><span class="s4">) == </span><span class="s1">numAxes</span>

        <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">AXIS_VALUES_HAVE_VARIATION</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex </span><span class="s4">= </span><span class="s1">NO_VARIATION_INDEX</span>
        <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">TRANSFORM_HAS_VARIATION</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex </span><span class="s4">= </span><span class="s1">NO_VARIATION_INDEX</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">transform </span><span class="s4">= </span><span class="s1">DecomposedTransform</span><span class="s4">()</span>

        <span class="s3">def </span><span class="s1">read_transform_component</span><span class="s4">(</span><span class="s1">values</span><span class="s4">):</span>
            <span class="s3">nonlocal </span><span class="s1">i</span>
            <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">values</span><span class="s4">.</span><span class="s1">flag</span><span class="s4">:</span>
                <span class="s1">v </span><span class="s4">= (</span>
                    <span class="s1">fi2fl</span><span class="s4">(</span>
                        <span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s6">&quot;&gt;h&quot;</span><span class="s4">, </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i </span><span class="s4">: </span><span class="s1">i </span><span class="s4">+ </span><span class="s5">2</span><span class="s4">])[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">values</span><span class="s4">.</span><span class="s1">fractionalBits</span>
                    <span class="s4">)</span>
                    <span class="s4">* </span><span class="s1">values</span><span class="s4">.</span><span class="s1">scale</span>
                <span class="s4">)</span>
                <span class="s1">i </span><span class="s4">+= </span><span class="s5">2</span>
                <span class="s3">return </span><span class="s1">v</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">values</span><span class="s4">.</span><span class="s1">defaultValue</span>

        <span class="s3">for </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">mapping_values </span><span class="s3">in </span><span class="s1">VAR_TRANSFORM_MAPPING</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">read_transform_component</span><span class="s4">(</span><span class="s1">mapping_values</span><span class="s4">)</span>
            <span class="s1">setattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

        <span class="s3">if not </span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_SCALE_Y</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">.</span><span class="s1">scaleY </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">.</span><span class="s1">scaleX</span>

        <span class="s1">n </span><span class="s4">= </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">RESERVED_MASK</span>
        <span class="s3">while </span><span class="s1">n</span><span class="s4">:</span>
            <span class="s1">_</span><span class="s4">, </span><span class="s1">i </span><span class="s4">= </span><span class="s1">_read_uint32var</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)</span>
            <span class="s1">n </span><span class="s4">&amp;= </span><span class="s1">n </span><span class="s4">- </span><span class="s5">1</span>

        <span class="s3">return </span><span class="s1">data</span><span class="s4">[</span><span class="s1">i</span><span class="s4">:]</span>

    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">data </span><span class="s4">= []</span>

        <span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags</span>

        <span class="s1">glyphID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">glyphName</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">glyphID </span><span class="s4">&gt; </span><span class="s5">65535</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">GID_IS_24BIT</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">_packer</span><span class="s4">[</span><span class="s5">3</span><span class="s4">](</span><span class="s1">glyphID</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">&amp;= ~</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">GID_IS_24BIT</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">_packer</span><span class="s4">[</span><span class="s5">2</span><span class="s4">](</span><span class="s1">glyphID</span><span class="s4">))</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_CONDITION</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">_write_uint32var</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex</span><span class="s4">))</span>

        <span class="s1">numAxes </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">numAxes</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_AXES</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">_write_uint32var</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex</span><span class="s4">))</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span>
                <span class="s1">TupleVariation</span><span class="s4">.</span><span class="s1">compileDeltaValues_</span><span class="s4">(</span>
                    <span class="s4">[</span><span class="s1">fl2fi</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s5">14</span><span class="s4">) </span><span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues</span><span class="s4">]</span>
                <span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">&amp;= ~</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_AXES</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex </span><span class="s4">!= </span><span class="s1">NO_VARIATION_INDEX</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">AXIS_VALUES_HAVE_VARIATION</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">_write_uint32var</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">&amp;= ~</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">AXIS_VALUES_HAVE_VARIATION</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex </span><span class="s4">!= </span><span class="s1">NO_VARIATION_INDEX</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">TRANSFORM_HAS_VARIATION</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">_write_uint32var</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">&amp;= ~</span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">TRANSFORM_HAS_VARIATION</span>

        <span class="s3">def </span><span class="s1">write_transform_component</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">values</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">values</span><span class="s4">.</span><span class="s1">flag</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span>
                    <span class="s6">&quot;&gt;h&quot;</span><span class="s4">, </span><span class="s1">fl2fi</span><span class="s4">(</span><span class="s1">value </span><span class="s4">/ </span><span class="s1">values</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">, </span><span class="s1">values</span><span class="s4">.</span><span class="s1">fractionalBits</span><span class="s4">)</span>
                <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s7">b&quot;&quot;</span>

        <span class="s3">for </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">mapping_values </span><span class="s3">in </span><span class="s1">VAR_TRANSFORM_MAPPING</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">)</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">write_transform_component</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">mapping_values</span><span class="s4">))</span>

        <span class="s3">return </span><span class="s1">_write_uint32var</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">) + </span><span class="s1">bytesjoin</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">ttFont</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">):</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s6">&quot;VarComponent&quot;</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

        <span class="s3">def </span><span class="s1">write</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">=()):</span>
            <span class="s3">if </span><span class="s1">value </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">writer</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, ((</span><span class="s6">&quot;value&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">),) + </span><span class="s1">attrs</span><span class="s4">)</span>
                <span class="s1">writer</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

        <span class="s1">write</span><span class="s4">(</span><span class="s6">&quot;glyphName&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">glyphName</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">write</span><span class="s4">(</span><span class="s6">&quot;conditionIndex&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">write</span><span class="s4">(</span><span class="s6">&quot;axisIndicesIndex&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex </span><span class="s3">is not None</span>
            <span class="s3">or </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">RESET_UNSPECIFIED_AXES</span>
        <span class="s4">):</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">RESET_UNSPECIFIED_AXES</span><span class="s4">:</span>
                <span class="s1">attrs </span><span class="s4">= ((</span><span class="s6">&quot;resetUnspecifiedAxes&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">),)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">attrs </span><span class="s4">= ()</span>
            <span class="s1">write</span><span class="s4">(</span><span class="s6">&quot;axisValues&quot;</span><span class="s4">, [</span><span class="s1">float</span><span class="s4">(</span><span class="s1">fl2str</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s5">14</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues</span><span class="s4">], </span><span class="s1">attrs</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex </span><span class="s4">!= </span><span class="s1">NO_VARIATION_INDEX</span><span class="s4">:</span>
            <span class="s1">write</span><span class="s4">(</span><span class="s6">&quot;axisValuesVarIndex&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex </span><span class="s4">!= </span><span class="s1">NO_VARIATION_INDEX</span><span class="s4">:</span>
            <span class="s1">write</span><span class="s4">(</span><span class="s6">&quot;transformVarIndex&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex</span><span class="s4">)</span>

        <span class="s0"># Only write transform components that are specified in the</span>
        <span class="s0"># flags, even if they are the default value.</span>
        <span class="s3">for </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">mapping </span><span class="s3">in </span><span class="s1">VAR_TRANSFORM_MAPPING</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s3">if not </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">flag</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">v </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">)</span>
            <span class="s1">write</span><span class="s4">(</span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">fl2str</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">fractionalBits</span><span class="s4">))</span>

        <span class="s1">writer</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s6">&quot;VarComponent&quot;</span><span class="s4">)</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">ttFont</span><span class="s4">):</span>
        <span class="s1">content </span><span class="s4">= [</span><span class="s1">c </span><span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">content </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)]</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">populateDefaults</span><span class="s4">()</span>

        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">assert not </span><span class="s1">content</span>
            <span class="s1">v </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">]</span>

            <span class="s3">if </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;glyphName&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphName </span><span class="s4">= </span><span class="s1">v</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;conditionIndex&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">conditionIndex </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">v</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;axisIndicesIndex&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">axisIndicesIndex </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">v</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;axisValues&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValues </span><span class="s4">= </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">str2fl</span><span class="s4">(</span><span class="s1">v</span><span class="s4">, </span><span class="s5">14</span><span class="s4">) </span><span class="s3">for </span><span class="s1">v </span><span class="s3">in </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">v</span><span class="s4">))</span>
                <span class="s3">if </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;resetUnspecifiedAxes&quot;</span><span class="s4">, </span><span class="s6">&quot;0&quot;</span><span class="s4">)):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">RESET_UNSPECIFIED_AXES</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;axisValuesVarIndex&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">axisValuesVarIndex </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">v</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;transformVarIndex&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">transformVarIndex </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">v</span><span class="s4">)</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">VAR_TRANSFORM_MAPPING</span><span class="s4">:</span>
                <span class="s1">setattr</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">,</span>
                    <span class="s1">name</span><span class="s4">,</span>
                    <span class="s1">safeEval</span><span class="s4">(</span><span class="s1">v</span><span class="s4">),</span>
                <span class="s4">)</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">|= </span><span class="s1">VAR_TRANSFORM_MAPPING</span><span class="s4">[</span><span class="s1">name</span><span class="s4">].</span><span class="s1">flag</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">assert False</span><span class="s4">, </span><span class="s1">name</span>

    <span class="s3">def </span><span class="s1">applyTransformDeltas</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">deltas</span><span class="s4">):</span>
        <span class="s1">i </span><span class="s4">= </span><span class="s5">0</span>

        <span class="s3">def </span><span class="s1">read_transform_component_delta</span><span class="s4">(</span><span class="s1">values</span><span class="s4">):</span>
            <span class="s3">nonlocal </span><span class="s1">i</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">values</span><span class="s4">.</span><span class="s1">flag</span><span class="s4">:</span>
                <span class="s1">v </span><span class="s4">= </span><span class="s1">fi2fl</span><span class="s4">(</span><span class="s1">deltas</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">values</span><span class="s4">.</span><span class="s1">fractionalBits</span><span class="s4">) * </span><span class="s1">values</span><span class="s4">.</span><span class="s1">scale</span>
                <span class="s1">i </span><span class="s4">+= </span><span class="s5">1</span>
                <span class="s3">return </span><span class="s1">v</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s5">0</span>

        <span class="s3">for </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">mapping_values </span><span class="s3">in </span><span class="s1">VAR_TRANSFORM_MAPPING</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">read_transform_component_delta</span><span class="s4">(</span><span class="s1">mapping_values</span><span class="s4">)</span>
            <span class="s1">setattr</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">, </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">, </span><span class="s1">attr_name</span><span class="s4">) + </span><span class="s1">value</span>
            <span class="s4">)</span>

        <span class="s3">if not </span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s1">VarComponentFlags</span><span class="s4">.</span><span class="s1">HAVE_SCALE_Y</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">.</span><span class="s1">scaleY </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">.</span><span class="s1">scaleX</span>

        <span class="s3">assert </span><span class="s1">i </span><span class="s4">== </span><span class="s1">len</span><span class="s4">(</span><span class="s1">deltas</span><span class="s4">), (</span><span class="s1">i</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">deltas</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">__eq__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) != </span><span class="s1">type</span><span class="s4">(</span><span class="s1">other</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">NotImplemented</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__ </span><span class="s4">== </span><span class="s1">other</span><span class="s4">.</span><span class="s1">__dict__</span>

    <span class="s3">def </span><span class="s1">__ne__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">other</span><span class="s4">):</span>
        <span class="s1">result </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__eq__</span><span class="s4">(</span><span class="s1">other</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">result </span><span class="s3">if </span><span class="s1">result </span><span class="s3">is </span><span class="s1">NotImplemented </span><span class="s3">else not </span><span class="s1">result</span>


<span class="s3">class </span><span class="s1">VarCompositeGlyph</span><span class="s4">:</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">components</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">components </span><span class="s4">= </span><span class="s1">components </span><span class="s3">if </span><span class="s1">components </span><span class="s3">is not None else </span><span class="s4">[]</span>

    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">data</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">localState</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">components </span><span class="s4">= []</span>
        <span class="s3">while </span><span class="s1">data</span><span class="s4">:</span>
            <span class="s1">component </span><span class="s4">= </span><span class="s1">VarComponent</span><span class="s4">()</span>
            <span class="s1">data </span><span class="s4">= </span><span class="s1">component</span><span class="s4">.</span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">data</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">localState</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">components</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">component</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">data </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">component </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">components</span><span class="s4">:</span>
            <span class="s1">data</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">component</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s1">font</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">bytesjoin</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s6">&quot;VarCompositeGlyph&quot;</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">component </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">components</span><span class="s4">):</span>
            <span class="s1">component</span><span class="s4">.</span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, [(</span><span class="s6">&quot;index&quot;</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)])</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s6">&quot;VarCompositeGlyph&quot;</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">content </span><span class="s4">= [</span><span class="s1">c </span><span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">content </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">c</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)]</span>
        <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;VarComponent&quot;</span>
            <span class="s1">component </span><span class="s4">= </span><span class="s1">VarComponent</span><span class="s4">()</span>
            <span class="s1">component</span><span class="s4">.</span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">components</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">component</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">AATStateTable</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">GlyphClasses </span><span class="s4">= {}  </span><span class="s0"># GlyphID --&gt; GlyphClass</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">States </span><span class="s4">= []  </span><span class="s0"># List of AATState, indexed by state number</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">PerGlyphLookups </span><span class="s4">= []  </span><span class="s0"># [{GlyphID:GlyphID}, ...]</span>


<span class="s3">class </span><span class="s1">AATState</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Transitions </span><span class="s4">= {}  </span><span class="s0"># GlyphClass --&gt; AATAction</span>


<span class="s3">class </span><span class="s1">AATAction</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s1">_FLAGS </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">compileActions</span><span class="s4">(</span><span class="s1">font</span><span class="s4">, </span><span class="s1">states</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s3">None</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_writeFlagsToXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">):</span>
        <span class="s1">flags </span><span class="s4">= [</span><span class="s1">f </span><span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_FLAGS </span><span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">[</span><span class="s1">f</span><span class="s4">]]</span>
        <span class="s3">if </span><span class="s1">flags</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Flags&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s6">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">))</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;ReservedFlags&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s6">&quot;0x%04X&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">_setFlag</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">flag</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">flag </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_FLAGS</span><span class="s4">, </span><span class="s6">&quot;unsupported flag %s&quot; </span><span class="s4">% </span><span class="s1">flag</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">[</span><span class="s1">flag</span><span class="s4">] = </span><span class="s3">True</span>


<span class="s3">class </span><span class="s1">RearrangementMorphAction</span><span class="s4">(</span><span class="s1">AATAction</span><span class="s4">):</span>
    <span class="s1">staticSize </span><span class="s4">= </span><span class="s5">4</span>
    <span class="s1">actionHeaderSize </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">_FLAGS </span><span class="s4">= [</span><span class="s6">&quot;MarkFirst&quot;</span><span class="s4">, </span><span class="s6">&quot;DontAdvance&quot;</span><span class="s4">, </span><span class="s6">&quot;MarkLast&quot;</span><span class="s4">]</span>

    <span class="s1">_VERBS </span><span class="s4">= {</span>
        <span class="s5">0</span><span class="s4">: </span><span class="s6">&quot;no change&quot;</span><span class="s4">,</span>
        <span class="s5">1</span><span class="s4">: </span><span class="s6">&quot;Ax ⇒ xA&quot;</span><span class="s4">,</span>
        <span class="s5">2</span><span class="s4">: </span><span class="s6">&quot;xD ⇒ Dx&quot;</span><span class="s4">,</span>
        <span class="s5">3</span><span class="s4">: </span><span class="s6">&quot;AxD ⇒ DxA&quot;</span><span class="s4">,</span>
        <span class="s5">4</span><span class="s4">: </span><span class="s6">&quot;ABx ⇒ xAB&quot;</span><span class="s4">,</span>
        <span class="s5">5</span><span class="s4">: </span><span class="s6">&quot;ABx ⇒ xBA&quot;</span><span class="s4">,</span>
        <span class="s5">6</span><span class="s4">: </span><span class="s6">&quot;xCD ⇒ CDx&quot;</span><span class="s4">,</span>
        <span class="s5">7</span><span class="s4">: </span><span class="s6">&quot;xCD ⇒ DCx&quot;</span><span class="s4">,</span>
        <span class="s5">8</span><span class="s4">: </span><span class="s6">&quot;AxCD ⇒ CDxA&quot;</span><span class="s4">,</span>
        <span class="s5">9</span><span class="s4">: </span><span class="s6">&quot;AxCD ⇒ DCxA&quot;</span><span class="s4">,</span>
        <span class="s5">10</span><span class="s4">: </span><span class="s6">&quot;ABxD ⇒ DxAB&quot;</span><span class="s4">,</span>
        <span class="s5">11</span><span class="s4">: </span><span class="s6">&quot;ABxD ⇒ DxBA&quot;</span><span class="s4">,</span>
        <span class="s5">12</span><span class="s4">: </span><span class="s6">&quot;ABxCD ⇒ CDxAB&quot;</span><span class="s4">,</span>
        <span class="s5">13</span><span class="s4">: </span><span class="s6">&quot;ABxCD ⇒ CDxBA&quot;</span><span class="s4">,</span>
        <span class="s5">14</span><span class="s4">: </span><span class="s6">&quot;ABxCD ⇒ DCxAB&quot;</span><span class="s4">,</span>
        <span class="s5">15</span><span class="s4">: </span><span class="s6">&quot;ABxCD ⇒ DCxBA&quot;</span><span class="s4">,</span>
    <span class="s4">}</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkFirst </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkLast </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>

    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionIndex </span><span class="s3">is None</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">&gt;= </span><span class="s5">0 </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">&lt;= </span><span class="s5">15</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">| </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkFirst</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x8000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x4000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkLast</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x2000</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionReader</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionReader </span><span class="s3">is None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">= </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0xF</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkFirst </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x8000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x4000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkLast </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x2000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x1FF0</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, **</span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;NewState&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_writeFlagsToXML</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Verb&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb</span><span class="s4">)</span>
        <span class="s1">verbComment </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_VERBS</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">verbComment </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">comment</span><span class="s4">(</span><span class="s1">verbComment</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkFirst </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkLast </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">content </span><span class="s4">= [</span><span class="s1">t </span><span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">content </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)]</span>
        <span class="s3">for </span><span class="s1">eltName</span><span class="s4">, </span><span class="s1">eltAttrs</span><span class="s4">, </span><span class="s1">eltContent </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;NewState&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;Verb&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">Verb </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;ReservedFlags&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;Flags&quot;</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">flag </span><span class="s3">in </span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_setFlag</span><span class="s4">(</span><span class="s1">flag</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">())</span>


<span class="s3">class </span><span class="s1">ContextualMorphAction</span><span class="s4">(</span><span class="s1">AATAction</span><span class="s4">):</span>
    <span class="s1">staticSize </span><span class="s4">= </span><span class="s5">8</span>
    <span class="s1">actionHeaderSize </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">_FLAGS </span><span class="s4">= [</span><span class="s6">&quot;SetMark&quot;</span><span class="s4">, </span><span class="s6">&quot;DontAdvance&quot;</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetMark</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkIndex</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIndex </span><span class="s4">= </span><span class="s5">0xFFFF</span><span class="s4">, </span><span class="s5">0xFFFF</span>

    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionIndex </span><span class="s3">is None</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">SetMark</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x8000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x4000</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">)</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkIndex</span><span class="s4">)</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIndex</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionReader</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionReader </span><span class="s3">is None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetMark </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x8000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x4000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x3FFF</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkIndex </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIndex </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, **</span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;NewState&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_writeFlagsToXML</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;MarkIndex&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkIndex</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;CurrentIndex&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIndex</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetMark </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkIndex</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIndex </span><span class="s4">= </span><span class="s5">0xFFFF</span><span class="s4">, </span><span class="s5">0xFFFF</span>
        <span class="s1">content </span><span class="s4">= [</span><span class="s1">t </span><span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">content </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)]</span>
        <span class="s3">for </span><span class="s1">eltName</span><span class="s4">, </span><span class="s1">eltAttrs</span><span class="s4">, </span><span class="s1">eltContent </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;NewState&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;Flags&quot;</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">flag </span><span class="s3">in </span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_setFlag</span><span class="s4">(</span><span class="s1">flag</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">())</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;ReservedFlags&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;MarkIndex&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkIndex </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;CurrentIndex&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIndex </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>


<span class="s3">class </span><span class="s1">LigAction</span><span class="s4">(</span><span class="s1">object</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Store </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s0"># GlyphIndexDelta is a (possibly negative) delta that gets</span>
        <span class="s0"># added to the glyph ID at the top of the AAT runtime</span>
        <span class="s0"># execution stack. It is *not* a byte offset into the</span>
        <span class="s0"># morx table. The result of the addition, which is performed</span>
        <span class="s0"># at run time by the shaping engine, is an index into</span>
        <span class="s0"># the ligature components table. See 'morx' specification.</span>
        <span class="s0"># In the AAT specification, this field is called Offset;</span>
        <span class="s0"># but its meaning is quite different from other offsets</span>
        <span class="s0"># in either AAT or OpenType, so we use a different name.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">GlyphIndexDelta </span><span class="s4">= </span><span class="s5">0</span>


<span class="s3">class </span><span class="s1">LigatureMorphAction</span><span class="s4">(</span><span class="s1">AATAction</span><span class="s4">):</span>
    <span class="s1">staticSize </span><span class="s4">= </span><span class="s5">6</span>

    <span class="s0"># 4 bytes for each of {action,ligComponents,ligatures}Offset</span>
    <span class="s1">actionHeaderSize </span><span class="s4">= </span><span class="s5">12</span>

    <span class="s1">_FLAGS </span><span class="s4">= [</span><span class="s6">&quot;SetComponent&quot;</span><span class="s4">, </span><span class="s6">&quot;DontAdvance&quot;</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetComponent</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s3">False</span><span class="s4">, </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Actions </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionIndex </span><span class="s3">is not None</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">SetComponent</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x8000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x4000</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Actions</span><span class="s4">) &gt; </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x2000</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Actions</span><span class="s4">) &gt; </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s1">actions </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">compileLigActions</span><span class="s4">()</span>
            <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">actionIndex</span><span class="s4">[</span><span class="s1">actions</span><span class="s4">])</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionReader</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionReader </span><span class="s3">is not None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetComponent </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x8000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x4000</span><span class="s4">)</span>
        <span class="s1">performAction </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x2000</span><span class="s4">)</span>
        <span class="s0"># As of 2017-09-12, the 'morx' specification says that</span>
        <span class="s0"># the reserved bitmask in ligature subtables is 0x3FFF.</span>
        <span class="s0"># However, the specification also defines a flag 0x2000,</span>
        <span class="s0"># so the reserved value should actually be 0x1FFF.</span>
        <span class="s0"># TODO: Report this specification bug to Apple.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x1FFF</span>
        <span class="s1">actionIndex </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">performAction</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">Actions </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_decompileLigActions</span><span class="s4">(</span><span class="s1">actionReader</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">Actions </span><span class="s4">= []</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">compileActions</span><span class="s4">(</span><span class="s1">font</span><span class="s4">, </span><span class="s1">states</span><span class="s4">):</span>
        <span class="s1">result</span><span class="s4">, </span><span class="s1">actions</span><span class="s4">, </span><span class="s1">actionIndex </span><span class="s4">= </span><span class="s7">b&quot;&quot;</span><span class="s4">, </span><span class="s1">set</span><span class="s4">(), {}</span>
        <span class="s3">for </span><span class="s1">state </span><span class="s3">in </span><span class="s1">states</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">_glyphClass</span><span class="s4">, </span><span class="s1">trans </span><span class="s3">in </span><span class="s1">state</span><span class="s4">.</span><span class="s1">Transitions</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s1">actions</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">trans</span><span class="s4">.</span><span class="s1">compileLigActions</span><span class="s4">())</span>
        <span class="s0"># Sort the compiled actions in decreasing order of</span>
        <span class="s0"># length, so that the longer sequence come before the</span>
        <span class="s0"># shorter ones.  For each compiled action ABCD, its</span>
        <span class="s0"># suffixes BCD, CD, and D do not be encoded separately</span>
        <span class="s0"># (in case they occur); instead, we can just store an</span>
        <span class="s0"># index that points into the middle of the longer</span>
        <span class="s0"># sequence. Every compiled AAT ligature sequence is</span>
        <span class="s0"># terminated with an end-of-sequence flag, which can</span>
        <span class="s0"># only be set on the last element of the sequence.</span>
        <span class="s0"># Therefore, it is sufficient to consider just the</span>
        <span class="s0"># suffixes.</span>
        <span class="s3">for </span><span class="s1">a </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">actions</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: (-</span><span class="s1">len</span><span class="s4">(</span><span class="s1">x</span><span class="s4">), </span><span class="s1">x</span><span class="s4">)):</span>
            <span class="s3">if </span><span class="s1">a </span><span class="s3">not in </span><span class="s1">actionIndex</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">a</span><span class="s4">), </span><span class="s5">4</span><span class="s4">):</span>
                    <span class="s1">suffix </span><span class="s4">= </span><span class="s1">a</span><span class="s4">[</span><span class="s1">i</span><span class="s4">:]</span>
                    <span class="s1">suffixIndex </span><span class="s4">= (</span><span class="s1">len</span><span class="s4">(</span><span class="s1">result</span><span class="s4">) + </span><span class="s1">i</span><span class="s4">) // </span><span class="s5">4</span>
                    <span class="s1">actionIndex</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s1">suffix</span><span class="s4">, </span><span class="s1">suffixIndex</span><span class="s4">)</span>
                <span class="s1">result </span><span class="s4">+= </span><span class="s1">a</span>
        <span class="s1">result </span><span class="s4">= </span><span class="s1">pad</span><span class="s4">(</span><span class="s1">result</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s4">(</span><span class="s1">result</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">compileLigActions</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">result </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">action </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Actions</span><span class="s4">):</span>
            <span class="s1">last </span><span class="s4">= </span><span class="s1">i </span><span class="s4">== </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Actions</span><span class="s4">) - </span><span class="s5">1</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">action</span><span class="s4">.</span><span class="s1">GlyphIndexDelta </span><span class="s4">&amp; </span><span class="s5">0x3FFFFFFF</span>
            <span class="s1">value </span><span class="s4">|= </span><span class="s5">0x80000000 </span><span class="s3">if </span><span class="s1">last </span><span class="s3">else </span><span class="s5">0</span>
            <span class="s1">value </span><span class="s4">|= </span><span class="s5">0x40000000 </span><span class="s3">if </span><span class="s1">action</span><span class="s4">.</span><span class="s1">Store </span><span class="s3">else </span><span class="s5">0</span>
            <span class="s1">result</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;L&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">))</span>
        <span class="s3">return </span><span class="s1">bytesjoin</span><span class="s4">(</span><span class="s1">result</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_decompileLigActions</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">actionReader</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">):</span>
        <span class="s1">actions </span><span class="s4">= []</span>
        <span class="s1">last </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">reader </span><span class="s4">= </span><span class="s1">actionReader</span><span class="s4">.</span><span class="s1">getSubReader</span><span class="s4">(</span><span class="s1">actionReader</span><span class="s4">.</span><span class="s1">pos </span><span class="s4">+ </span><span class="s1">actionIndex </span><span class="s4">* </span><span class="s5">4</span><span class="s4">)</span>
        <span class="s3">while not </span><span class="s1">last</span><span class="s4">:</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readULong</span><span class="s4">()</span>
            <span class="s1">last </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">value </span><span class="s4">&amp; </span><span class="s5">0x80000000</span><span class="s4">)</span>
            <span class="s1">action </span><span class="s4">= </span><span class="s1">LigAction</span><span class="s4">()</span>
            <span class="s1">actions</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">action</span><span class="s4">)</span>
            <span class="s1">action</span><span class="s4">.</span><span class="s1">Store </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">value </span><span class="s4">&amp; </span><span class="s5">0x40000000</span><span class="s4">)</span>
            <span class="s1">delta </span><span class="s4">= </span><span class="s1">value </span><span class="s4">&amp; </span><span class="s5">0x3FFFFFFF</span>
            <span class="s3">if </span><span class="s1">delta </span><span class="s4">&gt;= </span><span class="s5">0x20000000</span><span class="s4">:  </span><span class="s0"># sign-extend 30-bit value</span>
                <span class="s1">delta </span><span class="s4">= -</span><span class="s5">0x40000000 </span><span class="s4">+ </span><span class="s1">delta</span>
            <span class="s1">action</span><span class="s4">.</span><span class="s1">GlyphIndexDelta </span><span class="s4">= </span><span class="s1">delta</span>
        <span class="s3">return </span><span class="s1">actions</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetComponent </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s3">False</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Actions </span><span class="s4">= []</span>
        <span class="s1">content </span><span class="s4">= [</span><span class="s1">t </span><span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">content </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)]</span>
        <span class="s3">for </span><span class="s1">eltName</span><span class="s4">, </span><span class="s1">eltAttrs</span><span class="s4">, </span><span class="s1">eltContent </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;NewState&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;Flags&quot;</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">flag </span><span class="s3">in </span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_setFlag</span><span class="s4">(</span><span class="s1">flag</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">())</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;ReservedFlags&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;Action&quot;</span><span class="s4">:</span>
                <span class="s1">action </span><span class="s4">= </span><span class="s1">LigAction</span><span class="s4">()</span>
                <span class="s1">flags </span><span class="s4">= </span><span class="s1">eltAttrs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;Flags&quot;</span><span class="s4">, </span><span class="s6">&quot;&quot;</span><span class="s4">).</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">)</span>
                <span class="s1">flags </span><span class="s4">= [</span><span class="s1">f</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">() </span><span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">flags</span><span class="s4">]</span>
                <span class="s1">action</span><span class="s4">.</span><span class="s1">Store </span><span class="s4">= </span><span class="s6">&quot;Store&quot; </span><span class="s3">in </span><span class="s1">flags</span>
                <span class="s1">action</span><span class="s4">.</span><span class="s1">GlyphIndexDelta </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;GlyphIndexDelta&quot;</span><span class="s4">])</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">Actions</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">action</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, **</span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;NewState&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_writeFlagsToXML</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">action </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Actions</span><span class="s4">:</span>
            <span class="s1">attribs </span><span class="s4">= [(</span><span class="s6">&quot;GlyphIndexDelta&quot;</span><span class="s4">, </span><span class="s1">action</span><span class="s4">.</span><span class="s1">GlyphIndexDelta</span><span class="s4">)]</span>
            <span class="s3">if </span><span class="s1">action</span><span class="s4">.</span><span class="s1">Store</span><span class="s4">:</span>
                <span class="s1">attribs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s6">&quot;Flags&quot;</span><span class="s4">, </span><span class="s6">&quot;Store&quot;</span><span class="s4">))</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Action&quot;</span><span class="s4">, </span><span class="s1">attribs</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">InsertionMorphAction</span><span class="s4">(</span><span class="s1">AATAction</span><span class="s4">):</span>
    <span class="s1">staticSize </span><span class="s4">= </span><span class="s5">8</span>
    <span class="s1">actionHeaderSize </span><span class="s4">= </span><span class="s5">4  </span><span class="s0"># 4 bytes for actionOffset</span>
    <span class="s1">_FLAGS </span><span class="s4">= [</span>
        <span class="s6">&quot;SetMark&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;DontAdvance&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;CurrentIsKashidaLike&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;MarkedIsKashidaLike&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;CurrentInsertBefore&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;MarkedInsertBefore&quot;</span><span class="s4">,</span>
    <span class="s4">]</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s3">for </span><span class="s1">flag </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_FLAGS</span><span class="s4">:</span>
            <span class="s1">setattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">flag</span><span class="s4">, </span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction </span><span class="s4">= [], []</span>

    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionIndex </span><span class="s3">is not None</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ReservedFlags</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">SetMark</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x8000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x4000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIsKashidaLike</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x2000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedIsKashidaLike</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x1000</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertBefore</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x0800</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertBefore</span><span class="s4">:</span>
            <span class="s1">flags </span><span class="s4">|= </span><span class="s5">0x0400</span>
        <span class="s1">flags </span><span class="s4">|= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">) &lt;&lt; </span><span class="s5">5</span>
        <span class="s1">flags </span><span class="s4">|= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction</span><span class="s4">)</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">) &gt; </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s1">currentIndex </span><span class="s4">= </span><span class="s1">actionIndex</span><span class="s4">[</span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">)]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">currentIndex </span><span class="s4">= </span><span class="s5">0xFFFF</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">currentIndex</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction</span><span class="s4">) &gt; </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s1">markedIndex </span><span class="s4">= </span><span class="s1">actionIndex</span><span class="s4">[</span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction</span><span class="s4">)]</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">markedIndex </span><span class="s4">= </span><span class="s5">0xFFFF</span>
        <span class="s1">writer</span><span class="s4">.</span><span class="s1">writeUShort</span><span class="s4">(</span><span class="s1">markedIndex</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">actionReader</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s1">actionReader </span><span class="s3">is not None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">flags </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">SetMark </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x8000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">DontAdvance </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x4000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentIsKashidaLike </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x2000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedIsKashidaLike </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x1000</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertBefore </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x0800</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertBefore </span><span class="s4">= </span><span class="s1">bool</span><span class="s4">(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x0400</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_decompileInsertionAction</span><span class="s4">(</span>
            <span class="s1">actionReader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">index</span><span class="s4">=</span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">(), </span><span class="s1">count</span><span class="s4">=((</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x03E0</span><span class="s4">) &gt;&gt; </span><span class="s5">5</span><span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_decompileInsertionAction</span><span class="s4">(</span>
            <span class="s1">actionReader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">index</span><span class="s4">=</span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShort</span><span class="s4">(), </span><span class="s1">count</span><span class="s4">=(</span><span class="s1">flags </span><span class="s4">&amp; </span><span class="s5">0x001F</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_decompileInsertionAction</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">actionReader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">index</span><span class="s4">, </span><span class="s1">count</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">index </span><span class="s4">== </span><span class="s5">0xFFFF </span><span class="s3">or </span><span class="s1">count </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">[]</span>
        <span class="s1">reader </span><span class="s4">= </span><span class="s1">actionReader</span><span class="s4">.</span><span class="s1">getSubReader</span><span class="s4">(</span><span class="s1">actionReader</span><span class="s4">.</span><span class="s1">pos </span><span class="s4">+ </span><span class="s1">index </span><span class="s4">* </span><span class="s5">2</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphNameMany</span><span class="s4">(</span><span class="s1">reader</span><span class="s4">.</span><span class="s1">readUShortArray</span><span class="s4">(</span><span class="s1">count</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">name</span><span class="s4">):</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, **</span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;NewState&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">NewState</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_writeFlagsToXML</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;CurrentInsertionAction&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">=</span><span class="s1">g</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;MarkedInsertionAction&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">=</span><span class="s1">g</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">__init__</span><span class="s4">()</span>
        <span class="s1">content </span><span class="s4">= [</span><span class="s1">t </span><span class="s3">for </span><span class="s1">t </span><span class="s3">in </span><span class="s1">content </span><span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">t</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">)]</span>
        <span class="s3">for </span><span class="s1">eltName</span><span class="s4">, </span><span class="s1">eltAttrs</span><span class="s4">, </span><span class="s1">eltContent </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;NewState&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">NewState </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;Flags&quot;</span><span class="s4">:</span>
                <span class="s3">for </span><span class="s1">flag </span><span class="s3">in </span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">):</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_setFlag</span><span class="s4">(</span><span class="s1">flag</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">())</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;CurrentInsertionAction&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">eltName </span><span class="s4">== </span><span class="s6">&quot;MarkedInsertionAction&quot;</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">MarkedInsertionAction</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">eltAttrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">])</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">assert False</span><span class="s4">, </span><span class="s1">eltName</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">compileActions</span><span class="s4">(</span><span class="s1">font</span><span class="s4">, </span><span class="s1">states</span><span class="s4">):</span>
        <span class="s1">actions</span><span class="s4">, </span><span class="s1">actionIndex</span><span class="s4">, </span><span class="s1">result </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(), {}, </span><span class="s7">b&quot;&quot;</span>
        <span class="s3">for </span><span class="s1">state </span><span class="s3">in </span><span class="s1">states</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">_glyphClass</span><span class="s4">, </span><span class="s1">trans </span><span class="s3">in </span><span class="s1">state</span><span class="s4">.</span><span class="s1">Transitions</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">if </span><span class="s1">trans</span><span class="s4">.</span><span class="s1">CurrentInsertionAction </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s1">actions</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">trans</span><span class="s4">.</span><span class="s1">CurrentInsertionAction</span><span class="s4">))</span>
                <span class="s3">if </span><span class="s1">trans</span><span class="s4">.</span><span class="s1">MarkedInsertionAction </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s1">actions</span><span class="s4">.</span><span class="s1">add</span><span class="s4">(</span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">trans</span><span class="s4">.</span><span class="s1">MarkedInsertionAction</span><span class="s4">))</span>
        <span class="s0"># Sort the compiled actions in decreasing order of</span>
        <span class="s0"># length, so that the longer sequence come before the</span>
        <span class="s0"># shorter ones.</span>
        <span class="s3">for </span><span class="s1">action </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">actions</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">x</span><span class="s4">: (-</span><span class="s1">len</span><span class="s4">(</span><span class="s1">x</span><span class="s4">), </span><span class="s1">x</span><span class="s4">)):</span>
            <span class="s0"># We insert all sub-sequences of the action glyph sequence</span>
            <span class="s0"># into actionIndex. For example, if one action triggers on</span>
            <span class="s0"># glyph sequence [A, B, C, D, E] and another action triggers</span>
            <span class="s0"># on [C, D], we return result=[A, B, C, D, E] (as list of</span>
            <span class="s0"># encoded glyph IDs), and actionIndex={('A','B','C','D','E'): 0,</span>
            <span class="s0"># ('C','D'): 2}.</span>
            <span class="s3">if </span><span class="s1">action </span><span class="s3">in </span><span class="s1">actionIndex</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s3">for </span><span class="s1">start </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">action</span><span class="s4">)):</span>
                <span class="s1">startIndex </span><span class="s4">= (</span><span class="s1">len</span><span class="s4">(</span><span class="s1">result</span><span class="s4">) // </span><span class="s5">2</span><span class="s4">) + </span><span class="s1">start</span>
                <span class="s3">for </span><span class="s1">limit </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">action</span><span class="s4">)):</span>
                    <span class="s1">glyphs </span><span class="s4">= </span><span class="s1">action</span><span class="s4">[</span><span class="s1">start </span><span class="s4">: </span><span class="s1">limit </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">]</span>
                    <span class="s1">actionIndex</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s1">glyphs</span><span class="s4">, </span><span class="s1">startIndex</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">glyph </span><span class="s3">in </span><span class="s1">action</span><span class="s4">:</span>
                <span class="s1">glyphID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">glyph</span><span class="s4">)</span>
                <span class="s1">result </span><span class="s4">+= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">pack</span><span class="s4">(</span><span class="s6">&quot;&gt;H&quot;</span><span class="s4">, </span><span class="s1">glyphID</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">result</span><span class="s4">, </span><span class="s1">actionIndex</span>


<span class="s3">class </span><span class="s1">FeatureParams</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s4">(</span>
            <span class="s1">featureParamTypes</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">writer</span><span class="s4">[</span><span class="s6">&quot;FeatureTag&quot;</span><span class="s4">]) == </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span>
        <span class="s4">), </span><span class="s6">&quot;Wrong FeatureParams type for feature '%s': %s&quot; </span><span class="s4">% (</span>
            <span class="s1">writer</span><span class="s4">[</span><span class="s6">&quot;FeatureTag&quot;</span><span class="s4">],</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">writer</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">name</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">name</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">FeatureParamsSize</span><span class="s4">(</span><span class="s1">FeatureParams</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">FeatureParamsStylisticSet</span><span class="s4">(</span><span class="s1">FeatureParams</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">FeatureParamsCharacterVariants</span><span class="s4">(</span><span class="s1">FeatureParams</span><span class="s4">):</span>
    <span class="s3">pass</span>


<span class="s3">class </span><span class="s1">Coverage</span><span class="s4">(</span><span class="s1">FormatSwitchingBaseTable</span><span class="s4">):</span>
    <span class="s0"># manual implementation to get rid of glyphID dependencies</span>

    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;glyphs&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;GlyphArray&quot;</span><span class="s4">]</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">2</span><span class="s4">:</span>
            <span class="s1">glyphs </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= []</span>
            <span class="s1">ranges </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;RangeRecord&quot;</span><span class="s4">]</span>
            <span class="s0"># Some SIL fonts have coverage entries that don't have sorted</span>
            <span class="s0"># StartCoverageIndex.  If it is so, fixup and warn.  We undo</span>
            <span class="s0"># this when writing font out.</span>
            <span class="s1">sorted_ranges </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">ranges</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">a</span><span class="s4">: </span><span class="s1">a</span><span class="s4">.</span><span class="s1">StartCoverageIndex</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">ranges </span><span class="s4">!= </span><span class="s1">sorted_ranges</span><span class="s4">:</span>
                <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s6">&quot;GSUB/GPOS Coverage is not sorted by glyph ids.&quot;</span><span class="s4">)</span>
                <span class="s1">ranges </span><span class="s4">= </span><span class="s1">sorted_ranges</span>
            <span class="s3">del </span><span class="s1">sorted_ranges</span>
            <span class="s3">for </span><span class="s1">r </span><span class="s3">in </span><span class="s1">ranges</span><span class="s4">:</span>
                <span class="s1">start </span><span class="s4">= </span><span class="s1">r</span><span class="s4">.</span><span class="s1">Start</span>
                <span class="s1">end </span><span class="s4">= </span><span class="s1">r</span><span class="s4">.</span><span class="s1">End</span>
                <span class="s1">startID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">start</span><span class="s4">)</span>
                <span class="s1">endID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">end</span><span class="s4">) + </span><span class="s5">1</span>
                <span class="s1">glyphs</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphNameMany</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">startID</span><span class="s4">, </span><span class="s1">endID</span><span class="s4">)))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= []</span>
            <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s6">&quot;Unknown Coverage format: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">)</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format  </span><span class="s0"># Don't need this anymore</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">glyphs </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;glyphs&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">glyphs </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">glyphs </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= []</span>
        <span class="s1">format </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s1">rawTable </span><span class="s4">= {</span><span class="s6">&quot;GlyphArray&quot;</span><span class="s4">: </span><span class="s1">glyphs</span><span class="s4">}</span>
        <span class="s3">if </span><span class="s1">glyphs</span><span class="s4">:</span>
            <span class="s0"># find out whether Format 2 is more compact or not</span>
            <span class="s1">glyphIDs </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphIDMany</span><span class="s4">(</span><span class="s1">glyphs</span><span class="s4">)</span>
            <span class="s1">brokenOrder </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">glyphIDs</span><span class="s4">) != </span><span class="s1">glyphIDs</span>

            <span class="s1">last </span><span class="s4">= </span><span class="s1">glyphIDs</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
            <span class="s1">ranges </span><span class="s4">= [[</span><span class="s1">last</span><span class="s4">]]</span>
            <span class="s3">for </span><span class="s1">glyphID </span><span class="s3">in </span><span class="s1">glyphIDs</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]:</span>
                <span class="s3">if </span><span class="s1">glyphID </span><span class="s4">!= </span><span class="s1">last </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">:</span>
                    <span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">last</span><span class="s4">)</span>
                    <span class="s1">ranges</span><span class="s4">.</span><span class="s1">append</span><span class="s4">([</span><span class="s1">glyphID</span><span class="s4">])</span>
                <span class="s1">last </span><span class="s4">= </span><span class="s1">glyphID</span>
            <span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">last</span><span class="s4">)</span>

            <span class="s3">if </span><span class="s1">brokenOrder </span><span class="s3">or </span><span class="s1">len</span><span class="s4">(</span><span class="s1">ranges</span><span class="s4">) * </span><span class="s5">3 </span><span class="s4">&lt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">glyphs</span><span class="s4">):  </span><span class="s0"># 3 words vs. 1 word</span>
                <span class="s0"># Format 2 is more compact</span>
                <span class="s1">index </span><span class="s4">= </span><span class="s5">0</span>
                <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">ranges</span><span class="s4">)):</span>
                    <span class="s1">start</span><span class="s4">, </span><span class="s1">end </span><span class="s4">= </span><span class="s1">ranges</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
                    <span class="s1">r </span><span class="s4">= </span><span class="s1">RangeRecord</span><span class="s4">()</span>
                    <span class="s1">r</span><span class="s4">.</span><span class="s1">StartID </span><span class="s4">= </span><span class="s1">start</span>
                    <span class="s1">r</span><span class="s4">.</span><span class="s1">Start </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphName</span><span class="s4">(</span><span class="s1">start</span><span class="s4">)</span>
                    <span class="s1">r</span><span class="s4">.</span><span class="s1">End </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphName</span><span class="s4">(</span><span class="s1">end</span><span class="s4">)</span>
                    <span class="s1">r</span><span class="s4">.</span><span class="s1">StartCoverageIndex </span><span class="s4">= </span><span class="s1">index</span>
                    <span class="s1">ranges</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">r</span>
                    <span class="s1">index </span><span class="s4">= </span><span class="s1">index </span><span class="s4">+ </span><span class="s1">end </span><span class="s4">- </span><span class="s1">start </span><span class="s4">+ </span><span class="s5">1</span>
                <span class="s3">if </span><span class="s1">brokenOrder</span><span class="s4">:</span>
                    <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s6">&quot;GSUB/GPOS Coverage is not sorted by glyph ids.&quot;</span><span class="s4">)</span>
                    <span class="s1">ranges</span><span class="s4">.</span><span class="s1">sort</span><span class="s4">(</span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">a</span><span class="s4">: </span><span class="s1">a</span><span class="s4">.</span><span class="s1">StartID</span><span class="s4">)</span>
                <span class="s3">for </span><span class="s1">r </span><span class="s3">in </span><span class="s1">ranges</span><span class="s4">:</span>
                    <span class="s3">del </span><span class="s1">r</span><span class="s4">.</span><span class="s1">StartID</span>
                <span class="s1">format </span><span class="s4">= </span><span class="s5">2</span>
                <span class="s1">rawTable </span><span class="s4">= {</span><span class="s6">&quot;RangeRecord&quot;</span><span class="s4">: </span><span class="s1">ranges</span><span class="s4">}</span>
            <span class="s0"># else:</span>
            <span class="s0">#   fallthrough; Format 1 is more compact</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">format</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">glyphName </span><span class="s3">in </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;glyphs&quot;</span><span class="s4">, []):</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Glyph&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">glyphName</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">glyphs </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;glyphs&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">glyphs </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">glyphs </span><span class="s4">= []</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">glyphs</span>
        <span class="s1">glyphs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>


<span class="s0"># The special 0xFFFFFFFF delta-set index is used to indicate that there</span>
<span class="s0"># is no variation data in the ItemVariationStore for a given variable field</span>
<span class="s1">NO_VARIATION_INDEX </span><span class="s4">= </span><span class="s5">0xFFFFFFFF</span>


<span class="s3">class </span><span class="s1">DeltaSetIndexMap</span><span class="s4">(</span><span class="s1">getFormatSwitchingBaseTableClass</span><span class="s4">(</span><span class="s6">&quot;uint8&quot;</span><span class="s4">)):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= []</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;EntryFormat&quot;</span><span class="s4">] &amp; </span><span class="s5">0xFFC0</span><span class="s4">) == </span><span class="s5">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;mapping&quot;</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">getEntryFormat</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">):</span>
        <span class="s1">ored </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s3">for </span><span class="s1">idx </span><span class="s3">in </span><span class="s1">mapping</span><span class="s4">:</span>
            <span class="s1">ored </span><span class="s4">|= </span><span class="s1">idx</span>

        <span class="s1">inner </span><span class="s4">= </span><span class="s1">ored </span><span class="s4">&amp; </span><span class="s5">0xFFFF</span>
        <span class="s1">innerBits </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s3">while </span><span class="s1">inner</span><span class="s4">:</span>
            <span class="s1">innerBits </span><span class="s4">+= </span><span class="s5">1</span>
            <span class="s1">inner </span><span class="s4">&gt;&gt;= </span><span class="s5">1</span>
        <span class="s1">innerBits </span><span class="s4">= </span><span class="s1">max</span><span class="s4">(</span><span class="s1">innerBits</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">innerBits </span><span class="s4">&lt;= </span><span class="s5">16</span>

        <span class="s1">ored </span><span class="s4">= (</span><span class="s1">ored </span><span class="s4">&gt;&gt; (</span><span class="s5">16 </span><span class="s4">- </span><span class="s1">innerBits</span><span class="s4">)) | (</span><span class="s1">ored </span><span class="s4">&amp; ((</span><span class="s5">1 </span><span class="s4">&lt;&lt; </span><span class="s1">innerBits</span><span class="s4">) - </span><span class="s5">1</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">ored </span><span class="s4">&lt;= </span><span class="s5">0x000000FF</span><span class="s4">:</span>
            <span class="s1">entrySize </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s3">elif </span><span class="s1">ored </span><span class="s4">&lt;= </span><span class="s5">0x0000FFFF</span><span class="s4">:</span>
            <span class="s1">entrySize </span><span class="s4">= </span><span class="s5">2</span>
        <span class="s3">elif </span><span class="s1">ored </span><span class="s4">&lt;= </span><span class="s5">0x00FFFFFF</span><span class="s4">:</span>
            <span class="s1">entrySize </span><span class="s4">= </span><span class="s5">3</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">entrySize </span><span class="s4">= </span><span class="s5">4</span>

        <span class="s3">return </span><span class="s4">((</span><span class="s1">entrySize </span><span class="s4">- </span><span class="s5">1</span><span class="s4">) &lt;&lt; </span><span class="s5">4</span><span class="s4">) | (</span><span class="s1">innerBits </span><span class="s4">- </span><span class="s5">1</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= []</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s5">1 </span><span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">) &gt; </span><span class="s5">0xFFFF </span><span class="s3">else </span><span class="s5">0</span>
        <span class="s1">rawTable </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
        <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;MappingCount&quot;</span><span class="s4">] = </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">)</span>
        <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;EntryFormat&quot;</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">getEntryFormat</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s0"># Make xml dump less verbose, by omitting no-op entries like:</span>
        <span class="s0">#   &lt;Map index=&quot;...&quot; outer=&quot;65535&quot; inner=&quot;65535&quot;/&gt;</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">comment</span><span class="s4">(</span><span class="s6">&quot;Omitted values default to 0xFFFF/0xFFFF (no variations)&quot;</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, [])):</span>
            <span class="s1">attrs </span><span class="s4">= [(</span><span class="s6">&quot;index&quot;</span><span class="s4">, </span><span class="s1">i</span><span class="s4">)]</span>
            <span class="s3">if </span><span class="s1">value </span><span class="s4">!= </span><span class="s1">NO_VARIATION_INDEX</span><span class="s4">:</span>
                <span class="s1">attrs</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">(</span>
                    <span class="s4">[</span>
                        <span class="s4">(</span><span class="s6">&quot;outer&quot;</span><span class="s4">, </span><span class="s1">value </span><span class="s4">&gt;&gt; </span><span class="s5">16</span><span class="s4">),</span>
                        <span class="s4">(</span><span class="s6">&quot;inner&quot;</span><span class="s4">, </span><span class="s1">value </span><span class="s4">&amp; </span><span class="s5">0xFFFF</span><span class="s4">),</span>
                    <span class="s4">]</span>
                <span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Map&quot;</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">mapping </span><span class="s4">= []</span>
        <span class="s1">index </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;index&quot;</span><span class="s4">])</span>
        <span class="s1">outer </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;outer&quot;</span><span class="s4">, </span><span class="s6">&quot;0xFFFF&quot;</span><span class="s4">))</span>
        <span class="s1">inner </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;inner&quot;</span><span class="s4">, </span><span class="s6">&quot;0xFFFF&quot;</span><span class="s4">))</span>
        <span class="s3">assert </span><span class="s1">inner </span><span class="s4">&lt;= </span><span class="s5">0xFFFF</span>
        <span class="s1">mapping</span><span class="s4">.</span><span class="s1">insert</span><span class="s4">(</span><span class="s1">index</span><span class="s4">, (</span><span class="s1">outer </span><span class="s4">&lt;&lt; </span><span class="s5">16</span><span class="s4">) | </span><span class="s1">inner</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">i</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] </span><span class="s3">if </span><span class="s1">i </span><span class="s4">&lt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">) </span><span class="s3">else </span><span class="s1">NO_VARIATION_INDEX</span>


<span class="s3">class </span><span class="s1">VarIdxMap</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">assert </span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;EntryFormat&quot;</span><span class="s4">] &amp; </span><span class="s5">0xFFC0</span><span class="s4">) == </span><span class="s5">0</span>
        <span class="s1">glyphOrder </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphOrder</span><span class="s4">()</span>
        <span class="s1">mapList </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;mapping&quot;</span><span class="s4">]</span>
        <span class="s1">mapList</span><span class="s4">.</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">mapList</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]] * (</span><span class="s1">len</span><span class="s4">(</span><span class="s1">glyphOrder</span><span class="s4">) - </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mapList</span><span class="s4">)))</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">glyphOrder</span><span class="s4">, </span><span class="s1">mapList</span><span class="s4">))</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>

        <span class="s1">glyphOrder </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphOrder</span><span class="s4">()</span>
        <span class="s1">mapping </span><span class="s4">= [</span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">g</span><span class="s4">] </span><span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">glyphOrder</span><span class="s4">]</span>
        <span class="s3">while </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">) &gt; </span><span class="s5">1 </span><span class="s3">and </span><span class="s1">mapping</span><span class="s4">[-</span><span class="s5">2</span><span class="s4">] == </span><span class="s1">mapping</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]:</span>
            <span class="s3">del </span><span class="s1">mapping</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]</span>

        <span class="s1">rawTable </span><span class="s4">= {</span><span class="s6">&quot;mapping&quot;</span><span class="s4">: </span><span class="s1">mapping</span><span class="s4">}</span>
        <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;MappingCount&quot;</span><span class="s4">] = </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">)</span>
        <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;EntryFormat&quot;</span><span class="s4">] = </span><span class="s1">DeltaSetIndexMap</span><span class="s4">.</span><span class="s1">getEntryFormat</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">glyph</span><span class="s4">, </span><span class="s1">value </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, {}).</span><span class="s1">items</span><span class="s4">()):</span>
            <span class="s1">attrs </span><span class="s4">= (</span>
                <span class="s4">(</span><span class="s6">&quot;glyph&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">),</span>
                <span class="s4">(</span><span class="s6">&quot;outer&quot;</span><span class="s4">, </span><span class="s1">value </span><span class="s4">&gt;&gt; </span><span class="s5">16</span><span class="s4">),</span>
                <span class="s4">(</span><span class="s6">&quot;inner&quot;</span><span class="s4">, </span><span class="s1">value </span><span class="s4">&amp; </span><span class="s5">0xFFFF</span><span class="s4">),</span>
            <span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Map&quot;</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= {}</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">mapping</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">glyph </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">]</span>
        <span class="s3">except</span><span class="s4">:  </span><span class="s0"># https://github.com/fonttools/fonttools/commit/21cbab8ce9ded3356fef3745122da64dcaf314e9#commitcomment-27649836</span>
            <span class="s1">glyph </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphOrder</span><span class="s4">()[</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;index&quot;</span><span class="s4">]]</span>
        <span class="s1">outer </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;outer&quot;</span><span class="s4">])</span>
        <span class="s1">inner </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;inner&quot;</span><span class="s4">])</span>
        <span class="s3">assert </span><span class="s1">inner </span><span class="s4">&lt;= </span><span class="s5">0xFFFF</span>
        <span class="s1">mapping</span><span class="s4">[</span><span class="s1">glyph</span><span class="s4">] = (</span><span class="s1">outer </span><span class="s4">&lt;&lt; </span><span class="s5">16</span><span class="s4">) | </span><span class="s1">inner</span>

    <span class="s3">def </span><span class="s1">__getitem__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">glyphName</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">NO_VARIATION_INDEX</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">VarRegionList</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s0"># The OT spec says VarStore.VarRegionList.RegionAxisCount should always</span>
        <span class="s0"># be equal to the fvar.axisCount, and OTS &lt; v8.0.0 enforces this rule</span>
        <span class="s0"># even when the VarRegionList is empty. We can't treat RegionAxisCount</span>
        <span class="s0"># like a normal propagated count (== len(Region[i].VarRegionAxis)),</span>
        <span class="s0"># otherwise it would default to 0 if VarRegionList is empty.</span>
        <span class="s0"># Thus, we force it to always be equal to fvar.axisCount.</span>
        <span class="s0"># https://github.com/khaledhosny/ots/pull/192</span>
        <span class="s1">fvarTable </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;fvar&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">fvarTable</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">RegionAxisCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">fvarTable</span><span class="s4">.</span><span class="s1">axes</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s4">**</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">,</span>
            <span class="s6">&quot;RegionAxisCount&quot;</span><span class="s4">: </span><span class="s1">CountReference</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">, </span><span class="s6">&quot;RegionAxisCount&quot;</span><span class="s4">),</span>
        <span class="s4">}</span>


<span class="s3">class </span><span class="s1">SingleSubst</span><span class="s4">(</span><span class="s1">FormatSwitchingBaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= {}</span>
        <span class="s1">input </span><span class="s4">= </span><span class="s1">_getGlyphsFromCoverageTable</span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">])</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">delta </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;DeltaGlyphID&quot;</span><span class="s4">]</span>
            <span class="s1">inputGIDS </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphIDMany</span><span class="s4">(</span><span class="s1">input</span><span class="s4">)</span>
            <span class="s1">outGIDS </span><span class="s4">= [(</span><span class="s1">glyphID </span><span class="s4">+ </span><span class="s1">delta</span><span class="s4">) % </span><span class="s5">65536 </span><span class="s3">for </span><span class="s1">glyphID </span><span class="s3">in </span><span class="s1">inputGIDS</span><span class="s4">]</span>
            <span class="s1">outNames </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphNameMany</span><span class="s4">(</span><span class="s1">outGIDS</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">inp</span><span class="s4">, </span><span class="s1">out </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">input</span><span class="s4">, </span><span class="s1">outNames</span><span class="s4">):</span>
                <span class="s1">mapping</span><span class="s4">[</span><span class="s1">inp</span><span class="s4">] = </span><span class="s1">out</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">2</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s4">(</span>
                <span class="s1">len</span><span class="s4">(</span><span class="s1">input</span><span class="s4">) == </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;GlyphCount&quot;</span><span class="s4">]</span>
            <span class="s4">), </span><span class="s6">&quot;invalid SingleSubstFormat2 table&quot;</span>
            <span class="s1">subst </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Substitute&quot;</span><span class="s4">]</span>
            <span class="s3">for </span><span class="s1">inp</span><span class="s4">, </span><span class="s1">sub </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">input</span><span class="s4">, </span><span class="s1">subst</span><span class="s4">):</span>
                <span class="s1">mapping</span><span class="s4">[</span><span class="s1">inp</span><span class="s4">] = </span><span class="s1">sub</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s5">0</span><span class="s4">, </span><span class="s6">&quot;unknown format: %s&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">mapping</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format  </span><span class="s0"># Don't need this anymore</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s1">getGlyphID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span>
        <span class="s1">gidItems </span><span class="s4">= [(</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">a</span><span class="s4">), </span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">b</span><span class="s4">)) </span><span class="s3">for </span><span class="s1">a</span><span class="s4">, </span><span class="s1">b </span><span class="s3">in </span><span class="s1">items</span><span class="s4">]</span>
        <span class="s1">sortableItems </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">gidItems</span><span class="s4">, </span><span class="s1">items</span><span class="s4">))</span>

        <span class="s0"># figure out format</span>
        <span class="s1">format </span><span class="s4">= </span><span class="s5">2</span>
        <span class="s1">delta </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">for </span><span class="s1">inID</span><span class="s4">, </span><span class="s1">outID </span><span class="s3">in </span><span class="s1">gidItems</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">delta </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s1">delta </span><span class="s4">= (</span><span class="s1">outID </span><span class="s4">- </span><span class="s1">inID</span><span class="s4">) % </span><span class="s5">65536</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s1">inID </span><span class="s4">+ </span><span class="s1">delta</span><span class="s4">) % </span><span class="s5">65536 </span><span class="s4">!= </span><span class="s1">outID</span><span class="s4">:</span>
                <span class="s3">break</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">delta </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s0"># the mapping is empty, better use format 2</span>
                <span class="s1">format </span><span class="s4">= </span><span class="s5">2</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">format </span><span class="s4">= </span><span class="s5">1</span>

        <span class="s1">rawTable </span><span class="s4">= {}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">format</span>
        <span class="s1">cov </span><span class="s4">= </span><span class="s1">Coverage</span><span class="s4">()</span>
        <span class="s1">input </span><span class="s4">= [</span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">][</span><span class="s5">0</span><span class="s4">] </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">sortableItems</span><span class="s4">]</span>
        <span class="s1">subst </span><span class="s4">= [</span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">][</span><span class="s5">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">sortableItems</span><span class="s4">]</span>
        <span class="s1">cov</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">input</span>
        <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">] = </span><span class="s1">cov</span>
        <span class="s3">if </span><span class="s1">format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">delta </span><span class="s3">is not None</span>
            <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;DeltaGlyphID&quot;</span><span class="s4">] = </span><span class="s1">delta</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Substitute&quot;</span><span class="s4">] = </span><span class="s1">subst</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">inGlyph</span><span class="s4">, </span><span class="s1">outGlyph </span><span class="s3">in </span><span class="s1">items</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Substitution&quot;</span><span class="s4">, [(</span><span class="s6">&quot;in&quot;</span><span class="s4">, </span><span class="s1">inGlyph</span><span class="s4">), (</span><span class="s6">&quot;out&quot;</span><span class="s4">, </span><span class="s1">outGlyph</span><span class="s4">)])</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= {}</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">mapping</span>
        <span class="s1">mapping</span><span class="s4">[</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;in&quot;</span><span class="s4">]] = </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;out&quot;</span><span class="s4">]</span>


<span class="s3">class </span><span class="s1">MultipleSubst</span><span class="s4">(</span><span class="s1">FormatSwitchingBaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= {}</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">glyphs </span><span class="s4">= </span><span class="s1">_getGlyphsFromCoverageTable</span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">])</span>
            <span class="s1">subst </span><span class="s4">= [</span><span class="s1">s</span><span class="s4">.</span><span class="s1">Substitute </span><span class="s3">for </span><span class="s1">s </span><span class="s3">in </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Sequence&quot;</span><span class="s4">]]</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">(</span><span class="s1">zip</span><span class="s4">(</span><span class="s1">glyphs</span><span class="s4">, </span><span class="s1">subst</span><span class="s4">))</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s5">0</span><span class="s4">, </span><span class="s6">&quot;unknown format: %s&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">mapping</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format  </span><span class="s0"># Don't need this anymore</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>
        <span class="s1">cov </span><span class="s4">= </span><span class="s1">Coverage</span><span class="s4">()</span>
        <span class="s1">cov</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">list</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">()), </span><span class="s1">key</span><span class="s4">=</span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s1">rawTable </span><span class="s4">= {</span>
            <span class="s6">&quot;Coverage&quot;</span><span class="s4">: </span><span class="s1">cov</span><span class="s4">,</span>
            <span class="s6">&quot;Sequence&quot;</span><span class="s4">: [</span><span class="s1">self</span><span class="s4">.</span><span class="s1">makeSequence_</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">glyph</span><span class="s4">]) </span><span class="s3">for </span><span class="s1">glyph </span><span class="s3">in </span><span class="s1">cov</span><span class="s4">.</span><span class="s1">glyphs</span><span class="s4">],</span>
        <span class="s4">}</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">inGlyph</span><span class="s4">, </span><span class="s1">outGlyphs </span><span class="s3">in </span><span class="s1">items</span><span class="s4">:</span>
            <span class="s1">out </span><span class="s4">= </span><span class="s6">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">outGlyphs</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Substitution&quot;</span><span class="s4">, [(</span><span class="s6">&quot;in&quot;</span><span class="s4">, </span><span class="s1">inGlyph</span><span class="s4">), (</span><span class="s6">&quot;out&quot;</span><span class="s4">, </span><span class="s1">out</span><span class="s4">)])</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">mapping </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;mapping&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">mapping </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">mapping </span><span class="s4">= {}</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= </span><span class="s1">mapping</span>

        <span class="s0"># TTX v3.0 and earlier.</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;Coverage&quot;</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">old_coverage_ </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">element </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
                <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">element</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                    <span class="s3">continue</span>
                <span class="s1">element_name</span><span class="s4">, </span><span class="s1">element_attrs</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">element</span>
                <span class="s3">if </span><span class="s1">element_name </span><span class="s4">== </span><span class="s6">&quot;Glyph&quot;</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">old_coverage_</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">element_attrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">return</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;Sequence&quot;</span><span class="s4">:</span>
            <span class="s1">index </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s6">&quot;index&quot;</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">mapping</span><span class="s4">)))</span>
            <span class="s1">glyph </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">old_coverage_</span><span class="s4">[</span><span class="s1">index</span><span class="s4">]</span>
            <span class="s1">glyph_mapping </span><span class="s4">= </span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">glyph</span><span class="s4">] = []</span>
            <span class="s3">for </span><span class="s1">element </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
                <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">element</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                    <span class="s3">continue</span>
                <span class="s1">element_name</span><span class="s4">, </span><span class="s1">element_attrs</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">element</span>
                <span class="s3">if </span><span class="s1">element_name </span><span class="s4">== </span><span class="s6">&quot;Substitute&quot;</span><span class="s4">:</span>
                    <span class="s1">glyph_mapping</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">element_attrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">return</span>

            <span class="s0"># TTX v3.1 and later.</span>
        <span class="s1">outGlyphs </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;out&quot;</span><span class="s4">].</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">) </span><span class="s3">if </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;out&quot;</span><span class="s4">] </span><span class="s3">else </span><span class="s4">[]</span>
        <span class="s1">mapping</span><span class="s4">[</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;in&quot;</span><span class="s4">]] = [</span><span class="s1">g</span><span class="s4">.</span><span class="s1">strip</span><span class="s4">() </span><span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">outGlyphs</span><span class="s4">]</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">makeSequence_</span><span class="s4">(</span><span class="s1">g</span><span class="s4">):</span>
        <span class="s1">seq </span><span class="s4">= </span><span class="s1">Sequence</span><span class="s4">()</span>
        <span class="s1">seq</span><span class="s4">.</span><span class="s1">Substitute </span><span class="s4">= </span><span class="s1">g</span>
        <span class="s3">return </span><span class="s1">seq</span>


<span class="s3">class </span><span class="s1">ClassDef</span><span class="s4">(</span><span class="s1">FormatSwitchingBaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;classDefs&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">classDefs </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">classDefs </span><span class="s4">= {}</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">start </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;StartGlyph&quot;</span><span class="s4">]</span>
            <span class="s1">classList </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;ClassValueArray&quot;</span><span class="s4">]</span>
            <span class="s1">startID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">start</span><span class="s4">)</span>
            <span class="s1">endID </span><span class="s4">= </span><span class="s1">startID </span><span class="s4">+ </span><span class="s1">len</span><span class="s4">(</span><span class="s1">classList</span><span class="s4">)</span>
            <span class="s1">glyphNames </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphNameMany</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">startID</span><span class="s4">, </span><span class="s1">endID</span><span class="s4">))</span>
            <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">glyphNames</span><span class="s4">, </span><span class="s1">classList</span><span class="s4">):</span>
                <span class="s3">if </span><span class="s1">cls</span><span class="s4">:</span>
                    <span class="s1">classDefs</span><span class="s4">[</span><span class="s1">glyphName</span><span class="s4">] = </span><span class="s1">cls</span>

        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">2</span><span class="s4">:</span>
            <span class="s1">records </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;ClassRangeRecord&quot;</span><span class="s4">]</span>
            <span class="s3">for </span><span class="s1">rec </span><span class="s3">in </span><span class="s1">records</span><span class="s4">:</span>
                <span class="s1">cls </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">Class</span>
                <span class="s3">if not </span><span class="s1">cls</span><span class="s4">:</span>
                    <span class="s3">continue</span>
                <span class="s1">start </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">Start</span>
                <span class="s1">end </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">End</span>
                <span class="s1">startID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">start</span><span class="s4">)</span>
                <span class="s1">endID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">end</span><span class="s4">) + </span><span class="s5">1</span>
                <span class="s1">glyphNames </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphNameMany</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">startID</span><span class="s4">, </span><span class="s1">endID</span><span class="s4">))</span>
                <span class="s3">for </span><span class="s1">glyphName </span><span class="s3">in </span><span class="s1">glyphNames</span><span class="s4">:</span>
                    <span class="s1">classDefs</span><span class="s4">[</span><span class="s1">glyphName</span><span class="s4">] = </span><span class="s1">cls</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span><span class="s6">&quot;Unknown ClassDef format: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">classDefs </span><span class="s4">= </span><span class="s1">classDefs</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format  </span><span class="s0"># Don't need this anymore</span>

    <span class="s3">def </span><span class="s1">_getClassRanges</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">classDefs </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;classDefs&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">classDefs </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">classDefs </span><span class="s4">= {}</span>
            <span class="s3">return</span>
        <span class="s1">getGlyphID </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span>
        <span class="s1">items </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">classDefs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s3">if not </span><span class="s1">cls</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s1">items</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">), </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">cls</span><span class="s4">))</span>
        <span class="s3">if </span><span class="s1">items</span><span class="s4">:</span>
            <span class="s1">items</span><span class="s4">.</span><span class="s1">sort</span><span class="s4">()</span>
            <span class="s1">last</span><span class="s4">, </span><span class="s1">lastName</span><span class="s4">, </span><span class="s1">lastCls </span><span class="s4">= </span><span class="s1">items</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
            <span class="s1">ranges </span><span class="s4">= [[</span><span class="s1">lastCls</span><span class="s4">, </span><span class="s1">last</span><span class="s4">, </span><span class="s1">lastName</span><span class="s4">]]</span>
            <span class="s3">for </span><span class="s1">glyphID</span><span class="s4">, </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">items</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]:</span>
                <span class="s3">if </span><span class="s1">glyphID </span><span class="s4">!= </span><span class="s1">last </span><span class="s4">+ </span><span class="s5">1 </span><span class="s3">or </span><span class="s1">cls </span><span class="s4">!= </span><span class="s1">lastCls</span><span class="s4">:</span>
                    <span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">last</span><span class="s4">, </span><span class="s1">lastName</span><span class="s4">])</span>
                    <span class="s1">ranges</span><span class="s4">.</span><span class="s1">append</span><span class="s4">([</span><span class="s1">cls</span><span class="s4">, </span><span class="s1">glyphID</span><span class="s4">, </span><span class="s1">glyphName</span><span class="s4">])</span>
                <span class="s1">last </span><span class="s4">= </span><span class="s1">glyphID</span>
                <span class="s1">lastName </span><span class="s4">= </span><span class="s1">glyphName</span>
                <span class="s1">lastCls </span><span class="s4">= </span><span class="s1">cls</span>
            <span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">extend</span><span class="s4">([</span><span class="s1">last</span><span class="s4">, </span><span class="s1">lastName</span><span class="s4">])</span>
            <span class="s3">return </span><span class="s1">ranges</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">format </span><span class="s4">= </span><span class="s5">2</span>
        <span class="s1">rawTable </span><span class="s4">= {</span><span class="s6">&quot;ClassRangeRecord&quot;</span><span class="s4">: []}</span>
        <span class="s1">ranges </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_getClassRanges</span><span class="s4">(</span><span class="s1">font</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">ranges</span><span class="s4">:</span>
            <span class="s1">startGlyph </span><span class="s4">= </span><span class="s1">ranges</span><span class="s4">[</span><span class="s5">0</span><span class="s4">][</span><span class="s5">1</span><span class="s4">]</span>
            <span class="s1">endGlyph </span><span class="s4">= </span><span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">][</span><span class="s5">3</span><span class="s4">]</span>
            <span class="s1">glyphCount </span><span class="s4">= </span><span class="s1">endGlyph </span><span class="s4">- </span><span class="s1">startGlyph </span><span class="s4">+ </span><span class="s5">1</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">ranges</span><span class="s4">) * </span><span class="s5">3 </span><span class="s4">&lt; </span><span class="s1">glyphCount </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">:</span>
                <span class="s0"># Format 2 is more compact</span>
                <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">ranges</span><span class="s4">)):</span>
                    <span class="s1">cls</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">startName</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">endName </span><span class="s4">= </span><span class="s1">ranges</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
                    <span class="s1">rec </span><span class="s4">= </span><span class="s1">ClassRangeRecord</span><span class="s4">()</span>
                    <span class="s1">rec</span><span class="s4">.</span><span class="s1">Start </span><span class="s4">= </span><span class="s1">startName</span>
                    <span class="s1">rec</span><span class="s4">.</span><span class="s1">End </span><span class="s4">= </span><span class="s1">endName</span>
                    <span class="s1">rec</span><span class="s4">.</span><span class="s1">Class </span><span class="s4">= </span><span class="s1">cls</span>
                    <span class="s1">ranges</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">rec</span>
                <span class="s1">format </span><span class="s4">= </span><span class="s5">2</span>
                <span class="s1">rawTable </span><span class="s4">= {</span><span class="s6">&quot;ClassRangeRecord&quot;</span><span class="s4">: </span><span class="s1">ranges</span><span class="s4">}</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s0"># Format 1 is more compact</span>
                <span class="s1">startGlyphName </span><span class="s4">= </span><span class="s1">ranges</span><span class="s4">[</span><span class="s5">0</span><span class="s4">][</span><span class="s5">2</span><span class="s4">]</span>
                <span class="s1">classes </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">] * </span><span class="s1">glyphCount</span>
                <span class="s3">for </span><span class="s1">cls</span><span class="s4">, </span><span class="s1">start</span><span class="s4">, </span><span class="s1">startName</span><span class="s4">, </span><span class="s1">end</span><span class="s4">, </span><span class="s1">endName </span><span class="s3">in </span><span class="s1">ranges</span><span class="s4">:</span>
                    <span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">start </span><span class="s4">- </span><span class="s1">startGlyph</span><span class="s4">, </span><span class="s1">end </span><span class="s4">- </span><span class="s1">startGlyph </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">):</span>
                        <span class="s1">classes</span><span class="s4">[</span><span class="s1">g</span><span class="s4">] = </span><span class="s1">cls</span>
                <span class="s1">format </span><span class="s4">= </span><span class="s5">1</span>
                <span class="s1">rawTable </span><span class="s4">= {</span><span class="s6">&quot;StartGlyph&quot;</span><span class="s4">: </span><span class="s1">startGlyphName</span><span class="s4">, </span><span class="s6">&quot;ClassValueArray&quot;</span><span class="s4">: </span><span class="s1">classes</span><span class="s4">}</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">format</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">classDefs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">items</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;ClassDef&quot;</span><span class="s4">, [(</span><span class="s6">&quot;glyph&quot;</span><span class="s4">, </span><span class="s1">glyphName</span><span class="s4">), (</span><span class="s6">&quot;class&quot;</span><span class="s4">, </span><span class="s1">cls</span><span class="s4">)])</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">classDefs </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;classDefs&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">classDefs </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">classDefs </span><span class="s4">= {}</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">classDefs </span><span class="s4">= </span><span class="s1">classDefs</span>
        <span class="s1">classDefs</span><span class="s4">[</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">]] = </span><span class="s1">int</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;class&quot;</span><span class="s4">])</span>


<span class="s3">class </span><span class="s1">AlternateSubst</span><span class="s4">(</span><span class="s1">FormatSwitchingBaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;alternates&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">alternates </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">alternates </span><span class="s4">= {}</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">input </span><span class="s4">= </span><span class="s1">_getGlyphsFromCoverageTable</span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">])</span>
            <span class="s1">alts </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;AlternateSet&quot;</span><span class="s4">]</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">input</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">alts</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">inp</span><span class="s4">, </span><span class="s1">alt </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">input</span><span class="s4">, </span><span class="s1">alts</span><span class="s4">):</span>
                <span class="s1">alternates</span><span class="s4">[</span><span class="s1">inp</span><span class="s4">] = </span><span class="s1">alt</span><span class="s4">.</span><span class="s1">Alternate</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s5">0</span><span class="s4">, </span><span class="s6">&quot;unknown format: %s&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">alternates </span><span class="s4">= </span><span class="s1">alternates</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format  </span><span class="s0"># Don't need this anymore</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s1">alternates </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;alternates&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">alternates </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">alternates </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">alternates </span><span class="s4">= {}</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">alternates</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">items</span><span class="s4">)):</span>
            <span class="s1">glyphName</span><span class="s4">, </span><span class="s1">set </span><span class="s4">= </span><span class="s1">items</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
            <span class="s1">items</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">), </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">set</span>
        <span class="s1">items</span><span class="s4">.</span><span class="s1">sort</span><span class="s4">()</span>
        <span class="s1">cov </span><span class="s4">= </span><span class="s1">Coverage</span><span class="s4">()</span>
        <span class="s1">cov</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= [</span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">items</span><span class="s4">]</span>
        <span class="s1">alternates </span><span class="s4">= []</span>
        <span class="s1">setList </span><span class="s4">= [</span><span class="s1">item</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">items</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">set </span><span class="s3">in </span><span class="s1">setList</span><span class="s4">:</span>
            <span class="s1">alts </span><span class="s4">= </span><span class="s1">AlternateSet</span><span class="s4">()</span>
            <span class="s1">alts</span><span class="s4">.</span><span class="s1">Alternate </span><span class="s4">= </span><span class="s1">set</span>
            <span class="s1">alternates</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">alts</span><span class="s4">)</span>
        <span class="s0"># a special case to deal with the fact that several hundred Adobe Japan1-5</span>
        <span class="s0"># CJK fonts will overflow an offset if the coverage table isn't pushed to the end.</span>
        <span class="s0"># Also useful in that when splitting a sub-table because of an offset overflow</span>
        <span class="s0"># I don't need to calculate the change in the subtable offset due to the change in the coverage table size.</span>
        <span class="s0"># Allows packing more rules in subtable.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sortCoverageLast </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s3">return </span><span class="s4">{</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">: </span><span class="s1">cov</span><span class="s4">, </span><span class="s6">&quot;AlternateSet&quot;</span><span class="s4">: </span><span class="s1">alternates</span><span class="s4">}</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">alternates</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">alternates </span><span class="s3">in </span><span class="s1">items</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s6">&quot;AlternateSet&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">=</span><span class="s1">glyphName</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">alt </span><span class="s3">in </span><span class="s1">alternates</span><span class="s4">:</span>
                <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Alternate&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">=</span><span class="s1">alt</span><span class="s4">)</span>
                <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s6">&quot;AlternateSet&quot;</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">alternates </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;alternates&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">alternates </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">alternates </span><span class="s4">= {}</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">alternates </span><span class="s4">= </span><span class="s1">alternates</span>
        <span class="s1">glyphName </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">]</span>
        <span class="s1">set </span><span class="s4">= []</span>
        <span class="s1">alternates</span><span class="s4">[</span><span class="s1">glyphName</span><span class="s4">] = </span><span class="s1">set</span>
        <span class="s3">for </span><span class="s1">element </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">element</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content </span><span class="s4">= </span><span class="s1">element</span>
            <span class="s1">set</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">])</span>


<span class="s3">class </span><span class="s1">LigatureSubst</span><span class="s4">(</span><span class="s1">FormatSwitchingBaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;ligatures&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ligatures </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">ligatures </span><span class="s4">= {}</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
            <span class="s1">input </span><span class="s4">= </span><span class="s1">_getGlyphsFromCoverageTable</span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">])</span>
            <span class="s1">ligSets </span><span class="s4">= </span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;LigatureSet&quot;</span><span class="s4">]</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">input</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">ligSets</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">input</span><span class="s4">)):</span>
                <span class="s1">ligatures</span><span class="s4">[</span><span class="s1">input</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]] = </span><span class="s1">ligSets</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">Ligature</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s5">0</span><span class="s4">, </span><span class="s6">&quot;unknown format: %s&quot; </span><span class="s4">% </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">ligatures </span><span class="s4">= </span><span class="s1">ligatures</span>
        <span class="s3">del </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format  </span><span class="s0"># Don't need this anymore</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_getLigatureSortKey</span><span class="s4">(</span><span class="s1">components</span><span class="s4">):</span>
        <span class="s0"># Computes a key for ordering ligatures in a GSUB Type-4 lookup.</span>

        <span class="s0"># When building the OpenType lookup, we need to make sure that</span>
        <span class="s0"># the longest sequence of components is listed first, so we</span>
        <span class="s0"># use the negative length as the key for sorting.</span>
        <span class="s0"># Note, we no longer need to worry about deterministic order because the</span>
        <span class="s0"># ligature mapping `dict` remembers the insertion order, and this in</span>
        <span class="s0"># turn depends on the order in which the ligatures are written in the FEA.</span>
        <span class="s0"># Since python sort algorithm is stable, the ligatures of equal length</span>
        <span class="s0"># will keep the relative order in which they appear in the feature file.</span>
        <span class="s0"># For example, given the following ligatures (all starting with 'f' and</span>
        <span class="s0"># thus belonging to the same LigatureSet):</span>
        <span class="s0">#</span>
        <span class="s0">#   feature liga {</span>
        <span class="s0">#     sub f i by f_i;</span>
        <span class="s0">#     sub f f f by f_f_f;</span>
        <span class="s0">#     sub f f by f_f;</span>
        <span class="s0">#     sub f f i by f_f_i;</span>
        <span class="s0">#   } liga;</span>
        <span class="s0">#</span>
        <span class="s0"># this should sort to: f_f_f, f_f_i, f_i, f_f</span>
        <span class="s0"># This is also what fea-rs does, see:</span>
        <span class="s0"># https://github.com/adobe-type-tools/afdko/issues/1727</span>
        <span class="s0"># https://github.com/fonttools/fonttools/issues/3428</span>
        <span class="s0"># https://github.com/googlefonts/fontc/pull/680</span>
        <span class="s3">return </span><span class="s4">-</span><span class="s1">len</span><span class="s4">(</span><span class="s1">components</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s1">ligatures </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;ligatures&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">ligatures </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">ligatures </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ligatures </span><span class="s4">= {}</span>

        <span class="s3">if </span><span class="s1">ligatures </span><span class="s3">and </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">next</span><span class="s4">(</span><span class="s1">iter</span><span class="s4">(</span><span class="s1">ligatures</span><span class="s4">)), </span><span class="s1">tuple</span><span class="s4">):</span>
            <span class="s0"># New high-level API in v3.1 and later.  Note that we just support compiling this</span>
            <span class="s0"># for now.  We don't load to this API, and don't do XML with it.</span>

            <span class="s0"># ligatures is map from components-sequence to lig-glyph</span>
            <span class="s1">newLigatures </span><span class="s4">= </span><span class="s1">dict</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">comps </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">ligatures</span><span class="s4">.</span><span class="s1">keys</span><span class="s4">(), </span><span class="s1">key</span><span class="s4">=</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_getLigatureSortKey</span><span class="s4">):</span>
                <span class="s1">ligature </span><span class="s4">= </span><span class="s1">Ligature</span><span class="s4">()</span>
                <span class="s1">ligature</span><span class="s4">.</span><span class="s1">Component </span><span class="s4">= </span><span class="s1">comps</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]</span>
                <span class="s1">ligature</span><span class="s4">.</span><span class="s1">CompCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">comps</span><span class="s4">)</span>
                <span class="s1">ligature</span><span class="s4">.</span><span class="s1">LigGlyph </span><span class="s4">= </span><span class="s1">ligatures</span><span class="s4">[</span><span class="s1">comps</span><span class="s4">]</span>
                <span class="s1">newLigatures</span><span class="s4">.</span><span class="s1">setdefault</span><span class="s4">(</span><span class="s1">comps</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], []).</span><span class="s1">append</span><span class="s4">(</span><span class="s1">ligature</span><span class="s4">)</span>
            <span class="s1">ligatures </span><span class="s4">= </span><span class="s1">newLigatures</span>

        <span class="s1">items </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">ligatures</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">items</span><span class="s4">)):</span>
            <span class="s1">glyphName</span><span class="s4">, </span><span class="s1">set </span><span class="s4">= </span><span class="s1">items</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
            <span class="s1">items</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">), </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">set</span>
        <span class="s1">items</span><span class="s4">.</span><span class="s1">sort</span><span class="s4">()</span>
        <span class="s1">cov </span><span class="s4">= </span><span class="s1">Coverage</span><span class="s4">()</span>
        <span class="s1">cov</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= [</span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">items</span><span class="s4">]</span>

        <span class="s1">ligSets </span><span class="s4">= []</span>
        <span class="s1">setList </span><span class="s4">= [</span><span class="s1">item</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">] </span><span class="s3">for </span><span class="s1">item </span><span class="s3">in </span><span class="s1">items</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">set </span><span class="s3">in </span><span class="s1">setList</span><span class="s4">:</span>
            <span class="s1">ligSet </span><span class="s4">= </span><span class="s1">LigatureSet</span><span class="s4">()</span>
            <span class="s1">ligs </span><span class="s4">= </span><span class="s1">ligSet</span><span class="s4">.</span><span class="s1">Ligature </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">lig </span><span class="s3">in </span><span class="s1">set</span><span class="s4">:</span>
                <span class="s1">ligs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">lig</span><span class="s4">)</span>
            <span class="s1">ligSets</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">ligSet</span><span class="s4">)</span>
        <span class="s0"># Useful in that when splitting a sub-table because of an offset overflow</span>
        <span class="s0"># I don't need to calculate the change in subtabl offset due to the coverage table size.</span>
        <span class="s0"># Allows packing more rules in subtable.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">sortCoverageLast </span><span class="s4">= </span><span class="s5">1</span>
        <span class="s3">return </span><span class="s4">{</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">: </span><span class="s1">cov</span><span class="s4">, </span><span class="s6">&quot;LigatureSet&quot;</span><span class="s4">: </span><span class="s1">ligSets</span><span class="s4">}</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">items </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ligatures</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
        <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">ligSets </span><span class="s3">in </span><span class="s1">items</span><span class="s4">:</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s6">&quot;LigatureSet&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">=</span><span class="s1">glyphName</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">lig </span><span class="s3">in </span><span class="s1">ligSets</span><span class="s4">:</span>
                <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span>
                    <span class="s6">&quot;Ligature&quot;</span><span class="s4">, </span><span class="s1">glyph</span><span class="s4">=</span><span class="s1">lig</span><span class="s4">.</span><span class="s1">LigGlyph</span><span class="s4">, </span><span class="s1">components</span><span class="s4">=</span><span class="s6">&quot;,&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s1">lig</span><span class="s4">.</span><span class="s1">Component</span><span class="s4">)</span>
                <span class="s4">)</span>
                <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s6">&quot;LigatureSet&quot;</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">ligatures </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;ligatures&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">ligatures </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">ligatures </span><span class="s4">= {}</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ligatures </span><span class="s4">= </span><span class="s1">ligatures</span>
        <span class="s1">glyphName </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">]</span>
        <span class="s1">ligs </span><span class="s4">= []</span>
        <span class="s1">ligatures</span><span class="s4">[</span><span class="s1">glyphName</span><span class="s4">] = </span><span class="s1">ligs</span>
        <span class="s3">for </span><span class="s1">element </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">element</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content </span><span class="s4">= </span><span class="s1">element</span>
            <span class="s1">lig </span><span class="s4">= </span><span class="s1">Ligature</span><span class="s4">()</span>
            <span class="s1">lig</span><span class="s4">.</span><span class="s1">LigGlyph </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;glyph&quot;</span><span class="s4">]</span>
            <span class="s1">components </span><span class="s4">= </span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;components&quot;</span><span class="s4">]</span>
            <span class="s1">lig</span><span class="s4">.</span><span class="s1">Component </span><span class="s4">= </span><span class="s1">components</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s6">&quot;,&quot;</span><span class="s4">) </span><span class="s3">if </span><span class="s1">components </span><span class="s3">else </span><span class="s4">[]</span>
            <span class="s1">lig</span><span class="s4">.</span><span class="s1">CompCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">lig</span><span class="s4">.</span><span class="s1">Component</span><span class="s4">)</span>
            <span class="s1">ligs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">lig</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">COLR</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s0"># COLRv0 is exceptional in that LayerRecordCount appears *after* the</span>
        <span class="s0"># LayerRecordArray it counts, but the parser logic expects Count fields</span>
        <span class="s0"># to always precede the arrays. Here we work around this by parsing the</span>
        <span class="s0"># LayerRecordCount before the rest of the table, and storing it in</span>
        <span class="s0"># the reader's local state.</span>
        <span class="s1">subReader </span><span class="s4">= </span><span class="s1">reader</span><span class="s4">.</span><span class="s1">getSubReader</span><span class="s4">(</span><span class="s1">offset</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">conv </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">getConverters</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name </span><span class="s4">!= </span><span class="s6">&quot;LayerRecordCount&quot;</span><span class="s4">:</span>
                <span class="s1">subReader</span><span class="s4">.</span><span class="s1">advance</span><span class="s4">(</span><span class="s1">conv</span><span class="s4">.</span><span class="s1">staticSize</span><span class="s4">)</span>
                <span class="s3">continue</span>
            <span class="s1">reader</span><span class="s4">[</span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">] = </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s1">subReader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">tableDict</span><span class="s4">={})</span>
            <span class="s3">break</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">AssertionError</span><span class="s4">(</span><span class="s6">&quot;LayerRecordCount converter not found&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">decompile</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">reader</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s0"># The writer similarly assumes Count values precede the things counted,</span>
        <span class="s0"># thus here we pre-initialize a CountReference; the actual count value</span>
        <span class="s0"># will be set to the lenght of the array by the time this is assembled.</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">LayerRecordCount </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s4">**</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">,</span>
            <span class="s6">&quot;LayerRecordCount&quot;</span><span class="s4">: </span><span class="s1">CountReference</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">, </span><span class="s6">&quot;LayerRecordCount&quot;</span><span class="s4">),</span>
        <span class="s4">}</span>

    <span class="s3">def </span><span class="s1">computeClipBoxes</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">glyphSet</span><span class="s4">: </span><span class="s6">&quot;_TTGlyphSet&quot;</span><span class="s4">, </span><span class="s1">quantization</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">1</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Version </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">return</span>

        <span class="s1">clips </span><span class="s4">= {}</span>
        <span class="s3">for </span><span class="s1">rec </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">BaseGlyphList</span><span class="s4">.</span><span class="s1">BaseGlyphPaintRecord</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">clipBox </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">Paint</span><span class="s4">.</span><span class="s1">computeClipBox</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">glyphSet</span><span class="s4">, </span><span class="s1">quantization</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">e</span><span class="s4">:</span>
                <span class="s3">from </span><span class="s1">fontTools</span><span class="s4">.</span><span class="s1">ttLib </span><span class="s3">import </span><span class="s1">TTLibError</span>

                <span class="s3">raise </span><span class="s1">TTLibError</span><span class="s4">(</span>
                    <span class="s6">f&quot;Failed to compute COLR ClipBox for </span><span class="s3">{</span><span class="s1">rec</span><span class="s4">.</span><span class="s1">BaseGlyph</span><span class="s3">!r}</span><span class="s6">&quot;</span>
                <span class="s4">) </span><span class="s3">from </span><span class="s1">e</span>

            <span class="s3">if </span><span class="s1">clipBox </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">clips</span><span class="s4">[</span><span class="s1">rec</span><span class="s4">.</span><span class="s1">BaseGlyph</span><span class="s4">] = </span><span class="s1">clipBox</span>

        <span class="s1">hasClipList </span><span class="s4">= </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;ClipList&quot;</span><span class="s4">) </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">ClipList </span><span class="s3">is not None</span>
        <span class="s3">if not </span><span class="s1">clips</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">hasClipList</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ClipList </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">hasClipList</span><span class="s4">:</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ClipList </span><span class="s4">= </span><span class="s1">ClipList</span><span class="s4">()</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">ClipList</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s5">1</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">ClipList</span><span class="s4">.</span><span class="s1">clips </span><span class="s4">= </span><span class="s1">clips</span>


<span class="s3">class </span><span class="s1">LookupList</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">table</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">for </span><span class="s1">l </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Lookup</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">st </span><span class="s3">in </span><span class="s1">l</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">type</span><span class="s4">(</span><span class="s1">st</span><span class="s4">).</span><span class="s1">__name__</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;Subst&quot;</span><span class="s4">):</span>
                    <span class="s3">return </span><span class="s6">&quot;GSUB&quot;</span>
                <span class="s3">if </span><span class="s1">type</span><span class="s4">(</span><span class="s1">st</span><span class="s4">).</span><span class="s1">__name__</span><span class="s4">.</span><span class="s1">endswith</span><span class="s4">(</span><span class="s6">&quot;Pos&quot;</span><span class="s4">):</span>
                    <span class="s3">return </span><span class="s6">&quot;GPOS&quot;</span>
        <span class="s3">raise </span><span class="s1">ValueError</span>

    <span class="s3">def </span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s4">(</span>
            <span class="s3">not </span><span class="s1">font</span>
            <span class="s3">or </span><span class="s6">&quot;Debg&quot; </span><span class="s3">not in </span><span class="s1">font</span>
            <span class="s3">or </span><span class="s1">LOOKUP_DEBUG_INFO_KEY </span><span class="s3">not in </span><span class="s1">font</span><span class="s4">[</span><span class="s6">&quot;Debg&quot;</span><span class="s4">].</span><span class="s1">data</span>
        <span class="s4">):</span>
            <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>
        <span class="s1">debugData </span><span class="s4">= </span><span class="s1">font</span><span class="s4">[</span><span class="s6">&quot;Debg&quot;</span><span class="s4">].</span><span class="s1">data</span><span class="s4">[</span><span class="s1">LOOKUP_DEBUG_INFO_KEY</span><span class="s4">][</span><span class="s1">self</span><span class="s4">.</span><span class="s1">table</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">conv </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">getConverters</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">repeat</span><span class="s4">:</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, [])</span>
                <span class="s3">for </span><span class="s1">lookupIndex</span><span class="s4">, </span><span class="s1">item </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">value</span><span class="s4">):</span>
                    <span class="s3">if </span><span class="s1">str</span><span class="s4">(</span><span class="s1">lookupIndex</span><span class="s4">) </span><span class="s3">in </span><span class="s1">debugData</span><span class="s4">:</span>
                        <span class="s1">info </span><span class="s4">= </span><span class="s1">LookupDebugInfo</span><span class="s4">(*</span><span class="s1">debugData</span><span class="s4">[</span><span class="s1">str</span><span class="s4">(</span><span class="s1">lookupIndex</span><span class="s4">)])</span>
                        <span class="s1">tag </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">location</span>
                        <span class="s3">if </span><span class="s1">info</span><span class="s4">.</span><span class="s1">name</span><span class="s4">:</span>
                            <span class="s1">tag </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">info</span><span class="s4">.</span><span class="s1">name</span><span class="s3">}</span><span class="s6">: </span><span class="s3">{</span><span class="s1">tag</span><span class="s3">}</span><span class="s6">&quot;</span>
                        <span class="s3">if </span><span class="s1">info</span><span class="s4">.</span><span class="s1">feature</span><span class="s4">:</span>
                            <span class="s1">script</span><span class="s4">, </span><span class="s1">language</span><span class="s4">, </span><span class="s1">feature </span><span class="s4">= </span><span class="s1">info</span><span class="s4">.</span><span class="s1">feature</span>
                            <span class="s1">tag </span><span class="s4">= </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">tag</span><span class="s3">} </span><span class="s6">in </span><span class="s3">{</span><span class="s1">feature</span><span class="s3">} </span><span class="s6">(</span><span class="s3">{</span><span class="s1">script</span><span class="s3">}</span><span class="s6">/</span><span class="s3">{</span><span class="s1">language</span><span class="s3">}</span><span class="s6">)&quot;</span>
                        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">comment</span><span class="s4">(</span><span class="s1">tag</span><span class="s4">)</span>
                        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

                    <span class="s1">conv</span><span class="s4">.</span><span class="s1">xmlWrite</span><span class="s4">(</span>
                        <span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">item</span><span class="s4">, </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, [(</span><span class="s6">&quot;index&quot;</span><span class="s4">, </span><span class="s1">lookupIndex</span><span class="s4">)]</span>
                    <span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">aux </span><span class="s3">and not </span><span class="s1">eval</span><span class="s4">(</span><span class="s1">conv</span><span class="s4">.</span><span class="s1">aux</span><span class="s4">, </span><span class="s3">None</span><span class="s4">, </span><span class="s1">vars</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)):</span>
                    <span class="s3">continue</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span>
                    <span class="s1">self</span><span class="s4">, </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s3">None</span>
                <span class="s4">)  </span><span class="s0"># TODO Handle defaults instead of defaulting to None!</span>
                <span class="s1">conv</span><span class="s4">.</span><span class="s1">xmlWrite</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, [])</span>


<span class="s3">class </span><span class="s1">BaseGlyphRecordArray</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">BaseGlyphRecord </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">BaseGlyphRecord</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">rec</span><span class="s4">: </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">rec</span><span class="s4">.</span><span class="s1">BaseGlyph</span><span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">BaseGlyphList</span><span class="s4">(</span><span class="s1">BaseTable</span><span class="s4">):</span>
    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">BaseGlyphPaintRecord </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">BaseGlyphPaintRecord</span><span class="s4">, </span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">rec</span><span class="s4">: </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphID</span><span class="s4">(</span><span class="s1">rec</span><span class="s4">.</span><span class="s1">BaseGlyph</span><span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__dict__</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>


<span class="s3">class </span><span class="s1">ClipBoxFormat</span><span class="s4">(</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s1">Static </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">Variable </span><span class="s4">= </span><span class="s5">2</span>

    <span class="s3">def </span><span class="s1">is_variable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self </span><span class="s3">is </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Variable</span>

    <span class="s3">def </span><span class="s1">as_variable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Variable</span>


<span class="s3">class </span><span class="s1">ClipBox</span><span class="s4">(</span><span class="s1">getFormatSwitchingBaseTableClass</span><span class="s4">(</span><span class="s6">&quot;uint8&quot;</span><span class="s4">)):</span>
    <span class="s1">formatEnum </span><span class="s4">= </span><span class="s1">ClipBoxFormat</span>

    <span class="s3">def </span><span class="s1">as_tuple</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">) </span><span class="s3">for </span><span class="s1">conv </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">getConverters</span><span class="s4">())</span>

    <span class="s3">def </span><span class="s1">__repr__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">as_tuple</span><span class="s4">()</span><span class="s3">}</span><span class="s6">&quot;</span>


<span class="s3">class </span><span class="s1">ClipList</span><span class="s4">(</span><span class="s1">getFormatSwitchingBaseTableClass</span><span class="s4">(</span><span class="s6">&quot;uint8&quot;</span><span class="s4">)):</span>
    <span class="s3">def </span><span class="s1">populateDefaults</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">propagator</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;clips&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">clips </span><span class="s4">= {}</span>

    <span class="s3">def </span><span class="s1">postRead</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">rawTable</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">clips </span><span class="s4">= {}</span>
        <span class="s1">glyphOrder </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getGlyphOrder</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">rec </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">rawTable</span><span class="s4">[</span><span class="s6">&quot;ClipRecord&quot;</span><span class="s4">]):</span>
            <span class="s3">if </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">StartGlyphID </span><span class="s4">&gt; </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">EndGlyphID</span><span class="s4">:</span>
                <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span>
                    <span class="s6">&quot;invalid ClipRecord[%i].StartGlyphID (%i) &gt; &quot;</span>
                    <span class="s6">&quot;EndGlyphID (%i); skipped&quot;</span><span class="s4">,</span>
                    <span class="s1">i</span><span class="s4">,</span>
                    <span class="s1">rec</span><span class="s4">.</span><span class="s1">StartGlyphID</span><span class="s4">,</span>
                    <span class="s1">rec</span><span class="s4">.</span><span class="s1">EndGlyphID</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s3">continue</span>
            <span class="s1">redefinedGlyphs </span><span class="s4">= []</span>
            <span class="s1">missingGlyphs </span><span class="s4">= []</span>
            <span class="s3">for </span><span class="s1">glyphID </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">rec</span><span class="s4">.</span><span class="s1">StartGlyphID</span><span class="s4">, </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">EndGlyphID </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">):</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">glyph </span><span class="s4">= </span><span class="s1">glyphOrder</span><span class="s4">[</span><span class="s1">glyphID</span><span class="s4">]</span>
                <span class="s3">except </span><span class="s1">IndexError</span><span class="s4">:</span>
                    <span class="s1">missingGlyphs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">glyphID</span><span class="s4">)</span>
                    <span class="s3">continue</span>
                <span class="s3">if </span><span class="s1">glyph </span><span class="s3">not in </span><span class="s1">clips</span><span class="s4">:</span>
                    <span class="s1">clips</span><span class="s4">[</span><span class="s1">glyph</span><span class="s4">] = </span><span class="s1">copy</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">(</span><span class="s1">rec</span><span class="s4">.</span><span class="s1">ClipBox</span><span class="s4">)</span>
                <span class="s3">else</span><span class="s4">:</span>
                    <span class="s1">redefinedGlyphs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">glyphID</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">redefinedGlyphs</span><span class="s4">:</span>
                <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span>
                    <span class="s6">&quot;ClipRecord[%i] overlaps previous records; &quot;</span>
                    <span class="s6">&quot;ignoring redefined clip boxes for the &quot;</span>
                    <span class="s6">&quot;following glyph ID range: [%i-%i]&quot;</span><span class="s4">,</span>
                    <span class="s1">i</span><span class="s4">,</span>
                    <span class="s1">min</span><span class="s4">(</span><span class="s1">redefinedGlyphs</span><span class="s4">),</span>
                    <span class="s1">max</span><span class="s4">(</span><span class="s1">redefinedGlyphs</span><span class="s4">),</span>
                <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">missingGlyphs</span><span class="s4">:</span>
                <span class="s1">log</span><span class="s4">.</span><span class="s1">warning</span><span class="s4">(</span>
                    <span class="s6">&quot;ClipRecord[%i] range references missing &quot; &quot;glyph IDs: [%i-%i]&quot;</span><span class="s4">,</span>
                    <span class="s1">i</span><span class="s4">,</span>
                    <span class="s1">min</span><span class="s4">(</span><span class="s1">missingGlyphs</span><span class="s4">),</span>
                    <span class="s1">max</span><span class="s4">(</span><span class="s1">missingGlyphs</span><span class="s4">),</span>
                <span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">clips </span><span class="s4">= </span><span class="s1">clips</span>

    <span class="s3">def </span><span class="s1">groups</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">glyphsByClip </span><span class="s4">= </span><span class="s1">defaultdict</span><span class="s4">(</span><span class="s1">list</span><span class="s4">)</span>
        <span class="s1">uniqueClips </span><span class="s4">= {}</span>
        <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">clipBox </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clips</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">key </span><span class="s4">= </span><span class="s1">clipBox</span><span class="s4">.</span><span class="s1">as_tuple</span><span class="s4">()</span>
            <span class="s1">glyphsByClip</span><span class="s4">[</span><span class="s1">key</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">key </span><span class="s3">not in </span><span class="s1">uniqueClips</span><span class="s4">:</span>
                <span class="s1">uniqueClips</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">clipBox</span>
        <span class="s3">return </span><span class="s4">{</span>
            <span class="s1">frozenset</span><span class="s4">(</span><span class="s1">glyphs</span><span class="s4">): </span><span class="s1">uniqueClips</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] </span><span class="s3">for </span><span class="s1">key</span><span class="s4">, </span><span class="s1">glyphs </span><span class="s3">in </span><span class="s1">glyphsByClip</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()</span>
        <span class="s4">}</span>

    <span class="s3">def </span><span class="s1">preWrite</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;clips&quot;</span><span class="s4">):</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">clips </span><span class="s4">= {}</span>
        <span class="s1">clipBoxRanges </span><span class="s4">= {}</span>
        <span class="s1">glyphMap </span><span class="s4">= </span><span class="s1">font</span><span class="s4">.</span><span class="s1">getReverseGlyphMap</span><span class="s4">()</span>
        <span class="s3">for </span><span class="s1">glyphs</span><span class="s4">, </span><span class="s1">clipBox </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">().</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">glyphIDs </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span>
                <span class="s1">glyphMap</span><span class="s4">[</span><span class="s1">glyphName</span><span class="s4">] </span><span class="s3">for </span><span class="s1">glyphName </span><span class="s3">in </span><span class="s1">glyphs </span><span class="s3">if </span><span class="s1">glyphName </span><span class="s3">in </span><span class="s1">glyphMap</span>
            <span class="s4">)</span>
            <span class="s3">if not </span><span class="s1">glyphIDs</span><span class="s4">:</span>
                <span class="s3">continue</span>
            <span class="s1">last </span><span class="s4">= </span><span class="s1">glyphIDs</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
            <span class="s1">ranges </span><span class="s4">= [[</span><span class="s1">last</span><span class="s4">]]</span>
            <span class="s3">for </span><span class="s1">glyphID </span><span class="s3">in </span><span class="s1">glyphIDs</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]:</span>
                <span class="s3">if </span><span class="s1">glyphID </span><span class="s4">!= </span><span class="s1">last </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">:</span>
                    <span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">last</span><span class="s4">)</span>
                    <span class="s1">ranges</span><span class="s4">.</span><span class="s1">append</span><span class="s4">([</span><span class="s1">glyphID</span><span class="s4">])</span>
                <span class="s1">last </span><span class="s4">= </span><span class="s1">glyphID</span>
            <span class="s1">ranges</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">append</span><span class="s4">(</span><span class="s1">last</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">start</span><span class="s4">, </span><span class="s1">end </span><span class="s3">in </span><span class="s1">ranges</span><span class="s4">:</span>
                <span class="s3">assert </span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">) </span><span class="s3">not in </span><span class="s1">clipBoxRanges</span>
                <span class="s1">clipBoxRanges</span><span class="s4">[(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">)] = </span><span class="s1">clipBox</span>

        <span class="s1">clipRecords </span><span class="s4">= []</span>
        <span class="s3">for </span><span class="s4">(</span><span class="s1">start</span><span class="s4">, </span><span class="s1">end</span><span class="s4">), </span><span class="s1">clipBox </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">clipBoxRanges</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()):</span>
            <span class="s1">record </span><span class="s4">= </span><span class="s1">ClipRecord</span><span class="s4">()</span>
            <span class="s1">record</span><span class="s4">.</span><span class="s1">StartGlyphID </span><span class="s4">= </span><span class="s1">start</span>
            <span class="s1">record</span><span class="s4">.</span><span class="s1">EndGlyphID </span><span class="s4">= </span><span class="s1">end</span>
            <span class="s1">record</span><span class="s4">.</span><span class="s1">ClipBox </span><span class="s4">= </span><span class="s1">clipBox</span>
            <span class="s1">clipRecords</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">record</span><span class="s4">)</span>
        <span class="s1">rawTable </span><span class="s4">= {</span>
            <span class="s6">&quot;ClipCount&quot;</span><span class="s4">: </span><span class="s1">len</span><span class="s4">(</span><span class="s1">clipRecords</span><span class="s4">),</span>
            <span class="s6">&quot;ClipRecord&quot;</span><span class="s4">: </span><span class="s1">clipRecords</span><span class="s4">,</span>
        <span class="s4">}</span>
        <span class="s3">return </span><span class="s1">rawTable</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">name</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">tableName </span><span class="s4">= </span><span class="s1">name </span><span class="s3">if </span><span class="s1">name </span><span class="s3">else </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span>
        <span class="s3">if </span><span class="s1">attrs </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">attrs </span><span class="s4">= []</span>
        <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;Format&quot;</span><span class="s4">):</span>
            <span class="s1">attrs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s6">&quot;Format&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">))</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s1">tableName</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s0"># sort clips alphabetically to ensure deterministic XML dump</span>
        <span class="s3">for </span><span class="s1">glyphs</span><span class="s4">, </span><span class="s1">clipBox </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">().</span><span class="s1">items</span><span class="s4">(), </span><span class="s1">key</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">item</span><span class="s4">: </span><span class="s1">min</span><span class="s4">(</span><span class="s1">item</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
        <span class="s4">):</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s6">&quot;Clip&quot;</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s3">for </span><span class="s1">glyphName </span><span class="s3">in </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">glyphs</span><span class="s4">):</span>
                <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">simpletag</span><span class="s4">(</span><span class="s6">&quot;Glyph&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">glyphName</span><span class="s4">)</span>
                <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s6">&quot;ClipBox&quot;</span><span class="s4">, [(</span><span class="s6">&quot;Format&quot;</span><span class="s4">, </span><span class="s1">clipBox</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">)])</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s1">clipBox</span><span class="s4">.</span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s6">&quot;ClipBox&quot;</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s6">&quot;Clip&quot;</span><span class="s4">)</span>
            <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s1">tableName</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">):</span>
        <span class="s1">clips </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s6">&quot;clips&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">clips </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">clips </span><span class="s4">= </span><span class="s1">clips </span><span class="s4">= {}</span>
        <span class="s3">assert </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;Clip&quot;</span>
        <span class="s1">glyphs </span><span class="s4">= []</span>
        <span class="s1">clipBox </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s3">for </span><span class="s1">elem </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
            <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">elem</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                <span class="s3">continue</span>
            <span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content </span><span class="s4">= </span><span class="s1">elem</span>
            <span class="s3">if </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;Glyph&quot;</span><span class="s4">:</span>
                <span class="s1">glyphs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;value&quot;</span><span class="s4">])</span>
            <span class="s3">elif </span><span class="s1">name </span><span class="s4">== </span><span class="s6">&quot;ClipBox&quot;</span><span class="s4">:</span>
                <span class="s1">clipBox </span><span class="s4">= </span><span class="s1">ClipBox</span><span class="s4">()</span>
                <span class="s1">clipBox</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">safeEval</span><span class="s4">(</span><span class="s1">attrs</span><span class="s4">[</span><span class="s6">&quot;Format&quot;</span><span class="s4">])</span>
                <span class="s3">for </span><span class="s1">elem </span><span class="s3">in </span><span class="s1">content</span><span class="s4">:</span>
                    <span class="s3">if not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">elem</span><span class="s4">, </span><span class="s1">tuple</span><span class="s4">):</span>
                        <span class="s3">continue</span>
                    <span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content </span><span class="s4">= </span><span class="s1">elem</span>
                    <span class="s1">clipBox</span><span class="s4">.</span><span class="s1">fromXML</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">, </span><span class="s1">content</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">clipBox</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">glyphName </span><span class="s3">in </span><span class="s1">glyphs</span><span class="s4">:</span>
                <span class="s1">clips</span><span class="s4">[</span><span class="s1">glyphName</span><span class="s4">] = </span><span class="s1">clipBox</span>


<span class="s3">class </span><span class="s1">ExtendMode</span><span class="s4">(</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s1">PAD </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">REPEAT </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">REFLECT </span><span class="s4">= </span><span class="s5">2</span>


<span class="s0"># Porter-Duff modes for COLRv1 PaintComposite:</span>
<span class="s0"># https://github.com/googlefonts/colr-gradients-spec/tree/off_sub_1#compositemode-enumeration</span>
<span class="s3">class </span><span class="s1">CompositeMode</span><span class="s4">(</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s1">CLEAR </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">SRC </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">DEST </span><span class="s4">= </span><span class="s5">2</span>
    <span class="s1">SRC_OVER </span><span class="s4">= </span><span class="s5">3</span>
    <span class="s1">DEST_OVER </span><span class="s4">= </span><span class="s5">4</span>
    <span class="s1">SRC_IN </span><span class="s4">= </span><span class="s5">5</span>
    <span class="s1">DEST_IN </span><span class="s4">= </span><span class="s5">6</span>
    <span class="s1">SRC_OUT </span><span class="s4">= </span><span class="s5">7</span>
    <span class="s1">DEST_OUT </span><span class="s4">= </span><span class="s5">8</span>
    <span class="s1">SRC_ATOP </span><span class="s4">= </span><span class="s5">9</span>
    <span class="s1">DEST_ATOP </span><span class="s4">= </span><span class="s5">10</span>
    <span class="s1">XOR </span><span class="s4">= </span><span class="s5">11</span>
    <span class="s1">PLUS </span><span class="s4">= </span><span class="s5">12</span>
    <span class="s1">SCREEN </span><span class="s4">= </span><span class="s5">13</span>
    <span class="s1">OVERLAY </span><span class="s4">= </span><span class="s5">14</span>
    <span class="s1">DARKEN </span><span class="s4">= </span><span class="s5">15</span>
    <span class="s1">LIGHTEN </span><span class="s4">= </span><span class="s5">16</span>
    <span class="s1">COLOR_DODGE </span><span class="s4">= </span><span class="s5">17</span>
    <span class="s1">COLOR_BURN </span><span class="s4">= </span><span class="s5">18</span>
    <span class="s1">HARD_LIGHT </span><span class="s4">= </span><span class="s5">19</span>
    <span class="s1">SOFT_LIGHT </span><span class="s4">= </span><span class="s5">20</span>
    <span class="s1">DIFFERENCE </span><span class="s4">= </span><span class="s5">21</span>
    <span class="s1">EXCLUSION </span><span class="s4">= </span><span class="s5">22</span>
    <span class="s1">MULTIPLY </span><span class="s4">= </span><span class="s5">23</span>
    <span class="s1">HSL_HUE </span><span class="s4">= </span><span class="s5">24</span>
    <span class="s1">HSL_SATURATION </span><span class="s4">= </span><span class="s5">25</span>
    <span class="s1">HSL_COLOR </span><span class="s4">= </span><span class="s5">26</span>
    <span class="s1">HSL_LUMINOSITY </span><span class="s4">= </span><span class="s5">27</span>


<span class="s3">class </span><span class="s1">PaintFormat</span><span class="s4">(</span><span class="s1">IntEnum</span><span class="s4">):</span>
    <span class="s1">PaintColrLayers </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">PaintSolid </span><span class="s4">= </span><span class="s5">2</span>
    <span class="s1">PaintVarSolid </span><span class="s4">= </span><span class="s5">3</span>
    <span class="s1">PaintLinearGradient </span><span class="s4">= </span><span class="s5">4</span>
    <span class="s1">PaintVarLinearGradient </span><span class="s4">= </span><span class="s5">5</span>
    <span class="s1">PaintRadialGradient </span><span class="s4">= </span><span class="s5">6</span>
    <span class="s1">PaintVarRadialGradient </span><span class="s4">= </span><span class="s5">7</span>
    <span class="s1">PaintSweepGradient </span><span class="s4">= </span><span class="s5">8</span>
    <span class="s1">PaintVarSweepGradient </span><span class="s4">= </span><span class="s5">9</span>
    <span class="s1">PaintGlyph </span><span class="s4">= </span><span class="s5">10</span>
    <span class="s1">PaintColrGlyph </span><span class="s4">= </span><span class="s5">11</span>
    <span class="s1">PaintTransform </span><span class="s4">= </span><span class="s5">12</span>
    <span class="s1">PaintVarTransform </span><span class="s4">= </span><span class="s5">13</span>
    <span class="s1">PaintTranslate </span><span class="s4">= </span><span class="s5">14</span>
    <span class="s1">PaintVarTranslate </span><span class="s4">= </span><span class="s5">15</span>
    <span class="s1">PaintScale </span><span class="s4">= </span><span class="s5">16</span>
    <span class="s1">PaintVarScale </span><span class="s4">= </span><span class="s5">17</span>
    <span class="s1">PaintScaleAroundCenter </span><span class="s4">= </span><span class="s5">18</span>
    <span class="s1">PaintVarScaleAroundCenter </span><span class="s4">= </span><span class="s5">19</span>
    <span class="s1">PaintScaleUniform </span><span class="s4">= </span><span class="s5">20</span>
    <span class="s1">PaintVarScaleUniform </span><span class="s4">= </span><span class="s5">21</span>
    <span class="s1">PaintScaleUniformAroundCenter </span><span class="s4">= </span><span class="s5">22</span>
    <span class="s1">PaintVarScaleUniformAroundCenter </span><span class="s4">= </span><span class="s5">23</span>
    <span class="s1">PaintRotate </span><span class="s4">= </span><span class="s5">24</span>
    <span class="s1">PaintVarRotate </span><span class="s4">= </span><span class="s5">25</span>
    <span class="s1">PaintRotateAroundCenter </span><span class="s4">= </span><span class="s5">26</span>
    <span class="s1">PaintVarRotateAroundCenter </span><span class="s4">= </span><span class="s5">27</span>
    <span class="s1">PaintSkew </span><span class="s4">= </span><span class="s5">28</span>
    <span class="s1">PaintVarSkew </span><span class="s4">= </span><span class="s5">29</span>
    <span class="s1">PaintSkewAroundCenter </span><span class="s4">= </span><span class="s5">30</span>
    <span class="s1">PaintVarSkewAroundCenter </span><span class="s4">= </span><span class="s5">31</span>
    <span class="s1">PaintComposite </span><span class="s4">= </span><span class="s5">32</span>

    <span class="s3">def </span><span class="s1">is_variable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">name</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s6">&quot;PaintVar&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">as_variable</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">is_variable</span><span class="s4">():</span>
            <span class="s3">return </span><span class="s1">self</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">__members__</span><span class="s4">[</span><span class="s6">f&quot;PaintVar</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">name</span><span class="s4">[</span><span class="s5">5</span><span class="s4">:]</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">]</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">return None</span>


<span class="s3">class </span><span class="s1">Paint</span><span class="s4">(</span><span class="s1">getFormatSwitchingBaseTableClass</span><span class="s4">(</span><span class="s6">&quot;uint8&quot;</span><span class="s4">)):</span>
    <span class="s1">formatEnum </span><span class="s4">= </span><span class="s1">PaintFormat</span>

    <span class="s3">def </span><span class="s1">getFormatName</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">formatEnum</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">).</span><span class="s1">name</span>
        <span class="s3">except </span><span class="s1">ValueError</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s6">f&quot;Unknown Paint format: </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">toXML</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">name</span><span class="s4">=</span><span class="s3">None</span><span class="s4">):</span>
        <span class="s1">tableName </span><span class="s4">= </span><span class="s1">name </span><span class="s3">if </span><span class="s1">name </span><span class="s3">else </span><span class="s1">self</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span>
        <span class="s3">if </span><span class="s1">attrs </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">attrs </span><span class="s4">= []</span>
        <span class="s1">attrs</span><span class="s4">.</span><span class="s1">append</span><span class="s4">((</span><span class="s6">&quot;Format&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">))</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">begintag</span><span class="s4">(</span><span class="s1">tableName</span><span class="s4">, </span><span class="s1">attrs</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">comment</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">getFormatName</span><span class="s4">())</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">toXML2</span><span class="s4">(</span><span class="s1">xmlWriter</span><span class="s4">, </span><span class="s1">font</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">endtag</span><span class="s4">(</span><span class="s1">tableName</span><span class="s4">)</span>
        <span class="s1">xmlWriter</span><span class="s4">.</span><span class="s1">newline</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">iterPaintSubTables</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">colr</span><span class="s4">: </span><span class="s1">COLR</span><span class="s4">) </span><span class="s1">-&gt; Iterator</span><span class="s4">[</span><span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">SubTableEntry</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintColrLayers</span><span class="s4">:</span>
            <span class="s0"># https://github.com/fonttools/fonttools/issues/2438: don't die when no LayerList exists</span>
            <span class="s1">layers </span><span class="s4">= []</span>
            <span class="s3">if </span><span class="s1">colr</span><span class="s4">.</span><span class="s1">LayerList </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">layers </span><span class="s4">= </span><span class="s1">colr</span><span class="s4">.</span><span class="s1">LayerList</span><span class="s4">.</span><span class="s1">Paint</span>
            <span class="s3">yield from </span><span class="s4">(</span>
                <span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">SubTableEntry</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s6">&quot;Layers&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">v</span><span class="s4">, </span><span class="s1">index</span><span class="s4">=</span><span class="s1">i</span><span class="s4">)</span>
                <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span>
                    <span class="s1">layers</span><span class="s4">[</span><span class="s1">self</span><span class="s4">.</span><span class="s1">FirstLayerIndex </span><span class="s4">: </span><span class="s1">self</span><span class="s4">.</span><span class="s1">FirstLayerIndex </span><span class="s4">+ </span><span class="s1">self</span><span class="s4">.</span><span class="s1">NumLayers</span><span class="s4">]</span>
                <span class="s4">)</span>
            <span class="s4">)</span>
            <span class="s3">return</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintColrGlyph</span><span class="s4">:</span>
            <span class="s3">for </span><span class="s1">record </span><span class="s3">in </span><span class="s1">colr</span><span class="s4">.</span><span class="s1">BaseGlyphList</span><span class="s4">.</span><span class="s1">BaseGlyphPaintRecord</span><span class="s4">:</span>
                <span class="s3">if </span><span class="s1">record</span><span class="s4">.</span><span class="s1">BaseGlyph </span><span class="s4">== </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Glyph</span><span class="s4">:</span>
                    <span class="s3">yield </span><span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">SubTableEntry</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s6">&quot;BaseGlyph&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">record</span><span class="s4">.</span><span class="s1">Paint</span><span class="s4">)</span>
                    <span class="s3">return</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">KeyError</span><span class="s4">(</span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Glyph</span><span class="s3">!r} </span><span class="s6">not in colr.BaseGlyphList&quot;</span><span class="s4">)</span>

        <span class="s3">for </span><span class="s1">conv </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">getConverters</span><span class="s4">():</span>
            <span class="s3">if </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">tableClass </span><span class="s3">is not None and </span><span class="s1">issubclass</span><span class="s4">(</span><span class="s1">conv</span><span class="s4">.</span><span class="s1">tableClass</span><span class="s4">, </span><span class="s1">type</span><span class="s4">(</span><span class="s1">self</span><span class="s4">)):</span>
                <span class="s1">value </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
                <span class="s3">yield </span><span class="s1">BaseTable</span><span class="s4">.</span><span class="s1">SubTableEntry</span><span class="s4">(</span><span class="s1">name</span><span class="s4">=</span><span class="s1">conv</span><span class="s4">.</span><span class="s1">name</span><span class="s4">, </span><span class="s1">value</span><span class="s4">=</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">getChildren</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">colr</span><span class="s4">) </span><span class="s1">-&gt; List</span><span class="s4">[</span><span class="s6">&quot;Paint&quot;</span><span class="s4">]:</span>
        <span class="s0"># this is kept for backward compatibility (e.g. it's used by the subsetter)</span>
        <span class="s3">return </span><span class="s4">[</span><span class="s1">p</span><span class="s4">.</span><span class="s1">value </span><span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">iterPaintSubTables</span><span class="s4">(</span><span class="s1">colr</span><span class="s4">)]</span>

    <span class="s3">def </span><span class="s1">traverse</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">colr</span><span class="s4">: </span><span class="s1">COLR</span><span class="s4">, </span><span class="s1">callback</span><span class="s4">):</span>
        <span class="s2">&quot;&quot;&quot;Depth-first traversal of graph rooted at self, callback on each node.&quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">callable</span><span class="s4">(</span><span class="s1">callback</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s6">&quot;callback must be callable&quot;</span><span class="s4">)</span>

        <span class="s3">for </span><span class="s1">path </span><span class="s3">in </span><span class="s1">dfs_base_table</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">, </span><span class="s1">iter_subtables_fn</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">paint</span><span class="s4">: </span><span class="s1">paint</span><span class="s4">.</span><span class="s1">iterPaintSubTables</span><span class="s4">(</span><span class="s1">colr</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s1">paint </span><span class="s4">= </span><span class="s1">path</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">value</span>
            <span class="s1">callback</span><span class="s4">(</span><span class="s1">paint</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">getTransform</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; Transform</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintTransform</span><span class="s4">:</span>
            <span class="s1">t </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Transform</span>
            <span class="s3">return </span><span class="s1">Transform</span><span class="s4">(</span><span class="s1">t</span><span class="s4">.</span><span class="s1">xx</span><span class="s4">, </span><span class="s1">t</span><span class="s4">.</span><span class="s1">yx</span><span class="s4">, </span><span class="s1">t</span><span class="s4">.</span><span class="s1">xy</span><span class="s4">, </span><span class="s1">t</span><span class="s4">.</span><span class="s1">yy</span><span class="s4">, </span><span class="s1">t</span><span class="s4">.</span><span class="s1">dx</span><span class="s4">, </span><span class="s1">t</span><span class="s4">.</span><span class="s1">dy</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintTranslate</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">Identity</span><span class="s4">.</span><span class="s1">translate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">dx</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">dy</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintScale</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">Identity</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scaleX</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scaleY</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintScaleAroundCenter</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span>
                <span class="s1">Identity</span><span class="s4">.</span><span class="s1">translate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scaleX</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">scaleY</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">translate</span><span class="s4">(-</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, -</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintScaleUniform</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">Identity</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintScaleUniformAroundCenter</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span>
                <span class="s1">Identity</span><span class="s4">.</span><span class="s1">translate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">scale</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">translate</span><span class="s4">(-</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, -</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintRotate</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">Identity</span><span class="s4">.</span><span class="s1">rotate</span><span class="s4">(</span><span class="s1">radians</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">angle</span><span class="s4">))</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintRotateAroundCenter</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span>
                <span class="s1">Identity</span><span class="s4">.</span><span class="s1">translate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">rotate</span><span class="s4">(</span><span class="s1">radians</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">angle</span><span class="s4">))</span>
                <span class="s4">.</span><span class="s1">translate</span><span class="s4">(-</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, -</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintSkew</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">Identity</span><span class="s4">.</span><span class="s1">skew</span><span class="s4">(</span><span class="s1">radians</span><span class="s4">(-</span><span class="s1">self</span><span class="s4">.</span><span class="s1">xSkewAngle</span><span class="s4">), </span><span class="s1">radians</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ySkewAngle</span><span class="s4">))</span>
        <span class="s3">elif </span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintSkewAroundCenter</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s4">(</span>
                <span class="s1">Identity</span><span class="s4">.</span><span class="s1">translate</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
                <span class="s4">.</span><span class="s1">skew</span><span class="s4">(</span><span class="s1">radians</span><span class="s4">(-</span><span class="s1">self</span><span class="s4">.</span><span class="s1">xSkewAngle</span><span class="s4">), </span><span class="s1">radians</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">ySkewAngle</span><span class="s4">))</span>
                <span class="s4">.</span><span class="s1">translate</span><span class="s4">(-</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerX</span><span class="s4">, -</span><span class="s1">self</span><span class="s4">.</span><span class="s1">centerY</span><span class="s4">)</span>
            <span class="s4">)</span>
        <span class="s3">if </span><span class="s1">PaintFormat</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s4">).</span><span class="s1">is_variable</span><span class="s4">():</span>
            <span class="s3">raise </span><span class="s1">NotImplementedError</span><span class="s4">(</span><span class="s6">f&quot;Variable Paints not supported: </span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">Format</span><span class="s3">}</span><span class="s6">&quot;</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">Identity</span>

    <span class="s3">def </span><span class="s1">computeClipBox</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">colr</span><span class="s4">: </span><span class="s1">COLR</span><span class="s4">, </span><span class="s1">glyphSet</span><span class="s4">: </span><span class="s6">&quot;_TTGlyphSet&quot;</span><span class="s4">, </span><span class="s1">quantization</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">ClipBox</span><span class="s4">]:</span>
        <span class="s1">pen </span><span class="s4">= </span><span class="s1">ControlBoundsPen</span><span class="s4">(</span><span class="s1">glyphSet</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">path </span><span class="s3">in </span><span class="s1">dfs_base_table</span><span class="s4">(</span>
            <span class="s1">self</span><span class="s4">, </span><span class="s1">iter_subtables_fn</span><span class="s4">=</span><span class="s3">lambda </span><span class="s1">paint</span><span class="s4">: </span><span class="s1">paint</span><span class="s4">.</span><span class="s1">iterPaintSubTables</span><span class="s4">(</span><span class="s1">colr</span><span class="s4">)</span>
        <span class="s4">):</span>
            <span class="s1">paint </span><span class="s4">= </span><span class="s1">path</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">].</span><span class="s1">value</span>
            <span class="s3">if </span><span class="s1">paint</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s1">PaintFormat</span><span class="s4">.</span><span class="s1">PaintGlyph</span><span class="s4">:</span>
                <span class="s1">transformation </span><span class="s4">= </span><span class="s1">reduce</span><span class="s4">(</span>
                    <span class="s1">Transform</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">,</span>
                    <span class="s4">(</span><span class="s1">st</span><span class="s4">.</span><span class="s1">value</span><span class="s4">.</span><span class="s1">getTransform</span><span class="s4">() </span><span class="s3">for </span><span class="s1">st </span><span class="s3">in </span><span class="s1">path</span><span class="s4">),</span>
                    <span class="s1">Identity</span><span class="s4">,</span>
                <span class="s4">)</span>
                <span class="s1">glyphSet</span><span class="s4">[</span><span class="s1">paint</span><span class="s4">.</span><span class="s1">Glyph</span><span class="s4">].</span><span class="s1">draw</span><span class="s4">(</span><span class="s1">TransformPen</span><span class="s4">(</span><span class="s1">pen</span><span class="s4">, </span><span class="s1">transformation</span><span class="s4">))</span>

        <span class="s3">if </span><span class="s1">pen</span><span class="s4">.</span><span class="s1">bounds </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s1">cb </span><span class="s4">= </span><span class="s1">ClipBox</span><span class="s4">()</span>
        <span class="s1">cb</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">ClipBoxFormat</span><span class="s4">.</span><span class="s1">Static</span><span class="s4">)</span>
        <span class="s1">cb</span><span class="s4">.</span><span class="s1">xMin</span><span class="s4">, </span><span class="s1">cb</span><span class="s4">.</span><span class="s1">yMin</span><span class="s4">, </span><span class="s1">cb</span><span class="s4">.</span><span class="s1">xMax</span><span class="s4">, </span><span class="s1">cb</span><span class="s4">.</span><span class="s1">yMax </span><span class="s4">= </span><span class="s1">quantizeRect</span><span class="s4">(</span><span class="s1">pen</span><span class="s4">.</span><span class="s1">bounds</span><span class="s4">, </span><span class="s1">quantization</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">cb</span>


<span class="s0"># For each subtable format there is a class. However, we don't really distinguish</span>
<span class="s0"># between &quot;field name&quot; and &quot;format name&quot;: often these are the same. Yet there's</span>
<span class="s0"># a whole bunch of fields with different names. The following dict is a mapping</span>
<span class="s0"># from &quot;format name&quot; to &quot;field name&quot;. _buildClasses() uses this to create a</span>
<span class="s0"># subclass for each alternate field name.</span>
<span class="s0">#</span>
<span class="s1">_equivalents </span><span class="s4">= {</span>
    <span class="s6">&quot;MarkArray&quot;</span><span class="s4">: (</span><span class="s6">&quot;Mark1Array&quot;</span><span class="s4">,),</span>
    <span class="s6">&quot;LangSys&quot;</span><span class="s4">: (</span><span class="s6">&quot;DefaultLangSys&quot;</span><span class="s4">,),</span>
    <span class="s6">&quot;Coverage&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;MarkCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;BaseCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;LigatureCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;Mark1Coverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;Mark2Coverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;BacktrackCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;InputCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;LookAheadCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;VertGlyphCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;HorizGlyphCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;TopAccentCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExtendedShapeCoverage&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;MathKernCoverage&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;ClassDef&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;ClassDef1&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ClassDef2&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;BacktrackClassDef&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;InputClassDef&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;LookAheadClassDef&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;GlyphClassDef&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;MarkAttachClassDef&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;Anchor&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;EntryAnchor&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExitAnchor&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;BaseAnchor&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;LigatureAnchor&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;Mark2Anchor&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;MarkAnchor&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;Device&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;XPlaDevice&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;YPlaDevice&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;XAdvDevice&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;YAdvDevice&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;XDeviceTable&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;YDeviceTable&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;DeviceTable&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;Axis&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;HorizAxis&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;VertAxis&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;MinMax&quot;</span><span class="s4">: (</span><span class="s6">&quot;DefaultMinMax&quot;</span><span class="s4">,),</span>
    <span class="s6">&quot;BaseCoord&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;MinCoord&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;MaxCoord&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;JstfLangSys&quot;</span><span class="s4">: (</span><span class="s6">&quot;DefJstfLangSys&quot;</span><span class="s4">,),</span>
    <span class="s6">&quot;JstfGSUBModList&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;ShrinkageEnableGSUB&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ShrinkageDisableGSUB&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExtensionEnableGSUB&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExtensionDisableGSUB&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;JstfGPOSModList&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;ShrinkageEnableGPOS&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ShrinkageDisableGPOS&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExtensionEnableGPOS&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExtensionDisableGPOS&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;JstfMax&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;ShrinkageJstfMax&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;ExtensionJstfMax&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;MathKern&quot;</span><span class="s4">: (</span>
        <span class="s6">&quot;TopRightMathKern&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;TopLeftMathKern&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;BottomRightMathKern&quot;</span><span class="s4">,</span>
        <span class="s6">&quot;BottomLeftMathKern&quot;</span><span class="s4">,</span>
    <span class="s4">),</span>
    <span class="s6">&quot;MathGlyphConstruction&quot;</span><span class="s4">: (</span><span class="s6">&quot;VertGlyphConstruction&quot;</span><span class="s4">, </span><span class="s6">&quot;HorizGlyphConstruction&quot;</span><span class="s4">),</span>
<span class="s4">}</span>

<span class="s0">#</span>
<span class="s0"># OverFlow logic, to automatically create ExtensionLookups</span>
<span class="s0"># XXX This should probably move to otBase.py</span>
<span class="s0">#</span>


<span class="s3">def </span><span class="s1">fixLookupOverFlows</span><span class="s4">(</span><span class="s1">ttf</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Either the offset from the LookupList to a lookup overflowed, or 
    an offset from a lookup to a subtable overflowed. 
    The table layout is: 
    GPSO/GUSB 
            Script List 
            Feature List 
            LookUpList 
                    Lookup[0] and contents 
                            SubTable offset list 
                                    SubTable[0] and contents 
                                    ... 
                                    SubTable[n] and contents 
                    ... 
                    Lookup[n] and contents 
                            SubTable offset list 
                                    SubTable[0] and contents 
                                    ... 
                                    SubTable[n] and contents 
    If the offset to a lookup overflowed (SubTableIndex is None) 
            we must promote the *previous*  lookup to an Extension type. 
    If the offset from a lookup to subtable overflowed, then we must promote it 
            to an Extension Lookup type. 
    &quot;&quot;&quot;</span>
    <span class="s1">ok </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">lookupIndex </span><span class="s4">= </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">LookupListIndex</span>
    <span class="s3">if </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">SubTableIndex </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s1">lookupIndex </span><span class="s4">= </span><span class="s1">lookupIndex </span><span class="s4">- </span><span class="s5">1</span>
    <span class="s3">if </span><span class="s1">lookupIndex </span><span class="s4">&lt; </span><span class="s5">0</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">ok</span>
    <span class="s3">if </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType </span><span class="s4">== </span><span class="s6">&quot;GSUB&quot;</span><span class="s4">:</span>
        <span class="s1">extType </span><span class="s4">= </span><span class="s5">7</span>
    <span class="s3">elif </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType </span><span class="s4">== </span><span class="s6">&quot;GPOS&quot;</span><span class="s4">:</span>
        <span class="s1">extType </span><span class="s4">= </span><span class="s5">9</span>

    <span class="s1">lookups </span><span class="s4">= </span><span class="s1">ttf</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">].</span><span class="s1">table</span><span class="s4">.</span><span class="s1">LookupList</span><span class="s4">.</span><span class="s1">Lookup</span>
    <span class="s1">lookup </span><span class="s4">= </span><span class="s1">lookups</span><span class="s4">[</span><span class="s1">lookupIndex</span><span class="s4">]</span>
    <span class="s0"># If the previous lookup is an extType, look further back. Very unlikely, but possible.</span>
    <span class="s3">while </span><span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">LookupType </span><span class="s4">== </span><span class="s1">extType</span><span class="s4">:</span>
        <span class="s1">lookupIndex </span><span class="s4">= </span><span class="s1">lookupIndex </span><span class="s4">- </span><span class="s5">1</span>
        <span class="s3">if </span><span class="s1">lookupIndex </span><span class="s4">&lt; </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">ok</span>
        <span class="s1">lookup </span><span class="s4">= </span><span class="s1">lookups</span><span class="s4">[</span><span class="s1">lookupIndex</span><span class="s4">]</span>

    <span class="s3">for </span><span class="s1">lookupIndex </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">lookupIndex</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">lookups</span><span class="s4">)):</span>
        <span class="s1">lookup </span><span class="s4">= </span><span class="s1">lookups</span><span class="s4">[</span><span class="s1">lookupIndex</span><span class="s4">]</span>
        <span class="s3">if </span><span class="s1">lookup</span><span class="s4">.</span><span class="s1">LookupType </span><span class="s4">!= </span><span class="s1">extType</span><span class="s4">:</span>
            <span class="s1">lookup</span><span class="s4">.</span><span class="s1">LookupType </span><span class="s4">= </span><span class="s1">extType</span>
            <span class="s3">for </span><span class="s1">si </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">)):</span>
                <span class="s1">subTable </span><span class="s4">= </span><span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">[</span><span class="s1">si</span><span class="s4">]</span>
                <span class="s1">extSubTableClass </span><span class="s4">= </span><span class="s1">lookupTypes</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">][</span><span class="s1">extType</span><span class="s4">]</span>
                <span class="s1">extSubTable </span><span class="s4">= </span><span class="s1">extSubTableClass</span><span class="s4">()</span>
                <span class="s1">extSubTable</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s5">1</span>
                <span class="s1">extSubTable</span><span class="s4">.</span><span class="s1">ExtSubTable </span><span class="s4">= </span><span class="s1">subTable</span>
                <span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">[</span><span class="s1">si</span><span class="s4">] = </span><span class="s1">extSubTable</span>
    <span class="s1">ok </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s3">return </span><span class="s1">ok</span>


<span class="s3">def </span><span class="s1">splitMultipleSubst</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s1">ok </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">oldMapping </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
    <span class="s1">oldLen </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldMapping</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemName </span><span class="s3">in </span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">, </span><span class="s6">&quot;RangeRecord&quot;</span><span class="s4">]:</span>
        <span class="s0"># Coverage table is written last. Overflow is to or within the</span>
        <span class="s0"># the coverage table. We will just cut the subtable in half.</span>
        <span class="s1">newLen </span><span class="s4">= </span><span class="s1">oldLen </span><span class="s4">// </span><span class="s5">2</span>

    <span class="s3">elif </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemName </span><span class="s4">== </span><span class="s6">&quot;Sequence&quot;</span><span class="s4">:</span>
        <span class="s0"># We just need to back up by two items from the overflowed</span>
        <span class="s0"># Sequence index to make sure the offset to the Coverage table</span>
        <span class="s0"># doesn't overflow.</span>
        <span class="s1">newLen </span><span class="s4">= </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemIndex </span><span class="s4">- </span><span class="s5">1</span>

    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">mapping </span><span class="s4">= {}</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">newLen</span><span class="s4">, </span><span class="s1">oldLen</span><span class="s4">):</span>
        <span class="s1">item </span><span class="s4">= </span><span class="s1">oldMapping</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
        <span class="s1">key </span><span class="s4">= </span><span class="s1">item</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>
        <span class="s3">del </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">mapping</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>

    <span class="s3">return </span><span class="s1">ok</span>


<span class="s3">def </span><span class="s1">splitAlternateSubst</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s1">ok </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s6">&quot;sortCoverageLast&quot;</span><span class="s4">):</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">sortCoverageLast </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">sortCoverageLast</span>

    <span class="s1">oldAlts </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">alternates</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
    <span class="s1">oldLen </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldAlts</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemName </span><span class="s3">in </span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">, </span><span class="s6">&quot;RangeRecord&quot;</span><span class="s4">]:</span>
        <span class="s0"># Coverage table is written last. overflow is to or within the</span>
        <span class="s0"># the coverage table. We will just cut the subtable in half.</span>
        <span class="s1">newLen </span><span class="s4">= </span><span class="s1">oldLen </span><span class="s4">// </span><span class="s5">2</span>

    <span class="s3">elif </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemName </span><span class="s4">== </span><span class="s6">&quot;AlternateSet&quot;</span><span class="s4">:</span>
        <span class="s0"># We just need to back up by two items</span>
        <span class="s0"># from the overflowed AlternateSet index to make sure the offset</span>
        <span class="s0"># to the Coverage table doesn't overflow.</span>
        <span class="s1">newLen </span><span class="s4">= </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemIndex </span><span class="s4">- </span><span class="s5">1</span>

    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">alternates </span><span class="s4">= {}</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">newLen</span><span class="s4">, </span><span class="s1">oldLen</span><span class="s4">):</span>
        <span class="s1">item </span><span class="s4">= </span><span class="s1">oldAlts</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
        <span class="s1">key </span><span class="s4">= </span><span class="s1">item</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">alternates</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>
        <span class="s3">del </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">alternates</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>

    <span class="s3">return </span><span class="s1">ok</span>


<span class="s3">def </span><span class="s1">splitLigatureSubst</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s1">ok </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s1">oldLigs </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ligatures</span><span class="s4">.</span><span class="s1">items</span><span class="s4">())</span>
    <span class="s1">oldLen </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldLigs</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemName </span><span class="s3">in </span><span class="s4">[</span><span class="s6">&quot;Coverage&quot;</span><span class="s4">, </span><span class="s6">&quot;RangeRecord&quot;</span><span class="s4">]:</span>
        <span class="s0"># Coverage table is written last. overflow is to or within the</span>
        <span class="s0"># the coverage table. We will just cut the subtable in half.</span>
        <span class="s1">newLen </span><span class="s4">= </span><span class="s1">oldLen </span><span class="s4">// </span><span class="s5">2</span>

    <span class="s3">elif </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemName </span><span class="s4">== </span><span class="s6">&quot;LigatureSet&quot;</span><span class="s4">:</span>
        <span class="s0"># We just need to back up by two items</span>
        <span class="s0"># from the overflowed AlternateSet index to make sure the offset</span>
        <span class="s0"># to the Coverage table doesn't overflow.</span>
        <span class="s1">newLen </span><span class="s4">= </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">itemIndex </span><span class="s4">- </span><span class="s5">1</span>

    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">ligatures </span><span class="s4">= {}</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">newLen</span><span class="s4">, </span><span class="s1">oldLen</span><span class="s4">):</span>
        <span class="s1">item </span><span class="s4">= </span><span class="s1">oldLigs</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
        <span class="s1">key </span><span class="s4">= </span><span class="s1">item</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">ligatures</span><span class="s4">[</span><span class="s1">key</span><span class="s4">] = </span><span class="s1">item</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>
        <span class="s3">del </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ligatures</span><span class="s4">[</span><span class="s1">key</span><span class="s4">]</span>

    <span class="s3">return </span><span class="s1">ok</span>


<span class="s3">def </span><span class="s1">splitPairPos</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s1">st </span><span class="s4">= </span><span class="s1">oldSubTable</span>
    <span class="s1">ok </span><span class="s4">= </span><span class="s3">False</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Format</span>
    <span class="s3">if </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">1 </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">PairSet</span><span class="s4">) &gt; </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s6">&quot;ValueFormat1&quot;</span><span class="s4">, </span><span class="s6">&quot;ValueFormat2&quot;</span><span class="s4">:</span>
            <span class="s1">setattr</span><span class="s4">(</span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">name</span><span class="s4">))</span>

        <span class="s0"># Move top half of coverage to new subtable</span>

        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Coverage </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>

        <span class="s1">coverage </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">glyphs</span>
        <span class="s1">records </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">PairSet</span>

        <span class="s1">oldCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">PairSet</span><span class="s4">) // </span><span class="s5">2</span>

        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">coverage</span><span class="s4">[:</span><span class="s1">oldCount</span><span class="s4">]</span>
        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">PairSet </span><span class="s4">= </span><span class="s1">records</span><span class="s4">[:</span><span class="s1">oldCount</span><span class="s4">]</span>

        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">coverage</span><span class="s4">[</span><span class="s1">oldCount</span><span class="s4">:]</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">PairSet </span><span class="s4">= </span><span class="s1">records</span><span class="s4">[</span><span class="s1">oldCount</span><span class="s4">:]</span>

        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">PairSetCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">PairSet</span><span class="s4">)</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">PairSetCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">PairSet</span><span class="s4">)</span>

        <span class="s1">ok </span><span class="s4">= </span><span class="s3">True</span>

    <span class="s3">elif </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">== </span><span class="s5">2 </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Record</span><span class="s4">) &gt; </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s6">&quot;Class2Count&quot;</span><span class="s4">):</span>
            <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class2Count </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Record</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">Class2Record</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s6">&quot;Class2Count&quot;</span><span class="s4">, </span><span class="s6">&quot;ClassDef2&quot;</span><span class="s4">, </span><span class="s6">&quot;ValueFormat1&quot;</span><span class="s4">, </span><span class="s6">&quot;ValueFormat2&quot;</span><span class="s4">:</span>
            <span class="s1">setattr</span><span class="s4">(</span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">name</span><span class="s4">))</span>

        <span class="s0"># The two subtables will still have the same ClassDef2 and the table</span>
        <span class="s0"># sharing will still cause the sharing to overflow.  As such, disable</span>
        <span class="s0"># sharing on the one that is serialized second (that's oldSubTable).</span>
        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">DontShare </span><span class="s4">= </span><span class="s3">True</span>

        <span class="s0"># Move top half of class numbers to new subtable</span>

        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Coverage </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">ClassDef1 </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ClassDef1</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>

        <span class="s1">coverage </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">glyphs</span>
        <span class="s1">classDefs </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ClassDef1</span><span class="s4">.</span><span class="s1">classDefs</span>
        <span class="s1">records </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Record</span>

        <span class="s1">oldCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Record</span><span class="s4">) // </span><span class="s5">2</span>
        <span class="s1">newGlyphs </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">k </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">classDefs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">() </span><span class="s3">if </span><span class="s1">v </span><span class="s4">&gt;= </span><span class="s1">oldCount</span><span class="s4">)</span>

        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= [</span><span class="s1">g </span><span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">coverage </span><span class="s3">if </span><span class="s1">g </span><span class="s3">not in </span><span class="s1">newGlyphs</span><span class="s4">]</span>
        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ClassDef1</span><span class="s4">.</span><span class="s1">classDefs </span><span class="s4">= {</span>
            <span class="s1">k</span><span class="s4">: </span><span class="s1">v </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">classDefs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">() </span><span class="s3">if </span><span class="s1">v </span><span class="s4">&lt; </span><span class="s1">oldCount</span>
        <span class="s4">}</span>
        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Record </span><span class="s4">= </span><span class="s1">records</span><span class="s4">[:</span><span class="s1">oldCount</span><span class="s4">]</span>

        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Coverage</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= [</span><span class="s1">g </span><span class="s3">for </span><span class="s1">g </span><span class="s3">in </span><span class="s1">coverage </span><span class="s3">if </span><span class="s1">g </span><span class="s3">in </span><span class="s1">newGlyphs</span><span class="s4">]</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">ClassDef1</span><span class="s4">.</span><span class="s1">classDefs </span><span class="s4">= {</span>
            <span class="s1">k</span><span class="s4">: (</span><span class="s1">v </span><span class="s4">- </span><span class="s1">oldCount</span><span class="s4">) </span><span class="s3">for </span><span class="s1">k</span><span class="s4">, </span><span class="s1">v </span><span class="s3">in </span><span class="s1">classDefs</span><span class="s4">.</span><span class="s1">items</span><span class="s4">() </span><span class="s3">if </span><span class="s1">v </span><span class="s4">&gt; </span><span class="s1">oldCount</span>
        <span class="s4">}</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Class1Record </span><span class="s4">= </span><span class="s1">records</span><span class="s4">[</span><span class="s1">oldCount</span><span class="s4">:]</span>

        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Count </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Class1Record</span><span class="s4">)</span>
        <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Class1Count </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Class1Record</span><span class="s4">)</span>

        <span class="s1">ok </span><span class="s4">= </span><span class="s3">True</span>

    <span class="s3">return </span><span class="s1">ok</span>


<span class="s3">def </span><span class="s1">splitMarkBasePos</span><span class="s4">(</span><span class="s1">oldSubTable</span><span class="s4">, </span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s0"># split half of the mark classes to the new subtable</span>
    <span class="s1">classCount </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ClassCount</span>
    <span class="s3">if </span><span class="s1">classCount </span><span class="s4">&lt; </span><span class="s5">2</span><span class="s4">:</span>
        <span class="s0"># oh well, not much left to split...</span>
        <span class="s3">return False</span>

    <span class="s1">oldClassCount </span><span class="s4">= </span><span class="s1">classCount </span><span class="s4">// </span><span class="s5">2</span>
    <span class="s1">newClassCount </span><span class="s4">= </span><span class="s1">classCount </span><span class="s4">- </span><span class="s1">oldClassCount</span>

    <span class="s1">oldMarkCoverage</span><span class="s4">, </span><span class="s1">oldMarkRecords </span><span class="s4">= [], []</span>
    <span class="s1">newMarkCoverage</span><span class="s4">, </span><span class="s1">newMarkRecords </span><span class="s4">= [], []</span>
    <span class="s3">for </span><span class="s1">glyphName</span><span class="s4">, </span><span class="s1">markRecord </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span>
        <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkCoverage</span><span class="s4">.</span><span class="s1">glyphs</span><span class="s4">, </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkArray</span><span class="s4">.</span><span class="s1">MarkRecord</span>
    <span class="s4">):</span>
        <span class="s3">if </span><span class="s1">markRecord</span><span class="s4">.</span><span class="s1">Class </span><span class="s4">&lt; </span><span class="s1">oldClassCount</span><span class="s4">:</span>
            <span class="s1">oldMarkCoverage</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">)</span>
            <span class="s1">oldMarkRecords</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">markRecord</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">markRecord</span><span class="s4">.</span><span class="s1">Class </span><span class="s4">-= </span><span class="s1">oldClassCount</span>
            <span class="s1">newMarkCoverage</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">glyphName</span><span class="s4">)</span>
            <span class="s1">newMarkRecords</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">markRecord</span><span class="s4">)</span>

    <span class="s1">oldBaseRecords</span><span class="s4">, </span><span class="s1">newBaseRecords </span><span class="s4">= [], []</span>
    <span class="s3">for </span><span class="s1">rec </span><span class="s3">in </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">BaseArray</span><span class="s4">.</span><span class="s1">BaseRecord</span><span class="s4">:</span>
        <span class="s1">oldBaseRecord</span><span class="s4">, </span><span class="s1">newBaseRecord </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">(), </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>
        <span class="s1">oldBaseRecord</span><span class="s4">.</span><span class="s1">BaseAnchor </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">BaseAnchor</span><span class="s4">[:</span><span class="s1">oldClassCount</span><span class="s4">]</span>
        <span class="s1">newBaseRecord</span><span class="s4">.</span><span class="s1">BaseAnchor </span><span class="s4">= </span><span class="s1">rec</span><span class="s4">.</span><span class="s1">BaseAnchor</span><span class="s4">[</span><span class="s1">oldClassCount</span><span class="s4">:]</span>
        <span class="s1">oldBaseRecords</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">oldBaseRecord</span><span class="s4">)</span>
        <span class="s1">newBaseRecords</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">newBaseRecord</span><span class="s4">)</span>

    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">Format</span>

    <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkCoverage</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">oldMarkCoverage</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">MarkCoverage </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkCoverage</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">MarkCoverage</span><span class="s4">.</span><span class="s1">glyphs </span><span class="s4">= </span><span class="s1">newMarkCoverage</span>

    <span class="s0"># share the same BaseCoverage in both halves</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">BaseCoverage </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">BaseCoverage</span>

    <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">ClassCount </span><span class="s4">= </span><span class="s1">oldClassCount</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">ClassCount </span><span class="s4">= </span><span class="s1">newClassCount</span>

    <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkArray</span><span class="s4">.</span><span class="s1">MarkRecord </span><span class="s4">= </span><span class="s1">oldMarkRecords</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">MarkArray </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkArray</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">MarkArray</span><span class="s4">.</span><span class="s1">MarkRecord </span><span class="s4">= </span><span class="s1">newMarkRecords</span>

    <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">MarkArray</span><span class="s4">.</span><span class="s1">MarkCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldMarkRecords</span><span class="s4">)</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">MarkArray</span><span class="s4">.</span><span class="s1">MarkCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">newMarkRecords</span><span class="s4">)</span>

    <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">BaseArray</span><span class="s4">.</span><span class="s1">BaseRecord </span><span class="s4">= </span><span class="s1">oldBaseRecords</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">BaseArray </span><span class="s4">= </span><span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">BaseArray</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">()</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">BaseArray</span><span class="s4">.</span><span class="s1">BaseRecord </span><span class="s4">= </span><span class="s1">newBaseRecords</span>

    <span class="s1">oldSubTable</span><span class="s4">.</span><span class="s1">BaseArray</span><span class="s4">.</span><span class="s1">BaseCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">oldBaseRecords</span><span class="s4">)</span>
    <span class="s1">newSubTable</span><span class="s4">.</span><span class="s1">BaseArray</span><span class="s4">.</span><span class="s1">BaseCount </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">newBaseRecords</span><span class="s4">)</span>

    <span class="s3">return True</span>


<span class="s1">splitTable </span><span class="s4">= {</span>
    <span class="s6">&quot;GSUB&quot;</span><span class="s4">: {</span>
        <span class="s0">#                   1: splitSingleSubst,</span>
        <span class="s5">2</span><span class="s4">: </span><span class="s1">splitMultipleSubst</span><span class="s4">,</span>
        <span class="s5">3</span><span class="s4">: </span><span class="s1">splitAlternateSubst</span><span class="s4">,</span>
        <span class="s5">4</span><span class="s4">: </span><span class="s1">splitLigatureSubst</span><span class="s4">,</span>
        <span class="s0">#                   5: splitContextSubst,</span>
        <span class="s0">#                   6: splitChainContextSubst,</span>
        <span class="s0">#                   7: splitExtensionSubst,</span>
        <span class="s0">#                   8: splitReverseChainSingleSubst,</span>
    <span class="s4">},</span>
    <span class="s6">&quot;GPOS&quot;</span><span class="s4">: {</span>
        <span class="s0">#                   1: splitSinglePos,</span>
        <span class="s5">2</span><span class="s4">: </span><span class="s1">splitPairPos</span><span class="s4">,</span>
        <span class="s0">#                   3: splitCursivePos,</span>
        <span class="s5">4</span><span class="s4">: </span><span class="s1">splitMarkBasePos</span><span class="s4">,</span>
        <span class="s0">#                   5: splitMarkLigPos,</span>
        <span class="s0">#                   6: splitMarkMarkPos,</span>
        <span class="s0">#                   7: splitContextPos,</span>
        <span class="s0">#                   8: splitChainContextPos,</span>
        <span class="s0">#                   9: splitExtensionPos,</span>
    <span class="s4">},</span>
<span class="s4">}</span>


<span class="s3">def </span><span class="s1">fixSubTableOverFlows</span><span class="s4">(</span><span class="s1">ttf</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    An offset has overflowed within a sub-table. We need to divide this subtable into smaller parts. 
    &quot;&quot;&quot;</span>
    <span class="s1">table </span><span class="s4">= </span><span class="s1">ttf</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">].</span><span class="s1">table</span>
    <span class="s1">lookup </span><span class="s4">= </span><span class="s1">table</span><span class="s4">.</span><span class="s1">LookupList</span><span class="s4">.</span><span class="s1">Lookup</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">LookupListIndex</span><span class="s4">]</span>
    <span class="s1">subIndex </span><span class="s4">= </span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">SubTableIndex</span>
    <span class="s1">subtable </span><span class="s4">= </span><span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">[</span><span class="s1">subIndex</span><span class="s4">]</span>

    <span class="s0"># First, try not sharing anything for this subtable...</span>
    <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">subtable</span><span class="s4">, </span><span class="s6">&quot;DontShare&quot;</span><span class="s4">):</span>
        <span class="s1">subtable</span><span class="s4">.</span><span class="s1">DontShare </span><span class="s4">= </span><span class="s3">True</span>
        <span class="s3">return True</span>

    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">subtable</span><span class="s4">, </span><span class="s6">&quot;ExtSubTable&quot;</span><span class="s4">):</span>
        <span class="s0"># We split the subtable of the Extension table, and add a new Extension table</span>
        <span class="s0"># to contain the new subtable.</span>

        <span class="s1">subTableType </span><span class="s4">= </span><span class="s1">subtable</span><span class="s4">.</span><span class="s1">ExtSubTable</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">LookupType</span>
        <span class="s1">extSubTable </span><span class="s4">= </span><span class="s1">subtable</span>
        <span class="s1">subtable </span><span class="s4">= </span><span class="s1">extSubTable</span><span class="s4">.</span><span class="s1">ExtSubTable</span>
        <span class="s1">newExtSubTableClass </span><span class="s4">= </span><span class="s1">lookupTypes</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">][</span>
            <span class="s1">extSubTable</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">LookupType</span>
        <span class="s4">]</span>
        <span class="s1">newExtSubTable </span><span class="s4">= </span><span class="s1">newExtSubTableClass</span><span class="s4">()</span>
        <span class="s1">newExtSubTable</span><span class="s4">.</span><span class="s1">Format </span><span class="s4">= </span><span class="s1">extSubTable</span><span class="s4">.</span><span class="s1">Format</span>
        <span class="s1">toInsert </span><span class="s4">= </span><span class="s1">newExtSubTable</span>

        <span class="s1">newSubTableClass </span><span class="s4">= </span><span class="s1">lookupTypes</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">][</span><span class="s1">subTableType</span><span class="s4">]</span>
        <span class="s1">newSubTable </span><span class="s4">= </span><span class="s1">newSubTableClass</span><span class="s4">()</span>
        <span class="s1">newExtSubTable</span><span class="s4">.</span><span class="s1">ExtSubTable </span><span class="s4">= </span><span class="s1">newSubTable</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">subTableType </span><span class="s4">= </span><span class="s1">subtable</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">LookupType</span>
        <span class="s1">newSubTableClass </span><span class="s4">= </span><span class="s1">lookupTypes</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">][</span><span class="s1">subTableType</span><span class="s4">]</span>
        <span class="s1">newSubTable </span><span class="s4">= </span><span class="s1">newSubTableClass</span><span class="s4">()</span>
        <span class="s1">toInsert </span><span class="s4">= </span><span class="s1">newSubTable</span>

    <span class="s3">if </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">lookup</span><span class="s4">, </span><span class="s6">&quot;SubTableCount&quot;</span><span class="s4">):  </span><span class="s0"># may not be defined yet.</span>
        <span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTableCount </span><span class="s4">= </span><span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTableCount </span><span class="s4">+ </span><span class="s5">1</span>

    <span class="s3">try</span><span class="s4">:</span>
        <span class="s1">splitFunc </span><span class="s4">= </span><span class="s1">splitTable</span><span class="s4">[</span><span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">][</span><span class="s1">subTableType</span><span class="s4">]</span>
    <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
        <span class="s1">log</span><span class="s4">.</span><span class="s1">error</span><span class="s4">(</span>
            <span class="s6">&quot;Don't know how to split %s lookup type %s&quot;</span><span class="s4">,</span>
            <span class="s1">overflowRecord</span><span class="s4">.</span><span class="s1">tableType</span><span class="s4">,</span>
            <span class="s1">subTableType</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s3">return False</span>

    <span class="s1">ok </span><span class="s4">= </span><span class="s1">splitFunc</span><span class="s4">(</span><span class="s1">subtable</span><span class="s4">, </span><span class="s1">newSubTable</span><span class="s4">, </span><span class="s1">overflowRecord</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">ok</span><span class="s4">:</span>
        <span class="s1">lookup</span><span class="s4">.</span><span class="s1">SubTable</span><span class="s4">.</span><span class="s1">insert</span><span class="s4">(</span><span class="s1">subIndex </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">, </span><span class="s1">toInsert</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">ok</span>


<span class="s0"># End of OverFlow logic</span>


<span class="s3">def </span><span class="s1">_buildClasses</span><span class="s4">():</span>
    <span class="s3">import </span><span class="s1">re</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">otData </span><span class="s3">import </span><span class="s1">otData</span>

    <span class="s1">formatPat </span><span class="s4">= </span><span class="s1">re</span><span class="s4">.</span><span class="s1">compile</span><span class="s4">(</span><span class="s6">r&quot;([A-Za-z0-9]+)Format(\d+)$&quot;</span><span class="s4">)</span>
    <span class="s1">namespace </span><span class="s4">= </span><span class="s1">globals</span><span class="s4">()</span>

    <span class="s0"># populate module with classes</span>
    <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">table </span><span class="s3">in </span><span class="s1">otData</span><span class="s4">:</span>
        <span class="s1">baseClass </span><span class="s4">= </span><span class="s1">BaseTable</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">formatPat</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">m</span><span class="s4">:</span>
            <span class="s0"># XxxFormatN subtable, we only add the &quot;base&quot; table</span>
            <span class="s1">name </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">group</span><span class="s4">(</span><span class="s5">1</span><span class="s4">)</span>
            <span class="s0"># the first row of a format-switching otData table describes the Format;</span>
            <span class="s0"># the first column defines the type of the Format field.</span>
            <span class="s0"># Currently this can be either 'uint16' or 'uint8'.</span>
            <span class="s1">formatType </span><span class="s4">= </span><span class="s1">table</span><span class="s4">[</span><span class="s5">0</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]</span>
            <span class="s1">baseClass </span><span class="s4">= </span><span class="s1">getFormatSwitchingBaseTableClass</span><span class="s4">(</span><span class="s1">formatType</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">name </span><span class="s3">not in </span><span class="s1">namespace</span><span class="s4">:</span>
            <span class="s0"># the class doesn't exist yet, so the base implementation is used.</span>
            <span class="s1">cls </span><span class="s4">= </span><span class="s1">type</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, (</span><span class="s1">baseClass</span><span class="s4">,), {})</span>
            <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s4">(</span><span class="s6">&quot;GSUB&quot;</span><span class="s4">, </span><span class="s6">&quot;GPOS&quot;</span><span class="s4">):</span>
                <span class="s1">cls</span><span class="s4">.</span><span class="s1">DontShare </span><span class="s4">= </span><span class="s3">True</span>
            <span class="s1">namespace</span><span class="s4">[</span><span class="s1">name</span><span class="s4">] = </span><span class="s1">cls</span>

    <span class="s0"># link Var{Table} &lt;-&gt; {Table} (e.g. ColorStop &lt;-&gt; VarColorStop, etc.)</span>
    <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">_ </span><span class="s3">in </span><span class="s1">otData</span><span class="s4">:</span>
        <span class="s3">if </span><span class="s1">name</span><span class="s4">.</span><span class="s1">startswith</span><span class="s4">(</span><span class="s6">&quot;Var&quot;</span><span class="s4">) </span><span class="s3">and </span><span class="s1">len</span><span class="s4">(</span><span class="s1">name</span><span class="s4">) &gt; </span><span class="s5">3 </span><span class="s3">and </span><span class="s1">name</span><span class="s4">[</span><span class="s5">3</span><span class="s4">:] </span><span class="s3">in </span><span class="s1">namespace</span><span class="s4">:</span>
            <span class="s1">varType </span><span class="s4">= </span><span class="s1">namespace</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
            <span class="s1">noVarType </span><span class="s4">= </span><span class="s1">namespace</span><span class="s4">[</span><span class="s1">name</span><span class="s4">[</span><span class="s5">3</span><span class="s4">:]]</span>
            <span class="s1">varType</span><span class="s4">.</span><span class="s1">NoVarType </span><span class="s4">= </span><span class="s1">noVarType</span>
            <span class="s1">noVarType</span><span class="s4">.</span><span class="s1">VarType </span><span class="s4">= </span><span class="s1">varType</span>

    <span class="s3">for </span><span class="s1">base</span><span class="s4">, </span><span class="s1">alts </span><span class="s3">in </span><span class="s1">_equivalents</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
        <span class="s1">base </span><span class="s4">= </span><span class="s1">namespace</span><span class="s4">[</span><span class="s1">base</span><span class="s4">]</span>
        <span class="s3">for </span><span class="s1">alt </span><span class="s3">in </span><span class="s1">alts</span><span class="s4">:</span>
            <span class="s1">namespace</span><span class="s4">[</span><span class="s1">alt</span><span class="s4">] = </span><span class="s1">base</span>

    <span class="s3">global </span><span class="s1">lookupTypes</span>
    <span class="s1">lookupTypes </span><span class="s4">= {</span>
        <span class="s6">&quot;GSUB&quot;</span><span class="s4">: {</span>
            <span class="s5">1</span><span class="s4">: </span><span class="s1">SingleSubst</span><span class="s4">,</span>
            <span class="s5">2</span><span class="s4">: </span><span class="s1">MultipleSubst</span><span class="s4">,</span>
            <span class="s5">3</span><span class="s4">: </span><span class="s1">AlternateSubst</span><span class="s4">,</span>
            <span class="s5">4</span><span class="s4">: </span><span class="s1">LigatureSubst</span><span class="s4">,</span>
            <span class="s5">5</span><span class="s4">: </span><span class="s1">ContextSubst</span><span class="s4">,</span>
            <span class="s5">6</span><span class="s4">: </span><span class="s1">ChainContextSubst</span><span class="s4">,</span>
            <span class="s5">7</span><span class="s4">: </span><span class="s1">ExtensionSubst</span><span class="s4">,</span>
            <span class="s5">8</span><span class="s4">: </span><span class="s1">ReverseChainSingleSubst</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;GPOS&quot;</span><span class="s4">: {</span>
            <span class="s5">1</span><span class="s4">: </span><span class="s1">SinglePos</span><span class="s4">,</span>
            <span class="s5">2</span><span class="s4">: </span><span class="s1">PairPos</span><span class="s4">,</span>
            <span class="s5">3</span><span class="s4">: </span><span class="s1">CursivePos</span><span class="s4">,</span>
            <span class="s5">4</span><span class="s4">: </span><span class="s1">MarkBasePos</span><span class="s4">,</span>
            <span class="s5">5</span><span class="s4">: </span><span class="s1">MarkLigPos</span><span class="s4">,</span>
            <span class="s5">6</span><span class="s4">: </span><span class="s1">MarkMarkPos</span><span class="s4">,</span>
            <span class="s5">7</span><span class="s4">: </span><span class="s1">ContextPos</span><span class="s4">,</span>
            <span class="s5">8</span><span class="s4">: </span><span class="s1">ChainContextPos</span><span class="s4">,</span>
            <span class="s5">9</span><span class="s4">: </span><span class="s1">ExtensionPos</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;mort&quot;</span><span class="s4">: {</span>
            <span class="s5">4</span><span class="s4">: </span><span class="s1">NoncontextualMorph</span><span class="s4">,</span>
        <span class="s4">},</span>
        <span class="s6">&quot;morx&quot;</span><span class="s4">: {</span>
            <span class="s5">0</span><span class="s4">: </span><span class="s1">RearrangementMorph</span><span class="s4">,</span>
            <span class="s5">1</span><span class="s4">: </span><span class="s1">ContextualMorph</span><span class="s4">,</span>
            <span class="s5">2</span><span class="s4">: </span><span class="s1">LigatureMorph</span><span class="s4">,</span>
            <span class="s0"># 3: Reserved,</span>
            <span class="s5">4</span><span class="s4">: </span><span class="s1">NoncontextualMorph</span><span class="s4">,</span>
            <span class="s5">5</span><span class="s4">: </span><span class="s1">InsertionMorph</span><span class="s4">,</span>
        <span class="s4">},</span>
    <span class="s4">}</span>
    <span class="s1">lookupTypes</span><span class="s4">[</span><span class="s6">&quot;JSTF&quot;</span><span class="s4">] = </span><span class="s1">lookupTypes</span><span class="s4">[</span><span class="s6">&quot;GPOS&quot;</span><span class="s4">]  </span><span class="s0"># JSTF contains GPOS</span>
    <span class="s3">for </span><span class="s1">lookupEnum </span><span class="s3">in </span><span class="s1">lookupTypes</span><span class="s4">.</span><span class="s1">values</span><span class="s4">():</span>
        <span class="s3">for </span><span class="s1">enum</span><span class="s4">, </span><span class="s1">cls </span><span class="s3">in </span><span class="s1">lookupEnum</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">LookupType </span><span class="s4">= </span><span class="s1">enum</span>

    <span class="s3">global </span><span class="s1">featureParamTypes</span>
    <span class="s1">featureParamTypes </span><span class="s4">= {</span>
        <span class="s6">&quot;size&quot;</span><span class="s4">: </span><span class="s1">FeatureParamsSize</span><span class="s4">,</span>
    <span class="s4">}</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">20 </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">):</span>
        <span class="s1">featureParamTypes</span><span class="s4">[</span><span class="s6">&quot;ss%02d&quot; </span><span class="s4">% </span><span class="s1">i</span><span class="s4">] = </span><span class="s1">FeatureParamsStylisticSet</span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">99 </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">):</span>
        <span class="s1">featureParamTypes</span><span class="s4">[</span><span class="s6">&quot;cv%02d&quot; </span><span class="s4">% </span><span class="s1">i</span><span class="s4">] = </span><span class="s1">FeatureParamsCharacterVariants</span>

    <span class="s0"># add converters to classes</span>
    <span class="s3">from </span><span class="s4">.</span><span class="s1">otConverters </span><span class="s3">import </span><span class="s1">buildConverters</span>

    <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">table </span><span class="s3">in </span><span class="s1">otData</span><span class="s4">:</span>
        <span class="s1">m </span><span class="s4">= </span><span class="s1">formatPat</span><span class="s4">.</span><span class="s1">match</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">m</span><span class="s4">:</span>
            <span class="s0"># XxxFormatN subtable, add converter to &quot;base&quot; table</span>
            <span class="s1">name</span><span class="s4">, </span><span class="s1">format </span><span class="s4">= </span><span class="s1">m</span><span class="s4">.</span><span class="s1">groups</span><span class="s4">()</span>
            <span class="s1">format </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">format</span><span class="s4">)</span>
            <span class="s1">cls </span><span class="s4">= </span><span class="s1">namespace</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
            <span class="s3">if not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">cls</span><span class="s4">, </span><span class="s6">&quot;converters&quot;</span><span class="s4">):</span>
                <span class="s1">cls</span><span class="s4">.</span><span class="s1">converters </span><span class="s4">= {}</span>
                <span class="s1">cls</span><span class="s4">.</span><span class="s1">convertersByName </span><span class="s4">= {}</span>
            <span class="s1">converters</span><span class="s4">, </span><span class="s1">convertersByName </span><span class="s4">= </span><span class="s1">buildConverters</span><span class="s4">(</span><span class="s1">table</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:], </span><span class="s1">namespace</span><span class="s4">)</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">converters</span><span class="s4">[</span><span class="s1">format</span><span class="s4">] = </span><span class="s1">converters</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">convertersByName</span><span class="s4">[</span><span class="s1">format</span><span class="s4">] = </span><span class="s1">convertersByName</span>
            <span class="s0"># XXX Add staticSize?</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">cls </span><span class="s4">= </span><span class="s1">namespace</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
            <span class="s1">cls</span><span class="s4">.</span><span class="s1">converters</span><span class="s4">, </span><span class="s1">cls</span><span class="s4">.</span><span class="s1">convertersByName </span><span class="s4">= </span><span class="s1">buildConverters</span><span class="s4">(</span><span class="s1">table</span><span class="s4">, </span><span class="s1">namespace</span><span class="s4">)</span>
            <span class="s0"># XXX Add staticSize?</span>


<span class="s1">_buildClasses</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">_getGlyphsFromCoverageTable</span><span class="s4">(</span><span class="s1">coverage</span><span class="s4">):</span>
    <span class="s3">if </span><span class="s1">coverage </span><span class="s3">is None</span><span class="s4">:</span>
        <span class="s0"># empty coverage table</span>
        <span class="s3">return </span><span class="s4">[]</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s3">return </span><span class="s1">coverage</span><span class="s4">.</span><span class="s1">glyphs</span>
</pre>
</body>
</html>