<html>
<head>
<title>test_optics.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_optics.py</font>
</center></td></tr></table>
<pre><span class="s0"># Authors: Shane Grigsby &lt;refuge@rocktalus.com&gt;</span>
<span class="s0">#          Adrin Jalali &lt;adrin.jalali@gmail.com&gt;</span>
<span class="s0"># License: BSD 3 clause</span>
<span class="s2">import </span><span class="s1">warnings</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">cluster </span><span class="s2">import </span><span class="s1">DBSCAN</span><span class="s3">, </span><span class="s1">OPTICS</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">_optics </span><span class="s2">import </span><span class="s1">_extend_region</span><span class="s3">, </span><span class="s1">_extract_xi_labels</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">cluster</span><span class="s3">.</span><span class="s1">tests</span><span class="s3">.</span><span class="s1">common </span><span class="s2">import </span><span class="s1">generate_clustered_data</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">datasets </span><span class="s2">import </span><span class="s1">make_blobs</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">exceptions </span><span class="s2">import </span><span class="s1">DataConversionWarning</span><span class="s3">, </span><span class="s1">EfficiencyWarning</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">cluster </span><span class="s2">import </span><span class="s1">contingency_matrix</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">metrics</span><span class="s3">.</span><span class="s1">pairwise </span><span class="s2">import </span><span class="s1">pairwise_distances</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">shuffle</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">_testing </span><span class="s2">import </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_array_equal</span>
<span class="s2">from </span><span class="s1">sklearn</span><span class="s3">.</span><span class="s1">utils</span><span class="s3">.</span><span class="s1">fixes </span><span class="s2">import </span><span class="s1">CSR_CONTAINERS</span>

<span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
<span class="s1">n_points_per_cluster </span><span class="s3">= </span><span class="s4">10</span>
<span class="s1">C1 </span><span class="s3">= [-</span><span class="s4">5</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.8 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
<span class="s1">C2 </span><span class="s3">= [</span><span class="s4">4</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">] + </span><span class="s4">0.1 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
<span class="s1">C3 </span><span class="s3">= [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
<span class="s1">C4 </span><span class="s3">= [-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">] + </span><span class="s4">0.3 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
<span class="s1">C5 </span><span class="s3">= [</span><span class="s4">3</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">1.6 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
<span class="s1">C6 </span><span class="s3">= [</span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">] + </span><span class="s4">2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
<span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">, </span><span class="s1">C3</span><span class="s3">, </span><span class="s1">C4</span><span class="s3">, </span><span class="s1">C5</span><span class="s3">, </span><span class="s1">C6</span><span class="s3">))</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s3">(</span><span class="s5">&quot;r_plot&quot;</span><span class="s3">, </span><span class="s5">&quot;end&quot;</span><span class="s3">),</span>
    <span class="s3">[</span>
        <span class="s3">[[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">8.9</span><span class="s3">, </span><span class="s4">8.8</span><span class="s3">, </span><span class="s4">8.7</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">10</span><span class="s3">], </span><span class="s4">3</span><span class="s3">],</span>
        <span class="s3">[[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">8.9</span><span class="s3">, </span><span class="s4">8.8</span><span class="s3">, </span><span class="s4">8.7</span><span class="s3">, </span><span class="s4">8.6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">10</span><span class="s3">], </span><span class="s4">0</span><span class="s3">],</span>
        <span class="s3">[[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">8.9</span><span class="s3">, </span><span class="s4">8.8</span><span class="s3">, </span><span class="s4">8.7</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">4</span><span class="s3">],</span>
        <span class="s3">[[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">8.9</span><span class="s3">, </span><span class="s4">8.8</span><span class="s3">, </span><span class="s4">8.7</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">4</span><span class="s3">],</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_extend_downward</span><span class="s3">(</span><span class="s1">r_plot</span><span class="s3">, </span><span class="s1">end</span><span class="s3">):</span>
    <span class="s1">r_plot </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">r_plot</span><span class="s3">)</span>
    <span class="s1">ratio </span><span class="s3">= </span><span class="s1">r_plot</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">] / </span><span class="s1">r_plot</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:]</span>
    <span class="s1">steep_downward </span><span class="s3">= </span><span class="s1">ratio </span><span class="s3">&gt;= </span><span class="s4">1 </span><span class="s3">/ </span><span class="s4">0.9</span>
    <span class="s1">upward </span><span class="s3">= </span><span class="s1">ratio </span><span class="s3">&lt; </span><span class="s4">1</span>

    <span class="s1">e </span><span class="s3">= </span><span class="s1">_extend_region</span><span class="s3">(</span><span class="s1">steep_downward</span><span class="s3">, </span><span class="s1">upward</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">e </span><span class="s3">== </span><span class="s1">end</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s3">(</span><span class="s5">&quot;r_plot&quot;</span><span class="s3">, </span><span class="s5">&quot;end&quot;</span><span class="s3">),</span>
    <span class="s3">[</span>
        <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2.1</span><span class="s3">, </span><span class="s4">2.2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">6</span><span class="s3">],</span>
        <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2.1</span><span class="s3">, </span><span class="s4">2.2</span><span class="s3">, </span><span class="s4">2.3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">0</span><span class="s3">],</span>
        <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2.1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">0</span><span class="s3">],</span>
        <span class="s3">[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2.1</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">], </span><span class="s4">2</span><span class="s3">],</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_extend_upward</span><span class="s3">(</span><span class="s1">r_plot</span><span class="s3">, </span><span class="s1">end</span><span class="s3">):</span>
    <span class="s1">r_plot </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">r_plot</span><span class="s3">)</span>
    <span class="s1">ratio </span><span class="s3">= </span><span class="s1">r_plot</span><span class="s3">[:-</span><span class="s4">1</span><span class="s3">] / </span><span class="s1">r_plot</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:]</span>
    <span class="s1">steep_upward </span><span class="s3">= </span><span class="s1">ratio </span><span class="s3">&lt;= </span><span class="s4">0.9</span>
    <span class="s1">downward </span><span class="s3">= </span><span class="s1">ratio </span><span class="s3">&gt; </span><span class="s4">1</span>

    <span class="s1">e </span><span class="s3">= </span><span class="s1">_extend_region</span><span class="s3">(</span><span class="s1">steep_upward</span><span class="s3">, </span><span class="s1">downward</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">e </span><span class="s3">== </span><span class="s1">end</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s3">(</span><span class="s5">&quot;ordering&quot;</span><span class="s3">, </span><span class="s5">&quot;clusters&quot;</span><span class="s3">, </span><span class="s5">&quot;expected&quot;</span><span class="s3">),</span>
    <span class="s3">[</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]],</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]],</span>
        <span class="s3">[[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]],</span>
        <span class="s3">[[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]], [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]],</span>
    <span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_the_extract_xi_labels</span><span class="s3">(</span><span class="s1">ordering</span><span class="s3">, </span><span class="s1">clusters</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">):</span>
    <span class="s1">labels </span><span class="s3">= </span><span class="s1">_extract_xi_labels</span><span class="s3">(</span><span class="s1">ordering</span><span class="s3">, </span><span class="s1">clusters</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">labels</span><span class="s3">, </span><span class="s1">expected</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_extract_xi</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">):</span>
    <span class="s0"># small and easy test (no clusters around other clusters)</span>
    <span class="s0"># but with a clear noise data.</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_points_per_cluster </span><span class="s3">= </span><span class="s4">5</span>

    <span class="s1">C1 </span><span class="s3">= [-</span><span class="s4">5</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.8 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C2 </span><span class="s3">= [</span><span class="s4">4</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">] + </span><span class="s4">0.1 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C3 </span><span class="s3">= [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C4 </span><span class="s3">= [-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">] + </span><span class="s4">0.3 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C5 </span><span class="s3">= [</span><span class="s4">3</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.6 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C6 </span><span class="s3">= [</span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">, </span><span class="s1">C3</span><span class="s3">, </span><span class="s1">C4</span><span class="s3">, </span><span class="s1">C5</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">100</span><span class="s3">, </span><span class="s4">100</span><span class="s3">]]), </span><span class="s1">C6</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span>
        <span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">)</span>
    <span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[[</span><span class="s4">2</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">3</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, [</span><span class="s4">4</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>

    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span>
        <span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">20</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.4</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>

    <span class="s0"># check float min_samples and min_cluster_size</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span>
        <span class="s1">min_samples</span><span class="s3">=</span><span class="s4">0.1</span><span class="s3">, </span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s4">0.08</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">20</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.4</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">, </span><span class="s1">C3</span><span class="s3">, </span><span class="s1">C4</span><span class="s3">, </span><span class="s1">C5</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">100</span><span class="s3">, </span><span class="s4">100</span><span class="s3">]] * </span><span class="s4">2</span><span class="s3">), </span><span class="s1">C6</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span>
        <span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">)</span>
    <span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[</span>
        <span class="s3">[</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">3</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">2</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, [</span><span class="s4">2</span><span class="s3">] * </span><span class="s4">5</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">, [</span><span class="s4">4</span><span class="s3">] * </span><span class="s4">5</span>
    <span class="s3">]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>

    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span>
        <span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">20</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.3</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s0"># this may fail if the predecessor correction is not at work!</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>

    <span class="s1">C1 </span><span class="s3">= [[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, -</span><span class="s4">0.1</span><span class="s3">], [</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">]]</span>
    <span class="s1">C2 </span><span class="s3">= [[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">], [</span><span class="s4">10</span><span class="s3">, </span><span class="s4">9</span><span class="s3">], [</span><span class="s4">10</span><span class="s3">, </span><span class="s4">11</span><span class="s3">], [</span><span class="s4">9</span><span class="s3">, </span><span class="s4">10</span><span class="s3">]]</span>
    <span class="s1">C3 </span><span class="s3">= [[</span><span class="s4">100</span><span class="s3">, </span><span class="s4">100</span><span class="s3">], [</span><span class="s4">100</span><span class="s3">, </span><span class="s4">90</span><span class="s3">], [</span><span class="s4">100</span><span class="s3">, </span><span class="s4">110</span><span class="s3">], [</span><span class="s4">90</span><span class="s3">, </span><span class="s4">100</span><span class="s3">]]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">, </span><span class="s1">C3</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[[</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">4</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">4</span><span class="s3">, [</span><span class="s4">2</span><span class="s3">] * </span><span class="s4">4</span><span class="s3">]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s1">rng</span><span class="s3">)</span>

    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span>
        <span class="s1">min_samples</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.04</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_cluster_hierarchy_</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">):</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_points_per_cluster </span><span class="s3">= </span><span class="s4">100</span>
    <span class="s1">C1 </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">] + </span><span class="s4">2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span>
        <span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">)</span>
    <span class="s1">C2 </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">] + </span><span class="s4">50 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">).</span><span class="s1">astype</span><span class="s3">(</span>
        <span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span>
    <span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">))</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">shuffle</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)</span>

    <span class="s1">clusters </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">20</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.1</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">).</span><span class="s1">cluster_hierarchy_</span>
    <span class="s2">assert </span><span class="s1">clusters</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">diff </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">clusters </span><span class="s3">- </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">99</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">199</span><span class="s3">]]))</span>
    <span class="s2">assert </span><span class="s1">diff </span><span class="s3">/ </span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) &lt; </span><span class="s4">0.05</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;csr_container, metric&quot;</span><span class="s3">,</span>
    <span class="s3">[(</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;minkowski&quot;</span><span class="s3">)] + [(</span><span class="s1">container</span><span class="s3">, </span><span class="s5">&quot;euclidean&quot;</span><span class="s3">) </span><span class="s2">for </span><span class="s1">container </span><span class="s2">in </span><span class="s1">CSR_CONTAINERS</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_correct_number_of_clusters</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># in 'auto' mode</span>

    <span class="s1">n_clusters </span><span class="s3">= </span><span class="s4">3</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">generate_clustered_data</span><span class="s3">(</span><span class="s1">n_clusters</span><span class="s3">=</span><span class="s1">n_clusters</span><span class="s3">)</span>
    <span class="s0"># Parameters chosen specifically for this task.</span>
    <span class="s0"># Compute OPTICS</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">5.0 </span><span class="s3">* </span><span class="s4">6.0</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">4</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span><span class="s3">)</span>
    <span class="s1">clust</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) </span><span class="s2">if </span><span class="s1">csr_container </span><span class="s2">is not None else </span><span class="s1">X</span><span class="s3">)</span>
    <span class="s0"># number of clusters, ignoring noise if present</span>
    <span class="s1">n_clusters_1 </span><span class="s3">= </span><span class="s1">len</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)) - </span><span class="s1">int</span><span class="s3">(-</span><span class="s4">1 </span><span class="s2">in </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">n_clusters_1 </span><span class="s3">== </span><span class="s1">n_clusters</span>

    <span class="s0"># check attribute types and sizes</span>
    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">),)</span>
    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s5">&quot;i&quot;</span>

    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">),)</span>
    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s5">&quot;f&quot;</span>

    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">core_distances_</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">),)</span>
    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">core_distances_</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s5">&quot;f&quot;</span>

    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">.</span><span class="s1">shape </span><span class="s3">== (</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">),)</span>
    <span class="s2">assert </span><span class="s1">clust</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">.</span><span class="s1">dtype</span><span class="s3">.</span><span class="s1">kind </span><span class="s3">== </span><span class="s5">&quot;i&quot;</span>
    <span class="s2">assert </span><span class="s1">set</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">) == </span><span class="s1">set</span><span class="s3">(</span><span class="s1">range</span><span class="s3">(</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)))</span>


<span class="s2">def </span><span class="s1">test_minimum_number_of_sample_check</span><span class="s3">():</span>
    <span class="s0"># test that we check a minimum number of samples</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;min_samples must be no greater than&quot;</span>

    <span class="s0"># Compute OPTICS</span>
    <span class="s1">X </span><span class="s3">= [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">5.0 </span><span class="s3">* </span><span class="s4">0.3</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">10</span><span class="s3">, </span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s4">1.0</span><span class="s3">)</span>

    <span class="s0"># Run the fit</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clust</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_bad_extract</span><span class="s3">():</span>
    <span class="s0"># Test an extraction of eps too close to original eps</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;Specify an epsilon smaller than 0.15. Got 0.3.&quot;</span>
    <span class="s1">centers </span><span class="s3">= [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">labels_true </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">750</span><span class="s3">, </span><span class="s1">centers</span><span class="s3">=</span><span class="s1">centers</span><span class="s3">, </span><span class="s1">cluster_std</span><span class="s3">=</span><span class="s4">0.4</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span>
    <span class="s3">)</span>

    <span class="s0"># Compute OPTICS</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">5.0 </span><span class="s3">* </span><span class="s4">0.03</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;dbscan&quot;</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s4">0.3</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">10</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clust</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_bad_reachability</span><span class="s3">():</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">&quot;All reachability values are inf. Set a larger max_eps.&quot;</span>
    <span class="s1">centers </span><span class="s3">= [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">labels_true </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">750</span><span class="s3">, </span><span class="s1">centers</span><span class="s3">=</span><span class="s1">centers</span><span class="s3">, </span><span class="s1">cluster_std</span><span class="s3">=</span><span class="s4">0.4</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span>
    <span class="s3">)</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">):</span>
        <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">5.0 </span><span class="s3">* </span><span class="s4">0.003</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">10</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s4">0.015</span><span class="s3">)</span>
        <span class="s1">clust</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_nowarn_if_metric_bool_data_bool</span><span class="s3">():</span>
    <span class="s0"># make sure no warning is raised if metric and data are both boolean</span>
    <span class="s0"># non-regression test for</span>
    <span class="s0"># https://github.com/scikit-learn/scikit-learn/issues/18996</span>

    <span class="s1">pairwise_metric </span><span class="s3">= </span><span class="s5">&quot;rogerstanimoto&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, </span><span class="s1">DataConversionWarning</span><span class="s3">)</span>

        <span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">=</span><span class="s1">pairwise_metric</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_warn_if_metric_bool_data_no_bool</span><span class="s3">():</span>
    <span class="s0"># make sure a *single* conversion warning is raised if metric is boolean</span>
    <span class="s0"># but data isn't</span>
    <span class="s0"># non-regression test for</span>
    <span class="s0"># https://github.com/scikit-learn/scikit-learn/issues/18996</span>

    <span class="s1">pairwise_metric </span><span class="s3">= </span><span class="s5">&quot;rogerstanimoto&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>
    <span class="s1">msg </span><span class="s3">= </span><span class="s5">f&quot;Data will be converted to boolean for metric </span><span class="s2">{</span><span class="s1">pairwise_metric</span><span class="s2">}</span><span class="s5">&quot;</span>

    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">DataConversionWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s1">msg</span><span class="s3">) </span><span class="s2">as </span><span class="s1">warn_record</span><span class="s3">:</span>
        <span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">=</span><span class="s1">pairwise_metric</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s2">assert </span><span class="s1">len</span><span class="s3">(</span><span class="s1">warn_record</span><span class="s3">) == </span><span class="s4">1</span>


<span class="s2">def </span><span class="s1">test_nowarn_if_metric_no_bool</span><span class="s3">():</span>
    <span class="s0"># make sure no conversion warning is raised if</span>
    <span class="s0"># metric isn't boolean, no matter what the data type is</span>
    <span class="s1">pairwise_metric </span><span class="s3">= </span><span class="s5">&quot;minkowski&quot;</span>
    <span class="s1">X_bool </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">bool</span><span class="s3">)</span>
    <span class="s1">X_num </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">randint</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">size</span><span class="s3">=(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">2</span><span class="s3">), </span><span class="s1">dtype</span><span class="s3">=</span><span class="s1">np</span><span class="s3">.</span><span class="s1">int32</span><span class="s3">)</span>

    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;error&quot;</span><span class="s3">, </span><span class="s1">DataConversionWarning</span><span class="s3">)</span>

        <span class="s0"># fit boolean data</span>
        <span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">=</span><span class="s1">pairwise_metric</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_bool</span><span class="s3">)</span>
        <span class="s0"># fit numeric data</span>
        <span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">=</span><span class="s1">pairwise_metric</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_num</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">test_close_extract</span><span class="s3">():</span>
    <span class="s0"># Test extract where extraction eps is close to scaled max_eps</span>

    <span class="s1">centers </span><span class="s3">= [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">labels_true </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">750</span><span class="s3">, </span><span class="s1">centers</span><span class="s3">=</span><span class="s1">centers</span><span class="s3">, </span><span class="s1">cluster_std</span><span class="s3">=</span><span class="s4">0.4</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span>
    <span class="s3">)</span>

    <span class="s0"># Compute OPTICS</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;dbscan&quot;</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s4">0.3</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">10</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s0"># Cluster ordering starts at 0; max cluster label = 2 is 3 clusters</span>
    <span class="s2">assert </span><span class="s1">max</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">) == </span><span class="s4">2</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;eps&quot;</span><span class="s3">, [</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.3</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;min_samples&quot;</span><span class="s3">, [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">20</span><span class="s3">])</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span>
    <span class="s5">&quot;csr_container, metric&quot;</span><span class="s3">,</span>
    <span class="s3">[(</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;minkowski&quot;</span><span class="s3">), (</span><span class="s2">None</span><span class="s3">, </span><span class="s5">&quot;euclidean&quot;</span><span class="s3">)]</span>
    <span class="s3">+ [(</span><span class="s1">container</span><span class="s3">, </span><span class="s5">&quot;euclidean&quot;</span><span class="s3">) </span><span class="s2">for </span><span class="s1">container </span><span class="s2">in </span><span class="s1">CSR_CONTAINERS</span><span class="s3">],</span>
<span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_dbscan_optics_parity</span><span class="s3">(</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">, </span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s0"># Test that OPTICS clustering labels are &lt;= 5% difference of DBSCAN</span>

    <span class="s1">centers </span><span class="s3">= [[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">], [-</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">], [</span><span class="s4">1</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">]]</span>
    <span class="s1">X</span><span class="s3">, </span><span class="s1">labels_true </span><span class="s3">= </span><span class="s1">make_blobs</span><span class="s3">(</span>
        <span class="s1">n_samples</span><span class="s3">=</span><span class="s4">150</span><span class="s3">, </span><span class="s1">centers</span><span class="s3">=</span><span class="s1">centers</span><span class="s3">, </span><span class="s1">cluster_std</span><span class="s3">=</span><span class="s4">0.4</span><span class="s3">, </span><span class="s1">random_state</span><span class="s3">=</span><span class="s4">0</span>
    <span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) </span><span class="s2">if </span><span class="s1">csr_container </span><span class="s2">is not None else </span><span class="s1">X</span>

    <span class="s1">X </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s0"># calculate optics with dbscan extract at 0.3 epsilon</span>
    <span class="s1">op </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span>
        <span class="s1">min_samples</span><span class="s3">=</span><span class="s1">min_samples</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;dbscan&quot;</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s1">metric</span>
    <span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s0"># calculate dbscan labels</span>
    <span class="s1">db </span><span class="s3">= </span><span class="s1">DBSCAN</span><span class="s3">(</span><span class="s1">eps</span><span class="s3">=</span><span class="s1">eps</span><span class="s3">, </span><span class="s1">min_samples</span><span class="s3">=</span><span class="s1">min_samples</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">contingency </span><span class="s3">= </span><span class="s1">contingency_matrix</span><span class="s3">(</span><span class="s1">db</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">op</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)</span>
    <span class="s1">agree </span><span class="s3">= </span><span class="s1">min</span><span class="s3">(</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">contingency</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">0</span><span class="s3">)), </span><span class="s1">np</span><span class="s3">.</span><span class="s1">sum</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">max</span><span class="s3">(</span><span class="s1">contingency</span><span class="s3">, </span><span class="s1">axis</span><span class="s3">=</span><span class="s4">1</span><span class="s3">))</span>
    <span class="s3">)</span>
    <span class="s1">disagree </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] - </span><span class="s1">agree</span>

    <span class="s1">percent_mismatch </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">round</span><span class="s3">((</span><span class="s1">disagree </span><span class="s3">- </span><span class="s4">1</span><span class="s3">) / </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">], </span><span class="s4">2</span><span class="s3">)</span>

    <span class="s0"># verify label mismatch is &lt;= 5% labels</span>
    <span class="s2">assert </span><span class="s1">percent_mismatch </span><span class="s3">&lt;= </span><span class="s4">0.05</span>


<span class="s2">def </span><span class="s1">test_min_samples_edge_case</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">):</span>
    <span class="s1">C1 </span><span class="s3">= [[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">], [</span><span class="s4">0</span><span class="s3">, -</span><span class="s4">0.1</span><span class="s3">]]</span>
    <span class="s1">C2 </span><span class="s3">= [[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">], [</span><span class="s4">10</span><span class="s3">, </span><span class="s4">9</span><span class="s3">], [</span><span class="s4">10</span><span class="s3">, </span><span class="s4">11</span><span class="s3">]]</span>
    <span class="s1">C3 </span><span class="s3">= [[</span><span class="s4">100</span><span class="s3">, </span><span class="s4">100</span><span class="s3">], [</span><span class="s4">100</span><span class="s3">, </span><span class="s4">96</span><span class="s3">], [</span><span class="s4">100</span><span class="s3">, </span><span class="s4">106</span><span class="s3">]]</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">, </span><span class="s1">C3</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[[</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">3</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">3</span><span class="s3">, [</span><span class="s4">2</span><span class="s3">] * </span><span class="s4">3</span><span class="s3">]</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">7</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.04</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>

    <span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[[</span><span class="s4">0</span><span class="s3">] * </span><span class="s4">3</span><span class="s3">, [</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">3</span><span class="s3">, [-</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">3</span><span class="s3">]</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.04</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>

    <span class="s1">expected_labels </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">r_</span><span class="s3">[[-</span><span class="s4">1</span><span class="s3">] * </span><span class="s4">9</span><span class="s3">]</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">warns</span><span class="s3">(</span><span class="s1">UserWarning</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;All reachability values&quot;</span><span class="s3">):</span>
        <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">4</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;xi&quot;</span><span class="s3">, </span><span class="s1">xi</span><span class="s3">=</span><span class="s4">0.04</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
        <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">expected_labels</span><span class="s3">)</span>


<span class="s0"># try arbitrary minimum sizes</span>
<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;min_cluster_size&quot;</span><span class="s3">, </span><span class="s1">range</span><span class="s3">(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">X</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">] // </span><span class="s4">10</span><span class="s3">, </span><span class="s4">23</span><span class="s3">))</span>
<span class="s2">def </span><span class="s1">test_min_cluster_size</span><span class="s3">(</span><span class="s1">min_cluster_size</span><span class="s3">, </span><span class="s1">global_dtype</span><span class="s3">):</span>
    <span class="s1">redX </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[::</span><span class="s4">2</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)  </span><span class="s0"># reduce for speed</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">9</span><span class="s3">, </span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s1">min_cluster_size</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">redX</span><span class="s3">)</span>
    <span class="s1">cluster_sizes </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">bincount</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">[</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_ </span><span class="s3">!= -</span><span class="s4">1</span><span class="s3">])</span>
    <span class="s2">if </span><span class="s1">cluster_sizes</span><span class="s3">.</span><span class="s1">size</span><span class="s3">:</span>
        <span class="s2">assert </span><span class="s1">min</span><span class="s3">(</span><span class="s1">cluster_sizes</span><span class="s3">) &gt;= </span><span class="s1">min_cluster_size</span>
    <span class="s0"># check behaviour is the same when min_cluster_size is a fraction</span>
    <span class="s1">clust_frac </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span>
        <span class="s1">min_samples</span><span class="s3">=</span><span class="s4">9</span><span class="s3">,</span>
        <span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s1">min_cluster_size </span><span class="s3">/ </span><span class="s1">redX</span><span class="s3">.</span><span class="s1">shape</span><span class="s3">[</span><span class="s4">0</span><span class="s3">],</span>
    <span class="s3">)</span>
    <span class="s1">clust_frac</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">redX</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">clust_frac</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_min_cluster_size_invalid2</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) + </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;must be no greater than the &quot;</span><span class="s3">):</span>
        <span class="s1">clust</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_cluster_size</span><span class="s3">=</span><span class="s1">len</span><span class="s3">(</span><span class="s1">X</span><span class="s3">) + </span><span class="s4">1</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s3">)</span>
    <span class="s2">with </span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">raises</span><span class="s3">(</span><span class="s1">ValueError</span><span class="s3">, </span><span class="s1">match</span><span class="s3">=</span><span class="s5">&quot;must be no greater than the &quot;</span><span class="s3">):</span>
        <span class="s1">clust</span><span class="s3">.</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">))</span>


<span class="s2">def </span><span class="s1">test_processing_order</span><span class="s3">():</span>
    <span class="s0"># Ensure that we consider all unprocessed points,</span>
    <span class="s0"># not only direct neighbors. when picking the next point.</span>
    <span class="s1">Y </span><span class="s3">= [[</span><span class="s4">0</span><span class="s3">], [</span><span class="s4">10</span><span class="s3">], [-</span><span class="s4">10</span><span class="s3">], [</span><span class="s4">25</span><span class="s3">]]</span>

    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">15</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">Y</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">, [</span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">15</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">core_distances_</span><span class="s3">, [</span><span class="s4">10</span><span class="s3">, </span><span class="s4">15</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">])</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">, [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_compare_to_ELKI</span><span class="s3">():</span>
    <span class="s0"># Expected values, computed with (future) ELKI 0.7.5 using:</span>
    <span class="s0"># java -jar elki.jar cli -dbc.in csv -dbc.filter FixedDBIDsFilter</span>
    <span class="s0">#   -algorithm clustering.optics.OPTICSHeap -optics.minpts 5</span>
    <span class="s0"># where the FixedDBIDsFilter gives 0-indexed ids.</span>
    <span class="s1">r1 </span><span class="s3">= [</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s4">1.0574896366427478</span><span class="s3">,</span>
        <span class="s4">0.7587934993548423</span><span class="s3">,</span>
        <span class="s4">0.7290174038973836</span><span class="s3">,</span>
        <span class="s4">0.7290174038973836</span><span class="s3">,</span>
        <span class="s4">0.7290174038973836</span><span class="s3">,</span>
        <span class="s4">0.6861627576116127</span><span class="s3">,</span>
        <span class="s4">0.7587934993548423</span><span class="s3">,</span>
        <span class="s4">0.9280118450166668</span><span class="s3">,</span>
        <span class="s4">1.1748022534146194</span><span class="s3">,</span>
        <span class="s4">3.3355455741292257</span><span class="s3">,</span>
        <span class="s4">0.49618389254482587</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.24944622248445714</span><span class="s3">,</span>
        <span class="s4">0.24944622248445714</span><span class="s3">,</span>
        <span class="s4">0.24944622248445714</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.3086779122185853</span><span class="s3">,</span>
        <span class="s4">4.163024452756142</span><span class="s3">,</span>
        <span class="s4">1.623152630340929</span><span class="s3">,</span>
        <span class="s4">0.45315840475822655</span><span class="s3">,</span>
        <span class="s4">0.25468325192031926</span><span class="s3">,</span>
        <span class="s4">0.2254004358159971</span><span class="s3">,</span>
        <span class="s4">0.18765711877083036</span><span class="s3">,</span>
        <span class="s4">0.1821471333893275</span><span class="s3">,</span>
        <span class="s4">0.1821471333893275</span><span class="s3">,</span>
        <span class="s4">0.18765711877083036</span><span class="s3">,</span>
        <span class="s4">0.18765711877083036</span><span class="s3">,</span>
        <span class="s4">0.2240202988740153</span><span class="s3">,</span>
        <span class="s4">1.154337614548715</span><span class="s3">,</span>
        <span class="s4">1.342604473837069</span><span class="s3">,</span>
        <span class="s4">1.323308536402633</span><span class="s3">,</span>
        <span class="s4">0.8607514948648837</span><span class="s3">,</span>
        <span class="s4">0.27219111215810565</span><span class="s3">,</span>
        <span class="s4">0.13260875220533205</span><span class="s3">,</span>
        <span class="s4">0.13260875220533205</span><span class="s3">,</span>
        <span class="s4">0.09890587675958984</span><span class="s3">,</span>
        <span class="s4">0.09890587675958984</span><span class="s3">,</span>
        <span class="s4">0.13548790801634494</span><span class="s3">,</span>
        <span class="s4">0.1575483940837384</span><span class="s3">,</span>
        <span class="s4">0.17515137170530226</span><span class="s3">,</span>
        <span class="s4">0.17575920159442388</span><span class="s3">,</span>
        <span class="s4">0.27219111215810565</span><span class="s3">,</span>
        <span class="s4">0.6101447895405373</span><span class="s3">,</span>
        <span class="s4">1.3189208094864302</span><span class="s3">,</span>
        <span class="s4">1.323308536402633</span><span class="s3">,</span>
        <span class="s4">2.2509184159764577</span><span class="s3">,</span>
        <span class="s4">2.4517810628594527</span><span class="s3">,</span>
        <span class="s4">3.675977064404973</span><span class="s3">,</span>
        <span class="s4">3.8264795626020365</span><span class="s3">,</span>
        <span class="s4">2.9130735341510614</span><span class="s3">,</span>
        <span class="s4">2.9130735341510614</span><span class="s3">,</span>
        <span class="s4">2.9130735341510614</span><span class="s3">,</span>
        <span class="s4">2.9130735341510614</span><span class="s3">,</span>
        <span class="s4">2.8459300127258036</span><span class="s3">,</span>
        <span class="s4">2.8459300127258036</span><span class="s3">,</span>
        <span class="s4">2.8459300127258036</span><span class="s3">,</span>
        <span class="s4">3.0321982337972537</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s1">o1 </span><span class="s3">= [</span>
        <span class="s4">0</span><span class="s3">,</span>
        <span class="s4">3</span><span class="s3">,</span>
        <span class="s4">6</span><span class="s3">,</span>
        <span class="s4">4</span><span class="s3">,</span>
        <span class="s4">7</span><span class="s3">,</span>
        <span class="s4">8</span><span class="s3">,</span>
        <span class="s4">2</span><span class="s3">,</span>
        <span class="s4">9</span><span class="s3">,</span>
        <span class="s4">5</span><span class="s3">,</span>
        <span class="s4">1</span><span class="s3">,</span>
        <span class="s4">31</span><span class="s3">,</span>
        <span class="s4">30</span><span class="s3">,</span>
        <span class="s4">32</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">33</span><span class="s3">,</span>
        <span class="s4">38</span><span class="s3">,</span>
        <span class="s4">39</span><span class="s3">,</span>
        <span class="s4">35</span><span class="s3">,</span>
        <span class="s4">37</span><span class="s3">,</span>
        <span class="s4">36</span><span class="s3">,</span>
        <span class="s4">44</span><span class="s3">,</span>
        <span class="s4">21</span><span class="s3">,</span>
        <span class="s4">23</span><span class="s3">,</span>
        <span class="s4">24</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">27</span><span class="s3">,</span>
        <span class="s4">29</span><span class="s3">,</span>
        <span class="s4">26</span><span class="s3">,</span>
        <span class="s4">28</span><span class="s3">,</span>
        <span class="s4">20</span><span class="s3">,</span>
        <span class="s4">40</span><span class="s3">,</span>
        <span class="s4">45</span><span class="s3">,</span>
        <span class="s4">46</span><span class="s3">,</span>
        <span class="s4">10</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">11</span><span class="s3">,</span>
        <span class="s4">13</span><span class="s3">,</span>
        <span class="s4">17</span><span class="s3">,</span>
        <span class="s4">19</span><span class="s3">,</span>
        <span class="s4">18</span><span class="s3">,</span>
        <span class="s4">12</span><span class="s3">,</span>
        <span class="s4">16</span><span class="s3">,</span>
        <span class="s4">14</span><span class="s3">,</span>
        <span class="s4">47</span><span class="s3">,</span>
        <span class="s4">49</span><span class="s3">,</span>
        <span class="s4">43</span><span class="s3">,</span>
        <span class="s4">48</span><span class="s3">,</span>
        <span class="s4">42</span><span class="s3">,</span>
        <span class="s4">41</span><span class="s3">,</span>
        <span class="s4">53</span><span class="s3">,</span>
        <span class="s4">57</span><span class="s3">,</span>
        <span class="s4">51</span><span class="s3">,</span>
        <span class="s4">52</span><span class="s3">,</span>
        <span class="s4">56</span><span class="s3">,</span>
        <span class="s4">59</span><span class="s3">,</span>
        <span class="s4">54</span><span class="s3">,</span>
        <span class="s4">55</span><span class="s3">,</span>
        <span class="s4">58</span><span class="s3">,</span>
        <span class="s4">50</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s1">p1 </span><span class="s3">= [</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s4">0</span><span class="s3">,</span>
        <span class="s4">3</span><span class="s3">,</span>
        <span class="s4">6</span><span class="s3">,</span>
        <span class="s4">6</span><span class="s3">,</span>
        <span class="s4">6</span><span class="s3">,</span>
        <span class="s4">8</span><span class="s3">,</span>
        <span class="s4">3</span><span class="s3">,</span>
        <span class="s4">7</span><span class="s3">,</span>
        <span class="s4">5</span><span class="s3">,</span>
        <span class="s4">1</span><span class="s3">,</span>
        <span class="s4">31</span><span class="s3">,</span>
        <span class="s4">30</span><span class="s3">,</span>
        <span class="s4">30</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">32</span><span class="s3">,</span>
        <span class="s4">32</span><span class="s3">,</span>
        <span class="s4">37</span><span class="s3">,</span>
        <span class="s4">36</span><span class="s3">,</span>
        <span class="s4">44</span><span class="s3">,</span>
        <span class="s4">21</span><span class="s3">,</span>
        <span class="s4">23</span><span class="s3">,</span>
        <span class="s4">24</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">21</span><span class="s3">,</span>
        <span class="s4">40</span><span class="s3">,</span>
        <span class="s4">45</span><span class="s3">,</span>
        <span class="s4">46</span><span class="s3">,</span>
        <span class="s4">10</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">13</span><span class="s3">,</span>
        <span class="s4">13</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">11</span><span class="s3">,</span>
        <span class="s4">19</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">10</span><span class="s3">,</span>
        <span class="s4">47</span><span class="s3">,</span>
        <span class="s4">12</span><span class="s3">,</span>
        <span class="s4">45</span><span class="s3">,</span>
        <span class="s4">14</span><span class="s3">,</span>
        <span class="s4">43</span><span class="s3">,</span>
        <span class="s4">42</span><span class="s3">,</span>
        <span class="s4">53</span><span class="s3">,</span>
        <span class="s4">57</span><span class="s3">,</span>
        <span class="s4">57</span><span class="s3">,</span>
        <span class="s4">57</span><span class="s3">,</span>
        <span class="s4">57</span><span class="s3">,</span>
        <span class="s4">59</span><span class="s3">,</span>
        <span class="s4">59</span><span class="s3">,</span>
        <span class="s4">59</span><span class="s3">,</span>
        <span class="s4">58</span><span class="s3">,</span>
    <span class="s3">]</span>

    <span class="s0"># Tests against known extraction array</span>
    <span class="s0"># Does NOT work with metric='euclidean', because sklearn euclidean has</span>
    <span class="s0"># worse numeric precision. 'minkowski' is slower but more accurate.</span>
    <span class="s1">clust1 </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">5</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">o1</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">predecessor_</span><span class="s3">[</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">p1</span><span class="s3">))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">[</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">r1</span><span class="s3">))</span>
    <span class="s0"># ELKI currently does not print the core distances (which are not used much</span>
    <span class="s0"># in literature, but we can at least ensure to have this consistency:</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">[</span><span class="s4">1</span><span class="s3">:]:</span>
        <span class="s2">assert </span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">[</span><span class="s1">i</span><span class="s3">] &gt;= </span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">core_distances_</span><span class="s3">[</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">predecessor_</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]]</span>

    <span class="s0"># Expected values, computed with (future) ELKI 0.7.5 using</span>
    <span class="s1">r2 </span><span class="s3">= [</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s4">0.27219111215810565</span><span class="s3">,</span>
        <span class="s4">0.13260875220533205</span><span class="s3">,</span>
        <span class="s4">0.13260875220533205</span><span class="s3">,</span>
        <span class="s4">0.09890587675958984</span><span class="s3">,</span>
        <span class="s4">0.09890587675958984</span><span class="s3">,</span>
        <span class="s4">0.13548790801634494</span><span class="s3">,</span>
        <span class="s4">0.1575483940837384</span><span class="s3">,</span>
        <span class="s4">0.17515137170530226</span><span class="s3">,</span>
        <span class="s4">0.17575920159442388</span><span class="s3">,</span>
        <span class="s4">0.27219111215810565</span><span class="s3">,</span>
        <span class="s4">0.4928068613197889</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s4">0.2666183922512113</span><span class="s3">,</span>
        <span class="s4">0.18765711877083036</span><span class="s3">,</span>
        <span class="s4">0.1821471333893275</span><span class="s3">,</span>
        <span class="s4">0.1821471333893275</span><span class="s3">,</span>
        <span class="s4">0.1821471333893275</span><span class="s3">,</span>
        <span class="s4">0.18715928772277457</span><span class="s3">,</span>
        <span class="s4">0.18765711877083036</span><span class="s3">,</span>
        <span class="s4">0.18765711877083036</span><span class="s3">,</span>
        <span class="s4">0.25468325192031926</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.24944622248445714</span><span class="s3">,</span>
        <span class="s4">0.24944622248445714</span><span class="s3">,</span>
        <span class="s4">0.24944622248445714</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.2552805046961355</span><span class="s3">,</span>
        <span class="s4">0.3086779122185853</span><span class="s3">,</span>
        <span class="s4">0.34466409325984865</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
        <span class="s1">np</span><span class="s3">.</span><span class="s1">inf</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s1">o2 </span><span class="s3">= [</span>
        <span class="s4">0</span><span class="s3">,</span>
        <span class="s4">1</span><span class="s3">,</span>
        <span class="s4">2</span><span class="s3">,</span>
        <span class="s4">3</span><span class="s3">,</span>
        <span class="s4">4</span><span class="s3">,</span>
        <span class="s4">5</span><span class="s3">,</span>
        <span class="s4">6</span><span class="s3">,</span>
        <span class="s4">7</span><span class="s3">,</span>
        <span class="s4">8</span><span class="s3">,</span>
        <span class="s4">9</span><span class="s3">,</span>
        <span class="s4">10</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">11</span><span class="s3">,</span>
        <span class="s4">13</span><span class="s3">,</span>
        <span class="s4">17</span><span class="s3">,</span>
        <span class="s4">19</span><span class="s3">,</span>
        <span class="s4">18</span><span class="s3">,</span>
        <span class="s4">12</span><span class="s3">,</span>
        <span class="s4">16</span><span class="s3">,</span>
        <span class="s4">14</span><span class="s3">,</span>
        <span class="s4">47</span><span class="s3">,</span>
        <span class="s4">46</span><span class="s3">,</span>
        <span class="s4">20</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">23</span><span class="s3">,</span>
        <span class="s4">27</span><span class="s3">,</span>
        <span class="s4">29</span><span class="s3">,</span>
        <span class="s4">24</span><span class="s3">,</span>
        <span class="s4">26</span><span class="s3">,</span>
        <span class="s4">28</span><span class="s3">,</span>
        <span class="s4">21</span><span class="s3">,</span>
        <span class="s4">30</span><span class="s3">,</span>
        <span class="s4">32</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">33</span><span class="s3">,</span>
        <span class="s4">38</span><span class="s3">,</span>
        <span class="s4">39</span><span class="s3">,</span>
        <span class="s4">35</span><span class="s3">,</span>
        <span class="s4">37</span><span class="s3">,</span>
        <span class="s4">36</span><span class="s3">,</span>
        <span class="s4">31</span><span class="s3">,</span>
        <span class="s4">40</span><span class="s3">,</span>
        <span class="s4">41</span><span class="s3">,</span>
        <span class="s4">42</span><span class="s3">,</span>
        <span class="s4">43</span><span class="s3">,</span>
        <span class="s4">44</span><span class="s3">,</span>
        <span class="s4">45</span><span class="s3">,</span>
        <span class="s4">48</span><span class="s3">,</span>
        <span class="s4">49</span><span class="s3">,</span>
        <span class="s4">50</span><span class="s3">,</span>
        <span class="s4">51</span><span class="s3">,</span>
        <span class="s4">52</span><span class="s3">,</span>
        <span class="s4">53</span><span class="s3">,</span>
        <span class="s4">54</span><span class="s3">,</span>
        <span class="s4">55</span><span class="s3">,</span>
        <span class="s4">56</span><span class="s3">,</span>
        <span class="s4">57</span><span class="s3">,</span>
        <span class="s4">58</span><span class="s3">,</span>
        <span class="s4">59</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s1">p2 </span><span class="s3">= [</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s4">10</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">13</span><span class="s3">,</span>
        <span class="s4">13</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">11</span><span class="s3">,</span>
        <span class="s4">19</span><span class="s3">,</span>
        <span class="s4">15</span><span class="s3">,</span>
        <span class="s4">10</span><span class="s3">,</span>
        <span class="s4">47</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s4">20</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">25</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">22</span><span class="s3">,</span>
        <span class="s4">23</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s4">30</span><span class="s3">,</span>
        <span class="s4">30</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">34</span><span class="s3">,</span>
        <span class="s4">32</span><span class="s3">,</span>
        <span class="s4">32</span><span class="s3">,</span>
        <span class="s4">37</span><span class="s3">,</span>
        <span class="s4">38</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
        <span class="s3">-</span><span class="s4">1</span><span class="s3">,</span>
    <span class="s3">]</span>
    <span class="s1">clust2 </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">5</span><span class="s3">, </span><span class="s1">max_eps</span><span class="s3">=</span><span class="s4">0.5</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">, </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">o2</span><span class="s3">))</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">predecessor_</span><span class="s3">[</span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">p2</span><span class="s3">))</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">[</span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">ordering_</span><span class="s3">], </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(</span><span class="s1">r2</span><span class="s3">))</span>

    <span class="s1">index </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">where</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">core_distances_ </span><span class="s3">&lt;= </span><span class="s4">0.5</span><span class="s3">)[</span><span class="s4">0</span><span class="s3">]</span>
    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">core_distances_</span><span class="s3">[</span><span class="s1">index</span><span class="s3">], </span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">core_distances_</span><span class="s3">[</span><span class="s1">index</span><span class="s3">])</span>


<span class="s2">def </span><span class="s1">test_extract_dbscan</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">):</span>
    <span class="s0"># testing an easy dbscan case. Not including clusters with different</span>
    <span class="s0"># densities.</span>
    <span class="s1">rng </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">n_points_per_cluster </span><span class="s3">= </span><span class="s4">20</span>
    <span class="s1">C1 </span><span class="s3">= [-</span><span class="s4">5</span><span class="s3">, -</span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C2 </span><span class="s3">= [</span><span class="s4">4</span><span class="s3">, -</span><span class="s4">1</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C3 </span><span class="s3">= [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">C4 </span><span class="s3">= [-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">] + </span><span class="s4">0.2 </span><span class="s3">* </span><span class="s1">rng</span><span class="s3">.</span><span class="s1">randn</span><span class="s3">(</span><span class="s1">n_points_per_cluster</span><span class="s3">, </span><span class="s4">2</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">vstack</span><span class="s3">((</span><span class="s1">C1</span><span class="s3">, </span><span class="s1">C2</span><span class="s3">, </span><span class="s1">C3</span><span class="s3">, </span><span class="s1">C4</span><span class="s3">)).</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>

    <span class="s1">clust </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">cluster_method</span><span class="s3">=</span><span class="s5">&quot;dbscan&quot;</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">=</span><span class="s4">0.5</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">sort</span><span class="s3">(</span><span class="s1">np</span><span class="s3">.</span><span class="s1">unique</span><span class="s3">(</span><span class="s1">clust</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)), [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">])</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, [</span><span class="s2">None</span><span class="s3">] + </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_precomputed_dists</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s1">redX </span><span class="s3">= </span><span class="s1">X</span><span class="s3">[::</span><span class="s4">2</span><span class="s3">].</span><span class="s1">astype</span><span class="s3">(</span><span class="s1">global_dtype</span><span class="s3">, </span><span class="s1">copy</span><span class="s3">=</span><span class="s2">False</span><span class="s3">)</span>
    <span class="s1">dists </span><span class="s3">= </span><span class="s1">pairwise_distances</span><span class="s3">(</span><span class="s1">redX</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s3">)</span>
    <span class="s1">dists </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">dists</span><span class="s3">) </span><span class="s2">if </span><span class="s1">csr_container </span><span class="s2">is not None else </span><span class="s1">dists</span>
    <span class="s2">with </span><span class="s1">warnings</span><span class="s3">.</span><span class="s1">catch_warnings</span><span class="s3">():</span>
        <span class="s1">warnings</span><span class="s3">.</span><span class="s1">simplefilter</span><span class="s3">(</span><span class="s5">&quot;ignore&quot;</span><span class="s3">, </span><span class="s1">EfficiencyWarning</span><span class="s3">)</span>
        <span class="s1">clust1 </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">10</span><span class="s3">, </span><span class="s1">algorithm</span><span class="s3">=</span><span class="s5">&quot;brute&quot;</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;precomputed&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span>
            <span class="s1">dists</span>
        <span class="s3">)</span>
    <span class="s1">clust2 </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">10</span><span class="s3">, </span><span class="s1">algorithm</span><span class="s3">=</span><span class="s5">&quot;brute&quot;</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">redX</span><span class="s3">)</span>

    <span class="s1">assert_allclose</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">, </span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">reachability_</span><span class="s3">)</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">clust1</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">, </span><span class="s1">clust2</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)</span>


<span class="s3">@</span><span class="s1">pytest</span><span class="s3">.</span><span class="s1">mark</span><span class="s3">.</span><span class="s1">parametrize</span><span class="s3">(</span><span class="s5">&quot;csr_container&quot;</span><span class="s3">, </span><span class="s1">CSR_CONTAINERS</span><span class="s3">)</span>
<span class="s2">def </span><span class="s1">test_optics_input_not_modified_precomputed_sparse_nodiag</span><span class="s3">(</span><span class="s1">csr_container</span><span class="s3">):</span>
    <span class="s6">&quot;&quot;&quot;Check that we don't modify in-place the pre-computed sparse matrix. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/27508 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">random</span><span class="s3">.</span><span class="s1">RandomState</span><span class="s3">(</span><span class="s4">0</span><span class="s3">).</span><span class="s1">rand</span><span class="s3">(</span><span class="s4">6</span><span class="s3">, </span><span class="s4">6</span><span class="s3">)</span>
    <span class="s0"># Add zeros on the diagonal that will be implicit when creating</span>
    <span class="s0"># the sparse matrix. If `X` is modified in-place, the zeros from</span>
    <span class="s0"># the diagonal will be made explicit.</span>
    <span class="s1">np</span><span class="s3">.</span><span class="s1">fill_diagonal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">, </span><span class="s4">0</span><span class="s3">)</span>
    <span class="s1">X </span><span class="s3">= </span><span class="s1">csr_container</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s2">assert </span><span class="s1">all</span><span class="s3">(</span><span class="s1">row </span><span class="s3">!= </span><span class="s1">col </span><span class="s2">for </span><span class="s1">row</span><span class="s3">, </span><span class="s1">col </span><span class="s2">in </span><span class="s1">zip</span><span class="s3">(*</span><span class="s1">X</span><span class="s3">.</span><span class="s1">nonzero</span><span class="s3">()))</span>
    <span class="s1">X_copy </span><span class="s3">= </span><span class="s1">X</span><span class="s3">.</span><span class="s1">copy</span><span class="s3">()</span>
    <span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;precomputed&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X</span><span class="s3">)</span>
    <span class="s0"># Make sure that we did not modify `X` in-place even by creating</span>
    <span class="s0"># explicit 0s values.</span>
    <span class="s2">assert </span><span class="s1">X</span><span class="s3">.</span><span class="s1">nnz </span><span class="s3">== </span><span class="s1">X_copy</span><span class="s3">.</span><span class="s1">nnz</span>
    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">X</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">(), </span><span class="s1">X_copy</span><span class="s3">.</span><span class="s1">toarray</span><span class="s3">())</span>


<span class="s2">def </span><span class="s1">test_optics_predecessor_correction_ordering</span><span class="s3">():</span>
    <span class="s6">&quot;&quot;&quot;Check that cluster correction using predecessor is working as expected. 
 
    In the following example, the predecessor correction was not working properly 
    since it was not using the right indices. 
 
    This non-regression test check that reordering the data does not change the results. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/26324 
    &quot;&quot;&quot;</span>
    <span class="s1">X_1 </span><span class="s3">= </span><span class="s1">np</span><span class="s3">.</span><span class="s1">array</span><span class="s3">([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">100</span><span class="s3">]).</span><span class="s1">reshape</span><span class="s3">(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">)</span>
    <span class="s1">reorder </span><span class="s3">= [</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">3</span><span class="s3">]</span>
    <span class="s1">X_2 </span><span class="s3">= </span><span class="s1">X_1</span><span class="s3">[</span><span class="s1">reorder</span><span class="s3">]</span>

    <span class="s1">optics_1 </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_1</span><span class="s3">)</span>
    <span class="s1">optics_2 </span><span class="s3">= </span><span class="s1">OPTICS</span><span class="s3">(</span><span class="s1">min_samples</span><span class="s3">=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">metric</span><span class="s3">=</span><span class="s5">&quot;euclidean&quot;</span><span class="s3">).</span><span class="s1">fit</span><span class="s3">(</span><span class="s1">X_2</span><span class="s3">)</span>

    <span class="s1">assert_array_equal</span><span class="s3">(</span><span class="s1">optics_1</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">[</span><span class="s1">reorder</span><span class="s3">], </span><span class="s1">optics_2</span><span class="s3">.</span><span class="s1">labels_</span><span class="s3">)</span>
</pre>
</body>
</html>