<html>
<head>
<title>test_forest.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_forest.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Testing for the forest module (sklearn.ensemble.forest). 
&quot;&quot;&quot;</span>

<span class="s2"># Authors: Gilles Louppe,</span>
<span class="s2">#          Brian Holt,</span>
<span class="s2">#          Andreas Mueller,</span>
<span class="s2">#          Arnaud Joly</span>
<span class="s2"># License: BSD 3 clause</span>

<span class="s3">import </span><span class="s1">itertools</span>
<span class="s3">import </span><span class="s1">math</span>
<span class="s3">import </span><span class="s1">pickle</span>
<span class="s3">from </span><span class="s1">collections </span><span class="s3">import </span><span class="s1">defaultdict</span>
<span class="s3">from </span><span class="s1">functools </span><span class="s3">import </span><span class="s1">partial</span>
<span class="s3">from </span><span class="s1">itertools </span><span class="s3">import </span><span class="s1">combinations</span><span class="s4">, </span><span class="s1">product</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Dict</span>
<span class="s3">from </span><span class="s1">unittest</span><span class="s4">.</span><span class="s1">mock </span><span class="s3">import </span><span class="s1">patch</span>

<span class="s3">import </span><span class="s1">joblib</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">pytest</span>
<span class="s3">from </span><span class="s1">scipy</span><span class="s4">.</span><span class="s1">special </span><span class="s3">import </span><span class="s1">comb</span>

<span class="s3">import </span><span class="s1">sklearn</span>
<span class="s3">from </span><span class="s1">sklearn </span><span class="s3">import </span><span class="s1">clone</span><span class="s4">, </span><span class="s1">datasets</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">datasets </span><span class="s3">import </span><span class="s1">make_classification</span><span class="s4">, </span><span class="s1">make_hastie_10_2</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">decomposition </span><span class="s3">import </span><span class="s1">TruncatedSVD</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">dummy </span><span class="s3">import </span><span class="s1">DummyRegressor</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">ensemble </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">ExtraTreesClassifier</span><span class="s4">,</span>
    <span class="s1">ExtraTreesRegressor</span><span class="s4">,</span>
    <span class="s1">RandomForestClassifier</span><span class="s4">,</span>
    <span class="s1">RandomForestRegressor</span><span class="s4">,</span>
    <span class="s1">RandomTreesEmbedding</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">ensemble</span><span class="s4">.</span><span class="s1">_forest </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">_generate_unsampled_indices</span><span class="s4">,</span>
    <span class="s1">_get_n_samples_bootstrap</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">exceptions </span><span class="s3">import </span><span class="s1">NotFittedError</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">metrics </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">explained_variance_score</span><span class="s4">,</span>
    <span class="s1">f1_score</span><span class="s4">,</span>
    <span class="s1">mean_poisson_deviance</span><span class="s4">,</span>
    <span class="s1">mean_squared_error</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">model_selection </span><span class="s3">import </span><span class="s1">GridSearchCV</span><span class="s4">, </span><span class="s1">cross_val_score</span><span class="s4">, </span><span class="s1">train_test_split</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">svm </span><span class="s3">import </span><span class="s1">LinearSVC</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">tree</span><span class="s4">.</span><span class="s1">_classes </span><span class="s3">import </span><span class="s1">SPARSE_SPLITTERS</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">_testing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">_convert_container</span><span class="s4">,</span>
    <span class="s1">assert_allclose</span><span class="s4">,</span>
    <span class="s1">assert_almost_equal</span><span class="s4">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">,</span>
    <span class="s1">assert_array_equal</span><span class="s4">,</span>
    <span class="s1">ignore_warnings</span><span class="s4">,</span>
    <span class="s1">skip_if_no_parallel</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">fixes </span><span class="s3">import </span><span class="s1">COO_CONTAINERS</span><span class="s4">, </span><span class="s1">CSC_CONTAINERS</span><span class="s4">, </span><span class="s1">CSR_CONTAINERS</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">multiclass </span><span class="s3">import </span><span class="s1">type_of_target</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">parallel </span><span class="s3">import </span><span class="s1">Parallel</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">validation </span><span class="s3">import </span><span class="s1">check_random_state</span>

<span class="s2"># toy sample</span>
<span class="s1">X </span><span class="s4">= [[-</span><span class="s5">2</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">], [-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">], [-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">], [</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">]]</span>
<span class="s1">y </span><span class="s4">= [-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">]</span>
<span class="s1">T </span><span class="s4">= [[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">], [</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">], [</span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s4">]]</span>
<span class="s1">true_result </span><span class="s4">= [-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">]</span>

<span class="s2"># Larger classification sample used for testing feature importances</span>
<span class="s1">X_large</span><span class="s4">, </span><span class="s1">y_large </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_classification</span><span class="s4">(</span>
    <span class="s1">n_samples</span><span class="s4">=</span><span class="s5">500</span><span class="s4">,</span>
    <span class="s1">n_features</span><span class="s4">=</span><span class="s5">10</span><span class="s4">,</span>
    <span class="s1">n_informative</span><span class="s4">=</span><span class="s5">3</span><span class="s4">,</span>
    <span class="s1">n_redundant</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">n_repeated</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s1">shuffle</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
<span class="s4">)</span>

<span class="s2"># also load the iris dataset</span>
<span class="s2"># and randomly permute it</span>
<span class="s1">iris </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">load_iris</span><span class="s4">()</span>
<span class="s1">rng </span><span class="s4">= </span><span class="s1">check_random_state</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
<span class="s1">perm </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">permutation</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">size</span><span class="s4">)</span>
<span class="s1">iris</span><span class="s4">.</span><span class="s1">data </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[</span><span class="s1">perm</span><span class="s4">]</span>
<span class="s1">iris</span><span class="s4">.</span><span class="s1">target </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">[</span><span class="s1">perm</span><span class="s4">]</span>

<span class="s2"># Make regression dataset</span>
<span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y_reg </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_regression</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">500</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>

<span class="s2"># also make a hastie_10_2 dataset</span>
<span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_hastie_10_2</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">20</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
<span class="s1">hastie_X </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float32</span><span class="s4">)</span>

<span class="s2"># Get the default backend in joblib to test parallelism and interaction with</span>
<span class="s2"># different backends</span>
<span class="s1">DEFAULT_JOBLIB_BACKEND </span><span class="s4">= </span><span class="s1">joblib</span><span class="s4">.</span><span class="s1">parallel</span><span class="s4">.</span><span class="s1">get_active_backend</span><span class="s4">()[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">__class__</span>

<span class="s1">FOREST_CLASSIFIERS </span><span class="s4">= {</span>
    <span class="s6">&quot;ExtraTreesClassifier&quot;</span><span class="s4">: </span><span class="s1">ExtraTreesClassifier</span><span class="s4">,</span>
    <span class="s6">&quot;RandomForestClassifier&quot;</span><span class="s4">: </span><span class="s1">RandomForestClassifier</span><span class="s4">,</span>
<span class="s4">}</span>

<span class="s1">FOREST_REGRESSORS </span><span class="s4">= {</span>
    <span class="s6">&quot;ExtraTreesRegressor&quot;</span><span class="s4">: </span><span class="s1">ExtraTreesRegressor</span><span class="s4">,</span>
    <span class="s6">&quot;RandomForestRegressor&quot;</span><span class="s4">: </span><span class="s1">RandomForestRegressor</span><span class="s4">,</span>
<span class="s4">}</span>

<span class="s1">FOREST_TRANSFORMERS </span><span class="s4">= {</span>
    <span class="s6">&quot;RandomTreesEmbedding&quot;</span><span class="s4">: </span><span class="s1">RandomTreesEmbedding</span><span class="s4">,</span>
<span class="s4">}</span>

<span class="s1">FOREST_ESTIMATORS</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = </span><span class="s1">dict</span><span class="s4">()</span>
<span class="s1">FOREST_ESTIMATORS</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s1">FOREST_ESTIMATORS</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">FOREST_REGRESSORS</span><span class="s4">)</span>
<span class="s1">FOREST_ESTIMATORS</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">FOREST_TRANSFORMERS</span><span class="s4">)</span>

<span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">] = </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
<span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">.</span><span class="s1">update</span><span class="s4">(</span><span class="s1">FOREST_REGRESSORS</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_classification_toy</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check classification on a toy dataset.&quot;&quot;&quot;</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">T</span><span class="s4">), </span><span class="s1">true_result</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s5">10 </span><span class="s4">== </span><span class="s1">len</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">)</span>

    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">max_features</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">T</span><span class="s4">), </span><span class="s1">true_result</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s5">10 </span><span class="s4">== </span><span class="s1">len</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">)</span>

    <span class="s2"># also test apply</span>
    <span class="s1">leaf_indices </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">leaf_indices</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== (</span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">n_estimators</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;criterion&quot;</span><span class="s4">, (</span><span class="s6">&quot;gini&quot;</span><span class="s4">, </span><span class="s6">&quot;log_loss&quot;</span><span class="s4">))</span>
<span class="s3">def </span><span class="s1">test_iris_criterion</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">):</span>
    <span class="s2"># Check consistency on dataset iris.</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">score </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">score </span><span class="s4">&gt; </span><span class="s5">0.9</span><span class="s4">, </span><span class="s6">&quot;Failed with criterion %s and score = %f&quot; </span><span class="s4">% (</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">score</span><span class="s4">)</span>

    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">max_features</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">score </span><span class="s4">= </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">score </span><span class="s4">&gt; </span><span class="s5">0.5</span><span class="s4">, </span><span class="s6">&quot;Failed with criterion %s and score = %f&quot; </span><span class="s4">% (</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">score</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;criterion&quot;</span><span class="s4">, (</span><span class="s6">&quot;squared_error&quot;</span><span class="s4">, </span><span class="s6">&quot;absolute_error&quot;</span><span class="s4">, </span><span class="s6">&quot;friedman_mse&quot;</span><span class="s4">)</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_regression_criterion</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">):</span>
    <span class="s2"># Check consistency on regression dataset.</span>
    <span class="s1">ForestRegressor </span><span class="s4">= </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">reg </span><span class="s4">= </span><span class="s1">ForestRegressor</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y_reg</span><span class="s4">)</span>
    <span class="s1">score </span><span class="s4">= </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y_reg</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s4">(</span>
        <span class="s1">score </span><span class="s4">&gt; </span><span class="s5">0.93</span>
    <span class="s4">), </span><span class="s6">&quot;Failed with max_features=None, criterion %s and score = %f&quot; </span><span class="s4">% (</span>
        <span class="s1">criterion</span><span class="s4">,</span>
        <span class="s1">score</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s1">reg </span><span class="s4">= </span><span class="s1">ForestRegressor</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">max_features</span><span class="s4">=</span><span class="s5">6</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span>
    <span class="s4">)</span>
    <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y_reg</span><span class="s4">)</span>
    <span class="s1">score </span><span class="s4">= </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y_reg</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">score </span><span class="s4">&gt; </span><span class="s5">0.92</span><span class="s4">, </span><span class="s6">&quot;Failed with max_features=6, criterion %s and score = %f&quot; </span><span class="s4">% (</span>
        <span class="s1">criterion</span><span class="s4">,</span>
        <span class="s1">score</span><span class="s4">,</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_poisson_vs_mse</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Test that random forest with poisson criterion performs better than 
    mse for a poisson target. 
 
    There is a similar test for DecisionTreeRegressor. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">n_train</span><span class="s4">, </span><span class="s1">n_test</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s5">500</span><span class="s4">, </span><span class="s5">500</span><span class="s4">, </span><span class="s5">10</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_low_rank_matrix</span><span class="s4">(</span>
        <span class="s1">n_samples</span><span class="s4">=</span><span class="s1">n_train </span><span class="s4">+ </span><span class="s1">n_test</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s1">n_features</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span>
    <span class="s4">)</span>
    <span class="s2">#  We create a log-linear Poisson model and downscale coef as it will get</span>
    <span class="s2"># exponentiated.</span>
    <span class="s1">coef </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s1">low</span><span class="s4">=-</span><span class="s5">2</span><span class="s4">, </span><span class="s1">high</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_features</span><span class="s4">) / </span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">axis</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">poisson</span><span class="s4">(</span><span class="s1">lam</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">exp</span><span class="s4">(</span><span class="s1">X </span><span class="s4">@ </span><span class="s1">coef</span><span class="s4">))</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">test_size</span><span class="s4">=</span><span class="s1">n_test</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span>
    <span class="s4">)</span>
    <span class="s2"># We prevent some overfitting by setting min_samples_split=10.</span>
    <span class="s1">forest_poi </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span>
        <span class="s1">criterion</span><span class="s4">=</span><span class="s6">&quot;poisson&quot;</span><span class="s4">, </span><span class="s1">min_samples_leaf</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">max_features</span><span class="s4">=</span><span class="s6">&quot;sqrt&quot;</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span>
    <span class="s4">)</span>
    <span class="s1">forest_mse </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span>
        <span class="s1">criterion</span><span class="s4">=</span><span class="s6">&quot;squared_error&quot;</span><span class="s4">,</span>
        <span class="s1">min_samples_leaf</span><span class="s4">=</span><span class="s5">10</span><span class="s4">,</span>
        <span class="s1">max_features</span><span class="s4">=</span><span class="s6">&quot;sqrt&quot;</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s1">forest_poi</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">forest_mse</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">dummy </span><span class="s4">= </span><span class="s1">DummyRegressor</span><span class="s4">(</span><span class="s1">strategy</span><span class="s4">=</span><span class="s6">&quot;mean&quot;</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">data_name </span><span class="s3">in </span><span class="s4">[(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s6">&quot;train&quot;</span><span class="s4">), (</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">, </span><span class="s6">&quot;test&quot;</span><span class="s4">)]:</span>
        <span class="s1">metric_poi </span><span class="s4">= </span><span class="s1">mean_poisson_deviance</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">forest_poi</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>
        <span class="s2"># squared_error forest might produce non-positive predictions =&gt; clip</span>
        <span class="s2"># If y = 0 for those, the poisson deviance gets too good.</span>
        <span class="s2"># If we drew more samples, we would eventually get y &gt; 0 and the</span>
        <span class="s2"># poisson deviance would explode, i.e. be undefined. Therefore, we do</span>
        <span class="s2"># not clip to a tiny value like 1e-15, but to 1e-6. This acts like a</span>
        <span class="s2"># small penalty to the non-positive predictions.</span>
        <span class="s1">metric_mse </span><span class="s4">= </span><span class="s1">mean_poisson_deviance</span><span class="s4">(</span>
            <span class="s1">y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">clip</span><span class="s4">(</span><span class="s1">forest_mse</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s5">1e-6</span><span class="s4">, </span><span class="s3">None</span><span class="s4">)</span>
        <span class="s4">)</span>
        <span class="s1">metric_dummy </span><span class="s4">= </span><span class="s1">mean_poisson_deviance</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">dummy</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>
        <span class="s2"># As squared_error might correctly predict 0 in train set, its train</span>
        <span class="s2"># score can be better than Poisson. This is no longer the case for the</span>
        <span class="s2"># test set. But keep the above comment for clipping in mind.</span>
        <span class="s3">if </span><span class="s1">data_name </span><span class="s4">== </span><span class="s6">&quot;test&quot;</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">metric_poi </span><span class="s4">&lt; </span><span class="s1">metric_mse</span>
        <span class="s3">assert </span><span class="s1">metric_poi </span><span class="s4">&lt; </span><span class="s5">0.8 </span><span class="s4">* </span><span class="s1">metric_dummy</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;criterion&quot;</span><span class="s4">, (</span><span class="s6">&quot;poisson&quot;</span><span class="s4">, </span><span class="s6">&quot;squared_error&quot;</span><span class="s4">))</span>
<span class="s3">def </span><span class="s1">test_balance_property_random_forest</span><span class="s4">(</span><span class="s1">criterion</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot; &quot;Test that sum(y_pred)==sum(y_true) on the training set.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">n_train</span><span class="s4">, </span><span class="s1">n_test</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s5">500</span><span class="s4">, </span><span class="s5">500</span><span class="s4">, </span><span class="s5">10</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_low_rank_matrix</span><span class="s4">(</span>
        <span class="s1">n_samples</span><span class="s4">=</span><span class="s1">n_train </span><span class="s4">+ </span><span class="s1">n_test</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s1">n_features</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span>
    <span class="s4">)</span>

    <span class="s1">coef </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s1">low</span><span class="s4">=-</span><span class="s5">2</span><span class="s4">, </span><span class="s1">high</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_features</span><span class="s4">) / </span><span class="s1">np</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">axis</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">poisson</span><span class="s4">(</span><span class="s1">lam</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">exp</span><span class="s4">(</span><span class="s1">X </span><span class="s4">@ </span><span class="s1">coef</span><span class="s4">))</span>

    <span class="s1">reg </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span>
        <span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span>
    <span class="s4">)</span>
    <span class="s1">reg</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">reg</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)) == </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">approx</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">y</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_regressor_attributes</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Regression models should not have a classes_ attribute.</span>
    <span class="s1">r </span><span class="s4">= </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s6">&quot;classes_&quot;</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s6">&quot;n_classes_&quot;</span><span class="s4">)</span>

    <span class="s1">r</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">([[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">], [</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">]], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">])</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s6">&quot;classes_&quot;</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s6">&quot;n_classes_&quot;</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_probability</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Predict probabilities.</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s3">with </span><span class="s1">np</span><span class="s4">.</span><span class="s1">errstate</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">):</span>
        <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span>
            <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">max_features</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span>
        <span class="s4">)</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span>
            <span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">), </span><span class="s1">axis</span><span class="s4">=</span><span class="s5">1</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
        <span class="s4">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span>
            <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">), </span><span class="s1">np</span><span class="s4">.</span><span class="s1">exp</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">))</span>
        <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;dtype&quot;</span><span class="s4">, (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float32</span><span class="s4">))</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;name, criterion&quot;</span><span class="s4">,</span>
    <span class="s1">itertools</span><span class="s4">.</span><span class="s1">chain</span><span class="s4">(</span>
        <span class="s1">product</span><span class="s4">(</span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">, [</span><span class="s6">&quot;gini&quot;</span><span class="s4">, </span><span class="s6">&quot;log_loss&quot;</span><span class="s4">]),</span>
        <span class="s1">product</span><span class="s4">(</span><span class="s1">FOREST_REGRESSORS</span><span class="s4">, [</span><span class="s6">&quot;squared_error&quot;</span><span class="s4">, </span><span class="s6">&quot;friedman_mse&quot;</span><span class="s4">, </span><span class="s6">&quot;absolute_error&quot;</span><span class="s4">]),</span>
    <span class="s4">),</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_importances</span><span class="s4">(</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">):</span>
    <span class="s1">tolerance </span><span class="s4">= </span><span class="s5">0.01</span>
    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_REGRESSORS </span><span class="s3">and </span><span class="s1">criterion </span><span class="s4">== </span><span class="s6">&quot;absolute_error&quot;</span><span class="s4">:</span>
        <span class="s1">tolerance </span><span class="s4">= </span><span class="s5">0.05</span>

    <span class="s2"># cast as dtype</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">X_large</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">copy</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">y_large</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">dtype</span><span class="s4">, </span><span class="s1">copy</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">importances </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">feature_importances_</span>

    <span class="s2"># The forest estimator can detect that only the first 3 features of the</span>
    <span class="s2"># dataset are informative:</span>
    <span class="s1">n_important </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">importances </span><span class="s4">&gt; </span><span class="s5">0.1</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">importances</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] == </span><span class="s5">10</span>
    <span class="s3">assert </span><span class="s1">n_important </span><span class="s4">== </span><span class="s5">3</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">importances</span><span class="s4">[:</span><span class="s5">3</span><span class="s4">] &gt; </span><span class="s5">0.1</span><span class="s4">)</span>

    <span class="s2"># Check with parallel</span>
    <span class="s1">importances </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">feature_importances_</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">importances_parallel </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">feature_importances_</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">importances</span><span class="s4">, </span><span class="s1">importances_parallel</span><span class="s4">)</span>

    <span class="s2"># Check with sample weights</span>
    <span class="s1">sample_weight </span><span class="s4">= </span><span class="s1">check_random_state</span><span class="s4">(</span><span class="s5">0</span><span class="s4">).</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">sample_weight</span><span class="s4">)</span>
    <span class="s1">importances </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">feature_importances_</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">all</span><span class="s4">(</span><span class="s1">importances </span><span class="s4">&gt;= </span><span class="s5">0.0</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">scale </span><span class="s3">in </span><span class="s4">[</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">100</span><span class="s4">]:</span>
        <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">criterion</span><span class="s4">)</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">scale </span><span class="s4">* </span><span class="s1">sample_weight</span><span class="s4">)</span>
        <span class="s1">importances_bis </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">feature_importances_</span>
        <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">importances </span><span class="s4">- </span><span class="s1">importances_bis</span><span class="s4">).</span><span class="s1">mean</span><span class="s4">() &lt; </span><span class="s1">tolerance</span>


<span class="s3">def </span><span class="s1">test_importances_asymptotic</span><span class="s4">():</span>
    <span class="s2"># Check whether variable importances of totally randomized trees</span>
    <span class="s2"># converge towards their theoretical values (See Louppe et al,</span>
    <span class="s2"># Understanding variable importances in forests of randomized trees, 2013).</span>

    <span class="s3">def </span><span class="s1">binomial</span><span class="s4">(</span><span class="s1">k</span><span class="s4">, </span><span class="s1">n</span><span class="s4">):</span>
        <span class="s3">return </span><span class="s5">0 </span><span class="s3">if </span><span class="s1">k </span><span class="s4">&lt; </span><span class="s5">0 </span><span class="s3">or </span><span class="s1">k </span><span class="s4">&gt; </span><span class="s1">n </span><span class="s3">else </span><span class="s1">comb</span><span class="s4">(</span><span class="s1">int</span><span class="s4">(</span><span class="s1">n</span><span class="s4">), </span><span class="s1">int</span><span class="s4">(</span><span class="s1">k</span><span class="s4">), </span><span class="s1">exact</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">entropy</span><span class="s4">(</span><span class="s1">samples</span><span class="s4">):</span>
        <span class="s1">n_samples </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">samples</span><span class="s4">)</span>
        <span class="s1">entropy </span><span class="s4">= </span><span class="s5">0.0</span>

        <span class="s3">for </span><span class="s1">count </span><span class="s3">in </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bincount</span><span class="s4">(</span><span class="s1">samples</span><span class="s4">):</span>
            <span class="s1">p </span><span class="s4">= </span><span class="s5">1.0 </span><span class="s4">* </span><span class="s1">count </span><span class="s4">/ </span><span class="s1">n_samples</span>
            <span class="s3">if </span><span class="s1">p </span><span class="s4">&gt; </span><span class="s5">0</span><span class="s4">:</span>
                <span class="s1">entropy </span><span class="s4">-= </span><span class="s1">p </span><span class="s4">* </span><span class="s1">np</span><span class="s4">.</span><span class="s1">log2</span><span class="s4">(</span><span class="s1">p</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">entropy</span>

    <span class="s3">def </span><span class="s1">mdi_importance</span><span class="s4">(</span><span class="s1">X_m</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
        <span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span>

        <span class="s1">features </span><span class="s4">= </span><span class="s1">list</span><span class="s4">(</span><span class="s1">range</span><span class="s4">(</span><span class="s1">n_features</span><span class="s4">))</span>
        <span class="s1">features</span><span class="s4">.</span><span class="s1">pop</span><span class="s4">(</span><span class="s1">X_m</span><span class="s4">)</span>
        <span class="s1">values </span><span class="s4">= [</span><span class="s1">np</span><span class="s4">.</span><span class="s1">unique</span><span class="s4">(</span><span class="s1">X</span><span class="s4">[:, </span><span class="s1">i</span><span class="s4">]) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">n_features</span><span class="s4">)]</span>

        <span class="s1">imp </span><span class="s4">= </span><span class="s5">0.0</span>

        <span class="s3">for </span><span class="s1">k </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">n_features</span><span class="s4">):</span>
            <span class="s2"># Weight of each B of size k</span>
            <span class="s1">coef </span><span class="s4">= </span><span class="s5">1.0 </span><span class="s4">/ (</span><span class="s1">binomial</span><span class="s4">(</span><span class="s1">k</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">) * (</span><span class="s1">n_features </span><span class="s4">- </span><span class="s1">k</span><span class="s4">))</span>

            <span class="s2"># For all B of size k</span>
            <span class="s3">for </span><span class="s1">B </span><span class="s3">in </span><span class="s1">combinations</span><span class="s4">(</span><span class="s1">features</span><span class="s4">, </span><span class="s1">k</span><span class="s4">):</span>
                <span class="s2"># For all values B=b</span>
                <span class="s3">for </span><span class="s1">b </span><span class="s3">in </span><span class="s1">product</span><span class="s4">(*[</span><span class="s1">values</span><span class="s4">[</span><span class="s1">B</span><span class="s4">[</span><span class="s1">j</span><span class="s4">]] </span><span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">k</span><span class="s4">)]):</span>
                    <span class="s1">mask_b </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">)</span>

                    <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">k</span><span class="s4">):</span>
                        <span class="s1">mask_b </span><span class="s4">&amp;= </span><span class="s1">X</span><span class="s4">[:, </span><span class="s1">B</span><span class="s4">[</span><span class="s1">j</span><span class="s4">]] == </span><span class="s1">b</span><span class="s4">[</span><span class="s1">j</span><span class="s4">]</span>

                    <span class="s1">X_</span><span class="s4">, </span><span class="s1">y_ </span><span class="s4">= </span><span class="s1">X</span><span class="s4">[</span><span class="s1">mask_b</span><span class="s4">, :], </span><span class="s1">y</span><span class="s4">[</span><span class="s1">mask_b</span><span class="s4">]</span>
                    <span class="s1">n_samples_b </span><span class="s4">= </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X_</span><span class="s4">)</span>

                    <span class="s3">if </span><span class="s1">n_samples_b </span><span class="s4">&gt; </span><span class="s5">0</span><span class="s4">:</span>
                        <span class="s1">children </span><span class="s4">= []</span>

                        <span class="s3">for </span><span class="s1">xi </span><span class="s3">in </span><span class="s1">values</span><span class="s4">[</span><span class="s1">X_m</span><span class="s4">]:</span>
                            <span class="s1">mask_xi </span><span class="s4">= </span><span class="s1">X_</span><span class="s4">[:, </span><span class="s1">X_m</span><span class="s4">] == </span><span class="s1">xi</span>
                            <span class="s1">children</span><span class="s4">.</span><span class="s1">append</span><span class="s4">(</span><span class="s1">y_</span><span class="s4">[</span><span class="s1">mask_xi</span><span class="s4">])</span>

                        <span class="s1">imp </span><span class="s4">+= (</span>
                            <span class="s1">coef</span>
                            <span class="s4">* (</span><span class="s5">1.0 </span><span class="s4">* </span><span class="s1">n_samples_b </span><span class="s4">/ </span><span class="s1">n_samples</span><span class="s4">)  </span><span class="s2"># P(B=b)</span>
                            <span class="s4">* (</span>
                                <span class="s1">entropy</span><span class="s4">(</span><span class="s1">y_</span><span class="s4">)</span>
                                <span class="s4">- </span><span class="s1">sum</span><span class="s4">(</span>
                                    <span class="s4">[</span>
                                        <span class="s1">entropy</span><span class="s4">(</span><span class="s1">c</span><span class="s4">) * </span><span class="s1">len</span><span class="s4">(</span><span class="s1">c</span><span class="s4">) / </span><span class="s1">n_samples_b</span>
                                        <span class="s3">for </span><span class="s1">c </span><span class="s3">in </span><span class="s1">children</span>
                                    <span class="s4">]</span>
                                <span class="s4">)</span>
                            <span class="s4">)</span>
                        <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">imp</span>

    <span class="s1">data </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span>
        <span class="s4">[</span>
            <span class="s4">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">5</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">6</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">7</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">8</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">9</span><span class="s4">],</span>
            <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">],</span>
        <span class="s4">]</span>
    <span class="s4">)</span>

    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">data</span><span class="s4">[:, :</span><span class="s5">7</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">bool</span><span class="s4">), </span><span class="s1">data</span><span class="s4">[:, </span><span class="s5">7</span><span class="s4">]</span>
    <span class="s1">n_features </span><span class="s4">= </span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]</span>

    <span class="s2"># Compute true importances</span>
    <span class="s1">true_importances </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s1">n_features</span><span class="s4">)</span>

    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">n_features</span><span class="s4">):</span>
        <span class="s1">true_importances</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">mdi_importance</span><span class="s4">(</span><span class="s1">i</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s2"># Estimate importances with totally randomized trees</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ExtraTreesClassifier</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">500</span><span class="s4">, </span><span class="s1">max_features</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s6">&quot;log_loss&quot;</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">importances </span><span class="s4">= (</span>
        <span class="s1">sum</span><span class="s4">(</span>
            <span class="s1">tree</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">compute_feature_importances</span><span class="s4">(</span><span class="s1">normalize</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">estimators_</span>
        <span class="s4">)</span>
        <span class="s4">/ </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">n_estimators</span>
    <span class="s4">)</span>

    <span class="s2"># Check correctness</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">entropy</span><span class="s4">(</span><span class="s1">y</span><span class="s4">), </span><span class="s1">sum</span><span class="s4">(</span><span class="s1">importances</span><span class="s4">))</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">true_importances </span><span class="s4">- </span><span class="s1">importances</span><span class="s4">).</span><span class="s1">mean</span><span class="s4">() &lt; </span><span class="s5">0.01</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_unfitted_feature_importances</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">err_msg </span><span class="s4">= (</span>
        <span class="s6">&quot;This {} instance is not fitted yet. Call 'fit' with &quot;</span>
        <span class="s6">&quot;appropriate arguments before using this estimator.&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">NotFittedError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">getattr</span><span class="s4">(</span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](), </span><span class="s6">&quot;feature_importances_&quot;</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestClassifier&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;X_type&quot;</span><span class="s4">, [</span><span class="s6">&quot;array&quot;</span><span class="s4">, </span><span class="s6">&quot;sparse_csr&quot;</span><span class="s4">, </span><span class="s6">&quot;sparse_csc&quot;</span><span class="s4">])</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;X, y, lower_bound_accuracy&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s4">*</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_classification</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">300</span><span class="s4">, </span><span class="s1">n_classes</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">),</span>
            <span class="s5">0.9</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s4">*</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_classification</span><span class="s4">(</span>
                <span class="s1">n_samples</span><span class="s4">=</span><span class="s5">1000</span><span class="s4">, </span><span class="s1">n_classes</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">n_informative</span><span class="s4">=</span><span class="s5">6</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
            <span class="s4">),</span>
            <span class="s5">0.65</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">,</span>
            <span class="s1">iris</span><span class="s4">.</span><span class="s1">target </span><span class="s4">* </span><span class="s5">2 </span><span class="s4">+ </span><span class="s5">1</span><span class="s4">,</span>
            <span class="s5">0.65</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s4">*</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_multilabel_classification</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">300</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">),</span>
            <span class="s5">0.18</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;oob_score&quot;</span><span class="s4">, [</span><span class="s3">True</span><span class="s4">, </span><span class="s1">partial</span><span class="s4">(</span><span class="s1">f1_score</span><span class="s4">, </span><span class="s1">average</span><span class="s4">=</span><span class="s6">&quot;micro&quot;</span><span class="s4">)])</span>
<span class="s3">def </span><span class="s1">test_forest_classifier_oob</span><span class="s4">(</span>
    <span class="s1">ForestClassifier</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">X_type</span><span class="s4">, </span><span class="s1">lower_bound_accuracy</span><span class="s4">, </span><span class="s1">oob_score</span>
<span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that OOB score is close to score on a test set.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">_convert_container</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">constructor_name</span><span class="s4">=</span><span class="s1">X_type</span><span class="s4">)</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">,</span>
        <span class="s1">y</span><span class="s4">,</span>
        <span class="s1">test_size</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">classifier </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">40</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">oob_score</span><span class="s4">=</span><span class="s1">oob_score</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">classifier</span><span class="s4">, </span><span class="s6">&quot;oob_score_&quot;</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">classifier</span><span class="s4">, </span><span class="s6">&quot;oob_decision_function_&quot;</span><span class="s4">)</span>

    <span class="s1">classifier</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">callable</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">):</span>
        <span class="s1">test_score </span><span class="s4">= </span><span class="s1">oob_score</span><span class="s4">(</span><span class="s1">y_test</span><span class="s4">, </span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">test_score </span><span class="s4">= </span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">oob_score_ </span><span class="s4">&gt;= </span><span class="s1">lower_bound_accuracy</span>

    <span class="s1">abs_diff </span><span class="s4">= </span><span class="s1">abs</span><span class="s4">(</span><span class="s1">test_score </span><span class="s4">- </span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">oob_score_</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">abs_diff </span><span class="s4">&lt;= </span><span class="s5">0.11</span><span class="s4">, </span><span class="s6">f&quot;</span><span class="s3">{</span><span class="s1">abs_diff</span><span class="s4">=</span><span class="s3">} </span><span class="s6">is greater than 0.11&quot;</span>

    <span class="s3">assert </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">classifier</span><span class="s4">, </span><span class="s6">&quot;oob_score_&quot;</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">classifier</span><span class="s4">, </span><span class="s6">&quot;oob_prediction_&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">classifier</span><span class="s4">, </span><span class="s6">&quot;oob_decision_function_&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">y</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">expected_shape </span><span class="s4">= (</span><span class="s1">X_train</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">len</span><span class="s4">(</span><span class="s1">set</span><span class="s4">(</span><span class="s1">y</span><span class="s4">)))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">expected_shape </span><span class="s4">= (</span><span class="s1">X_train</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">len</span><span class="s4">(</span><span class="s1">set</span><span class="s4">(</span><span class="s1">y</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">])), </span><span class="s1">y</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">])</span>
    <span class="s3">assert </span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">oob_decision_function_</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== </span><span class="s1">expected_shape</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestRegressor&quot;</span><span class="s4">, </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;X_type&quot;</span><span class="s4">, [</span><span class="s6">&quot;array&quot;</span><span class="s4">, </span><span class="s6">&quot;sparse_csr&quot;</span><span class="s4">, </span><span class="s6">&quot;sparse_csc&quot;</span><span class="s4">])</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;X, y, lower_bound_r2&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s4">*</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_regression</span><span class="s4">(</span>
                <span class="s1">n_samples</span><span class="s4">=</span><span class="s5">500</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">n_targets</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
            <span class="s4">),</span>
            <span class="s5">0.7</span><span class="s4">,</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s4">*</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_regression</span><span class="s4">(</span>
                <span class="s1">n_samples</span><span class="s4">=</span><span class="s5">500</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">n_targets</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
            <span class="s4">),</span>
            <span class="s5">0.55</span><span class="s4">,</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;oob_score&quot;</span><span class="s4">, [</span><span class="s3">True</span><span class="s4">, </span><span class="s1">explained_variance_score</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_forest_regressor_oob</span><span class="s4">(</span><span class="s1">ForestRegressor</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">X_type</span><span class="s4">, </span><span class="s1">lower_bound_r2</span><span class="s4">, </span><span class="s1">oob_score</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that forest-based regressor provide an OOB score close to the 
    score on a test set.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">_convert_container</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">constructor_name</span><span class="s4">=</span><span class="s1">X_type</span><span class="s4">)</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">,</span>
        <span class="s1">y</span><span class="s4">,</span>
        <span class="s1">test_size</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">regressor </span><span class="s4">= </span><span class="s1">ForestRegressor</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">50</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">oob_score</span><span class="s4">=</span><span class="s1">oob_score</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">regressor</span><span class="s4">, </span><span class="s6">&quot;oob_score_&quot;</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">regressor</span><span class="s4">, </span><span class="s6">&quot;oob_prediction_&quot;</span><span class="s4">)</span>

    <span class="s1">regressor</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s3">if </span><span class="s1">callable</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">):</span>
        <span class="s1">test_score </span><span class="s4">= </span><span class="s1">oob_score</span><span class="s4">(</span><span class="s1">y_test</span><span class="s4">, </span><span class="s1">regressor</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">))</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">test_score </span><span class="s4">= </span><span class="s1">regressor</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">regressor</span><span class="s4">.</span><span class="s1">oob_score_ </span><span class="s4">&gt;= </span><span class="s1">lower_bound_r2</span>

    <span class="s3">assert </span><span class="s1">abs</span><span class="s4">(</span><span class="s1">test_score </span><span class="s4">- </span><span class="s1">regressor</span><span class="s4">.</span><span class="s1">oob_score_</span><span class="s4">) &lt;= </span><span class="s5">0.1</span>

    <span class="s3">assert </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">regressor</span><span class="s4">, </span><span class="s6">&quot;oob_score_&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">regressor</span><span class="s4">, </span><span class="s6">&quot;oob_prediction_&quot;</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">regressor</span><span class="s4">, </span><span class="s6">&quot;oob_decision_function_&quot;</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">y</span><span class="s4">.</span><span class="s1">ndim </span><span class="s4">== </span><span class="s5">1</span><span class="s4">:</span>
        <span class="s1">expected_shape </span><span class="s4">= (</span><span class="s1">X_train</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">],)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">expected_shape </span><span class="s4">= (</span><span class="s1">X_train</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s1">y</span><span class="s4">.</span><span class="s1">ndim</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">regressor</span><span class="s4">.</span><span class="s1">oob_prediction_</span><span class="s4">.</span><span class="s1">shape </span><span class="s4">== </span><span class="s1">expected_shape</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestEstimator&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s3">def </span><span class="s1">test_forest_oob_warning</span><span class="s4">(</span><span class="s1">ForestEstimator</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that a warning is raised when not enough estimator and the OOB 
    estimates will be inaccurate.&quot;&quot;&quot;</span>
    <span class="s1">estimator </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,</span>
        <span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span><span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Some inputs do not have OOB scores&quot;</span><span class="s4">):</span>
        <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestEstimator&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s3">def </span><span class="s1">test_forest_oob_score_requires_bootstrap</span><span class="s4">(</span><span class="s1">ForestEstimator</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise an error if OOB score is requested without 
    activating bootstrapping. 
    &quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span>
    <span class="s1">err_msg </span><span class="s4">= </span><span class="s6">&quot;Out of bag estimation only available if bootstrap=True&quot;</span>
    <span class="s1">estimator </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestClassifier&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s3">def </span><span class="s1">test_classifier_error_oob_score_multiclass_multioutput</span><span class="s4">(</span><span class="s1">ForestClassifier</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise an error with when requesting OOB score with 
    multiclass-multioutput classification target. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s1">low</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">high</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s5">2</span><span class="s4">))</span>
    <span class="s1">y_type </span><span class="s4">= </span><span class="s1">type_of_target</span><span class="s4">(</span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">y_type </span><span class="s4">== </span><span class="s6">&quot;multiclass-multioutput&quot;</span>
    <span class="s1">estimator </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">err_msg </span><span class="s4">= </span><span class="s6">&quot;The type of target cannot be used to compute OOB estimates&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestRegressor&quot;</span><span class="s4">, </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s3">def </span><span class="s1">test_forest_multioutput_integral_regression_target</span><span class="s4">(</span><span class="s1">ForestRegressor</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that multioutput regression with integral values is not interpreted 
    as a multiclass-multioutput target and OOB score can be computed. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">42</span><span class="s4">)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s1">low</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">high</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">], </span><span class="s5">2</span><span class="s4">))</span>
    <span class="s1">estimator </span><span class="s4">= </span><span class="s1">ForestRegressor</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">30</span><span class="s4">, </span><span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">n_samples_bootstrap </span><span class="s4">= </span><span class="s1">_get_n_samples_bootstrap</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">max_samples</span><span class="s4">)</span>
    <span class="s1">n_samples_test </span><span class="s4">= </span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] // </span><span class="s5">4</span>
    <span class="s1">oob_pred </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">([</span><span class="s1">n_samples_test</span><span class="s4">, </span><span class="s5">2</span><span class="s4">])</span>
    <span class="s3">for </span><span class="s1">sample_idx</span><span class="s4">, </span><span class="s1">sample </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">X</span><span class="s4">[:</span><span class="s1">n_samples_test</span><span class="s4">]):</span>
        <span class="s1">n_samples_oob </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">oob_pred_sample </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s5">2</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">:</span>
            <span class="s1">oob_unsampled_indices </span><span class="s4">= </span><span class="s1">_generate_unsampled_indices</span><span class="s4">(</span>
                <span class="s1">tree</span><span class="s4">.</span><span class="s1">random_state</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">n_samples_bootstrap</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">sample_idx </span><span class="s3">in </span><span class="s1">oob_unsampled_indices</span><span class="s4">:</span>
                <span class="s1">n_samples_oob </span><span class="s4">+= </span><span class="s5">1</span>
                <span class="s1">oob_pred_sample </span><span class="s4">+= </span><span class="s1">tree</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">sample</span><span class="s4">.</span><span class="s1">reshape</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">)).</span><span class="s1">squeeze</span><span class="s4">()</span>
        <span class="s1">oob_pred</span><span class="s4">[</span><span class="s1">sample_idx</span><span class="s4">] = </span><span class="s1">oob_pred_sample </span><span class="s4">/ </span><span class="s1">n_samples_oob</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">oob_pred</span><span class="s4">, </span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">oob_prediction_</span><span class="s4">[:</span><span class="s1">n_samples_test</span><span class="s4">])</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;oob_score&quot;</span><span class="s4">, [</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_random_trees_embedding_raise_error_oob</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">):</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;got an unexpected keyword argument&quot;</span><span class="s4">):</span>
        <span class="s1">RandomTreesEmbedding</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">=</span><span class="s1">oob_score</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">NotImplementedError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;OOB score not supported&quot;</span><span class="s4">):</span>
        <span class="s1">RandomTreesEmbedding</span><span class="s4">().</span><span class="s1">_set_oob_score_and_attributes</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_gridsearch</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check that base trees can be grid-searched.</span>
    <span class="s1">forest </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]()</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">GridSearchCV</span><span class="s4">(</span><span class="s1">forest</span><span class="s4">, {</span><span class="s6">&quot;n_estimators&quot;</span><span class="s4">: (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">), </span><span class="s6">&quot;max_depth&quot;</span><span class="s4">: (</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)})</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_parallel</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check parallel computations in classification&quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">:</span>
        <span class="s1">X </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span>
    <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">:</span>
        <span class="s1">X </span><span class="s4">= </span><span class="s1">X_reg</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">y_reg</span>

    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">forest </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>

    <span class="s1">forest</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">forest</span><span class="s4">) == </span><span class="s5">10</span>

    <span class="s1">forest</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">y1 </span><span class="s4">= </span><span class="s1">forest</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">forest</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">y2 </span><span class="s4">= </span><span class="s1">forest</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">y1</span><span class="s4">, </span><span class="s1">y2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_pickle</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check pickability.</span>
    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">:</span>
        <span class="s1">X </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[::</span><span class="s5">2</span><span class="s4">]</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">[::</span><span class="s5">2</span><span class="s4">]</span>
    <span class="s3">elif </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">:</span>
        <span class="s1">X </span><span class="s4">= </span><span class="s1">X_reg</span><span class="s4">[::</span><span class="s5">2</span><span class="s4">]</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">y_reg</span><span class="s4">[::</span><span class="s5">2</span><span class="s4">]</span>

    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">obj </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">obj</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">score </span><span class="s4">= </span><span class="s1">obj</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">pickle_object </span><span class="s4">= </span><span class="s1">pickle</span><span class="s4">.</span><span class="s1">dumps</span><span class="s4">(</span><span class="s1">obj</span><span class="s4">)</span>

    <span class="s1">obj2 </span><span class="s4">= </span><span class="s1">pickle</span><span class="s4">.</span><span class="s1">loads</span><span class="s4">(</span><span class="s1">pickle_object</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">type</span><span class="s4">(</span><span class="s1">obj2</span><span class="s4">) == </span><span class="s1">obj</span><span class="s4">.</span><span class="s1">__class__</span>
    <span class="s1">score2 </span><span class="s4">= </span><span class="s1">obj2</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">score </span><span class="s4">== </span><span class="s1">score2</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_multioutput</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check estimators on multi-output problems.</span>

    <span class="s1">X_train </span><span class="s4">= [</span>
        <span class="s4">[-</span><span class="s5">2</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">2</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">],</span>
    <span class="s4">]</span>
    <span class="s1">y_train </span><span class="s4">= [</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">],</span>
    <span class="s4">]</span>
    <span class="s1">X_test </span><span class="s4">= [[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">]]</span>
    <span class="s1">y_test </span><span class="s4">= [[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">]]</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">y_pred </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">y_pred</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">:</span>
        <span class="s3">with </span><span class="s1">np</span><span class="s4">.</span><span class="s1">errstate</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">):</span>
            <span class="s1">proba </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">proba</span><span class="s4">) == </span><span class="s5">2</span>
            <span class="s3">assert </span><span class="s1">proba</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">proba</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)</span>

            <span class="s1">log_proba </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">log_proba</span><span class="s4">) == </span><span class="s5">2</span>
            <span class="s3">assert </span><span class="s1">log_proba</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)</span>
            <span class="s3">assert </span><span class="s1">log_proba</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_multioutput_string</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check estimators on multi-output problems with string outputs.</span>

    <span class="s1">X_train </span><span class="s4">= [</span>
        <span class="s4">[-</span><span class="s5">2</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">2</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">2</span><span class="s4">],</span>
    <span class="s4">]</span>
    <span class="s1">y_train </span><span class="s4">= [</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;blue&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;blue&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;blue&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;green&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;green&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;green&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;purple&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;purple&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;purple&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;yellow&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;yellow&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;yellow&quot;</span><span class="s4">],</span>
    <span class="s4">]</span>
    <span class="s1">X_test </span><span class="s4">= [[-</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [</span><span class="s5">1</span><span class="s4">, -</span><span class="s5">1</span><span class="s4">]]</span>
    <span class="s1">y_test </span><span class="s4">= [</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;blue&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;green&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;red&quot;</span><span class="s4">, </span><span class="s6">&quot;purple&quot;</span><span class="s4">],</span>
        <span class="s4">[</span><span class="s6">&quot;green&quot;</span><span class="s4">, </span><span class="s6">&quot;yellow&quot;</span><span class="s4">],</span>
    <span class="s4">]</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">y_pred </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">y_pred</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">np</span><span class="s4">.</span><span class="s1">errstate</span><span class="s4">(</span><span class="s1">divide</span><span class="s4">=</span><span class="s6">&quot;ignore&quot;</span><span class="s4">):</span>
        <span class="s1">proba </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">proba</span><span class="s4">) == </span><span class="s5">2</span>
        <span class="s3">assert </span><span class="s1">proba</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">proba</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)</span>

        <span class="s1">log_proba </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">log_proba</span><span class="s4">) == </span><span class="s5">2</span>
        <span class="s3">assert </span><span class="s1">log_proba</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">log_proba</span><span class="s4">[</span><span class="s5">1</span><span class="s4">].</span><span class="s1">shape </span><span class="s4">== (</span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_classes_shape</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test that n_classes_ and classes_ have proper shape.</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s2"># Classification, single output</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">n_classes_ </span><span class="s4">== </span><span class="s5">2</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">classes_</span><span class="s4">, [-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>

    <span class="s2"># Classification, multi-output</span>
    <span class="s1">_y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">vstack</span><span class="s4">((</span><span class="s1">y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">y</span><span class="s4">) * </span><span class="s5">2</span><span class="s4">)).</span><span class="s1">T</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">_y</span><span class="s4">)</span>

    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">n_classes_</span><span class="s4">, [</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">])</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">classes_</span><span class="s4">, [[-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">], [-</span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s4">]])</span>


<span class="s3">def </span><span class="s1">test_random_trees_dense_type</span><span class="s4">():</span>
    <span class="s2"># Test that the `sparse_output` parameter of RandomTreesEmbedding</span>
    <span class="s2"># works by returning a dense array.</span>

    <span class="s2"># Create the RTE with sparse=False</span>
    <span class="s1">hasher </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">sparse_output</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_circles</span><span class="s4">(</span><span class="s1">factor</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">)</span>
    <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>

    <span class="s2"># Assert that type is ndarray, not scipy.sparse.csr_matrix</span>
    <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">X_transformed</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ndarray</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_random_trees_dense_equal</span><span class="s4">():</span>
    <span class="s2"># Test that the `sparse_output` parameter of RandomTreesEmbedding</span>
    <span class="s2"># works by returning the same array for both argument values.</span>

    <span class="s2"># Create the RTEs</span>
    <span class="s1">hasher_dense </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">sparse_output</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">hasher_sparse </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">sparse_output</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_circles</span><span class="s4">(</span><span class="s1">factor</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">)</span>
    <span class="s1">X_transformed_dense </span><span class="s4">= </span><span class="s1">hasher_dense</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">X_transformed_sparse </span><span class="s4">= </span><span class="s1">hasher_sparse</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>

    <span class="s2"># Assert that dense and sparse hashers have same array.</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">X_transformed_sparse</span><span class="s4">.</span><span class="s1">toarray</span><span class="s4">(), </span><span class="s1">X_transformed_dense</span><span class="s4">)</span>


<span class="s2"># Ignore warnings from switching to more power iterations in randomized_svd</span>
<span class="s4">@</span><span class="s1">ignore_warnings</span>
<span class="s3">def </span><span class="s1">test_random_hasher</span><span class="s4">():</span>
    <span class="s2"># test random forest hashing on circles dataset</span>
    <span class="s2"># make sure that it is linearly separable.</span>
    <span class="s2"># even after projected to two SVD dimensions</span>
    <span class="s2"># Note: Not all random_states produce perfect results.</span>
    <span class="s1">hasher </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">30</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_circles</span><span class="s4">(</span><span class="s1">factor</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">)</span>
    <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>

    <span class="s2"># test fit and transform:</span>
    <span class="s1">hasher </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">30</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">).</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">).</span><span class="s1">toarray</span><span class="s4">(), </span><span class="s1">X_transformed</span><span class="s4">.</span><span class="s1">toarray</span><span class="s4">())</span>

    <span class="s2"># one leaf active per data point per forest</span>
    <span class="s3">assert </span><span class="s1">X_transformed</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] == </span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">X_transformed</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">axis</span><span class="s4">=</span><span class="s5">1</span><span class="s4">), </span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">n_estimators</span><span class="s4">)</span>
    <span class="s1">svd </span><span class="s4">= </span><span class="s1">TruncatedSVD</span><span class="s4">(</span><span class="s1">n_components</span><span class="s4">=</span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">X_reduced </span><span class="s4">= </span><span class="s1">svd</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X_transformed</span><span class="s4">)</span>
    <span class="s1">linear_clf </span><span class="s4">= </span><span class="s1">LinearSVC</span><span class="s4">()</span>
    <span class="s1">linear_clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_reduced</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">linear_clf</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_reduced</span><span class="s4">, </span><span class="s1">y</span><span class="s4">) == </span><span class="s5">1.0</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;csc_container&quot;</span><span class="s4">, </span><span class="s1">CSC_CONTAINERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_random_hasher_sparse_data</span><span class="s4">(</span><span class="s1">csc_container</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_multilabel_classification</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">hasher </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">30</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">X_transformed </span><span class="s4">= </span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">X_transformed_sparse </span><span class="s4">= </span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">csc_container</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">X_transformed_sparse</span><span class="s4">.</span><span class="s1">toarray</span><span class="s4">(), </span><span class="s1">X_transformed</span><span class="s4">.</span><span class="s1">toarray</span><span class="s4">())</span>


<span class="s3">def </span><span class="s1">test_parallel_train</span><span class="s4">():</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">check_random_state</span><span class="s4">(</span><span class="s5">12321</span><span class="s4">)</span>
    <span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s5">80</span><span class="s4">, </span><span class="s5">30</span>
    <span class="s1">X_train </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randn</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">)</span>
    <span class="s1">y_train </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s1">n_samples</span><span class="s4">)</span>

    <span class="s1">clfs </span><span class="s4">= [</span>
        <span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">20</span><span class="s4">, </span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s1">n_jobs</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">12345</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span>
            <span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span>
        <span class="s4">)</span>
        <span class="s3">for </span><span class="s1">n_jobs </span><span class="s3">in </span><span class="s4">[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">16</span><span class="s4">, </span><span class="s5">32</span><span class="s4">]</span>
    <span class="s4">]</span>

    <span class="s1">X_test </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randn</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">)</span>
    <span class="s1">probas </span><span class="s4">= [</span><span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">) </span><span class="s3">for </span><span class="s1">clf </span><span class="s3">in </span><span class="s1">clfs</span><span class="s4">]</span>
    <span class="s3">for </span><span class="s1">proba1</span><span class="s4">, </span><span class="s1">proba2 </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">probas</span><span class="s4">, </span><span class="s1">probas</span><span class="s4">[</span><span class="s5">1</span><span class="s4">:]):</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">proba1</span><span class="s4">, </span><span class="s1">proba2</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_distribution</span><span class="s4">():</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">check_random_state</span><span class="s4">(</span><span class="s5">12321</span><span class="s4">)</span>

    <span class="s2"># Single variable with 4 values</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=(</span><span class="s5">1000</span><span class="s4">, </span><span class="s5">1</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s5">1000</span><span class="s4">)</span>
    <span class="s1">n_trees </span><span class="s4">= </span><span class="s5">500</span>

    <span class="s1">reg </span><span class="s4">= </span><span class="s1">ExtraTreesRegressor</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s1">n_trees</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">uniques </span><span class="s4">= </span><span class="s1">defaultdict</span><span class="s4">(</span><span class="s1">int</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">:</span>
        <span class="s1">tree </span><span class="s4">= </span><span class="s6">&quot;&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
            <span class="s4">(</span><span class="s6">&quot;%d,%d/&quot; </span><span class="s4">% (</span><span class="s1">f</span><span class="s4">, </span><span class="s1">int</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)) </span><span class="s3">if </span><span class="s1">f </span><span class="s4">&gt;= </span><span class="s5">0 </span><span class="s3">else </span><span class="s6">&quot;-&quot;</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">f</span><span class="s4">, </span><span class="s1">t </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">tree</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">feature</span><span class="s4">, </span><span class="s1">tree</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">threshold</span><span class="s4">)</span>
        <span class="s4">)</span>

        <span class="s1">uniques</span><span class="s4">[</span><span class="s1">tree</span><span class="s4">] += </span><span class="s5">1</span>

    <span class="s1">uniques </span><span class="s4">= </span><span class="s1">sorted</span><span class="s4">([(</span><span class="s5">1.0 </span><span class="s4">* </span><span class="s1">count </span><span class="s4">/ </span><span class="s1">n_trees</span><span class="s4">, </span><span class="s1">tree</span><span class="s4">) </span><span class="s3">for </span><span class="s1">tree</span><span class="s4">, </span><span class="s1">count </span><span class="s3">in </span><span class="s1">uniques</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()])</span>

    <span class="s2"># On a single variable problem where X_0 has 4 equiprobable values, there</span>
    <span class="s2"># are 5 ways to build a random tree. The more compact (0,1/0,0/--0,2/--) of</span>
    <span class="s2"># them has probability 1/3 while the 4 others have probability 1/6.</span>

    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">uniques</span><span class="s4">) == </span><span class="s5">5</span>
    <span class="s3">assert </span><span class="s5">0.20 </span><span class="s4">&gt; </span><span class="s1">uniques</span><span class="s4">[</span><span class="s5">0</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]  </span><span class="s2"># Rough approximation of 1/6.</span>
    <span class="s3">assert </span><span class="s5">0.20 </span><span class="s4">&gt; </span><span class="s1">uniques</span><span class="s4">[</span><span class="s5">1</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s5">0.20 </span><span class="s4">&gt; </span><span class="s1">uniques</span><span class="s4">[</span><span class="s5">2</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s5">0.20 </span><span class="s4">&gt; </span><span class="s1">uniques</span><span class="s4">[</span><span class="s5">3</span><span class="s4">][</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s1">uniques</span><span class="s4">[</span><span class="s5">4</span><span class="s4">][</span><span class="s5">0</span><span class="s4">] &gt; </span><span class="s5">0.3</span>
    <span class="s3">assert </span><span class="s1">uniques</span><span class="s4">[</span><span class="s5">4</span><span class="s4">][</span><span class="s5">1</span><span class="s4">] == </span><span class="s6">&quot;0,1/0,0/--0,2/--&quot;</span>

    <span class="s2"># Two variables, one with 2 values, one with 3 values</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">empty</span><span class="s4">((</span><span class="s5">1000</span><span class="s4">, </span><span class="s5">2</span><span class="s4">))</span>
    <span class="s1">X</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1000</span><span class="s4">)</span>
    <span class="s1">X</span><span class="s4">[:, </span><span class="s5">1</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1000</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s5">1000</span><span class="s4">)</span>

    <span class="s1">reg </span><span class="s4">= </span><span class="s1">ExtraTreesRegressor</span><span class="s4">(</span><span class="s1">max_features</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">uniques </span><span class="s4">= </span><span class="s1">defaultdict</span><span class="s4">(</span><span class="s1">int</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">reg</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">:</span>
        <span class="s1">tree </span><span class="s4">= </span><span class="s6">&quot;&quot;</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span>
            <span class="s4">(</span><span class="s6">&quot;%d,%d/&quot; </span><span class="s4">% (</span><span class="s1">f</span><span class="s4">, </span><span class="s1">int</span><span class="s4">(</span><span class="s1">t</span><span class="s4">)) </span><span class="s3">if </span><span class="s1">f </span><span class="s4">&gt;= </span><span class="s5">0 </span><span class="s3">else </span><span class="s6">&quot;-&quot;</span><span class="s4">)</span>
            <span class="s3">for </span><span class="s1">f</span><span class="s4">, </span><span class="s1">t </span><span class="s3">in </span><span class="s1">zip</span><span class="s4">(</span><span class="s1">tree</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">feature</span><span class="s4">, </span><span class="s1">tree</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">threshold</span><span class="s4">)</span>
        <span class="s4">)</span>

        <span class="s1">uniques</span><span class="s4">[</span><span class="s1">tree</span><span class="s4">] += </span><span class="s5">1</span>

    <span class="s1">uniques </span><span class="s4">= [(</span><span class="s1">count</span><span class="s4">, </span><span class="s1">tree</span><span class="s4">) </span><span class="s3">for </span><span class="s1">tree</span><span class="s4">, </span><span class="s1">count </span><span class="s3">in </span><span class="s1">uniques</span><span class="s4">.</span><span class="s1">items</span><span class="s4">()]</span>
    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">uniques</span><span class="s4">) == </span><span class="s5">8</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_max_leaf_nodes_max_depth</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>

    <span class="s2"># Test precedence of max_leaf_nodes over max_depth.</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">max_leaf_nodes</span><span class="s4">=</span><span class="s5">4</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">get_depth</span><span class="s4">() == </span><span class="s5">1</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">get_depth</span><span class="s4">() == </span><span class="s5">1</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_min_samples_split</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">min_samples_split</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">node_idx </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">children_left </span><span class="s4">!= -</span><span class="s5">1</span>
    <span class="s1">node_samples </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">n_node_samples</span><span class="s4">[</span><span class="s1">node_idx</span><span class="s4">]</span>

    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">node_samples</span><span class="s4">) &gt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">) * </span><span class="s5">0.5 </span><span class="s4">- </span><span class="s5">1</span><span class="s4">, </span><span class="s6">&quot;Failed with {0}&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">min_samples_split</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">node_idx </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">children_left </span><span class="s4">!= -</span><span class="s5">1</span>
    <span class="s1">node_samples </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">n_node_samples</span><span class="s4">[</span><span class="s1">node_idx</span><span class="s4">]</span>

    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">node_samples</span><span class="s4">) &gt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">) * </span><span class="s5">0.5 </span><span class="s4">- </span><span class="s5">1</span><span class="s4">, </span><span class="s6">&quot;Failed with {0}&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_min_samples_leaf</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>

    <span class="s2"># Test if leaves contain more than leaf_count training examples</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">min_samples_leaf</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">out </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">node_counts </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bincount</span><span class="s4">(</span><span class="s1">out</span><span class="s4">)</span>
    <span class="s2"># drop inner nodes</span>
    <span class="s1">leaf_count </span><span class="s4">= </span><span class="s1">node_counts</span><span class="s4">[</span><span class="s1">node_counts </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">leaf_count</span><span class="s4">) &gt; </span><span class="s5">4</span><span class="s4">, </span><span class="s6">&quot;Failed with {0}&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">min_samples_leaf</span><span class="s4">=</span><span class="s5">0.25</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">out </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">node_counts </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bincount</span><span class="s4">(</span><span class="s1">out</span><span class="s4">)</span>
    <span class="s2"># drop inner nodes</span>
    <span class="s1">leaf_count </span><span class="s4">= </span><span class="s1">node_counts</span><span class="s4">[</span><span class="s1">node_counts </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">leaf_count</span><span class="s4">) &gt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">) * </span><span class="s5">0.25 </span><span class="s4">- </span><span class="s5">1</span><span class="s4">, </span><span class="s6">&quot;Failed with {0}&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_min_weight_fraction_leaf</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>

    <span class="s2"># Test if leaves contain at least min_weight_fraction_leaf of the</span>
    <span class="s2"># training set</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">weights </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">rand</span><span class="s4">(</span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">])</span>
    <span class="s1">total_weight </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">weights</span><span class="s4">)</span>

    <span class="s2"># test both DepthFirstTreeBuilder and BestFirstTreeBuilder</span>
    <span class="s2"># by setting max_leaf_nodes</span>
    <span class="s3">for </span><span class="s1">frac </span><span class="s3">in </span><span class="s1">np</span><span class="s4">.</span><span class="s1">linspace</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">):</span>
        <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
            <span class="s1">min_weight_fraction_leaf</span><span class="s4">=</span><span class="s1">frac</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
        <span class="s4">)</span>
        <span class="s3">if </span><span class="s6">&quot;RandomForest&quot; </span><span class="s3">in </span><span class="s1">name</span><span class="s4">:</span>
            <span class="s1">est</span><span class="s4">.</span><span class="s1">bootstrap </span><span class="s4">= </span><span class="s3">False</span>

        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">=</span><span class="s1">weights</span><span class="s4">)</span>
        <span class="s1">out </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
        <span class="s1">node_weights </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">bincount</span><span class="s4">(</span><span class="s1">out</span><span class="s4">, </span><span class="s1">weights</span><span class="s4">=</span><span class="s1">weights</span><span class="s4">)</span>
        <span class="s2"># drop inner nodes</span>
        <span class="s1">leaf_weights </span><span class="s4">= </span><span class="s1">node_weights</span><span class="s4">[</span><span class="s1">node_weights </span><span class="s4">!= </span><span class="s5">0</span><span class="s4">]</span>
        <span class="s3">assert </span><span class="s4">(</span>
            <span class="s1">np</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">leaf_weights</span><span class="s4">) &gt;= </span><span class="s1">total_weight </span><span class="s4">* </span><span class="s1">est</span><span class="s4">.</span><span class="s1">min_weight_fraction_leaf</span>
        <span class="s4">), </span><span class="s6">&quot;Failed with {0} min_weight_fraction_leaf={1}&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span>
            <span class="s1">name</span><span class="s4">, </span><span class="s1">est</span><span class="s4">.</span><span class="s1">min_weight_fraction_leaf</span>
        <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;sparse_container&quot;</span><span class="s4">, </span><span class="s1">COO_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSR_CONTAINERS</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_sparse_input</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">sparse_container</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_multilabel_classification</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">50</span><span class="s4">)</span>

    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">dense </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">2</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">sparse </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">2</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">sparse_container</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">sparse</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>

    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_CLASSIFIERS </span><span class="s3">or </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">:</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">sparse</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span>
            <span class="s1">sparse</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">feature_importances_</span>
        <span class="s4">)</span>

    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">:</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">sparse</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span>
            <span class="s1">sparse</span><span class="s4">.</span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">predict_log_proba</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
        <span class="s4">)</span>

    <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_TRANSFORMERS</span><span class="s4">:</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span>
            <span class="s1">sparse</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">).</span><span class="s1">toarray</span><span class="s4">(), </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">).</span><span class="s1">toarray</span><span class="s4">()</span>
        <span class="s4">)</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span>
            <span class="s1">sparse</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">).</span><span class="s1">toarray</span><span class="s4">(), </span><span class="s1">dense</span><span class="s4">.</span><span class="s1">fit_transform</span><span class="s4">(</span><span class="s1">X</span><span class="s4">).</span><span class="s1">toarray</span><span class="s4">()</span>
        <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;dtype&quot;</span><span class="s4">, (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">float32</span><span class="s4">))</span>
<span class="s3">def </span><span class="s1">test_memory_layout</span><span class="s4">(</span><span class="s1">name</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">):</span>
    <span class="s2"># Test that it works no matter the memory layout</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s2"># Dense</span>
    <span class="s3">for </span><span class="s1">container</span><span class="s4">, </span><span class="s1">kwargs </span><span class="s3">in </span><span class="s4">(</span>
        <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">, {}),  </span><span class="s2"># Nothing</span>
        <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">, {</span><span class="s6">&quot;order&quot;</span><span class="s4">: </span><span class="s6">&quot;C&quot;</span><span class="s4">}),  </span><span class="s2"># C-order</span>
        <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">, {</span><span class="s6">&quot;order&quot;</span><span class="s4">: </span><span class="s6">&quot;F&quot;</span><span class="s4">}),  </span><span class="s2"># F-order</span>
        <span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">ascontiguousarray</span><span class="s4">, {}),  </span><span class="s2"># Contiguous</span>
    <span class="s4">):</span>
        <span class="s1">X </span><span class="s4">= </span><span class="s1">container</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dtype</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s2"># Sparse (if applicable)</span>
    <span class="s3">if </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">splitter </span><span class="s3">in </span><span class="s1">SPARSE_SPLITTERS</span><span class="s4">:</span>
        <span class="s3">for </span><span class="s1">sparse_container </span><span class="s3">in </span><span class="s1">COO_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSC_CONTAINERS </span><span class="s4">+ </span><span class="s1">CSR_CONTAINERS</span><span class="s4">:</span>
            <span class="s1">X </span><span class="s4">= </span><span class="s1">sparse_container</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dtype</span><span class="s4">)</span>
            <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span>
            <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s2"># Strided</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">asarray</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[::</span><span class="s5">3</span><span class="s4">], </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">dtype</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">[::</span><span class="s5">3</span><span class="s4">]</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_1d_input</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">]</span>
    <span class="s1">X_2d </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">[:, </span><span class="s5">0</span><span class="s4">].</span><span class="s1">reshape</span><span class="s4">((-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span>

    <span class="s3">with </span><span class="s1">ignore_warnings</span><span class="s4">():</span>
        <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

        <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_2d</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_CLASSIFIERS </span><span class="s3">or </span><span class="s1">name </span><span class="s3">in </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">:</span>
            <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
                <span class="s1">est</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_class_weights</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check class_weights resemble sample_weights behavior.</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s2"># Iris is balanced, so no effect expected for using 'balanced' weights</span>
    <span class="s1">clf1 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf1</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">clf2 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s6">&quot;balanced&quot;</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">clf1</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">clf2</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">)</span>

    <span class="s2"># Make a multi-output problem with three copies of Iris</span>
    <span class="s1">iris_multi </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">vstack</span><span class="s4">((</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)).</span><span class="s1">T</span>
    <span class="s2"># Create user-defined weights that should balance over the outputs</span>
    <span class="s1">clf3 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span>
        <span class="s1">class_weight</span><span class="s4">=[</span>
            <span class="s4">{</span><span class="s5">0</span><span class="s4">: </span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">},</span>
            <span class="s4">{</span><span class="s5">0</span><span class="s4">: </span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s5">2.0</span><span class="s4">},</span>
            <span class="s4">{</span><span class="s5">0</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s5">2.0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s5">2.0</span><span class="s4">},</span>
        <span class="s4">],</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">clf3</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris_multi</span><span class="s4">)</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">clf2</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">clf3</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">)</span>
    <span class="s2"># Check against multi-output &quot;balanced&quot; which should also have no effect</span>
    <span class="s1">clf4 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s6">&quot;balanced&quot;</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf4</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris_multi</span><span class="s4">)</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">clf3</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">clf4</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">)</span>

    <span class="s2"># Inflate importance of class 1, check against user-defined weights</span>
    <span class="s1">sample_weight </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">)</span>
    <span class="s1">sample_weight</span><span class="s4">[</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target </span><span class="s4">== </span><span class="s5">1</span><span class="s4">] *= </span><span class="s5">100</span>
    <span class="s1">class_weight </span><span class="s4">= {</span><span class="s5">0</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s5">100.0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">}</span>
    <span class="s1">clf1 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf1</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">)</span>
    <span class="s1">clf2 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s1">class_weight</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">)</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">clf1</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">clf2</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">)</span>

    <span class="s2"># Check that sample_weight and class_weight are multiplicative</span>
    <span class="s1">clf1 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf1</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">**</span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">clf2 </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s1">class_weight</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">iris</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">iris</span><span class="s4">.</span><span class="s1">target</span><span class="s4">, </span><span class="s1">sample_weight</span><span class="s4">)</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">clf1</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">clf2</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_class_weight_balanced_and_bootstrap_multi_output</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test class_weight works for multi-output&quot;&quot;&quot;</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">_y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">vstack</span><span class="s4">((</span><span class="s1">y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">y</span><span class="s4">) * </span><span class="s5">2</span><span class="s4">)).</span><span class="s1">T</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s6">&quot;balanced&quot;</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">_y</span><span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span>
        <span class="s1">class_weight</span><span class="s4">=[{-</span><span class="s5">1</span><span class="s4">: </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">}, {-</span><span class="s5">2</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">}], </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">_y</span><span class="s4">)</span>
    <span class="s2"># smoke test for balanced subsample</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s6">&quot;balanced_subsample&quot;</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">_y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_class_weight_errors</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test if class_weight raises errors and warnings when expected.</span>
    <span class="s1">ForestClassifier </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">_y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">vstack</span><span class="s4">((</span><span class="s1">y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">y</span><span class="s4">) * </span><span class="s5">2</span><span class="s4">)).</span><span class="s1">T</span>

    <span class="s2"># Warning warm_start with preset</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=</span><span class="s6">&quot;balanced&quot;</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">warn_msg </span><span class="s4">= (</span>
        <span class="s6">&quot;Warm-start fitting without increasing n_estimators does not fit new trees.&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span><span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">warn_msg</span><span class="s4">):</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">_y</span><span class="s4">)</span>

    <span class="s2"># Incorrect length list for multi-output</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">ForestClassifier</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">=[{-</span><span class="s5">1</span><span class="s4">: </span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">1</span><span class="s4">: </span><span class="s5">1.0</span><span class="s4">}], </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">_y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_warm_start</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test if fitting incrementally with warm start gives a forest of the</span>
    <span class="s2"># right size and the same results as a normal fit.</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">est_ws </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">for </span><span class="s1">n_estimators </span><span class="s3">in </span><span class="s4">[</span><span class="s5">5</span><span class="s4">, </span><span class="s5">10</span><span class="s4">]:</span>
        <span class="s3">if </span><span class="s1">est_ws </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s1">est_ws </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
                <span class="s1">n_estimators</span><span class="s4">=</span><span class="s1">n_estimators</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span>
            <span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">est_ws</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s1">n_estimators</span><span class="s4">)</span>
        <span class="s1">est_ws</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
        <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">est_ws</span><span class="s4">) == </span><span class="s1">n_estimators</span>

    <span class="s1">est_no_ws </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">est_no_ws</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">set</span><span class="s4">([</span><span class="s1">tree</span><span class="s4">.</span><span class="s1">random_state </span><span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">est_ws</span><span class="s4">]) == </span><span class="s1">set</span><span class="s4">(</span>
        <span class="s4">[</span><span class="s1">tree</span><span class="s4">.</span><span class="s1">random_state </span><span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">est_no_ws</span><span class="s4">]</span>
    <span class="s4">)</span>

    <span class="s1">assert_array_equal</span><span class="s4">(</span>
        <span class="s1">est_ws</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">est_no_ws</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">err_msg</span><span class="s4">=</span><span class="s6">&quot;Failed with {0}&quot;</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">name</span><span class="s4">)</span>
    <span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_warm_start_clear</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test if fit clears state and grows a new forest when warm_start==False.</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">est_2 </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">2</span>
    <span class="s4">)</span>
    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)  </span><span class="s2"># inits state</span>
    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)  </span><span class="s2"># clears old state and equals est</span>

    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">est_2</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">est</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_warm_start_smaller_n_estimators</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test if warm start second fit with smaller n_estimators raises error.</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">4</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_warm_start_equal_n_estimators</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test if warm start with equal n_estimators does nothing and returns the</span>
    <span class="s2"># same forest and raises a warning.</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">est_2 </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span>
    <span class="s4">)</span>
    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s2"># Now est_2 equals est.</span>

    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">warn_msg </span><span class="s4">= (</span>
        <span class="s6">&quot;Warm-start fitting without increasing n_estimators does not fit new trees.&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span><span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">warn_msg</span><span class="s4">):</span>
        <span class="s1">est_2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s2"># If we had fit the trees again we would have got a different forest as we</span>
    <span class="s2"># changed the random state.</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">est</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">), </span><span class="s1">est_2</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_warm_start_oob</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Test that the warm start computes oob score when asked.</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s2"># Use 15 estimators to avoid 'some inputs do not have OOB scores' warning.</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">15</span><span class="s4">,</span>
        <span class="s1">max_depth</span><span class="s4">=</span><span class="s5">3</span><span class="s4">,</span>
        <span class="s1">warm_start</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">est_2 </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">,</span>
        <span class="s1">max_depth</span><span class="s4">=</span><span class="s5">3</span><span class="s4">,</span>
        <span class="s1">warm_start</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">oob_score</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">15</span><span class="s4">)</span>
    <span class="s1">est_2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">est_2</span><span class="s4">, </span><span class="s6">&quot;oob_score_&quot;</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">oob_score_ </span><span class="s4">== </span><span class="s1">est_2</span><span class="s4">.</span><span class="s1">oob_score_</span>

    <span class="s2"># Test that oob_score is computed even if we don't need to train</span>
    <span class="s2"># additional trees.</span>
    <span class="s1">est_3 </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">15</span><span class="s4">,</span>
        <span class="s1">max_depth</span><span class="s4">=</span><span class="s5">3</span><span class="s4">,</span>
        <span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">oob_score</span><span class="s4">=</span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">est_3</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert not </span><span class="s1">hasattr</span><span class="s4">(</span><span class="s1">est_3</span><span class="s4">, </span><span class="s6">&quot;oob_score_&quot;</span><span class="s4">)</span>

    <span class="s1">est_3</span><span class="s4">.</span><span class="s1">set_params</span><span class="s4">(</span><span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">ignore_warnings</span><span class="s4">(</span><span class="s1">est_3</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">)(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">est</span><span class="s4">.</span><span class="s1">oob_score_ </span><span class="s4">== </span><span class="s1">est_3</span><span class="s4">.</span><span class="s1">oob_score_</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_oob_not_computed_twice</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check that oob_score is not computed twice when warm_start=True.</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>

    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">oob_score</span><span class="s4">=</span><span class="s3">True</span>
    <span class="s4">)</span>

    <span class="s3">with </span><span class="s1">patch</span><span class="s4">.</span><span class="s1">object</span><span class="s4">(</span>
        <span class="s1">est</span><span class="s4">, </span><span class="s6">&quot;_set_oob_score_and_attributes&quot;</span><span class="s4">, </span><span class="s1">wraps</span><span class="s4">=</span><span class="s1">est</span><span class="s4">.</span><span class="s1">_set_oob_score_and_attributes</span>
    <span class="s4">) </span><span class="s3">as </span><span class="s1">mock_set_oob_score_and_attributes</span><span class="s4">:</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

        <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span><span class="s1">UserWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s6">&quot;Warm-start fitting without increasing&quot;</span><span class="s4">):</span>
            <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

        <span class="s1">mock_set_oob_score_and_attributes</span><span class="s4">.</span><span class="s1">assert_called_once</span><span class="s4">()</span>


<span class="s3">def </span><span class="s1">test_dtype_convert</span><span class="s4">(</span><span class="s1">n_classes</span><span class="s4">=</span><span class="s5">15</span><span class="s4">):</span>
    <span class="s1">classifier </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>

    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">eye</span><span class="s4">(</span><span class="s1">n_classes</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= [</span><span class="s1">ch </span><span class="s3">for </span><span class="s1">ch </span><span class="s3">in </span><span class="s6">&quot;ABCDEFGHIJKLMNOPQRSTU&quot;</span><span class="s4">[:</span><span class="s1">n_classes</span><span class="s4">]]</span>

    <span class="s1">result </span><span class="s4">= </span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">classifier</span><span class="s4">.</span><span class="s1">classes_</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">result</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_decision_path</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">hastie_X</span><span class="s4">, </span><span class="s1">hastie_y</span>
    <span class="s1">n_samples </span><span class="s4">= </span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]</span>
    <span class="s1">ForestEstimator </span><span class="s4">= </span><span class="s1">FOREST_ESTIMATORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">]</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestEstimator</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">warm_start</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">indicator</span><span class="s4">, </span><span class="s1">n_nodes_ptr </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">decision_path</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">indicator</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">] == </span><span class="s1">n_nodes_ptr</span><span class="s4">[-</span><span class="s5">1</span><span class="s4">]</span>
    <span class="s3">assert </span><span class="s1">indicator</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">0</span><span class="s4">] == </span><span class="s1">n_samples</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span>
        <span class="s1">np</span><span class="s4">.</span><span class="s1">diff</span><span class="s4">(</span><span class="s1">n_nodes_ptr</span><span class="s4">), [</span><span class="s1">e</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">node_count </span><span class="s3">for </span><span class="s1">e </span><span class="s3">in </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">]</span>
    <span class="s4">)</span>

    <span class="s2"># Assert that leaves index are correct</span>
    <span class="s1">leaves </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">apply</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s3">for </span><span class="s1">est_id </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">leaves</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s5">1</span><span class="s4">]):</span>
        <span class="s1">leave_indicator </span><span class="s4">= [</span>
            <span class="s1">indicator</span><span class="s4">[</span><span class="s1">i</span><span class="s4">, </span><span class="s1">n_nodes_ptr</span><span class="s4">[</span><span class="s1">est_id</span><span class="s4">] + </span><span class="s1">j</span><span class="s4">]</span>
            <span class="s3">for </span><span class="s1">i</span><span class="s4">, </span><span class="s1">j </span><span class="s3">in </span><span class="s1">enumerate</span><span class="s4">(</span><span class="s1">leaves</span><span class="s4">[:, </span><span class="s1">est_id</span><span class="s4">])</span>
        <span class="s4">]</span>
        <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">leave_indicator</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">(</span><span class="s1">shape</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">))</span>


<span class="s3">def </span><span class="s1">test_min_impurity_decrease</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_hastie_10_2</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">100</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">all_estimators </span><span class="s4">= [</span>
        <span class="s1">RandomForestClassifier</span><span class="s4">,</span>
        <span class="s1">RandomForestRegressor</span><span class="s4">,</span>
        <span class="s1">ExtraTreesClassifier</span><span class="s4">,</span>
        <span class="s1">ExtraTreesRegressor</span><span class="s4">,</span>
    <span class="s4">]</span>

    <span class="s3">for </span><span class="s1">Estimator </span><span class="s3">in </span><span class="s1">all_estimators</span><span class="s4">:</span>
        <span class="s1">est </span><span class="s4">= </span><span class="s1">Estimator</span><span class="s4">(</span><span class="s1">min_impurity_decrease</span><span class="s4">=</span><span class="s5">0.1</span><span class="s4">)</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
        <span class="s3">for </span><span class="s1">tree </span><span class="s3">in </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">:</span>
            <span class="s2"># Simply check if the parameter is passed on correctly. Tree tests</span>
            <span class="s2"># will suffice for the actual working of this param</span>
            <span class="s3">assert </span><span class="s1">tree</span><span class="s4">.</span><span class="s1">min_impurity_decrease </span><span class="s4">== </span><span class="s5">0.1</span>


<span class="s3">def </span><span class="s1">test_poisson_y_positive_check</span><span class="s4">():</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span><span class="s1">criterion</span><span class="s4">=</span><span class="s6">&quot;poisson&quot;</span><span class="s4">)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">((</span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s4">))</span>

    <span class="s1">y </span><span class="s4">= [-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">]</span>
    <span class="s1">err_msg </span><span class="s4">= (</span>
        <span class="s6">r&quot;Some value\(s\) of y are negative which is &quot;</span>
        <span class="s6">r&quot;not allowed for Poisson regression.&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">y </span><span class="s4">= [</span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">]</span>
    <span class="s1">err_msg </span><span class="s4">= (</span>
        <span class="s6">r&quot;Sum of y is not strictly positive which &quot;</span>
        <span class="s6">r&quot;is necessary for Poisson regression.&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s2"># mypy error: Variable &quot;DEFAULT_JOBLIB_BACKEND&quot; is not valid type</span>
<span class="s3">class </span><span class="s1">MyBackend</span><span class="s4">(</span><span class="s1">DEFAULT_JOBLIB_BACKEND</span><span class="s4">):  </span><span class="s2"># type: ignore</span>
    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, *</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">count </span><span class="s4">= </span><span class="s5">0</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(*</span><span class="s1">args</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">start_call</span><span class="s4">(</span><span class="s1">self</span><span class="s4">):</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">count </span><span class="s4">+= </span><span class="s5">1</span>
        <span class="s3">return </span><span class="s1">super</span><span class="s4">().</span><span class="s1">start_call</span><span class="s4">()</span>


<span class="s1">joblib</span><span class="s4">.</span><span class="s1">register_parallel_backend</span><span class="s4">(</span><span class="s6">&quot;testing&quot;</span><span class="s4">, </span><span class="s1">MyBackend</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">skip_if_no_parallel</span>
<span class="s3">def </span><span class="s1">test_backend_respected</span><span class="s4">():</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">2</span><span class="s4">)</span>

    <span class="s3">with </span><span class="s1">joblib</span><span class="s4">.</span><span class="s1">parallel_backend</span><span class="s4">(</span><span class="s6">&quot;testing&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s4">(</span><span class="s1">ba</span><span class="s4">, </span><span class="s1">n_jobs</span><span class="s4">):</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">ba</span><span class="s4">.</span><span class="s1">count </span><span class="s4">&gt; </span><span class="s5">0</span>

    <span class="s2"># predict_proba requires shared memory. Ensure that's honored.</span>
    <span class="s3">with </span><span class="s1">joblib</span><span class="s4">.</span><span class="s1">parallel_backend</span><span class="s4">(</span><span class="s6">&quot;testing&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s4">(</span><span class="s1">ba</span><span class="s4">, </span><span class="s1">_</span><span class="s4">):</span>
        <span class="s1">clf</span><span class="s4">.</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">ba</span><span class="s4">.</span><span class="s1">count </span><span class="s4">== </span><span class="s5">0</span>


<span class="s3">def </span><span class="s1">test_forest_feature_importances_sum</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">make_classification</span><span class="s4">(</span>
        <span class="s1">n_samples</span><span class="s4">=</span><span class="s5">15</span><span class="s4">, </span><span class="s1">n_informative</span><span class="s4">=</span><span class="s5">3</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">, </span><span class="s1">n_classes</span><span class="s4">=</span><span class="s5">3</span>
    <span class="s4">)</span>
    <span class="s1">clf </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span>
        <span class="s1">min_samples_leaf</span><span class="s4">=</span><span class="s5">5</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">42</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">200</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">math</span><span class="s4">.</span><span class="s1">isclose</span><span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">clf</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(), </span><span class="s1">abs_tol</span><span class="s4">=</span><span class="s5">1e-7</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_forest_degenerate_feature_importances</span><span class="s4">():</span>
    <span class="s2"># build a forest of single node trees. See #13636</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">((</span><span class="s5">10</span><span class="s4">, </span><span class="s5">10</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">ones</span><span class="s4">((</span><span class="s5">10</span><span class="s4">,))</span>
    <span class="s1">gbr </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">gbr</span><span class="s4">.</span><span class="s1">feature_importances_</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">zeros</span><span class="s4">(</span><span class="s5">10</span><span class="s4">, </span><span class="s1">dtype</span><span class="s4">=</span><span class="s1">np</span><span class="s4">.</span><span class="s1">float64</span><span class="s4">))</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_max_samples_bootstrap</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check invalid `max_samples` values</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">)</span>
    <span class="s1">err_msg </span><span class="s4">= (</span>
        <span class="s6">r&quot;`max_sample` cannot be set if `bootstrap=False`. &quot;</span>
        <span class="s6">r&quot;Either switch to `bootstrap=True` or set &quot;</span>
        <span class="s6">r&quot;`max_sample=None`.&quot;</span>
    <span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">err_msg</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_large_max_samples_exception</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s2"># Check invalid `max_samples`</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span><span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s1">int</span><span class="s4">(</span><span class="s5">1e9</span><span class="s4">))</span>
    <span class="s1">match </span><span class="s4">= </span><span class="s6">&quot;`max_samples` must be &lt;= n_samples=6 but got value 1000000000&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">match</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_max_samples_boundary_regressors</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y_reg</span><span class="s4">, </span><span class="s1">train_size</span><span class="s4">=</span><span class="s5">0.7</span><span class="s4">, </span><span class="s1">test_size</span><span class="s4">=</span><span class="s5">0.3</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>

    <span class="s1">ms_1_model </span><span class="s4">= </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s5">1.0</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">ms_1_predict </span><span class="s4">= </span><span class="s1">ms_1_model</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">ms_None_model </span><span class="s4">= </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">ms_None_predict </span><span class="s4">= </span><span class="s1">ms_None_model</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">).</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">ms_1_ms </span><span class="s4">= </span><span class="s1">mean_squared_error</span><span class="s4">(</span><span class="s1">ms_1_predict</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>
    <span class="s1">ms_None_ms </span><span class="s4">= </span><span class="s1">mean_squared_error</span><span class="s4">(</span><span class="s1">ms_None_predict</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">ms_1_ms </span><span class="s4">== </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">approx</span><span class="s4">(</span><span class="s1">ms_None_ms</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;name&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_max_samples_boundary_classifiers</span><span class="s4">(</span><span class="s1">name</span><span class="s4">):</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X_large</span><span class="s4">, </span><span class="s1">y_large</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">, </span><span class="s1">stratify</span><span class="s4">=</span><span class="s1">y_large</span>
    <span class="s4">)</span>

    <span class="s1">ms_1_model </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s5">1.0</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">ms_1_proba </span><span class="s4">= </span><span class="s1">ms_1_model</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">).</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">ms_None_model </span><span class="s4">= </span><span class="s1">FOREST_CLASSIFIERS</span><span class="s4">[</span><span class="s1">name</span><span class="s4">](</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s3">None</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">ms_None_proba </span><span class="s4">= </span><span class="s1">ms_None_model</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">).</span><span class="s1">predict_proba</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">)</span>

    <span class="s1">np</span><span class="s4">.</span><span class="s1">testing</span><span class="s4">.</span><span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">ms_1_proba</span><span class="s4">, </span><span class="s1">ms_None_proba</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s4">, </span><span class="s1">CSR_CONTAINERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_forest_y_sparse</span><span class="s4">(</span><span class="s1">csr_container</span><span class="s4">):</span>
    <span class="s1">X </span><span class="s4">= [[</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">3</span><span class="s4">]]</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">csr_container</span><span class="s4">([[</span><span class="s5">4</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">6</span><span class="s4">]])</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">()</span>
    <span class="s1">msg </span><span class="s4">= </span><span class="s6">&quot;sparse multilabel-indicator for y is not supported.&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg</span><span class="s4">):</span>
        <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestClass&quot;</span><span class="s4">, [</span><span class="s1">RandomForestClassifier</span><span class="s4">, </span><span class="s1">RandomForestRegressor</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_little_tree_with_small_max_samples</span><span class="s4">(</span><span class="s1">ForestClass</span><span class="s4">):</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">1</span><span class="s4">)</span>

    <span class="s1">X </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randn</span><span class="s4">(</span><span class="s5">10000</span><span class="s4">, </span><span class="s5">2</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randn</span><span class="s4">(</span><span class="s5">10000</span><span class="s4">) &gt; </span><span class="s5">0</span>

    <span class="s2"># First fit with no restriction on max samples</span>
    <span class="s1">est1 </span><span class="s4">= </span><span class="s1">ForestClass</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">,</span>
        <span class="s1">max_samples</span><span class="s4">=</span><span class="s3">None</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s2"># Second fit with max samples restricted to just 2</span>
    <span class="s1">est2 </span><span class="s4">= </span><span class="s1">ForestClass</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">1</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">,</span>
        <span class="s1">max_samples</span><span class="s4">=</span><span class="s5">2</span><span class="s4">,</span>
    <span class="s4">)</span>

    <span class="s1">est1</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">est2</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">tree1 </span><span class="s4">= </span><span class="s1">est1</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span>
    <span class="s1">tree2 </span><span class="s4">= </span><span class="s1">est2</span><span class="s4">.</span><span class="s1">estimators_</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">tree_</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s6">&quot;Tree without `max_samples` restriction should have more nodes&quot;</span>
    <span class="s3">assert </span><span class="s1">tree1</span><span class="s4">.</span><span class="s1">node_count </span><span class="s4">&gt; </span><span class="s1">tree2</span><span class="s4">.</span><span class="s1">node_count</span><span class="s4">, </span><span class="s1">msg</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;Forest&quot;</span><span class="s4">, </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_mse_criterion_object_segfault_smoke_test</span><span class="s4">(</span><span class="s1">Forest</span><span class="s4">):</span>
    <span class="s2"># This is a smoke test to ensure that passing a mutable criterion</span>
    <span class="s2"># does not cause a segfault when fitting with concurrent threads.</span>
    <span class="s2"># Non-regression test for:</span>
    <span class="s2"># https://github.com/scikit-learn/scikit-learn/issues/12623</span>
    <span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">tree</span><span class="s4">.</span><span class="s1">_criterion </span><span class="s3">import </span><span class="s1">MSE</span>

    <span class="s1">y </span><span class="s4">= </span><span class="s1">y_reg</span><span class="s4">.</span><span class="s1">reshape</span><span class="s4">(-</span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_outputs </span><span class="s4">= </span><span class="s1">y</span><span class="s4">.</span><span class="s1">shape</span>
    <span class="s1">mse_criterion </span><span class="s4">= </span><span class="s1">MSE</span><span class="s4">(</span><span class="s1">n_outputs</span><span class="s4">, </span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">FOREST_REGRESSORS</span><span class="s4">[</span><span class="s1">Forest</span><span class="s4">](</span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">criterion</span><span class="s4">=</span><span class="s1">mse_criterion</span><span class="s4">)</span>

    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_reg</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_random_trees_embedding_feature_names_out</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Check feature names out for Random Trees Embedding.&quot;&quot;&quot;</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">randn</span><span class="s4">(</span><span class="s5">100</span><span class="s4">, </span><span class="s5">4</span><span class="s4">))</span>
    <span class="s1">hasher </span><span class="s4">= </span><span class="s1">RandomTreesEmbedding</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">max_depth</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">sparse_output</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">names </span><span class="s4">= </span><span class="s1">hasher</span><span class="s4">.</span><span class="s1">get_feature_names_out</span><span class="s4">()</span>
    <span class="s1">expected_names </span><span class="s4">= [</span>
        <span class="s6">f&quot;randomtreesembedding_</span><span class="s3">{</span><span class="s1">tree</span><span class="s3">}</span><span class="s6">_</span><span class="s3">{</span><span class="s1">leaf</span><span class="s3">}</span><span class="s6">&quot;</span>
        <span class="s2"># Note: nodes with indices 0, 1 and 4 are internal split nodes and</span>
        <span class="s2"># therefore do not appear in the expected output feature names.</span>
        <span class="s3">for </span><span class="s1">tree</span><span class="s4">, </span><span class="s1">leaf </span><span class="s3">in </span><span class="s4">[</span>
            <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">2</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">3</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">5</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">6</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">3</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">5</span><span class="s4">),</span>
            <span class="s4">(</span><span class="s5">1</span><span class="s4">, </span><span class="s5">6</span><span class="s4">),</span>
        <span class="s4">]</span>
    <span class="s4">]</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">expected_names</span><span class="s4">, </span><span class="s1">names</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;csr_container&quot;</span><span class="s4">, </span><span class="s1">CSR_CONTAINERS</span><span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_read_only_buffer</span><span class="s4">(</span><span class="s1">csr_container</span><span class="s4">, </span><span class="s1">monkeypatch</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;RandomForestClassifier must work on readonly sparse data. 
 
    Non-regression test for: https://github.com/scikit-learn/scikit-learn/issues/25333 
    &quot;&quot;&quot;</span>
    <span class="s1">monkeypatch</span><span class="s4">.</span><span class="s1">setattr</span><span class="s4">(</span>
        <span class="s1">sklearn</span><span class="s4">.</span><span class="s1">ensemble</span><span class="s4">.</span><span class="s1">_forest</span><span class="s4">,</span>
        <span class="s6">&quot;Parallel&quot;</span><span class="s4">,</span>
        <span class="s1">partial</span><span class="s4">(</span><span class="s1">Parallel</span><span class="s4">, </span><span class="s1">max_nbytes</span><span class="s4">=</span><span class="s5">100</span><span class="s4">),</span>
    <span class="s4">)</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s1">seed</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>

    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">make_classification</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">100</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s5">200</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">csr_container</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">copy</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>

    <span class="s1">clf </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">)</span>
    <span class="s1">cross_val_score</span><span class="s4">(</span><span class="s1">clf</span><span class="s4">, </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">cv</span><span class="s4">=</span><span class="s5">2</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;class_weight&quot;</span><span class="s4">, [</span><span class="s6">&quot;balanced_subsample&quot;</span><span class="s4">, </span><span class="s3">None</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_round_samples_to_one_when_samples_too_low</span><span class="s4">(</span><span class="s1">class_weight</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check low max_samples works and is rounded to one. 
 
    Non-regression test for gh-24037. 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">load_wine</span><span class="s4">(</span><span class="s1">return_X_y</span><span class="s4">=</span><span class="s3">True</span><span class="s4">)</span>
    <span class="s1">forest </span><span class="s4">= </span><span class="s1">RandomForestClassifier</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">, </span><span class="s1">max_samples</span><span class="s4">=</span><span class="s5">1e-4</span><span class="s4">, </span><span class="s1">class_weight</span><span class="s4">=</span><span class="s1">class_weight</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>
    <span class="s1">forest</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;seed&quot;</span><span class="s4">, [</span><span class="s3">None</span><span class="s4">, </span><span class="s5">1</span><span class="s4">])</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;bootstrap&quot;</span><span class="s4">, [</span><span class="s3">True</span><span class="s4">, </span><span class="s3">False</span><span class="s4">])</span>
<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;ForestClass&quot;</span><span class="s4">, </span><span class="s1">FOREST_CLASSIFIERS_REGRESSORS</span><span class="s4">.</span><span class="s1">values</span><span class="s4">())</span>
<span class="s3">def </span><span class="s1">test_estimators_samples</span><span class="s4">(</span><span class="s1">ForestClass</span><span class="s4">, </span><span class="s1">bootstrap</span><span class="s4">, </span><span class="s1">seed</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Estimators_samples_ property should be consistent. 
 
    Tests consistency across fits and whether or not the seed for the random generator 
    is set. 
    &quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">make_hastie_10_2</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s5">200</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">1</span><span class="s4">)</span>

    <span class="s3">if </span><span class="s1">bootstrap</span><span class="s4">:</span>
        <span class="s1">max_samples </span><span class="s4">= </span><span class="s5">0.5</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">max_samples </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">est </span><span class="s4">= </span><span class="s1">ForestClass</span><span class="s4">(</span>
        <span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">10</span><span class="s4">,</span>
        <span class="s1">max_samples</span><span class="s4">=</span><span class="s1">max_samples</span><span class="s4">,</span>
        <span class="s1">max_features</span><span class="s4">=</span><span class="s5">0.5</span><span class="s4">,</span>
        <span class="s1">random_state</span><span class="s4">=</span><span class="s1">seed</span><span class="s4">,</span>
        <span class="s1">bootstrap</span><span class="s4">=</span><span class="s1">bootstrap</span><span class="s4">,</span>
    <span class="s4">)</span>
    <span class="s1">est</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>

    <span class="s1">estimators_samples </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_samples_</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>

    <span class="s2"># Test repeated calls result in same set of indices</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">, </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_samples_</span><span class="s4">)</span>
    <span class="s1">estimators </span><span class="s4">= </span><span class="s1">est</span><span class="s4">.</span><span class="s1">estimators_</span>

    <span class="s3">assert </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">, </span><span class="s1">list</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">estimators_samples</span><span class="s4">[</span><span class="s5">0</span><span class="s4">].</span><span class="s1">dtype </span><span class="s4">== </span><span class="s1">np</span><span class="s4">.</span><span class="s1">int32</span>

    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators</span><span class="s4">)):</span>
        <span class="s3">if </span><span class="s1">bootstrap</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">) // </span><span class="s5">2</span>

            <span class="s2"># the bootstrap should be a resampling with replacement</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">np</span><span class="s4">.</span><span class="s1">unique</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">[</span><span class="s1">i</span><span class="s4">])) &lt; </span><span class="s1">len</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">[</span><span class="s1">i</span><span class="s4">])</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">assert </span><span class="s1">len</span><span class="s4">(</span><span class="s1">set</span><span class="s4">(</span><span class="s1">estimators_samples</span><span class="s4">[</span><span class="s1">i</span><span class="s4">])) == </span><span class="s1">len</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>

    <span class="s1">estimator_index </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">estimator_samples </span><span class="s4">= </span><span class="s1">estimators_samples</span><span class="s4">[</span><span class="s1">estimator_index</span><span class="s4">]</span>
    <span class="s1">estimator </span><span class="s4">= </span><span class="s1">estimators</span><span class="s4">[</span><span class="s1">estimator_index</span><span class="s4">]</span>

    <span class="s1">X_train </span><span class="s4">= </span><span class="s1">X</span><span class="s4">[</span><span class="s1">estimator_samples</span><span class="s4">]</span>
    <span class="s1">y_train </span><span class="s4">= </span><span class="s1">y</span><span class="s4">[</span><span class="s1">estimator_samples</span><span class="s4">]</span>

    <span class="s1">orig_tree_values </span><span class="s4">= </span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">value</span>
    <span class="s1">estimator </span><span class="s4">= </span><span class="s1">clone</span><span class="s4">(</span><span class="s1">estimator</span><span class="s4">)</span>
    <span class="s1">estimator</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">new_tree_values </span><span class="s4">= </span><span class="s1">estimator</span><span class="s4">.</span><span class="s1">tree_</span><span class="s4">.</span><span class="s1">value</span>
    <span class="s1">assert_allclose</span><span class="s4">(</span><span class="s1">orig_tree_values</span><span class="s4">, </span><span class="s1">new_tree_values</span><span class="s4">)</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s6">&quot;make_data, Forest&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_regression</span><span class="s4">, </span><span class="s1">RandomForestRegressor</span><span class="s4">),</span>
        <span class="s4">(</span><span class="s1">datasets</span><span class="s4">.</span><span class="s1">make_classification</span><span class="s4">, </span><span class="s1">RandomForestClassifier</span><span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_missing_values_is_resilient</span><span class="s4">(</span><span class="s1">make_data</span><span class="s4">, </span><span class="s1">Forest</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that forest can deal with missing values and has decent performance.&quot;&quot;&quot;</span>

    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s5">1000</span><span class="s4">, </span><span class="s5">10</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y </span><span class="s4">= </span><span class="s1">make_data</span><span class="s4">(</span><span class="s1">n_samples</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">=</span><span class="s1">n_features</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">)</span>

    <span class="s2"># Create dataset with missing values</span>
    <span class="s1">X_missing </span><span class="s4">= </span><span class="s1">X</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
    <span class="s1">X_missing</span><span class="s4">[</span><span class="s1">rng</span><span class="s4">.</span><span class="s1">choice</span><span class="s4">([</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">], </span><span class="s1">size</span><span class="s4">=</span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">, </span><span class="s1">p</span><span class="s4">=[</span><span class="s5">0.95</span><span class="s4">, </span><span class="s5">0.05</span><span class="s4">])] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">nan</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">isnan</span><span class="s4">(</span><span class="s1">X_missing</span><span class="s4">).</span><span class="s1">any</span><span class="s4">()</span>

    <span class="s1">X_missing_train</span><span class="s4">, </span><span class="s1">X_missing_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span>
        <span class="s1">X_missing</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span>
    <span class="s4">)</span>

    <span class="s2"># Train forest with missing values</span>
    <span class="s1">forest_with_missing </span><span class="s4">= </span><span class="s1">Forest</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">50</span><span class="s4">)</span>
    <span class="s1">forest_with_missing</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_missing_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">score_with_missing </span><span class="s4">= </span><span class="s1">forest_with_missing</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_missing_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>

    <span class="s2"># Train forest without missing values</span>
    <span class="s1">X_train</span><span class="s4">, </span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">, </span><span class="s1">y_test </span><span class="s4">= </span><span class="s1">train_test_split</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">forest </span><span class="s4">= </span><span class="s1">Forest</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s1">rng</span><span class="s4">, </span><span class="s1">n_estimators</span><span class="s4">=</span><span class="s5">50</span><span class="s4">)</span>
    <span class="s1">forest</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">score_without_missing </span><span class="s4">= </span><span class="s1">forest</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>

    <span class="s2"># Score is still 80 percent of the forest's score that had no missing values</span>
    <span class="s3">assert </span><span class="s1">score_with_missing </span><span class="s4">&gt;= </span><span class="s5">0.80 </span><span class="s4">* </span><span class="s1">score_without_missing</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span><span class="s6">&quot;Forest&quot;</span><span class="s4">, [</span><span class="s1">RandomForestClassifier</span><span class="s4">, </span><span class="s1">RandomForestRegressor</span><span class="s4">])</span>
<span class="s3">def </span><span class="s1">test_missing_value_is_predictive</span><span class="s4">(</span><span class="s1">Forest</span><span class="s4">):</span>
    <span class="s0">&quot;&quot;&quot;Check that the forest learns when missing values are only present for 
    a predictive feature.&quot;&quot;&quot;</span>
    <span class="s1">rng </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">n_samples </span><span class="s4">= </span><span class="s5">300</span>

    <span class="s1">X_non_predictive </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">standard_normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s5">10</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">high</span><span class="s4">=</span><span class="s5">2</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>

    <span class="s2"># Create a predictive feature using `y` and with some noise</span>
    <span class="s1">X_random_mask </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">choice</span><span class="s4">([</span><span class="s3">False</span><span class="s4">, </span><span class="s3">True</span><span class="s4">], </span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">p</span><span class="s4">=[</span><span class="s5">0.95</span><span class="s4">, </span><span class="s5">0.05</span><span class="s4">])</span>
    <span class="s1">y_mask </span><span class="s4">= </span><span class="s1">y</span><span class="s4">.</span><span class="s1">astype</span><span class="s4">(</span><span class="s1">bool</span><span class="s4">)</span>
    <span class="s1">y_mask</span><span class="s4">[</span><span class="s1">X_random_mask</span><span class="s4">] = ~</span><span class="s1">y_mask</span><span class="s4">[</span><span class="s1">X_random_mask</span><span class="s4">]</span>

    <span class="s1">predictive_feature </span><span class="s4">= </span><span class="s1">rng</span><span class="s4">.</span><span class="s1">standard_normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">predictive_feature</span><span class="s4">[</span><span class="s1">y_mask</span><span class="s4">] = </span><span class="s1">np</span><span class="s4">.</span><span class="s1">nan</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">isnan</span><span class="s4">(</span><span class="s1">predictive_feature</span><span class="s4">).</span><span class="s1">any</span><span class="s4">()</span>

    <span class="s1">X_predictive </span><span class="s4">= </span><span class="s1">X_non_predictive</span><span class="s4">.</span><span class="s1">copy</span><span class="s4">()</span>
    <span class="s1">X_predictive</span><span class="s4">[:, </span><span class="s5">5</span><span class="s4">] = </span><span class="s1">predictive_feature</span>

    <span class="s4">(</span>
        <span class="s1">X_predictive_train</span><span class="s4">,</span>
        <span class="s1">X_predictive_test</span><span class="s4">,</span>
        <span class="s1">X_non_predictive_train</span><span class="s4">,</span>
        <span class="s1">X_non_predictive_test</span><span class="s4">,</span>
        <span class="s1">y_train</span><span class="s4">,</span>
        <span class="s1">y_test</span><span class="s4">,</span>
    <span class="s4">) = </span><span class="s1">train_test_split</span><span class="s4">(</span><span class="s1">X_predictive</span><span class="s4">, </span><span class="s1">X_non_predictive</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">)</span>
    <span class="s1">forest_predictive </span><span class="s4">= </span><span class="s1">Forest</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_predictive_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>
    <span class="s1">forest_non_predictive </span><span class="s4">= </span><span class="s1">Forest</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s5">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X_non_predictive_train</span><span class="s4">, </span><span class="s1">y_train</span><span class="s4">)</span>

    <span class="s1">predictive_test_score </span><span class="s4">= </span><span class="s1">forest_predictive</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X_predictive_test</span><span class="s4">, </span><span class="s1">y_test</span><span class="s4">)</span>

    <span class="s3">assert </span><span class="s1">predictive_test_score </span><span class="s4">&gt;= </span><span class="s5">0.75</span>
    <span class="s3">assert </span><span class="s1">predictive_test_score </span><span class="s4">&gt;= </span><span class="s1">forest_non_predictive</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span>
        <span class="s1">X_non_predictive_test</span><span class="s4">, </span><span class="s1">y_test</span>
    <span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_non_supported_criterion_raises_error_with_missing_values</span><span class="s4">():</span>
    <span class="s0">&quot;&quot;&quot;Raise error for unsupported criterion when there are missing values.&quot;&quot;&quot;</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([[</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s4">], [</span><span class="s1">np</span><span class="s4">.</span><span class="s1">nan</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">2.0</span><span class="s4">]])</span>
    <span class="s1">y </span><span class="s4">= [</span><span class="s5">0.5</span><span class="s4">, </span><span class="s5">1.0</span><span class="s4">]</span>

    <span class="s1">forest </span><span class="s4">= </span><span class="s1">RandomForestRegressor</span><span class="s4">(</span><span class="s1">criterion</span><span class="s4">=</span><span class="s6">&quot;absolute_error&quot;</span><span class="s4">)</span>

    <span class="s1">msg </span><span class="s4">= </span><span class="s6">&quot;RandomForestRegressor does not accept missing values&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">msg</span><span class="s4">):</span>
        <span class="s1">forest</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
</pre>
</body>
</html>