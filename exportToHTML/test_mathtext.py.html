<html>
<head>
<title>test_mathtext.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_mathtext.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">io</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">shlex</span>
<span class="s0">from </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree </span><span class="s0">import </span><span class="s1">ElementTree </span><span class="s0">as </span><span class="s1">ET</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">packaging</span><span class="s2">.</span><span class="s1">version </span><span class="s0">import </span><span class="s1">parse </span><span class="s0">as </span><span class="s1">parse_version</span>
<span class="s0">import </span><span class="s1">pyparsing</span>
<span class="s0">import </span><span class="s1">pytest</span>


<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s2">, </span><span class="s1">image_comparison</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">mathtext</span><span class="s2">, </span><span class="s1">_mathtext</span>

<span class="s1">pyparsing_version </span><span class="s2">= </span><span class="s1">parse_version</span><span class="s2">(</span><span class="s1">pyparsing</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">)</span>


<span class="s3"># If test is removed, use None as placeholder</span>
<span class="s1">math_tests </span><span class="s2">= [</span>
    <span class="s4">r'$a+b+\dot s+\dot{s}+\ldots$'</span><span class="s2">,</span>
    <span class="s4">r'$x\hspace{-0.2}\doteq\hspace{-0.2}y$'</span><span class="s2">,</span>
    <span class="s4">r'\$100.00 $\alpha \_$'</span><span class="s2">,</span>
    <span class="s4">r'$\frac{\$100.00}{y}$'</span><span class="s2">,</span>
    <span class="s4">r'$x   y$'</span><span class="s2">,</span>
    <span class="s4">r'$x+y\ x=y\ x&lt;y\ x:y\ x,y\ x@y$'</span><span class="s2">,</span>
    <span class="s4">r'$100\%y\ x*y\ x/y x\$y$'</span><span class="s2">,</span>
    <span class="s4">r'$x\leftarrow y\ x\forall y\ x-y$'</span><span class="s2">,</span>
    <span class="s4">r'$x \sf x \bf x {\cal X} \rm x$'</span><span class="s2">,</span>
    <span class="s4">r'$x\ x\,x\;x\quad x\qquad x\!x\hspace{ 0.5 }y$'</span><span class="s2">,</span>
    <span class="s4">r'$\{ \rm braces \}$'</span><span class="s2">,</span>
    <span class="s4">r'$\left[\left\lfloor\frac{5}{\frac{\left(3\right)}{4}} y\right)\right]$'</span><span class="s2">,</span>
    <span class="s4">r'$\left(x\right)$'</span><span class="s2">,</span>
    <span class="s4">r'$\sin(x)$'</span><span class="s2">,</span>
    <span class="s4">r'$x_2$'</span><span class="s2">,</span>
    <span class="s4">r'$x^2$'</span><span class="s2">,</span>
    <span class="s4">r'$x^2_y$'</span><span class="s2">,</span>
    <span class="s4">r'$x_y^2$'</span><span class="s2">,</span>
    <span class="s2">(</span><span class="s4">r'$\sum _{\genfrac{}{}{0}{}{0\leq i\leq m}{0&lt;j&lt;n}}f\left(i,j\right)'</span>
     <span class="s4">r'\mathcal{R}\prod_{i=\alpha_{i+1}}^\infty a_i \sin(2 \pi f x_i)'</span>
     <span class="s4">r&quot;\sqrt[2]{\prod^\frac{x}{2\pi^2}_\infty}$&quot;</span><span class="s2">),</span>
    <span class="s4">r'$x = \frac{x+\frac{5}{2}}{\frac{y+3}{8}}$'</span><span class="s2">,</span>
    <span class="s4">r'$dz/dt = \gamma x^2 + {\rm sin}(2\pi y+\phi)$'</span><span class="s2">,</span>
    <span class="s4">r'Foo: $\alpha_{i+1}^j = {\rm sin}(2\pi f_j t_i) e^{-5 t_i/\tau}$'</span><span class="s2">,</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s4">r'Variable $i$ is good'</span><span class="s2">,</span>
    <span class="s4">r'$\Delta_i^j$'</span><span class="s2">,</span>
    <span class="s4">r'$\Delta^j_{i+1}$'</span><span class="s2">,</span>
    <span class="s4">r'$\ddot{o}\acute{e}\grave{e}\hat{O}\breve{\imath}\tilde{n}\vec{q}$'</span><span class="s2">,</span>
    <span class="s4">r&quot;$\arccos((x^i))$&quot;</span><span class="s2">,</span>
    <span class="s4">r&quot;$\gamma = \frac{x=\frac{6}{8}}{y} \delta$&quot;</span><span class="s2">,</span>
    <span class="s4">r'$\limsup_{x\to\infty}$'</span><span class="s2">,</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s4">r&quot;$f'\quad f'''(x)\quad ''/\mathrm{yr}$&quot;</span><span class="s2">,</span>
    <span class="s4">r'$\frac{x_2888}{y}$'</span><span class="s2">,</span>
    <span class="s4">r&quot;$\sqrt[3]{\frac{X_2}{Y}}=5$&quot;</span><span class="s2">,</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s4">r&quot;$\sqrt[3]{x}=5$&quot;</span><span class="s2">,</span>
    <span class="s4">r'$\frac{X}{\frac{X}{Y}}$'</span><span class="s2">,</span>
    <span class="s4">r&quot;$W^{3\beta}_{\delta_1 \rho_1 \sigma_2} = U^{3\beta}_{\delta_1 \rho_1} + \frac{1}{8 \pi 2} \int^{\alpha_2}_{\alpha_2} d \alpha^\prime_2 \left[\frac{ U^{2\beta}_{\delta_1 \rho_1} - \alpha^\prime_2U^{1\beta}_{\rho_1 \sigma_2} }{U^{0\beta}_{\rho_1 \sigma_2}}\right]$&quot;</span><span class="s2">,</span>
    <span class="s4">r'$\mathcal{H} = \int d \tau \left(\epsilon E^2 + \mu H^2\right)$'</span><span class="s2">,</span>
    <span class="s4">r'$\widehat{abc}\widetilde{def}$'</span><span class="s2">,</span>
    <span class="s4">'$</span><span class="s0">\\</span><span class="s4">Gamma </span><span class="s0">\\</span><span class="s4">Delta </span><span class="s0">\\</span><span class="s4">Theta </span><span class="s0">\\</span><span class="s4">Lambda </span><span class="s0">\\</span><span class="s4">Xi </span><span class="s0">\\</span><span class="s4">Pi </span><span class="s0">\\</span><span class="s4">Sigma </span><span class="s0">\\</span><span class="s4">Upsilon </span><span class="s0">\\</span><span class="s4">Phi </span><span class="s0">\\</span><span class="s4">Psi </span><span class="s0">\\</span><span class="s4">Omega$'</span><span class="s2">,</span>
    <span class="s4">'$</span><span class="s0">\\</span><span class="s4">alpha </span><span class="s0">\\</span><span class="s4">beta </span><span class="s0">\\</span><span class="s4">gamma </span><span class="s0">\\</span><span class="s4">delta </span><span class="s0">\\</span><span class="s4">epsilon </span><span class="s0">\\</span><span class="s4">zeta </span><span class="s0">\\</span><span class="s4">eta </span><span class="s0">\\</span><span class="s4">theta </span><span class="s0">\\</span><span class="s4">iota </span><span class="s0">\\</span><span class="s4">lambda </span><span class="s0">\\</span><span class="s4">mu </span><span class="s0">\\</span><span class="s4">nu </span><span class="s0">\\</span><span class="s4">xi </span><span class="s0">\\</span><span class="s4">pi </span><span class="s0">\\</span><span class="s4">kappa </span><span class="s0">\\</span><span class="s4">rho </span><span class="s0">\\</span><span class="s4">sigma </span><span class="s0">\\</span><span class="s4">tau </span><span class="s0">\\</span><span class="s4">upsilon </span><span class="s0">\\</span><span class="s4">phi </span><span class="s0">\\</span><span class="s4">chi </span><span class="s0">\\</span><span class="s4">psi$'</span><span class="s2">,</span>

    <span class="s3"># The following examples are from the MathML torture test here:</span>
    <span class="s3"># https://www-archive.mozilla.org/projects/mathml/demo/texvsmml.xhtml</span>
    <span class="s4">r'${x}^{2}{y}^{2}$'</span><span class="s2">,</span>
    <span class="s4">r'${}_{2}F_{3}$'</span><span class="s2">,</span>
    <span class="s4">r'$\frac{x+{y}^{2}}{k+1}$'</span><span class="s2">,</span>
    <span class="s4">r'$x+{y}^{\frac{2}{k+1}}$'</span><span class="s2">,</span>
    <span class="s4">r'$\frac{a}{b/2}$'</span><span class="s2">,</span>
    <span class="s4">r'${a}_{0}+\frac{1}{{a}_{1}+\frac{1}{{a}_{2}+\frac{1}{{a}_{3}+\frac{1}{{a}_{4}}}}}$'</span><span class="s2">,</span>
    <span class="s4">r'${a}_{0}+\frac{1}{{a}_{1}+\frac{1}{{a}_{2}+\frac{1}{{a}_{3}+\frac{1}{{a}_{4}}}}}$'</span><span class="s2">,</span>
    <span class="s4">r'$\binom{n}{k/2}$'</span><span class="s2">,</span>
    <span class="s4">r'$\binom{p}{2}{x}^{2}{y}^{p-2}-\frac{1}{1-x}\frac{1}{1-{x}^{2}}$'</span><span class="s2">,</span>
    <span class="s4">r'${x}^{2y}$'</span><span class="s2">,</span>
    <span class="s4">r'$\sum _{i=1}^{p}\sum _{j=1}^{q}\sum _{k=1}^{r}{a}_{ij}{b}_{jk}{c}_{ki}$'</span><span class="s2">,</span>
    <span class="s4">r'$\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+\sqrt{1+x}}}}}}}$'</span><span class="s2">,</span>
    <span class="s4">r'$\left(\frac{{\partial }^{2}}{\partial {x}^{2}}+\frac{{\partial }^{2}}{\partial {y}^{2}}\right){|\varphi \left(x+iy\right)|}^{2}=0$'</span><span class="s2">,</span>
    <span class="s4">r'${2}^{{2}^{{2}^{x}}}$'</span><span class="s2">,</span>
    <span class="s4">r'${\int }_{1}^{x}\frac{\mathrm{dt}}{t}$'</span><span class="s2">,</span>
    <span class="s4">r'$\int {\int }_{D}\mathrm{dx} \mathrm{dy}$'</span><span class="s2">,</span>
    <span class="s3"># mathtex doesn't support array</span>
    <span class="s3"># 'mmltt18'    : r'$f\left(x\right)=\left\{\begin{array}{cc}\hfill 1/3\hfill &amp; \text{if_}0\le x\le 1;\hfill \\ \hfill 2/3\hfill &amp; \hfill \text{if_}3\le x\le 4;\hfill \\ \hfill 0\hfill &amp; \text{elsewhere.}\hfill \end{array}$',</span>
    <span class="s3"># mathtex doesn't support stackrel</span>
    <span class="s3"># 'mmltt19'    : r'$\stackrel{\stackrel{k\text{times}}{\ufe37}}{x+...+x}$',</span>
    <span class="s4">r'${y}_{{x}^{2}}$'</span><span class="s2">,</span>
    <span class="s3"># mathtex doesn't support the &quot;\text&quot; command</span>
    <span class="s3"># 'mmltt21'    : r'$\sum _{p\text{\prime}}f\left(p\right)={\int }_{t&gt;1}f\left(t\right) d\pi \left(t\right)$',</span>
    <span class="s3"># mathtex doesn't support array</span>
    <span class="s3"># 'mmltt23'    : r'$\left(\begin{array}{cc}\hfill \left(\begin{array}{cc}\hfill a\hfill &amp; \hfill b\hfill \\ \hfill c\hfill &amp; \hfill d\hfill \end{array}\right)\hfill &amp; \hfill \left(\begin{array}{cc}\hfill e\hfill &amp; \hfill f\hfill \\ \hfill g\hfill &amp; \hfill h\hfill \end{array}\right)\hfill \\ \hfill 0\hfill &amp; \hfill \left(\begin{array}{cc}\hfill i\hfill &amp; \hfill j\hfill \\ \hfill k\hfill &amp; \hfill l\hfill \end{array}\right)\hfill \end{array}\right)$',</span>
    <span class="s3"># mathtex doesn't support array</span>
    <span class="s3"># 'mmltt24'   : r'$det|\begin{array}{ccccc}\hfill {c}_{0}\hfill &amp; \hfill {c}_{1}\hfill &amp; \hfill {c}_{2}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{n}\hfill \\ \hfill {c}_{1}\hfill &amp; \hfill {c}_{2}\hfill &amp; \hfill {c}_{3}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{n+1}\hfill \\ \hfill {c}_{2}\hfill &amp; \hfill {c}_{3}\hfill &amp; \hfill {c}_{4}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{n+2}\hfill \\ \hfill \u22ee\hfill &amp; \hfill \u22ee\hfill &amp; \hfill \u22ee\hfill &amp; \hfill \hfill &amp; \hfill \u22ee\hfill \\ \hfill {c}_{n}\hfill &amp; \hfill {c}_{n+1}\hfill &amp; \hfill {c}_{n+2}\hfill &amp; \hfill \dots \hfill &amp; \hfill {c}_{2n}\hfill \end{array}|&gt;0$',</span>
    <span class="s4">r'${y}_{{x}_{2}}$'</span><span class="s2">,</span>
    <span class="s4">r'${x}_{92}^{31415}+\pi $'</span><span class="s2">,</span>
    <span class="s4">r'${x}_{{y}_{b}^{a}}^{{z}_{c}^{d}}$'</span><span class="s2">,</span>
    <span class="s4">r'${y}_{3}^{\prime \prime \prime }$'</span><span class="s2">,</span>
    <span class="s3"># End of the MathML torture tests.</span>

    <span class="s4">r&quot;$\left( \xi \left( 1 - \xi \right) \right)$&quot;</span><span class="s2">,  </span><span class="s3"># Bug 2969451</span>
    <span class="s4">r&quot;$\left(2 \, a=b\right)$&quot;</span><span class="s2">,  </span><span class="s3"># Sage bug #8125</span>
    <span class="s4">r&quot;$? ! &amp;$&quot;</span><span class="s2">,  </span><span class="s3"># github issue #466</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s4">r&quot;$\left\Vert \frac{a}{b} \right\Vert \left\vert \frac{a}{b} \right\vert \left\| \frac{a}{b}\right\| \left| \frac{a}{b} \right| \Vert a \Vert \vert b \vert \| a \| | b |$&quot;</span><span class="s2">,</span>
    <span class="s4">r'$\mathring{A}  \AA$'</span><span class="s2">,</span>
    <span class="s4">r'$M \, M \thinspace M \/ M \&gt; M \: M \; M \ M \enspace M \quad M \qquad M \! M$'</span><span class="s2">,</span>
    <span class="s4">r'$\Cap$ $\Cup$ $\leftharpoonup$ $\barwedge$ $\rightharpoonup$'</span><span class="s2">,</span>
    <span class="s4">r'$\hspace{-0.2}\dotplus\hspace{-0.2}$ $\hspace{-0.2}\doteq\hspace{-0.2}$ $\hspace{-0.2}\doteqdot\hspace{-0.2}$ $\ddots$'</span><span class="s2">,</span>
    <span class="s4">r'$xyz^kx_kx^py^{p-2} d_i^jb_jc_kd x^j_i E^0 E^0_u$'</span><span class="s2">,  </span><span class="s3"># github issue #4873</span>
    <span class="s4">r'${xyz}^k{x}_{k}{x}^{p}{y}^{p-2} {d}_{i}^{j}{b}_{j}{c}_{k}{d} {x}^{j}_{i}{E}^{0}{E}^0_u$'</span><span class="s2">,</span>
    <span class="s4">r'${\int}_x^x x\oint_x^x x\int_{X}^{X}x\int_x x \int^x x \int_{x} x\int^{x}{\int}_{x} x{\int}^{x}_{x}x$'</span><span class="s2">,</span>
    <span class="s4">r'testing$^{123}$'</span><span class="s2">,</span>
    <span class="s0">None</span><span class="s2">,</span>
    <span class="s4">r'$6-2$; $-2$; $ -2$; ${-2}$; ${  -2}$; $20^{+3}_{-2}$'</span><span class="s2">,</span>
    <span class="s4">r'$\overline{\omega}^x \frac{1}{2}_0^x$'</span><span class="s2">,  </span><span class="s3"># github issue #5444</span>
    <span class="s4">r'$,$ $.$ $1{,}234{, }567{ , }890$ and $1,234,567,890$'</span><span class="s2">,  </span><span class="s3"># github issue 5799</span>
    <span class="s4">r'$\left(X\right)_{a}^{b}$'</span><span class="s2">,  </span><span class="s3"># github issue 7615</span>
    <span class="s4">r'$\dfrac{\$100.00}{y}$'</span><span class="s2">,  </span><span class="s3"># github issue #1888</span>
<span class="s2">]</span>
<span class="s3"># 'svgastext' tests switch svg output to embed text as text (rather than as</span>
<span class="s3"># paths).</span>
<span class="s1">svgastext_math_tests </span><span class="s2">= [</span>
    <span class="s4">r'$-$-'</span><span class="s2">,</span>
<span class="s2">]</span>
<span class="s3"># 'lightweight' tests test only a single fontset (dejavusans, which is the</span>
<span class="s3"># default) and only png outputs, in order to minimize the size of baseline</span>
<span class="s3"># images.</span>
<span class="s1">lightweight_math_tests </span><span class="s2">= [</span>
    <span class="s4">r'$\sqrt[ab]{123}$'</span><span class="s2">,  </span><span class="s3"># github issue #8665</span>
    <span class="s4">r'$x \overset{f}{\rightarrow} \overset{f}{x} \underset{xx}{ff} \overset{xx}{ff} \underset{f}{x} \underset{f}{\leftarrow} x$'</span><span class="s2">,  </span><span class="s3"># github issue #18241</span>
    <span class="s4">r'$\sum x\quad\sum^nx\quad\sum_nx\quad\sum_n^nx\quad\prod x\quad\prod^nx\quad\prod_nx\quad\prod_n^nx$'</span><span class="s2">,  </span><span class="s3"># GitHub issue 18085</span>
    <span class="s4">r'$1.$ $2.$ $19680801.$ $a.$ $b.$ $mpl.$'</span><span class="s2">,</span>
    <span class="s4">r'$\text{text}_{\text{sub}}^{\text{sup}} + \text{\$foo\$} + \frac{\text{num}}{\mathbf{\text{den}}}\text{with space, curly brackets \{\}, and dash -}$'</span><span class="s2">,</span>
    <span class="s4">r'$\boldsymbol{abcde} \boldsymbol{+} \boldsymbol{\Gamma + \Omega} \boldsymbol{01234} \boldsymbol{\alpha * \beta}$'</span><span class="s2">,</span>
    <span class="s4">r'$\left\lbrace\frac{\left\lbrack A^b_c\right\rbrace}{\left\leftbrace D^e_f \right\rbrack}\right\rightbrace\ \left\leftparen\max_{x} \left\lgroup \frac{A}{B}\right\rgroup \right\rightparen$'</span><span class="s2">,</span>
    <span class="s4">r'$\left( a\middle. b \right)$ $\left( \frac{a}{b} \middle\vert x_i \in P^S \right)$ $\left[ 1 - \middle| a\middle| + \left( x  - \left\lfloor \dfrac{a}{b}\right\rfloor \right)  \right]$'</span><span class="s2">,</span>
    <span class="s4">r'$\sum_{\substack{k = 1\\ k \neq \lfloor n/2\rfloor}}^{n}P(i,j) \sum_{\substack{i \neq 0\\ -1 \leq i \leq 3\\ 1 \leq j \leq 5}} F^i(x,y) \sum_{\substack{\left \lfloor \frac{n}{2} \right\rfloor}} F(n)$'</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">digits </span><span class="s2">= </span><span class="s4">&quot;0123456789&quot;</span>
<span class="s1">uppercase </span><span class="s2">= </span><span class="s4">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>
<span class="s1">lowercase </span><span class="s2">= </span><span class="s4">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>
<span class="s1">uppergreek </span><span class="s2">= (</span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">Gamma </span><span class="s0">\\</span><span class="s4">Delta </span><span class="s0">\\</span><span class="s4">Theta </span><span class="s0">\\</span><span class="s4">Lambda </span><span class="s0">\\</span><span class="s4">Xi </span><span class="s0">\\</span><span class="s4">Pi </span><span class="s0">\\</span><span class="s4">Sigma </span><span class="s0">\\</span><span class="s4">Upsilon </span><span class="s0">\\</span><span class="s4">Phi </span><span class="s0">\\</span><span class="s4">Psi &quot;</span>
              <span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">Omega&quot;</span><span class="s2">)</span>
<span class="s1">lowergreek </span><span class="s2">= (</span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">alpha </span><span class="s0">\\</span><span class="s4">beta </span><span class="s0">\\</span><span class="s4">gamma </span><span class="s0">\\</span><span class="s4">delta </span><span class="s0">\\</span><span class="s4">epsilon </span><span class="s0">\\</span><span class="s4">zeta </span><span class="s0">\\</span><span class="s4">eta </span><span class="s0">\\</span><span class="s4">theta </span><span class="s0">\\</span><span class="s4">iota &quot;</span>
              <span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">lambda </span><span class="s0">\\</span><span class="s4">mu </span><span class="s0">\\</span><span class="s4">nu </span><span class="s0">\\</span><span class="s4">xi </span><span class="s0">\\</span><span class="s4">pi </span><span class="s0">\\</span><span class="s4">kappa </span><span class="s0">\\</span><span class="s4">rho </span><span class="s0">\\</span><span class="s4">sigma </span><span class="s0">\\</span><span class="s4">tau </span><span class="s0">\\</span><span class="s4">upsilon &quot;</span>
              <span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">phi </span><span class="s0">\\</span><span class="s4">chi </span><span class="s0">\\</span><span class="s4">psi&quot;</span><span class="s2">)</span>
<span class="s1">all </span><span class="s2">= [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">, </span><span class="s1">uppergreek</span><span class="s2">, </span><span class="s1">lowergreek</span><span class="s2">]</span>

<span class="s3"># Use stubs to reserve space if tests are removed</span>
<span class="s3"># stub should be of the form (None, N) where N is the number of strings that</span>
<span class="s3"># used to be tested</span>
<span class="s3"># Add new tests at the end.</span>
<span class="s1">font_test_specs</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s0">None </span><span class="s2">| </span><span class="s1">list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">], </span><span class="s1">Any</span><span class="s2">]] = [</span>
    <span class="s2">([], </span><span class="s1">all</span><span class="s2">),</span>
    <span class="s2">([</span><span class="s4">'mathrm'</span><span class="s2">], </span><span class="s1">all</span><span class="s2">),</span>
    <span class="s2">([</span><span class="s4">'mathbf'</span><span class="s2">], </span><span class="s1">all</span><span class="s2">),</span>
    <span class="s2">([</span><span class="s4">'mathit'</span><span class="s2">], </span><span class="s1">all</span><span class="s2">),</span>
    <span class="s2">([</span><span class="s4">'mathtt'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s5">3</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s5">3</span><span class="s2">),</span>
    <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s5">3</span><span class="s2">),</span>
    <span class="s2">([</span><span class="s4">'mathbb'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">,</span>
                  <span class="s4">r'\Gamma \Pi \Sigma \gamma \pi'</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathrm'</span><span class="s2">, </span><span class="s4">'mathbb'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">,</span>
                            <span class="s4">r'\Gamma \Pi \Sigma \gamma \pi'</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathbf'</span><span class="s2">, </span><span class="s4">'mathbb'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">,</span>
                            <span class="s4">r'\Gamma \Pi \Sigma \gamma \pi'</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathcal'</span><span class="s2">], [</span><span class="s1">uppercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathfrak'</span><span class="s2">], [</span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathbf'</span><span class="s2">, </span><span class="s4">'mathfrak'</span><span class="s2">], [</span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathscr'</span><span class="s2">], [</span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathsf'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathrm'</span><span class="s2">, </span><span class="s4">'mathsf'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathbf'</span><span class="s2">, </span><span class="s4">'mathsf'</span><span class="s2">], [</span><span class="s1">digits</span><span class="s2">, </span><span class="s1">uppercase</span><span class="s2">, </span><span class="s1">lowercase</span><span class="s2">]),</span>
    <span class="s2">([</span><span class="s4">'mathbfit'</span><span class="s2">], </span><span class="s1">all</span><span class="s2">),</span>
    <span class="s2">]</span>

<span class="s1">font_tests</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s0">None </span><span class="s2">| </span><span class="s1">str</span><span class="s2">] = []</span>
<span class="s0">for </span><span class="s1">fonts</span><span class="s2">, </span><span class="s1">chars </span><span class="s0">in </span><span class="s1">font_test_specs</span><span class="s2">:</span>
    <span class="s0">if </span><span class="s1">fonts </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">font_tests</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s0">None</span><span class="s2">] * </span><span class="s1">chars</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">wrapper </span><span class="s2">= </span><span class="s4">''</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span>
            <span class="s4">' '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">fonts</span><span class="s2">),</span>
            <span class="s4">' $'</span><span class="s2">,</span>
            <span class="s2">*(</span><span class="s4">r'\%s{' </span><span class="s2">% </span><span class="s1">font </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts</span><span class="s2">),</span>
            <span class="s4">'%s'</span><span class="s2">,</span>
            <span class="s2">*(</span><span class="s4">'}' </span><span class="s0">for </span><span class="s1">font </span><span class="s0">in </span><span class="s1">fonts</span><span class="s2">),</span>
            <span class="s4">'$'</span><span class="s2">,</span>
        <span class="s2">])</span>
        <span class="s0">for </span><span class="s1">set </span><span class="s0">in </span><span class="s1">chars</span><span class="s2">:</span>
            <span class="s1">font_tests</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">wrapper </span><span class="s2">% </span><span class="s1">set</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">baseline_images</span><span class="s2">(</span><span class="s1">request</span><span class="s2">, </span><span class="s1">fontset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">text </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;test has been removed&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s4">'%s_%s_%02d' </span><span class="s2">% (</span><span class="s1">request</span><span class="s2">.</span><span class="s1">param</span><span class="s2">, </span><span class="s1">fontset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">)]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">'index, text'</span><span class="s2">, </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">math_tests</span><span class="s2">), </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">math_tests</span><span class="s2">)))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">'fontset'</span><span class="s2">, [</span><span class="s4">'cm'</span><span class="s2">, </span><span class="s4">'stix'</span><span class="s2">, </span><span class="s4">'stixsans'</span><span class="s2">, </span><span class="s4">'dejavusans'</span><span class="s2">, </span><span class="s4">'dejavuserif'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'baseline_images'</span><span class="s2">, [</span><span class="s4">'mathtext'</span><span class="s2">], </span><span class="s1">indirect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s5">0.011 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'ppc64le'</span><span class="s2">, </span><span class="s4">'s390x'</span><span class="s2">) </span><span class="s0">else </span><span class="s5">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mathtext_rendering</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">, </span><span class="s1">fontset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fontset'</span><span class="s2">] = </span><span class="s1">fontset</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">5.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">text</span><span class="s2">,</span>
             <span class="s1">horizontalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">, </span><span class="s1">verticalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'index, text'</span><span class="s2">, </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">svgastext_math_tests</span><span class="s2">),</span>
                         <span class="s1">ids</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">svgastext_math_tests</span><span class="s2">)))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'fontset'</span><span class="s2">, [</span><span class="s4">'cm'</span><span class="s2">, </span><span class="s4">'dejavusans'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'baseline_images'</span><span class="s2">, [</span><span class="s4">'mathtext0'</span><span class="s2">], </span><span class="s1">indirect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span>
    <span class="s1">baseline_images</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">'svg'</span><span class="s2">],</span>
    <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s4">'metadata'</span><span class="s2">: {  </span><span class="s3"># Minimize image size.</span>
        <span class="s4">'Creator'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Date'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Format'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Type'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">}})</span>
<span class="s0">def </span><span class="s1">test_mathtext_rendering_svgastext</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">, </span><span class="s1">fontset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fontset'</span><span class="s2">] = </span><span class="s1">fontset</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'svg.fonttype'</span><span class="s2">] = </span><span class="s4">'none'  </span><span class="s3"># Minimize image size.</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">5.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">patch</span><span class="s2">.</span><span class="s1">set</span><span class="s2">(</span><span class="s1">visible</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)  </span><span class="s3"># Minimize image size.</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">text</span><span class="s2">,</span>
             <span class="s1">horizontalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">, </span><span class="s1">verticalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'index, text'</span><span class="s2">, </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">lightweight_math_tests</span><span class="s2">),</span>
                         <span class="s1">ids</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">lightweight_math_tests</span><span class="s2">)))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'fontset'</span><span class="s2">, [</span><span class="s4">'dejavusans'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'baseline_images'</span><span class="s2">, [</span><span class="s4">'mathtext1'</span><span class="s2">], </span><span class="s1">indirect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">'png'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_mathtext_rendering_lightweight</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">, </span><span class="s1">fontset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">5.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">text</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s1">fontset</span><span class="s2">,</span>
             <span class="s1">horizontalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">, </span><span class="s1">verticalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">'index, text'</span><span class="s2">, </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">font_tests</span><span class="s2">), </span><span class="s1">ids</span><span class="s2">=</span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">font_tests</span><span class="s2">)))</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">'fontset'</span><span class="s2">, [</span><span class="s4">'cm'</span><span class="s2">, </span><span class="s4">'stix'</span><span class="s2">, </span><span class="s4">'stixsans'</span><span class="s2">, </span><span class="s4">'dejavusans'</span><span class="s2">, </span><span class="s4">'dejavuserif'</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'baseline_images'</span><span class="s2">, [</span><span class="s4">'mathfont'</span><span class="s2">], </span><span class="s1">indirect</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">'png'</span><span class="s2">],</span>
                  <span class="s1">tol</span><span class="s2">=</span><span class="s5">0.011 </span><span class="s0">if </span><span class="s1">platform</span><span class="s2">.</span><span class="s1">machine</span><span class="s2">() </span><span class="s0">in </span><span class="s2">(</span><span class="s4">'ppc64le'</span><span class="s2">, </span><span class="s4">'s390x'</span><span class="s2">) </span><span class="s0">else </span><span class="s5">0</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mathfont_rendering</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">, </span><span class="s1">fontset</span><span class="s2">, </span><span class="s1">index</span><span class="s2">, </span><span class="s1">text</span><span class="s2">):</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fontset'</span><span class="s2">] = </span><span class="s1">fontset</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">5.25</span><span class="s2">, </span><span class="s5">0.75</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">text</span><span class="s2">,</span>
             <span class="s1">horizontalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">, </span><span class="s1">verticalalignment</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_short_long_accents</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">acc_map </span><span class="s2">= </span><span class="s1">_mathtext</span><span class="s2">.</span><span class="s1">Parser</span><span class="s2">.</span><span class="s1">_accent_map</span>
    <span class="s1">short_accs </span><span class="s2">= [</span><span class="s1">s </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">acc_map </span><span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">s</span><span class="s2">) == </span><span class="s5">1</span><span class="s2">]</span>
    <span class="s1">corresponding_long_accs </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">short_accs</span><span class="s2">:</span>
        <span class="s1">l</span><span class="s2">, = [</span><span class="s1">l </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">acc_map </span><span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">l</span><span class="s2">) &gt; </span><span class="s5">1 </span><span class="s0">and </span><span class="s1">acc_map</span><span class="s2">[</span><span class="s1">l</span><span class="s2">] == </span><span class="s1">acc_map</span><span class="s2">[</span><span class="s1">s</span><span class="s2">]]</span>
        <span class="s1">corresponding_long_accs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">l</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s4">&quot;$&quot; </span><span class="s2">+ </span><span class="s4">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">rf&quot;\</span><span class="s0">{</span><span class="s1">s</span><span class="s0">}</span><span class="s4">a&quot; </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">short_accs</span><span class="s2">) + </span><span class="s4">&quot;$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span>
        <span class="s5">0</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s4">&quot;$&quot; </span><span class="s2">+ </span><span class="s4">&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s4">fr&quot;\</span><span class="s0">{</span><span class="s1">l</span><span class="s0">} </span><span class="s4">a&quot; </span><span class="s0">for </span><span class="s1">l </span><span class="s0">in </span><span class="s1">corresponding_long_accs</span><span class="s2">) + </span><span class="s4">&quot;$&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_fontinfo</span><span class="s2">():</span>
    <span class="s1">fontpath </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">font_manager</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s4">&quot;DejaVu Sans&quot;</span><span class="s2">)</span>
    <span class="s1">font </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">ft2font</span><span class="s2">.</span><span class="s1">FT2Font</span><span class="s2">(</span><span class="s1">fontpath</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s1">font</span><span class="s2">.</span><span class="s1">get_sfnt_table</span><span class="s2">(</span><span class="s4">&quot;head&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">table </span><span class="s0">is not None</span>
    <span class="s0">assert </span><span class="s1">table</span><span class="s2">[</span><span class="s4">'version'</span><span class="s2">] == (</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">)</span>


<span class="s3"># See gh-26152 for more context on this xfail</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">pyparsing_version</span><span class="s2">.</span><span class="s1">release </span><span class="s2">== (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">),</span>
                   <span class="s1">reason</span><span class="s2">=</span><span class="s4">&quot;Error messages are incorrect for this version&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">'math, msg'</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s4">r'$\hspace{}$'</span><span class="s2">, </span><span class="s4">r'Expected \hspace{space}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\hspace{foo}$'</span><span class="s2">, </span><span class="s4">r'Expected \hspace{space}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\sinx$'</span><span class="s2">, </span><span class="s4">r'Unknown symbol: \sinx'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\dotx$'</span><span class="s2">, </span><span class="s4">r'Unknown symbol: \dotx'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\frac$'</span><span class="s2">, </span><span class="s4">r'Expected \frac{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\frac{}{}$'</span><span class="s2">, </span><span class="s4">r'Expected \frac{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\binom$'</span><span class="s2">, </span><span class="s4">r'Expected \binom{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\binom{}{}$'</span><span class="s2">, </span><span class="s4">r'Expected \binom{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\genfrac$'</span><span class="s2">,</span>
         <span class="s4">r'Expected \genfrac{ldelim}{rdelim}{rulesize}{style}{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\genfrac{}{}{}{}{}{}$'</span><span class="s2">,</span>
         <span class="s4">r'Expected \genfrac{ldelim}{rdelim}{rulesize}{style}{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\sqrt$'</span><span class="s2">, </span><span class="s4">r'Expected \sqrt{value}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\sqrt f$'</span><span class="s2">, </span><span class="s4">r'Expected \sqrt{value}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\overline$'</span><span class="s2">, </span><span class="s4">r'Expected \overline{body}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\overline{}$'</span><span class="s2">, </span><span class="s4">r'Expected \overline{body}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\leftF$'</span><span class="s2">, </span><span class="s4">r'Expected a delimiter'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\rightF$'</span><span class="s2">, </span><span class="s4">r'Unknown symbol: \rightF'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\left(\right$'</span><span class="s2">, </span><span class="s4">r'Expected a delimiter'</span><span class="s2">),</span>
        <span class="s3"># PyParsing 2 uses double quotes, PyParsing 3 uses single quotes and an</span>
        <span class="s3"># extra backslash.</span>
        <span class="s2">(</span><span class="s4">r'$\left($'</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s4">r'Expected (&quot;|\'\\)\\right[&quot;\']'</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s4">r'$\dfrac$'</span><span class="s2">, </span><span class="s4">r'Expected \dfrac{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\dfrac{}{}$'</span><span class="s2">, </span><span class="s4">r'Expected \dfrac{num}{den}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\overset$'</span><span class="s2">, </span><span class="s4">r'Expected \overset{annotation}{body}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\underset$'</span><span class="s2">, </span><span class="s4">r'Expected \underset{annotation}{body}'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$\foo$'</span><span class="s2">, </span><span class="s4">r'Unknown symbol: \foo'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$a^2^2$'</span><span class="s2">, </span><span class="s4">r'Double superscript'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$a_2_2$'</span><span class="s2">, </span><span class="s4">r'Double subscript'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$a^2_a^2$'</span><span class="s2">, </span><span class="s4">r'Double superscript'</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">r'$a = {b$'</span><span class="s2">, </span><span class="s4">r&quot;Expected '}'&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
    <span class="s1">ids</span><span class="s2">=[</span>
        <span class="s4">'hspace without value'</span><span class="s2">,</span>
        <span class="s4">'hspace with invalid value'</span><span class="s2">,</span>
        <span class="s4">'function without space'</span><span class="s2">,</span>
        <span class="s4">'accent without space'</span><span class="s2">,</span>
        <span class="s4">'frac without parameters'</span><span class="s2">,</span>
        <span class="s4">'frac with empty parameters'</span><span class="s2">,</span>
        <span class="s4">'binom without parameters'</span><span class="s2">,</span>
        <span class="s4">'binom with empty parameters'</span><span class="s2">,</span>
        <span class="s4">'genfrac without parameters'</span><span class="s2">,</span>
        <span class="s4">'genfrac with empty parameters'</span><span class="s2">,</span>
        <span class="s4">'sqrt without parameters'</span><span class="s2">,</span>
        <span class="s4">'sqrt with invalid value'</span><span class="s2">,</span>
        <span class="s4">'overline without parameters'</span><span class="s2">,</span>
        <span class="s4">'overline with empty parameter'</span><span class="s2">,</span>
        <span class="s4">'left with invalid delimiter'</span><span class="s2">,</span>
        <span class="s4">'right with invalid delimiter'</span><span class="s2">,</span>
        <span class="s4">'unclosed parentheses with sizing'</span><span class="s2">,</span>
        <span class="s4">'unclosed parentheses without sizing'</span><span class="s2">,</span>
        <span class="s4">'dfrac without parameters'</span><span class="s2">,</span>
        <span class="s4">'dfrac with empty parameters'</span><span class="s2">,</span>
        <span class="s4">'overset without parameters'</span><span class="s2">,</span>
        <span class="s4">'underset without parameters'</span><span class="s2">,</span>
        <span class="s4">'unknown symbol'</span><span class="s2">,</span>
        <span class="s4">'double superscript'</span><span class="s2">,</span>
        <span class="s4">'double subscript'</span><span class="s2">,</span>
        <span class="s4">'super on sub without braces'</span><span class="s2">,</span>
        <span class="s4">'unclosed group'</span><span class="s2">,</span>
    <span class="s2">]</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mathtext_exceptions</span><span class="s2">(</span><span class="s1">math</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">):</span>
    <span class="s1">parser </span><span class="s2">= </span><span class="s1">mathtext</span><span class="s2">.</span><span class="s1">MathTextParser</span><span class="s2">(</span><span class="s4">'agg'</span><span class="s2">)</span>
    <span class="s1">match </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">str</span><span class="s2">) </span><span class="s0">else </span><span class="s1">msg</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">match</span><span class="s2">):</span>
        <span class="s1">parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">(</span><span class="s1">math</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_unicode_index_exception</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
        <span class="s1">_mathtext</span><span class="s2">.</span><span class="s1">get_unicode_index</span><span class="s2">(</span><span class="s4">r'\foo'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_single_minus_sign</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s4">'$-$'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">renderer</span><span class="s2">.</span><span class="s1">buffer_rgba</span><span class="s2">())</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">t </span><span class="s2">!= </span><span class="s5">0xff</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()  </span><span class="s3"># assert that canvas is not all white.</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_spaces</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s4">r&quot;$1\,2\&gt;3\ 4$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s4">r&quot;$1\/2\:3~4$&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_operator_space</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s4">r&quot;$\log 6$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s4">r&quot;$\log(6)$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s4">r&quot;$\arcsin 6$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s4">r&quot;$\arcsin|6|$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s4">r&quot;$\operatorname{op} 6$&quot;</span><span class="s2">)  </span><span class="s3"># GitHub issue #553</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s4">r&quot;$\operatorname{op}[6]$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s4">r&quot;$\cos^2$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s4">r&quot;$\log_2$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s4">r&quot;$\sin^2 \cos$&quot;</span><span class="s2">)  </span><span class="s3"># GitHub issue #17852</span>

    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{log\,}6$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{log}(6)$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{arcsin\,}6$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{arcsin}|6|$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{op\,}6$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.6</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{op}[6]$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{cos}^2$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{log}_2$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.9</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{sin}^2 \mathrm{\,cos}$&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_inverted_delimiters</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s4">r&quot;$\left)\right($&quot;</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">&quot;dejavusans&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s4">r&quot;$)($&quot;</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">&quot;dejavusans&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_genfrac_displaystyle</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s4">r&quot;$\dfrac{2x}{3y}$&quot;</span><span class="s2">)</span>

    <span class="s1">thickness </span><span class="s2">= </span><span class="s1">_mathtext</span><span class="s2">.</span><span class="s1">TruetypeFonts</span><span class="s2">.</span><span class="s1">get_underline_thickness</span><span class="s2">(</span>
        <span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;font.size&quot;</span><span class="s2">],</span>
        <span class="s1">dpi</span><span class="s2">=</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;savefig.dpi&quot;</span><span class="s2">])</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s4">r&quot;$\genfrac{}{}{%f}{0}{2x}{3y}$&quot; </span><span class="s2">% </span><span class="s1">thickness</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_mathtext_fallback_valid</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">fallback </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'cm'</span><span class="s2">, </span><span class="s4">'stix'</span><span class="s2">, </span><span class="s4">'stixsans'</span><span class="s2">, </span><span class="s4">'None'</span><span class="s2">]:</span>
        <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fallback'</span><span class="s2">] = </span><span class="s1">fallback</span>


<span class="s0">def </span><span class="s1">test_mathtext_fallback_invalid</span><span class="s2">():</span>
    <span class="s0">for </span><span class="s1">fallback </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'abc'</span><span class="s2">, </span><span class="s4">''</span><span class="s2">]:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s4">&quot;not a valid fallback font name&quot;</span><span class="s2">):</span>
            <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fallback'</span><span class="s2">] = </span><span class="s1">fallback</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s4">&quot;fallback,fontlist&quot;</span><span class="s2">,</span>
    <span class="s2">[(</span><span class="s4">&quot;cm&quot;</span><span class="s2">, [</span><span class="s4">'DejaVu Sans'</span><span class="s2">, </span><span class="s4">'mpltest'</span><span class="s2">, </span><span class="s4">'STIXGeneral'</span><span class="s2">, </span><span class="s4">'cmr10'</span><span class="s2">, </span><span class="s4">'STIXGeneral'</span><span class="s2">]),</span>
     <span class="s2">(</span><span class="s4">&quot;stix&quot;</span><span class="s2">, [</span><span class="s4">'DejaVu Sans'</span><span class="s2">, </span><span class="s4">'mpltest'</span><span class="s2">, </span><span class="s4">'STIXGeneral'</span><span class="s2">])])</span>
<span class="s0">def </span><span class="s1">test_mathtext_fallback</span><span class="s2">(</span><span class="s1">fallback</span><span class="s2">, </span><span class="s1">fontlist</span><span class="s2">):</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">font_manager</span><span class="s2">.</span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">addfont</span><span class="s2">(</span>
        <span class="s1">str</span><span class="s2">(</span><span class="s1">Path</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">).</span><span class="s1">resolve</span><span class="s2">().</span><span class="s1">parent </span><span class="s2">/ </span><span class="s4">'mpltest.ttf'</span><span class="s2">))</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;svg.fonttype&quot;</span><span class="s2">] = </span><span class="s4">'none'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fontset'</span><span class="s2">] = </span><span class="s4">'custom'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.rm'</span><span class="s2">] = </span><span class="s4">'mpltest'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.it'</span><span class="s2">] = </span><span class="s4">'mpltest:italic'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.bf'</span><span class="s2">] = </span><span class="s4">'mpltest:bold'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.bfit'</span><span class="s2">] = </span><span class="s4">'mpltest:italic:bold'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fallback'</span><span class="s2">] = </span><span class="s1">fallback</span>

    <span class="s1">test_str </span><span class="s2">= </span><span class="s4">r'a$A\AA\breve\gimel$'</span>

    <span class="s1">buff </span><span class="s2">= </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">.5</span><span class="s2">, </span><span class="s5">.5</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">, </span><span class="s1">fontsize</span><span class="s2">=</span><span class="s5">40</span><span class="s2">, </span><span class="s1">ha</span><span class="s2">=</span><span class="s4">'center'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;svg&quot;</span><span class="s2">)</span>
    <span class="s1">tspans </span><span class="s2">= (</span><span class="s1">ET</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">buff</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">())</span>
              <span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">&quot;.//{http://www.w3.org/2000/svg}tspan[@style]&quot;</span><span class="s2">))</span>
    <span class="s3"># Getting the last element of the style attrib is a close enough</span>
    <span class="s3"># approximation for parsing the font property.</span>
    <span class="s1">char_fonts </span><span class="s2">= [</span><span class="s1">shlex</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">tspan</span><span class="s2">.</span><span class="s1">attrib</span><span class="s2">[</span><span class="s4">&quot;style&quot;</span><span class="s2">])[-</span><span class="s5">1</span><span class="s2">] </span><span class="s0">for </span><span class="s1">tspan </span><span class="s0">in </span><span class="s1">tspans</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">char_fonts </span><span class="s2">== </span><span class="s1">fontlist</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">font_manager</span><span class="s2">.</span><span class="s1">fontManager</span><span class="s2">.</span><span class="s1">ttflist</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_math_to_image</span><span class="s2">(</span><span class="s1">tmp_path</span><span class="s2">):</span>
    <span class="s1">mathtext</span><span class="s2">.</span><span class="s1">math_to_image</span><span class="s2">(</span><span class="s4">'$x^2$'</span><span class="s2">, </span><span class="s1">tmp_path </span><span class="s2">/ </span><span class="s4">'example.png'</span><span class="s2">)</span>
    <span class="s1">mathtext</span><span class="s2">.</span><span class="s1">math_to_image</span><span class="s2">(</span><span class="s4">'$x^2$'</span><span class="s2">, </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">())</span>
    <span class="s1">mathtext</span><span class="s2">.</span><span class="s1">math_to_image</span><span class="s2">(</span><span class="s4">'$x^2$'</span><span class="s2">, </span><span class="s1">io</span><span class="s2">.</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">color</span><span class="s2">=</span><span class="s4">'Maroon'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">(</span><span class="s1">baseline_images</span><span class="s2">=[</span><span class="s4">'math_fontfamily_image.png'</span><span class="s2">],</span>
                  <span class="s1">savefig_kwarg</span><span class="s2">={</span><span class="s4">'dpi'</span><span class="s2">: </span><span class="s5">40</span><span class="s2">})</span>
<span class="s0">def </span><span class="s1">test_math_fontfamily</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">(</span><span class="s1">figsize</span><span class="s2">=(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s4">r&quot;$This\ text\ should\ have\ one\ font$&quot;</span><span class="s2">,</span>
             <span class="s1">size</span><span class="s2">=</span><span class="s5">24</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">'dejavusans'</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s4">r&quot;$This\ text\ should\ have\ another$&quot;</span><span class="s2">,</span>
             <span class="s1">size</span><span class="s2">=</span><span class="s5">24</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">'stix'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_default_math_fontfamily</span><span class="s2">():</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fontset'</span><span class="s2">] = </span><span class="s4">'cm'</span>
    <span class="s1">test_str </span><span class="s2">= </span><span class="s4">r'abc$abc\alpha$'</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">text1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">, </span><span class="s1">font</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">)</span>
    <span class="s1">prop1 </span><span class="s2">= </span><span class="s1">text1</span><span class="s2">.</span><span class="s1">get_fontproperties</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">prop1</span><span class="s2">.</span><span class="s1">get_math_fontfamily</span><span class="s2">() == </span><span class="s4">'cm'</span>
    <span class="s1">text2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">, </span><span class="s1">fontproperties</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">)</span>
    <span class="s1">prop2 </span><span class="s2">= </span><span class="s1">text2</span><span class="s2">.</span><span class="s1">get_fontproperties</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">prop2</span><span class="s2">.</span><span class="s1">get_math_fontfamily</span><span class="s2">() == </span><span class="s4">'cm'</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_argument_order</span><span class="s2">():</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'mathtext.fontset'</span><span class="s2">] = </span><span class="s4">'cm'</span>
    <span class="s1">test_str </span><span class="s2">= </span><span class="s4">r'abc$abc\alpha$'</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">text1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">,</span>
                     <span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">'dejavusans'</span><span class="s2">, </span><span class="s1">font</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">)</span>
    <span class="s1">prop1 </span><span class="s2">= </span><span class="s1">text1</span><span class="s2">.</span><span class="s1">get_fontproperties</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">prop1</span><span class="s2">.</span><span class="s1">get_math_fontfamily</span><span class="s2">() == </span><span class="s4">'dejavusans'</span>
    <span class="s1">text2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">,</span>
                     <span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">'dejavusans'</span><span class="s2">, </span><span class="s1">fontproperties</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">)</span>
    <span class="s1">prop2 </span><span class="s2">= </span><span class="s1">text2</span><span class="s2">.</span><span class="s1">get_fontproperties</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">prop2</span><span class="s2">.</span><span class="s1">get_math_fontfamily</span><span class="s2">() == </span><span class="s4">'dejavusans'</span>
    <span class="s1">text3 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.3</span><span class="s2">, </span><span class="s5">0.3</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">,</span>
                     <span class="s1">font</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">'dejavusans'</span><span class="s2">)</span>
    <span class="s1">prop3 </span><span class="s2">= </span><span class="s1">text3</span><span class="s2">.</span><span class="s1">get_fontproperties</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">prop3</span><span class="s2">.</span><span class="s1">get_math_fontfamily</span><span class="s2">() == </span><span class="s4">'dejavusans'</span>
    <span class="s1">text4 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s1">test_str</span><span class="s2">,</span>
                     <span class="s1">fontproperties</span><span class="s2">=</span><span class="s4">'Arial'</span><span class="s2">, </span><span class="s1">math_fontfamily</span><span class="s2">=</span><span class="s4">'dejavusans'</span><span class="s2">)</span>
    <span class="s1">prop4 </span><span class="s2">= </span><span class="s1">text4</span><span class="s2">.</span><span class="s1">get_fontproperties</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">prop4</span><span class="s2">.</span><span class="s1">get_math_fontfamily</span><span class="s2">() == </span><span class="s4">'dejavusans'</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_mathtext_cmr10_minus_sign</span><span class="s2">():</span>
    <span class="s3"># cmr10 does not contain a minus sign and used to issue a warning</span>
    <span class="s3"># RuntimeWarning: Glyph 8722 missing from current font.</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'font.family'</span><span class="s2">] = </span><span class="s4">'cmr10'</span>
    <span class="s1">mpl</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'axes.formatter.use_mathtext'</span><span class="s2">] = </span><span class="s0">True</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">), </span><span class="s1">range</span><span class="s2">(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s2">))</span>
    <span class="s3"># draw to make sure we have no warnings</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_mathtext_operators</span><span class="s2">():</span>
    <span class="s1">test_str </span><span class="s2">= </span><span class="s4">r''' 
    \increment \smallin \notsmallowns 
    \smallowns \QED \rightangle 
    \smallintclockwise \smallvarointclockwise 
    \smallointctrcclockwise 
    \ratio \minuscolon \dotsminusdots 
    \sinewave \simneqq \nlesssim 
    \ngtrsim \nlessgtr \ngtrless 
    \cupleftarrow \oequal \rightassert 
    \rightModels \hermitmatrix \barvee 
    \measuredrightangle \varlrtriangle 
    \equalparallel \npreccurlyeq \nsucccurlyeq 
    \nsqsubseteq \nsqsupseteq \sqsubsetneq 
    \sqsupsetneq  \disin \varisins 
    \isins \isindot \varisinobar 
    \isinobar \isinvb \isinE 
    \nisd \varnis \nis 
    \varniobar \niobar \bagmember 
    \triangle'''</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">i </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">test_str</span><span class="s2">):</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">, (</span><span class="s1">x </span><span class="s2">+ </span><span class="s5">0.5</span><span class="s2">)/</span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_str</span><span class="s2">), </span><span class="s4">r'${%s}$' </span><span class="s2">% </span><span class="s1">i</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">draw_without_rendering</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">&quot;png&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_boldsymbol</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">fig_test</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s4">r&quot;$\boldsymbol{\mathrm{abc0123\alpha}}$&quot;</span><span class="s2">)</span>
    <span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s4">r&quot;$\mathrm{abc0123\alpha}$&quot;</span><span class="s2">)</span>
</pre>
</body>
</html>