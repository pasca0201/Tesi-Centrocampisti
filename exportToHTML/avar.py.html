<html>
<head>
<title>avar.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
avar.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">varLib </span><span class="s0">import </span><span class="s1">_add_avar</span><span class="s2">, </span><span class="s1">load_designspace</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">varLib</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">VariationModel</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">varLib</span><span class="s2">.</span><span class="s1">varStore </span><span class="s0">import </span><span class="s1">VarStoreInstancer</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">fixedTools </span><span class="s0">import </span><span class="s1">fixedToFloat </span><span class="s0">as </span><span class="s1">fi2fl</span>
<span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">misc</span><span class="s2">.</span><span class="s1">cliTools </span><span class="s0">import </span><span class="s1">makeOutputFileName</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>
<span class="s0">import </span><span class="s1">logging</span>

<span class="s1">log </span><span class="s2">= </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s3">&quot;fontTools.varLib.avar&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_denormalize</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">v </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">defaultValue </span><span class="s2">+ </span><span class="s1">v </span><span class="s2">* (</span><span class="s1">axis</span><span class="s2">.</span><span class="s1">maxValue </span><span class="s2">- </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">defaultValue</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">defaultValue </span><span class="s2">+ </span><span class="s1">v </span><span class="s2">* (</span><span class="s1">axis</span><span class="s2">.</span><span class="s1">defaultValue </span><span class="s2">- </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">minValue</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_pruneLocations</span><span class="s2">(</span><span class="s1">locations</span><span class="s2">, </span><span class="s1">poles</span><span class="s2">, </span><span class="s1">axisTags</span><span class="s2">):</span>
    <span class="s5"># Now we have all the input locations, find which ones are</span>
    <span class="s5"># not needed and remove them.</span>

    <span class="s5"># Note: This algorithm is heavily tied to how VariationModel</span>
    <span class="s5"># is implemented.  It assumes that input was extracted from</span>
    <span class="s5"># VariationModel-generated object, like an ItemVariationStore</span>
    <span class="s5"># created by fontmake using varLib.models.VariationModel.</span>
    <span class="s5"># Some CoPilot blabbering:</span>
    <span class="s5"># I *think* I can prove that this algorithm is correct, but</span>
    <span class="s5"># I'm not 100% sure.  It's possible that there are edge cases</span>
    <span class="s5"># where this algorithm will fail.  I'm not sure how to prove</span>
    <span class="s5"># that it's correct, but I'm also not sure how to prove that</span>
    <span class="s5"># it's incorrect.  I'm not sure how to write a test case that</span>
    <span class="s5"># would prove that it's incorrect.  I'm not sure how to write</span>
    <span class="s5"># a test case that would prove that it's correct.</span>

    <span class="s1">model </span><span class="s2">= </span><span class="s1">VariationModel</span><span class="s2">(</span><span class="s1">locations</span><span class="s2">, </span><span class="s1">axisTags</span><span class="s2">)</span>
    <span class="s1">modelMapping </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">mapping</span>
    <span class="s1">modelSupports </span><span class="s2">= </span><span class="s1">model</span><span class="s2">.</span><span class="s1">supports</span>
    <span class="s1">pins </span><span class="s2">= {</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">k</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()): </span><span class="s0">None for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">poles</span><span class="s2">}</span>
    <span class="s0">for </span><span class="s1">location </span><span class="s0">in </span><span class="s1">poles</span><span class="s2">:</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">locations</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">location</span><span class="s2">)</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">modelMapping</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">support </span><span class="s2">= </span><span class="s1">modelSupports</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">supportAxes </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">support</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s0">for </span><span class="s1">axisTag</span><span class="s2">, (</span><span class="s1">minV</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">maxV</span><span class="s2">) </span><span class="s0">in </span><span class="s1">support</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s2">(</span><span class="s1">minV</span><span class="s2">, </span><span class="s1">maxV</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">v </span><span class="s0">in </span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
                    <span class="s0">continue</span>
                <span class="s0">for </span><span class="s1">pin </span><span class="s0">in </span><span class="s1">pins</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">():</span>
                    <span class="s1">pinLocation </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">pin</span><span class="s2">)</span>
                    <span class="s1">pinAxes </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">pinLocation</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
                    <span class="s0">if </span><span class="s1">pinAxes </span><span class="s2">!= </span><span class="s1">supportAxes</span><span class="s2">:</span>
                        <span class="s0">continue</span>
                    <span class="s0">if </span><span class="s1">axisTag </span><span class="s0">not in </span><span class="s1">pinAxes</span><span class="s2">:</span>
                        <span class="s0">continue</span>
                    <span class="s0">if </span><span class="s1">pinLocation</span><span class="s2">[</span><span class="s1">axisTag</span><span class="s2">] == </span><span class="s1">v</span><span class="s2">:</span>
                        <span class="s0">break</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s5"># No pin found. Go through the previous masters</span>
                    <span class="s5"># and find a suitable pin.  Going backwards is</span>
                    <span class="s5"># better because it can find a pin that is close</span>
                    <span class="s5"># to the pole in more dimensions, and reducing</span>
                    <span class="s5"># the total number of pins needed.</span>
                    <span class="s0">for </span><span class="s1">candidateIdx </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">i </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">):</span>
                        <span class="s1">candidate </span><span class="s2">= </span><span class="s1">modelSupports</span><span class="s2">[</span><span class="s1">candidateIdx</span><span class="s2">]</span>
                        <span class="s1">candidateAxes </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">candidate</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
                        <span class="s0">if </span><span class="s1">candidateAxes </span><span class="s2">!= </span><span class="s1">supportAxes</span><span class="s2">:</span>
                            <span class="s0">continue</span>
                        <span class="s0">if </span><span class="s1">axisTag </span><span class="s0">not in </span><span class="s1">candidateAxes</span><span class="s2">:</span>
                            <span class="s0">continue</span>
                        <span class="s1">candidate </span><span class="s2">= {</span>
                            <span class="s1">k</span><span class="s2">: </span><span class="s1">defaultV </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, (</span><span class="s1">_</span><span class="s2">, </span><span class="s1">defaultV</span><span class="s2">, </span><span class="s1">_</span><span class="s2">) </span><span class="s0">in </span><span class="s1">candidate</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
                        <span class="s2">}</span>
                        <span class="s0">if </span><span class="s1">candidate</span><span class="s2">[</span><span class="s1">axisTag</span><span class="s2">] == </span><span class="s1">v</span><span class="s2">:</span>
                            <span class="s1">pins</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">candidate</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())] = </span><span class="s0">None</span>
                            <span class="s0">break</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s0">assert False</span><span class="s2">, </span><span class="s3">&quot;No pin found&quot;</span>
    <span class="s0">return </span><span class="s2">[</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">pins</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()]</span>


<span class="s0">def </span><span class="s1">mappings_from_avar</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">denormalize</span><span class="s2">=</span><span class="s0">True</span><span class="s2">):</span>
    <span class="s1">fvarAxes </span><span class="s2">= </span><span class="s1">font</span><span class="s2">[</span><span class="s3">&quot;fvar&quot;</span><span class="s2">].</span><span class="s1">axes</span>
    <span class="s1">axisMap </span><span class="s2">= {</span><span class="s1">a</span><span class="s2">.</span><span class="s1">axisTag</span><span class="s2">: </span><span class="s1">a </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">fvarAxes</span><span class="s2">}</span>
    <span class="s1">axisTags </span><span class="s2">= [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">axisTag </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">fvarAxes</span><span class="s2">]</span>
    <span class="s1">axisIndexes </span><span class="s2">= {</span><span class="s1">a</span><span class="s2">.</span><span class="s1">axisTag</span><span class="s2">: </span><span class="s1">i </span><span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">a </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">fvarAxes</span><span class="s2">)}</span>
    <span class="s0">if </span><span class="s3">&quot;avar&quot; </span><span class="s0">not in </span><span class="s1">font</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">{}, {}</span>
    <span class="s1">avar </span><span class="s2">= </span><span class="s1">font</span><span class="s2">[</span><span class="s3">&quot;avar&quot;</span><span class="s2">]</span>
    <span class="s1">axisMaps </span><span class="s2">= {</span>
        <span class="s1">tag</span><span class="s2">: </span><span class="s1">seg</span>
        <span class="s0">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">seg </span><span class="s0">in </span><span class="s1">avar</span><span class="s2">.</span><span class="s1">segments</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">seg </span><span class="s0">and </span><span class="s1">seg </span><span class="s2">!= {-</span><span class="s4">1</span><span class="s2">: -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">: </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}</span>
    <span class="s2">}</span>
    <span class="s1">mappings </span><span class="s2">= []</span>

    <span class="s0">if </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">avar</span><span class="s2">, </span><span class="s3">&quot;majorVersion&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">) == </span><span class="s4">2</span><span class="s2">:</span>
        <span class="s1">varStore </span><span class="s2">= </span><span class="s1">avar</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">VarStore</span>
        <span class="s1">regions </span><span class="s2">= </span><span class="s1">varStore</span><span class="s2">.</span><span class="s1">VarRegionList</span><span class="s2">.</span><span class="s1">Region</span>

        <span class="s5"># Find all the input locations; this finds &quot;poles&quot;, that are</span>
        <span class="s5"># locations of the peaks, and &quot;corners&quot;, that are locations</span>
        <span class="s5"># of the corners of the regions.  These two sets of locations</span>
        <span class="s5"># together constitute inputLocations to consider.</span>

        <span class="s1">poles </span><span class="s2">= {(): </span><span class="s0">None</span><span class="s2">}  </span><span class="s5"># Just using it as an ordered set</span>
        <span class="s1">inputLocations </span><span class="s2">= </span><span class="s1">set</span><span class="s2">({()})</span>
        <span class="s0">for </span><span class="s1">varData </span><span class="s0">in </span><span class="s1">varStore</span><span class="s2">.</span><span class="s1">VarData</span><span class="s2">:</span>
            <span class="s1">regionIndices </span><span class="s2">= </span><span class="s1">varData</span><span class="s2">.</span><span class="s1">VarRegionIndex</span>
            <span class="s0">for </span><span class="s1">regionIndex </span><span class="s0">in </span><span class="s1">regionIndices</span><span class="s2">:</span>
                <span class="s1">peakLocation </span><span class="s2">= []</span>
                <span class="s1">corners </span><span class="s2">= []</span>
                <span class="s1">region </span><span class="s2">= </span><span class="s1">regions</span><span class="s2">[</span><span class="s1">regionIndex</span><span class="s2">]</span>
                <span class="s0">for </span><span class="s1">axisIndex</span><span class="s2">, </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">region</span><span class="s2">.</span><span class="s1">VarRegionAxis</span><span class="s2">):</span>
                    <span class="s0">if </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">PeakCoord </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
                        <span class="s0">continue</span>
                    <span class="s1">axisTag </span><span class="s2">= </span><span class="s1">axisTags</span><span class="s2">[</span><span class="s1">axisIndex</span><span class="s2">]</span>
                    <span class="s1">peakLocation</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">axisTag</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">PeakCoord</span><span class="s2">))</span>
                    <span class="s1">corner </span><span class="s2">= []</span>
                    <span class="s0">if </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">StartCoord </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
                        <span class="s1">corner</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">axisTag</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">StartCoord</span><span class="s2">))</span>
                    <span class="s0">if </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">EndCoord </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
                        <span class="s1">corner</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">axisTag</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">.</span><span class="s1">EndCoord</span><span class="s2">))</span>
                    <span class="s1">corners</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">corner</span><span class="s2">)</span>
                <span class="s1">corners </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">corners</span><span class="s2">))</span>
                <span class="s1">peakLocation </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">peakLocation</span><span class="s2">)</span>
                <span class="s1">poles</span><span class="s2">[</span><span class="s1">peakLocation</span><span class="s2">] = </span><span class="s0">None</span>
                <span class="s1">inputLocations</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">peakLocation</span><span class="s2">)</span>
                <span class="s1">inputLocations</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">corners</span><span class="s2">)</span>

        <span class="s5"># Sort them by number of axes, then by axis order</span>
        <span class="s1">inputLocations </span><span class="s2">= [</span>
            <span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">sorted</span><span class="s2">(</span>
                <span class="s1">inputLocations</span><span class="s2">,</span>
                <span class="s1">key</span><span class="s2">=</span><span class="s0">lambda </span><span class="s1">t</span><span class="s2">: (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">), </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">axisIndexes</span><span class="s2">[</span><span class="s1">tag</span><span class="s2">] </span><span class="s0">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">t</span><span class="s2">)),</span>
            <span class="s2">)</span>
        <span class="s2">]</span>
        <span class="s1">poles </span><span class="s2">= [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">poles</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()]</span>
        <span class="s1">inputLocations </span><span class="s2">= </span><span class="s1">_pruneLocations</span><span class="s2">(</span><span class="s1">inputLocations</span><span class="s2">, </span><span class="s1">list</span><span class="s2">(</span><span class="s1">poles</span><span class="s2">), </span><span class="s1">axisTags</span><span class="s2">)</span>

        <span class="s5"># Find the output locations, at input locations</span>
        <span class="s1">varIdxMap </span><span class="s2">= </span><span class="s1">avar</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">VarIdxMap</span>
        <span class="s1">instancer </span><span class="s2">= </span><span class="s1">VarStoreInstancer</span><span class="s2">(</span><span class="s1">varStore</span><span class="s2">, </span><span class="s1">fvarAxes</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">location </span><span class="s0">in </span><span class="s1">inputLocations</span><span class="s2">:</span>
            <span class="s1">instancer</span><span class="s2">.</span><span class="s1">setLocation</span><span class="s2">(</span><span class="s1">location</span><span class="s2">)</span>
            <span class="s1">outputLocation </span><span class="s2">= {}</span>
            <span class="s0">for </span><span class="s1">axisIndex</span><span class="s2">, </span><span class="s1">axisTag </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">axisTags</span><span class="s2">):</span>
                <span class="s1">varIdx </span><span class="s2">= </span><span class="s1">axisIndex</span>
                <span class="s0">if </span><span class="s1">varIdxMap </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s1">varIdx </span><span class="s2">= </span><span class="s1">varIdxMap</span><span class="s2">[</span><span class="s1">varIdx</span><span class="s2">]</span>
                <span class="s1">delta </span><span class="s2">= </span><span class="s1">instancer</span><span class="s2">[</span><span class="s1">varIdx</span><span class="s2">]</span>
                <span class="s0">if </span><span class="s1">delta </span><span class="s2">!= </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">v </span><span class="s2">= </span><span class="s1">location</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">axisTag</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
                    <span class="s1">v </span><span class="s2">= </span><span class="s1">v </span><span class="s2">+ </span><span class="s1">fi2fl</span><span class="s2">(</span><span class="s1">delta</span><span class="s2">, </span><span class="s4">14</span><span class="s2">)</span>
                    <span class="s5"># See https://github.com/fonttools/fonttools/pull/3598#issuecomment-2266082009</span>
                    <span class="s5"># v = max(-1, min(1, v))</span>
                    <span class="s1">outputLocation</span><span class="s2">[</span><span class="s1">axisTag</span><span class="s2">] = </span><span class="s1">v</span>
            <span class="s1">mappings</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">location</span><span class="s2">, </span><span class="s1">outputLocation</span><span class="s2">))</span>

        <span class="s5"># Remove base master we added, if it maps to the default location</span>
        <span class="s0">assert </span><span class="s1">mappings</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">0</span><span class="s2">] == {}</span>
        <span class="s0">if </span><span class="s1">mappings</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">] == {}:</span>
            <span class="s1">mappings</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">denormalize</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">seg </span><span class="s0">in </span><span class="s1">axisMaps</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">tag </span><span class="s0">not in </span><span class="s1">axisMap</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">f&quot;Unknown axis tag </span><span class="s0">{</span><span class="s1">tag</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
            <span class="s1">denorm </span><span class="s2">= </span><span class="s0">lambda </span><span class="s1">v</span><span class="s2">: </span><span class="s1">_denormalize</span><span class="s2">(</span><span class="s1">v</span><span class="s2">, </span><span class="s1">axisMap</span><span class="s2">[</span><span class="s1">tag</span><span class="s2">])</span>
            <span class="s1">axisMaps</span><span class="s2">[</span><span class="s1">tag</span><span class="s2">] = {</span><span class="s1">denorm</span><span class="s2">(</span><span class="s1">k</span><span class="s2">): </span><span class="s1">denorm</span><span class="s2">(</span><span class="s1">v</span><span class="s2">) </span><span class="s0">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">seg</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()}</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">inputLoc</span><span class="s2">, </span><span class="s1">outputLoc</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">mappings</span><span class="s2">):</span>
            <span class="s1">inputLoc </span><span class="s2">= {</span>
                <span class="s1">tag</span><span class="s2">: </span><span class="s1">_denormalize</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">axisMap</span><span class="s2">[</span><span class="s1">tag</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">inputLoc</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
            <span class="s2">}</span>
            <span class="s1">outputLoc </span><span class="s2">= {</span>
                <span class="s1">tag</span><span class="s2">: </span><span class="s1">_denormalize</span><span class="s2">(</span><span class="s1">val</span><span class="s2">, </span><span class="s1">axisMap</span><span class="s2">[</span><span class="s1">tag</span><span class="s2">]) </span><span class="s0">for </span><span class="s1">tag</span><span class="s2">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">outputLoc</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()</span>
            <span class="s2">}</span>
            <span class="s1">mappings</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] = (</span><span class="s1">inputLoc</span><span class="s2">, </span><span class="s1">outputLoc</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">axisMaps</span><span class="s2">, </span><span class="s1">mappings</span>


<span class="s0">def </span><span class="s1">main</span><span class="s2">(</span><span class="s1">args</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Add `avar` table from designspace file to variable font.&quot;&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">args </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">import </span><span class="s1">sys</span>

        <span class="s1">args </span><span class="s2">= </span><span class="s1">sys</span><span class="s2">.</span><span class="s1">argv</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:]</span>

    <span class="s0">from </span><span class="s1">fontTools </span><span class="s0">import </span><span class="s1">configLogger</span>
    <span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">ttLib </span><span class="s0">import </span><span class="s1">TTFont</span>
    <span class="s0">from </span><span class="s1">fontTools</span><span class="s2">.</span><span class="s1">designspaceLib </span><span class="s0">import </span><span class="s1">DesignSpaceDocument</span>
    <span class="s0">import </span><span class="s1">argparse</span>

    <span class="s1">parser </span><span class="s2">= </span><span class="s1">argparse</span><span class="s2">.</span><span class="s1">ArgumentParser</span><span class="s2">(</span>
        <span class="s3">&quot;fonttools varLib.avar&quot;</span><span class="s2">,</span>
        <span class="s1">description</span><span class="s2">=</span><span class="s3">&quot;Add `avar` table from designspace file to variable font.&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span><span class="s3">&quot;font&quot;</span><span class="s2">, </span><span class="s1">metavar</span><span class="s2">=</span><span class="s3">&quot;varfont.ttf&quot;</span><span class="s2">, </span><span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Variable-font file.&quot;</span><span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
        <span class="s3">&quot;designspace&quot;</span><span class="s2">,</span>
        <span class="s1">metavar</span><span class="s2">=</span><span class="s3">&quot;family.designspace&quot;</span><span class="s2">,</span>
        <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Designspace file.&quot;</span><span class="s2">,</span>
        <span class="s1">nargs</span><span class="s2">=</span><span class="s3">&quot;?&quot;</span><span class="s2">,</span>
        <span class="s1">default</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
        <span class="s3">&quot;-o&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;--output-file&quot;</span><span class="s2">,</span>
        <span class="s1">type</span><span class="s2">=</span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Output font file name.&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">add_argument</span><span class="s2">(</span>
        <span class="s3">&quot;-v&quot;</span><span class="s2">, </span><span class="s3">&quot;--verbose&quot;</span><span class="s2">, </span><span class="s1">action</span><span class="s2">=</span><span class="s3">&quot;store_true&quot;</span><span class="s2">, </span><span class="s1">help</span><span class="s2">=</span><span class="s3">&quot;Run more verbosely.&quot;</span>
    <span class="s2">)</span>

    <span class="s1">options </span><span class="s2">= </span><span class="s1">parser</span><span class="s2">.</span><span class="s1">parse_args</span><span class="s2">(</span><span class="s1">args</span><span class="s2">)</span>

    <span class="s1">configLogger</span><span class="s2">(</span><span class="s1">level</span><span class="s2">=(</span><span class="s3">&quot;INFO&quot; </span><span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">verbose </span><span class="s0">else </span><span class="s3">&quot;WARNING&quot;</span><span class="s2">))</span>

    <span class="s1">font </span><span class="s2">= </span><span class="s1">TTFont</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">font</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s3">&quot;fvar&quot; </span><span class="s0">in </span><span class="s1">font</span><span class="s2">:</span>
        <span class="s1">log</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s3">&quot;Not a variable font.&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s4">1</span>

    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">designspace </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">pprint </span><span class="s0">import </span><span class="s1">pprint</span>

        <span class="s1">segments</span><span class="s2">, </span><span class="s1">mappings </span><span class="s2">= </span><span class="s1">mappings_from_avar</span><span class="s2">(</span><span class="s1">font</span><span class="s2">)</span>
        <span class="s1">pprint</span><span class="s2">(</span><span class="s1">segments</span><span class="s2">)</span>
        <span class="s1">pprint</span><span class="s2">(</span><span class="s1">mappings</span><span class="s2">)</span>
        <span class="s1">print</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">mappings</span><span class="s2">), </span><span class="s3">&quot;mappings&quot;</span><span class="s2">)</span>
        <span class="s0">return</span>

    <span class="s1">axisTags </span><span class="s2">= [</span><span class="s1">a</span><span class="s2">.</span><span class="s1">axisTag </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">font</span><span class="s2">[</span><span class="s3">&quot;fvar&quot;</span><span class="s2">].</span><span class="s1">axes</span><span class="s2">]</span>

    <span class="s1">ds </span><span class="s2">= </span><span class="s1">load_designspace</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">designspace</span><span class="s2">, </span><span class="s1">require_sources</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;avar&quot; </span><span class="s0">in </span><span class="s1">font</span><span class="s2">:</span>
        <span class="s1">log</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s3">&quot;avar table already present, overwriting.&quot;</span><span class="s2">)</span>
        <span class="s0">del </span><span class="s1">font</span><span class="s2">[</span><span class="s3">&quot;avar&quot;</span><span class="s2">]</span>

    <span class="s1">_add_avar</span><span class="s2">(</span><span class="s1">font</span><span class="s2">, </span><span class="s1">ds</span><span class="s2">.</span><span class="s1">axes</span><span class="s2">, </span><span class="s1">ds</span><span class="s2">.</span><span class="s1">axisMappings</span><span class="s2">, </span><span class="s1">axisTags</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">options</span><span class="s2">.</span><span class="s1">output_file </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s1">outfile </span><span class="s2">= </span><span class="s1">makeOutputFileName</span><span class="s2">(</span><span class="s1">options</span><span class="s2">.</span><span class="s1">font</span><span class="s2">, </span><span class="s1">overWrite</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">suffix</span><span class="s2">=</span><span class="s3">&quot;.avar&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">outfile </span><span class="s2">= </span><span class="s1">options</span><span class="s2">.</span><span class="s1">output_file</span>
    <span class="s0">if </span><span class="s1">outfile</span><span class="s2">:</span>
        <span class="s1">log</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s3">&quot;Saving %s&quot;</span><span class="s2">, </span><span class="s1">outfile</span><span class="s2">)</span>
        <span class="s1">font</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">outfile</span><span class="s2">)</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">&quot;__main__&quot;</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">sys</span>

    <span class="s1">sys</span><span class="s2">.</span><span class="s1">exit</span><span class="s2">(</span><span class="s1">main</span><span class="s2">())</span>
</pre>
</body>
</html>