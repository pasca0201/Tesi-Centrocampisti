<html>
<head>
<title>conversion.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
conversion.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2009, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s2">&quot;&quot;&quot;Converting MySQL and Python types 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">array</span>
<span class="s3">import </span><span class="s1">datetime</span>
<span class="s3">import </span><span class="s1">math</span>
<span class="s3">import </span><span class="s1">struct</span>
<span class="s3">import </span><span class="s1">time</span>

<span class="s3">from </span><span class="s1">decimal </span><span class="s3">import </span><span class="s1">Decimal</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Callable</span><span class="s4">, </span><span class="s1">Dict</span><span class="s4">, </span><span class="s1">List</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Set</span><span class="s4">, </span><span class="s1">Tuple</span><span class="s4">, </span><span class="s1">Union</span>

<span class="s3">from </span><span class="s4">.</span><span class="s1">constants </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">MYSQL_VECTOR_TYPE_CODE</span><span class="s4">,</span>
    <span class="s1">CharacterSet</span><span class="s4">,</span>
    <span class="s1">FieldFlag</span><span class="s4">,</span>
    <span class="s1">FieldType</span><span class="s4">,</span>
    <span class="s1">SQLMode</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">custom_types </span><span class="s3">import </span><span class="s1">HexLiteral</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">types </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">DescriptionType</span><span class="s4">,</span>
    <span class="s1">MySQLConvertibleType</span><span class="s4">,</span>
    <span class="s1">MySQLProducedType</span><span class="s4">,</span>
    <span class="s1">PythonProducedType</span><span class="s4">,</span>
    <span class="s1">StrOrBytes</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s4">.</span><span class="s1">utils </span><span class="s3">import </span><span class="s1">NUMERIC_TYPES</span>

<span class="s1">CONVERT_ERROR </span><span class="s4">= </span><span class="s5">&quot;Could not convert '{value}' to python {pytype}&quot;</span>


<span class="s3">class </span><span class="s1">MySQLConverterBase</span><span class="s4">:</span>
    <span class="s2">&quot;&quot;&quot;Base class for conversion classes 
 
    All class dealing with converting to and from MySQL data types must 
    be a subclass of this class. 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">charset</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s5">&quot;utf8&quot;</span><span class="s4">,</span>
        <span class="s1">use_unicode</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">str_fallback</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_character_set</span><span class="s4">: </span><span class="s1">CharacterSet </span><span class="s4">= </span><span class="s1">CharacterSet</span><span class="s4">()</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">python_types</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">mysql_types</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Tuple</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">charset_id</span><span class="s4">: </span><span class="s1">int </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">set_charset</span><span class="s4">(</span><span class="s1">charset</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">use_unicode</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s1">use_unicode</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">str_fallback</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s1">str_fallback</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span>
            <span class="s1">int</span><span class="s4">,</span>
            <span class="s1">Callable</span><span class="s4">[[</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">DescriptionType</span><span class="s4">], </span><span class="s1">PythonProducedType</span><span class="s4">],</span>
        <span class="s4">] = {}</span>

    <span class="s3">def </span><span class="s1">set_charset</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">charset</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">], </span><span class="s1">character_set</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">CharacterSet</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Set character set&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">charset </span><span class="s3">in </span><span class="s4">(</span><span class="s5">&quot;utf8mb4&quot;</span><span class="s4">, </span><span class="s5">&quot;utf8mb3&quot;</span><span class="s4">):</span>
            <span class="s1">charset </span><span class="s4">= </span><span class="s5">&quot;utf8&quot;</span>
        <span class="s3">if </span><span class="s1">charset </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">charset </span><span class="s4">= </span><span class="s1">charset</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s0"># default to utf8</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">charset </span><span class="s4">= </span><span class="s5">&quot;utf8&quot;</span>

        <span class="s3">if </span><span class="s1">character_set</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_character_set </span><span class="s4">= </span><span class="s1">character_set</span>

        <span class="s1">self</span><span class="s4">.</span><span class="s1">charset_id </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_character_set</span><span class="s4">.</span><span class="s1">get_charset_info</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>

    <span class="s3">def </span><span class="s1">set_unicode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Set whether to use Unicode&quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">use_unicode </span><span class="s4">= </span><span class="s1">value</span>

    <span class="s3">def </span><span class="s1">to_mysql</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">MySQLConvertibleType</span>
    <span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">MySQLConvertibleType</span><span class="s4">, </span><span class="s1">HexLiteral</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Convert Python data type to MySQL&quot;&quot;&quot;</span>
        <span class="s1">type_name </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">converted</span><span class="s4">: </span><span class="s1">MySQLConvertibleType </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">f&quot;_</span><span class="s3">{</span><span class="s1">type_name</span><span class="s3">}</span><span class="s5">_to_mysql&quot;</span><span class="s4">)(</span>
                <span class="s1">value</span>
            <span class="s4">)</span>
            <span class="s3">return </span><span class="s1">converted</span>
        <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">value</span>

    <span class="s3">def </span><span class="s1">to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">vtype</span><span class="s4">: </span><span class="s1">DescriptionType</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; PythonProducedType</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert MySQL data type to Python&quot;&quot;&quot;</span>

        <span class="s3">if </span><span class="s4">(</span><span class="s1">value </span><span class="s4">== </span><span class="s7">b&quot;</span><span class="s3">\x00</span><span class="s7">&quot; </span><span class="s3">or </span><span class="s1">value </span><span class="s3">is None</span><span class="s4">) </span><span class="s3">and </span><span class="s1">vtype</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] != </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">BIT</span><span class="s4">:</span>
            <span class="s0"># Don't go further when we hit a NULL value</span>
            <span class="s3">return None</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types </span><span class="s4">= {}</span>
            <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">info </span><span class="s3">in </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">desc</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">[</span><span class="s1">info</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]] = </span><span class="s1">getattr</span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">, </span><span class="s5">f&quot;_</span><span class="s3">{</span><span class="s1">name</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span><span class="s3">}</span><span class="s5">_to_python&quot;</span>
                    <span class="s4">)</span>
                <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
                    <span class="s0"># We ignore field types which has no method</span>
                    <span class="s3">pass</span>
        <span class="s3">if </span><span class="s1">value </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">[</span><span class="s1">vtype</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]](</span><span class="s1">value</span><span class="s4">, </span><span class="s1">vtype</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">value</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">escape</span><span class="s4">(</span>
        <span class="s1">value</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">,</span>
        <span class="s1">sql_mode</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">,  </span><span class="s0"># pylint: disable=unused-argument</span>
    <span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Escape buffer for sending to MySQL&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">value</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">quote</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">) </span><span class="s1">-&gt; StrOrBytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Quote buffer for sending to MySQL&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">str</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">)</span>


<span class="s3">class </span><span class="s1">MySQLConverter</span><span class="s4">(</span><span class="s1">MySQLConverterBase</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Default conversion class for MySQL Connector/Python. 
 
     o escape method: for escaping values send to MySQL 
     o quoting method: for quoting values send to MySQL in statements 
     o conversion mapping: maps Python and MySQL data types to 
       function for converting them. 
 
    Whenever one needs to convert values differently, a converter_class 
    argument can be given while instantiating a new connection like 
    cnx.connect(converter_class=CustomMySQLConverterClass). 
 
    &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">__init__</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">charset</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">str</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">,</span>
        <span class="s1">use_unicode</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">True</span><span class="s4">,</span>
        <span class="s1">str_fallback</span><span class="s4">: </span><span class="s1">bool </span><span class="s4">= </span><span class="s3">False</span><span class="s4">,</span>
    <span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:</span>
        <span class="s1">super</span><span class="s4">().</span><span class="s1">__init__</span><span class="s4">(</span><span class="s1">charset</span><span class="s4">, </span><span class="s1">use_unicode</span><span class="s4">, </span><span class="s1">str_fallback</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">: </span><span class="s1">Dict</span><span class="s4">[</span>
            <span class="s1">int</span><span class="s4">,</span>
            <span class="s1">Callable</span><span class="s4">[[</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">DescriptionType</span><span class="s4">], </span><span class="s1">PythonProducedType</span><span class="s4">],</span>
        <span class="s4">] = {}</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">escape</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">sql_mode</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">]] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; Any</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Escapes special characters as they are expected to by when MySQL 
        receives them. 
        As found in MySQL source mysys/charset.c 
 
        Returns the value if not a string, or the escaped string. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">sql_mode</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">):</span>
            <span class="s0"># sql_mode is returned as bytes if use_unicode is set to False during connect()</span>
            <span class="s1">sql_mode </span><span class="s4">= </span><span class="s1">sql_mode</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, (</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">bytearray</span><span class="s4">)):</span>
            <span class="s3">if </span><span class="s1">sql_mode </span><span class="s3">is not None and </span><span class="s1">SQLMode</span><span class="s4">.</span><span class="s1">NO_BACKSLASH_ESCAPES </span><span class="s3">in </span><span class="s1">sql_mode</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;'&quot;</span><span class="s4">, </span><span class="s7">b&quot;''&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\\</span><span class="s7">&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\\\\</span><span class="s7">&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\n</span><span class="s7">&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\\</span><span class="s7">n&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\r</span><span class="s7">&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\\</span><span class="s7">r&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\047</span><span class="s7">&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\134\047</span><span class="s7">&quot;</span><span class="s4">)  </span><span class="s0"># single quotes</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\042</span><span class="s7">&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\134\042</span><span class="s7">&quot;</span><span class="s4">)  </span><span class="s0"># double quotes</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\032</span><span class="s7">&quot;</span><span class="s4">, </span><span class="s7">b&quot;</span><span class="s3">\134\032</span><span class="s7">&quot;</span><span class="s4">)  </span><span class="s0"># for Win32</span>
        <span class="s3">elif </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">str</span><span class="s4">) </span><span class="s3">and not </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">HexLiteral</span><span class="s4">):</span>
            <span class="s3">if </span><span class="s1">sql_mode </span><span class="s3">is not None and </span><span class="s1">SQLMode</span><span class="s4">.</span><span class="s1">NO_BACKSLASH_ESCAPES </span><span class="s3">in </span><span class="s1">sql_mode</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;'&quot;</span><span class="s4">, </span><span class="s5">&quot;''&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\\</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s5">&quot;</span><span class="s3">\\\\</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\n</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s5">&quot;</span><span class="s3">\\</span><span class="s5">n&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\r</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s5">&quot;</span><span class="s3">\\</span><span class="s5">r&quot;</span><span class="s4">)</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\047</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s5">&quot;</span><span class="s3">\134\047</span><span class="s5">&quot;</span><span class="s4">)  </span><span class="s0"># single quotes</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\042</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s5">&quot;</span><span class="s3">\134\042</span><span class="s5">&quot;</span><span class="s4">)  </span><span class="s0"># double quotes</span>
            <span class="s1">value </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s5">&quot;</span><span class="s3">\032</span><span class="s5">&quot;</span><span class="s4">, </span><span class="s5">&quot;</span><span class="s3">\134\032</span><span class="s5">&quot;</span><span class="s4">)  </span><span class="s0"># for Win32</span>
        <span class="s3">return </span><span class="s1">value</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">quote</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">float</span><span class="s4">, </span><span class="s1">int</span><span class="s4">, </span><span class="s1">Decimal</span><span class="s4">, </span><span class="s1">HexLiteral</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">]]) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Quote the parameters for commands. General rules: 
          o numbers are returns as bytes using ascii codec 
          o None is returned as bytearray(b'NULL') 
          o Everything else is single quoted '&lt;buf&gt;' 
 
        Returns a bytearray object. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s1">NUMERIC_TYPES</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">str</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">buf</span><span class="s4">, </span><span class="s1">type</span><span class="s4">(</span><span class="s3">None</span><span class="s4">)):</span>
            <span class="s3">return </span><span class="s1">bytearray</span><span class="s4">(</span><span class="s7">b&quot;NULL&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">bytearray</span><span class="s4">(</span><span class="s7">b&quot;'&quot; </span><span class="s4">+ </span><span class="s1">buf </span><span class="s4">+ </span><span class="s7">b&quot;'&quot;</span><span class="s4">)  </span><span class="s0"># type: ignore[operator]</span>

    <span class="s3">def </span><span class="s1">to_mysql</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">MySQLConvertibleType</span><span class="s4">) </span><span class="s1">-&gt; MySQLProducedType</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert Python data type to MySQL&quot;&quot;&quot;</span>
        <span class="s1">type_name </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">converted</span><span class="s4">: </span><span class="s1">MySQLProducedType </span><span class="s4">= </span><span class="s1">getattr</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s5">f&quot;_</span><span class="s3">{</span><span class="s1">type_name</span><span class="s3">}</span><span class="s5">_to_mysql&quot;</span><span class="s4">)(</span>
                <span class="s1">value</span>
            <span class="s4">)</span>
            <span class="s3">return </span><span class="s1">converted</span>
        <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">str_fallback</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">str</span><span class="s4">(</span><span class="s1">value</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">()</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span>
                <span class="s5">f&quot;Python '</span><span class="s3">{</span><span class="s1">type_name</span><span class="s3">}</span><span class="s5">' cannot be converted to a MySQL type&quot;</span>
            <span class="s4">) </span><span class="s3">from None</span>

    <span class="s3">def </span><span class="s1">to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">,</span>
        <span class="s1">vtype</span><span class="s4">: </span><span class="s1">DescriptionType</span><span class="s4">,</span>
        <span class="s1">value</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">],</span>
    <span class="s4">) </span><span class="s1">-&gt; PythonProducedType</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert MySQL data type to Python&quot;&quot;&quot;</span>
        <span class="s0"># \x00</span>
        <span class="s3">if </span><span class="s1">value </span><span class="s4">== </span><span class="s6">0 </span><span class="s3">and </span><span class="s1">vtype</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] != </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">BIT</span><span class="s4">:</span>
            <span class="s0"># Don't go further when we hit a NULL value</span>
            <span class="s3">return None</span>
        <span class="s3">if </span><span class="s1">value </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return None</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types </span><span class="s4">= {}</span>
            <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">info </span><span class="s3">in </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">desc</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">[</span><span class="s1">info</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]] = </span><span class="s1">getattr</span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">, </span><span class="s5">f&quot;_</span><span class="s3">{</span><span class="s1">name</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span><span class="s3">}</span><span class="s5">_to_python&quot;</span>
                    <span class="s4">)</span>
                <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
                    <span class="s0"># We ignore field types which has no method</span>
                    <span class="s3">pass</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">[</span><span class="s1">vtype</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]](</span><span class="s1">value</span><span class="s4">, </span><span class="s1">vtype</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
            <span class="s0"># If one type is not defined, we just return the value as str</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">UnicodeDecodeError</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span>
        <span class="s3">except </span><span class="s1">ValueError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">err</span><span class="s3">} </span><span class="s5">(field </span><span class="s3">{</span><span class="s1">vtype</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span><span class="s3">}</span><span class="s5">)&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">except </span><span class="s1">TypeError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">err</span><span class="s3">} </span><span class="s5">(field </span><span class="s3">{</span><span class="s1">vtype</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span><span class="s3">}</span><span class="s5">)&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_int_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">int</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to int&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_long_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">int</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to int 
 
        Note: There is no type &quot;long&quot; in Python 3 since integers are of unlimited size. 
              Since Python 2 is no longer supported, this method should be deprecated. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_float_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">float</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">float</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to float&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">math</span><span class="s4">.</span><span class="s1">isnan</span><span class="s4">(</span><span class="s1">value</span><span class="s4">):</span>
            <span class="s3">return None</span>
        <span class="s3">return </span><span class="s1">float</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_str_to_mysql</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">HexLiteral</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to string&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_unicode_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">_unicode_to_mysql</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">HexLiteral</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Convert unicode&quot;&quot;&quot;</span>
        <span class="s1">charset </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span>
        <span class="s1">charset_id </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset_id</span>
        <span class="s3">if </span><span class="s1">charset </span><span class="s4">== </span><span class="s5">&quot;binary&quot;</span><span class="s4">:</span>
            <span class="s1">charset </span><span class="s4">= </span><span class="s5">&quot;utf8&quot;</span>
            <span class="s1">charset_id </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_character_set</span><span class="s4">.</span><span class="s1">get_charset_info</span><span class="s4">(</span><span class="s1">charset</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">encoded </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s1">charset</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">charset_id </span><span class="s3">in </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_character_set</span><span class="s4">.</span><span class="s1">slash_charsets</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s7">b&quot;</span><span class="s3">\x5c</span><span class="s7">&quot; </span><span class="s3">in </span><span class="s1">encoded</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">HexLiteral</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">charset</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">encoded</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_bytes_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to bytes&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">value</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_bytearray_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytearray</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to bytes&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">bytes</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_bool_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bool</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Convert value to boolean&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s6">1 </span><span class="s3">if </span><span class="s1">value </span><span class="s3">else </span><span class="s6">0</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_nonetype_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; </span><span class="s3">None</span><span class="s4">:  </span><span class="s0"># pylint: disable=unused-argument</span>
        <span class="s2">&quot;&quot;&quot; 
        This would return what None would be in MySQL, but instead we 
        leave it None and return it right away. The actual conversion 
        from None to NULL happens in the quoting functionality. 
 
        Return None. 
        &quot;&quot;&quot;</span>
        <span class="s3">return None</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_datetime_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">datetime</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a datetime instance to a string suitable for MySQL. 
        The returned string has format: %Y-%m-%d %H:%M:%S[.%f] 
 
        If the instance isn't a datetime.datetime type, it return None. 
 
        Returns a bytes. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">value</span><span class="s4">.</span><span class="s1">microsecond</span><span class="s4">:</span>
            <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;{0:04d}-{1:02d}-{2:02d} {3:02d}:{4:02d}:{5:02d}.{6:06d}&quot;</span>
            <span class="s3">return </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">year</span><span class="s4">,</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">month</span><span class="s4">,</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">day</span><span class="s4">,</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">hour</span><span class="s4">,</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">minute</span><span class="s4">,</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">second</span><span class="s4">,</span>
                <span class="s1">value</span><span class="s4">.</span><span class="s1">microsecond</span><span class="s4">,</span>
            <span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

        <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;{0:04d}-{1:02d}-{2:02d} {3:02d}:{4:02d}:{5:02d}&quot;</span>
        <span class="s3">return </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span>
            <span class="s1">value</span><span class="s4">.</span><span class="s1">year</span><span class="s4">,</span>
            <span class="s1">value</span><span class="s4">.</span><span class="s1">month</span><span class="s4">,</span>
            <span class="s1">value</span><span class="s4">.</span><span class="s1">day</span><span class="s4">,</span>
            <span class="s1">value</span><span class="s4">.</span><span class="s1">hour</span><span class="s4">,</span>
            <span class="s1">value</span><span class="s4">.</span><span class="s1">minute</span><span class="s4">,</span>
            <span class="s1">value</span><span class="s4">.</span><span class="s1">second</span><span class="s4">,</span>
        <span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_date_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">date</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a date instance to a string suitable for MySQL. 
        The returned string has format: %Y-%m-%d 
 
        If the instance isn't a datetime.date type, it return None. 
 
        Returns a bytes. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">value</span><span class="s4">.</span><span class="s1">year</span><span class="s3">:</span><span class="s5">04d</span><span class="s3">}</span><span class="s5">-</span><span class="s3">{</span><span class="s1">value</span><span class="s4">.</span><span class="s1">month</span><span class="s3">:</span><span class="s5">02d</span><span class="s3">}</span><span class="s5">-</span><span class="s3">{</span><span class="s1">value</span><span class="s4">.</span><span class="s1">day</span><span class="s3">:</span><span class="s5">02d</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_time_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">time</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a time instance to a string suitable for MySQL. 
        The returned string has format: %H:%M:%S[.%f] 
 
        If the instance isn't a datetime.time type, it return None. 
 
        Returns a bytes. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">value</span><span class="s4">.</span><span class="s1">microsecond</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">strftime</span><span class="s4">(</span><span class="s5">&quot;%H:%M:%S.%f&quot;</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">strftime</span><span class="s4">(</span><span class="s5">&quot;%H:%M:%S&quot;</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_struct_time_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">time</span><span class="s4">.</span><span class="s1">struct_time</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a time.struct_time sequence to a string suitable 
        for MySQL. 
        The returned string has format: %Y-%m-%d %H:%M:%S 
 
        Returns a bytes or None when not valid. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">time</span><span class="s4">.</span><span class="s1">strftime</span><span class="s4">(</span><span class="s5">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s4">, </span><span class="s1">value</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_timedelta_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">timedelta</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a timedelta instance to a string suitable for MySQL. 
        The returned string has format: %H:%M:%S 
 
        Returns a bytes. 
        &quot;&quot;&quot;</span>
        <span class="s1">seconds </span><span class="s4">= </span><span class="s1">abs</span><span class="s4">(</span><span class="s1">value</span><span class="s4">.</span><span class="s1">days </span><span class="s4">* </span><span class="s6">86400 </span><span class="s4">+ </span><span class="s1">value</span><span class="s4">.</span><span class="s1">seconds</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">value</span><span class="s4">.</span><span class="s1">microseconds</span><span class="s4">:</span>
            <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;{0:02d}:{1:02d}:{2:02d}.{3:06d}&quot;</span>
            <span class="s3">if </span><span class="s1">value</span><span class="s4">.</span><span class="s1">days </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
                <span class="s1">mcs </span><span class="s4">= </span><span class="s6">1000000 </span><span class="s4">- </span><span class="s1">value</span><span class="s4">.</span><span class="s1">microseconds</span>
                <span class="s1">seconds </span><span class="s4">-= </span><span class="s6">1</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">mcs </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">microseconds</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;{0:02d}:{1:02d}:{2:02d}&quot;</span>

        <span class="s3">if </span><span class="s1">value</span><span class="s4">.</span><span class="s1">days </span><span class="s4">&lt; </span><span class="s6">0</span><span class="s4">:</span>
            <span class="s1">fmt </span><span class="s4">= </span><span class="s5">&quot;-&quot; </span><span class="s4">+ </span><span class="s1">fmt</span>

        <span class="s4">(</span><span class="s1">hours</span><span class="s4">, </span><span class="s1">remainder</span><span class="s4">) = </span><span class="s1">divmod</span><span class="s4">(</span><span class="s1">seconds</span><span class="s4">, </span><span class="s6">3600</span><span class="s4">)</span>
        <span class="s4">(</span><span class="s1">mins</span><span class="s4">, </span><span class="s1">secs</span><span class="s4">) = </span><span class="s1">divmod</span><span class="s4">(</span><span class="s1">remainder</span><span class="s4">, </span><span class="s6">60</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">value</span><span class="s4">.</span><span class="s1">microseconds</span><span class="s4">:</span>
            <span class="s1">result </span><span class="s4">= </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">hours</span><span class="s4">, </span><span class="s1">mins</span><span class="s4">, </span><span class="s1">secs</span><span class="s4">, </span><span class="s1">mcs</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">result </span><span class="s4">= </span><span class="s1">fmt</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">hours</span><span class="s4">, </span><span class="s1">mins</span><span class="s4">, </span><span class="s1">secs</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">result</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_decimal_to_mysql</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">Decimal</span><span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a decimal.Decimal instance to a string suitable for 
        MySQL. 
 
        Returns a bytes or None when not valid. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">Decimal</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">str</span><span class="s4">(</span><span class="s1">value</span><span class="s4">).</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;ascii&quot;</span><span class="s4">)</span>

        <span class="s3">return None</span>

    <span class="s3">def </span><span class="s1">row_to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">row</span><span class="s4">: </span><span class="s1">Tuple</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">, ...], </span><span class="s1">fields</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">PythonProducedType</span><span class="s4">, ...]:</span>
        <span class="s2">&quot;&quot;&quot;Convert a MySQL text result row to Python types 
 
        The row argument is a sequence containing text result returned 
        by a MySQL server. Each value of the row is converted to the 
        using the field type information in the fields argument. 
 
        Returns a tuple. 
        &quot;&quot;&quot;</span>
        <span class="s1">i </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s1">result</span><span class="s4">: </span><span class="s1">List</span><span class="s4">[</span><span class="s1">PythonProducedType</span><span class="s4">] = [</span><span class="s3">None</span><span class="s4">] * </span><span class="s1">len</span><span class="s4">(</span><span class="s1">fields</span><span class="s4">)</span>

        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">:</span>
            <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types </span><span class="s4">= {}</span>
            <span class="s3">for </span><span class="s1">name</span><span class="s4">, </span><span class="s1">info </span><span class="s3">in </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">desc</span><span class="s4">.</span><span class="s1">items</span><span class="s4">():</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">[</span><span class="s1">info</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]] = </span><span class="s1">getattr</span><span class="s4">(</span>
                        <span class="s1">self</span><span class="s4">, </span><span class="s5">f&quot;_</span><span class="s3">{</span><span class="s1">name</span><span class="s4">.</span><span class="s1">lower</span><span class="s4">()</span><span class="s3">}</span><span class="s5">_to_python&quot;</span>
                    <span class="s4">)</span>
                <span class="s3">except </span><span class="s1">AttributeError</span><span class="s4">:</span>
                    <span class="s0"># We ignore field types which has no method</span>
                    <span class="s3">pass</span>

        <span class="s3">for </span><span class="s1">field </span><span class="s3">in </span><span class="s1">fields</span><span class="s4">:</span>
            <span class="s1">field_type </span><span class="s4">= </span><span class="s1">field</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]</span>

            <span class="s3">if </span><span class="s4">(</span><span class="s1">row</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] == </span><span class="s6">0 </span><span class="s3">and </span><span class="s1">field_type </span><span class="s4">!= </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">BIT</span><span class="s4">) </span><span class="s3">or </span><span class="s1">row</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] </span><span class="s3">is None</span><span class="s4">:</span>
                <span class="s0"># Don't convert NULL value</span>
                <span class="s1">i </span><span class="s4">+= </span><span class="s6">1</span>
                <span class="s3">continue</span>

            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">result</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_cache_field_types</span><span class="s4">[</span><span class="s1">field_type</span><span class="s4">](</span><span class="s1">row</span><span class="s4">[</span><span class="s1">i</span><span class="s4">], </span><span class="s1">field</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">KeyError</span><span class="s4">:</span>
                <span class="s0"># If one type is not defined, we just return the value as str</span>
                <span class="s3">try</span><span class="s4">:</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">row</span><span class="s4">[</span><span class="s1">i</span><span class="s4">].</span><span class="s1">decode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>
                <span class="s3">except </span><span class="s1">UnicodeDecodeError</span><span class="s4">:</span>
                    <span class="s1">result</span><span class="s4">[</span><span class="s1">i</span><span class="s4">] = </span><span class="s1">row</span><span class="s4">[</span><span class="s1">i</span><span class="s4">]</span>
            <span class="s3">except </span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">) </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s0"># Item &quot;ValueError&quot; of &quot;Union[ValueError, TypeError]&quot; has no attribute &quot;message&quot;</span>
                <span class="s1">err</span><span class="s4">.</span><span class="s1">message </span><span class="s4">= </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">err</span><span class="s3">} </span><span class="s5">(field </span><span class="s3">{</span><span class="s1">field</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span><span class="s3">}</span><span class="s5">)&quot;  </span><span class="s0"># type: ignore[union-attr]</span>
                <span class="s3">raise</span>

            <span class="s1">i </span><span class="s4">+= </span><span class="s6">1</span>

        <span class="s3">return </span><span class="s1">tuple</span><span class="s4">(</span><span class="s1">result</span><span class="s4">)</span>

    <span class="s0"># pylint: disable=unused-argument</span>
    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_float_to_python</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">desc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; float</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Returns value as float type. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">float</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s1">_double_to_python </span><span class="s4">= </span><span class="s1">_float_to_python</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_int_to_python</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">desc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Returns value as int type. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s1">_tiny_to_python </span><span class="s4">= </span><span class="s1">_int_to_python</span>
    <span class="s1">_short_to_python </span><span class="s4">= </span><span class="s1">_int_to_python</span>
    <span class="s1">_int24_to_python </span><span class="s4">= </span><span class="s1">_int_to_python</span>
    <span class="s1">_long_to_python </span><span class="s4">= </span><span class="s1">_int_to_python</span>
    <span class="s1">_longlong_to_python </span><span class="s4">= </span><span class="s1">_int_to_python</span>

    <span class="s3">def </span><span class="s1">_decimal_to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">desc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Decimal</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Returns value as a decimal.Decimal. 
        &quot;&quot;&quot;</span>
        <span class="s1">val </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">Decimal</span><span class="s4">(</span><span class="s1">val</span><span class="s4">)</span>

    <span class="s1">_newdecimal_to_python </span><span class="s4">= </span><span class="s1">_decimal_to_python</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_str</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">desc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot; 
        Returns value as str type. 
        &quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s1">str</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_bit_to_python</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns BIT columntype as integer&quot;&quot;&quot;</span>
        <span class="s1">int_val </span><span class="s4">= </span><span class="s1">value</span>
        <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">int_val</span><span class="s4">) &lt; </span><span class="s6">8</span><span class="s4">:</span>
            <span class="s1">int_val </span><span class="s4">= </span><span class="s7">b&quot;</span><span class="s3">\x00</span><span class="s7">&quot; </span><span class="s4">* (</span><span class="s6">8 </span><span class="s4">- </span><span class="s1">len</span><span class="s4">(</span><span class="s1">int_val</span><span class="s4">)) + </span><span class="s1">int_val</span>
        <span class="s3">return </span><span class="s1">int</span><span class="s4">(</span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">&quot;&gt;Q&quot;</span><span class="s4">, </span><span class="s1">int_val</span><span class="s4">)[</span><span class="s6">0</span><span class="s4">])</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_date_to_python</span><span class="s4">(</span>
        <span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">date</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Converts TIME column MySQL to a python datetime.datetime type. 
 
        Raises ValueError if the value can not be converted. 
 
        Returns DATE column type as datetime.date type. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">date</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">value</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">parts </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot;-&quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">parts</span><span class="s4">) != </span><span class="s6">3</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;invalid datetime format: </span><span class="s3">{</span><span class="s1">parts</span><span class="s3">} </span><span class="s5">len: </span><span class="s3">{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">parts</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">date</span><span class="s4">(</span><span class="s1">int</span><span class="s4">(</span><span class="s1">parts</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]), </span><span class="s1">int</span><span class="s4">(</span><span class="s1">parts</span><span class="s4">[</span><span class="s6">1</span><span class="s4">]), </span><span class="s1">int</span><span class="s4">(</span><span class="s1">parts</span><span class="s4">[</span><span class="s6">2</span><span class="s4">]))</span>
            <span class="s3">except </span><span class="s1">ValueError</span><span class="s4">:</span>
                <span class="s3">return None</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">IndexError</span><span class="s4">, </span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                <span class="s5">f&quot;Could not convert </span><span class="s3">{</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span><span class="s3">} </span><span class="s5">to python datetime.timedelta&quot;</span>
            <span class="s4">) </span><span class="s3">from None</span>

    <span class="s1">_NEWDATE_to_python </span><span class="s4">= </span><span class="s1">_date_to_python</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_time_to_python</span><span class="s4">(</span>
        <span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; datetime</span><span class="s4">.</span><span class="s1">timedelta</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Converts TIME column value to python datetime.time value type. 
 
        Converts the TIME column MySQL type passed as bytes to a python 
        datetime.datetime type. 
 
        Raises ValueError if the value can not be converted. 
 
        Returns datetime.timedelta type. 
        &quot;&quot;&quot;</span>
        <span class="s1">mcs</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">]] = </span><span class="s3">None</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">hms</span><span class="s4">, </span><span class="s1">mcs</span><span class="s4">) = </span><span class="s1">value</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot;.&quot;</span><span class="s4">)</span>
            <span class="s1">mcs </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">mcs</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">6</span><span class="s4">, </span><span class="s7">b&quot;0&quot;</span><span class="s4">))</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s1">hms </span><span class="s4">= </span><span class="s1">value</span>
            <span class="s1">mcs </span><span class="s4">= </span><span class="s6">0</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">hours</span><span class="s4">, </span><span class="s1">mins</span><span class="s4">, </span><span class="s1">secs</span><span class="s4">) = [</span><span class="s1">int</span><span class="s4">(</span><span class="s1">d</span><span class="s4">) </span><span class="s3">for </span><span class="s1">d </span><span class="s3">in </span><span class="s1">hms</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot;:&quot;</span><span class="s4">)]</span>
            <span class="s3">if </span><span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s6">45 </span><span class="s3">or </span><span class="s1">value</span><span class="s4">[</span><span class="s6">0</span><span class="s4">] == </span><span class="s5">&quot;-&quot;</span><span class="s4">:</span>
                <span class="s1">mins</span><span class="s4">, </span><span class="s1">secs</span><span class="s4">, </span><span class="s1">mcs </span><span class="s4">= (</span>
                    <span class="s4">-</span><span class="s1">mins</span><span class="s4">,</span>
                    <span class="s4">-</span><span class="s1">secs</span><span class="s4">,</span>
                    <span class="s4">-</span><span class="s1">mcs</span><span class="s4">,  </span><span class="s0"># pylint: disable=invalid-unary-operand-type</span>
                <span class="s4">)</span>
            <span class="s3">return </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">timedelta</span><span class="s4">(</span>
                <span class="s1">hours</span><span class="s4">=</span><span class="s1">hours</span><span class="s4">, </span><span class="s1">minutes</span><span class="s4">=</span><span class="s1">mins</span><span class="s4">, </span><span class="s1">seconds</span><span class="s4">=</span><span class="s1">secs</span><span class="s4">, </span><span class="s1">microseconds</span><span class="s4">=</span><span class="s1">mcs</span>
            <span class="s4">)</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">IndexError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">, </span><span class="s1">ValueError</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                <span class="s1">CONVERT_ERROR</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">value</span><span class="s4">=</span><span class="s1">value</span><span class="s4">, </span><span class="s1">pytype</span><span class="s4">=</span><span class="s5">&quot;datetime.timedelta&quot;</span><span class="s4">)</span>
            <span class="s4">) </span><span class="s3">from None</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_datetime_to_python</span><span class="s4">(</span>
        <span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">datetime</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Converts DATETIME column value to python datetime.time value type. 
 
        Converts the DATETIME column MySQL type passed as bytes to a python 
        datetime.datetime type. 
 
        Returns: datetime.datetime type. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">datetime</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">value</span>
        <span class="s1">datetime_val </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">mcs</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">Union</span><span class="s4">[</span><span class="s1">int</span><span class="s4">, </span><span class="s1">bytes</span><span class="s4">]] = </span><span class="s3">None</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s4">(</span><span class="s1">date_</span><span class="s4">, </span><span class="s1">time_</span><span class="s4">) = </span><span class="s1">value</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot; &quot;</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">time_</span><span class="s4">) &gt; </span><span class="s6">8</span><span class="s4">:</span>
                <span class="s4">(</span><span class="s1">hms</span><span class="s4">, </span><span class="s1">mcs</span><span class="s4">) = </span><span class="s1">time_</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot;.&quot;</span><span class="s4">)</span>
                <span class="s1">mcs </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">mcs</span><span class="s4">.</span><span class="s1">ljust</span><span class="s4">(</span><span class="s6">6</span><span class="s4">, </span><span class="s7">b&quot;0&quot;</span><span class="s4">))</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">hms </span><span class="s4">= </span><span class="s1">time_</span>
                <span class="s1">mcs </span><span class="s4">= </span><span class="s6">0</span>
            <span class="s1">dtval </span><span class="s4">= (</span>
                <span class="s4">[</span><span class="s1">int</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">date_</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot;-&quot;</span><span class="s4">)]</span>
                <span class="s4">+ [</span><span class="s1">int</span><span class="s4">(</span><span class="s1">i</span><span class="s4">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">hms</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s7">b&quot;:&quot;</span><span class="s4">)]</span>
                <span class="s4">+ [</span>
                    <span class="s1">mcs</span><span class="s4">,</span>
                <span class="s4">]</span>
            <span class="s4">)</span>
            <span class="s3">if </span><span class="s1">len</span><span class="s4">(</span><span class="s1">dtval</span><span class="s4">) &lt; </span><span class="s6">6</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;invalid datetime format: </span><span class="s3">{</span><span class="s1">dtval</span><span class="s3">} </span><span class="s5">len: </span><span class="s3">{</span><span class="s1">len</span><span class="s4">(</span><span class="s1">dtval</span><span class="s4">)</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>
            <span class="s0"># Note that by default MySQL accepts invalid timestamps</span>
            <span class="s0"># (this is also backward compatibility).</span>
            <span class="s0"># Traditionaly C/py returns None for this well formed but</span>
            <span class="s0"># invalid datetime for python like '0000-00-00 HH:MM:SS'.</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">datetime_val </span><span class="s4">= </span><span class="s1">datetime</span><span class="s4">.</span><span class="s1">datetime</span><span class="s4">(*</span><span class="s1">dtval</span><span class="s4">)  </span><span class="s0"># type: ignore[arg-type]</span>
            <span class="s3">except </span><span class="s1">ValueError</span><span class="s4">:</span>
                <span class="s3">return None</span>
        <span class="s3">except </span><span class="s4">(</span><span class="s1">IndexError</span><span class="s4">, </span><span class="s1">TypeError</span><span class="s4">):</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                <span class="s1">CONVERT_ERROR</span><span class="s4">.</span><span class="s1">format</span><span class="s4">(</span><span class="s1">value</span><span class="s4">=</span><span class="s1">value</span><span class="s4">, </span><span class="s1">pytype</span><span class="s4">=</span><span class="s5">&quot;datetime.timedelta&quot;</span><span class="s4">)</span>
            <span class="s4">) </span><span class="s3">from None</span>

        <span class="s3">return </span><span class="s1">datetime_val</span>

    <span class="s1">_timestamp_to_python </span><span class="s4">= </span><span class="s1">_datetime_to_python</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_year_to_python</span><span class="s4">(</span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">) </span><span class="s1">-&gt; int</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Returns YEAR column type as integer&quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">year </span><span class="s4">= </span><span class="s1">int</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">ValueError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span><span class="s5">f&quot;Failed converting YEAR to int (</span><span class="s3">{</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span><span class="s3">}</span><span class="s5">)&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s3">return </span><span class="s1">year</span>

    <span class="s3">def </span><span class="s1">_set_to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Set</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Returns SET column type as set 
 
        Actually, MySQL protocol sees a SET as a string type field. So this 
        code isn't called directly, but used by STRING_to_python() method. 
 
        Returns SET column type as a set. 
        &quot;&quot;&quot;</span>
        <span class="s1">set_type </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">val </span><span class="s4">= </span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span><span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">val</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">set</span><span class="s4">()</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">set_type </span><span class="s4">= </span><span class="s1">set</span><span class="s4">(</span><span class="s1">val</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;,&quot;</span><span class="s4">))</span>
        <span class="s3">except </span><span class="s1">ValueError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ValueError</span><span class="s4">(</span>
                <span class="s5">f&quot;Could not convert set </span><span class="s3">{</span><span class="s1">repr</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span><span class="s3">} </span><span class="s5">to a sequence&quot;</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">return </span><span class="s1">set_type</span>

    <span class="s3">def </span><span class="s1">_string_to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">StrOrBytes</span><span class="s4">, </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Note that a SET is a string too, but using the FieldFlag we can see 
        whether we have to split it. 
 
        Returns string typed columns as string type. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset </span><span class="s4">== </span><span class="s5">&quot;binary&quot;</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">value</span>
        <span class="s3">if </span><span class="s1">dsc </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">dsc</span><span class="s4">[</span><span class="s6">1</span><span class="s4">] == </span><span class="s1">FieldType</span><span class="s4">.</span><span class="s1">JSON </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">use_unicode</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">dsc</span><span class="s4">[</span><span class="s6">7</span><span class="s4">] &amp; </span><span class="s1">FieldFlag</span><span class="s4">.</span><span class="s1">SET</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_set_to_python</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">)</span>
            <span class="s0"># 'binary' charset</span>
            <span class="s3">if </span><span class="s1">dsc</span><span class="s4">[</span><span class="s6">8</span><span class="s4">] == </span><span class="s6">63</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span>
        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, (</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">bytearray</span><span class="s4">)) </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">use_unicode</span><span class="s4">:</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(</span><span class="s1">self</span><span class="s4">.</span><span class="s1">charset</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">UnicodeDecodeError</span><span class="s4">:</span>
                <span class="s3">return </span><span class="s1">value</span>

        <span class="s3">return </span><span class="s1">value</span>

    <span class="s1">_var_string_to_python </span><span class="s4">= </span><span class="s1">_string_to_python</span>
    <span class="s1">_json_to_python </span><span class="s4">= </span><span class="s1">_string_to_python</span>

    <span class="s3">def </span><span class="s1">_blob_to_python</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">value</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Union</span><span class="s4">[</span><span class="s1">StrOrBytes</span><span class="s4">, </span><span class="s1">Set</span><span class="s4">[</span><span class="s1">str</span><span class="s4">]]:</span>
        <span class="s2">&quot;&quot;&quot;Convert BLOB data type to Python.&quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">dsc </span><span class="s3">is not None</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span>
                <span class="s1">dsc</span><span class="s4">[</span><span class="s6">7</span><span class="s4">] &amp; </span><span class="s1">FieldFlag</span><span class="s4">.</span><span class="s1">BLOB</span>
                <span class="s3">and </span><span class="s1">dsc</span><span class="s4">[</span><span class="s6">7</span><span class="s4">] &amp; </span><span class="s1">FieldFlag</span><span class="s4">.</span><span class="s1">BINARY</span>
                <span class="s0"># 'binary' charset</span>
                <span class="s3">and </span><span class="s1">dsc</span><span class="s4">[</span><span class="s6">8</span><span class="s4">] == </span><span class="s6">63</span>
            <span class="s4">):</span>
                <span class="s3">return </span><span class="s1">bytes</span><span class="s4">(</span><span class="s1">value</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_string_to_python</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">dsc</span><span class="s4">)</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_vector_to_python</span><span class="s4">(</span>
        <span class="s1">value</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">], </span><span class="s1">desc</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">DescriptionType</span><span class="s4">] = </span><span class="s3">None</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">array</span><span class="s4">.</span><span class="s1">array</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot; 
        Converts a MySQL VECTOR value to a Python array.array type. 
 
        Returns an array of floats if `value` isn't `None`, otherwise `None`. 
        &quot;&quot;&quot;</span>
        <span class="s3">if </span><span class="s1">value </span><span class="s3">is None or </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, </span><span class="s1">array</span><span class="s4">.</span><span class="s1">array</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">value</span>

        <span class="s3">if </span><span class="s1">isinstance</span><span class="s4">(</span><span class="s1">value</span><span class="s4">, (</span><span class="s1">bytes</span><span class="s4">, </span><span class="s1">bytearray</span><span class="s4">)):</span>
            <span class="s3">return </span><span class="s1">array</span><span class="s4">.</span><span class="s1">array</span><span class="s4">(</span><span class="s1">MYSQL_VECTOR_TYPE_CODE</span><span class="s4">, </span><span class="s1">value</span><span class="s4">)</span>

        <span class="s3">raise </span><span class="s1">TypeError</span><span class="s4">(</span><span class="s5">f&quot;Got unsupported type </span><span class="s3">{</span><span class="s1">value</span><span class="s4">.</span><span class="s1">__class__</span><span class="s4">.</span><span class="s1">__name__</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">)</span>

    <span class="s1">_long_blob_to_python </span><span class="s4">= </span><span class="s1">_blob_to_python</span>
    <span class="s1">_medium_blob_to_python </span><span class="s4">= </span><span class="s1">_blob_to_python</span>
    <span class="s1">_tiny_blob_to_python </span><span class="s4">= </span><span class="s1">_blob_to_python</span>
    <span class="s0"># pylint: enable=unused-argument</span>
</pre>
</body>
</html>