<html>
<head>
<title>test_theil_sen.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #7a7e85;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_theil_sen.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Testing for Theil-Sen module (sklearn.linear_model.theil_sen) 
&quot;&quot;&quot;</span>

<span class="s2"># Author: Florian Wilhelm &lt;florian.wilhelm@gmail.com&gt;</span>
<span class="s2"># License: BSD 3 clause</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">re</span>
<span class="s3">import </span><span class="s1">sys</span>
<span class="s3">from </span><span class="s1">contextlib </span><span class="s3">import </span><span class="s1">contextmanager</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">pytest</span>
<span class="s3">from </span><span class="s1">numpy</span><span class="s4">.</span><span class="s1">testing </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">,</span>
    <span class="s1">assert_array_equal</span><span class="s4">,</span>
    <span class="s1">assert_array_less</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">scipy</span><span class="s4">.</span><span class="s1">linalg </span><span class="s3">import </span><span class="s1">norm</span>
<span class="s3">from </span><span class="s1">scipy</span><span class="s4">.</span><span class="s1">optimize </span><span class="s3">import </span><span class="s1">fmin_bfgs</span>

<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">exceptions </span><span class="s3">import </span><span class="s1">ConvergenceWarning</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">linear_model </span><span class="s3">import </span><span class="s1">LinearRegression</span><span class="s4">, </span><span class="s1">TheilSenRegressor</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">linear_model</span><span class="s4">.</span><span class="s1">_theil_sen </span><span class="s3">import </span><span class="s4">(</span>
    <span class="s1">_breakdown_point</span><span class="s4">,</span>
    <span class="s1">_modified_weiszfeld_step</span><span class="s4">,</span>
    <span class="s1">_spatial_median</span><span class="s4">,</span>
<span class="s4">)</span>
<span class="s3">from </span><span class="s1">sklearn</span><span class="s4">.</span><span class="s1">utils</span><span class="s4">.</span><span class="s1">_testing </span><span class="s3">import </span><span class="s1">assert_almost_equal</span>


<span class="s4">@</span><span class="s1">contextmanager</span>
<span class="s3">def </span><span class="s1">no_stdout_stderr</span><span class="s4">():</span>
    <span class="s1">old_stdout </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stdout</span>
    <span class="s1">old_stderr </span><span class="s4">= </span><span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr</span>
    <span class="s3">with </span><span class="s1">open</span><span class="s4">(</span><span class="s1">os</span><span class="s4">.</span><span class="s1">devnull</span><span class="s4">, </span><span class="s5">&quot;w&quot;</span><span class="s4">) </span><span class="s3">as </span><span class="s1">devnull</span><span class="s4">:</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">stdout </span><span class="s4">= </span><span class="s1">devnull</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr </span><span class="s4">= </span><span class="s1">devnull</span>
        <span class="s3">yield</span>
        <span class="s1">devnull</span><span class="s4">.</span><span class="s1">flush</span><span class="s4">()</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">stdout </span><span class="s4">= </span><span class="s1">old_stdout</span>
        <span class="s1">sys</span><span class="s4">.</span><span class="s1">stderr </span><span class="s4">= </span><span class="s1">old_stderr</span>


<span class="s3">def </span><span class="s1">gen_toy_problem_1d</span><span class="s4">(</span><span class="s1">intercept</span><span class="s4">=</span><span class="s3">True</span><span class="s4">):</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s2"># Linear model y = 3*x + N(2, 0.1**2)</span>
    <span class="s1">w </span><span class="s4">= </span><span class="s6">3.0</span>
    <span class="s3">if </span><span class="s1">intercept</span><span class="s4">:</span>
        <span class="s1">c </span><span class="s4">= </span><span class="s6">2.0</span>
        <span class="s1">n_samples </span><span class="s4">= </span><span class="s6">50</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">c </span><span class="s4">= </span><span class="s6">0.1</span>
        <span class="s1">n_samples </span><span class="s4">= </span><span class="s6">100</span>
    <span class="s1">x </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">noise </span><span class="s4">= </span><span class="s6">0.1 </span><span class="s4">* </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">w </span><span class="s4">* </span><span class="s1">x </span><span class="s4">+ </span><span class="s1">c </span><span class="s4">+ </span><span class="s1">noise</span>
    <span class="s2"># Add some outliers</span>
    <span class="s3">if </span><span class="s1">intercept</span><span class="s4">:</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">42</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">42</span><span class="s4">] = (-</span><span class="s6">2</span><span class="s4">, </span><span class="s6">4</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">43</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">43</span><span class="s4">] = (-</span><span class="s6">2.5</span><span class="s4">, </span><span class="s6">8</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">33</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">33</span><span class="s4">] = (</span><span class="s6">2.5</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">49</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">49</span><span class="s4">] = (</span><span class="s6">2.1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">42</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">42</span><span class="s4">] = (-</span><span class="s6">2</span><span class="s4">, </span><span class="s6">4</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">43</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">43</span><span class="s4">] = (-</span><span class="s6">2.5</span><span class="s4">, </span><span class="s6">8</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">53</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">53</span><span class="s4">] = (</span><span class="s6">2.5</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">60</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">60</span><span class="s4">] = (</span><span class="s6">2.1</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>
        <span class="s1">x</span><span class="s4">[</span><span class="s6">72</span><span class="s4">], </span><span class="s1">y</span><span class="s4">[</span><span class="s6">72</span><span class="s4">] = (</span><span class="s6">1.8</span><span class="s4">, -</span><span class="s6">7</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">x</span><span class="s4">[:, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">newaxis</span><span class="s4">], </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c</span>


<span class="s3">def </span><span class="s1">gen_toy_problem_2d</span><span class="s4">():</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s1">n_samples </span><span class="s4">= </span><span class="s6">100</span>
    <span class="s2"># Linear model y = 5*x_1 + 10*x_2 + N(1, 0.1**2)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s6">2</span><span class="s4">))</span>
    <span class="s1">w </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">5.0</span><span class="s4">, </span><span class="s6">10.0</span><span class="s4">])</span>
    <span class="s1">c </span><span class="s4">= </span><span class="s6">1.0</span>
    <span class="s1">noise </span><span class="s4">= </span><span class="s6">0.1 </span><span class="s4">* </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dot</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">w</span><span class="s4">) + </span><span class="s1">c </span><span class="s4">+ </span><span class="s1">noise</span>
    <span class="s2"># Add some outliers</span>
    <span class="s1">n_outliers </span><span class="s4">= </span><span class="s1">n_samples </span><span class="s4">// </span><span class="s6">10</span>
    <span class="s1">ix </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_outliers</span><span class="s4">)</span>
    <span class="s1">y</span><span class="s4">[</span><span class="s1">ix</span><span class="s4">] = </span><span class="s6">50 </span><span class="s4">* </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_outliers</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c</span>


<span class="s3">def </span><span class="s1">gen_toy_problem_4d</span><span class="s4">():</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s1">n_samples </span><span class="s4">= </span><span class="s6">10000</span>
    <span class="s2"># Linear model y = 5*x_1 + 10*x_2  + 42*x_3 + 7*x_4 + N(1, 0.1**2)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s6">4</span><span class="s4">))</span>
    <span class="s1">w </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">5.0</span><span class="s4">, </span><span class="s6">10.0</span><span class="s4">, </span><span class="s6">42.0</span><span class="s4">, </span><span class="s6">7.0</span><span class="s4">])</span>
    <span class="s1">c </span><span class="s4">= </span><span class="s6">1.0</span>
    <span class="s1">noise </span><span class="s4">= </span><span class="s6">0.1 </span><span class="s4">* </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">dot</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">w</span><span class="s4">) + </span><span class="s1">c </span><span class="s4">+ </span><span class="s1">noise</span>
    <span class="s2"># Add some outliers</span>
    <span class="s1">n_outliers </span><span class="s4">= </span><span class="s1">n_samples </span><span class="s4">// </span><span class="s6">10</span>
    <span class="s1">ix </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">0</span><span class="s4">, </span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_outliers</span><span class="s4">)</span>
    <span class="s1">y</span><span class="s4">[</span><span class="s1">ix</span><span class="s4">] = </span><span class="s6">50 </span><span class="s4">* </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_outliers</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c</span>


<span class="s3">def </span><span class="s1">test_modweiszfeld_step_1d</span><span class="s4">():</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">2.0</span><span class="s4">, </span><span class="s6">3.0</span><span class="s4">]).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s2"># Check startvalue is element of X and solution</span>
    <span class="s1">median </span><span class="s4">= </span><span class="s6">2.0</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">median</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">new_y</span><span class="s4">, </span><span class="s1">median</span><span class="s4">)</span>
    <span class="s2"># Check startvalue is not the solution</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s6">2.5</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_less</span><span class="s4">(</span><span class="s1">median</span><span class="s4">, </span><span class="s1">new_y</span><span class="s4">)</span>
    <span class="s1">assert_array_less</span><span class="s4">(</span><span class="s1">new_y</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s2"># Check startvalue is not the solution but element of X</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s6">3.0</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_less</span><span class="s4">(</span><span class="s1">median</span><span class="s4">, </span><span class="s1">new_y</span><span class="s4">)</span>
    <span class="s1">assert_array_less</span><span class="s4">(</span><span class="s1">new_y</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s2"># Check that a single vector is identity</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">2.0</span><span class="s4">, </span><span class="s6">3.0</span><span class="s4">]).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s6">1</span><span class="s4">, </span><span class="s6">3</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">X</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">y</span><span class="s4">, </span><span class="s1">new_y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_modweiszfeld_step_2d</span><span class="s4">():</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">]).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.5</span><span class="s4">, </span><span class="s6">0.5</span><span class="s4">])</span>
    <span class="s2"># Check first two iterations</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">new_y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1 </span><span class="s4">/ </span><span class="s6">3</span><span class="s4">, </span><span class="s6">2 </span><span class="s4">/ </span><span class="s6">3</span><span class="s4">]))</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">new_y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">new_y</span><span class="s4">, </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.2792408</span><span class="s4">, </span><span class="s6">0.7207592</span><span class="s4">]))</span>
    <span class="s2"># Check fix point</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.21132505</span><span class="s4">, </span><span class="s6">0.78867497</span><span class="s4">])</span>
    <span class="s1">new_y </span><span class="s4">= </span><span class="s1">_modified_weiszfeld_step</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">new_y</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_spatial_median_1d</span><span class="s4">():</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">2.0</span><span class="s4">, </span><span class="s6">3.0</span><span class="s4">]).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">true_median </span><span class="s4">= </span><span class="s6">2.0</span>
    <span class="s1">_</span><span class="s4">, </span><span class="s1">median </span><span class="s4">= </span><span class="s1">_spatial_median</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">median</span><span class="s4">, </span><span class="s1">true_median</span><span class="s4">)</span>
    <span class="s2"># Test larger problem and for exact solution in 1d case</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s6">100</span><span class="s4">, </span><span class="s1">size</span><span class="s4">=(</span><span class="s6">1000</span><span class="s4">, </span><span class="s6">1</span><span class="s4">))</span>
    <span class="s1">true_median </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">median</span><span class="s4">(</span><span class="s1">X</span><span class="s4">.</span><span class="s1">ravel</span><span class="s4">())</span>
    <span class="s1">_</span><span class="s4">, </span><span class="s1">median </span><span class="s4">= </span><span class="s1">_spatial_median</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">assert_array_equal</span><span class="s4">(</span><span class="s1">median</span><span class="s4">, </span><span class="s1">true_median</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_spatial_median_2d</span><span class="s4">():</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">, </span><span class="s6">1.0</span><span class="s4">]).</span><span class="s1">reshape</span><span class="s4">(</span><span class="s6">3</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>
    <span class="s1">_</span><span class="s4">, </span><span class="s1">median </span><span class="s4">= </span><span class="s1">_spatial_median</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">max_iter</span><span class="s4">=</span><span class="s6">100</span><span class="s4">, </span><span class="s1">tol</span><span class="s4">=</span><span class="s6">1.0e-6</span><span class="s4">)</span>

    <span class="s3">def </span><span class="s1">cost_func</span><span class="s4">(</span><span class="s1">y</span><span class="s4">):</span>
        <span class="s1">dists </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">array</span><span class="s4">([</span><span class="s1">norm</span><span class="s4">(</span><span class="s1">x </span><span class="s4">- </span><span class="s1">y</span><span class="s4">) </span><span class="s3">for </span><span class="s1">x </span><span class="s3">in </span><span class="s1">X</span><span class="s4">])</span>
        <span class="s3">return </span><span class="s1">np</span><span class="s4">.</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">dists</span><span class="s4">)</span>

    <span class="s2"># Check if median is solution of the Fermat-Weber location problem</span>
    <span class="s1">fermat_weber </span><span class="s4">= </span><span class="s1">fmin_bfgs</span><span class="s4">(</span><span class="s1">cost_func</span><span class="s4">, </span><span class="s1">median</span><span class="s4">, </span><span class="s1">disp</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">median</span><span class="s4">, </span><span class="s1">fermat_weber</span><span class="s4">)</span>
    <span class="s2"># Check when maximum iteration is exceeded a warning is emitted</span>
    <span class="s1">warning_message </span><span class="s4">= </span><span class="s5">&quot;Maximum number of iterations 30 reached in spatial median.&quot;</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">warns</span><span class="s4">(</span><span class="s1">ConvergenceWarning</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">warning_message</span><span class="s4">):</span>
        <span class="s1">_spatial_median</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">max_iter</span><span class="s4">=</span><span class="s6">30</span><span class="s4">, </span><span class="s1">tol</span><span class="s4">=</span><span class="s6">0.0</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_theil_sen_1d</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_1d</span><span class="s4">()</span>
    <span class="s2"># Check that Least Squares fails</span>
    <span class="s1">lstq </span><span class="s4">= </span><span class="s1">LinearRegression</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">lstq</span><span class="s4">.</span><span class="s1">coef_ </span><span class="s4">- </span><span class="s1">w</span><span class="s4">) &gt; </span><span class="s6">0.9</span>
    <span class="s2"># Check that Theil-Sen works</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">intercept_</span><span class="s4">, </span><span class="s1">c</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_theil_sen_1d_no_intercept</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_1d</span><span class="s4">(</span><span class="s1">intercept</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
    <span class="s2"># Check that Least Squares fails</span>
    <span class="s1">lstq </span><span class="s4">= </span><span class="s1">LinearRegression</span><span class="s4">(</span><span class="s1">fit_intercept</span><span class="s4">=</span><span class="s3">False</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">lstq</span><span class="s4">.</span><span class="s1">coef_ </span><span class="s4">- </span><span class="s1">w </span><span class="s4">- </span><span class="s1">c</span><span class="s4">) &gt; </span><span class="s6">0.5</span>
    <span class="s2"># Check that Theil-Sen works</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">fit_intercept</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">w </span><span class="s4">+ </span><span class="s1">c</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">assert_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">intercept_</span><span class="s4">, </span><span class="s6">0.0</span><span class="s4">)</span>

    <span class="s2"># non-regression test for #18104</span>
    <span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">score</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_theil_sen_2d</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_2d</span><span class="s4">()</span>
    <span class="s2"># Check that Least Squares fails</span>
    <span class="s1">lstq </span><span class="s4">= </span><span class="s1">LinearRegression</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">norm</span><span class="s4">(</span><span class="s1">lstq</span><span class="s4">.</span><span class="s1">coef_ </span><span class="s4">- </span><span class="s1">w</span><span class="s4">) &gt; </span><span class="s6">1.0</span>
    <span class="s2"># Check that Theil-Sen works</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">max_subpopulation</span><span class="s4">=</span><span class="s6">1e3</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">intercept_</span><span class="s4">, </span><span class="s1">c</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_calc_breakdown_point</span><span class="s4">():</span>
    <span class="s1">bp </span><span class="s4">= </span><span class="s1">_breakdown_point</span><span class="s4">(</span><span class="s6">1e10</span><span class="s4">, </span><span class="s6">2</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">np</span><span class="s4">.</span><span class="s1">abs</span><span class="s4">(</span><span class="s1">bp </span><span class="s4">- </span><span class="s6">1 </span><span class="s4">+ </span><span class="s6">1 </span><span class="s4">/ (</span><span class="s1">np</span><span class="s4">.</span><span class="s1">sqrt</span><span class="s4">(</span><span class="s6">2</span><span class="s4">))) &lt; </span><span class="s6">1.0e-6</span>


<span class="s4">@</span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">mark</span><span class="s4">.</span><span class="s1">parametrize</span><span class="s4">(</span>
    <span class="s5">&quot;param, ExceptionCls, match&quot;</span><span class="s4">,</span>
    <span class="s4">[</span>
        <span class="s4">(</span>
            <span class="s4">{</span><span class="s5">&quot;n_subsamples&quot;</span><span class="s4">: </span><span class="s6">1</span><span class="s4">},</span>
            <span class="s1">ValueError</span><span class="s4">,</span>
            <span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span><span class="s5">&quot;Invalid parameter since n_features+1 &gt; n_subsamples (2 &gt; 1)&quot;</span><span class="s4">),</span>
        <span class="s4">),</span>
        <span class="s4">(</span>
            <span class="s4">{</span><span class="s5">&quot;n_subsamples&quot;</span><span class="s4">: </span><span class="s6">101</span><span class="s4">},</span>
            <span class="s1">ValueError</span><span class="s4">,</span>
            <span class="s1">re</span><span class="s4">.</span><span class="s1">escape</span><span class="s4">(</span><span class="s5">&quot;Invalid parameter since n_subsamples &gt; n_samples (101 &gt; 50)&quot;</span><span class="s4">),</span>
        <span class="s4">),</span>
    <span class="s4">],</span>
<span class="s4">)</span>
<span class="s3">def </span><span class="s1">test_checksubparams_invalid_input</span><span class="s4">(</span><span class="s1">param</span><span class="s4">, </span><span class="s1">ExceptionCls</span><span class="s4">, </span><span class="s1">match</span><span class="s4">):</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_1d</span><span class="s4">()</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(**</span><span class="s1">param</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ExceptionCls</span><span class="s4">, </span><span class="s1">match</span><span class="s4">=</span><span class="s1">match</span><span class="s4">):</span>
        <span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_checksubparams_n_subsamples_if_less_samples_than_features</span><span class="s4">():</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s6">10</span><span class="s4">, </span><span class="s6">20</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">n_subsamples</span><span class="s4">=</span><span class="s6">9</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s3">with </span><span class="s1">pytest</span><span class="s4">.</span><span class="s1">raises</span><span class="s4">(</span><span class="s1">ValueError</span><span class="s4">):</span>
        <span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_subpopulation</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_4d</span><span class="s4">()</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">max_subpopulation</span><span class="s4">=</span><span class="s6">250</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">intercept_</span><span class="s4">, </span><span class="s1">c</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_subsamples</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_4d</span><span class="s4">()</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">n_subsamples</span><span class="s4">=</span><span class="s1">X</span><span class="s4">.</span><span class="s1">shape</span><span class="s4">[</span><span class="s6">0</span><span class="s4">], </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">lstq </span><span class="s4">= </span><span class="s1">LinearRegression</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s2"># Check for exact the same results as Least Squares</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">lstq</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s6">9</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_verbosity</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_1d</span><span class="s4">()</span>
    <span class="s2"># Check that Theil-Sen can be verbose</span>
    <span class="s3">with </span><span class="s1">no_stdout_stderr</span><span class="s4">():</span>
        <span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">verbose</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
        <span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">verbose</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">max_subpopulation</span><span class="s4">=</span><span class="s6">10</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_theil_sen_parallel</span><span class="s4">():</span>
    <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s1">c </span><span class="s4">= </span><span class="s1">gen_toy_problem_2d</span><span class="s4">()</span>
    <span class="s2"># Check that Least Squares fails</span>
    <span class="s1">lstq </span><span class="s4">= </span><span class="s1">LinearRegression</span><span class="s4">().</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">assert </span><span class="s1">norm</span><span class="s4">(</span><span class="s1">lstq</span><span class="s4">.</span><span class="s1">coef_ </span><span class="s4">- </span><span class="s1">w</span><span class="s4">) &gt; </span><span class="s6">1.0</span>
    <span class="s2"># Check that Theil-Sen works</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">n_jobs</span><span class="s4">=</span><span class="s6">2</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">, </span><span class="s1">max_subpopulation</span><span class="s4">=</span><span class="s6">2e3</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span>
        <span class="s1">X</span><span class="s4">, </span><span class="s1">y</span>
    <span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">w</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">intercept_</span><span class="s4">, </span><span class="s1">c</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">test_less_samples_than_features</span><span class="s4">():</span>
    <span class="s1">random_state </span><span class="s4">= </span><span class="s1">np</span><span class="s4">.</span><span class="s1">random</span><span class="s4">.</span><span class="s1">RandomState</span><span class="s4">(</span><span class="s6">0</span><span class="s4">)</span>
    <span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features </span><span class="s4">= </span><span class="s6">10</span><span class="s4">, </span><span class="s6">20</span>
    <span class="s1">X </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=(</span><span class="s1">n_samples</span><span class="s4">, </span><span class="s1">n_features</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">random_state</span><span class="s4">.</span><span class="s1">normal</span><span class="s4">(</span><span class="s1">size</span><span class="s4">=</span><span class="s1">n_samples</span><span class="s4">)</span>
    <span class="s2"># Check that Theil-Sen falls back to Least Squares if fit_intercept=False</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">fit_intercept</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">lstq </span><span class="s4">= </span><span class="s1">LinearRegression</span><span class="s4">(</span><span class="s1">fit_intercept</span><span class="s4">=</span><span class="s3">False</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s1">lstq</span><span class="s4">.</span><span class="s1">coef_</span><span class="s4">, </span><span class="s6">12</span><span class="s4">)</span>
    <span class="s2"># Check fit_intercept=True case. This will not be equal to the Least</span>
    <span class="s2"># Squares solution since the intercept is calculated differently.</span>
    <span class="s1">theil_sen </span><span class="s4">= </span><span class="s1">TheilSenRegressor</span><span class="s4">(</span><span class="s1">fit_intercept</span><span class="s4">=</span><span class="s3">True</span><span class="s4">, </span><span class="s1">random_state</span><span class="s4">=</span><span class="s6">0</span><span class="s4">).</span><span class="s1">fit</span><span class="s4">(</span><span class="s1">X</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">y_pred </span><span class="s4">= </span><span class="s1">theil_sen</span><span class="s4">.</span><span class="s1">predict</span><span class="s4">(</span><span class="s1">X</span><span class="s4">)</span>
    <span class="s1">assert_array_almost_equal</span><span class="s4">(</span><span class="s1">y_pred</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s6">12</span><span class="s4">)</span>
</pre>
</body>
</html>